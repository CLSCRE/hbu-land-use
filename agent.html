<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Land to Yield ‚Äî Agent Portal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0d9488;
            --primary-dark: #0f766e;
            --primary-light: #14b8a6;
            --accent: #0ea5e9;
            --bg: #f8fafc;
            --white: #ffffff;
            --text: #1e293b;
            --text-dark: #0f172a;
            --text-light: #64748b;
            --border: #e2e8f0;
            --radius: 12px;
            --shadow: 0 4px 24px rgba(13,148,136,0.08);
            --shadow-lg: 0 12px 48px rgba(13,148,136,0.12);
            --green: #16a34a;
            --red: #dc2626;
            --amber: #d97706;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            color: var(--text); background: var(--bg); line-height: 1.6;
        }

        /* Auth Overlay */
        #authOverlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, #0f766e 0%, #0d9488 50%, #14b8a6 100%);
            z-index: 9999;
            display: flex; align-items: center; justify-content: center;
            transition: opacity 0.4s ease;
        }
        #authOverlay.fade-out { opacity: 0; pointer-events: none; }
        .auth-box {
            background: white; border-radius: 16px; padding: 2.5rem 2rem;
            text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 380px; width: 90%;
        }
        .auth-box h2 { color: var(--primary-dark); font-size: 1.4rem; margin-bottom: 0.25rem; }
        .auth-box > p { color: var(--text-light); font-size: 0.92rem; margin-bottom: 1.5rem; }
        .auth-box input[type="password"] {
            width: 100%; padding: 0.7rem 1rem; border: 1.5px solid var(--border);
            border-radius: 8px; font-size: 1rem; text-align: center; margin-bottom: 1rem;
            font-family: inherit;
        }
        .auth-box input[type="password"]:focus {
            outline: none; border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(13,148,136,0.12);
        }
        .auth-btn {
            display: block; width: 100%; padding: 0.75rem; font-size: 1rem; font-weight: 700;
            color: white; background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            border: none; border-radius: 10px; cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
            box-shadow: 0 4px 12px rgba(13,148,136,0.35);
        }
        .auth-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(13,148,136,0.45); }
        .auth-error { color: var(--red); font-size: 0.85rem; margin-top: 0.75rem; min-height: 1.2em; }
        @media print { #authOverlay { display: none !important; } }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            color: white; padding: 1.25rem 2rem;
            display: flex; align-items: center; justify-content: space-between;
        }
        .header-brand { font-weight: 800; font-size: 1.15rem; }
        .header-brand small { font-weight: 400; font-size: 0.7rem; opacity: 0.7; display: block; }
        .header-nav { display: flex; gap: 1rem; align-items: center; }
        .header-nav a {
            color: rgba(255,255,255,0.8); text-decoration: none; font-size: 0.85rem; font-weight: 500;
        }
        .header-nav a:hover { color: white; }

        /* Main Layout */
        .main { max-width: 900px; margin: 0 auto; padding: 2rem 1.5rem; }

        /* Search */
        .search-card {
            background: white; border-radius: var(--radius); padding: 2rem;
            box-shadow: var(--shadow); border: 1px solid var(--border); margin-bottom: 2rem;
        }
        .search-card h2 { font-size: 1.3rem; color: var(--text-dark); margin-bottom: 0.5rem; }
        .search-card p { color: var(--text-light); font-size: 0.9rem; margin-bottom: 1.25rem; }
        .search-row { display: flex; gap: 0.75rem; }
        .search-row input {
            flex: 1; padding: 0.75rem 1rem; border: 1.5px solid var(--border);
            border-radius: 8px; font-size: 1rem; font-family: inherit;
        }
        .search-row input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(13,148,136,0.1); }
        .btn-search {
            padding: 0.75rem 1.5rem; background: var(--primary); color: white;
            border: none; border-radius: 8px; font-weight: 700; font-size: 0.95rem;
            cursor: pointer; white-space: nowrap; transition: background 0.2s;
        }
        .btn-search:hover { background: var(--primary-dark); }
        .btn-search:disabled { opacity: 0.6; cursor: not-allowed; }
        #searchStatus { margin-top: 0.75rem; font-size: 0.85rem; }
        #searchStatus .ok { color: var(--green); }
        #searchStatus .warn { color: var(--amber); }
        #searchStatus .err { color: var(--red); }
        #searchStatus .loading { color: var(--text-light); }

        /* Results */
        #resultsSection { display: none; }

        /* Property Overview */
        .overview-card {
            background: white; border-radius: var(--radius); padding: 1.5rem 2rem;
            box-shadow: var(--shadow); border: 1px solid var(--border); margin-bottom: 1.5rem;
        }
        .overview-card h3 { font-size: 1.1rem; color: var(--text-dark); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
        .overview-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem;
        }
        .overview-item label { font-size: 0.72rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-light); font-weight: 600; }
        .overview-item .val { font-size: 1rem; font-weight: 600; color: var(--text-dark); }

        /* Legislation Cards */
        .leg-section { margin-bottom: 1.5rem; }
        .leg-section h3 { font-size: 1.1rem; color: var(--text-dark); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
        .leg-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1rem; }
        .leg-card {
            background: white; border-radius: var(--radius); padding: 1.25rem;
            border: 1px solid var(--border); transition: box-shadow 0.2s;
        }
        .leg-card:hover { box-shadow: var(--shadow); }
        .leg-card.eligible { border-left: 4px solid var(--green); }
        .leg-card.ineligible { border-left: 4px solid #cbd5e1; opacity: 0.6; }
        .leg-badge {
            display: inline-block; font-size: 0.7rem; font-weight: 700; text-transform: uppercase;
            letter-spacing: 0.05em; padding: 0.2rem 0.6rem; border-radius: 4px; margin-bottom: 0.5rem;
        }
        .leg-badge.pass { background: #dcfce7; color: var(--green); }
        .leg-badge.fail { background: #f1f5f9; color: #94a3b8; }
        .leg-card h4 { font-size: 0.95rem; color: var(--text-dark); margin-bottom: 0.35rem; }
        .leg-card p { font-size: 0.82rem; color: var(--text-light); line-height: 1.5; }

        /* Value Uplift */
        .uplift-card {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            color: white; border-radius: var(--radius); padding: 2rem;
            box-shadow: var(--shadow-lg); margin-bottom: 1.5rem;
        }
        .uplift-card h3 { font-size: 1.1rem; margin-bottom: 1.25rem; }
        .uplift-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; text-align: center; }
        .uplift-item .label { font-size: 0.75rem; opacity: 0.75; text-transform: uppercase; letter-spacing: 0.05em; }
        .uplift-item .value { font-size: 1.8rem; font-weight: 800; }
        .uplift-item .value.highlight { color: #5eead4; }

        /* HBU Score */
        .hbu-section { margin-bottom: 1.5rem; }
        .hbu-section h3 { font-size: 1.1rem; color: var(--text-dark); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
        .hbu-card {
            background: white; border-radius: var(--radius); padding: 1.25rem;
            border: 1px solid var(--border); display: flex; align-items: center; gap: 1rem;
            margin-bottom: 0.75rem; transition: box-shadow 0.2s;
        }
        .hbu-card:hover { box-shadow: var(--shadow); }
        .hbu-rank {
            width: 36px; height: 36px; border-radius: 50%;
            background: var(--primary); color: white; font-weight: 800; font-size: 1rem;
            display: flex; align-items: center; justify-content: center; flex-shrink: 0;
        }
        .hbu-rank.r1 { background: var(--primary); }
        .hbu-rank.r2 { background: var(--primary-light); }
        .hbu-rank.r3 { background: var(--accent); }
        .hbu-icon { font-size: 1.5rem; flex-shrink: 0; }
        .hbu-info { flex: 1; }
        .hbu-info h4 { font-size: 0.95rem; color: var(--text-dark); margin-bottom: 0.15rem; }
        .hbu-info p { font-size: 0.82rem; color: var(--text-light); }
        .hbu-score { text-align: right; }
        .hbu-score .num { font-size: 1.4rem; font-weight: 800; color: var(--primary-dark); }
        .hbu-score .lbl { font-size: 0.7rem; color: var(--text-light); text-transform: uppercase; }

        /* Score bar */
        .score-bar { width: 80px; height: 6px; background: #e2e8f0; border-radius: 3px; margin-top: 4px; }
        .score-bar-fill { height: 100%; border-radius: 3px; background: var(--primary); }

        /* Print Button */
        .print-bar { text-align: center; margin: 2rem 0; }
        .btn-print {
            padding: 0.75rem 2rem; background: var(--primary); color: white;
            border: none; border-radius: 8px; font-weight: 700; font-size: 0.95rem;
            cursor: pointer; transition: background 0.2s;
        }
        .btn-print:hover { background: var(--primary-dark); }

        /* Print Styles */
        @media print {
            body { background: white; }
            .header, .search-card, .print-bar, .header-nav { display: none !important; }
            .main { padding: 0; max-width: 100%; }
            #resultsSection { display: block !important; }
            .print-header { display: block !important; }
            .overview-card, .leg-card, .hbu-card, .uplift-card { break-inside: avoid; box-shadow: none; }
            .leg-card.ineligible { display: none !important; }
        }
        .print-header {
            display: none; text-align: center; padding: 1.5rem 0; margin-bottom: 1rem;
            border-bottom: 3px solid var(--primary);
        }
        .print-header h1 { font-size: 1.3rem; color: var(--primary-dark); }
        .print-header p { font-size: 0.85rem; color: var(--text-light); }
        .print-footer { display: none; text-align: center; margin-top: 2rem; padding-top: 1rem; border-top: 1px solid var(--border); font-size: 0.75rem; color: var(--text-light); }
        @media print { .print-footer { display: block !important; } }

        /* Responsive */
        @media (max-width: 640px) {
            .search-row { flex-direction: column; }
            .uplift-grid { grid-template-columns: 1fr; }
            .overview-grid { grid-template-columns: 1fr 1fr; }
            .header { flex-direction: column; gap: 0.5rem; text-align: center; }
        }
    </style>
</head>
<body>

<!-- Auth -->
<div id="authOverlay">
    <div class="auth-box">
        <h2>Land to Yield</h2>
        <p>Agent Portal</p>
        <input type="password" id="authPassword" placeholder="Access Code" onkeydown="if(event.key==='Enter')checkAuth();">
        <button type="button" class="auth-btn" onclick="checkAuth()">Enter</button>
        <div class="auth-error" id="authError"></div>
        <div style="margin-top:0.75rem;font-size:0.75rem;color:#a0aec0;">Enter the access code from your subscription email</div>
        <div style="margin-top:0.75rem;"><a href="index.html#pricing" style="color:#0d9488;font-size:0.8rem;text-decoration:none;">Don't have a code? Subscribe here &rarr;</a></div>
        <div style="margin-top:1.5rem;font-size:0.7rem;color:#a0aec0;">v1.0</div>
    </div>
</div>

<!-- Header -->
<div class="header">
    <div class="header-brand">
        Land to Yield <small>Agent Portal</small>
    </div>
    <div class="header-nav">
        <a href="index.html">Home</a>
        <a href="app.html">Developer Portal</a>
    </div>
</div>

<!-- Main -->
<div class="main">

    <!-- Search -->
    <div class="search-card">
        <h2>Discover Hidden Property Value</h2>
        <p>Enter any Los Angeles property address to see its development potential and value uplift from applicable legislation.</p>
        <div class="search-row">
            <input type="text" id="addressInput" placeholder="e.g. 1234 Wilshire Blvd, Los Angeles, CA 90010">
            <button class="btn-search" id="btnSearch" onclick="runAgentAnalysis()">Analyze</button>
        </div>
        <div id="searchStatus"></div>
    </div>

    <!-- Results -->
    <div id="resultsSection">

        <!-- Print Header -->
        <div class="print-header">
            <h1>Land to Yield ‚Äî Property Development Potential Report</h1>
            <p id="printSubtitle"></p>
        </div>

        <!-- Property Overview -->
        <div class="overview-card">
            <h3>üìç Property Overview</h3>
            <div class="overview-grid" id="overviewGrid"></div>
        </div>

        <!-- Legislation -->
        <div class="leg-section">
            <h3>üìú Development Bonuses &amp; Legislation</h3>
            <div class="leg-grid" id="legGrid"></div>
        </div>

        <!-- Value Uplift -->
        <div class="uplift-card">
            <h3>üí∞ Estimated Value Uplift</h3>
            <div class="uplift-grid" id="upliftGrid"></div>
        </div>

        <!-- HBU Top 3 -->
        <div class="hbu-section">
            <h3>üèÜ Top Recommended Uses</h3>
            <div id="hbuList"></div>
        </div>

        <!-- Print -->
        <div class="print-bar">
            <button class="btn-print" onclick="window.print()">Print / Save as PDF</button>
        </div>

        <!-- Print Footer -->
        <div class="print-footer">
            Generated by Land to Yield &mdash; landtoyield.com &mdash; <span id="printDate"></span><br>
            For informational purposes only. Verify all data independently before making investment decisions.
        </div>
    </div>
</div>

<script>
// ============================================================
//  AUTH GATE (same as developer portal)
// ============================================================
const ADMIN_HASH = '08c5d8c40ac5bd96091f704d10989da4e7b65c5ee36be18b618848c4e91a22af';
const VALID_CODES = [
    '14197a5cc2fdd7254604a791eae2e02bd3e23a448230367ce249fe3192b94b12', // BETA-TEST-2026
];

async function sha256(str) {
    const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
    return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('');
}

async function checkAuth() {
    const code = document.getElementById('authPassword').value;
    const hash = await sha256(code);
    if (hash === ADMIN_HASH || VALID_CODES.includes(hash)) {
        localStorage.setItem('hbu_auth_hash', hash);
        const overlay = document.getElementById('authOverlay');
        overlay.classList.add('fade-out');
        setTimeout(() => overlay.remove(), 500);
    } else {
        document.getElementById('authError').textContent = 'Invalid access code. Please try again.';
        document.getElementById('authPassword').value = '';
        document.getElementById('authPassword').focus();
    }
}

(function() {
    const storedHash = localStorage.getItem('hbu_auth_hash');
    if (storedHash && (storedHash === ADMIN_HASH || VALID_CODES.includes(storedHash))) {
        const overlay = document.getElementById('authOverlay');
        if (overlay) overlay.remove();
    } else {
        localStorage.removeItem('hbu_auth_hash');
    }
})();


// ============================================================
//  NEIGHBORHOOD DATA
// ============================================================
const NEIGHBORHOOD_CENTROIDS = {
    dtla: { lat: 34.0407, lon: -118.2468 }, hollywood: { lat: 34.0928, lon: -118.3287 },
    koreatown: { lat: 34.0578, lon: -118.3010 }, westside: { lat: 34.0367, lon: -118.4376 },
    santamonica: { lat: 34.0906, lon: -118.3856 }, beverly: { lat: 34.0736, lon: -118.4004 },
    midcity: { lat: 34.0483, lon: -118.3396 }, southla: { lat: 33.9425, lon: -118.2820 },
    valleyeast: { lat: 34.2219, lon: -118.4157 }, valleywest: { lat: 34.1866, lon: -118.5353 },
    silverlake: { lat: 34.0869, lon: -118.2697 }, highland: { lat: 34.1133, lon: -118.1902 },
    venice: { lat: 33.9850, lon: -118.4695 }, culver: { lat: 34.0211, lon: -118.3965 },
    exposition: { lat: 34.0183, lon: -118.2932 }, southbay: { lat: 33.8358, lon: -118.3406 },
    harbor: { lat: 33.7361, lon: -118.2922 }, boyleheights: { lat: 34.0345, lon: -118.2120 },
};

const NEIGHBORHOOD_LABELS = {
    dtla: 'Downtown LA', hollywood: 'Hollywood', koreatown: 'Koreatown', westside: 'Westside',
    santamonica: 'Santa Monica', beverly: 'Beverly Hills', midcity: 'Mid-City', southla: 'South LA',
    valleyeast: 'Valley East', valleywest: 'Valley West', silverlake: 'Silver Lake',
    highland: 'Highland Park', venice: 'Venice', culver: 'Culver City', exposition: 'Exposition',
    southbay: 'South Bay', harbor: 'Harbor', boyleheights: 'Boyle Heights',
};

const SUBURB_TO_NEIGHBORHOOD = {
    'downtown':'dtla','downtown los angeles':'dtla','little tokyo':'dtla','arts district':'dtla',
    'chinatown':'dtla','civic center':'dtla','bunker hill':'dtla','financial district':'dtla','skid row':'dtla',
    'hollywood':'hollywood','east hollywood':'hollywood','thai town':'hollywood','hollywood hills':'hollywood',
    'los feliz':'silverlake','koreatown':'koreatown','pico-union':'koreatown','westlake':'koreatown',
    'west los angeles':'westside','west la':'westside','sawtelle':'westside','westwood':'westside',
    'brentwood':'westside','bel air':'westside','santa monica':'santamonica','west hollywood':'santamonica','weho':'santamonica',
    'beverly hills':'beverly','beverly grove':'beverly','beverlywood':'beverly','century city':'beverly',
    'mid-wilshire':'midcity','mid wilshire':'midcity','mid-city':'midcity','mid city':'midcity',
    'miracle mile':'midcity','hancock park':'midcity','larchmont':'midcity','windsor square':'midcity',
    'park la brea':'midcity','fairfax':'midcity',
    'south los angeles':'southla','south la':'southla','watts':'southla','florence':'southla',
    'vermont square':'southla','vermont-slauson':'southla','green meadows':'southla',
    'north hollywood':'valleyeast','noho':'valleyeast','studio city':'valleyeast','valley village':'valleyeast',
    'sun valley':'valleyeast','panorama city':'valleyeast','arleta':'valleyeast','pacoima':'valleyeast','sylmar':'valleyeast',
    'sherman oaks':'valleywest','encino':'valleywest','tarzana':'valleywest','woodland hills':'valleywest',
    'reseda':'valleywest','canoga park':'valleywest','winnetka':'valleywest','chatsworth':'valleywest',
    'northridge':'valleywest','granada hills':'valleywest','west hills':'valleywest',
    'silver lake':'silverlake','silverlake':'silverlake','echo park':'silverlake','elysian valley':'silverlake','atwater village':'silverlake',
    'highland park':'highland','eagle rock':'highland','glassell park':'highland','mount washington':'highland',
    'cypress park':'highland','el sereno':'highland',
    'venice':'venice','mar vista':'venice','del rey':'venice','playa vista':'venice','playa del rey':'venice','marina del rey':'venice',
    'culver city':'culver','palms':'culver','rancho park':'culver','cheviot hills':'culver','castle heights':'culver',
    'exposition park':'exposition','university park':'exposition','leimert park':'exposition','jefferson park':'exposition',
    'west adams':'exposition','baldwin hills':'exposition','crenshaw':'exposition',
    'torrance':'southbay','gardena':'southbay','carson':'southbay','hawthorne':'southbay','inglewood':'southbay',
    'lawndale':'southbay','el segundo':'southbay','manhattan beach':'southbay','hermosa beach':'southbay','redondo beach':'southbay',
    'san pedro':'harbor','wilmington':'harbor','harbor city':'harbor','harbor gateway':'harbor',
    'boyle heights':'boyleheights','east los angeles':'boyleheights','east la':'boyleheights','lincoln heights':'boyleheights',
};

// ============================================================
//  TRANSIT STATIONS
// ============================================================
const METRO_STATIONS = [
    {lat:34.0561,lon:-118.2365,name:'Union Station',line:'red',tier:1,serviceType:'Heavy Rail'},
    {lat:34.0562,lon:-118.2500,name:'Civic Center/Grand Park',line:'red',tier:1,serviceType:'Heavy Rail'},
    {lat:34.0469,lon:-118.2600,name:'Pershing Square',line:'red',tier:1,serviceType:'Heavy Rail'},
    {lat:34.0488,lon:-118.2588,name:'7th St/Metro Center',line:'red',tier:1,serviceType:'Heavy Rail'},
    {lat:34.0678,lon:-118.2915,name:'Wilshire/Vermont',line:'red',tier:1,serviceType:'Heavy Rail'},
    {lat:34.1017,lon:-118.3070,name:'Hollywood/Western',line:'red',tier:1,serviceType:'Heavy Rail'},
    {lat:34.1017,lon:-118.3250,name:'Hollywood/Vine',line:'red',tier:1,serviceType:'Heavy Rail'},
    {lat:34.1014,lon:-118.3388,name:'Hollywood/Highland',line:'red',tier:1,serviceType:'Heavy Rail'},
    {lat:34.1381,lon:-118.3623,name:'Universal City/Studio City',line:'red',tier:1,serviceType:'Heavy Rail'},
    {lat:34.1687,lon:-118.3765,name:'North Hollywood',line:'red',tier:1,serviceType:'Heavy Rail'},
    {lat:34.0624,lon:-118.3080,name:'Wilshire/Normandie',line:'purple',tier:1,serviceType:'Heavy Rail'},
    {lat:34.0573,lon:-118.3273,name:'Wilshire/Western',line:'purple',tier:1,serviceType:'Heavy Rail'},
    {lat:34.0620,lon:-118.3440,name:'Wilshire/La Brea',line:'purple',tier:1,serviceType:'Heavy Rail'},
    {lat:34.0622,lon:-118.3615,name:'Wilshire/Fairfax',line:'purple',tier:1,serviceType:'Heavy Rail'},
    {lat:34.0626,lon:-118.3766,name:'Wilshire/La Cienega',line:'purple',tier:1,serviceType:'Heavy Rail'},
    {lat:34.0630,lon:-118.3945,name:'Wilshire/Rodeo',line:'purple',tier:1,serviceType:'Heavy Rail'},
    {lat:34.0632,lon:-118.4170,name:'Century City/Constellation',line:'purple',tier:1,serviceType:'Heavy Rail'},
    {lat:34.0638,lon:-118.4385,name:'Westwood/UCLA',line:'purple',tier:1,serviceType:'Heavy Rail'},
    {lat:34.0640,lon:-118.4510,name:'Westwood/VA Hospital',line:'purple',tier:1,serviceType:'Heavy Rail'},
    {lat:34.0398,lon:-118.2610,name:'Pico',line:'blue_a',tier:2,serviceType:'Light Rail'},
    {lat:34.0295,lon:-118.2435,name:'LATTC/Ortho Institute',line:'blue_a',tier:2,serviceType:'Light Rail'},
    {lat:34.0222,lon:-118.2344,name:'San Pedro St',line:'blue_a',tier:2,serviceType:'Light Rail'},
    {lat:34.0030,lon:-118.2297,name:'Washington',line:'blue_a',tier:2,serviceType:'Light Rail'},
    {lat:33.9938,lon:-118.2296,name:'Vernon',line:'blue_a',tier:2,serviceType:'Light Rail'},
    {lat:33.9830,lon:-118.2295,name:'Slauson',line:'blue_a',tier:2,serviceType:'Light Rail'},
    {lat:33.9722,lon:-118.2293,name:'Florence',line:'blue_a',tier:2,serviceType:'Light Rail'},
    {lat:33.9612,lon:-118.2340,name:'Firestone',line:'blue_a',tier:2,serviceType:'Light Rail'},
    {lat:33.9450,lon:-118.2362,name:'103rd St/Watts Towers',line:'blue_a',tier:2,serviceType:'Light Rail'},
    {lat:33.9268,lon:-118.2377,name:'Willowbrook/Rosa Parks',line:'blue_a',tier:2,serviceType:'Light Rail'},
    {lat:33.9160,lon:-118.2382,name:'Compton',line:'blue_a',tier:2,serviceType:'Light Rail'},
    {lat:33.9029,lon:-118.2382,name:'Artesia',line:'blue_a',tier:2,serviceType:'Light Rail'},
    {lat:33.8862,lon:-118.2284,name:'Del Amo',line:'blue_a',tier:2,serviceType:'Light Rail'},
    {lat:33.8697,lon:-118.2119,name:'Wardlow',line:'blue_a',tier:2,serviceType:'Light Rail'},
    {lat:33.8567,lon:-118.2100,name:'Willow St',line:'blue_a',tier:2,serviceType:'Light Rail'},
    {lat:33.8470,lon:-118.1890,name:'Pacific Coast Hwy',line:'blue_a',tier:2,serviceType:'Light Rail'},
    {lat:33.7686,lon:-118.1891,name:'1st St (Long Beach)',line:'blue_a',tier:2,serviceType:'Light Rail'},
    {lat:33.7676,lon:-118.1935,name:'Downtown Long Beach',line:'blue_a',tier:2,serviceType:'Light Rail'},
    {lat:34.0222,lon:-118.2580,name:'Expo Park/USC',line:'expo_e',tier:2,serviceType:'Light Rail'},
    {lat:34.0186,lon:-118.2862,name:'Expo/Vermont',line:'expo_e',tier:2,serviceType:'Light Rail'},
    {lat:34.0183,lon:-118.3088,name:'Expo/Western',line:'expo_e',tier:2,serviceType:'Light Rail'},
    {lat:34.0227,lon:-118.3310,name:'Expo/Crenshaw',line:'expo_e',tier:2,serviceType:'Light Rail'},
    {lat:34.0252,lon:-118.3418,name:'Farmdale',line:'expo_e',tier:2,serviceType:'Light Rail'},
    {lat:34.0289,lon:-118.3520,name:'Expo/La Brea',line:'expo_e',tier:2,serviceType:'Light Rail'},
    {lat:34.0270,lon:-118.3710,name:'La Cienega/Jefferson',line:'expo_e',tier:2,serviceType:'Light Rail'},
    {lat:34.0248,lon:-118.3860,name:'Culver City',line:'expo_e',tier:2,serviceType:'Light Rail'},
    {lat:34.0209,lon:-118.3520,name:'Palms',line:'expo_e',tier:2,serviceType:'Light Rail'},
    {lat:34.0124,lon:-118.3908,name:'Expo/Sepulveda',line:'expo_e',tier:2,serviceType:'Light Rail'},
    {lat:34.0168,lon:-118.3685,name:'Westwood/Rancho Park',line:'expo_e',tier:2,serviceType:'Light Rail'},
    {lat:34.0135,lon:-118.4330,name:'Expo/Bundy',line:'expo_e',tier:2,serviceType:'Light Rail'},
    {lat:34.0156,lon:-118.4694,name:'26th St/Bergamot',line:'expo_e',tier:2,serviceType:'Light Rail'},
    {lat:34.0154,lon:-118.4960,name:'Downtown Santa Monica',line:'expo_e',tier:2,serviceType:'Light Rail'},
    {lat:34.0566,lon:-118.2338,name:'Little Tokyo/Arts District',line:'gold_l',tier:2,serviceType:'Light Rail'},
    {lat:34.0561,lon:-118.2365,name:'Union Station (Gold)',line:'gold_l',tier:2,serviceType:'Light Rail'},
    {lat:34.0620,lon:-118.2360,name:'Chinatown',line:'gold_l',tier:2,serviceType:'Light Rail'},
    {lat:34.0672,lon:-118.2350,name:'Lincoln/Cypress',line:'gold_l',tier:2,serviceType:'Light Rail'},
    {lat:34.0760,lon:-118.2260,name:'Heritage Square/Arroyo',line:'gold_l',tier:2,serviceType:'Light Rail'},
    {lat:34.0890,lon:-118.2100,name:'Southwest Museum',line:'gold_l',tier:2,serviceType:'Light Rail'},
    {lat:34.0960,lon:-118.1990,name:'Highland Park',line:'gold_l',tier:2,serviceType:'Light Rail'},
    {lat:34.1118,lon:-118.1868,name:'South Pasadena',line:'gold_l',tier:2,serviceType:'Light Rail'},
    {lat:34.1175,lon:-118.1560,name:'Fillmore',line:'gold_l',tier:2,serviceType:'Light Rail'},
    {lat:34.1285,lon:-118.1340,name:'Del Mar',line:'gold_l',tier:2,serviceType:'Light Rail'},
    {lat:34.1360,lon:-118.1230,name:'Memorial Park',line:'gold_l',tier:2,serviceType:'Light Rail'},
    {lat:34.1421,lon:-118.1150,name:'Lake',line:'gold_l',tier:2,serviceType:'Light Rail'},
    {lat:34.1497,lon:-118.1030,name:'Allen',line:'gold_l',tier:2,serviceType:'Light Rail'},
    {lat:34.1500,lon:-118.0830,name:'Sierra Madre Villa',line:'gold_l',tier:2,serviceType:'Light Rail'},
    {lat:34.1520,lon:-118.0520,name:'Arcadia',line:'gold_l',tier:2,serviceType:'Light Rail'},
    {lat:34.1425,lon:-118.0310,name:'Monrovia',line:'gold_l',tier:2,serviceType:'Light Rail'},
    {lat:34.1365,lon:-118.0090,name:'Duarte/City of Hope',line:'gold_l',tier:2,serviceType:'Light Rail'},
    {lat:34.1360,lon:-117.9870,name:'Irwindale',line:'gold_l',tier:2,serviceType:'Light Rail'},
    {lat:34.1370,lon:-117.9620,name:'Azusa Downtown',line:'gold_l',tier:2,serviceType:'Light Rail'},
    {lat:34.1380,lon:-117.9440,name:'APU/Citrus College',line:'gold_l',tier:2,serviceType:'Light Rail'},
    {lat:34.0441,lon:-118.2120,name:'Mariachi Plaza/Boyle Heights',line:'gold_l',tier:2,serviceType:'Light Rail'},
    {lat:34.0395,lon:-118.1938,name:'Soto',line:'gold_l',tier:2,serviceType:'Light Rail'},
    {lat:34.0335,lon:-118.1770,name:'Indiana',line:'gold_l',tier:2,serviceType:'Light Rail'},
    {lat:34.0290,lon:-118.1620,name:'Maravilla',line:'gold_l',tier:2,serviceType:'Light Rail'},
    {lat:34.0245,lon:-118.1475,name:'East LA Civic Center',line:'gold_l',tier:2,serviceType:'Light Rail'},
    {lat:34.0220,lon:-118.1280,name:'Atlantic',line:'gold_l',tier:2,serviceType:'Light Rail'},
    {lat:33.9190,lon:-118.0570,name:'Norwalk',line:'green_c',tier:2,serviceType:'Light Rail'},
    {lat:33.9198,lon:-118.0940,name:'Lakewood Blvd',line:'green_c',tier:2,serviceType:'Light Rail'},
    {lat:33.9204,lon:-118.1262,name:'Long Beach Blvd',line:'green_c',tier:2,serviceType:'Light Rail'},
    {lat:33.9230,lon:-118.1706,name:'Avalon',line:'green_c',tier:2,serviceType:'Light Rail'},
    {lat:33.9268,lon:-118.2377,name:'Willowbrook/Rosa Parks (Green)',line:'green_c',tier:2,serviceType:'Light Rail'},
    {lat:33.9252,lon:-118.2565,name:'Vermont/Athens',line:'green_c',tier:2,serviceType:'Light Rail'},
    {lat:33.9289,lon:-118.2735,name:'Harbor Freeway',line:'green_c',tier:2,serviceType:'Light Rail'},
    {lat:33.9324,lon:-118.2915,name:'Crenshaw (Green)',line:'green_c',tier:2,serviceType:'Light Rail'},
    {lat:33.9525,lon:-118.3518,name:'Hawthorne/Lennox',line:'green_c',tier:2,serviceType:'Light Rail'},
    {lat:33.9340,lon:-118.3828,name:'Aviation/LAX',line:'green_c',tier:2,serviceType:'Light Rail'},
    {lat:33.9262,lon:-118.3960,name:'Mariposa',line:'green_c',tier:2,serviceType:'Light Rail'},
    {lat:33.9130,lon:-118.4030,name:'El Segundo',line:'green_c',tier:2,serviceType:'Light Rail'},
    {lat:33.9030,lon:-118.4093,name:'Douglas',line:'green_c',tier:2,serviceType:'Light Rail'},
    {lat:33.8920,lon:-118.4128,name:'Redondo Beach',line:'green_c',tier:2,serviceType:'Light Rail'},
    {lat:34.0227,lon:-118.3310,name:'Expo/Crenshaw (K)',line:'k_line',tier:2,serviceType:'Light Rail'},
    {lat:34.0100,lon:-118.3340,name:'Leimert Park',line:'k_line',tier:2,serviceType:'Light Rail'},
    {lat:33.9978,lon:-118.3320,name:'Hyde Park',line:'k_line',tier:2,serviceType:'Light Rail'},
    {lat:33.9838,lon:-118.3290,name:'Fairview Heights',line:'k_line',tier:2,serviceType:'Light Rail'},
    {lat:33.9680,lon:-118.3380,name:'Downtown Inglewood',line:'k_line',tier:2,serviceType:'Light Rail'},
    {lat:33.9530,lon:-118.3560,name:'Westchester/Veterans',line:'k_line',tier:2,serviceType:'Light Rail'},
    {lat:33.9340,lon:-118.3828,name:'Aviation/Century (K)',line:'k_line',tier:2,serviceType:'Light Rail'},
    {lat:34.0458,lon:-118.2562,name:'Grand Av Arts/Bunker Hill',line:'connector',tier:2,serviceType:'Light Rail'},
    {lat:34.0489,lon:-118.2468,name:'Historic Broadway',line:'connector',tier:2,serviceType:'Light Rail'},
    {lat:34.0561,lon:-118.2365,name:'LA Union Station (Metrolink)',line:'metrolink',tier:2,serviceType:'Commuter Rail'},
    {lat:34.1900,lon:-118.4500,name:'Van Nuys (Metrolink)',line:'metrolink',tier:2,serviceType:'Commuter Rail'},
    {lat:34.2083,lon:-118.4958,name:'Chatsworth',line:'metrolink',tier:2,serviceType:'Commuter Rail'},
    {lat:34.2600,lon:-118.4400,name:'Sylmar/San Fernando',line:'metrolink',tier:2,serviceType:'Commuter Rail'},
    {lat:34.1480,lon:-118.2555,name:'Glendale',line:'metrolink',tier:2,serviceType:'Commuter Rail'},
    {lat:34.1360,lon:-118.2410,name:'Glendale (Tropico)',line:'metrolink',tier:2,serviceType:'Commuter Rail'},
    {lat:34.0930,lon:-118.2360,name:'Lincoln Heights (Metrolink)',line:'metrolink',tier:2,serviceType:'Commuter Rail'},
    {lat:34.1766,lon:-118.3080,name:'Burbank Airport North',line:'metrolink',tier:2,serviceType:'Commuter Rail'},
    {lat:34.1834,lon:-118.3268,name:'Burbank Downtown',line:'metrolink',tier:2,serviceType:'Commuter Rail'},
    {lat:33.9017,lon:-118.2260,name:'Compton (Metrolink)',line:'metrolink',tier:2,serviceType:'Commuter Rail'},
    {lat:34.0513,lon:-118.2310,name:'LA Downtown (Commercial St)',line:'metrolink',tier:2,serviceType:'Commuter Rail'},
    {lat:34.0670,lon:-118.1650,name:'Cal State LA',line:'metrolink',tier:2,serviceType:'Commuter Rail'},
    {lat:34.0870,lon:-118.1300,name:'El Monte',line:'metrolink',tier:2,serviceType:'Commuter Rail'},
    {lat:34.1010,lon:-118.1030,name:'Baldwin Park',line:'metrolink',tier:2,serviceType:'Commuter Rail'},
    {lat:34.1160,lon:-118.0550,name:'Covina',line:'metrolink',tier:2,serviceType:'Commuter Rail'},
    {lat:34.0500,lon:-117.7510,name:'Pomona Downtown',line:'metrolink',tier:2,serviceType:'Commuter Rail'},
    {lat:33.7710,lon:-118.1890,name:'Long Beach (Metrolink)',line:'metrolink',tier:2,serviceType:'Commuter Rail'},
];

// ============================================================
//  SB 79 & CORE ENGINE DATA
// ============================================================
const SB79_TIERS = {
    1: { label: 'Tier 1 (Heavy Rail)', height: 95, density: 160, far: 4.5 },
    2: { label: 'Tier 2 (Light Rail/BRT)', height: 85, density: 140, far: 4.0 },
};
const SB79_ZONES = {
    adjacent: { maxDist: 0.038, label: '200ft (Adjacent)', parking: 0, heightMult: 1.0 },
    inner:    { maxDist: 0.25,  label: '1/4 Mile (Inner)',  parking: 0, heightMult: 1.0 },
    outer:    { maxDist: 0.50,  label: '1/2 Mile (Outer)',  parking: 0.5, heightMult: 0.68 },
};

function haversine(lat1, lon1, lat2, lon2) {
    const R = 3958.8;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat / 2) ** 2 +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon / 2) ** 2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

function detectNeighborhood(lat, lon, addressDetails) {
    if (addressDetails) {
        const fields = [addressDetails.neighbourhood, addressDetails.suburb, addressDetails.city_district, addressDetails.quarter];
        for (const field of fields) {
            if (field) {
                const key = field.toLowerCase().trim();
                if (SUBURB_TO_NEIGHBORHOOD[key]) return SUBURB_TO_NEIGHBORHOOD[key];
            }
        }
    }
    let best = 'westside', bestDist = Infinity;
    for (const [key, c] of Object.entries(NEIGHBORHOOD_CENTROIDS)) {
        const d = haversine(lat, lon, c.lat, c.lon);
        if (d < bestDist) { bestDist = d; best = key; }
    }
    return best;
}

function detectTransitProximity(lat, lon) {
    let minDist = Infinity;
    for (const s of METRO_STATIONS) {
        const d = haversine(lat, lon, s.lat, s.lon);
        if (d < minDist) minDist = d;
    }
    if (minDist <= 0.25) return 'adjacent';
    if (minDist <= 0.5) return 'near';
    if (minDist <= 1.0) return 'moderate';
    return 'far';
}

function detectSB79Eligibility(lat, lon) {
    let nearest = null, nearestDist = Infinity;
    for (const s of METRO_STATIONS) {
        const d = haversine(lat, lon, s.lat, s.lon);
        if (d < nearestDist) { nearestDist = d; nearest = s; }
    }
    if (!nearest || nearestDist > 0.5) return { eligible: false, station: nearest, distMiles: nearestDist };
    const tier = nearest.tier;
    const tierData = SB79_TIERS[tier];
    let zone, zoneKey;
    if (nearestDist <= SB79_ZONES.adjacent.maxDist) { zone = SB79_ZONES.adjacent; zoneKey = 'adjacent'; }
    else if (nearestDist <= SB79_ZONES.inner.maxDist) { zone = SB79_ZONES.inner; zoneKey = 'inner'; }
    else { zone = SB79_ZONES.outer; zoneKey = 'outer'; }
    return {
        eligible: true, station: nearest, tier, tierLabel: tierData.label,
        zone: zoneKey, zoneLabel: zone.label, distMiles: nearestDist,
        allowances: {
            height: Math.round(tierData.height * zone.heightMult),
            density: Math.round(tierData.density * zone.heightMult),
            far: parseFloat((tierData.far * zone.heightMult).toFixed(2)),
            parking: zone.parking,
        },
    };
}

const MAJOR_ARTERIALS = [
    'wilshire','sunset','santa monica','hollywood','venice','olympic','pico','la cienega',
    'figueroa','vermont','western','crenshaw','sepulveda','van nuys','ventura','victory',
    'sherman way','lincoln','pacific coast','pch','florence','manchester','century','imperial',
    'alameda','broadway','spring','main st','san fernando','glendale','beverly','la brea',
    'fairfax','robertson','melrose','highland','cahuenga','vine','western ave','normandie',
    'hoover','alvarado','temple','cesar chavez','first','1st st','3rd st','6th st',
    'whittier','washington','jefferson','exposition','mlk','martin luther king','slauson',
];

function detectArterial(addressString, addressDetails) {
    if (addressDetails && addressDetails.road) {
        const road = addressDetails.road.toLowerCase();
        for (const art of MAJOR_ARTERIALS) { if (road.includes(art)) return 'major'; }
        if (/\bblvd\b|\bboulevard\b|\bave\b|\bavenue\b/.test(road)) return 'secondary';
        return 'residential';
    }
    const lower = addressString.toLowerCase();
    for (const art of MAJOR_ARTERIALS) { if (lower.includes(art)) return 'major'; }
    if (/\bblvd\b|\bboulevard\b|\bave\b|\bavenue\b/.test(lower)) return 'secondary';
    return 'residential';
}

function detectSiteCondition(osmClass, osmType) {
    const structureClasses = ['building','amenity','shop','office','tourism','leisure','craft','club','healthcare'];
    if (structureClasses.includes(osmClass)) return 'demolition';
    if (osmClass === 'place' && ['house','building','apartments','residential'].includes(osmType)) return 'demolition';
    if (osmClass === 'place') return 'demolition';
    return 'vacant';
}

function estimateZoningFallback(addressString, addressDetails, neighborhood) {
    const lower = (addressString || '').toLowerCase();
    const road = (addressDetails && addressDetails.road) ? addressDetails.road.toLowerCase() : '';
    const commercialCorridors = [
        'wilshire','sunset blvd','santa monica blvd','hollywood blvd','venice blvd',
        'olympic','pico blvd','beverly blvd','melrose ave','3rd st','la brea',
        'la cienega','fairfax ave','robertson','highland ave','western ave',
        'vermont ave','figueroa','broadway','spring st','main st',
        'ventura blvd','lankershim','sepulveda blvd','van nuys blvd',
        'colorado blvd','brand blvd','glendale ave',
    ];
    const isCommercialCorridor = commercialCorridors.some(c => road.includes(c) || lower.includes(c));
    const industrialAreas = ['arts district','vernon','commerce','boyle heights industrial'];
    const isIndustrial = industrialAreas.some(a => lower.includes(a));
    if (neighborhood === 'dtla') return isIndustrial ? 'M1' : 'C2';
    if (isCommercialCorridor) return 'C2';
    if (addressDetails && addressDetails.type === 'apartments') return 'R3';
    const residentialSuffixes = /\b(ave|avenue|st|street|dr|drive|pl|place|way|ln|lane|ct|court|rd|road|blvd|ter|terrace|cir|circle)\b/i;
    const isResidential = residentialSuffixes.test(road) && !isCommercialCorridor;
    const residentialHoods = ['beverly','westside','santamonica','valleyeast','valleywest','silverlake','highland','venice','culver','southbay','harbor'];
    if (residentialHoods.includes(neighborhood) && isResidential) return 'R1';
    const denseHoods = ['koreatown','hollywood','midcity','exposition'];
    if (denseHoods.includes(neighborhood) && isResidential) return 'R3';
    if (['southla','boyleheights'].includes(neighborhood) && isResidential) return 'R1';
    if (isResidential) return 'R1';
    return null;
}

function mapZoningCode(rawZone) {
    if (!rawZone) return null;
    let z = rawZone.toUpperCase().replace(/\[.*?\]/g, '').trim();
    const match = z.match(/^(R[1-5]|C[1-5]|C1\.5|CM|M[1-3]|PF|OS|LAX)/);
    return match ? match[1] : null;
}

// ============================================================
//  GEOCODING & ZONING APIs
// ============================================================
async function geocodeAddress(address) {
    let query = address;
    if (!/los\s*angeles/i.test(query) && !/\bLA\b/.test(query)) query += ', Los Angeles, CA';
    const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&addressdetails=1&limit=1&countrycodes=us`;
    const resp = await fetch(url, { headers: { 'Accept': 'application/json' } });
    if (!resp.ok) throw new Error('Geocoding service unavailable');
    const data = await resp.json();
    if (!data || data.length === 0) throw new Error('Address not found. Try including city and zip code.');
    const m = data[0];
    return { lat: parseFloat(m.lat), lon: parseFloat(m.lon), matched: m.display_name, address: m.address || {}, osmClass: m.class || '', osmType: m.type || '' };
}

async function fetchZoning(lat, lon) {
    try {
        const url = `https://zimas.lacity.org/arcgis/rest/services/zma/zoning/MapServer/1102/query?geometry=${lon},${lat}&geometryType=esriGeometryPoint&inSR=4326&spatialRel=esriSpatialRelIntersects&outFields=ZONE_CMPLT&returnGeometry=false&f=json`;
        const resp = await fetch(url);
        if (!resp.ok) throw new Error('ZIMAS unavailable');
        const data = await resp.json();
        if (data.features && data.features.length > 0) {
            const raw = data.features[0].attributes.ZONE_CMPLT || data.features[0].attributes.zone_cmplt;
            return { raw, mapped: mapZoningCode(raw) };
        }
        return null;
    } catch (e) { return { error: 'cors' }; }
}

async function fetchParcelInfo(lat, lon) {
    try {
        const url = `https://public.gis.lacounty.gov/public/rest/services/LACounty_Cache/LACounty_Parcel/MapServer/0/query?geometry=${lon},${lat}&geometryType=esriGeometryPoint&inSR=4326&spatialRel=esriSpatialRelIntersects&outFields=*&returnGeometry=true&f=json`;
        const resp = await fetch(url);
        if (!resp.ok) throw new Error('Parcel service unavailable');
        const data = await resp.json();
        if (data.features && data.features.length > 0) {
            const attrs = data.features[0].attributes;
            let area = attrs['Shape.STArea()'] || attrs['Shape__Area'] || attrs['ShapeSTArea'] || attrs['SHAPE.STArea()'] || null;
            if (!area && data.features[0].geometry && data.features[0].geometry.rings) {
                area = computePolygonArea(data.features[0].geometry.rings, data.spatialReference);
            }
            return { area, attrs };
        }
        return null;
    } catch (e) { return { error: 'cors' }; }
}

function computePolygonArea(rings, sr) {
    let totalArea = 0;
    for (const ring of rings) {
        let a = 0;
        for (let i = 0; i < ring.length - 1; i++) { a += ring[i][0] * ring[i + 1][1] - ring[i + 1][0] * ring[i][1]; }
        totalArea += Math.abs(a) / 2;
    }
    if (sr && (sr.wkid === 102100 || sr.wkid === 3857)) {
        const latRad = 34.05 * Math.PI / 180;
        const scaleFactor = Math.cos(latRad);
        return Math.round(totalArea * scaleFactor * scaleFactor * 10.7639);
    }
    if (sr && (sr.wkid === 2229 || sr.wkid === 102645)) return Math.round(totalArea);
    return Math.round(totalArea);
}

function estimateFrontage(areaSqFt) {
    if (!areaSqFt || areaSqFt <= 0) return 80;
    return Math.round(Math.max(20, Math.min(500, Math.sqrt(areaSqFt / 2))));
}

// ============================================================
//  SCORING DATA (from developer portal)
// ============================================================
const LAND_USES = [
    { id:'sfr', name:'Single-Family Residential', icon:'üè°' },
    { id:'duplex', name:'Duplex / Two-Unit', icon:'üèòÔ∏è' },
    { id:'multifamily_low', name:'Multi-Family (Low-Rise)', icon:'üè¢' },
    { id:'multifamily_mid', name:'Multi-Family (Mid-Rise)', icon:'üèôÔ∏è' },
    { id:'multifamily_high', name:'Multi-Family (High-Rise)', icon:'üèóÔ∏è' },
    { id:'mixeduse', name:'Mixed-Use (Retail + Residential)', icon:'üè¨' },
    { id:'retail', name:'Retail / Restaurant', icon:'üõçÔ∏è' },
    { id:'office', name:'Office / Professional', icon:'üèõÔ∏è' },
    { id:'medical', name:'Medical Office', icon:'üè•' },
    { id:'hotel', name:'Hotel / Hospitality', icon:'üè®' },
    { id:'industrial', name:'Industrial / Warehouse', icon:'üè≠' },
    { id:'selfstorage', name:'Self-Storage', icon:'üì¶' },
    { id:'senior', name:'Senior Living / Assisted', icon:'üßì' },
    { id:'parking', name:'Parking Structure / Lot', icon:'üÖøÔ∏è' },
    { id:'creative', name:'Creative Office / Flex', icon:'üé®' },
    { id:'adu', name:'ADU / Small-Lot Subdivision', icon:'üè†' },
];

const ZONING_MATRIX = {
    'R1':  {sfr:1,duplex:0,multifamily_low:0,multifamily_mid:0,multifamily_high:0,mixeduse:0,retail:0,office:0,medical:0,hotel:0,industrial:0,selfstorage:0,senior:0.5,parking:0,creative:0,adu:1},
    'R2':  {sfr:1,duplex:1,multifamily_low:0.5,multifamily_mid:0,multifamily_high:0,mixeduse:0,retail:0,office:0,medical:0,hotel:0,industrial:0,selfstorage:0,senior:0.5,parking:0,creative:0,adu:1},
    'R3':  {sfr:1,duplex:1,multifamily_low:1,multifamily_mid:0.5,multifamily_high:0,mixeduse:0,retail:0,office:0,medical:0,hotel:0,industrial:0,selfstorage:0,senior:0.5,parking:0.5,creative:0,adu:1},
    'R4':  {sfr:0.5,duplex:1,multifamily_low:1,multifamily_mid:1,multifamily_high:0.5,mixeduse:0,retail:0,office:0,medical:0,hotel:0,industrial:0,selfstorage:0,senior:1,parking:0.5,creative:0,adu:0.5},
    'R5':  {sfr:0,duplex:0.5,multifamily_low:1,multifamily_mid:1,multifamily_high:1,mixeduse:0,retail:0,office:0,medical:0,hotel:0.5,industrial:0,selfstorage:0,senior:1,parking:0.5,creative:0,adu:0},
    'C1':  {sfr:0,duplex:0,multifamily_low:0.5,multifamily_mid:0,multifamily_high:0,mixeduse:0.5,retail:1,office:1,medical:1,hotel:0,industrial:0,selfstorage:0,senior:0,parking:1,creative:0.5,adu:0},
    'C1.5':{sfr:0,duplex:0,multifamily_low:0.5,multifamily_mid:0.5,multifamily_high:0,mixeduse:1,retail:1,office:1,medical:1,hotel:0.5,industrial:0,selfstorage:0,senior:0.5,parking:1,creative:0.5,adu:0},
    'C2':  {sfr:0,duplex:0,multifamily_low:1,multifamily_mid:1,multifamily_high:0.5,mixeduse:1,retail:1,office:1,medical:1,hotel:1,industrial:0,selfstorage:0.5,senior:1,parking:1,creative:1,adu:0},
    'C4':  {sfr:0,duplex:0,multifamily_low:0.5,multifamily_mid:1,multifamily_high:0.5,mixeduse:1,retail:1,office:1,medical:1,hotel:1,industrial:0,selfstorage:0.5,senior:0.5,parking:1,creative:1,adu:0},
    'C5':  {sfr:0,duplex:0,multifamily_low:0,multifamily_mid:0.5,multifamily_high:0,mixeduse:0.5,retail:1,office:1,medical:0.5,hotel:0.5,industrial:0,selfstorage:0.5,senior:0,parking:1,creative:0.5,adu:0},
    'CM':  {sfr:0,duplex:0,multifamily_low:0,multifamily_mid:0,multifamily_high:0,mixeduse:0.5,retail:0.5,office:1,medical:0.5,hotel:0,industrial:0.5,selfstorage:1,senior:0,parking:1,creative:1,adu:0},
    'M1':  {sfr:0,duplex:0,multifamily_low:0,multifamily_mid:0,multifamily_high:0,mixeduse:0,retail:0.5,office:0.5,medical:0,hotel:0,industrial:1,selfstorage:1,senior:0,parking:1,creative:1,adu:0},
    'M2':  {sfr:0,duplex:0,multifamily_low:0,multifamily_mid:0,multifamily_high:0,mixeduse:0,retail:0,office:0,medical:0,hotel:0,industrial:1,selfstorage:1,senior:0,parking:1,creative:0.5,adu:0},
    'M3':  {sfr:0,duplex:0,multifamily_low:0,multifamily_mid:0,multifamily_high:0,mixeduse:0,retail:0,office:0,medical:0,hotel:0,industrial:1,selfstorage:0.5,senior:0,parking:1,creative:0,adu:0},
    'PF':  {sfr:0,duplex:0,multifamily_low:0,multifamily_mid:0,multifamily_high:0,mixeduse:0,retail:0,office:0.5,medical:0.5,hotel:0,industrial:0,selfstorage:0,senior:0.5,parking:0.5,creative:0,adu:0},
    'OS':  {sfr:0,duplex:0,multifamily_low:0,multifamily_mid:0,multifamily_high:0,mixeduse:0,retail:0,office:0,medical:0,hotel:0,industrial:0,selfstorage:0,senior:0,parking:0,creative:0,adu:0},
    'LAX': {sfr:0,duplex:0,multifamily_low:0,multifamily_mid:0,multifamily_high:0,mixeduse:0,retail:0.5,office:0.5,medical:0,hotel:0.5,industrial:0.5,selfstorage:0.5,senior:0,parking:1,creative:0,adu:0},
    'TOD': {sfr:0,duplex:0.5,multifamily_low:1,multifamily_mid:1,multifamily_high:1,mixeduse:1,retail:1,office:1,medical:1,hotel:1,industrial:0,selfstorage:0,senior:1,parking:0.5,creative:1,adu:0.5},
};

const NEIGHBORHOOD_DEMAND = {
    dtla:{sfr:0.3,duplex:0.4,multifamily_low:1.1,multifamily_mid:1.3,multifamily_high:1.4,mixeduse:1.4,retail:1.2,office:1.3,medical:0.7,hotel:1.3,industrial:0.5,selfstorage:0.7,senior:0.6,parking:1.3,creative:1.4,adu:0.3},
    hollywood:{sfr:0.5,duplex:0.7,multifamily_low:1.2,multifamily_mid:1.3,multifamily_high:1.1,mixeduse:1.3,retail:1.2,office:1.0,medical:0.8,hotel:1.2,industrial:0.3,selfstorage:0.7,senior:0.5,parking:1.1,creative:1.3,adu:0.6},
    koreatown:{sfr:0.4,duplex:0.6,multifamily_low:1.3,multifamily_mid:1.4,multifamily_high:1.2,mixeduse:1.3,retail:1.2,office:0.9,medical:1.1,hotel:1.0,industrial:0.3,selfstorage:0.8,senior:0.8,parking:1.2,creative:0.9,adu:0.5},
    westside:{sfr:1.0,duplex:0.9,multifamily_low:1.1,multifamily_mid:1.2,multifamily_high:0.9,mixeduse:1.2,retail:1.1,office:1.2,medical:1.3,hotel:1.0,industrial:0.2,selfstorage:0.6,senior:1.0,parking:1.0,creative:1.1,adu:0.9},
    santamonica:{sfr:0.8,duplex:0.8,multifamily_low:1.0,multifamily_mid:1.1,multifamily_high:0.8,mixeduse:1.2,retail:1.3,office:1.1,medical:1.0,hotel:1.1,industrial:0.2,selfstorage:0.4,senior:0.8,parking:1.0,creative:1.2,adu:0.7},
    beverly:{sfr:1.2,duplex:0.8,multifamily_low:1.0,multifamily_mid:1.1,multifamily_high:0.9,mixeduse:1.1,retail:1.1,office:1.3,medical:1.4,hotel:1.1,industrial:0.1,selfstorage:0.3,senior:1.0,parking:0.9,creative:0.9,adu:0.7},
    midcity:{sfr:0.7,duplex:0.8,multifamily_low:1.2,multifamily_mid:1.2,multifamily_high:0.8,mixeduse:1.2,retail:1.0,office:0.9,medical:1.0,hotel:0.8,industrial:0.3,selfstorage:0.8,senior:0.9,parking:0.9,creative:1.0,adu:0.8},
    southla:{sfr:0.9,duplex:1.0,multifamily_low:1.1,multifamily_mid:0.8,multifamily_high:0.4,mixeduse:0.8,retail:0.8,office:0.5,medical:0.7,hotel:0.4,industrial:0.9,selfstorage:1.1,senior:0.7,parking:0.6,creative:0.6,adu:1.1},
    valleyeast:{sfr:1.1,duplex:1.0,multifamily_low:1.0,multifamily_mid:0.8,multifamily_high:0.5,mixeduse:0.9,retail:0.9,office:0.8,medical:0.9,hotel:0.6,industrial:1.0,selfstorage:1.1,senior:0.9,parking:0.7,creative:0.7,adu:1.0},
    valleywest:{sfr:1.2,duplex:1.0,multifamily_low:0.9,multifamily_mid:0.8,multifamily_high:0.4,mixeduse:0.9,retail:0.9,office:0.9,medical:1.0,hotel:0.6,industrial:0.8,selfstorage:1.0,senior:1.0,parking:0.6,creative:0.7,adu:1.0},
    silverlake:{sfr:0.9,duplex:0.9,multifamily_low:1.2,multifamily_mid:1.0,multifamily_high:0.5,mixeduse:1.2,retail:1.1,office:0.8,medical:0.7,hotel:0.7,industrial:0.3,selfstorage:0.5,senior:0.5,parking:0.7,creative:1.3,adu:1.0},
    highland:{sfr:0.9,duplex:0.9,multifamily_low:1.1,multifamily_mid:0.9,multifamily_high:0.4,mixeduse:1.1,retail:1.0,office:0.7,medical:0.7,hotel:0.5,industrial:0.5,selfstorage:0.7,senior:0.5,parking:0.6,creative:1.1,adu:1.0},
    venice:{sfr:0.9,duplex:0.8,multifamily_low:1.0,multifamily_mid:0.9,multifamily_high:0.5,mixeduse:1.2,retail:1.2,office:1.0,medical:0.7,hotel:1.0,industrial:0.2,selfstorage:0.3,senior:0.6,parking:0.8,creative:1.3,adu:0.8},
    culver:{sfr:0.8,duplex:0.8,multifamily_low:1.1,multifamily_mid:1.1,multifamily_high:0.7,mixeduse:1.2,retail:1.0,office:1.2,medical:1.0,hotel:0.9,industrial:0.5,selfstorage:0.7,senior:0.8,parking:0.8,creative:1.3,adu:0.8},
    exposition:{sfr:0.6,duplex:0.7,multifamily_low:1.2,multifamily_mid:1.2,multifamily_high:0.9,mixeduse:1.2,retail:1.0,office:0.9,medical:0.8,hotel:0.7,industrial:0.4,selfstorage:0.8,senior:0.7,parking:0.9,creative:1.0,adu:0.8},
    southbay:{sfr:1.0,duplex:0.9,multifamily_low:0.9,multifamily_mid:0.7,multifamily_high:0.3,mixeduse:0.8,retail:0.9,office:0.8,medical:1.0,hotel:0.7,industrial:1.2,selfstorage:1.1,senior:0.9,parking:0.6,creative:0.6,adu:0.9},
    harbor:{sfr:0.7,duplex:0.7,multifamily_low:0.8,multifamily_mid:0.6,multifamily_high:0.3,mixeduse:0.7,retail:0.7,office:0.5,medical:0.6,hotel:0.6,industrial:1.3,selfstorage:1.1,senior:0.7,parking:0.7,creative:0.5,adu:0.7},
    boyleheights:{sfr:0.9,duplex:1.0,multifamily_low:1.1,multifamily_mid:0.7,multifamily_high:0.3,mixeduse:0.9,retail:0.9,office:0.5,medical:0.6,hotel:0.3,industrial:0.8,selfstorage:0.9,senior:0.6,parking:0.5,creative:0.8,adu:1.1},
};

const MIN_PARCEL = {sfr:2500,duplex:3500,multifamily_low:5000,multifamily_mid:10000,multifamily_high:20000,mixeduse:5000,retail:2000,office:3000,medical:3000,hotel:15000,industrial:5000,selfstorage:8000,senior:15000,parking:3000,creative:3000,adu:1200};
const LAND_VALUE_PSF = {dtla:250,hollywood:250,koreatown:200,westside:350,santamonica:400,beverly:450,midcity:180,southla:85,valleyeast:110,valleywest:130,silverlake:220,highland:150,venice:350,culver:260,exposition:160,southbay:120,harbor:80,boyleheights:110};
const REVENUE_PSF = {sfr:40,duplex:42,multifamily_low:52,multifamily_mid:58,multifamily_high:66,mixeduse:56,retail:52,office:52,medical:62,hotel:90,industrial:22,selfstorage:24,senior:62,parking:30,creative:52,adu:46};
const NEIGHBORHOOD_RENT_MULT = {dtla:0.95,hollywood:1.10,koreatown:0.88,westside:1.25,santamonica:1.35,beverly:1.40,midcity:1.00,southla:0.70,valleyeast:0.82,valleywest:0.85,silverlake:1.08,highland:0.88,venice:1.25,culver:1.12,exposition:0.88,southbay:0.85,harbor:0.70,boyleheights:0.75};
const PARKING_COST_MAP = {sfr:8000,duplex:8000,multifamily_low:30000,multifamily_mid:40000,multifamily_high:65000,mixeduse:40000,retail:8000,office:40000,medical:40000,hotel:55000,industrial:5000,selfstorage:5000,senior:30000,parking:35000,creative:8000,adu:5000};
const BUILD_COST_PSF = {sfr:300,duplex:275,multifamily_low:310,multifamily_mid:400,multifamily_high:575,mixeduse:420,retail:260,office:365,medical:430,hotel:480,industrial:150,selfstorage:110,senior:400,parking:85,creative:290,adu:280};
const FAR_TYPICAL = {sfr:0.5,duplex:0.6,multifamily_low:1.5,multifamily_mid:3.0,multifamily_high:6.0,mixeduse:3.0,retail:0.5,office:2.0,medical:1.5,hotel:4.0,industrial:0.5,selfstorage:2.5,senior:2.5,parking:3.0,creative:1.5,adu:0.5};

const BUILDING_PARAMS = {
    sfr:{stories:2,floorH:10,eff:0.92,unitSF:1800,parkRatio:2.0,setF:20,setS:5,opex:0.30,cap:0.045},
    duplex:{stories:2,floorH:10,eff:0.90,unitSF:1200,parkRatio:1.5,setF:15,setS:5,opex:0.32,cap:0.047},
    multifamily_low:{stories:4,floorH:10,eff:0.82,unitSF:850,parkRatio:1.25,setF:10,setS:5,opex:0.35,cap:0.047},
    multifamily_mid:{stories:7,floorH:10,eff:0.80,unitSF:800,parkRatio:1.0,setF:10,setS:5,opex:0.35,cap:0.045},
    multifamily_high:{stories:18,floorH:10,eff:0.78,unitSF:750,parkRatio:1.0,setF:10,setS:10,opex:0.38,cap:0.042},
    mixeduse:{stories:6,floorH:12,eff:0.80,unitSF:850,parkRatio:1.0,setF:0,setS:0,opex:0.36,cap:0.048},
    retail:{stories:1,floorH:16,eff:0.88,unitSF:null,parkRatio:4.0,setF:0,setS:0,opex:0.32,cap:0.058},
    office:{stories:5,floorH:13,eff:0.85,unitSF:null,parkRatio:3.0,setF:5,setS:5,opex:0.38,cap:0.065},
    medical:{stories:4,floorH:13,eff:0.82,unitSF:null,parkRatio:4.0,setF:10,setS:5,opex:0.40,cap:0.055},
    hotel:{stories:10,floorH:11,eff:0.75,unitSF:400,parkRatio:0.5,setF:5,setS:5,opex:0.55,cap:0.070},
    industrial:{stories:1,floorH:24,eff:0.92,unitSF:null,parkRatio:1.0,setF:10,setS:5,opex:0.28,cap:0.052},
    selfstorage:{stories:4,floorH:9,eff:0.88,unitSF:null,parkRatio:0.2,setF:5,setS:5,opex:0.30,cap:0.062},
    senior:{stories:5,floorH:10,eff:0.78,unitSF:600,parkRatio:0.5,setF:10,setS:5,opex:0.50,cap:0.058},
    parking:{stories:5,floorH:11,eff:0.90,unitSF:null,parkRatio:null,setF:0,setS:0,opex:0.25,cap:0.065},
    creative:{stories:3,floorH:14,eff:0.85,unitSF:null,parkRatio:2.5,setF:0,setS:0,opex:0.32,cap:0.058},
    adu:{stories:2,floorH:9,eff:0.90,unitSF:600,parkRatio:0,setF:5,setS:4,opex:0.30,cap:0.048},
};

const RATIONALE = {
    sfr:'Single-family development suits the site due to residential zoning, neighborhood character, and stable demand.',
    duplex:'Duplex provides moderate density with manageable entitlement complexity, strong for rental income strategies.',
    multifamily_low:'Low-rise multifamily maximizes unit count within a manageable building type, aligning with LA housing demand.',
    multifamily_mid:'Mid-rise multifamily leverages parcel size and zoning for meaningful density, supported by strong rental fundamentals.',
    multifamily_high:'High-rise captures maximum density bonus potential in a high-demand corridor.',
    mixeduse:'Mixed-use combines ground-floor commercial with residential density above, ideal for transit-accessible corridors.',
    retail:'Retail leverages street frontage, visibility, and pedestrian traffic in a commercial corridor.',
    office:'Office responds to professional service demand with viable access and infrastructure.',
    medical:'Medical office benefits from proximity to health care services and premium tenant rents.',
    hotel:'Hotel leverages tourism and business travel demand with arterial visibility and transit proximity.',
    industrial:'Industrial provides strong yield potential with lower construction costs and limited supply.',
    selfstorage:'Self-storage is operationally efficient with low staffing costs and reliable demand.',
    senior:'Senior living addresses the growing aging population with premium per-unit revenue.',
    parking:'Parking addresses chronic parking deficits in dense urban areas with modest build costs.',
    creative:'Creative office appeals to tech and media tenants seeking character space with premium rents.',
    adu:'ADU maximizes yield on smaller parcels under CA housing legislation with minimal entitlement friction.',
};

// ============================================================
//  LEGISLATION
// ============================================================
const CA_HOUSING_LEGISLATION = [
    { id:'sb9', name:'SB 9 (HOME Act)', description:'By-right duplex and lot splits on single-family parcels.',
      applies:(useId,inp)=>inp.zoning==='R1'&&inp.parcelSize>=2400&&['duplex','adu'].includes(useId), densityBonus:1.0, parkingReduction:0, softCostReduction:0, legalOverride:true },
    { id:'ab2011', name:'AB 2011', description:'By-right affordable housing on commercially zoned land.',
      applies:(useId,inp)=>['C1','C1.5','C2','C4','C5','CM'].includes(inp.zoning)&&['multifamily_low','multifamily_mid','multifamily_high','mixeduse'].includes(useId), densityBonus:0.35, parkingReduction:0, softCostReduction:0, legalOverride:true },
    { id:'sb6', name:'SB 6', description:'Market-rate housing on commercially zoned land.',
      applies:(useId,inp)=>['C1','C1.5','C2','C4','C5','CM'].includes(inp.zoning)&&['multifamily_low','multifamily_mid','multifamily_high','mixeduse'].includes(useId), densityBonus:0.25, parkingReduction:0, softCostReduction:0, legalOverride:false },
    { id:'sb423', name:'SB 423 (Streamlined)', description:'Streamlined approval for multifamily projects meeting affordability thresholds.',
      applies:(useId,inp)=>['R2','R3','R4','R5','C1.5','C2','C4','TOD'].includes(inp.zoning)&&['multifamily_low','multifamily_mid','multifamily_high','mixeduse'].includes(useId), densityBonus:0, parkingReduction:0, softCostReduction:0.15, legalOverride:false },
    { id:'ab2345', name:'AB 2345 (Density Bonus)', description:'Up to 50% density bonus and reduced parking for projects with affordable units.',
      applies:(useId,inp)=>['R2','R3','R4','R5','C1','C1.5','C2','C4','TOD'].includes(inp.zoning)&&['duplex','multifamily_low','multifamily_mid','multifamily_high','mixeduse','senior'].includes(useId), densityBonus:0.50, parkingReduction:0.20, softCostReduction:0, legalOverride:false },
    { id:'ab1763', name:'AB 1763', description:'Unlimited density for 100% affordable housing near transit.',
      applies:(useId,inp)=>['adjacent','near'].includes(inp.transit)&&['multifamily_low','multifamily_mid','multifamily_high','senior'].includes(useId), densityBonus:1.0, parkingReduction:0, softCostReduction:0, legalOverride:true },
    { id:'toc', name:'TOC (LA Local)', description:'Transit Oriented Communities ‚Äî up to 80% density bonus near transit.',
      applies:(useId,inp)=>['adjacent','near'].includes(inp.transit)&&['multifamily_low','multifamily_mid','multifamily_high','mixeduse'].includes(useId), densityBonus:0.80, parkingReduction:0.30, softCostReduction:0, legalOverride:false },
    { id:'ab2097', name:'AB 2097', description:'Eliminates minimum parking within 1/2 mile of transit.',
      applies:(useId,inp)=>['adjacent','near'].includes(inp.transit), densityBonus:0, parkingReduction:1.0, softCostReduction:0, legalOverride:false },
    { id:'adu_reform', name:'ADU Reform (AB 68/SB 13)', description:'By-right ADU on residential lots; no parking near transit.',
      applies:(useId,inp)=>['R1','R2','R3','R4','R5'].includes(inp.zoning)&&useId==='adu', densityBonus:0, parkingReduction:0, softCostReduction:0, legalOverride:true },
    { id:'sb478', name:'SB 478', description:'Minimum 1.0 FAR for multifamily on parcels up to 10,000 SF.',
      applies:(useId,inp)=>inp.parcelSize<=10000&&['R3','R4','R5','C1.5','C2','C4','TOD'].includes(inp.zoning)&&['multifamily_low','multifamily_mid','multifamily_high'].includes(useId), densityBonus:0, parkingReduction:0, softCostReduction:0, legalOverride:false, minFAR:1.0 },
    { id:'ed1', name:'ED1 (LA Local)', description:'Streamlined approvals for 100% affordable and senior housing.',
      applies:(useId,inp)=>['multifamily_low','multifamily_mid','multifamily_high','senior'].includes(useId), densityBonus:0.35, parkingReduction:0, softCostReduction:0.20, legalOverride:false },
    { id:'sb684', name:'SB 684', description:'By-right approval for 10+ unit housing on commercial land.',
      applies:(useId,inp)=>['C1','C1.5','C2','C4','C5','CM'].includes(inp.zoning)&&['multifamily_low','multifamily_mid','multifamily_high','mixeduse'].includes(useId), densityBonus:0, parkingReduction:0, softCostReduction:0, legalOverride:true },
    { id:'sb79', name:'SB 79 (Transit-Oriented)', description:'Overrides local zoning near transit ‚Äî up to 95ft, 160 du/acre, 4.5 FAR.',
      applies:(useId,inp)=>{
          if (!window._agentGeocode) return false;
          if (!['multifamily_low','multifamily_mid','multifamily_high','mixeduse','senior','hotel'].includes(useId)) return false;
          return detectSB79Eligibility(window._agentGeocode.lat, window._agentGeocode.lon).eligible;
      },
      get densityBonus(){ if(!window._agentGeocode)return 0; const s=detectSB79Eligibility(window._agentGeocode.lat,window._agentGeocode.lon); return s.eligible?s.allowances.far/3.0-1:0; },
      get parkingReduction(){ if(!window._agentGeocode)return 0; const s=detectSB79Eligibility(window._agentGeocode.lat,window._agentGeocode.lon); return s.eligible?(s.allowances.parking===0?1.0:0.5):0; },
      softCostReduction:0.10, legalOverride:true,
      get minFAR(){ if(!window._agentGeocode)return 0; const s=detectSB79Eligibility(window._agentGeocode.lat,window._agentGeocode.lon); return s.eligible?s.allowances.far:0; },
    },
];

function getApplicableLegislation(useId, inp) { return CA_HOUSING_LEGISLATION.filter(b => b.applies(useId, inp)); }

function stackLegislationEffects(list) {
    let densityBonus=0, parkingReduction=0, softCostReduction=0, legalOverride=false, minFAR=0;
    for (const b of list) {
        densityBonus = Math.max(densityBonus, b.densityBonus||0);
        parkingReduction = Math.max(parkingReduction, b.parkingReduction||0);
        softCostReduction += (b.softCostReduction||0);
        if (b.legalOverride) legalOverride = true;
        minFAR = Math.max(minFAR, b.minFAR||0);
    }
    return { densityBonus, parkingReduction, softCostReduction: Math.min(softCostReduction, 0.50), legalOverride, minFAR };
}

// ============================================================
//  SCORING (simplified from developer portal)
// ============================================================
function calcSiteWorkBreakdown(useId, inp, gsf) {
    var lot = inp.parcelSize || 10000;
    if (useId === 'adu') {
        var a = Math.min(lot * 0.3, gsf || 800);
        return { total: Math.round(a * 11) };
    }
    var rates = { clearing:2.00, grading:3.50, soilPrep:2.50, utilities:5.00, erosion:1.25 };
    if (inp.topography==='steep'){rates.grading=10;rates.soilPrep=4.5;rates.erosion=2;}
    else if(inp.topography==='moderate'){rates.grading=6;rates.soilPrep=3.25;rates.erosion=1.5;}
    if(inp.siteCondition==='vacant')rates.clearing=1.5;
    else if(inp.siteCondition==='brownfield'){rates.clearing=4;rates.soilPrep=4;}
    else if(inp.siteCondition==='demolition')rates.clearing=3.5;
    if(inp.utilities==='partial')rates.utilities=7;else if(inp.utilities==='none')rates.utilities=12;
    if(inp.constFlood){rates.grading+=2;rates.erosion+=0.75;}
    if(inp.constHillside)rates.grading+=3;
    if(inp.constFault)rates.soilPrep+=1.5;
    return { total: Math.round(lot*(rates.clearing+rates.grading+rates.soilPrep+rates.utilities+rates.erosion)) };
}

function scoreLegal(useId, inp, effects) {
    const zoneRow = ZONING_MATRIX[inp.zoning]; if (!zoneRow) return 0;
    let base = zoneRow[useId] || 0;
    if (effects && effects.legalOverride) base = 1.0;
    if (inp.constHistoric && ['multifamily_high','hotel','industrial'].includes(useId)) base *= 0.5;
    if (inp.constCoastal && ['industrial','multifamily_high','selfstorage'].includes(useId)) base *= 0.4;
    if (inp.constHillside && ['multifamily_mid','multifamily_high','hotel','industrial'].includes(useId)) base *= 0.3;
    return Math.min(base, 1.0);
}

function scorePhysical(useId, inp) {
    let score = 1.0;
    const minSqFt = MIN_PARCEL[useId] || 2000;
    if (inp.parcelSize < minSqFt) score *= Math.max(0.1, inp.parcelSize / minSqFt);
    if (['retail','mixeduse','hotel','office','medical'].includes(useId) && inp.frontage < 50) score *= 0.6;
    const topoPenalty = { flat:1.0, gentle:0.9, moderate:0.65, steep:0.3 };
    score *= (topoPenalty[inp.topography] || 1.0);
    if (inp.siteCondition === 'demolition') score *= 0.85;
    if (inp.siteCondition === 'brownfield') score *= 0.6;
    return Math.min(score, 1.0);
}

function scoreFinancial(useId, inp, effects) {
    const baseFAR = FAR_TYPICAL[useId]||1.0;
    let far = baseFAR;
    if(effects){far=baseFAR*(1+effects.densityBonus);if(effects.minFAR>0)far=Math.max(far,effects.minFAR);}
    const params=BUILDING_PARAMS[useId];
    const buildableSF=inp.parcelSize*far;
    const nsf=buildableSF*(params?params.eff:0.82);
    const landValuePSF=LAND_VALUE_PSF[inp.neighborhood]||150;
    const landCost=useId==='adu'?0:inp.parcelSize*landValuePSF;
    let buildCostPerSF=BUILD_COST_PSF[useId]||300;
    if(effects&&effects.parkingReduction>0)buildCostPerSF*=(1-effects.parkingReduction*0.18);
    const buildCost=buildableSF*buildCostPerSF;
    const parkCostPerSpace=PARKING_COST_MAP[useId]||35000;
    const baseParkRatio=params?(params.parkRatio||0):0;
    const parkReduction=effects?effects.parkingReduction:0;
    const hasUnits=params&&params.unitSF;
    let parkSpaces=0;
    if(useId==='parking')parkSpaces=Math.round(buildableSF/350);
    else if(hasUnits)parkSpaces=Math.max(0,Math.ceil(Math.floor(nsf/params.unitSF)*baseParkRatio*(1-parkReduction)));
    else parkSpaces=Math.max(0,Math.ceil(buildableSF/1000*baseParkRatio*(1-parkReduction)));
    const parkingCost=parkSpaces*parkCostPerSpace;
    const siteWorkCost=calcSiteWorkBreakdown(useId,inp,buildableSF).total;
    const hardCostBase=buildCost+parkingCost+siteWorkCost;
    const totalHard=hardCostBase*1.11;
    const totalSoft=totalHard*0.235;
    let totalCost=landCost+totalHard+totalSoft;
    if(effects&&effects.softCostReduction>0)totalCost-=totalSoft*effects.softCostReduction*0.20;
    const rentMult=NEIGHBORHOOD_RENT_MULT[inp.neighborhood]||1.0;
    const opexRate=params?params.opex:0.35;
    const annualNOI=nsf*(REVENUE_PSF[useId]||30)*rentMult*(1-opexRate);
    const yieldOnCost=annualNOI/totalCost;
    const capRate=params?params.cap:0.05;
    const devMargin=capRate>0?(yieldOnCost/capRate-1):0;
    let score;
    if(devMargin>=0.25)score=1.0;
    else if(devMargin>=0.15)score=0.75+(devMargin-0.15)/0.10*0.25;
    else if(devMargin>=0.05)score=0.45+(devMargin-0.05)/0.10*0.30;
    else if(devMargin>=0)score=0.20+(devMargin/0.05)*0.25;
    else if(devMargin>=-0.15)score=Math.max(0.02,0.20+devMargin*1.2);
    else score=0.02;
    const demandRow=NEIGHBORHOOD_DEMAND[inp.neighborhood];
    score*=(demandRow?(demandRow[useId]||0.7):0.7);
    if(inp.cornerLot&&['retail','mixeduse','hotel','office','medical'].includes(useId))score*=1.15;
    const transitBonus={adjacent:1.2,near:1.1,moderate:1.0,far:0.85};
    if(['multifamily_mid','multifamily_high','mixeduse','office','hotel'].includes(useId))score*=(transitBonus[inp.transit]||1.0);
    if(inp.arterial==='major'&&['retail','mixeduse','hotel','office'].includes(useId))score*=1.1;
    if(inp.arterial==='residential'&&['retail','hotel','industrial'].includes(useId))score*=0.7;
    if(inp.siteCondition==='demolition')score*=0.9;
    if(inp.siteCondition==='brownfield')score*=0.7;
    if(useId==='adu'){score=Math.max(score,0.55);if(['R1','R2','R3'].includes(inp.zoning))score*=1.25;}
    return Math.min(score, 1.0);
}

function scoreProductive(useId, inp, effects) {
    const baseFAR=FAR_TYPICAL[useId]||1.0;
    let far=baseFAR;
    if(effects){far=baseFAR*(1+effects.densityBonus);if(effects.minFAR>0)far=Math.max(far,effects.minFAR);}
    const buildableSF=inp.parcelSize*far;
    const revenuePSF=REVENUE_PSF[useId]||30;
    const rentMult=NEIGHBORHOOD_RENT_MULT[inp.neighborhood]||1.0;
    const totalAnnualRev=buildableSF*revenuePSF*rentMult;
    const landValuePSF=LAND_VALUE_PSF[inp.neighborhood]||150;
    const revToLand=totalAnnualRev/(inp.parcelSize*landValuePSF);
    let score;
    if(revToLand>=0.20)score=1.0;else if(revToLand>=0.10)score=0.5+(revToLand-0.10)/0.10*0.5;else score=revToLand/0.10*0.5;
    const demandRow=NEIGHBORHOOD_DEMAND[inp.neighborhood];
    score*=(demandRow?(demandRow[useId]||0.7):0.7);
    if(useId==='adu'){score=Math.max(score,0.45);if(['R1','R2','R3'].includes(inp.zoning))score*=1.20;}
    return Math.min(score, 1.0);
}

function generateBudget(useId, inp, effects) {
    const params=BUILDING_PARAMS[useId];
    const baseFAR=FAR_TYPICAL[useId]||1.0;
    let far=baseFAR;
    if(effects){far=baseFAR*(1+effects.densityBonus);if(effects.minFAR>0)far=Math.max(far,effects.minFAR);}
    const gsf=Math.round(inp.parcelSize*far);
    const nsf=Math.round(gsf*params.eff);
    const units=params.unitSF?Math.max(1,Math.floor(nsf/params.unitSF)):null;
    const landValuePSF=LAND_VALUE_PSF[inp.neighborhood]||150;
    const landCost=useId==='adu'?0:inp.parcelSize*landValuePSF;
    const siteWork=calcSiteWorkBreakdown(useId,inp,gsf).total;
    const demolition=(inp.siteCondition==='demolition'&&useId!=='adu')?inp.parcelSize*12:0;
    let buildCostPSF=BUILD_COST_PSF[useId]||300;
    if(effects&&effects.parkingReduction>0)buildCostPSF*=(1-effects.parkingReduction*0.18);
    const construction=gsf*buildCostPSF;
    const baseParkRatio=params.parkRatio||0;
    const parkReduction=effects?effects.parkingReduction:0;
    let parkingSpaces;
    if(useId==='parking')parkingSpaces=Math.round(gsf/350);
    else if(units)parkingSpaces=Math.max(0,Math.ceil(units*baseParkRatio*(1-parkReduction)));
    else parkingSpaces=Math.max(0,Math.ceil(gsf/1000*baseParkRatio*(1-parkReduction)));
    const parkingCost=parkingSpaces*(PARKING_COST_MAP[useId]||35000);
    const landscaping=Math.round(construction*0.04);
    const hardContingency=Math.round((siteWork+demolition+construction+parkingCost+landscaping)*0.07);
    const totalHard=siteWork+demolition+construction+parkingCost+landscaping+hardContingency;
    const totalSoft=Math.round(totalHard*0.235);
    const totalDev=landCost+totalHard+totalSoft;
    const rentMult=NEIGHBORHOOD_RENT_MULT[inp.neighborhood]||1.0;
    const revenuePSF=(REVENUE_PSF[useId]||30)*rentMult;
    const grossRevenue=nsf*revenuePSF;
    const noi=grossRevenue-Math.round(grossRevenue*params.opex);
    const capRate=params.cap||0.05;
    const stabilizedValue=capRate>0?Math.round(noi/capRate):0;
    const devMargin=totalDev>0?(stabilizedValue-totalDev)/totalDev:0;
    return { gsf, nsf, units, far, landCost, totalDev, stabilizedValue, devMargin, noi, capRate };
}

// ============================================================
//  MAIN AGENT ANALYSIS
// ============================================================
async function runAgentAnalysis() {
    const address = document.getElementById('addressInput').value.trim();
    if (!address) { setStatus('<span class="err">Please enter an address.</span>'); return; }

    const btn = document.getElementById('btnSearch');
    btn.disabled = true; btn.textContent = 'Analyzing...';
    setStatus('<span class="loading">Geocoding address...</span>');

    let coords;
    try {
        coords = await geocodeAddress(address);
        setStatus('<span class="ok">Matched: ' + coords.matched + '</span>');
    } catch (e) {
        setStatus('<span class="err">' + e.message + '</span>');
        btn.disabled = false; btn.textContent = 'Analyze'; return;
    }

    window._agentGeocode = { lat: coords.lat, lon: coords.lon };

    setStatus('<span class="ok">Matched: ' + coords.matched + '</span><br><span class="loading">Querying zoning &amp; parcel data...</span>');

    const [zoningResult, parcelResult] = await Promise.all([
        fetchZoning(coords.lat, coords.lon),
        fetchParcelInfo(coords.lat, coords.lon),
    ]);

    // Determine neighborhood
    const hood = detectNeighborhood(coords.lat, coords.lon, coords.address);

    // Determine zoning
    let zoning = null, zoningRaw = '';
    if (zoningResult && !zoningResult.error && zoningResult.mapped) {
        zoning = zoningResult.mapped; zoningRaw = zoningResult.raw;
    } else {
        zoning = estimateZoningFallback(coords.matched || address, coords.address, hood) || 'R1';
        zoningRaw = zoning + ' (estimated)';
    }

    // Determine parcel size
    let parcelSize = 7500, parcelSizeLabel = '7,500 SF (default)';
    if (parcelResult && !parcelResult.error && parcelResult.area && parcelResult.area > 0) {
        parcelSize = Math.round(parcelResult.area);
        parcelSizeLabel = parcelSize.toLocaleString() + ' SF';
    }

    const frontage = estimateFrontage(parcelSize);
    const transit = detectTransitProximity(coords.lat, coords.lon);
    const arterial = detectArterial(coords.matched || address, coords.address);
    const siteCondition = detectSiteCondition(coords.osmClass, coords.osmType);
    const sb79 = detectSB79Eligibility(coords.lat, coords.lon);

    // Build input object (same structure as developer portal)
    const inp = {
        parcelSize, frontage, zoning, neighborhood: hood,
        siteCondition, topography: 'flat', cornerLot: false,
        transit, arterial, utilities: 'full',
        constFlood: false, constHillside: false, constHistoric: false,
        constFault: false, constCoastal: false, constParking: false,
    };

    // Status
    let statusParts = ['<span class="ok">Matched: ' + coords.matched + '</span>'];
    statusParts.push('<span class="ok">Zoning: ' + zoningRaw + '</span>');
    statusParts.push('<span class="ok">Lot: ' + parcelSizeLabel + '</span>');
    if (sb79.eligible) statusParts.push('<span class="ok">SB 79 Eligible ‚Äî ' + sb79.tierLabel + ', ' + sb79.zoneLabel + '</span>');
    setStatus(statusParts.join('<br>'));

    // Score all uses
    const results = LAND_USES.map(use => {
        const legislation = getApplicableLegislation(use.id, inp);
        const effects = stackLegislationEffects(legislation);
        const legal = scoreLegal(use.id, inp, effects);
        const physical = scorePhysical(use.id, inp);
        const financial = scoreFinancial(use.id, inp, effects);
        const productive = scoreProductive(use.id, inp, effects);
        const budget = generateBudget(use.id, inp, effects);
        let overall;
        if (legal === 0) overall = 0;
        else {
            overall = legal*0.25 + physical*0.20 + financial*0.30 + productive*0.25;
            if (legal <= 0.5) overall *= 0.8;
            if (budget.devMargin < -0.15) overall *= 0.50;
            else if (budget.devMargin < -0.05) overall *= 0.65;
            else if (budget.devMargin < 0) overall *= 0.80;
        }
        return { ...use, overall: Math.round(overall*100), legislation, budget };
    });
    results.sort((a, b) => b.overall - a.overall);

    // Collect all unique applicable legislation
    const allLeg = new Set();
    results.forEach(r => r.legislation.forEach(l => allLeg.add(l.id)));

    // Render
    renderOverview(coords, inp, zoningRaw, parcelSizeLabel, hood, sb79);
    renderLegislation(allLeg, inp, sb79);
    renderUplift(inp, results);
    renderHBU(results);

    document.getElementById('resultsSection').style.display = 'block';
    document.getElementById('printSubtitle').textContent = coords.matched + ' | Generated ' + new Date().toLocaleDateString();
    document.getElementById('printDate').textContent = new Date().toLocaleDateString();

    btn.disabled = false; btn.textContent = 'Analyze';

    // Scroll to results
    document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
}

function setStatus(html) { document.getElementById('searchStatus').innerHTML = html; }

function fmt$(n) { if (n >= 1e6) return '$' + (n/1e6).toFixed(1) + 'M'; if (n >= 1e3) return '$' + Math.round(n/1e3) + 'K'; return '$' + n; }

// ============================================================
//  RENDER FUNCTIONS
// ============================================================
function renderOverview(coords, inp, zoningRaw, parcelSizeLabel, hood, sb79) {
    const transitLabels = { adjacent: 'Adjacent (<0.25 mi)', near: 'Near (0.25-0.5 mi)', moderate: 'Moderate (0.5-1 mi)', far: 'Far (>1 mi)' };
    let items = [
        { label: 'Address', val: coords.matched.split(',').slice(0,2).join(',') },
        { label: 'Lot Size', val: parcelSizeLabel },
        { label: 'Zoning', val: zoningRaw },
        { label: 'Neighborhood', val: NEIGHBORHOOD_LABELS[hood] || hood },
        { label: 'Transit Proximity', val: transitLabels[inp.transit] || inp.transit },
        { label: 'Site Condition', val: inp.siteCondition.charAt(0).toUpperCase() + inp.siteCondition.slice(1) },
    ];
    if (sb79.eligible) {
        items.push({ label: 'SB 79 Status', val: sb79.tierLabel + ' ‚Äî ' + sb79.zoneLabel });
        items.push({ label: 'Nearest Station', val: sb79.station.name + ' (' + (sb79.distMiles*5280).toFixed(0) + ' ft)' });
    }
    document.getElementById('overviewGrid').innerHTML = items.map(i =>
        '<div class="overview-item"><label>' + i.label + '</label><div class="val">' + i.val + '</div></div>'
    ).join('');
}

function renderLegislation(allLeg, inp, sb79) {
    let html = '';
    CA_HOUSING_LEGISLATION.forEach(bill => {
        // Check if this bill applies to ANY use for this property
        const applies = allLeg.has(bill.id);
        const cls = applies ? 'eligible' : 'ineligible';
        const badge = applies ? '<span class="leg-badge pass">Eligible</span>' : '<span class="leg-badge fail">Not Applicable</span>';
        html += '<div class="leg-card ' + cls + '">' + badge + '<h4>' + bill.name + '</h4><p>' + bill.description + '</p></div>';
    });
    document.getElementById('legGrid').innerHTML = html;
}

function renderUplift(inp, results) {
    const landValue = inp.parcelSize * (LAND_VALUE_PSF[inp.neighborhood] || 150);
    const bestResult = results[0];
    const devValue = bestResult ? bestResult.budget.stabilizedValue : landValue;
    const uplift = devValue > 0 && landValue > 0 ? ((devValue - landValue) / landValue * 100) : 0;
    document.getElementById('upliftGrid').innerHTML =
        '<div class="uplift-item"><div class="label">Current Land Value</div><div class="value">' + fmt$(landValue) + '</div></div>' +
        '<div class="uplift-item"><div class="label">Development Value (Best Use)</div><div class="value highlight">' + fmt$(devValue) + '</div></div>' +
        '<div class="uplift-item"><div class="label">Value Uplift</div><div class="value highlight">' + (uplift > 0 ? '+' : '') + Math.round(uplift) + '%</div></div>';
}

function renderHBU(results) {
    const top3 = results.filter(r => r.overall > 0).slice(0, 3);
    if (top3.length === 0) {
        document.getElementById('hbuList').innerHTML = '<p style="color:var(--text-light);">No viable development uses identified for this parcel.</p>';
        return;
    }
    document.getElementById('hbuList').innerHTML = top3.map((r, i) => {
        const rankCls = i === 0 ? 'r1' : i === 1 ? 'r2' : 'r3';
        return '<div class="hbu-card">' +
            '<div class="hbu-rank ' + rankCls + '">' + (i+1) + '</div>' +
            '<div class="hbu-icon">' + r.icon + '</div>' +
            '<div class="hbu-info"><h4>' + r.name + '</h4><p>' + (RATIONALE[r.id] || '') + '</p></div>' +
            '<div class="hbu-score"><div class="num">' + r.overall + '</div><div class="lbl">HBU Score</div>' +
            '<div class="score-bar"><div class="score-bar-fill" style="width:' + r.overall + '%;"></div></div></div>' +
            '</div>';
    }).join('');
}
</script>
</body>
</html>
