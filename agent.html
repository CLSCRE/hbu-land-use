<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Portal â€” Land to Yield</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/@geoman-io/leaflet-geoman-free@2.16.0/dist/leaflet-geoman.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@geoman-io/leaflet-geoman-free@2.16.0/dist/leaflet-geoman.min.js"></script>
    <style>
        :root {
            --primary: #0d9488;
            --primary-light: #14b8a6;
            --primary-dark: #0f766e;
            --accent: #0ea5e9;
            --accent-dark: #0284c7;
            --bg: #f0fdfa;
            --card: #ffffff;
            --text: #1e293b;
            --text-light: #64748b;
            --border: #e2e8f0;
            --success: #10b981;
            --gold: #d4a020;
            --silver: #8a8a8a;
            --bronze: #b87333;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        header {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary), var(--primary-light));
            color: white;
            padding: 1.5rem 2rem;
            text-align: center;
            box-shadow: 0 4px 12px rgba(13,148,136,0.25);
        }

        header h1 {
            font-size: 1.8rem;
            font-weight: 800;
            margin-bottom: 0.25rem;
        }

        header p {
            font-size: 0.95rem;
            opacity: 0.85;
        }

        .header-nav {
            margin-top: 0.75rem;
            display: flex;
            justify-content: center;
            gap: 1.5rem;
        }

        .header-nav a {
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            font-size: 0.82rem;
            font-weight: 600;
            padding: 0.3rem 0.75rem;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.3);
            transition: all 0.2s;
        }

        .header-nav a:hover {
            color: white;
            border-color: white;
            background: rgba(255,255,255,0.1);
        }

        .badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            color: white;
            font-weight: 700;
            padding: 0.2rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-top: 0.5rem;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
        }

        .intro-box {
            background: var(--card);
            border-left: 4px solid var(--accent);
            padding: 1.25rem 1.5rem;
            border-radius: 0 8px 8px 0;
            margin-bottom: 2rem;
            box-shadow: 0 2px 6px rgba(0,0,0,0.06);
        }

        .intro-box h3 { color: var(--primary); margin-bottom: 0.5rem; }
        .intro-box p { font-size: 0.92rem; color: var(--text-light); }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        @media (max-width: 768px) {
            .form-grid { grid-template-columns: 1fr; }
            header h1 { font-size: 1.5rem; }
        }

        .section {
            background: var(--card);
            border-radius: 12px;
            padding: 1.75rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .section h2 {
            font-size: 1.1rem;
            color: var(--primary);
            border-bottom: 2px solid var(--border);
            padding-bottom: 0.5rem;
            margin-bottom: 1.25rem;
        }

        .field { margin-bottom: 1.1rem; }
        .field:last-child { margin-bottom: 0; }

        label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 0.3rem;
        }

        label .hint {
            font-weight: 400;
            color: var(--text-light);
            font-size: 0.78rem;
        }

        select, input[type="number"], input[type="text"] {
            width: 100%;
            padding: 0.6rem 0.75rem;
            border: 1.5px solid var(--border);
            border-radius: 8px;
            font-size: 0.92rem;
            color: var(--text);
            background: #fff;
            transition: border-color 0.2s;
            font-family: 'Inter', sans-serif;
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(13,148,136,0.12);
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.88rem;
        }

        .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--primary);
        }

        /* Address Lookup */
        .address-section {
            background: var(--card);
            border-radius: 12px;
            padding: 1.75rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            margin-bottom: 2rem;
            border: 2px solid var(--primary-light);
        }

        .address-section h2 {
            font-size: 1.1rem;
            color: var(--primary);
            border-bottom: 2px solid var(--border);
            padding-bottom: 0.5rem;
            margin-bottom: 1.25rem;
        }

        .address-row {
            display: flex;
            gap: 0.75rem;
            align-items: flex-end;
        }

        .address-row .field { flex: 1; margin-bottom: 0; }

        .btn-lookup {
            padding: 0.6rem 1.5rem;
            font-size: 0.92rem;
            font-weight: 700;
            color: white;
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            border: none;
            border-radius: 8px;
            cursor: pointer;
            white-space: nowrap;
            transition: transform 0.15s, box-shadow 0.15s;
            box-shadow: 0 2px 8px rgba(13,148,136,0.25);
            height: 40px;
            font-family: 'Inter', sans-serif;
        }

        .btn-lookup:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(13,148,136,0.35);
        }

        .btn-lookup:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .lookup-status {
            margin-top: 0.75rem;
            font-size: 0.85rem;
            min-height: 1.4em;
        }

        .lookup-status .status-item {
            display: inline-block;
            margin-right: 1rem;
            margin-bottom: 0.25rem;
        }

        .lookup-status .ok { color: var(--success); }
        .lookup-status .warn { color: var(--accent-dark); }
        .lookup-status .err { color: #e53e3e; }
        .lookup-status .loading { color: var(--primary-light); }

        .autofill-notice {
            display: none;
            background: #f0fdfa;
            border: 1px solid #99f6e4;
            border-radius: 8px;
            padding: 0.7rem 1rem;
            font-size: 0.82rem;
            color: var(--primary);
            margin-top: 0.75rem;
        }

        .autofill-notice.visible { display: block; }

        .field.autofilled select,
        .field.autofilled input {
            border-color: var(--primary-light);
            background: #f0fdfa;
        }

        .field .autofill-badge {
            display: none;
            font-size: 0.7rem;
            color: var(--primary-light);
            font-weight: 400;
            margin-left: 0.4rem;
        }

        .field.autofilled .autofill-badge { display: inline; }

        @media (max-width: 768px) {
            .address-row { flex-direction: column; }
            .btn-lookup { width: 100%; }
        }

        .btn-calculate {
            display: block;
            width: 100%;
            max-width: 400px;
            margin: 2rem auto;
            padding: 1rem 2rem;
            font-size: 1.15rem;
            font-weight: 700;
            color: white;
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
            box-shadow: 0 4px 12px rgba(13,148,136,0.35);
            font-family: 'Inter', sans-serif;
        }

        .btn-calculate:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(13,148,136,0.45);
        }

        .btn-calculate:active { transform: translateY(0); }

        /* Results */
        #results {
            display: none;
            margin-top: 1rem;
        }

        #results.visible { display: block; }

        .results-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .results-header h2 {
            font-size: 1.5rem;
            color: var(--primary);
        }

        .results-header p {
            color: var(--text-light);
            font-size: 0.92rem;
        }

        .result-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 900px) {
            .result-cards { grid-template-columns: 1fr; }
        }

        .result-card {
            background: var(--card);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            transition: transform 0.2s;
        }

        .result-card:hover { transform: translateY(-4px); }

        .result-card .rank-banner {
            text-align: center;
            padding: 1rem;
            color: white;
            font-size: 0.9rem;
            font-weight: 700;
        }

        .rank-1 .rank-banner { background: linear-gradient(135deg, #b8860b, #daa520); }
        .rank-2 .rank-banner { background: linear-gradient(135deg, #6a6a6a, #a0a0a0); }
        .rank-3 .rank-banner { background: linear-gradient(135deg, #8b4513, #cd853f); }

        .rank-banner .rank-num {
            display: block;
            font-size: 2rem;
            line-height: 1;
        }

        .result-card .card-body {
            padding: 1.5rem;
        }

        .result-card .use-name {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.75rem;
        }

        .score-bar-container {
            margin-bottom: 0.75rem;
        }

        .score-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .score-bar {
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }

        .score-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.8s ease-out;
        }

        .score-bar-fill.legal { background: #0ea5e9; }
        .score-bar-fill.physical { background: #14b8a6; }
        .score-bar-fill.financial { background: #f59e0b; }
        .score-bar-fill.productive { background: #8b5cf6; }

        .overall-score {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .overall-score .big-score {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary);
        }

        .overall-score span {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .rationale {
            margin-top: 1rem;
            font-size: 0.85rem;
            color: var(--text-light);
            line-height: 1.5;
        }

        /* Key Metrics section on result cards */
        .key-metrics {
            margin-top: 1rem;
            padding-top: 0.85rem;
            border-top: 1px dashed var(--border);
        }

        .key-metrics-title {
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-light);
            margin-bottom: 0.5rem;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.4rem;
        }

        .metric-item {
            background: #f0fdfa;
            border-radius: 6px;
            padding: 0.4rem 0.55rem;
        }

        .metric-icon-label {
            font-size: 0.68rem;
            color: var(--text-light);
            margin-bottom: 0.15rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .metric-value {
            font-size: 0.88rem;
            font-weight: 700;
            color: var(--text);
        }

        .metric-value.positive { color: #059669; }
        .metric-value.caution  { color: #d97706; }
        .metric-value.negative { color: #dc2626; }

        .risk-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.78rem;
            font-weight: 700;
            padding: 0.15rem 0.5rem;
            border-radius: 999px;
        }

        .risk-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            display: inline-block;
        }

        .ease-bar-bg {
            width: 100%;
            height: 5px;
            background: #e2e8f0;
            border-radius: 3px;
            margin-top: 0.25rem;
            overflow: hidden;
        }

        .ease-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.4s ease;
        }

        /* Details table */
        .details-section {
            background: var(--card);
            border-radius: 12px;
            padding: 1.75rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            margin-bottom: 2rem;
        }

        .details-section h3 {
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .details-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.88rem;
        }

        .details-table th {
            background: var(--primary);
            color: white;
            padding: 0.65rem 0.75rem;
            text-align: left;
            font-weight: 600;
        }

        .details-table th:first-child { border-radius: 8px 0 0 0; }
        .details-table th:last-child { border-radius: 0 8px 0 0; }

        .details-table td {
            padding: 0.6rem 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .details-table tr:nth-child(even) { background: #f8fafc; }
        .details-table tr.top-3 { font-weight: 600; }
        .details-table tr.top-3 td:first-child { color: var(--primary); }

        .pass { color: var(--success); font-weight: 600; }
        .fail { color: #e53e3e; font-weight: 600; }
        .partial { color: var(--accent-dark); font-weight: 600; }

        .disclaimer {
            background: #fffbeb;
            border: 1px solid #f6e05e;
            border-radius: 8px;
            padding: 1rem 1.25rem;
            font-size: 0.82rem;
            color: #744210;
            margin-top: 1rem;
        }

        footer {
            text-align: center;
            padding: 2rem;
            color: var(--text-light);
            font-size: 0.82rem;
            border-top: 1px solid var(--border);
            margin-top: 2rem;
        }

        /* Print / Export Button */
        .btn-print {
            display: none;
            width: 100%;
            max-width: 400px;
            margin: 0 auto 2rem;
            padding: 0.85rem 2rem;
            font-size: 1rem;
            font-weight: 700;
            color: white;
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
            box-shadow: 0 4px 12px rgba(13,148,136,0.3);
            font-family: 'Inter', sans-serif;
        }

        .btn-print.visible { display: block; }

        .btn-print:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(13,148,136,0.4);
        }

        .btn-print:active { transform: translateY(0); }

        .print-date {
            display: none;
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-light);
            margin-bottom: 1rem;
        }

        /* Print Styles */
        @media print {
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; color-adjust: exact !important; }

            body { background: white; font-size: 11pt; }

            header {
                background: var(--primary) !important;
                -webkit-print-color-adjust: exact;
                padding: 1.25rem;
                box-shadow: none;
            }

            header h1 { font-size: 1.5rem; }

            .container { padding: 1rem; }

            .intro-box, .btn-calculate, .btn-print, .address-section, footer, .header-nav { display: none !important; }

            .form-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 1rem;
                margin-bottom: 1rem;
            }

            .section {
                box-shadow: none;
                border: 1px solid #ddd;
                padding: 1rem;
                page-break-inside: avoid;
            }

            .section h2 { font-size: 0.95rem; margin-bottom: 0.75rem; }

            .field { margin-bottom: 0.5rem; }
            label { font-size: 0.78rem; }

            select, input[type="number"], input[type="text"] {
                border: none;
                padding: 0;
                font-size: 0.82rem;
                font-weight: 600;
                color: var(--primary);
                background: transparent;
                -webkit-appearance: none;
                appearance: none;
            }

            .checkbox-item { font-size: 0.78rem; }

            #results { display: block !important; page-break-before: auto; }

            .results-header { margin-bottom: 1rem; }
            .results-header h2 { font-size: 1.2rem; }

            .result-cards {
                grid-template-columns: repeat(3, 1fr);
                gap: 0.75rem;
                margin-bottom: 1rem;
            }

            .result-card {
                box-shadow: none;
                border: 1px solid #ddd;
                page-break-inside: avoid;
            }

            .result-card:hover { transform: none; }

            .rank-banner { padding: 0.6rem; font-size: 0.8rem; }
            .rank-banner .rank-num { font-size: 1.4rem; }
            .result-card .card-body { padding: 1rem; }
            .result-card .use-name { font-size: 1rem; margin-bottom: 0.5rem; }
            .score-bar-container { margin-bottom: 0.4rem; }
            .overall-score { margin-top: 0.5rem; padding-top: 0.5rem; }
            .overall-score .big-score { font-size: 1.5rem; }
            .rationale { font-size: 0.78rem; margin-top: 0.5rem; }

            .key-metrics { margin-top: 0.5rem; padding-top: 0.5rem; }
            .key-metrics-title { font-size: 0.6rem; margin-bottom: 0.3rem; }
            .metrics-grid { gap: 0.25rem; }
            .metric-item { padding: 0.25rem 0.4rem; }
            .metric-icon-label { font-size: 0.6rem; }
            .metric-value { font-size: 0.75rem; }

            .details-section {
                box-shadow: none;
                border: 1px solid #ddd;
                padding: 1rem;
                page-break-inside: avoid;
            }

            .details-table { font-size: 0.78rem; }
            .details-table th { padding: 0.4rem 0.5rem; }
            .details-table td { padding: 0.35rem 0.5rem; }

            .disclaimer {
                font-size: 0.72rem;
                padding: 0.75rem;
                page-break-inside: avoid;
            }

            .print-date { display: block !important; }

            .legislation-section {
                page-break-inside: avoid;
                box-shadow: none;
                border: 1px solid #ddd;
                padding: 1rem;
            }
            .legislation-section .legislation-card {
                page-break-inside: avoid;
            }

            .map-section { display: none !important; }
        }

        /* Legislation Section */
        .legislation-section {
            background: var(--card);
            border-radius: 12px;
            padding: 1.75rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            margin-bottom: 2rem;
        }

        .legislation-section h3 {
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .legislation-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }

        .legislation-card {
            background: #f0fdfa;
            border-left: 4px solid var(--accent);
            border-radius: 0 8px 8px 0;
            padding: 1rem 1.25rem;
        }

        .legislation-card strong {
            color: var(--primary);
            font-size: 0.92rem;
            display: block;
            margin-bottom: 0.35rem;
        }

        .legislation-card p {
            color: var(--text-light);
            font-size: 0.82rem;
            margin: 0;
            line-height: 1.45;
        }

        .legislation-badge {
            display: inline-block;
            background: #f0fdfa;
            color: var(--primary);
            font-size: 0.7rem;
            font-weight: 600;
            padding: 0.15rem 0.5rem;
            border-radius: 12px;
            margin-right: 0.3rem;
            margin-bottom: 0.25rem;
            border: 1px solid #99f6e4;
        }

        .legislation-badges {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border);
        }

        .legislation-badges .leg-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 0.35rem;
        }

        /* Clickable Legislation Cards & Badges */
        .legislation-card.clickable {
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
        }
        .legislation-card.clickable:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .legislation-badge.clickable {
            cursor: pointer;
            transition: background 0.15s;
        }
        .legislation-badge.clickable:hover {
            background: #ccfbf1;
        }

        /* Legislation Detail Popup */
        .leg-detail-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.45);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        .leg-detail-content {
            background: white;
            border-radius: 14px;
            max-width: 520px;
            width: 100%;
            box-shadow: 0 16px 48px rgba(0,0,0,0.25);
            overflow: hidden;
        }
        .leg-detail-header {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            color: white;
            padding: 1.25rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        .leg-detail-header h3 { font-size: 1.1rem; margin: 0; }
        .leg-detail-close {
            width: 28px; height: 28px;
            border-radius: 50%;
            border: none;
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 1.1rem;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }
        .leg-detail-close:hover { background: rgba(255,255,255,0.35); }
        .leg-detail-body {
            padding: 1.5rem;
        }
        .leg-detail-body .leg-summary {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-bottom: 0.75rem;
            font-style: italic;
        }
        .leg-detail-body .leg-full {
            font-size: 0.88rem;
            color: var(--text);
            line-height: 1.65;
        }

        /* SB 79 Transit Map */
        .map-section {
            background: var(--card);
            border-radius: 12px;
            padding: 1.75rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            margin-top: 2rem;
        }
        .map-section .section-header { text-align: center; margin-bottom: 1.25rem; }
        .map-section .section-header h2 { font-size: 1.3rem; color: var(--primary); margin-bottom: 0.25rem; }
        .map-section .section-subtitle { font-size: 0.88rem; color: var(--text-light); }
        #sb79Map { width: 100%; height: 500px; border-radius: 10px; border: 1.5px solid var(--border); z-index: 1; }
        .map-controls { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.75rem; justify-content: center; }
        .layer-btn {
            padding: 0.4rem 1rem; font-size: 0.82rem; font-weight: 600; border: 1.5px solid var(--border);
            border-radius: 20px; background: #fff; color: var(--text-light); cursor: pointer; transition: all 0.2s;
            font-family: 'Inter', sans-serif;
        }
        .layer-btn:hover { border-color: var(--primary-light); color: var(--primary); }
        .layer-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); }
        .map-legend {
            display: flex; flex-wrap: wrap; gap: 0.75rem 1.5rem; margin-top: 0.75rem;
            padding: 0.75rem 1rem; background: #f0fdfa; border-radius: 8px; font-size: 0.78rem; color: var(--text-light);
        }
        .map-legend .legend-item { display: flex; align-items: center; gap: 0.35rem; }
        .legend-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
        .legend-line { width: 18px; height: 3px; border-radius: 2px; display: inline-block; }
        .sb79-eligibility {
            margin-top: 1rem; padding: 1.25rem; border-radius: 10px;
            background: linear-gradient(135deg, #f0fdfa, #ecfdf5); border: 1.5px solid #99f6e4;
        }
        .sb79-eligibility h3 { font-size: 1rem; color: var(--primary); margin-bottom: 0.75rem; }
        .sb79-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.6rem; }
        .sb79-stat { background: #fff; border-radius: 8px; padding: 0.6rem 0.75rem; text-align: center; }
        .sb79-stat .stat-label { font-size: 0.7rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.05em; }
        .sb79-stat .stat-value { font-size: 1.1rem; font-weight: 700; color: var(--primary); }
        .tier-badge, .zone-badge {
            display: inline-block; font-size: 0.72rem; font-weight: 700; padding: 0.15rem 0.55rem;
            border-radius: 10px; margin-right: 0.3rem;
        }
        .tier-badge.tier1 { background: #e9d8fd; color: #553c9a; }
        .tier-badge.tier2 { background: #bee3f8; color: #2b6cb0; }
        .zone-badge.adjacent { background: #fed7d7; color: #c53030; }
        .zone-badge.inner { background: #fefcbf; color: #975a16; }
        .zone-badge.outer { background: #c6f6d5; color: #276749; }
        .station-popup .popup-title { font-weight: 700; font-size: 0.92rem; margin-bottom: 0.3rem; }
        .station-popup .popup-line { font-size: 0.8rem; color: #555; }
        .station-popup .popup-allowances { margin-top: 0.4rem; font-size: 0.78rem; }
        .station-popup .popup-allowances span { display: block; }
        @media print { .map-section { display: none !important; } }
        @media (max-width: 768px) { #sb79Map { height: 350px; } }

        /* ===== Tab Bar ===== */
        .tab-bar {
            display: flex; justify-content: center; background: #fff;
            border-bottom: 2px solid var(--border); position: sticky; top: 0; z-index: 50;
        }
        .tab-btn {
            flex: 1; max-width: 220px; padding: 0.85rem 1rem; font-size: 0.88rem; font-weight: 700;
            color: var(--text-light); background: transparent; border: none;
            border-bottom: 3px solid transparent; cursor: pointer;
            transition: color 0.2s, border-color 0.2s, background 0.2s; font-family: 'Inter', sans-serif;
        }
        .tab-btn:hover { color: var(--primary); background: #f0fdfa; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary-light); background: #fff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        @media print { .tab-bar { display: none !important; } }
        @media (max-width: 600px) { .tab-btn { font-size: 0.72rem; padding: 0.65rem 0.4rem; } }

        /* ===== Analysis Modal ===== */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6); z-index: 1000; overflow-y: auto; padding: 2rem 1rem;
        }
        .modal-content {
            max-width: 1000px; margin: 0 auto; background: white;
            border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); position: relative;
        }
        .modal-top-bar {
            position: sticky; top: 0; display: flex; justify-content: flex-end; gap: 0.5rem;
            padding: 0.75rem 1rem; background: rgba(255,255,255,0.95);
            border-radius: 16px 16px 0 0; z-index: 10; backdrop-filter: blur(6px);
        }
        .modal-close {
            width: 36px; height: 36px; border-radius: 50%; border: 1px solid var(--border);
            background: #f7fafc; font-size: 1.3rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center; color: var(--text-light);
        }
        .modal-close:hover { background: #edf2f7; }
        .modal-print-btn {
            padding: 0.45rem 1.25rem; font-size: 0.85rem; font-weight: 700;
            color: white; background: var(--primary-light); border: none; border-radius: 8px; cursor: pointer;
        }
        .modal-print-btn:hover { background: var(--primary); }
        .modal-header {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary)); color: white; padding: 1.75rem 2rem;
        }
        .modal-header h2 { font-size: 1.4rem; margin-bottom: 0.25rem; }
        .modal-header p { font-size: 0.88rem; opacity: 0.85; }
        .modal-body { padding: 2rem; }
        .analysis-section { margin-bottom: 2rem; }
        .analysis-section h3 {
            color: var(--primary); border-bottom: 2px solid var(--border);
            padding-bottom: 0.5rem; margin-bottom: 1rem; font-size: 1rem;
        }
        .program-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.75rem; }
        @media (max-width: 600px) { .program-grid { grid-template-columns: repeat(2, 1fr); } }
        .program-item { text-align: center; padding: 0.85rem; background: #f0fdfa; border-radius: 8px; }
        .program-item .program-value { font-size: 1.3rem; font-weight: 700; color: var(--primary); }
        .program-item .program-label { font-size: 0.75rem; color: var(--text-light); margin-top: 0.15rem; }
        .rendering-container { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        @media (max-width: 700px) { .rendering-container { grid-template-columns: 1fr; } }
        .rendering-container svg { width: 100%; height: auto; border: 1px solid var(--border); border-radius: 8px; }
        .assumptions-panel { background: #f0fdfa; border: 1px solid #99f6e4; border-radius: 10px; padding: 1rem 1.25rem; }
        .assumptions-panel h4 { font-size: 0.88rem; color: var(--primary); margin-bottom: 0.75rem; }
        .assumptions-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 0.6rem; }
        .assumption-field label { font-size: 0.72rem; font-weight: 600; color: var(--text-light); display: block; margin-bottom: 0.15rem; }
        .assumption-input {
            width: 100%; padding: 0.4rem 0.5rem; border: 1px solid var(--border);
            border-radius: 6px; font-size: 0.85rem; font-family: 'Inter', sans-serif;
        }
        .assumption-input:focus { outline: none; border-color: var(--primary-light); box-shadow: 0 0 0 2px rgba(13,148,136,0.12); }
        .returns-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.75rem; margin-bottom: 1.25rem; }
        @media (max-width: 700px) { .returns-grid { grid-template-columns: repeat(2, 1fr); } }
        .return-card { text-align: center; padding: 1rem; background: #f0fdfa; border-radius: 8px; }
        .return-card .return-value { font-size: 1.5rem; font-weight: 800; color: var(--primary); }
        .return-card .return-label { font-size: 0.78rem; color: var(--text-light); margin-top: 0.15rem; }
        .timeline-bar { display: flex; border-radius: 8px; overflow: hidden; height: 36px; margin-bottom: 0.5rem; }
        .timeline-segment { display: flex; align-items: center; justify-content: center; color: white; font-size: 0.7rem; font-weight: 600; text-align: center; line-height: 1.2; }
        .timeline-legend { font-size: 0.78rem; color: var(--text-light); text-align: center; }
        .risk-card { background: #fffaf0; border-left: 3px solid #ed8936; border-radius: 0 8px 8px 0; padding: 0.75rem 1rem; margin-bottom: 0.5rem; }
        .risk-card strong { color: #c05621; font-size: 0.88rem; display: block; margin-bottom: 0.2rem; }
        .risk-card p { color: var(--text-light); font-size: 0.82rem; margin: 0; }
        @media print {
            body.printing-analysis * { visibility: hidden; }
            body.printing-analysis .modal-overlay, body.printing-analysis .modal-overlay * { visibility: visible; }
            body.printing-analysis .modal-overlay { position: absolute; top: 0; left: 0; padding: 0; background: white; }
            body.printing-analysis .modal-top-bar { display: none; }
            body.printing-analysis .modal-content { box-shadow: none; }
        }

        /* ===== Finder CSS ===== */
        .finder-section { margin-top: 1.5rem; padding: 1.25rem; border-radius: 10px; background: var(--card); border: 1.5px solid var(--border); }
        .finder-controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem; margin-bottom: 1rem; }
        .finder-field label { font-size: 0.78rem; font-weight: 600; color: var(--text-light); margin-bottom: 0.2rem; display: block; }
        .finder-field select, .finder-field input {
            width: 100%; padding: 0.5rem 0.6rem; border: 1.5px solid var(--border); border-radius: 6px; font-size: 0.88rem;
        }
        .finder-field select:focus, .finder-field input:focus {
            outline: none; border-color: var(--primary-light); box-shadow: 0 0 0 3px rgba(13,148,136,0.12);
        }
        .finder-radios { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .finder-radios label { font-size: 0.82rem; font-weight: 500; color: var(--text); display: flex; align-items: center; gap: 0.25rem; cursor: pointer; }
        .finder-checks { display: flex; gap: 0.75rem; flex-wrap: wrap; }
        .finder-checks label { font-size: 0.82rem; font-weight: 500; color: var(--text); display: flex; align-items: center; gap: 0.25rem; cursor: pointer; }
        .finder-btn-search {
            padding: 0.65rem 2rem; font-size: 0.95rem; font-weight: 700;
            color: white; background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            border: none; border-radius: 8px; cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s; box-shadow: 0 2px 8px rgba(13,148,136,0.25);
            font-family: 'Inter', sans-serif;
        }
        .finder-btn-search:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(13,148,136,0.35); }
        .finder-btn-search:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .finder-progress { display: none; margin: 1rem 0; }
        .finder-progress.active { display: block; }
        .finder-progress-bar { height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; }
        .finder-progress-fill { height: 100%; background: var(--primary-light); border-radius: 3px; transition: width 0.3s; width: 0; }
        .finder-progress-text { font-size: 0.78rem; color: var(--text-light); margin-top: 0.35rem; }
        .finder-table-wrapper { overflow-x: auto; margin-top: 1rem; }
        .finder-table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
        .finder-table th {
            background: var(--primary); color: white; padding: 0.5rem 0.6rem;
            text-align: left; font-weight: 600; cursor: pointer; white-space: nowrap; user-select: none;
        }
        .finder-table th:first-child { border-radius: 8px 0 0 0; }
        .finder-table th:last-child { border-radius: 0 8px 0 0; }
        .finder-table th:hover { background: var(--primary-light); }
        .finder-table th.sort-asc::after { content: ' \u25B2'; font-size: 0.7rem; }
        .finder-table th.sort-desc::after { content: ' \u25BC'; font-size: 0.7rem; }
        .finder-table td { padding: 0.45rem 0.6rem; border-bottom: 1px solid var(--border); }
        .finder-table tr:nth-child(even) { background: #f8fafc; }
        .finder-table tr:hover { background: #f0fdfa; cursor: pointer; }
        .finder-table tr.highlighted { background: #ccfbf1 !important; }
        .imp-ratio-hot { color: #e53e3e; font-weight: 700; }
        .imp-ratio-warm { color: #dd6b20; font-weight: 600; }
        .imp-ratio-cool { color: #38a169; }
        .finder-btn-export {
            margin-top: 0.75rem; padding: 0.5rem 1.25rem; font-size: 0.85rem; font-weight: 600;
            color: var(--primary); background: #f0fdfa; border: 1.5px solid #99f6e4;
            border-radius: 8px; cursor: pointer; transition: background 0.15s;
        }
        .finder-btn-export:hover { background: #ccfbf1; }
        .finder-no-results { text-align: center; padding: 2rem 1rem; color: var(--text-light); font-size: 0.92rem; }
        .finder-error { background: #fff5f5; border: 1px solid #fc8181; border-radius: 8px; padding: 1rem; color: #c53030; font-size: 0.88rem; margin-top: 1rem; }
        .finder-summary { font-size: 0.85rem; color: var(--text-light); margin-top: 0.5rem; }
        .prop-links a { font-weight: 700; font-size: 0.78rem; color: var(--primary); text-decoration: none; }
        .prop-links a:hover { text-decoration: underline; }
        .selection-bar {
            position: sticky; top: 0; z-index: 10; display: flex; align-items: center; gap: 0.75rem;
            background: #f0fdfa; border: 1.5px solid #99f6e4; border-radius: 8px;
            padding: 0.5rem 1rem; margin-bottom: 0.75rem; font-size: 0.88rem; font-weight: 600; color: var(--primary);
        }
        .saved-list-panel {
            background: var(--card); border-radius: 12px; padding: 1.75rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06); margin-bottom: 2rem; border-left: 4px solid var(--success);
        }
        .saved-list-panel h2 { font-size: 1.1rem; color: #065f46; border-bottom: 2px solid var(--border); padding-bottom: 0.5rem; margin-bottom: 1rem; }
        .saved-list-header { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.75rem; }
        .saved-list-header span { font-size: 0.88rem; color: var(--text-light); font-weight: 600; }
        .saved-list-actions { display: flex; gap: 0.5rem; }
        .saved-btn { padding: 0.4rem 1rem; font-size: 0.82rem; font-weight: 600; border-radius: 6px; cursor: pointer; border: 1.5px solid; transition: background 0.15s; }
        .saved-btn-export { color: #065f46; background: #ecfdf5; border-color: #6ee7b7; }
        .saved-btn-export:hover { background: #d1fae5; }
        .saved-btn-clear { color: #c53030; background: #fff5f5; border-color: #fc8181; }
        .saved-btn-clear:hover { background: #fed7d7; }
        .saved-btn-remove { background: none; border: none; color: #c53030; cursor: pointer; font-size: 0.85rem; padding: 0.2rem 0.4rem; }
        .saved-btn-remove:hover { text-decoration: underline; }

        /* Pipeline legend */
        .pipeline-legend { display: flex; flex-wrap: wrap; gap: 0.75rem; margin-top: 0.75rem; padding: 0.75rem 1rem; background: #f0fdfa; border-radius: 8px; font-size: 0.78rem; }
        .pipeline-legend-item { display: flex; align-items: center; gap: 0.3rem; }
        .pipeline-legend-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
        .pipeline-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: 600; color: white; }
        .pipeline-badge.submitted { background: #d69e2e; }
        .pipeline-badge.plan_check { background: #dd6b20; }
        .pipeline-badge.issued { background: #3182ce; }
        .pipeline-badge.inspection { background: #38a169; }
        .pipeline-badge.finaled { background: #718096; }
        .pipeline-badge.coo { background: #276749; }
        .pipeline-val-high { color: #e53e3e; font-weight: 700; }
        .pipeline-val-mid { color: #dd6b20; font-weight: 600; }
        .pipeline-overlay-btn {
            position: absolute; top: 10px; right: 10px; z-index: 10;
            padding: 6px 14px; font-size: 0.78rem; font-weight: 600;
            background: white; border: 1.5px solid var(--primary-light); color: var(--primary);
            border-radius: 6px; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        .pipeline-overlay-btn.active { background: var(--primary); color: white; }

        /* ===== One-Pager Modal ===== */
        .onepager-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6); z-index: 1100; overflow-y: auto; padding: 1rem;
        }
        .onepager-content {
            max-width: 800px; margin: 0 auto; background: white;
            border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden;
        }
        .onepager-hero {
            background: linear-gradient(135deg, #0f766e, #0d9488, #14b8a6);
            color: white; padding: 2rem 2.5rem; text-align: center;
        }
        .onepager-hero h2 { font-size: 1.6rem; font-weight: 800; margin-bottom: 0.25rem; }
        .onepager-hero .address { font-size: 1rem; opacity: 0.85; margin-bottom: 1.5rem; }
        .value-trio { display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap; }
        .value-box { text-align: center; }
        .value-box .val-label { font-size: 0.72rem; text-transform: uppercase; letter-spacing: 0.08em; opacity: 0.75; }
        .value-box .val-amount { font-size: 2rem; font-weight: 800; }
        .value-box .val-amount.uplift { color: #fde68a; }
        .value-arrow { font-size: 2rem; display: flex; align-items: center; opacity: 0.6; }
        .onepager-body { padding: 2rem 2.5rem; }
        .onepager-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 1.5rem; }
        @media (max-width: 600px) { .onepager-grid { grid-template-columns: 1fr; } }
        .onepager-section h4 { font-size: 0.88rem; color: var(--primary); margin-bottom: 0.75rem; border-bottom: 2px solid var(--border); padding-bottom: 0.35rem; }
        .onepager-metric { display: flex; justify-content: space-between; padding: 0.35rem 0; border-bottom: 1px solid #f1f5f9; font-size: 0.82rem; }
        .onepager-metric .m-label { color: var(--text-light); }
        .onepager-metric .m-value { font-weight: 700; color: var(--text); }
        .ease-meter { display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem; }
        .ease-meter-bar { flex: 1; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; }
        .ease-meter-fill { height: 100%; border-radius: 4px; }
        .onepager-sb79 { background: #f0fdfa; border: 1px solid #99f6e4; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem; }
        .onepager-legislation { margin-bottom: 1.5rem; }
        .onepager-legislation .leg-pills { display: flex; flex-wrap: wrap; gap: 0.35rem; }
        .onepager-legislation .leg-pill { background: #f0fdfa; border: 1px solid #99f6e4; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.72rem; font-weight: 600; color: var(--primary); }
        .onepager-branding { text-align: center; padding: 1rem 0; border-top: 1px solid var(--border); margin-top: 1rem; }
        .onepager-branding .agent-name { font-size: 0.92rem; font-weight: 700; color: var(--primary); }
        .onepager-disclaimer { font-size: 0.68rem; color: #94a3b8; text-align: center; padding: 0.75rem 1.5rem; border-top: 1px solid var(--border); }
        .onepager-topbar {
            display: flex; justify-content: flex-end; gap: 0.5rem; padding: 0.75rem 1rem;
            background: rgba(255,255,255,0.95); border-radius: 16px 16px 0 0; backdrop-filter: blur(6px);
        }
        @media print {
            body.printing-onepager * { visibility: hidden; }
            body.printing-onepager .onepager-overlay, body.printing-onepager .onepager-overlay * { visibility: visible; }
            body.printing-onepager .onepager-overlay { position: absolute; top: 0; left: 0; padding: 0; background: white; }
            body.printing-onepager .onepager-topbar { display: none; }
            body.printing-onepager .onepager-content { box-shadow: none; max-width: 100%; }
        }

        /* ===== My Sites Tab ===== */
        .sites-score-badge {
            display: inline-block; font-size: 0.78rem; font-weight: 700; padding: 0.2rem 0.6rem;
            border-radius: 10px; color: white;
        }
        .sites-score-badge.high { background: #059669; }
        .sites-score-badge.medium { background: #d69e2e; }
        .sites-score-badge.low-medium { background: #ea580c; }
        .sites-score-badge.low { background: #dc2626; }

        /* Auth Overlay */
        #authOverlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, #0f766e 0%, #0d9488 50%, #14b8a6 100%);
            z-index: 9999;
            display: flex; align-items: center; justify-content: center;
            transition: opacity 0.4s ease;
        }
        #authOverlay.fade-out { opacity: 0; pointer-events: none; }
        .auth-box {
            background: white; border-radius: 16px; padding: 2.5rem 2rem;
            text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 380px; width: 90%;
        }
        .auth-box h2 { color: var(--primary); font-size: 1.4rem; margin-bottom: 0.25rem; }
        .auth-box > p { color: var(--text-light); font-size: 0.92rem; margin-bottom: 1.5rem; }
        .auth-box input[type="password"] {
            width: 100%; padding: 0.7rem 1rem; border: 1.5px solid var(--border);
            border-radius: 8px; font-size: 1rem; text-align: center; margin-bottom: 1rem;
            font-family: 'Inter', sans-serif;
        }
        .auth-box input[type="password"]:focus {
            outline: none; border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(13,148,136,0.12);
        }
        .auth-btn {
            display: block; width: 100%; padding: 0.75rem; font-size: 1rem; font-weight: 700;
            color: white; background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            border: none; border-radius: 10px; cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
            box-shadow: 0 4px 12px rgba(13,148,136,0.35);
            font-family: 'Inter', sans-serif;
        }
        .auth-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(13,148,136,0.45); }
        .auth-error { color: #e53e3e; font-size: 0.85rem; margin-top: 0.75rem; min-height: 1.2em; }
        @media print { #authOverlay { display: none !important; } }

        /* Feasibility badge */
        .feasibility-badge {
            display: inline-block;
            font-size: 0.72rem;
            font-weight: 700;
            padding: 0.15rem 0.6rem;
            border-radius: 10px;
            margin-top: 0.5rem;
        }
        .feasibility-badge.feasible { background: #d1fae5; color: #065f46; }
        .feasibility-badge.marginal { background: #fef3c7; color: #92400e; }
        .feasibility-badge.not-feasible { background: #fee2e2; color: #991b1b; }

        /* Budget table */
        .budget-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.82rem;
        }
        .budget-table th {
            padding: 0.35rem 0.6rem;
            text-align: right;
            font-weight: 600;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            color: var(--text-light);
            border-bottom: 2px solid var(--border);
        }
        .budget-table th:first-child { text-align: left; }
        .budget-table td {
            padding: 0.35rem 0.6rem;
            border-bottom: 1px solid var(--border);
            font-variant-numeric: tabular-nums;
        }
        .budget-table td:not(:first-child) {
            text-align: right;
            white-space: nowrap;
        }
        .budget-table td.dim {
            color: var(--text-light);
            font-size: 0.78rem;
        }
        .budget-table .section-header td {
            font-weight: 700;
            background: #f8fafc;
            color: var(--primary);
            padding-top: 0.65rem;
            border-bottom: 2px solid var(--border);
        }
        .budget-table .subtotal td {
            font-weight: 700;
            background: #f0f4f8;
        }
        .budget-table .grand-total td {
            font-weight: 700;
            background: var(--primary);
            color: white;
            font-size: 0.88rem;
            padding: 0.55rem 0.6rem;
        }
        .budget-table .pct-col {
            font-size: 0.72rem;
            color: var(--text-light);
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            overflow-y: auto;
            padding: 2rem 1rem;
        }
        .modal-content {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            position: relative;
        }

        /* Returns grid */
        .returns-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
            margin-bottom: 1.25rem;
        }
        @media (max-width: 700px) { .returns-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 400px) { .returns-grid { grid-template-columns: 1fr; } }
        .return-card {
            text-align: center;
            padding: 1rem;
            background: #f0fdfa;
            border-radius: 8px;
        }
        .return-card .return-value {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
        }
        .return-card .return-label {
            font-size: 0.78rem;
            color: var(--text-light);
            margin-top: 0.15rem;
        }

        .program-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
        }
        @media (max-width: 600px) { .program-grid { grid-template-columns: repeat(2, 1fr); } }
        .program-item {
            text-align: center;
            padding: 0.85rem;
            background: #f0fdfa;
            border-radius: 8px;
        }
        .program-item .program-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary);
        }
        .program-item .program-label {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-top: 0.15rem;
        }

        .rendering-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }
        @media (max-width: 700px) { .rendering-container { grid-template-columns: 1fr; } }
        .rendering-container svg {
            width: 100%;
            height: auto;
            border: 1px solid var(--border);
            border-radius: 8px;
        }

        .timeline-bar {
            display: flex;
            border-radius: 8px;
            overflow: hidden;
            height: 36px;
            margin-bottom: 0.5rem;
        }
        .timeline-segment {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.68rem;
            font-weight: 600;
            color: white;
            line-height: 1.2;
            text-align: center;
            padding: 0 0.25rem;
        }
        .timeline-legend {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-top: 0.35rem;
        }

        .risk-card {
            background: #fff5f5;
            border-left: 4px solid #fc8181;
            border-radius: 0 8px 8px 0;
            padding: 0.85rem 1.1rem;
            margin-bottom: 0.6rem;
        }
        .risk-card strong { color: #c53030; font-size: 0.88rem; display: block; margin-bottom: 0.2rem; }
        .risk-card p { color: var(--text-light); font-size: 0.82rem; margin: 0; line-height: 1.45; }

        .click-hint {
            font-size: 0.75rem;
            color: var(--primary-light);
            text-align: center;
            margin-top: 0.5rem;
            font-weight: 600;
        }

        /* Scanner mode selector */
        .scanner-modes { display: flex; gap: 0.5rem; margin-bottom: 1.25rem; flex-wrap: wrap; }
        .scanner-mode-btn {
            padding: 0.5rem 1rem; border-radius: 8px; border: 2px solid var(--border);
            background: var(--card); color: var(--text-light); font-weight: 600; font-size: 0.82rem;
            cursor: pointer; transition: all 0.2s;
        }
        .scanner-mode-btn:hover { border-color: var(--primary-light); color: var(--primary); }
        .scanner-mode-btn.active { border-color: var(--primary); background: #f0fdfa; color: var(--primary); }
        .scanner-panel { display: none; }
        .scanner-panel.active { display: block; }

        /* Smart filter bar */
        .smart-filters { background: #f8fafc; border: 1px solid var(--border); border-radius: 10px; padding: 1rem 1.25rem; margin-bottom: 1rem; }
        .smart-filters h4 { font-size: 0.82rem; color: var(--text-light); margin-bottom: 0.75rem; font-weight: 600; }
        .filter-row { display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: center; margin-bottom: 0.6rem; }
        .filter-row:last-child { margin-bottom: 0; }
        .filter-label { font-size: 0.78rem; font-weight: 600; color: var(--text-light); min-width: 80px; }
        .tier-btn {
            padding: 0.35rem 0.75rem; border-radius: 6px; border: 1.5px solid var(--border);
            background: white; font-size: 0.78rem; font-weight: 600; cursor: pointer; transition: all 0.15s;
        }
        .tier-btn:hover { border-color: var(--primary-light); }
        .tier-btn.active { color: white; border-color: transparent; }
        .tier-btn.tier-hot.active { background: #059669; }
        .tier-btn.tier-strong.active { background: #16a34a; }
        .tier-btn.tier-moderate.active { background: #ca8a04; }
        .tier-btn.tier-weak.active { background: #dc2626; }
        .tier-btn .tier-count { font-weight: 400; opacity: 0.8; margin-left: 0.25rem; }
        .lot-size-btn {
            padding: 0.3rem 0.65rem; border-radius: 6px; border: 1.5px solid var(--border);
            background: white; font-size: 0.75rem; font-weight: 600; cursor: pointer; transition: all 0.15s;
        }
        .lot-size-btn:hover { border-color: var(--primary-light); }
        .lot-size-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .filter-input-sm {
            width: 100px; padding: 0.3rem 0.5rem; border: 1.5px solid var(--border); border-radius: 6px;
            font-size: 0.8rem; font-family: inherit;
        }
        .filter-toggle {
            display: flex; align-items: center; gap: 0.4rem; font-size: 0.78rem; font-weight: 600;
            color: var(--text-light); cursor: pointer;
        }
        .filter-toggle input { accent-color: var(--primary); }

        /* Prospect status badges / selects */
        .prospect-status {
            display: inline-block; padding: 0.15rem 0.5rem; border-radius: 4px;
            font-size: 0.72rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.03em;
        }
        select.prospect-status { font-weight: 700; text-transform: uppercase; letter-spacing: 0.03em; appearance: auto; }
        .ps-not-contacted { background: #e2e8f0; color: #475569; }
        .ps-contacted { background: #dbeafe; color: #1e40af; }
        .ps-interested { background: #fef3c7; color: #92400e; }
        .ps-listed { background: #d1fae5; color: #065f46; }
        .ps-sold { background: #059669; color: white; }
        .ps-passed { background: #fee2e2; color: #991b1b; }

        /* Pipeline metrics bar */
        .pipeline-metrics {
            display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1.25rem; padding: 1rem 1.25rem;
            background: linear-gradient(135deg, #f0fdf4, #ecfdf5); border-radius: 10px; border: 1px solid #bbf7d0;
        }
        .pipeline-metric { text-align: center; flex: 1; min-width: 80px; }
        .pipeline-metric .pm-val { font-size: 1.4rem; font-weight: 800; color: var(--primary-dark); }
        .pipeline-metric .pm-label { font-size: 0.7rem; color: var(--text-light); font-weight: 600; }

        /* Opp ratio cells */
        .opp-strong { background: #dcfce7; color: #166534; font-weight: 700; }
        .opp-moderate { background: #fef9c3; color: #854d0e; font-weight: 600; }
        .opp-weak { background: #fee2e2; color: #991b1b; font-weight: 600; }
        .opp-badge { display: inline-block; padding: 0.15rem 0.5rem; border-radius: 4px; font-size: 0.78rem; }

        /* Copy APN button */
        .btn-copy-apn {
            background: none; border: 1px solid var(--border); border-radius: 4px;
            padding: 0.15rem 0.4rem; font-size: 0.7rem; cursor: pointer; color: var(--text-light);
            transition: all 0.15s;
        }
        .btn-copy-apn:hover { border-color: var(--primary); color: var(--primary); }

        /* Agent profile modal */
        .profile-modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5);
            z-index: 9999; display: flex; align-items: center; justify-content: center;
        }
        .profile-modal {
            background: var(--card); border-radius: 16px; padding: 2rem; max-width: 500px; width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        }
        .profile-modal h3 { color: var(--primary); margin-bottom: 1.25rem; font-size: 1.1rem; }
        .profile-modal .field { margin-bottom: 0.9rem; }
        .profile-modal label { font-size: 0.82rem; font-weight: 600; margin-bottom: 0.2rem; display: block; }
        .profile-modal input {
            width: 100%; padding: 0.6rem 0.8rem; border: 1.5px solid var(--border); border-radius: 8px;
            font-size: 0.9rem; font-family: inherit;
        }
        .profile-modal input:focus { border-color: var(--primary); outline: none; }
        .profile-modal-actions { display: flex; gap: 0.75rem; margin-top: 1.5rem; }
        .profile-modal-actions button {
            flex: 1; padding: 0.6rem; border-radius: 8px; font-weight: 600; font-size: 0.88rem;
            cursor: pointer; border: none; font-family: inherit;
        }

        /* Letter modal */
        .letter-modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5);
            z-index: 9998; display: flex; align-items: center; justify-content: center; overflow-y: auto;
        }
        .letter-modal {
            background: white; border-radius: 16px; padding: 2.5rem; max-width: 700px; width: 95%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2); margin: 2rem auto;
        }
        .letter-content { font-family: Georgia, 'Times New Roman', serif; line-height: 1.8; font-size: 1rem; color: #1a1a1a; }
        .letter-content p { margin-bottom: 1rem; }
        .letter-actions { display: flex; gap: 0.75rem; margin-top: 1.5rem; justify-content: flex-end; }
        .letter-actions button {
            padding: 0.6rem 1.2rem; border-radius: 8px; font-weight: 600; font-size: 0.85rem;
            cursor: pointer; border: none; font-family: 'Inter', sans-serif;
        }

        /* Settings gear icon */
        .header-settings {
            position: absolute; right: 1.5rem; top: 50%; transform: translateY(-50%);
            background: none; border: none; color: rgba(255,255,255,0.7); cursor: pointer;
            font-size: 1.3rem; transition: all 0.2s;
        }
        .header-settings:hover { color: white; transform: translateY(-50%) rotate(45deg); }
        header { position: relative; }

        @media print {
            .letter-actions, .letter-modal-overlay > button { display: none !important; }
            .letter-modal { box-shadow: none; border-radius: 0; max-width: 100%; padding: 1in; }
            .letter-modal-overlay { background: white; position: static; }
            body > *:not(.letter-modal-overlay) { display: none !important; }
        }
    </style>
</head>
<body>

<div id="authOverlay">
    <div class="auth-box">
        <h2>Land to Yield</h2>
        <p>Agent Portal</p>
        <input type="password" id="authPassword" placeholder="Access Code" onkeydown="if(event.key==='Enter')checkAuth();">
        <button type="button" class="auth-btn" onclick="checkAuth()">Enter</button>
        <div class="auth-error" id="authError"></div>
        <div style="margin-top:0.75rem;font-size:0.75rem;color:#a0aec0;">Enter the access code from your subscription email</div>
        <div style="margin-top:0.75rem;"><a href="index.html#pricing" style="color:var(--primary-light);font-size:0.8rem;text-decoration:none;">Don't have a code? Subscribe here &rarr;</a></div>
        <div style="margin-top:1.5rem;font-size:0.7rem;color:#a0aec0;">v4.2 &middot; Agent Edition</div>
    </div>
</div>

<header>
    <h1>Land to Yield &mdash; Agent Portal</h1>
    <p>HBU Land Use Calculator for Real Estate Professionals</p>
    <span class="badge">Agent Edition</span>
    <div class="header-nav">
        <a href="index.html">Home</a>
        <a href="app.html">Developer Portal</a>
    </div>
    <button class="header-settings" onclick="openAgentProfileModal()" title="Agent Profile Settings">&#9881;</button>
</header>

<div class="tab-bar">
    <button class="tab-btn active" onclick="switchTab('Calculator')">HBU Calculator</button>
    <button class="tab-btn" onclick="switchTab('Finder')">Listing Scout</button>
    <button class="tab-btn" onclick="switchTab('Pipeline')">Pipeline</button>
    <button class="tab-btn" onclick="switchTab('Contacts')">Contacts</button>
    <button class="tab-btn" onclick="switchTab('Sites')">My Portfolio</button>
</div>

<div id="tabCalculator" class="tab-content active">
<div class="container">
    <div class="intro-box">
        <h3>How It Works</h3>
        <p>Enter your parcel details below. The calculator evaluates potential land uses against the four standard HBU tests&mdash;<strong>Legally Permissible</strong>, <strong>Physically Possible</strong>, <strong>Financially Feasible</strong>, and <strong>Maximally Productive</strong>&mdash;then ranks the top 3 uses for your site.</p>
    </div>

    <div class="address-section">
        <h2>Address Lookup</h2>
        <div class="address-row">
            <div class="field">
                <label>Property Address <span class="hint">(Los Angeles, CA)</span></label>
                <input type="text" id="addressInput" placeholder="e.g. 6801 Hollywood Blvd, Los Angeles, CA 90028" onkeydown="if(event.key==='Enter'){event.preventDefault();lookupAddress();}">
            </div>
            <button type="button" class="btn-lookup" id="btnLookup" onclick="lookupAddress()">Look Up</button>
        </div>
        <div class="lookup-status" id="lookupStatus"></div>
        <div class="autofill-notice" id="autofillNotice">
            Fields highlighted in teal were auto-populated from public data. <strong>You can modify any value</strong> before running the calculation. Click a field to edit it.
        </div>
    </div>

    <form id="hbuForm" onsubmit="return false;">
        <div class="form-grid">
            <!-- LEFT COLUMN -->
            <div>
                <div class="section">
                    <h2>Parcel Information</h2>

                    <div class="field" id="field-parcelSize">
                        <label>Parcel Size (sq ft) <span class="autofill-badge">auto-filled</span></label>
                        <input type="number" id="parcelSize" value="10000" min="500" max="5000000" step="100">
                    </div>

                    <div class="field" id="field-frontage">
                        <label>Street Frontage (linear ft) <span class="autofill-badge">auto-filled</span></label>
                        <input type="number" id="frontage" value="80" min="10" max="2000" step="5">
                    </div>

                    <div class="field" id="field-zoning">
                        <label>Zoning Designation <span class="autofill-badge">auto-filled</span></label>
                        <select id="zoning">
                            <option value="R1" selected>R1 â€” Single-Family Residential</option>
                            <option value="R2">R2 â€” Two-Family Residential</option>
                            <option value="R3">R3 â€” Multi-Family (Low Density)</option>
                            <option value="R4">R4 â€” Multi-Family (Medium Density)</option>
                            <option value="R5">R5 â€” Multi-Family (High Density)</option>
                            <option value="C1">C1 â€” Limited Commercial</option>
                            <option value="C1.5">C1.5 â€” Limited Commercial (Mixed)</option>
                            <option value="C2">C2 â€” General Commercial</option>
                            <option value="C4">C4 â€” Commercial Zone</option>
                            <option value="C5">C5 â€” Commercial (Highway)</option>
                            <option value="CM">CM â€” Commercial Manufacturing</option>
                            <option value="M1">M1 â€” Limited Industrial</option>
                            <option value="M2">M2 â€” Light Industrial</option>
                            <option value="M3">M3 â€” Heavy Industrial</option>
                            <option value="PF">PF â€” Public Facilities</option>
                            <option value="OS">OS â€” Open Space</option>
                            <option value="LAX">LAX â€” Airport</option>
                            <option value="TOD">TOD â€” Transit-Oriented Development</option>
                        </select>
                    </div>

                    <div class="field" id="field-neighborhood">
                        <label>Neighborhood / Submarket <span class="autofill-badge">auto-filled</span></label>
                        <select id="neighborhood">
                            <option value="dtla">Downtown LA (DTLA)</option>
                            <option value="hollywood">Hollywood / East Hollywood</option>
                            <option value="koreatown">Koreatown</option>
                            <option value="westside" selected>Westside (West LA / Sawtelle)</option>
                            <option value="santamonica">Santa Monica Blvd Corridor</option>
                            <option value="beverly">Beverly Hills Adjacent</option>
                            <option value="midcity">Mid-City / Mid-Wilshire</option>
                            <option value="southla">South LA</option>
                            <option value="valleyeast">San Fernando Valley â€” East</option>
                            <option value="valleywest">San Fernando Valley â€” West</option>
                            <option value="silverlake">Silver Lake / Echo Park</option>
                            <option value="highland">Highland Park / Eagle Rock</option>
                            <option value="venice">Venice / Mar Vista</option>
                            <option value="culver">Culver City Adjacent</option>
                            <option value="exposition">Exposition Corridor</option>
                            <option value="southbay">South Bay (Torrance / Gardena)</option>
                            <option value="harbor">Harbor / San Pedro</option>
                            <option value="boyleheights">Boyle Heights / East LA</option>
                        </select>
                    </div>

                    <div class="field" id="field-siteCondition">
                        <label>Current Site Condition <span class="autofill-badge">auto-filled</span></label>
                        <select id="siteCondition">
                            <option value="vacant" selected>Vacant Land</option>
                            <option value="improved_under">Improved â€” Underutilized</option>
                            <option value="improved_functional">Improved â€” Functional</option>
                            <option value="demolition">Structure â€” Requires Demolition</option>
                            <option value="brownfield">Brownfield / Environmental Issues</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- RIGHT COLUMN -->
            <div>
                <div class="section">
                    <h2>Site Characteristics</h2>

                    <div class="field">
                        <label>Topography</label>
                        <select id="topography">
                            <option value="flat" selected>Flat / Level</option>
                            <option value="gentle">Gentle Slope (&lt;10%)</option>
                            <option value="moderate">Moderate Slope (10â€“25%)</option>
                            <option value="steep">Steep Slope (&gt;25%)</option>
                        </select>
                    </div>

                    <div class="field">
                        <label>Is this a corner lot?</label>
                        <select id="cornerLot">
                            <option value="yes">Yes</option>
                            <option value="no" selected>No</option>
                        </select>
                    </div>

                    <div class="field" id="field-transit">
                        <label>Proximity to Public Transit <span class="autofill-badge">auto-filled</span></label>
                        <select id="transit">
                            <option value="adjacent">Adjacent to Metro Rail Station (&lt;0.25 mi)</option>
                            <option value="near" selected>Near Transit (0.25â€“0.5 mi)</option>
                            <option value="moderate">Moderate (0.5â€“1 mi)</option>
                            <option value="far">Far (&gt;1 mi)</option>
                        </select>
                    </div>

                    <div class="field" id="field-arterial">
                        <label>Major Street / Arterial Frontage? <span class="autofill-badge">auto-filled</span></label>
                        <select id="arterial">
                            <option value="major">Yes â€” Major Arterial (e.g. Wilshire, Sunset)</option>
                            <option value="secondary" selected>Secondary Road</option>
                            <option value="residential">Residential / Side Street</option>
                        </select>
                    </div>

                    <div class="field">
                        <label>Site Constraints <span class="hint">(select all that apply)</span></label>
                        <div class="checkbox-group">
                            <label class="checkbox-item"><input type="checkbox" id="constFlood"> Flood Zone</label>
                            <label class="checkbox-item"><input type="checkbox" id="constHillside"> Hillside Ordinance</label>
                            <label class="checkbox-item"><input type="checkbox" id="constHistoric"> Historic Overlay</label>
                            <label class="checkbox-item"><input type="checkbox" id="constFault"> Fault Zone</label>
                            <label class="checkbox-item"><input type="checkbox" id="constCoastal"> Coastal Zone</label>
                            <label class="checkbox-item"><input type="checkbox" id="constParking"> Parking Constraints</label>
                        </div>
                    </div>

                    <div class="field">
                        <label>Utilities Available</label>
                        <select id="utilities">
                            <option value="full" selected>All Utilities Available</option>
                            <option value="partial">Partial â€” Needs Upgrades</option>
                            <option value="none">No Utilities â€” Requires Extension</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <button type="button" class="btn-calculate" onclick="calculateHBU()">Calculate Top 3 Highest &amp; Best Uses</button>
    </form>

    <button type="button" class="btn-print" id="btnPrint" onclick="exportPDF()">Print / Export to PDF</button>

    <!-- RESULTS -->
    <div id="results">
        <div class="print-date" id="printDate"></div>
        <div class="results-header">
            <h2>Top 3 Highest &amp; Best Use Results</h2>
            <p id="resultsSummary"></p>
        </div>

        <div class="result-cards" id="resultCards"></div>

        <div class="legislation-section" id="legislationSection" style="display:none;"></div>

        <div class="details-section">
            <h3>Scoring Breakdown â€” Legally Permissible Uses</h3>
            <div style="overflow-x: auto;">
                <table class="details-table" id="detailsTable">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Land Use</th>
                            <th>Legal</th>
                            <th>Physical</th>
                            <th>Financial</th>
                            <th>Productive</th>
                            <th>Overall</th>
                        </tr>
                    </thead>
                    <tbody id="detailsBody"></tbody>
                </table>
            </div>

            <div id="excludedSection" style="display:none; margin-top:1.25rem;">
                <button id="toggleExcluded" onclick="toggleExcludedUses()" style="background:none;border:1px solid var(--border);border-radius:8px;padding:0.5rem 1rem;font-size:0.82rem;color:var(--text-light);cursor:pointer;width:100%;text-align:left;">
                    &#9654; Show <span id="excludedCount">0</span> uses not legally permissible under current zoning
                </button>
                <div id="excludedTable" style="display:none; margin-top:0.75rem; opacity:0.65;">
                    <div style="overflow-x: auto;">
                        <table class="details-table">
                            <thead>
                                <tr>
                                    <th>Land Use</th>
                                    <th>Physical</th>
                                    <th>Financial</th>
                                    <th>Productive</th>
                                    <th>Why Excluded</th>
                                </tr>
                            </thead>
                            <tbody id="excludedBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="disclaimer">
            <strong>Disclaimer:</strong> This tool provides a preliminary, educational estimate only. Highest and Best Use analysis for real estate investment or appraisal purposes should be performed by a qualified MAI appraiser or licensed professional. Actual HBU depends on detailed market studies, entitlement feasibility, construction cost analysis, and site-specific due diligence. Zoning codes, overlay districts, and specific plan areas in Los Angeles change frequently â€” always verify with the LA Department of City Planning (ZIMAS).
        </div>

        <!-- SB 79 Transit Opportunity Map -->
        <div class="map-section" id="mapSection" style="display:none;">
            <div class="section-header">
                <h2>SB 79 Transit Opportunity Map</h2>
                <p class="section-subtitle">Interactive map showing transit stations, SB 79 zones, and development opportunities</p>
            </div>
            <div class="map-controls" id="mapControls">
                <button type="button" class="layer-btn active" onclick="toggleMapLayer('tier1')">Tier 1 (Heavy Rail)</button>
                <button type="button" class="layer-btn active" onclick="toggleMapLayer('tier2')">Tier 2 (Metrolink)</button>
                <button type="button" class="layer-btn active" onclick="toggleMapLayer('zones')">SB 79 Zones</button>
                <button type="button" class="layer-btn active" onclick="toggleMapLayer('property')">Your Property</button>
            </div>
            <div id="sb79Map" style="height:500px;"></div>
            <div class="map-legend" id="mapLegend"></div>
            <div class="sb79-eligibility" id="sb79Eligibility" style="display:none;"></div>
        </div>
    </div>
</div>
</div><!-- /tabCalculator -->

<!-- ===== SB 79 FINDER TAB ===== -->
<div id="tabFinder" class="tab-content">
<div class="container">
    <div class="intro-box" style="border-left-color:#805ad5;">
        <h3>Listing Scout</h3>
        <p>Find homeowners sitting on <strong>hidden gold</strong>. New California legislation (SB 79, effective July 2026) dramatically increases what can be built near transit stations â€” meaning many homeowners' land is now worth <strong>far more than they realize</strong>. Select a station, search nearby parcels, and identify underbuilt properties where the land value exceeds the improvement value. These owners are your best listing leads â€” you can show them exactly what their property is worth to a developer.</p>
    </div>

    <div id="finderMapContainer" style="background:var(--card);border-radius:12px;padding:1.75rem;box-shadow:0 2px 8px rgba(0,0,0,0.06);margin-bottom:2rem;">
        <div style="text-align:center;margin-bottom:1rem;">
            <h2 style="font-size:1.3rem;color:var(--primary);margin-bottom:0.25rem;">LA Metro Transit Stations</h2>
            <p style="font-size:0.88rem;color:var(--text-light);">Click any station to select it, then configure filters and search for opportunities</p>
        </div>
        <div id="finderMap" style="width:100%;height:500px;border-radius:10px;border:1.5px solid var(--border);z-index:1;"></div>
        <div class="map-legend" id="finderMapLegend"></div>
    </div>

    <div style="background:var(--card);border-radius:12px;padding:1.75rem;box-shadow:0 2px 8px rgba(0,0,0,0.06);margin-bottom:2rem;">
        <h2 style="font-size:1.1rem;color:var(--primary);border-bottom:2px solid var(--border);padding-bottom:0.5rem;margin-bottom:1.25rem;">Area Scanner</h2>

        <div class="scanner-modes">
            <button class="scanner-mode-btn active" onclick="setScannerMode('station')">&#128651; Metro Station</button>
            <button class="scanner-mode-btn" onclick="setScannerMode('draw')">&#9999;&#65039; Draw on Map</button>
            <button class="scanner-mode-btn" onclick="setScannerMode('zip')">&#128230; ZIP Code</button>
            <button class="scanner-mode-btn" onclick="setScannerMode('radius')">&#128205; Address Radius</button>
        </div>

        <!-- Mode: Metro Station (existing) -->
        <div id="scannerPanel_station" class="scanner-panel active">
            <div class="finder-controls">
                <div class="finder-field" style="grid-column: span 2;">
                    <label>Transit Station</label>
                    <select id="finderStation2"></select>
                </div>
                <div class="finder-field">
                    <label>Search Radius (select one or more)</label>
                    <div class="finder-checks">
                        <label><input type="checkbox" class="finderRadius2" value="200"> Adjacent (200ft)</label>
                        <label><input type="checkbox" class="finderRadius2" value="1320"> Inner (1/4 mi)</label>
                        <label><input type="checkbox" class="finderRadius2" value="2640" checked> Outer (1/2 mi)</label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mode: Draw on Map -->
        <div id="scannerPanel_draw" class="scanner-panel">
            <p style="font-size:0.85rem;color:var(--text-light);margin-bottom:0.75rem;">Use the drawing tools on the map above to draw a polygon, rectangle, or circle. Then click <strong>Find Opportunities</strong> to scan all parcels in that area.</p>
            <div style="font-size:0.78rem;color:var(--primary);font-weight:600;">Tip: Click the polygon or rectangle tool in the map toolbar, draw your shape, then search.</div>
        </div>

        <!-- Mode: ZIP Code -->
        <div id="scannerPanel_zip" class="scanner-panel">
            <div class="finder-controls">
                <div class="finder-field" style="grid-column: span 2;">
                    <label>ZIP Code</label>
                    <select id="scannerZip">
                        <option value="">Select a ZIP code...</option>
                    </select>
                </div>
                <div class="finder-field">
                    <label>Search Radius from ZIP Center</label>
                    <div class="finder-checks">
                        <label><input type="radio" name="zipRadius" value="0.5" checked> 1/2 mi</label>
                        <label><input type="radio" name="zipRadius" value="0.75"> 3/4 mi</label>
                        <label><input type="radio" name="zipRadius" value="1.0"> 1 mi</label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mode: Address Radius -->
        <div id="scannerPanel_radius" class="scanner-panel">
            <div class="finder-controls">
                <div class="finder-field" style="grid-column: span 2;">
                    <label>Address</label>
                    <div style="display:flex;gap:0.5rem;">
                        <input type="text" id="scannerAddress" placeholder="e.g. 6801 Hollywood Blvd, Los Angeles, CA" style="flex:1;" onkeydown="if(event.key==='Enter'){event.preventDefault();runAreaScan();}">
                        <button type="button" class="btn-lookup" onclick="geocodeScannerAddress()" style="white-space:nowrap;">Locate</button>
                    </div>
                    <div id="scannerAddressStatus" style="font-size:0.78rem;color:var(--text-light);margin-top:0.3rem;"></div>
                </div>
                <div class="finder-field">
                    <label>Search Radius</label>
                    <div class="finder-checks">
                        <label><input type="radio" name="addrRadius" value="0.25"> 1/4 mi</label>
                        <label><input type="radio" name="addrRadius" value="0.5" checked> 1/2 mi</label>
                        <label><input type="radio" name="addrRadius" value="1.0"> 1 mi</label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Common filters for all modes -->
        <div style="border-top:1px solid var(--border);padding-top:1rem;margin-top:0.5rem;">
            <div class="finder-controls">
                <div class="finder-field">
                    <label>Use Type</label>
                    <div class="finder-checks">
                        <label><input type="checkbox" class="finderUseType2" value="Residential" checked> Residential</label>
                        <label><input type="checkbox" class="finderUseType2" value="Commercial" checked> Commercial</label>
                        <label><input type="checkbox" class="finderUseType2" value="Industrial"> Industrial</label>
                        <label><input type="checkbox" class="finderUseType2" value="Vacant" checked> Vacant</label>
                    </div>
                </div>
                <div class="finder-field">
                    <label>Min Lot Size (sq ft)</label>
                    <input type="number" id="finderMinLot2" value="2500" min="0" step="500">
                </div>
                <div class="finder-field">
                    <label>Max Lot Size (sq ft)</label>
                    <input type="number" id="finderMaxLot2" value="100000" min="0" step="500">
                </div>
            </div>
        </div>

        <!-- Smart filters â€” shown after results load -->
        <div id="smartFilterPanel" style="display:none;"></div>

        <button type="button" class="finder-btn-search" id="finderSearchBtn2" onclick="runAreaScan()">Find Opportunities</button>
        <div class="finder-progress" id="finderProgress2">
            <div class="finder-progress-bar"><div class="finder-progress-fill" id="finderProgressFill2"></div></div>
            <div class="finder-progress-text" id="finderProgressText2">Querying parcels...</div>
        </div>
        <div id="finderResultsArea2"></div>
    </div>

    <div id="savedListPanel" class="saved-list-panel" style="display:none;">
        <h2>Saved Properties</h2>
        <div class="saved-list-header">
            <span id="savedListCount">0 properties</span>
            <div class="saved-list-actions">
                <button type="button" class="saved-btn" onclick="combineContiguousParcels()" style="background:#805ad5;color:#fff;" id="combineBtn" title="Select 2-4 contiguous parcels to combine">Combine Parcels</button>
                <button type="button" class="saved-btn saved-btn-export" onclick="exportSavedCSV()">Export to Excel</button>
                <button type="button" class="saved-btn saved-btn-clear" onclick="clearSavedList()">Clear All</button>
            </div>
        </div>
        <div class="finder-table-wrapper">
            <table class="finder-table" id="savedListTable">
                <thead><tr>
                    <th style="cursor:default;width:30px;"><input type="checkbox" id="savedSelectAll" onclick="toggleSavedSelectAll()" title="Select for combining"></th>
                    <th style="cursor:default;">Address</th>
                    <th style="cursor:default;">APN</th>
                    <th style="cursor:default;">Lot Size</th>
                    <th style="cursor:default;">Zone</th>
                    <th style="cursor:default;">Links</th>
                    <th style="cursor:default;"></th>
                </tr></thead>
                <tbody id="savedListBody"></tbody>
            </table>
        </div>
    </div>
</div>
</div><!-- /tabFinder -->

<!-- ===== PIPELINE TAB ===== -->
<div id="tabPipeline" class="tab-content">
<div class="container">
    <div class="intro-box" style="border-left-color:#3182ce;">
        <h3>Development Pipeline</h3>
        <p>Search <strong>active LA City building permits</strong> near any address. Results are color-coded by pipeline stage â€” from initial submission through Certificate of Occupancy. Use this to evaluate the competitive development landscape around any site. Data sourced from LA City Open Data (updated daily).</p>
    </div>

    <div id="pipelineMapContainer" style="background:var(--card);border-radius:12px;padding:1.75rem;box-shadow:0 2px 8px rgba(0,0,0,0.06);margin-bottom:2rem;">
        <div style="text-align:center;margin-bottom:1rem;">
            <h2 style="font-size:1.3rem;color:var(--primary);margin-bottom:0.25rem;">Permit Activity Map</h2>
            <p style="font-size:0.88rem;color:var(--text-light);" id="pipelineMapStatus">Enter an address or click the map to set a search center</p>
        </div>
        <div id="pipelineMap" style="width:100%;height:500px;border-radius:10px;border:1.5px solid var(--border);z-index:1;"></div>
        <div class="pipeline-legend" id="pipelineLegend"></div>
    </div>

    <div style="background:var(--card);border-radius:12px;padding:1.75rem;box-shadow:0 2px 8px rgba(0,0,0,0.06);margin-bottom:2rem;">
        <h2 style="font-size:1.1rem;color:var(--primary);border-bottom:2px solid var(--border);padding-bottom:0.5rem;margin-bottom:1.25rem;">Search Filters</h2>
        <div class="finder-controls">
            <div class="finder-field" style="grid-column: span 2;">
                <label>Address</label>
                <div style="display:flex;gap:0.5rem;">
                    <input type="text" id="pipelineAddress" placeholder="e.g. 6801 Hollywood Blvd, Los Angeles, CA" style="flex:1;" onkeydown="if(event.key==='Enter'){event.preventDefault();geocodePipelineAddress();}">
                    <button type="button" class="btn-lookup" onclick="geocodePipelineAddress()" style="white-space:nowrap;">Locate</button>
                </div>
            </div>
            <div class="finder-field">
                <label>Search Radius</label>
                <div class="finder-radios">
                    <label><input type="radio" name="pipelineRadius" value="0.25"> 1/4 mi</label>
                    <label><input type="radio" name="pipelineRadius" value="0.5" checked> 1/2 mi</label>
                    <label><input type="radio" name="pipelineRadius" value="1"> 1 mi</label>
                </div>
            </div>
            <div class="finder-field">
                <label>Permit Type</label>
                <div class="finder-checks">
                    <label><input type="checkbox" class="pipelinePermitType" value="bldg" checked> Building</label>
                    <label><input type="checkbox" class="pipelinePermitType" value="grading"> Grading</label>
                    <label><input type="checkbox" class="pipelinePermitType" value="elec"> Electrical</label>
                    <label><input type="checkbox" class="pipelinePermitType" value="plumb"> Plumbing</label>
                    <label><input type="checkbox" class="pipelinePermitType" value="mech"> Mechanical</label>
                </div>
            </div>
            <div class="finder-field">
                <label>Pipeline Stage</label>
                <div class="finder-checks">
                    <label><input type="checkbox" class="pipelineStage" value="submitted" checked> Submitted</label>
                    <label><input type="checkbox" class="pipelineStage" value="plan_check" checked> Plan Check</label>
                    <label><input type="checkbox" class="pipelineStage" value="issued" checked> Issued</label>
                    <label><input type="checkbox" class="pipelineStage" value="inspection" checked> Under Inspection</label>
                    <label><input type="checkbox" class="pipelineStage" value="finaled" checked> Finaled</label>
                    <label><input type="checkbox" class="pipelineStage" value="coo" checked> Cert of Occ</label>
                </div>
            </div>
            <div class="finder-field">
                <label>Min Valuation ($)</label>
                <input type="number" id="pipelineMinVal" placeholder="e.g. 500000" min="0" step="10000">
            </div>
            <div class="finder-field">
                <label>Date From</label>
                <input type="date" id="pipelineDateFrom">
            </div>
            <div class="finder-field">
                <label>Date To</label>
                <input type="date" id="pipelineDateTo">
            </div>
        </div>
        <div style="display:flex;gap:0.75rem;margin-top:1rem;flex-wrap:wrap;">
            <button type="button" class="btn-lookup" onclick="runPipelineSearch()" style="padding:0.6rem 1.5rem;">Search Permits</button>
            <button type="button" class="btn-lookup" onclick="clearPipelineSearch()" style="padding:0.6rem 1.5rem;background:#fff;color:var(--primary);border:1.5px solid var(--primary-light);">Clear</button>
            <button type="button" class="btn-lookup" onclick="exportPipelineCSV()" id="pipelineExportBtn" style="padding:0.6rem 1.5rem;background:#f0fff4;color:#276749;border:1.5px solid #9ae6b4;display:none;">Export CSV</button>
        </div>
        <div class="finder-progress" id="pipelineProgress">
            <div class="finder-progress-bar"><div class="finder-progress-fill" id="pipelineProgressFill"></div></div>
            <div class="finder-progress-text" id="pipelineProgressText">Searching permits...</div>
        </div>
    </div>

    <div id="pipelineResultsArea" style="display:none;">
        <div style="background:var(--card);border-radius:12px;padding:1.75rem;box-shadow:0 2px 8px rgba(0,0,0,0.06);">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;flex-wrap:wrap;gap:0.5rem;">
                <h2 style="font-size:1.1rem;color:var(--primary);margin:0;" id="pipelineResultsTitle">Results</h2>
                <span style="font-size:0.82rem;color:var(--text-light);" id="pipelineResultsSummary"></span>
                <div style="display:flex;gap:0.5rem;">
                    <button type="button" class="btn-lookup" onclick="savePipelineSelected()" id="pipelineSaveBtn" style="display:none;font-size:0.78rem;padding:6px 14px;">Save Selected</button>
                </div>
            </div>
            <div class="finder-table-wrapper">
                <table class="finder-table" id="pipelineTable">
                    <thead><tr>
                        <th style="width:30px;cursor:default;"><input type="checkbox" id="pipelineSelectAll" onclick="togglePipelineSelectAll()" title="Select all"></th>
                        <th data-col="address" onclick="setPipelineSort('address')">Address</th>
                        <th data-col="permit_nbr" onclick="setPipelineSort('permit_nbr')">Permit #</th>
                        <th data-col="permit_type" onclick="setPipelineSort('permit_type')">Type</th>
                        <th data-col="stage" onclick="setPipelineSort('stage')">Stage</th>
                        <th data-col="valuation" onclick="setPipelineSort('valuation')">Valuation</th>
                        <th data-col="date" onclick="setPipelineSort('date')">Date</th>
                        <th data-col="zone" onclick="setPipelineSort('zone')">Zone</th>
                        <th style="cursor:default;">Details</th>
                    </tr></thead>
                    <tbody id="pipelineTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="pipelineSavedPanel" style="display:none;background:var(--card);border-radius:12px;padding:1.75rem;box-shadow:0 2px 8px rgba(0,0,0,0.06);margin-top:2rem;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;flex-wrap:wrap;gap:0.5rem;">
            <h2 style="font-size:1.1rem;color:#805ad5;margin:0;">Saved Pipeline Sites</h2>
            <span style="font-size:0.82rem;color:var(--text-light);" id="pipelineSavedCount">0 sites</span>
            <div style="display:flex;gap:0.5rem;">
                <button type="button" class="btn-lookup" onclick="exportPipelineSavedCSV()" style="font-size:0.78rem;padding:6px 14px;">Export CSV</button>
                <button type="button" class="btn-lookup" onclick="clearPipelineSaved()" style="font-size:0.78rem;padding:6px 14px;background:#e53e3e;">Clear</button>
            </div>
        </div>
        <div class="finder-table-wrapper">
            <table class="finder-table">
                <thead><tr>
                    <th>Address</th><th>Permit #</th><th>Type</th><th>Stage</th><th>Valuation</th><th>Description</th><th>Action</th>
                </tr></thead>
                <tbody id="pipelineSavedBody"></tbody>
            </table>
        </div>
    </div>
</div>
</div><!-- /tabPipeline -->

<!-- ===== CONTACTS TAB ===== -->
<div id="tabContacts" class="tab-content">
<div class="container">
    <div class="intro-box" style="border-left-color:#805ad5;">
        <h3>Contacts Directory</h3>
        <p>Your <strong>go-to rolodex</strong> for every vendor and service provider you need to close a residential deal in Los Angeles County. Title &amp; escrow, home inspectors, mortgage lenders, appraisers, photographers, stagers, and more. Filter by category or search by name.</p>
    </div>

    <div style="background:var(--card);border-radius:12px;padding:1.75rem;box-shadow:0 2px 8px rgba(0,0,0,0.06);margin-bottom:2rem;">
        <div style="display:flex;gap:0.75rem;flex-wrap:wrap;margin-bottom:1.25rem;">
            <input type="text" id="contactSearch" placeholder="Search contacts..." style="flex:1;min-width:200px;padding:8px 12px;border:1px solid var(--border);border-radius:6px;font-size:0.85rem;" oninput="filterContacts()">
            <select id="contactCategory" style="padding:8px 12px;border:1px solid var(--border);border-radius:6px;font-size:0.85rem;" onchange="filterContacts()">
                <option value="">All Categories</option>
                <option value="title">Title & Escrow</option>
                <option value="mortgage">Mortgage Lenders</option>
                <option value="inspector">Home Inspectors</option>
                <option value="appraiser">Appraisers</option>
                <option value="photo">Photography & Media</option>
                <option value="staging">Staging</option>
                <option value="termite">Termite & Pest</option>
                <option value="insurance">Insurance</option>
                <option value="notary">Notary & Signing</option>
                <option value="moving">Moving & Junk Removal</option>
                <option value="handyman">Handyman & Repair</option>
                <option value="legal">Legal</option>
            </select>
        </div>
        <div id="contactsGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:1rem;"></div>
    </div>
</div>
</div><!-- /tabContacts -->

<!-- ===== MY SITES TAB ===== -->
<div id="tabSites" class="tab-content">
<div class="container">
    <div class="intro-box" style="border-left-color:#059669;">
        <h3>My Portfolio</h3>
        <p>Every property you analyze is <strong>automatically saved here</strong>, ranked by listing attractiveness. The key metric is the <strong>Opportunity Ratio</strong> â€” what a developer would pay divided by the current market value. Properties at <strong style="color:#059669;">1.5x or higher</strong> are strong listing opportunities where the homeowner stands to gain significantly. Properties <strong style="color:#dc2626;">below 1.0x</strong> are worth more as-is. Use the filter to show only strong opportunities, and click <strong>"One-Pager"</strong> to generate a polished report for the owner.</p>
    </div>

    <div id="sitesMapContainer" style="background:var(--card);border-radius:12px;padding:1.75rem;box-shadow:0 2px 8px rgba(0,0,0,0.06);margin-bottom:2rem;">
        <div style="text-align:center;margin-bottom:1rem;">
            <h2 style="font-size:1.3rem;color:var(--primary);margin-bottom:0.25rem;">My Analyzed Properties</h2>
            <p style="font-size:0.88rem;color:var(--text-light);">Color-coded by attractiveness: <span style="color:#059669;font-weight:600;">Green</span> = High, <span style="color:#d69e2e;font-weight:600;">Gold</span> = Medium, <span style="color:#ea580c;font-weight:600;">Orange</span> = Low-Medium, <span style="color:#dc2626;font-weight:600;">Red</span> = Low</p>
        </div>
        <div id="sitesMap" style="width:100%;height:450px;border-radius:10px;border:1.5px solid var(--border);z-index:1;"></div>
    </div>

    <!-- Pipeline Metrics -->
    <div class="pipeline-metrics" id="pipelineMetrics">
        <div class="pipeline-metric"><div class="pm-val" id="pmTotal">0</div><div class="pm-label">Total Prospects</div></div>
        <div class="pipeline-metric"><div class="pm-val" id="pmContacted">0</div><div class="pm-label">Contacted</div></div>
        <div class="pipeline-metric"><div class="pm-val" id="pmInterested">0</div><div class="pm-label">Interested</div></div>
        <div class="pipeline-metric"><div class="pm-val" id="pmListed">0</div><div class="pm-label">Listed</div></div>
        <div class="pipeline-metric"><div class="pm-val" id="pmSold">0</div><div class="pm-label">Sold</div></div>
        <div class="pipeline-metric"><div class="pm-val" id="pmConversion">0%</div><div class="pm-label">Contact &rarr; Listed</div></div>
    </div>

    <div style="background:var(--card);border-radius:12px;padding:1.75rem;box-shadow:0 2px 8px rgba(0,0,0,0.06);margin-bottom:2rem;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;flex-wrap:wrap;gap:0.5rem;">
            <h2 style="font-size:1.1rem;color:var(--primary);margin:0;">Prospect Pipeline</h2>
            <span style="font-size:0.82rem;color:var(--text-light);" id="sitesCount">0 properties</span>
            <select id="filterProspectStatus" onchange="renderAgentSites()" style="padding:4px 8px;border:1px solid var(--border);border-radius:6px;font-size:0.78rem;">
                <option value="">All Statuses</option>
                <option value="not_contacted">Not Contacted</option>
                <option value="contacted">Contacted</option>
                <option value="interested">Interested</option>
                <option value="listed">Listed</option>
                <option value="sold">Sold</option>
                <option value="passed">Passed</option>
            </select>
            <label style="display:flex;align-items:center;gap:0.4rem;font-size:0.82rem;color:var(--text-light);cursor:pointer;">
                <input type="checkbox" id="filterStrongOpp" onchange="renderAgentSites()" style="accent-color:#059669;"> 1.5x+ only
            </label>
            <button type="button" class="btn-lookup" onclick="exportPortfolioCallList()" style="font-size:0.78rem;padding:6px 14px;">Export Call List</button>
            <button type="button" class="btn-lookup" onclick="clearAgentSites()" style="font-size:0.78rem;padding:6px 14px;background:#e53e3e;color:white;">Clear All</button>
        </div>
        <div class="finder-table-wrapper">
            <table class="finder-table" id="sitesTable">
                <thead><tr>
                    <th data-col="score" onclick="sortAgentSites('score')" style="cursor:pointer;">Score</th>
                    <th data-col="address" onclick="sortAgentSites('address')" style="cursor:pointer;">Address</th>
                    <th data-col="status" onclick="sortAgentSites('status')" style="cursor:pointer;">Status</th>
                    <th data-col="bestUse" onclick="sortAgentSites('bestUse')" style="cursor:pointer;">Best Use</th>
                    <th data-col="lotSize" onclick="sortAgentSites('lotSize')" style="cursor:pointer;">Lot Size</th>
                    <th data-col="asIsValue" onclick="sortAgentSites('asIsValue')" style="cursor:pointer;">Market Value</th>
                    <th data-col="devValue" onclick="sortAgentSites('devValue')" style="cursor:pointer;">Dev Land Bid</th>
                    <th data-col="oppRatio" onclick="sortAgentSites('oppRatio')" style="cursor:pointer;">Opp. Ratio</th>
                    <th data-col="ease" onclick="sortAgentSites('ease')" style="cursor:pointer;">Ease</th>
                    <th data-col="date" onclick="sortAgentSites('date')" style="cursor:pointer;">Date</th>
                    <th style="cursor:default;">Action</th>
                </tr></thead>
                <tbody id="sitesTableBody"></tbody>
            </table>
        </div>
    </div>
</div>
</div><!-- /tabSites -->

<!-- ===== Analysis Detail Modal ===== -->
<div class="modal-overlay" id="analysisModal" style="display:none;" onclick="if(event.target===this)closeAnalysis();">
    <div class="modal-content">
        <div class="modal-top-bar">
            <button type="button" class="modal-print-btn" onclick="printAnalysis()">Print / PDF</button>
            <button type="button" class="modal-close" onclick="closeAnalysis()">&times;</button>
        </div>
        <div class="modal-header">
            <h2 id="modalTitle"></h2>
            <p id="modalSubtitle"></p>
        </div>
        <div class="modal-body" id="modalBody"></div>
    </div>
</div>

<!-- ===== Listing One-Pager Modal ===== -->
<div class="onepager-overlay" id="onepagerModal" style="display:none;" onclick="if(event.target===this)closeOnePager();">
    <div class="onepager-topbar">
        <button type="button" class="modal-print-btn" onclick="printOnePager()">Print / PDF</button>
        <button type="button" class="modal-close" onclick="closeOnePager()">&times;</button>
    </div>
    <div class="onepager-content" id="onepagerContent"></div>
</div>

<footer>
    &copy; 2026 CLS CRE &mdash; Land to Yield. All rights reserved. For educational and professional use only.
</footer>

<script>
// ============================================================
//  AUTH GATE
// ============================================================
// Master admin password hash (original password still works)
const ADMIN_HASH = '08c5d8c40ac5bd96091f704d10989da4e7b65c5ee36be18b618848c4e91a22af';

// Subscriber access-code hashes â€” add SHA-256 hashes here after generating with generateCodeHash()
const VALID_CODES = [
    '14197a5cc2fdd7254604a791eae2e02bd3e23a448230367ce249fe3192b94b12', // BETA-TEST-2026
];

async function sha256(str) {
    const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
    return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('');
}

async function checkAuth() {
    const code = document.getElementById('authPassword').value;
    const hash = await sha256(code);
    if (hash === ADMIN_HASH || VALID_CODES.includes(hash)) {
        localStorage.setItem('hbu_auth_hash', hash);
        const overlay = document.getElementById('authOverlay');
        overlay.classList.add('fade-out');
        setTimeout(() => overlay.remove(), 500);
    } else {
        document.getElementById('authError').textContent = 'Invalid access code. Please try again.';
        document.getElementById('authPassword').value = '';
        document.getElementById('authPassword').focus();
    }
}

// Auto-authenticate on load if stored hash is still valid
(function() {
    const storedHash = localStorage.getItem('hbu_auth_hash');
    if (storedHash && (storedHash === ADMIN_HASH || VALID_CODES.includes(storedHash))) {
        const overlay = document.getElementById('authOverlay');
        if (overlay) overlay.remove();
    } else {
        // Clear invalid/revoked hash
        localStorage.removeItem('hbu_auth_hash');
    }
})();

// Utility: run in browser console to generate a hash for a new access code
// Usage: generateCodeHash('YOUR-CODE-HERE')
async function generateCodeHash(code) {
    const hash = await sha256(code);
    console.log('Code:', code);
    console.log('Hash:', hash);
    console.log('Add this to VALID_CODES array:', "'" + hash + "',");
    return hash;
}

// Neighborhood centroids (lat, lon)
const NEIGHBORHOOD_CENTROIDS = {
    dtla:         { lat: 34.0407, lon: -118.2468 },
    hollywood:    { lat: 34.0928, lon: -118.3287 },
    koreatown:    { lat: 34.0578, lon: -118.3010 },
    westside:     { lat: 34.0367, lon: -118.4376 },
    santamonica:  { lat: 34.0906, lon: -118.3856 },
    beverly:      { lat: 34.0736, lon: -118.4004 },
    midcity:      { lat: 34.0483, lon: -118.3396 },
    southla:      { lat: 33.9425, lon: -118.2820 },
    valleyeast:   { lat: 34.2219, lon: -118.4157 },
    valleywest:   { lat: 34.1866, lon: -118.5353 },
    silverlake:   { lat: 34.0869, lon: -118.2697 },
    highland:     { lat: 34.1133, lon: -118.1902 },
    venice:       { lat: 33.9850, lon: -118.4695 },
    culver:       { lat: 34.0211, lon: -118.3965 },
    exposition:   { lat: 34.0183, lon: -118.2932 },
    southbay:     { lat: 33.8358, lon: -118.3406 },
    harbor:       { lat: 33.7361, lon: -118.2922 },
    boyleheights: { lat: 34.0345, lon: -118.2120 },
};

// Map Nominatim suburb/neighbourhood names â†’ our dropdown IDs
const SUBURB_TO_NEIGHBORHOOD = {
    'downtown': 'dtla',
    'downtown los angeles': 'dtla',
    'little tokyo': 'dtla',
    'arts district': 'dtla',
    'chinatown': 'dtla',
    'civic center': 'dtla',
    'bunker hill': 'dtla',
    'financial district': 'dtla',
    'skid row': 'dtla',
    'hollywood': 'hollywood',
    'east hollywood': 'hollywood',
    'thai town': 'hollywood',
    'hollywood hills': 'hollywood',
    'los feliz': 'silverlake',
    'koreatown': 'koreatown',
    'pico-union': 'koreatown',
    'westlake': 'koreatown',
    'west los angeles': 'westside',
    'west la': 'westside',
    'sawtelle': 'westside',
    'westwood': 'westside',
    'brentwood': 'westside',
    'bel air': 'westside',
    'santa monica': 'santamonica',
    'west hollywood': 'santamonica',
    'weho': 'santamonica',
    'beverly hills': 'beverly',
    'beverly grove': 'beverly',
    'beverlywood': 'beverly',
    'century city': 'beverly',
    'mid-wilshire': 'midcity',
    'mid wilshire': 'midcity',
    'mid-city': 'midcity',
    'mid city': 'midcity',
    'miracle mile': 'midcity',
    'hancock park': 'midcity',
    'larchmont': 'midcity',
    'windsor square': 'midcity',
    'park la brea': 'midcity',
    'fairfax': 'midcity',
    'south los angeles': 'southla',
    'south la': 'southla',
    'watts': 'southla',
    'florence': 'southla',
    'vermont square': 'southla',
    'vermont-slauson': 'southla',
    'green meadows': 'southla',
    'north hollywood': 'valleyeast',
    'noho': 'valleyeast',
    'studio city': 'valleyeast',
    'valley village': 'valleyeast',
    'sun valley': 'valleyeast',
    'panorama city': 'valleyeast',
    'arleta': 'valleyeast',
    'pacoima': 'valleyeast',
    'sylmar': 'valleyeast',
    'sherman oaks': 'valleywest',
    'encino': 'valleywest',
    'tarzana': 'valleywest',
    'woodland hills': 'valleywest',
    'reseda': 'valleywest',
    'canoga park': 'valleywest',
    'winnetka': 'valleywest',
    'chatsworth': 'valleywest',
    'northridge': 'valleywest',
    'granada hills': 'valleywest',
    'west hills': 'valleywest',
    'silver lake': 'silverlake',
    'silverlake': 'silverlake',
    'echo park': 'silverlake',
    'elysian valley': 'silverlake',
    'atwater village': 'silverlake',
    'highland park': 'highland',
    'eagle rock': 'highland',
    'glassell park': 'highland',
    'mount washington': 'highland',
    'cypress park': 'highland',
    'el sereno': 'highland',
    'venice': 'venice',
    'mar vista': 'venice',
    'del rey': 'venice',
    'playa vista': 'venice',
    'playa del rey': 'venice',
    'marina del rey': 'venice',
    'culver city': 'culver',
    'palms': 'culver',
    'rancho park': 'culver',
    'cheviot hills': 'culver',
    'castle heights': 'culver',
    'exposition park': 'exposition',
    'university park': 'exposition',
    'leimert park': 'exposition',
    'jefferson park': 'exposition',
    'west adams': 'exposition',
    'baldwin hills': 'exposition',
    'crenshaw': 'exposition',
    'torrance': 'southbay',
    'gardena': 'southbay',
    'carson': 'southbay',
    'hawthorne': 'southbay',
    'inglewood': 'southbay',
    'lawndale': 'southbay',
    'el segundo': 'southbay',
    'manhattan beach': 'southbay',
    'hermosa beach': 'southbay',
    'redondo beach': 'southbay',
    'san pedro': 'harbor',
    'wilmington': 'harbor',
    'harbor city': 'harbor',
    'harbor gateway': 'harbor',
    'boyle heights': 'boyleheights',
    'east los angeles': 'boyleheights',
    'east la': 'boyleheights',
    'lincoln heights': 'boyleheights',
};

// LA Metro Rail & Metrolink stations { lat, lon, name, line, tier, serviceType }
// Tier is determined by SERVICE TYPE, not distance:
//   Tier 1 = Heavy Rail (subway): Red/B Line, Purple/D Line
//   Tier 2 = Light Rail: Blue/A, Expo/E, Gold/L, Green/C, K Line, Regional Connector
//   Tier 2 = Commuter Rail: Metrolink
const METRO_STATIONS = [
    // --- Red Line (B Line) â€” HEAVY RAIL (Tier 1): Union Station â†’ North Hollywood ---
    { lat: 34.0561, lon: -118.2365, name: 'Union Station', line: 'red', tier: 1, serviceType: 'Heavy Rail' },
    { lat: 34.0562, lon: -118.2500, name: 'Civic Center/Grand Park', line: 'red', tier: 1, serviceType: 'Heavy Rail' },
    { lat: 34.0469, lon: -118.2600, name: 'Pershing Square', line: 'red', tier: 1, serviceType: 'Heavy Rail' },
    { lat: 34.0488, lon: -118.2588, name: '7th St/Metro Center', line: 'red', tier: 1, serviceType: 'Heavy Rail' },
    { lat: 34.0678, lon: -118.2915, name: 'Wilshire/Vermont', line: 'red', tier: 1, serviceType: 'Heavy Rail' },
    { lat: 34.1017, lon: -118.3070, name: 'Hollywood/Western', line: 'red', tier: 1, serviceType: 'Heavy Rail' },
    { lat: 34.1017, lon: -118.3250, name: 'Hollywood/Vine', line: 'red', tier: 1, serviceType: 'Heavy Rail' },
    { lat: 34.1014, lon: -118.3388, name: 'Hollywood/Highland', line: 'red', tier: 1, serviceType: 'Heavy Rail' },
    { lat: 34.1381, lon: -118.3623, name: 'Universal City/Studio City', line: 'red', tier: 1, serviceType: 'Heavy Rail' },
    { lat: 34.1687, lon: -118.3765, name: 'North Hollywood', line: 'red', tier: 1, serviceType: 'Heavy Rail' },
    // --- Purple Line (D Line) â€” HEAVY RAIL (Tier 1): Wilshire corridor ---
    { lat: 34.0624, lon: -118.3080, name: 'Wilshire/Normandie', line: 'purple', tier: 1, serviceType: 'Heavy Rail' },
    { lat: 34.0573, lon: -118.3273, name: 'Wilshire/Western', line: 'purple', tier: 1, serviceType: 'Heavy Rail' },
    { lat: 34.0620, lon: -118.3440, name: 'Wilshire/La Brea', line: 'purple', tier: 1, serviceType: 'Heavy Rail' },
    { lat: 34.0622, lon: -118.3615, name: 'Wilshire/Fairfax', line: 'purple', tier: 1, serviceType: 'Heavy Rail' },
    { lat: 34.0626, lon: -118.3766, name: 'Wilshire/La Cienega', line: 'purple', tier: 1, serviceType: 'Heavy Rail' },
    { lat: 34.0630, lon: -118.3945, name: 'Wilshire/Rodeo', line: 'purple', tier: 1, serviceType: 'Heavy Rail' },
    { lat: 34.0632, lon: -118.4170, name: 'Century City/Constellation', line: 'purple', tier: 1, serviceType: 'Heavy Rail' },
    { lat: 34.0638, lon: -118.4385, name: 'Westwood/UCLA', line: 'purple', tier: 1, serviceType: 'Heavy Rail' },
    { lat: 34.0640, lon: -118.4510, name: 'Westwood/VA Hospital', line: 'purple', tier: 1, serviceType: 'Heavy Rail' },
    // --- Blue/A Line â€” LIGHT RAIL (Tier 2): 7th/Metro â†’ Long Beach ---
    { lat: 34.0398, lon: -118.2610, name: 'Pico', line: 'blue_a', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0295, lon: -118.2435, name: 'LATTC/Ortho Institute', line: 'blue_a', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0222, lon: -118.2344, name: 'San Pedro St', line: 'blue_a', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0030, lon: -118.2297, name: 'Washington', line: 'blue_a', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.9938, lon: -118.2296, name: 'Vernon', line: 'blue_a', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.9830, lon: -118.2295, name: 'Slauson', line: 'blue_a', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.9722, lon: -118.2293, name: 'Florence', line: 'blue_a', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.9612, lon: -118.2340, name: 'Firestone', line: 'blue_a', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.9450, lon: -118.2362, name: '103rd St/Watts Towers', line: 'blue_a', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.9268, lon: -118.2377, name: 'Willowbrook/Rosa Parks', line: 'blue_a', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.9160, lon: -118.2382, name: 'Compton', line: 'blue_a', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.9029, lon: -118.2382, name: 'Artesia', line: 'blue_a', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.8862, lon: -118.2284, name: 'Del Amo', line: 'blue_a', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.8697, lon: -118.2119, name: 'Wardlow', line: 'blue_a', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.8567, lon: -118.2100, name: 'Willow St', line: 'blue_a', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.8470, lon: -118.1890, name: 'Pacific Coast Hwy', line: 'blue_a', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.7686, lon: -118.1891, name: '1st St (Long Beach)', line: 'blue_a', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.7676, lon: -118.1935, name: 'Downtown Long Beach', line: 'blue_a', tier: 2, serviceType: 'Light Rail' },
    // --- Expo/E Line â€” LIGHT RAIL (Tier 2): 7th/Metro â†’ Downtown Santa Monica ---
    { lat: 34.0222, lon: -118.2580, name: 'Expo Park/USC', line: 'expo_e', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0186, lon: -118.2862, name: 'Expo/Vermont', line: 'expo_e', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0183, lon: -118.3088, name: 'Expo/Western', line: 'expo_e', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0227, lon: -118.3310, name: 'Expo/Crenshaw', line: 'expo_e', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0252, lon: -118.3418, name: 'Farmdale', line: 'expo_e', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0289, lon: -118.3520, name: 'Expo/La Brea', line: 'expo_e', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0270, lon: -118.3710, name: 'La Cienega/Jefferson', line: 'expo_e', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0248, lon: -118.3860, name: 'Culver City', line: 'expo_e', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0209, lon: -118.3520, name: 'Palms', line: 'expo_e', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0124, lon: -118.3908, name: 'Expo/Sepulveda', line: 'expo_e', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0168, lon: -118.3685, name: 'Westwood/Rancho Park', line: 'expo_e', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0135, lon: -118.4330, name: 'Expo/Bundy', line: 'expo_e', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0156, lon: -118.4694, name: '26th St/Bergamot', line: 'expo_e', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0154, lon: -118.4960, name: 'Downtown Santa Monica', line: 'expo_e', tier: 2, serviceType: 'Light Rail' },
    // --- Gold/L Line â€” LIGHT RAIL (Tier 2): East LA â†’ Azusa/APU ---
    { lat: 34.0566, lon: -118.2338, name: 'Little Tokyo/Arts District', line: 'gold_l', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0561, lon: -118.2365, name: 'Union Station (Gold)', line: 'gold_l', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0620, lon: -118.2360, name: 'Chinatown', line: 'gold_l', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0672, lon: -118.2350, name: 'Lincoln/Cypress', line: 'gold_l', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0760, lon: -118.2260, name: 'Heritage Square/Arroyo', line: 'gold_l', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0890, lon: -118.2100, name: 'Southwest Museum', line: 'gold_l', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0960, lon: -118.1990, name: 'Highland Park', line: 'gold_l', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.1118, lon: -118.1868, name: 'South Pasadena', line: 'gold_l', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.1175, lon: -118.1560, name: 'Fillmore', line: 'gold_l', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.1285, lon: -118.1340, name: 'Del Mar', line: 'gold_l', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.1360, lon: -118.1230, name: 'Memorial Park', line: 'gold_l', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.1421, lon: -118.1150, name: 'Lake', line: 'gold_l', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.1497, lon: -118.1030, name: 'Allen', line: 'gold_l', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.1500, lon: -118.0830, name: 'Sierra Madre Villa', line: 'gold_l', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.1520, lon: -118.0520, name: 'Arcadia', line: 'gold_l', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.1425, lon: -118.0310, name: 'Monrovia', line: 'gold_l', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.1365, lon: -118.0090, name: 'Duarte/City of Hope', line: 'gold_l', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.1360, lon: -117.9870, name: 'Irwindale', line: 'gold_l', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.1370, lon: -117.9620, name: 'Azusa Downtown', line: 'gold_l', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.1380, lon: -117.9440, name: 'APU/Citrus College', line: 'gold_l', tier: 2, serviceType: 'Light Rail' },
    // Gold/L Line East LA branch
    { lat: 34.0441, lon: -118.2120, name: 'Mariachi Plaza/Boyle Heights', line: 'gold_l', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0395, lon: -118.1938, name: 'Soto', line: 'gold_l', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0335, lon: -118.1770, name: 'Indiana', line: 'gold_l', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0290, lon: -118.1620, name: 'Maravilla', line: 'gold_l', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0245, lon: -118.1475, name: 'East LA Civic Center', line: 'gold_l', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0220, lon: -118.1280, name: 'Atlantic', line: 'gold_l', tier: 2, serviceType: 'Light Rail' },
    // --- Green/C Line â€” LIGHT RAIL (Tier 2): Norwalk â†’ Redondo Beach ---
    { lat: 33.9190, lon: -118.0570, name: 'Norwalk', line: 'green_c', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.9198, lon: -118.0940, name: 'Lakewood Blvd', line: 'green_c', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.9204, lon: -118.1262, name: 'Long Beach Blvd', line: 'green_c', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.9230, lon: -118.1706, name: 'Avalon', line: 'green_c', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.9268, lon: -118.2377, name: 'Willowbrook/Rosa Parks (Green)', line: 'green_c', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.9252, lon: -118.2565, name: 'Vermont/Athens', line: 'green_c', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.9289, lon: -118.2735, name: 'Harbor Freeway', line: 'green_c', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.9324, lon: -118.2915, name: 'Crenshaw (Green)', line: 'green_c', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.9525, lon: -118.3518, name: 'Hawthorne/Lennox', line: 'green_c', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.9340, lon: -118.3828, name: 'Aviation/LAX', line: 'green_c', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.9262, lon: -118.3960, name: 'Mariposa', line: 'green_c', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.9130, lon: -118.4030, name: 'El Segundo', line: 'green_c', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.9030, lon: -118.4093, name: 'Douglas', line: 'green_c', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.8920, lon: -118.4128, name: 'Redondo Beach', line: 'green_c', tier: 2, serviceType: 'Light Rail' },
    // --- K Line (Crenshaw/LAX) â€” LIGHT RAIL (Tier 2) ---
    { lat: 34.0227, lon: -118.3310, name: 'Expo/Crenshaw (K)', line: 'k_line', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0100, lon: -118.3340, name: 'Leimert Park', line: 'k_line', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.9978, lon: -118.3320, name: 'Hyde Park', line: 'k_line', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.9838, lon: -118.3290, name: 'Fairview Heights', line: 'k_line', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.9680, lon: -118.3380, name: 'Downtown Inglewood', line: 'k_line', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.9530, lon: -118.3560, name: 'Westchester/Veterans', line: 'k_line', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.9340, lon: -118.3828, name: 'Aviation/Century (K)', line: 'k_line', tier: 2, serviceType: 'Light Rail' },
    // --- Regional Connector â€” LIGHT RAIL (Tier 2) ---
    { lat: 34.0458, lon: -118.2562, name: 'Grand Av Arts/Bunker Hill', line: 'connector', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0489, lon: -118.2468, name: 'Historic Broadway', line: 'connector', tier: 2, serviceType: 'Light Rail' },
    // --- Key Metrolink Stations (LA County) â€” COMMUTER RAIL (Tier 2) ---
    { lat: 34.0561, lon: -118.2365, name: 'LA Union Station (Metrolink)', line: 'metrolink', tier: 2, serviceType: 'Commuter Rail' },
    { lat: 34.1900, lon: -118.4500, name: 'Van Nuys (Metrolink)', line: 'metrolink', tier: 2, serviceType: 'Commuter Rail' },
    { lat: 34.2083, lon: -118.4958, name: 'Chatsworth', line: 'metrolink', tier: 2, serviceType: 'Commuter Rail' },
    { lat: 34.2600, lon: -118.4400, name: 'Sylmar/San Fernando', line: 'metrolink', tier: 2, serviceType: 'Commuter Rail' },
    { lat: 34.1480, lon: -118.2555, name: 'Glendale', line: 'metrolink', tier: 2, serviceType: 'Commuter Rail' },
    { lat: 34.1360, lon: -118.2410, name: 'Glendale (Tropico)', line: 'metrolink', tier: 2, serviceType: 'Commuter Rail' },
    { lat: 34.0930, lon: -118.2360, name: 'Lincoln Heights (Metrolink)', line: 'metrolink', tier: 2, serviceType: 'Commuter Rail' },
    { lat: 34.1766, lon: -118.3080, name: 'Burbank Airport North', line: 'metrolink', tier: 2, serviceType: 'Commuter Rail' },
    { lat: 34.1834, lon: -118.3268, name: 'Burbank Downtown', line: 'metrolink', tier: 2, serviceType: 'Commuter Rail' },
    { lat: 33.9017, lon: -118.2260, name: 'Compton (Metrolink)', line: 'metrolink', tier: 2, serviceType: 'Commuter Rail' },
    { lat: 34.0513, lon: -118.2310, name: 'LA Downtown (Commercial St)', line: 'metrolink', tier: 2, serviceType: 'Commuter Rail' },
    { lat: 34.0670, lon: -118.1650, name: 'Cal State LA', line: 'metrolink', tier: 2, serviceType: 'Commuter Rail' },
    { lat: 34.0870, lon: -118.1300, name: 'El Monte', line: 'metrolink', tier: 2, serviceType: 'Commuter Rail' },
    { lat: 34.1010, lon: -118.1030, name: 'Baldwin Park', line: 'metrolink', tier: 2, serviceType: 'Commuter Rail' },
    { lat: 34.1160, lon: -118.0550, name: 'Covina', line: 'metrolink', tier: 2, serviceType: 'Commuter Rail' },
    { lat: 34.0500, lon: -117.7510, name: 'Pomona Downtown', line: 'metrolink', tier: 2, serviceType: 'Commuter Rail' },
    { lat: 33.7710, lon: -118.1890, name: 'Long Beach (Metrolink)', line: 'metrolink', tier: 2, serviceType: 'Commuter Rail' },
];

// LA County ZIP Code centroids (approx center for radius-based scanning)
const LA_ZIP_CENTROIDS = {
'90001':{lat:33.9425,lon:-118.2551,name:'Florence-Firestone'},'90002':{lat:33.9490,lon:-118.2480,name:'Watts'},'90003':{lat:33.9640,lon:-118.2730,name:'South LA'},'90004':{lat:34.0770,lon:-118.3090,name:'Los Feliz'},
'90005':{lat:34.0590,lon:-118.3100,name:'Koreatown'},'90006':{lat:34.0480,lon:-118.2920,name:'Westlake'},'90007':{lat:34.0290,lon:-118.2830,name:'USC/Exposition Park'},'90008':{lat:34.0110,lon:-118.3400,name:'Baldwin Hills'},
'90010':{lat:34.0600,lon:-118.3020,name:'Mid-Wilshire'},'90011':{lat:33.9930,lon:-118.2580,name:'South Central'},'90012':{lat:34.0620,lon:-118.2400,name:'Civic Center/Chinatown'},'90013':{lat:34.0440,lon:-118.2450,name:'Downtown LA'},
'90014':{lat:34.0390,lon:-118.2560,name:'Fashion District'},'90015':{lat:34.0360,lon:-118.2680,name:'South Park'},'90016':{lat:34.0280,lon:-118.3540,name:'West Adams'},'90017':{lat:34.0510,lon:-118.2660,name:'Downtown West'},
'90018':{lat:34.0330,lon:-118.3190,name:'Jefferson Park'},'90019':{lat:34.0480,lon:-118.3430,name:'Mid-City'},'90020':{lat:34.0650,lon:-118.3090,name:'Koreatown North'},'90022':{lat:34.0230,lon:-118.1560,name:'East LA'},
'90023':{lat:34.0230,lon:-118.1980,name:'Boyle Heights'},'90024':{lat:34.0640,lon:-118.4310,name:'Westwood'},'90025':{lat:34.0510,lon:-118.4450,name:'West LA'},'90026':{lat:34.0770,lon:-118.2600,name:'Echo Park'},
'90027':{lat:34.1010,lon:-118.2920,name:'Los Feliz/Griffith'},'90028':{lat:34.0990,lon:-118.3260,name:'Hollywood'},'90029':{lat:34.0890,lon:-118.2940,name:'Thai Town'},'90031':{lat:34.0790,lon:-118.2100,name:'Lincoln Heights'},
'90032':{lat:34.0780,lon:-118.1770,name:'El Sereno'},'90033':{lat:34.0510,lon:-118.2100,name:'Boyle Heights North'},'90034':{lat:34.0310,lon:-118.3970,name:'Palms/Cheviot Hills'},'90035':{lat:34.0520,lon:-118.3800,name:'Beverly-Fairfax'},
'90036':{lat:34.0700,lon:-118.3510,name:'Fairfax'},'90037':{lat:33.9950,lon:-118.2860,name:'Vermont-Slauson'},'90038':{lat:34.0880,lon:-118.3220,name:'Hollywood East'},'90039':{lat:34.1120,lon:-118.2610,name:'Silverlake'},
'90041':{lat:34.1370,lon:-118.2090,name:'Eagle Rock'},'90042':{lat:34.1140,lon:-118.1920,name:'Highland Park'},'90043':{lat:33.9930,lon:-118.3350,name:'View Park/Windsor Hills'},'90044':{lat:33.9560,lon:-118.2940,name:'Athens'},
'90045':{lat:33.9610,lon:-118.3960,name:'Westchester'},'90046':{lat:34.1110,lon:-118.3700,name:'Hollywood Hills'},'90047':{lat:33.9570,lon:-118.3120,name:'Gramercy Park'},'90048':{lat:34.0750,lon:-118.3720,name:'Beverly Grove'},
'90049':{lat:34.0690,lon:-118.4730,name:'Brentwood'},'90056':{lat:33.9850,lon:-118.3700,name:'Ladera Heights'},'90057':{lat:34.0590,lon:-118.2740,name:'Pico-Union'},'90058':{lat:33.9960,lon:-118.2130,name:'Vernon'},
'90059':{lat:33.9280,lon:-118.2410,name:'Willowbrook'},'90061':{lat:33.9210,lon:-118.2740,name:'Gardena North'},'90062':{lat:34.0100,lon:-118.3070,name:'Vermont Knolls'},'90063':{lat:34.0440,lon:-118.1830,name:'East LA South'},
'90064':{lat:34.0370,lon:-118.4260,name:'Rancho Park'},'90065':{lat:34.1010,lon:-118.2290,name:'Cypress Park/Glassell'},'90066':{lat:34.0000,lon:-118.4310,name:'Mar Vista'},'90067':{lat:34.0570,lon:-118.4140,name:'Century City'},
'90068':{lat:34.1190,lon:-118.3350,name:'Hollywood Hills'},'90069':{lat:34.0900,lon:-118.3770,name:'West Hollywood'},'90071':{lat:34.0520,lon:-118.2550,name:'Bunker Hill'},'90077':{lat:34.0830,lon:-118.4490,name:'Bel Air'},
'90089':{lat:34.0220,lon:-118.2850,name:'USC'},'90094':{lat:33.9740,lon:-118.4220,name:'Playa Vista'},'90095':{lat:34.0690,lon:-118.4440,name:'UCLA'},
'90201':{lat:33.9680,lon:-118.1870,name:'Bell'},'90210':{lat:34.0900,lon:-118.4070,name:'Beverly Hills'},'90211':{lat:34.0640,lon:-118.3810,name:'Beverly Hills South'},
'90212':{lat:34.0580,lon:-118.3990,name:'Beverly Hills SW'},'90220':{lat:33.8720,lon:-118.2420,name:'Compton'},'90221':{lat:33.8760,lon:-118.2200,name:'Compton East'},
'90230':{lat:33.9990,lon:-118.3920,name:'Culver City'},'90232':{lat:34.0130,lon:-118.3920,name:'Culver City North'},
'90240':{lat:33.9450,lon:-118.1320,name:'Downey'},'90241':{lat:33.9380,lon:-118.1480,name:'Downey South'},'90242':{lat:33.9220,lon:-118.1430,name:'Downey SE'},
'90245':{lat:33.9160,lon:-118.3930,name:'El Segundo'},'90247':{lat:33.8900,lon:-118.3070,name:'Gardena'},'90248':{lat:33.8710,lon:-118.2980,name:'Gardena South'},
'90249':{lat:33.8970,lon:-118.3240,name:'Gardena West'},'90250':{lat:33.8610,lon:-118.3520,name:'Hawthorne'},'90254':{lat:33.8620,lon:-118.3950,name:'Hermosa Beach'},
'90255':{lat:33.9740,lon:-118.2070,name:'Huntington Park'},'90260':{lat:33.8870,lon:-118.3520,name:'Lawndale'},'90262':{lat:33.9400,lon:-118.2050,name:'Lynwood'},
'90265':{lat:34.0350,lon:-118.6830,name:'Malibu'},'90266':{lat:33.8830,lon:-118.4020,name:'Manhattan Beach'},'90270':{lat:33.9830,lon:-118.1870,name:'Maywood'},
'90272':{lat:34.0440,lon:-118.5260,name:'Pacific Palisades'},'90274':{lat:33.7650,lon:-118.3800,name:'Palos Verdes'},
'90275':{lat:33.7660,lon:-118.3560,name:'Rancho Palos Verdes'},'90277':{lat:33.8360,lon:-118.3910,name:'Redondo Beach'},'90278':{lat:33.8620,lon:-118.3690,name:'Redondo Beach North'},
'90280':{lat:33.9470,lon:-118.2170,name:'South Gate'},'90291':{lat:33.9920,lon:-118.4640,name:'Venice'},'90292':{lat:33.9770,lon:-118.4540,name:'Marina del Rey'},
'90293':{lat:33.9590,lon:-118.4530,name:'Playa del Rey'},'90301':{lat:33.9500,lon:-118.3510,name:'Inglewood'},'90302':{lat:33.9610,lon:-118.3540,name:'Inglewood North'},
'90303':{lat:33.9370,lon:-118.3400,name:'Inglewood South'},'90304':{lat:33.9310,lon:-118.3740,name:'Lennox'},'90305':{lat:33.9550,lon:-118.3660,name:'Inglewood West'},
'91040':{lat:34.2370,lon:-118.2810,name:'Sunland-Tujunga'},'91042':{lat:34.2280,lon:-118.2430,name:'Tujunga'},
'91101':{lat:34.1480,lon:-118.1440,name:'Pasadena'},'91103':{lat:34.1660,lon:-118.1620,name:'Pasadena NW'},'91104':{lat:34.1680,lon:-118.1280,name:'Pasadena NE'},
'91105':{lat:34.1370,lon:-118.1640,name:'South Pasadena/Pasadena'},'91106':{lat:34.1370,lon:-118.1210,name:'Pasadena SE'},'91107':{lat:34.1540,lon:-118.0870,name:'Pasadena East'},
'91201':{lat:34.1720,lon:-118.2990,name:'Glendale'},'91202':{lat:34.1640,lon:-118.2710,name:'Glendale South'},'91203':{lat:34.1510,lon:-118.2640,name:'Glendale Downtown'},
'91204':{lat:34.1430,lon:-118.2600,name:'Glendale SE'},'91205':{lat:34.1390,lon:-118.2420,name:'Glendale East'},'91206':{lat:34.1610,lon:-118.2320,name:'Glendale NE'},
'91301':{lat:34.1690,lon:-118.7540,name:'Agoura Hills'},'91302':{lat:34.1480,lon:-118.6620,name:'Calabasas'},
'91303':{lat:34.2050,lon:-118.6010,name:'Canoga Park'},'91304':{lat:34.2310,lon:-118.6110,name:'Canoga Park North'},
'91306':{lat:34.2240,lon:-118.5630,name:'Winnetka'},'91307':{lat:34.2070,lon:-118.6560,name:'West Hills'},
'91311':{lat:34.2540,lon:-118.5680,name:'Chatsworth'},'91316':{lat:34.1600,lon:-118.5190,name:'Encino'},
'91324':{lat:34.2400,lon:-118.5260,name:'Northridge'},'91325':{lat:34.2290,lon:-118.5130,name:'Northridge South'},
'91326':{lat:34.2810,lon:-118.5560,name:'Porter Ranch'},'91331':{lat:34.2470,lon:-118.4070,name:'Pacoima'},
'91335':{lat:34.1950,lon:-118.5380,name:'Reseda'},'91340':{lat:34.2680,lon:-118.4340,name:'San Fernando'},
'91342':{lat:34.2910,lon:-118.4460,name:'Sylmar'},'91343':{lat:34.2360,lon:-118.4530,name:'North Hills'},
'91344':{lat:34.2770,lon:-118.4960,name:'Granada Hills'},'91345':{lat:34.2570,lon:-118.4640,name:'Mission Hills'},
'91350':{lat:34.3860,lon:-118.5380,name:'Santa Clarita'},'91351':{lat:34.3870,lon:-118.5690,name:'Canyon Country'},
'91352':{lat:34.2030,lon:-118.3520,name:'Sun Valley'},'91356':{lat:34.1720,lon:-118.5520,name:'Tarzana'},
'91364':{lat:34.1560,lon:-118.5660,name:'Woodland Hills'},'91367':{lat:34.1760,lon:-118.5910,name:'Woodland Hills West'},
'91401':{lat:34.1830,lon:-118.4490,name:'Van Nuys'},'91402':{lat:34.2130,lon:-118.4400,name:'Panorama City'},
'91403':{lat:34.1560,lon:-118.4520,name:'Sherman Oaks'},'91405':{lat:34.2010,lon:-118.4630,name:'Van Nuys West'},
'91406':{lat:34.2030,lon:-118.4900,name:'Van Nuys NW'},'91411':{lat:34.1890,lon:-118.4660,name:'Sherman Oaks North'},
'91423':{lat:34.1490,lon:-118.4240,name:'Sherman Oaks East'},'91436':{lat:34.1540,lon:-118.4700,name:'Encino East'},
'91501':{lat:34.1950,lon:-118.3240,name:'Burbank'},'91502':{lat:34.1830,lon:-118.3110,name:'Burbank South'},
'91504':{lat:34.2060,lon:-118.3020,name:'Burbank North'},'91505':{lat:34.1980,lon:-118.3380,name:'Burbank West'},
'91601':{lat:34.1710,lon:-118.3800,name:'North Hollywood'},'91602':{lat:34.1510,lon:-118.3730,name:'North Hollywood South'},
'91604':{lat:34.1450,lon:-118.3960,name:'Studio City'},'91605':{lat:34.2050,lon:-118.4060,name:'North Hollywood East'},
'91606':{lat:34.1870,lon:-118.3950,name:'North Hollywood Central'},'91607':{lat:34.1650,lon:-118.4090,name:'Valley Village'},
};

// SB 79 Transit-Oriented Development tier definitions (effective July 1, 2026)
const SB79_TIERS = {
    1: { label: 'Tier 1 (Heavy Rail)', height: 95, density: 160, far: 4.5 },
    2: { label: 'Tier 2 (Light Rail/BRT)', height: 85, density: 140, far: 4.0 },
};
const SB79_ZONES = {
    adjacent: { maxDist: 0.038, label: '200ft (Adjacent)', parking: 0, heightMult: 1.0 },
    inner:    { maxDist: 0.25,  label: '1/4 Mile (Inner)',  parking: 0, heightMult: 1.0 },
    outer:    { maxDist: 0.50,  label: '1/2 Mile (Outer)',  parking: 0.5, heightMult: 0.68 },
};

// Line display colors for map markers
const LINE_COLORS = {
    red: '#e53e3e', purple: '#805ad5', blue_a: '#3182ce', expo_e: '#d69e2e',
    gold_l: '#b7791f', green_c: '#38a169', k_line: '#00bcd4', connector: '#ed64a6',
    metrolink: '#e53e3e',
};
const LINE_LABELS = {
    red: 'Red/B Line', purple: 'Purple/D Line', blue_a: 'Blue/A Line', expo_e: 'Expo/E Line',
    gold_l: 'Gold/L Line', green_c: 'Green/C Line', k_line: 'K Line (Crenshaw)', connector: 'Regional Connector',
    metrolink: 'Metrolink',
};

// Major LA arterials for street detection
const MAJOR_ARTERIALS = [
    'wilshire', 'sunset', 'santa monica', 'hollywood', 'venice', 'olympic',
    'pico', 'la cienega', 'figueroa', 'vermont', 'western', 'crenshaw',
    'sepulveda', 'van nuys', 'ventura', 'victory', 'sherman way', 'lincoln',
    'pacific coast', 'pch', 'florence', 'manchester', 'century', 'imperial',
    'alameda', 'broadway', 'spring', 'main st', 'san fernando', 'glendale',
    'beverly', 'la brea', 'fairfax', 'robertson', 'melrose', 'highland',
    'cahuenga', 'vine', 'western ave', 'normandie', 'hoover', 'alvarado',
    'temple', 'cesar chavez', 'first', '1st st', '3rd st', '6th st',
    'whittier', 'washington', 'jefferson', 'exposition', 'mlk',
    'martin luther king', 'slauson', 'gage', 'rosecrans', 'artesia',
    'el segundo', 'hawthorne', 'inglewood', 'prairie', 'aviation',
    'centinela', 'overland', 'motor', 'sawtelle', 'barrington',
    'balboa', 'reseda', 'tampa', 'winnetka', 'de soto', 'topanga',
    'canoga', 'fallbrook', 'laurel canyon', 'coldwater canyon',
    'lankershim', 'vineland', 'tujunga', 'foothill', 'glenoaks',
    'brand', 'colorado', 'huntington', 'atlantic', 'soto',
];

// Haversine distance in miles
function haversine(lat1, lon1, lat2, lon2) {
    const R = 3958.8; // Earth radius in miles
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat / 2) ** 2 +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon / 2) ** 2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

// Detect nearest neighborhood from coordinates + Nominatim address details
function detectNeighborhood(lat, lon, addressDetails) {
    // Try Nominatim address fields (neighbourhood is most specific, then suburb)
    if (addressDetails) {
        const fields = [
            addressDetails.neighbourhood,
            addressDetails.suburb,
            addressDetails.city_district,
            addressDetails.quarter,
        ];
        for (const field of fields) {
            if (field) {
                const key = field.toLowerCase().trim();
                if (SUBURB_TO_NEIGHBORHOOD[key]) {
                    return SUBURB_TO_NEIGHBORHOOD[key];
                }
            }
        }
    }
    // Fall back to centroid distance
    let best = 'westside';
    let bestDist = Infinity;
    for (const [key, c] of Object.entries(NEIGHBORHOOD_CENTROIDS)) {
        const d = haversine(lat, lon, c.lat, c.lon);
        if (d < bestDist) { bestDist = d; best = key; }
    }
    return best;
}

// Detect transit proximity from coordinates
function detectTransitProximity(lat, lon) {
    let minDist = Infinity;
    for (const s of METRO_STATIONS) {
        const d = haversine(lat, lon, s.lat, s.lon);
        if (d < minDist) minDist = d;
    }
    if (minDist <= 0.25) return 'adjacent';
    if (minDist <= 0.5) return 'near';
    if (minDist <= 1.0) return 'moderate';
    return 'far';
}

// Detect SB 79 eligibility from coordinates
function detectSB79Eligibility(lat, lon) {
    let nearest = null;
    let nearestDist = Infinity;
    let nearestIdx = -1;
    for (let i = 0; i < METRO_STATIONS.length; i++) {
        const s = METRO_STATIONS[i];
        const d = haversine(lat, lon, s.lat, s.lon);
        if (d < nearestDist) {
            nearestDist = d;
            nearest = s;
            nearestIdx = i;
        }
    }
    if (!nearest || nearestDist > 0.5) {
        return { eligible: false, station: nearest, distMiles: nearestDist, nearestIdx };
    }
    const tier = nearest.tier;
    const tierData = SB79_TIERS[tier];
    let zone, zoneKey;
    if (nearestDist <= SB79_ZONES.adjacent.maxDist) { zone = SB79_ZONES.adjacent; zoneKey = 'adjacent'; }
    else if (nearestDist <= SB79_ZONES.inner.maxDist) { zone = SB79_ZONES.inner; zoneKey = 'inner'; }
    else { zone = SB79_ZONES.outer; zoneKey = 'outer'; }

    const height = Math.round(tierData.height * zone.heightMult);
    const far = parseFloat((tierData.far * zone.heightMult).toFixed(2));
    const density = Math.round(tierData.density * zone.heightMult);
    return {
        eligible: true,
        station: nearest,
        nearestIdx,
        tier,
        tierLabel: tierData.label,
        zone: zoneKey,
        zoneLabel: zone.label,
        distMiles: nearestDist,
        allowances: { height, density, far, parking: zone.parking },
    };
}

// Detect if address is on a major arterial
function detectArterial(addressString, addressDetails) {
    // Try Nominatim road field first (most accurate â€” avoids matching neighborhood names)
    if (addressDetails && addressDetails.road) {
        const road = addressDetails.road.toLowerCase();
        for (const art of MAJOR_ARTERIALS) {
            if (road.includes(art)) return 'major';
        }
        if (/\bblvd\b|\bboulevard\b|\bave\b|\bavenue\b/.test(road)) return 'secondary';
        return 'residential';
    }
    // Fall back to full address string
    const lower = addressString.toLowerCase();
    for (const art of MAJOR_ARTERIALS) {
        if (lower.includes(art)) return 'major';
    }
    if (/\bblvd\b|\bboulevard\b|\bave\b|\bavenue\b/.test(lower)) return 'secondary';
    return 'residential';
}

// Detect site condition from Nominatim result
// For HBU analysis, any existing structure implies redevelopment â†’ demolition
function detectSiteCondition(osmClass, osmType) {
    // Named structures (buildings, amenities, commercial, etc.)
    const structureClasses = ['building', 'amenity', 'shop', 'office', 'tourism', 'leisure', 'craft', 'club', 'healthcare'];
    if (structureClasses.includes(osmClass)) return 'demolition';
    // Address resolving to a house/building â†’ existing structure for HBU redevelopment
    if (osmClass === 'place' && ['house', 'building', 'apartments', 'residential'].includes(osmType)) return 'demolition';
    // Other place types (most LA parcels have structures)
    if (osmClass === 'place') return 'demolition';
    return 'vacant';
}

// Estimate zoning when ZIMAS is blocked (fallback heuristic)
function estimateZoningFallback(addressString, addressDetails, neighborhood) {
    const lower = (addressString || '').toLowerCase();
    const road = (addressDetails && addressDetails.road) ? addressDetails.road.toLowerCase() : '';

    // Check if on a major commercial corridor
    const commercialCorridors = [
        'wilshire', 'sunset blvd', 'santa monica blvd', 'hollywood blvd', 'venice blvd',
        'olympic', 'pico blvd', 'beverly blvd', 'melrose ave', '3rd st', 'la brea',
        'la cienega', 'fairfax ave', 'robertson', 'highland ave', 'western ave',
        'vermont ave', 'figueroa', 'broadway', 'spring st', 'main st',
        'ventura blvd', 'lankershim', 'sepulveda blvd', 'van nuys blvd',
        'colorado blvd', 'brand blvd', 'glendale ave',
    ];
    const isCommercialCorridor = commercialCorridors.some(c => road.includes(c) || lower.includes(c));

    // Industrial areas
    const industrialAreas = ['arts district', 'vernon', 'commerce', 'boyle heights industrial'];
    const isIndustrial = industrialAreas.some(a => lower.includes(a));

    // DTLA is mostly commercial/mixed
    if (neighborhood === 'dtla') return isIndustrial ? 'M1' : 'C2';

    // Commercial corridors
    if (isCommercialCorridor) return 'C2';

    // Check for apartment-style addresses (Nominatim type)
    if (addressDetails && addressDetails.type === 'apartments') return 'R3';

    // Residential streets â€” check street suffix patterns
    const residentialSuffixes = /\b(ave|avenue|st|street|dr|drive|pl|place|way|ln|lane|ct|court|rd|road|blvd|ter|terrace|cir|circle)\b/i;
    const isResidential = residentialSuffixes.test(road) && !isCommercialCorridor;

    // Residential neighborhoods default to R1
    const residentialHoods = ['beverly', 'westside', 'santamonica', 'valleyeast', 'valleywest',
        'silverlake', 'highland', 'venice', 'culver', 'southbay', 'harbor'];
    if (residentialHoods.includes(neighborhood) && isResidential) return 'R1';

    // Dense residential neighborhoods
    const denseHoods = ['koreatown', 'hollywood', 'midcity', 'exposition'];
    if (denseHoods.includes(neighborhood) && isResidential) return 'R3';

    // South LA residential
    if (['southla', 'boyleheights'].includes(neighborhood) && isResidential) return 'R1';

    // Default: R1 for residential streets, C2 for commercial
    if (isResidential) return 'R1';
    return null; // Can't determine â€” let user select
}

// Map ZIMAS zoning code to our dropdown values
function mapZoningCode(rawZone) {
    if (!rawZone) return null;
    // ZIMAS returns codes like "C2-1VL", "[Q]R3-1XL", "M1-1", "R1-1-HCR" etc.
    // Strip Q conditions, D limitations, and supplemental use districts
    let z = rawZone.toUpperCase().replace(/\[.*?\]/g, '').trim();
    // Extract the base zone (letters + optional digits before the dash-height suffix)
    const match = z.match(/^(R[1-5]|C[1-5]|C1\.5|CM|M[1-3]|PF|OS|LAX)/);
    if (match) return match[1];
    // TOD areas are usually identified via overlay, not base zone
    return null;
}

// === API CALLS ===

// Geocode via OpenStreetMap Nominatim (CORS-friendly)
async function geocodeAddress(address) {
    // Append Los Angeles CA if not already present to improve results
    let query = address;
    if (!/los\s*angeles/i.test(query) && !/\bLA\b/.test(query)) {
        query += ', Los Angeles, CA';
    }
    const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&addressdetails=1&limit=1&countrycodes=us`;
    const resp = await fetch(url, {
        headers: { 'Accept': 'application/json' }
    });
    if (!resp.ok) throw new Error('Geocoding service unavailable');
    const data = await resp.json();
    if (!data || data.length === 0) throw new Error('Address not found. Try including city and zip code.');
    const m = data[0];
    return {
        lat: parseFloat(m.lat),
        lon: parseFloat(m.lon),
        matched: m.display_name,
        address: m.address || {},
        osmClass: m.class || '',
        osmType: m.type || '',
    };
}

// Query ZIMAS zoning layer
async function fetchZoning(lat, lon) {
    try {
        // ZIMAS uses CA State Plane Zone 5 (feet) but we can pass WGS84 with inSR=4326
        const url = `https://zimas.lacity.org/arcgis/rest/services/zma/zoning/MapServer/1102/query?` +
            `geometry=${lon},${lat}&geometryType=esriGeometryPoint&inSR=4326` +
            `&spatialRel=esriSpatialRelIntersects&outFields=ZONE_CMPLT&returnGeometry=false&f=json`;
        const resp = await fetch(url);
        if (!resp.ok) throw new Error('ZIMAS unavailable');
        const data = await resp.json();
        if (data.features && data.features.length > 0) {
            const raw = data.features[0].attributes.ZONE_CMPLT || data.features[0].attributes.zone_cmplt;
            return { raw, mapped: mapZoningCode(raw) };
        }
        return null;
    } catch (e) {
        console.warn('ZIMAS zoning query failed (may be CORS):', e);
        return { error: 'cors' };
    }
}

// Query LA County parcel layer for lot size
async function fetchParcelInfo(lat, lon) {
    try {
        const url = `https://public.gis.lacounty.gov/public/rest/services/LACounty_Cache/LACounty_Parcel/MapServer/0/query?` +
            `geometry=${lon},${lat}&geometryType=esriGeometryPoint&inSR=4326` +
            `&spatialRel=esriSpatialRelIntersects&outFields=*&returnGeometry=true&f=json`;
        const resp = await fetch(url);
        if (!resp.ok) throw new Error('Parcel service unavailable');
        const data = await resp.json();
        if (data.features && data.features.length > 0) {
            const attrs = data.features[0].attributes;
            // Try different field names for area
            let area = attrs['Shape.STArea()'] || attrs['Shape__Area'] || attrs['ShapeSTArea'] || attrs['SHAPE.STArea()'] || null;
            // If geometry is returned, try to compute from rings
            if (!area && data.features[0].geometry && data.features[0].geometry.rings) {
                area = computePolygonArea(data.features[0].geometry.rings, data.spatialReference);
            }
            return { area, attrs };
        }
        return null;
    } catch (e) {
        console.warn('Parcel query failed (may be CORS):', e);
        return { error: 'cors' };
    }
}

// Compute polygon area from rings (in sq ft if Web Mercator, approximate otherwise)
function computePolygonArea(rings, sr) {
    // Shoelace formula â€” gives area in the spatial reference units
    let totalArea = 0;
    for (const ring of rings) {
        let a = 0;
        for (let i = 0; i < ring.length - 1; i++) {
            a += ring[i][0] * ring[i + 1][1] - ring[i + 1][0] * ring[i][1];
        }
        totalArea += Math.abs(a) / 2;
    }
    // If Web Mercator (meters), convert to sq ft
    if (sr && (sr.wkid === 102100 || sr.wkid === 3857)) {
        // At LA latitude (~34Â°), 1 Web Mercator meter â‰ˆ 0.829 real meters
        const latRad = 34.05 * Math.PI / 180;
        const scaleFactor = Math.cos(latRad);
        const realSqMeters = totalArea * scaleFactor * scaleFactor;
        return Math.round(realSqMeters * 10.7639); // sq meters to sq ft
    }
    // If State Plane feet
    if (sr && (sr.wkid === 2229 || sr.wkid === 102645)) {
        return Math.round(totalArea);
    }
    // Fallback: assume sq ft
    return Math.round(totalArea);
}

// Estimate frontage from parcel area (rough: assume ~2:1 lot ratio)
function estimateFrontage(areaSqFt) {
    if (!areaSqFt || areaSqFt <= 0) return 80;
    // Assume lot depth â‰ˆ 2Ã— frontage â†’ area = frontage Ã— (2 Ã— frontage) = 2fÂ²
    const f = Math.sqrt(areaSqFt / 2);
    return Math.round(Math.max(20, Math.min(500, f)));
}

// Lookup status helpers
function setStatus(html) {
    document.getElementById('lookupStatus').innerHTML = html;
}

function addStatus(html) {
    document.getElementById('lookupStatus').innerHTML += html;
}

// Mark a field as autofilled
function markAutofill(fieldId) {
    const el = document.getElementById('field-' + fieldId);
    if (el) el.classList.add('autofilled');
}

// Clear all autofill markers
function clearAutofill() {
    document.querySelectorAll('.field.autofilled').forEach(el => el.classList.remove('autofilled'));
    document.getElementById('autofillNotice').classList.remove('visible');
}

// === MAIN LOOKUP ORCHESTRATOR ===

async function lookupAddress() {
    const address = document.getElementById('addressInput').value.trim();
    if (!address) {
        setStatus('<span class="err">Please enter an address.</span>');
        return;
    }

    const btn = document.getElementById('btnLookup');
    btn.disabled = true;
    btn.textContent = 'Looking up...';
    clearAutofill();
    setStatus('<span class="loading">Geocoding address...</span>');

    let coords;
    try {
        coords = await geocodeAddress(address);
        setStatus(`<span class="status-item ok">Matched: ${coords.matched}</span>`);
    } catch (e) {
        setStatus(`<span class="err">${e.message}</span>`);
        btn.disabled = false;
        btn.textContent = 'Look Up';
        return;
    }

    // Store coordinates globally for map & SB 79 detection
    window.lastGeocode = { lat: coords.lat, lon: coords.lon };

    let filledCount = 0;

    // Run zoning + parcel queries in parallel
    addStatus('<br><span class="loading">Querying zoning &amp; parcel data...</span>');

    const [zoningResult, parcelResult] = await Promise.all([
        fetchZoning(coords.lat, coords.lon),
        fetchParcelInfo(coords.lat, coords.lon),
    ]);

    // Build status summary
    let statusParts = [`<span class="status-item ok">Matched: ${coords.matched}</span>`];

    // Apply zoning
    if (zoningResult && zoningResult.error === 'cors') {
        // Estimate zoning from street type and neighborhood when ZIMAS blocked
        const estZone = estimateZoningFallback(coords.matched || address, coords.address, hood);
        if (estZone) {
            document.getElementById('zoning').value = estZone;
            markAutofill('zoning');
            filledCount++;
            statusParts.push(`<span class="status-item warn">Zoning: ZIMAS blocked â€” estimated ${estZone} from location (verify manually)</span>`);
        } else {
            statusParts.push(`<span class="status-item warn">Zoning: ZIMAS blocked by browser â€” select manually</span>`);
        }
    } else if (zoningResult && zoningResult.mapped) {
        const sel = document.getElementById('zoning');
        const opt = sel.querySelector(`option[value="${zoningResult.mapped}"]`);
        if (opt) {
            sel.value = zoningResult.mapped;
            markAutofill('zoning');
            filledCount++;
            statusParts.push(`<span class="status-item ok">Zoning: ${zoningResult.raw}</span>`);
        } else {
            statusParts.push(`<span class="status-item warn">Zoning "${zoningResult.raw}" â€” not in dropdown, please select manually</span>`);
        }
    } else if (zoningResult && zoningResult.raw) {
        statusParts.push(`<span class="status-item warn">Zoning "${zoningResult.raw}" â€” please select closest match</span>`);
    } else {
        // Also try fallback estimation when ZIMAS returns nothing
        const estZone = estimateZoningFallback(coords.matched || address, coords.address, hood);
        if (estZone) {
            document.getElementById('zoning').value = estZone;
            markAutofill('zoning');
            filledCount++;
            statusParts.push(`<span class="status-item warn">Zoning: estimated ${estZone} from location (verify manually)</span>`);
        } else {
            statusParts.push(`<span class="status-item warn">Zoning: could not retrieve â€” please select manually</span>`);
        }
    }

    // Apply parcel size
    if (parcelResult && parcelResult.error === 'cors') {
        statusParts.push(`<span class="status-item warn">Parcel size: County GIS blocked by browser â€” enter manually</span>`);
    } else if (parcelResult && parcelResult.area && parcelResult.area > 0) {
        document.getElementById('parcelSize').value = Math.round(parcelResult.area);
        markAutofill('parcelSize');
        filledCount++;
        statusParts.push(`<span class="status-item ok">Lot: ${Math.round(parcelResult.area).toLocaleString()} SF</span>`);

        // Estimate frontage
        const est = estimateFrontage(parcelResult.area);
        document.getElementById('frontage').value = est;
        markAutofill('frontage');
        filledCount++;

        // Store assessed values for one-pager (Prop 13 assessed, not market)
        if (parcelResult.attrs) {
            const assessedLand = parseFloat(parcelResult.attrs.Roll_LandValue) || 0;
            const assessedImp = parseFloat(parcelResult.attrs.Roll_ImpValue) || 0;
            if (window.lastGeocode) {
                window.lastGeocode.assessedLand = assessedLand;
                window.lastGeocode.assessedImp = assessedImp;
                window.lastGeocode.assessedTotal = assessedLand + assessedImp;
            }
        }
    } else {
        statusParts.push(`<span class="status-item warn">Parcel size: could not retrieve â€” enter manually</span>`);
    }

    // Detect neighborhood (using Nominatim address details when available)
    const hood = detectNeighborhood(coords.lat, coords.lon, coords.address);
    document.getElementById('neighborhood').value = hood;
    markAutofill('neighborhood');
    filledCount++;

    // Detect transit
    const transit = detectTransitProximity(coords.lat, coords.lon);
    document.getElementById('transit').value = transit;
    markAutofill('transit');
    filledCount++;

    // Detect arterial (using Nominatim road field when available)
    const arterial = detectArterial(coords.matched || address, coords.address);
    document.getElementById('arterial').value = arterial;
    markAutofill('arterial');
    filledCount++;

    // Detect site condition from Nominatim class/type
    const siteCondition = detectSiteCondition(coords.osmClass, coords.osmType);
    document.getElementById('siteCondition').value = siteCondition;
    markAutofill('siteCondition');
    filledCount++;

    // Show status
    setStatus(statusParts.join('<br>'));

    // Show autofill notice
    if (filledCount > 0) {
        document.getElementById('autofillNotice').classList.add('visible');
    }

    btn.disabled = false;
    btn.textContent = 'Look Up';
}


// ============================================================
//  LA-Specific Data & Scoring Engine
// ============================================================

const LAND_USES = [
    { id: 'sfr',            name: 'Single-Family Residential',      icon: 'ðŸ¡' },
    { id: 'duplex',         name: 'Duplex / Two-Unit',              icon: 'ðŸ˜ï¸' },
    { id: 'multifamily_low', name: 'Multi-Family (Low-Rise)',       icon: 'ðŸ¢' },
    { id: 'multifamily_mid', name: 'Multi-Family (Mid-Rise)',       icon: 'ðŸ™ï¸' },
    { id: 'multifamily_high', name: 'Multi-Family (High-Rise)',     icon: 'ðŸ—ï¸' },
    { id: 'mixeduse',       name: 'Mixed-Use (Retail + Residential)', icon: 'ðŸ¬' },
    { id: 'retail',         name: 'Retail / Restaurant',            icon: 'ðŸ›ï¸' },
    { id: 'office',         name: 'Office / Professional',          icon: 'ðŸ›ï¸' },
    { id: 'medical',        name: 'Medical Office',                 icon: 'ðŸ¥' },
    { id: 'hotel',          name: 'Hotel / Hospitality',            icon: 'ðŸ¨' },
    { id: 'industrial',     name: 'Industrial / Warehouse',         icon: 'ðŸ­' },
    { id: 'selfstorage',    name: 'Self-Storage',                   icon: 'ðŸ“¦' },
    { id: 'senior',         name: 'Senior Living / Assisted',       icon: 'ðŸ§“' },
    { id: 'parking',        name: 'Parking Structure / Lot',        icon: 'ðŸ…¿ï¸' },
    { id: 'creative',       name: 'Creative Office / Flex',         icon: 'ðŸŽ¨' },
    { id: 'adu',            name: 'ADU / Small-Lot Subdivision',    icon: 'ðŸ ' },
];

// Zoning â†’ which uses are legally permissible
// 0 = not permitted, 0.5 = conditional/CUP required, 1.0 = by-right
const ZONING_MATRIX = {
    'R1':  { sfr:1, duplex:0, multifamily_low:0, multifamily_mid:0, multifamily_high:0, mixeduse:0, retail:0, office:0, medical:0, hotel:0, industrial:0, selfstorage:0, senior:0.5, parking:0, creative:0, adu:1 },
    'R2':  { sfr:1, duplex:1, multifamily_low:0.5, multifamily_mid:0, multifamily_high:0, mixeduse:0, retail:0, office:0, medical:0, hotel:0, industrial:0, selfstorage:0, senior:0.5, parking:0, creative:0, adu:1 },
    'R3':  { sfr:1, duplex:1, multifamily_low:1, multifamily_mid:0.5, multifamily_high:0, mixeduse:0, retail:0, office:0, medical:0, hotel:0, industrial:0, selfstorage:0, senior:0.5, parking:0.5, creative:0, adu:1 },
    'R4':  { sfr:0.5, duplex:1, multifamily_low:1, multifamily_mid:1, multifamily_high:0.5, mixeduse:0, retail:0, office:0, medical:0, hotel:0, industrial:0, selfstorage:0, senior:1, parking:0.5, creative:0, adu:0.5 },
    'R5':  { sfr:0, duplex:0.5, multifamily_low:1, multifamily_mid:1, multifamily_high:1, mixeduse:0, retail:0, office:0, medical:0, hotel:0.5, industrial:0, selfstorage:0, senior:1, parking:0.5, creative:0, adu:0 },
    'C1':  { sfr:0, duplex:0, multifamily_low:0.5, multifamily_mid:0, multifamily_high:0, mixeduse:0.5, retail:1, office:1, medical:1, hotel:0, industrial:0, selfstorage:0, senior:0, parking:1, creative:0.5, adu:0 },
    'C1.5':{ sfr:0, duplex:0, multifamily_low:0.5, multifamily_mid:0.5, multifamily_high:0, mixeduse:1, retail:1, office:1, medical:1, hotel:0.5, industrial:0, selfstorage:0, senior:0.5, parking:1, creative:0.5, adu:0 },
    'C2':  { sfr:0, duplex:0, multifamily_low:1, multifamily_mid:1, multifamily_high:0.5, mixeduse:1, retail:1, office:1, medical:1, hotel:1, industrial:0, selfstorage:0.5, senior:1, parking:1, creative:1, adu:0 },
    'C4':  { sfr:0, duplex:0, multifamily_low:0.5, multifamily_mid:1, multifamily_high:0.5, mixeduse:1, retail:1, office:1, medical:1, hotel:1, industrial:0, selfstorage:0.5, senior:0.5, parking:1, creative:1, adu:0 },
    'C5':  { sfr:0, duplex:0, multifamily_low:0, multifamily_mid:0.5, multifamily_high:0, mixeduse:0.5, retail:1, office:1, medical:0.5, hotel:0.5, industrial:0, selfstorage:0.5, senior:0, parking:1, creative:0.5, adu:0 },
    'CM':  { sfr:0, duplex:0, multifamily_low:0, multifamily_mid:0, multifamily_high:0, mixeduse:0.5, retail:0.5, office:1, medical:0.5, hotel:0, industrial:0.5, selfstorage:1, senior:0, parking:1, creative:1, adu:0 },
    'M1':  { sfr:0, duplex:0, multifamily_low:0, multifamily_mid:0, multifamily_high:0, mixeduse:0, retail:0.5, office:0.5, medical:0, hotel:0, industrial:1, selfstorage:1, senior:0, parking:1, creative:1, adu:0 },
    'M2':  { sfr:0, duplex:0, multifamily_low:0, multifamily_mid:0, multifamily_high:0, mixeduse:0, retail:0, office:0, medical:0, hotel:0, industrial:1, selfstorage:1, senior:0, parking:1, creative:0.5, adu:0 },
    'M3':  { sfr:0, duplex:0, multifamily_low:0, multifamily_mid:0, multifamily_high:0, mixeduse:0, retail:0, office:0, medical:0, hotel:0, industrial:1, selfstorage:0.5, senior:0, parking:1, creative:0, adu:0 },
    'PF':  { sfr:0, duplex:0, multifamily_low:0, multifamily_mid:0, multifamily_high:0, mixeduse:0, retail:0, office:0.5, medical:0.5, hotel:0, industrial:0, selfstorage:0, senior:0.5, parking:0.5, creative:0, adu:0 },
    'OS':  { sfr:0, duplex:0, multifamily_low:0, multifamily_mid:0, multifamily_high:0, mixeduse:0, retail:0, office:0, medical:0, hotel:0, industrial:0, selfstorage:0, senior:0, parking:0, creative:0, adu:0 },
    'LAX': { sfr:0, duplex:0, multifamily_low:0, multifamily_mid:0, multifamily_high:0, mixeduse:0, retail:0.5, office:0.5, medical:0, hotel:0.5, industrial:0.5, selfstorage:0.5, senior:0, parking:1, creative:0, adu:0 },
    'TOD': { sfr:0, duplex:0.5, multifamily_low:1, multifamily_mid:1, multifamily_high:1, mixeduse:1, retail:1, office:1, medical:1, hotel:1, industrial:0, selfstorage:0, senior:1, parking:0.5, creative:1, adu:0.5 },
};

// Neighborhood market demand multipliers (1.0 = average)
const NEIGHBORHOOD_DEMAND = {
    dtla:         { sfr:0.3, duplex:0.4, multifamily_low:1.1, multifamily_mid:1.3, multifamily_high:1.4, mixeduse:1.4, retail:1.2, office:1.3, medical:0.7, hotel:1.3, industrial:0.5, selfstorage:0.7, senior:0.6, parking:1.3, creative:1.4, adu:0.3 },
    hollywood:    { sfr:0.5, duplex:0.7, multifamily_low:1.2, multifamily_mid:1.3, multifamily_high:1.1, mixeduse:1.3, retail:1.2, office:1.0, medical:0.8, hotel:1.2, industrial:0.3, selfstorage:0.7, senior:0.5, parking:1.1, creative:1.3, adu:0.6 },
    koreatown:    { sfr:0.4, duplex:0.6, multifamily_low:1.3, multifamily_mid:1.4, multifamily_high:1.2, mixeduse:1.3, retail:1.2, office:0.9, medical:1.1, hotel:1.0, industrial:0.3, selfstorage:0.8, senior:0.8, parking:1.2, creative:0.9, adu:0.5 },
    westside:     { sfr:1.0, duplex:0.9, multifamily_low:1.1, multifamily_mid:1.2, multifamily_high:0.9, mixeduse:1.2, retail:1.1, office:1.2, medical:1.3, hotel:1.0, industrial:0.2, selfstorage:0.6, senior:1.0, parking:1.0, creative:1.1, adu:0.9 },
    santamonica:  { sfr:0.8, duplex:0.8, multifamily_low:1.0, multifamily_mid:1.1, multifamily_high:0.8, mixeduse:1.2, retail:1.3, office:1.1, medical:1.0, hotel:1.1, industrial:0.2, selfstorage:0.4, senior:0.8, parking:1.0, creative:1.2, adu:0.7 },
    beverly:      { sfr:1.2, duplex:0.8, multifamily_low:1.0, multifamily_mid:1.1, multifamily_high:0.9, mixeduse:1.1, retail:1.1, office:1.3, medical:1.4, hotel:1.1, industrial:0.1, selfstorage:0.3, senior:1.0, parking:0.9, creative:0.9, adu:0.7 },
    midcity:      { sfr:0.7, duplex:0.8, multifamily_low:1.2, multifamily_mid:1.2, multifamily_high:0.8, mixeduse:1.2, retail:1.0, office:0.9, medical:1.0, hotel:0.8, industrial:0.3, selfstorage:0.8, senior:0.9, parking:0.9, creative:1.0, adu:0.8 },
    southla:      { sfr:0.9, duplex:1.0, multifamily_low:1.1, multifamily_mid:0.8, multifamily_high:0.4, mixeduse:0.8, retail:0.8, office:0.5, medical:0.7, hotel:0.4, industrial:0.9, selfstorage:1.1, senior:0.7, parking:0.6, creative:0.6, adu:1.1 },
    valleyeast:   { sfr:1.1, duplex:1.0, multifamily_low:1.0, multifamily_mid:0.8, multifamily_high:0.5, mixeduse:0.9, retail:0.9, office:0.8, medical:0.9, hotel:0.6, industrial:1.0, selfstorage:1.1, senior:0.9, parking:0.7, creative:0.7, adu:1.0 },
    valleywest:   { sfr:1.2, duplex:1.0, multifamily_low:0.9, multifamily_mid:0.8, multifamily_high:0.4, mixeduse:0.9, retail:0.9, office:0.9, medical:1.0, hotel:0.6, industrial:0.8, selfstorage:1.0, senior:1.0, parking:0.6, creative:0.7, adu:1.0 },
    silverlake:   { sfr:0.9, duplex:0.9, multifamily_low:1.2, multifamily_mid:1.0, multifamily_high:0.5, mixeduse:1.2, retail:1.1, office:0.8, medical:0.7, hotel:0.7, industrial:0.3, selfstorage:0.5, senior:0.5, parking:0.7, creative:1.3, adu:1.0 },
    highland:     { sfr:0.9, duplex:0.9, multifamily_low:1.1, multifamily_mid:0.9, multifamily_high:0.4, mixeduse:1.1, retail:1.0, office:0.7, medical:0.7, hotel:0.5, industrial:0.5, selfstorage:0.7, senior:0.5, parking:0.6, creative:1.1, adu:1.0 },
    venice:       { sfr:0.9, duplex:0.8, multifamily_low:1.0, multifamily_mid:0.9, multifamily_high:0.5, mixeduse:1.2, retail:1.2, office:1.0, medical:0.7, hotel:1.0, industrial:0.2, selfstorage:0.3, senior:0.6, parking:0.8, creative:1.3, adu:0.8 },
    culver:       { sfr:0.8, duplex:0.8, multifamily_low:1.1, multifamily_mid:1.1, multifamily_high:0.7, mixeduse:1.2, retail:1.0, office:1.2, medical:1.0, hotel:0.9, industrial:0.5, selfstorage:0.7, senior:0.8, parking:0.8, creative:1.3, adu:0.8 },
    exposition:   { sfr:0.6, duplex:0.7, multifamily_low:1.2, multifamily_mid:1.2, multifamily_high:0.9, mixeduse:1.2, retail:1.0, office:0.9, medical:0.8, hotel:0.7, industrial:0.4, selfstorage:0.8, senior:0.7, parking:0.9, creative:1.0, adu:0.8 },
    southbay:     { sfr:1.0, duplex:0.9, multifamily_low:0.9, multifamily_mid:0.7, multifamily_high:0.3, mixeduse:0.8, retail:0.9, office:0.8, medical:1.0, hotel:0.7, industrial:1.2, selfstorage:1.1, senior:0.9, parking:0.6, creative:0.6, adu:0.9 },
    harbor:       { sfr:0.7, duplex:0.7, multifamily_low:0.8, multifamily_mid:0.6, multifamily_high:0.3, mixeduse:0.7, retail:0.7, office:0.5, medical:0.6, hotel:0.6, industrial:1.3, selfstorage:1.1, senior:0.7, parking:0.7, creative:0.5, adu:0.7 },
    boyleheights: { sfr:0.9, duplex:1.0, multifamily_low:1.1, multifamily_mid:0.7, multifamily_high:0.3, mixeduse:0.9, retail:0.9, office:0.5, medical:0.6, hotel:0.3, industrial:0.8, selfstorage:0.9, senior:0.6, parking:0.5, creative:0.8, adu:1.1 },
};

// Minimum parcel sizes (sq ft) for feasibility
const MIN_PARCEL = {
    sfr: 2500, duplex: 3500, multifamily_low: 5000, multifamily_mid: 10000,
    multifamily_high: 20000, mixeduse: 5000, retail: 2000, office: 3000,
    medical: 3000, hotel: 15000, industrial: 5000, selfstorage: 8000,
    senior: 15000, parking: 3000, creative: 3000, adu: 1200
};

// Approx LA land value per SF by neighborhood (for relative comparisons)
const LAND_VALUE_PSF = {
    dtla: 250, hollywood: 250, koreatown: 200, westside: 350, santamonica: 400,
    beverly: 450, midcity: 180, southla: 85, valleyeast: 110, valleywest: 130,
    silverlake: 220, highland: 150, venice: 350, culver: 260, exposition: 160,
    southbay: 120, harbor: 80, boyleheights: 110
};

// Revenue potential per NSF of building (annual $/SF, new-construction achievable rents)
const REVENUE_PSF = {
    sfr: 40, duplex: 42, multifamily_low: 52, multifamily_mid: 58,
    multifamily_high: 66, mixeduse: 56, retail: 52, office: 52,
    medical: 62, hotel: 90, industrial: 22, selfstorage: 24,
    senior: 62, parking: 30, creative: 52, adu: 46
};

// Neighborhood rent multiplier â€” adjusts REVENUE_PSF by submarket
const NEIGHBORHOOD_RENT_MULT = {
    dtla: 0.95, hollywood: 1.10, koreatown: 0.88, westside: 1.25, santamonica: 1.35,
    beverly: 1.40, midcity: 1.00, southla: 0.70, valleyeast: 0.82, valleywest: 0.85,
    silverlake: 1.08, highland: 0.88, venice: 1.25, culver: 1.12, exposition: 0.88,
    southbay: 0.85, harbor: 0.70, boyleheights: 0.75
};

// Parking cost per space by building type
const PARKING_COST_MAP = {
    sfr: 8000, duplex: 8000, multifamily_low: 30000, multifamily_mid: 40000,
    multifamily_high: 65000, mixeduse: 40000, retail: 8000, office: 40000,
    medical: 40000, hotel: 55000, industrial: 5000, selfstorage: 5000,
    senior: 30000, parking: 35000, creative: 8000, adu: 5000
};

// Build cost per SF (LA 2024-2025 market)
const BUILD_COST_PSF = {
    sfr: 300, duplex: 275, multifamily_low: 310, multifamily_mid: 400,
    multifamily_high: 575, mixeduse: 420, retail: 260, office: 365,
    medical: 430, hotel: 480, industrial: 150, selfstorage: 110,
    senior: 400, parking: 85, creative: 290, adu: 280
};

// FAR (floor area ratio) by use â€” typical LA densities
const FAR_TYPICAL = {
    sfr: 0.5, duplex: 0.6, multifamily_low: 1.5, multifamily_mid: 3.0,
    multifamily_high: 6.0, mixeduse: 3.0, retail: 0.5, office: 2.0,
    medical: 1.5, hotel: 4.0, industrial: 0.5, selfstorage: 2.5,
    senior: 2.5, parking: 3.0, creative: 1.5, adu: 0.5
};

// Rationale templates
const RATIONALE = {
    sfr:             'Single-family development suits the site due to residential zoning, neighborhood character, and stable demand for ownership housing.',
    duplex:          'Duplex development provides moderate density with manageable entitlement complexity, strong for owner-occupant or rental income strategies.',
    multifamily_low: 'Low-rise multifamily maximizes unit count within a manageable building type, aligning well with LA\'s housing demand and density incentives.',
    multifamily_mid: 'Mid-rise multifamily leverages the parcel size and zoning to achieve meaningful density, supported by strong rental market fundamentals.',
    multifamily_high:'High-rise multifamily captures maximum density bonus potential in a high-demand corridor, though construction costs are significantly higher.',
    mixeduse:        'Mixed-use development combines ground-floor commercial revenue with residential density above, ideal for transit-accessible commercial corridors.',
    retail:          'Retail use leverages street frontage, visibility, and pedestrian traffic in a commercial corridor with demonstrated consumer demand.',
    office:          'Office development responds to professional service demand in the submarket, with viable access and infrastructure to support employment density.',
    medical:         'Medical office benefits from proximity to health care services, strong tenant demand, and premium rents typical of medical-zoned uses.',
    hotel:           'Hotel/hospitality use leverages tourism and business travel demand, arterial visibility, and transit proximity for viable room-night revenue.',
    industrial:      'Industrial/warehouse use provides strong yield potential with lower construction costs, supported by limited industrial land supply in LA.',
    selfstorage:     'Self-storage is operationally efficient with low staffing costs, serves population density demand, and tolerates suboptimal site configurations.',
    senior:          'Senior living addresses the growing aging population with premium per-unit revenue and purpose-built care facilities.',
    parking:         'Parking structure use addresses chronic parking deficits in dense urban areas, with modest build costs and reliable demand.',
    creative:        'Creative office/flex space appeals to tech and media tenants seeking character space, commanding premium rents in emerging neighborhoods.',
    adu:             'ADU or small-lot subdivision maximizes yield on smaller parcels under CA housing legislation (SB 9, AB 68) with minimal entitlement friction.',
};

const CA_HOUSING_LEGISLATION = [
    {
        id: 'sb9',
        name: 'SB 9 (HOME Act)',
        description: 'By-right duplex and lot splits on single-family parcels statewide.',
        detail: 'The California HOME Act (2021) allows property owners to split single-family lots and build duplexes by-right, bypassing traditional zoning restrictions. Applies to parcels of at least 2,400 SF in urbanized areas, not in historic districts, fire hazard zones, or conservation areas. Each resulting lot must be at least 1,200 SF. Owner-occupancy is required for 3 years on one of the units if a lot split is pursued. This effectively doubles the allowed density on R1-zoned land without requiring a zone change or CUP. Impact: Significant for small infill developers targeting R1 neighborhoods.',
        applies: (useId, inp) => inp.zoning === 'R1' && inp.parcelSize >= 2400 && ['duplex', 'adu'].includes(useId),
        densityBonus: 1.0,
        parkingReduction: 0,
        softCostReduction: 0,
        legalOverride: true,
    },
    {
        id: 'ab2011',
        name: 'AB 2011',
        description: 'By-right affordable housing on commercially zoned land.',
        detail: 'AB 2011 (2022) creates a streamlined, ministerial (by-right) approval pathway for 100% affordable housing on commercially zoned land. Projects must pay prevailing wages and meet affordability requirements â€” mixed-income projects require a percentage of units at below-market rents. Applies to sites zoned for office, retail, or parking that are not in industrial zones, coastal zones, or high fire areas. Overrides local zoning that would otherwise prohibit residential uses on commercial parcels. Impact: Unlocks large swaths of commercial land for affordable housing development across California.',
        applies: (useId, inp) => ['C1','C1.5','C2','C4','C5','CM'].includes(inp.zoning) && ['multifamily_low','multifamily_mid','multifamily_high','mixeduse'].includes(useId),
        densityBonus: 0.35,
        parkingReduction: 0,
        softCostReduction: 0,
        legalOverride: true,
    },
    {
        id: 'sb6',
        name: 'SB 6',
        description: 'Market-rate housing permitted on commercially zoned land.',
        detail: 'SB 6, the Middle Class Housing Act (2022), allows market-rate residential development on commercially zoned land, provided the project meets specified objective design standards and at least 20% of units are affordable. Unlike AB 2011, SB 6 allows market-rate projects but requires the local approval process. Projects must comply with local height and FAR limits. Applies to parcels zoned for office, retail, or parking uses. Impact: Enables market-rate housing on commercial corridors where residential was previously prohibited.',
        applies: (useId, inp) => ['C1','C1.5','C2','C4','C5','CM'].includes(inp.zoning) && ['multifamily_low','multifamily_mid','multifamily_high','mixeduse'].includes(useId),
        densityBonus: 0.25,
        parkingReduction: 0,
        softCostReduction: 0,
        legalOverride: false,
    },
    {
        id: 'sb423',
        name: 'SB 423 (Streamlined)',
        description: 'Streamlined ministerial approval for multifamily projects meeting affordability thresholds.',
        detail: 'SB 423 (2023) extends and strengthens SB 35\'s streamlined ministerial approval process for multifamily housing projects meeting affordability thresholds. Projects with 10%+ affordable units in jurisdictions that have not met housing production goals qualify for ministerial approval. Eliminates discretionary review, CEQA requirements, and public hearings for qualifying projects. Applies to urban infill sites in areas meeting RHNA progress standards. Impact: Dramatically reduces entitlement timelines and costs for projects meeting affordability thresholds.',
        applies: (useId, inp) => ['R2','R3','R4','R5','C1.5','C2','C4','TOD'].includes(inp.zoning) && ['multifamily_low','multifamily_mid','multifamily_high','mixeduse'].includes(useId),
        densityBonus: 0,
        parkingReduction: 0,
        softCostReduction: 0.15,
        legalOverride: false,
    },
    {
        id: 'ab2345',
        name: 'AB 2345 (Density Bonus)',
        description: 'Up to 50% density bonus and reduced parking for projects including affordable units.',
        detail: 'AB 2345 (2020) enhances California\'s Density Bonus Law, increasing the maximum density bonus from 35% to 50% for projects including affordable units. Provides up to 4 incentives or concessions such as reduced setbacks, increased height, and reduced parking. Parking minimums reduced to 0.5 spaces per unit for projects near transit. Applies to all residential and mixed-use zones with affordable set-asides meeting specified thresholds. Impact: One of the most widely used tools by LA developers to significantly increase project density and reduce parking requirements.',
        applies: (useId, inp) => ['R2','R3','R4','R5','C1','C1.5','C2','C4','TOD'].includes(inp.zoning) && ['duplex','multifamily_low','multifamily_mid','multifamily_high','mixeduse','senior'].includes(useId),
        densityBonus: 0.50,
        parkingReduction: 0.20,
        softCostReduction: 0,
        legalOverride: false,
    },
    {
        id: 'ab1763',
        name: 'AB 1763',
        description: 'Unlimited density for 100% affordable housing projects near transit.',
        detail: 'AB 1763 (2019) provides unlimited density for 100% affordable housing projects located within half a mile of a major transit stop. Eliminates maximum FAR and unit count restrictions entirely. Parking requirements are set to zero for projects within half a mile of transit. Projects must be 100% affordable with an allowance for manager units. Impact: Enables very high-density affordable development near transit without the typical density caps, making transit-adjacent sites extremely valuable for affordable housing developers.',
        applies: (useId, inp) => ['adjacent','near'].includes(inp.transit) && ['multifamily_low','multifamily_mid','multifamily_high','senior'].includes(useId),
        densityBonus: 1.0,
        parkingReduction: 0,
        softCostReduction: 0,
        legalOverride: true,
    },
    {
        id: 'toc',
        name: 'TOC (LA Local)',
        description: 'Transit Oriented Communities incentives â€” up to 80% density bonus and parking reductions near transit.',
        detail: 'The Transit Oriented Communities (TOC) program is an LA-specific incentive providing density bonuses of up to 80% and significant parking reductions for housing projects near transit. Projects are tiered by proximity: Tier 1 (within 750 ft of a major stop) through Tier 4 (within 2,640 ft), with each tier providing increasing incentives. Affordable units must be included at specified set-aside levels. Impact: The most impactful local density incentive in Los Angeles, enabling significantly larger buildings near Metro stations.',
        applies: (useId, inp) => ['adjacent','near'].includes(inp.transit) && ['multifamily_low','multifamily_mid','multifamily_high','mixeduse'].includes(useId),
        densityBonus: 0.80,
        parkingReduction: 0.30,
        softCostReduction: 0,
        legalOverride: false,
    },
    {
        id: 'ab2097',
        name: 'AB 2097',
        description: 'Eliminates minimum parking requirements within 1/2 mile of major transit stops.',
        detail: 'AB 2097 (2022) eliminates minimum parking requirements for any development within half a mile of a major transit stop in California. Applies to all land use types â€” residential, commercial, and mixed-use â€” not just affordable housing. Local jurisdictions cannot impose minimum parking requirements in these areas. Developers can still choose to build parking, but it is not mandated. Impact: Reduces development costs by $30,000 to $80,000 per eliminated parking space and enables more efficient site utilization near transit.',
        applies: (useId, inp) => ['adjacent','near'].includes(inp.transit),
        densityBonus: 0,
        parkingReduction: 1.0,
        softCostReduction: 0,
        legalOverride: false,
    },
    {
        id: 'adu_reform',
        name: 'ADU Reform (AB 68/SB 13/AB 881)',
        description: 'By-right ADU construction on residential lots; no parking required near transit.',
        detail: 'California\'s ADU reform package (2019-2020) established a comprehensive by-right framework for Accessory Dwelling Units on residential lots. AB 68 allows at least one ADU on any residential lot regardless of local zoning. SB 13 eliminates impact fees for ADUs under 750 SF and caps fees for larger units. AB 881 prohibits local agencies from requiring owner-occupancy or imposing minimum lot sizes. No additional parking is required near transit. Impact: Has generated tens of thousands of new housing units statewide, particularly in single-family neighborhoods.',
        applies: (useId, inp) => ['R1','R2','R3','R4','R5'].includes(inp.zoning) && useId === 'adu',
        densityBonus: 0,
        parkingReduction: 0,
        softCostReduction: 0,
        legalOverride: true,
    },
    {
        id: 'sb478',
        name: 'SB 478',
        description: 'Sets minimum 1.0 FAR for multifamily projects on parcels up to 10,000 SF.',
        detail: 'SB 478 (2021) establishes a minimum floor area ratio (FAR) of 1.0 for multifamily housing projects on parcels of 10,000 SF or less in areas zoned for at least two residential units. Prohibits local jurisdictions from imposing lot coverage limits below 60% on qualifying parcels. Prevents cities from using low FAR limits to effectively block apartment construction on small lots. Applies only to urban infill locations. Impact: Ensures meaningful development potential on small multifamily parcels that might otherwise be restricted by overly conservative FAR limits.',
        applies: (useId, inp) => inp.parcelSize <= 10000 && ['R3','R4','R5','C1.5','C2','C4','TOD'].includes(inp.zoning) && ['multifamily_low','multifamily_mid','multifamily_high'].includes(useId),
        densityBonus: 0,
        parkingReduction: 0,
        softCostReduction: 0,
        legalOverride: false,
        minFAR: 1.0,
    },
    {
        id: 'ed1',
        name: 'ED1 (LA Local)',
        description: 'Executive Directive 1 â€” streamlined approvals and density bonus for 100% affordable and senior housing.',
        detail: 'Executive Directive 1 (2022) is an LA mayoral order streamlining approvals for 100% affordable and senior housing projects in Los Angeles. Provides expedited processing, priority permitting, and fee waivers for qualifying projects. Includes density bonus provisions beyond state law for affordable projects. Directs all city departments to prioritize affordable housing applications and reduce bureaucratic barriers. Impact: Significantly reduces entitlement timelines for affordable housing, with some projects receiving permits in weeks rather than months.',
        applies: (useId, inp) => ['multifamily_low','multifamily_mid','multifamily_high','senior'].includes(useId),
        densityBonus: 0.35,
        parkingReduction: 0,
        softCostReduction: 0.20,
        legalOverride: false,
    },
    {
        id: 'sb684',
        name: 'SB 684',
        description: 'By-right approval for 10+ unit housing projects on commercially zoned land.',
        detail: 'SB 684 (2023) establishes a by-right (ministerial) approval pathway for housing projects of 10 or more units on commercially zoned land. Projects must meet objective design and development standards. Requires compliance with density, height, and FAR limits as defined by local jurisdictions. Overrides local discretionary review requirements and CEQA for qualifying projects on infill sites. Impact: Provides certainty and speed for developers building housing on commercial sites, reducing entitlement risk and project timelines substantially.',
        applies: (useId, inp) => ['C1','C1.5','C2','C4','C5','CM'].includes(inp.zoning) && ['multifamily_low','multifamily_mid','multifamily_high','mixeduse'].includes(useId),
        densityBonus: 0,
        parkingReduction: 0,
        softCostReduction: 0,
        legalOverride: true,
    },
    {
        id: 'sb79',
        name: 'SB 79 (Transit-Oriented)',
        description: 'Overrides local zoning near qualifying transit stations â€” up to 95ft, 160 du/acre, 4.5 FAR.',
        detail: 'SB 79 (effective July 1, 2026) is California\'s transit-oriented development bill that overrides local zoning near qualifying heavy and light rail stations. Tier 1 (heavy rail, including all Metro Rail lines) allows 95ft height, 160 du/acre, and 4.5 FAR. Tier 2 (light rail, BRT, qualifying Metrolink) allows 85ft height, 140 du/acre, and 4.0 FAR. Three distance zones apply: Adjacent (within 200ft of station entrance) and Inner (within 1/4 mile) get full tier benefits and zero parking requirements. Outer zone (1/4 to 1/2 mile) is limited to 65ft height and 3.25 FAR, with 0.5 parking spaces per unit. All projects require 15% affordable units. 100% affordable projects receive the full tier benefits regardless of zone. Impact: Unlocks massive upzoning near every Metro station in LA County, making transit-adjacent parcels significantly more valuable for higher-density development.',
        applies: (useId, inp) => {
            if (!window.lastGeocode) return false;
            if (!['multifamily_low','multifamily_mid','multifamily_high','mixeduse','senior','hotel'].includes(useId)) return false;
            const sb79 = detectSB79Eligibility(window.lastGeocode.lat, window.lastGeocode.lon);
            return sb79.eligible;
        },
        get densityBonus() {
            if (!window.lastGeocode) return 0;
            const sb79 = detectSB79Eligibility(window.lastGeocode.lat, window.lastGeocode.lon);
            if (!sb79.eligible) return 0;
            return sb79.allowances.far / 3.0 - 1;
        },
        get parkingReduction() {
            if (!window.lastGeocode) return 0;
            const sb79 = detectSB79Eligibility(window.lastGeocode.lat, window.lastGeocode.lon);
            if (!sb79.eligible) return 0;
            return sb79.allowances.parking === 0 ? 1.0 : 0.5;
        },
        softCostReduction: 0.10,
        legalOverride: true,
        get minFAR() {
            if (!window.lastGeocode) return 0;
            const sb79 = detectSB79Eligibility(window.lastGeocode.lat, window.lastGeocode.lon);
            if (!sb79.eligible) return 0;
            return sb79.allowances.far;
        },
    },
];

function getApplicableLegislation(useId, inp) {
    return CA_HOUSING_LEGISLATION.filter(bill => bill.applies(useId, inp));
}

function stackLegislationEffects(legislationList) {
    let densityBonus = 0;
    let parkingReduction = 0;
    let softCostReduction = 0;
    let legalOverride = false;
    let minFAR = 0;

    for (const bill of legislationList) {
        densityBonus = Math.max(densityBonus, bill.densityBonus || 0);
        parkingReduction = Math.max(parkingReduction, bill.parkingReduction || 0);
        softCostReduction += (bill.softCostReduction || 0);
        if (bill.legalOverride) legalOverride = true;
        minFAR = Math.max(minFAR, bill.minFAR || 0);
    }

    softCostReduction = Math.min(softCostReduction, 0.50);
    return { densityBonus, parkingReduction, softCostReduction, legalOverride, minFAR };
}

/**
 * Calculate site work cost broken into sub-components.
 * Adjusts for topography, soil conditions, site condition, and use type.
 *
 * Sub-components (all $/SF of lot area unless noted):
 *   1. Clearing & Grubbing  â€” remove vegetation, trees, debris ($1.50-$4.50/SF)
 *   2. Rough Grading         â€” cut/fill, grade to design elevations ($2-$12/SF depending on slope)
 *   3. Soil Prep / Compaction â€” scarify, moisture condition, compact subgrade ($1.50-$5/SF)
 *   4. Utility Rough-In      â€” trench, stub water/sewer/storm/electric/gas to building pad ($3-$8/SF)
 *   5. Erosion / SWPPP        â€” silt fence, BMP, SWPPP compliance during grading ($0.75-$2/SF)
 *
 * @param {string} useId â€” land use type
 * @param {object} inp â€” site input (parcelSize, topography, siteCondition, etc.)
 * @param {number} gsf â€” gross square footage of building
 * @param {object} [rateOverrides] â€” optional user-overridden $/SF rates for each sub-component
 * @returns {object} { clearing, grading, soilPrep, utilities, erosion, total, rates, assumptions }
 */
function calcSiteWorkBreakdown(useId, inp, gsf, rateOverrides) {
    var lot = inp.parcelSize || 10000;

    // ADU: minimal site work scoped to footprint
    if (useId === 'adu') {
        var aduArea = Math.min(lot * 0.3, gsf || 800);
        return { clearing: 0, grading: Math.round(aduArea * 3), soilPrep: Math.round(aduArea * 2),
                 utilities: Math.round(aduArea * 5), erosion: Math.round(aduArea * 1),
                 total: Math.round(aduArea * 11), rates: { clearing: 0, grading: 3, soilPrep: 2, utilities: 5, erosion: 1 },
                 assumptions: 'ADU â€” site work scoped to ADU footprint only (~' + Math.round(aduArea).toLocaleString() + ' SF). Minimal grading, shared utility laterals.' };
    }

    // Base rates ($/SF of lot) â€” typical flat urban infill in LA
    var rates = {
        clearing:  2.00,  // vegetation/debris removal
        grading:   3.50,  // rough grading, cut/fill
        soilPrep:  2.50,  // compaction, moisture conditioning
        utilities: 5.00,  // trench & stub all utilities to pad
        erosion:   1.25,  // SWPPP, silt fence, BMPs
    };

    // --- Adjust for TOPOGRAPHY ---
    if (inp.topography === 'steep') {
        rates.grading = 10.00;   // heavy cut/fill, retaining walls, export
        rates.soilPrep = 4.50;   // deeper compaction, engineered fill
        rates.erosion = 2.00;    // extended SWPPP, slope stabilization
    } else if (inp.topography === 'moderate' || inp.topography === 'sloped') {
        rates.grading = 6.00;    // moderate cut/fill
        rates.soilPrep = 3.25;
        rates.erosion = 1.50;
    }
    // flat = base rates

    // --- Adjust for SITE CONDITION ---
    if (inp.siteCondition === 'vacant') {
        rates.clearing = 1.50;   // minimal â€” empty lot, weeds/fence
    } else if (inp.siteCondition === 'brownfield') {
        rates.clearing = 4.00;   // hazmat screening, debris, potential contaminated soil handling
        rates.soilPrep = 4.00;   // over-excavation, clean fill import
    } else if (inp.siteCondition === 'demolition') {
        rates.clearing = 3.50;   // post-demo debris, asbestos survey area
    }

    // --- Adjust for UTILITIES ---
    if (inp.utilities === 'partial') {
        rates.utilities = 7.00;  // some laterals need extension
    } else if (inp.utilities === 'none') {
        rates.utilities = 12.00; // full utility extension from main to site
    }

    // --- Adjust for CONSTRAINTS ---
    if (inp.constFlood) {
        rates.grading += 2.00;   // flood mitigation grading, raised pad
        rates.erosion += 0.75;   // extra drainage BMPs
    }
    if (inp.constHillside) {
        rates.grading += 3.00;   // hillside grading ordinance compliance
    }
    if (inp.constFault) {
        rates.soilPrep += 1.50;  // fault zone geotech compliance
    }

    // Apply user overrides if provided
    if (rateOverrides) {
        if (rateOverrides.clearing !== undefined) rates.clearing = rateOverrides.clearing;
        if (rateOverrides.grading !== undefined) rates.grading = rateOverrides.grading;
        if (rateOverrides.soilPrep !== undefined) rates.soilPrep = rateOverrides.soilPrep;
        if (rateOverrides.utilities !== undefined) rates.utilities = rateOverrides.utilities;
        if (rateOverrides.erosion !== undefined) rates.erosion = rateOverrides.erosion;
    }

    var clearing  = Math.round(lot * rates.clearing);
    var grading   = Math.round(lot * rates.grading);
    var soilPrep  = Math.round(lot * rates.soilPrep);
    var utilities = Math.round(lot * rates.utilities);
    var erosion   = Math.round(lot * rates.erosion);
    var total     = clearing + grading + soilPrep + utilities + erosion;

    // Build human-readable assumption string
    var assumptionParts = [];
    if (inp.topography === 'steep') assumptionParts.push('steep slope (+heavy grading, retaining, export)');
    else if (inp.topography === 'moderate' || inp.topography === 'sloped') assumptionParts.push('moderate slope (+additional grading)');
    else assumptionParts.push('flat/level grade (standard grading)');
    if (inp.siteCondition === 'brownfield') assumptionParts.push('brownfield (+over-excavation, clean fill)');
    else if (inp.siteCondition === 'demolition') assumptionParts.push('post-demo site (+debris handling)');
    else if (inp.siteCondition === 'vacant') assumptionParts.push('vacant lot (minimal clearing)');
    if (inp.utilities === 'none') assumptionParts.push('no utilities (+full lateral extension)');
    else if (inp.utilities === 'partial') assumptionParts.push('partial utilities (+lateral extensions)');
    if (inp.constFlood) assumptionParts.push('flood zone (+raised pad, drainage)');
    if (inp.constHillside) assumptionParts.push('hillside (+ordinance compliance)');
    if (inp.constFault) assumptionParts.push('fault zone (+geotech)');

    return {
        clearing: clearing, grading: grading, soilPrep: soilPrep, utilities: utilities, erosion: erosion,
        total: total, rates: rates,
        assumptions: assumptionParts.join('; '),
    };
}

const BUILDING_PARAMS = {
    sfr:              { stories: 2,  floorH: 10, eff: 0.92, unitSF: 1800, parkRatio: 2.0,  setF: 20, setS: 5,  opex: 0.30, cap: 0.045 },
    duplex:           { stories: 2,  floorH: 10, eff: 0.90, unitSF: 1200, parkRatio: 1.5,  setF: 15, setS: 5,  opex: 0.32, cap: 0.047 },
    multifamily_low:  { stories: 4,  floorH: 10, eff: 0.82, unitSF: 850,  parkRatio: 1.25, setF: 10, setS: 5,  opex: 0.35, cap: 0.047 },
    multifamily_mid:  { stories: 7,  floorH: 10, eff: 0.80, unitSF: 800,  parkRatio: 1.0,  setF: 10, setS: 5,  opex: 0.35, cap: 0.045 },
    multifamily_high: { stories: 18, floorH: 10, eff: 0.78, unitSF: 750,  parkRatio: 1.0,  setF: 10, setS: 10, opex: 0.38, cap: 0.042 },
    mixeduse:         { stories: 6,  floorH: 12, eff: 0.80, unitSF: 850,  parkRatio: 1.0,  setF: 0,  setS: 0,  opex: 0.36, cap: 0.048 },
    retail:           { stories: 1,  floorH: 16, eff: 0.88, unitSF: null, parkRatio: 4.0,  setF: 0,  setS: 0,  opex: 0.32, cap: 0.058 },
    office:           { stories: 5,  floorH: 13, eff: 0.85, unitSF: null, parkRatio: 3.0,  setF: 5,  setS: 5,  opex: 0.38, cap: 0.065 },
    medical:          { stories: 4,  floorH: 13, eff: 0.82, unitSF: null, parkRatio: 4.0,  setF: 10, setS: 5,  opex: 0.40, cap: 0.055 },
    hotel:            { stories: 10, floorH: 11, eff: 0.75, unitSF: 400,  parkRatio: 0.5,  setF: 5,  setS: 5,  opex: 0.55, cap: 0.070 },
    industrial:       { stories: 1,  floorH: 24, eff: 0.92, unitSF: null, parkRatio: 1.0,  setF: 10, setS: 5,  opex: 0.28, cap: 0.052 },
    selfstorage:      { stories: 4,  floorH: 9,  eff: 0.88, unitSF: null, parkRatio: 0.2,  setF: 5,  setS: 5,  opex: 0.30, cap: 0.062 },
    senior:           { stories: 5,  floorH: 10, eff: 0.78, unitSF: 600,  parkRatio: 0.5,  setF: 10, setS: 5,  opex: 0.50, cap: 0.058 },
    parking:          { stories: 5,  floorH: 11, eff: 0.90, unitSF: null, parkRatio: null, setF: 0,  setS: 0,  opex: 0.25, cap: 0.065 },
    creative:         { stories: 3,  floorH: 14, eff: 0.85, unitSF: null, parkRatio: 2.5,  setF: 0,  setS: 0,  opex: 0.32, cap: 0.058 },
    adu:              { stories: 2,  floorH: 9,  eff: 0.90, unitSF: 600,  parkRatio: 0,    setF: 5,  setS: 4,  opex: 0.30, cap: 0.048 },
};

const TIMELINE_MONTHS = {
    sfr:              { entitlement: 2,  design: 2,  permits: 2, construction: 10, leaseup: 1 },
    duplex:           { entitlement: 3,  design: 2,  permits: 2, construction: 12, leaseup: 1 },
    multifamily_low:  { entitlement: 6,  design: 4,  permits: 3, construction: 18, leaseup: 6 },
    multifamily_mid:  { entitlement: 8,  design: 5,  permits: 4, construction: 24, leaseup: 8 },
    multifamily_high: { entitlement: 12, design: 8,  permits: 6, construction: 36, leaseup: 10 },
    mixeduse:         { entitlement: 8,  design: 5,  permits: 4, construction: 22, leaseup: 8 },
    retail:           { entitlement: 4,  design: 3,  permits: 2, construction: 10, leaseup: 4 },
    office:           { entitlement: 6,  design: 4,  permits: 3, construction: 18, leaseup: 8 },
    medical:          { entitlement: 6,  design: 5,  permits: 4, construction: 16, leaseup: 6 },
    hotel:            { entitlement: 10, design: 6,  permits: 5, construction: 28, leaseup: 12 },
    industrial:       { entitlement: 4,  design: 3,  permits: 2, construction: 10, leaseup: 3 },
    selfstorage:      { entitlement: 4,  design: 3,  permits: 2, construction: 12, leaseup: 12 },
    senior:           { entitlement: 8,  design: 5,  permits: 4, construction: 22, leaseup: 10 },
    parking:          { entitlement: 4,  design: 3,  permits: 2, construction: 14, leaseup: 2 },
    creative:         { entitlement: 4,  design: 3,  permits: 2, construction: 14, leaseup: 6 },
    adu:              { entitlement: 1,  design: 1,  permits: 2, construction: 8,  leaseup: 1 },
};

const USE_COLORS = {
    sfr: '#4a9e5c', duplex: '#5ba86e', multifamily_low: '#3182ce', multifamily_mid: '#2b6cb0',
    multifamily_high: '#1a4791', mixeduse: '#805ad5', retail: '#dd6b20', office: '#2c5282',
    medical: '#38a169', hotel: '#b83280', industrial: '#718096', selfstorage: '#a0aec0',
    senior: '#d69e2e', parking: '#4a5568', creative: '#ed8936', adu: '#48bb78',
};


// ============================================================
//  SCORING FUNCTIONS
// ============================================================

function getInputs() {
    return {
        parcelSize:    parseFloat(document.getElementById('parcelSize').value) || 10000,
        frontage:      parseFloat(document.getElementById('frontage').value) || 80,
        zoning:        document.getElementById('zoning').value,
        neighborhood:  document.getElementById('neighborhood').value,
        siteCondition: document.getElementById('siteCondition').value,
        topography:    document.getElementById('topography').value,
        cornerLot:     document.getElementById('cornerLot').value === 'yes',
        transit:       document.getElementById('transit').value,
        arterial:      document.getElementById('arterial').value,
        utilities:     document.getElementById('utilities').value,
        constFlood:    document.getElementById('constFlood').checked,
        constHillside: document.getElementById('constHillside').checked,
        constHistoric: document.getElementById('constHistoric').checked,
        constFault:    document.getElementById('constFault').checked,
        constCoastal:  document.getElementById('constCoastal').checked,
        constParking:  document.getElementById('constParking').checked,
    };
}

function scoreLegal(useId, inp, effects) {
    const zoneRow = ZONING_MATRIX[inp.zoning];
    if (!zoneRow) return 0;
    let base = zoneRow[useId] || 0;

    // CA Housing Legislation: by-right override
    if (effects && effects.legalOverride) {
        base = 1.0;
    }

    // Historic overlay reduces redevelopment permission
    if (inp.constHistoric && ['multifamily_high', 'hotel', 'industrial'].includes(useId)) {
        base *= 0.5;
    }
    // Coastal zone limits industrial, dense residential
    if (inp.constCoastal && ['industrial', 'multifamily_high', 'selfstorage'].includes(useId)) {
        base *= 0.4;
    }
    // Hillside ordinance restricts density
    if (inp.constHillside && ['multifamily_mid', 'multifamily_high', 'hotel', 'industrial'].includes(useId)) {
        base *= 0.3;
    }
    return Math.min(base, 1.0);
}

function scorePhysical(useId, inp) {
    let score = 1.0;

    // Parcel size check
    const minSqFt = MIN_PARCEL[useId] || 2000;
    if (inp.parcelSize < minSqFt) {
        score *= Math.max(0.1, inp.parcelSize / minSqFt);
    } else if (inp.parcelSize > minSqFt * 3) {
        score *= 1.0; // plenty of room
    }

    // Frontage adequacy
    const needsFrontage = ['retail', 'mixeduse', 'hotel', 'office', 'medical'];
    if (needsFrontage.includes(useId) && inp.frontage < 50) {
        score *= 0.6;
    }

    // Topography
    const topoPenalty = { flat: 1.0, gentle: 0.9, moderate: 0.65, steep: 0.3 };
    const baseTopo = topoPenalty[inp.topography] || 1.0;
    // Some uses are more topo-tolerant
    if (['parking', 'selfstorage'].includes(useId)) {
        score *= Math.max(baseTopo, 0.7);
    } else if (['industrial', 'multifamily_high', 'hotel'].includes(useId)) {
        score *= baseTopo * 0.9; // extra sensitive
    } else {
        score *= baseTopo;
    }

    // Utilities
    if (inp.utilities === 'partial') score *= 0.85;
    if (inp.utilities === 'none') score *= 0.5;

    // Site condition
    if (inp.siteCondition === 'demolition') score *= 0.85;
    if (inp.siteCondition === 'brownfield') score *= 0.6;

    // Flood zone
    if (inp.constFlood) score *= 0.7;

    // Fault zone â€” penalizes tall structures
    if (inp.constFault && ['multifamily_high', 'hotel', 'office'].includes(useId)) {
        score *= 0.7;
    }

    return Math.min(score, 1.0);
}

function scoreFinancial(useId, inp, effects) {
    // Compute effective FAR with legislation bonuses
    const baseFAR = FAR_TYPICAL[useId] || 1.0;
    let far = baseFAR;
    if (effects) {
        far = baseFAR * (1 + effects.densityBonus);
        if (effects.minFAR > 0) far = Math.max(far, effects.minFAR);
    }

    const params = BUILDING_PARAMS[useId];
    const buildableSF = inp.parcelSize * far;
    const nsf = buildableSF * (params ? params.eff : 0.82);
    const landValuePSF = LAND_VALUE_PSF[inp.neighborhood] || 150;
    // ADU is an addition â€” no land acquisition cost
    const landCost = useId === 'adu' ? 0 : inp.parcelSize * landValuePSF;

    // Build cost with parking reduction from legislation
    let buildCostPerSF = BUILD_COST_PSF[useId] || 300;
    if (effects && effects.parkingReduction > 0) {
        buildCostPerSF *= (1 - effects.parkingReduction * 0.18);
    }
    const buildCost = buildableSF * buildCostPerSF;

    // Parking cost (use-specific)
    const parkCostPerSpace = PARKING_COST_MAP[useId] || 35000;
    const baseParkRatio = params ? (params.parkRatio || 0) : 0;
    const parkReduction = effects ? effects.parkingReduction : 0;
    const hasUnits = params && params.unitSF;
    let parkSpaces = 0;
    if (useId === 'parking') parkSpaces = Math.round(buildableSF / 350);
    else if (hasUnits) parkSpaces = Math.max(0, Math.ceil(Math.floor(nsf / params.unitSF) * baseParkRatio * (1 - parkReduction)));
    else parkSpaces = Math.max(0, Math.ceil(buildableSF / 1000 * baseParkRatio * (1 - parkReduction)));
    const parkingCost = parkSpaces * parkCostPerSpace;

    // Total cost including overhead (parking, contingency, soft costs)
    // Site work cost (uses breakdown function for consistency)
    const siteWorkCost = calcSiteWorkBreakdown(useId, inp, buildableSF).total;
    const hardCostBase = buildCost + parkingCost + siteWorkCost;
    const totalHard = hardCostBase * 1.11; // ~4% landscaping + 7% contingency
    const totalSoft = totalHard * 0.235; // ~23.5% (A&E 8%, permits 5%, legal 2%, financing 4.5%, dev fee 4%)
    let totalCost = landCost + totalHard + totalSoft;
    if (effects && effects.softCostReduction > 0) {
        totalCost -= totalSoft * effects.softCostReduction * 0.20;
    }

    // Annual NOI with neighborhood rent adjustment
    const rentMult = NEIGHBORHOOD_RENT_MULT[inp.neighborhood] || 1.0;
    const opexRate = params ? params.opex : 0.35;
    const annualNOI = nsf * (REVENUE_PSF[useId] || 30) * rentMult * (1 - opexRate);

    // Yield-on-cost and development margin
    const yieldOnCost = annualNOI / totalCost;
    const capRate = params ? params.cap : 0.05;
    const devMargin = capRate > 0 ? (yieldOnCost / capRate - 1) : 0;

    // Score based on dev margin â€” directly ties to project profitability
    let score;
    if (devMargin >= 0.25) score = 1.0;
    else if (devMargin >= 0.15) score = 0.75 + (devMargin - 0.15) / 0.10 * 0.25;
    else if (devMargin >= 0.05) score = 0.45 + (devMargin - 0.05) / 0.10 * 0.30;
    else if (devMargin >= 0) score = 0.20 + (devMargin / 0.05) * 0.25;
    else if (devMargin >= -0.15) score = Math.max(0.02, 0.20 + devMargin * 1.2);
    else score = 0.02;

    // Neighborhood demand multiplier
    const demandRow = NEIGHBORHOOD_DEMAND[inp.neighborhood];
    const demand = demandRow ? (demandRow[useId] || 0.7) : 0.7;
    score *= demand;

    // Corner lot bonus for visibility-dependent uses
    if (inp.cornerLot && ['retail', 'mixeduse', 'hotel', 'office', 'medical'].includes(useId)) {
        score *= 1.15;
    }

    // Transit proximity bonus
    const transitBonus = { adjacent: 1.2, near: 1.1, moderate: 1.0, far: 0.85 };
    if (['multifamily_mid', 'multifamily_high', 'mixeduse', 'office', 'hotel'].includes(useId)) {
        score *= (transitBonus[inp.transit] || 1.0);
    }

    // Arterial bonus
    if (inp.arterial === 'major' && ['retail', 'mixeduse', 'hotel', 'office'].includes(useId)) {
        score *= 1.1;
    }
    if (inp.arterial === 'residential' && ['retail', 'hotel', 'industrial'].includes(useId)) {
        score *= 0.7;
    }

    // Site condition cost adjustments
    if (inp.siteCondition === 'demolition') score *= 0.9;
    if (inp.siteCondition === 'brownfield') score *= 0.7;

    // Parking constraints
    if (inp.constParking && ['retail', 'office', 'medical', 'hotel'].includes(useId)) {
        score *= 0.8;
    }

    // ADU bonus: low total cost, zero parking, by-right, fastest timeline,
    // can add to existing structure â€” highest ROI per dollar invested
    if (useId === 'adu') {
        // ADU total investment is a fraction of ground-up projects, so the dev-margin
        // math (which divides NOI by total cost incl. land) understates its attractiveness.
        // Boost reflects: minimal entitlement risk, 13-month timeline, no parking cost.
        score = Math.max(score, 0.55);
        // Extra lift for residential zones where ADU is by-right
        if (['R1','R2','R3'].includes(inp.zoning)) score *= 1.25;
        // ADU excels on smaller/mid-size parcels with existing structures
        if (inp.siteCondition === 'improved' || inp.siteCondition === 'vacant') score *= 1.10;
    }

    return Math.min(score, 1.0);
}

function scoreProductive(useId, inp, effects) {
    // Compute effective FAR with legislation bonuses
    const baseFAR = FAR_TYPICAL[useId] || 1.0;
    let far = baseFAR;
    if (effects) {
        far = baseFAR * (1 + effects.densityBonus);
        if (effects.minFAR > 0) far = Math.max(far, effects.minFAR);
    }

    const buildableSF = inp.parcelSize * far;
    const revenuePSF = REVENUE_PSF[useId] || 30;
    const rentMult = NEIGHBORHOOD_RENT_MULT[inp.neighborhood] || 1.0;
    const totalAnnualRev = buildableSF * revenuePSF * rentMult;
    const landValuePSF = LAND_VALUE_PSF[inp.neighborhood] || 150;

    // Revenue-to-land-value ratio (higher = more productive per dollar of land)
    const revToLand = totalAnnualRev / (inp.parcelSize * landValuePSF);

    // Normalize
    let score;
    if (revToLand >= 0.20) score = 1.0;
    else if (revToLand >= 0.10) score = 0.5 + (revToLand - 0.10) / 0.10 * 0.5;
    else score = revToLand / 0.10 * 0.5;

    // Demand multiplier
    const demandRow = NEIGHBORHOOD_DEMAND[inp.neighborhood];
    const demand = demandRow ? (demandRow[useId] || 0.7) : 0.7;
    score *= demand;

    // ADU productivity: revenue-to-land-value underrates ADU because it
    // doesn't require using the full parcel â€” it adds income to an existing
    // property. Adjust to reflect incremental value-add ROI.
    if (useId === 'adu') {
        score = Math.max(score, 0.45);
        if (['R1','R2','R3'].includes(inp.zoning)) score *= 1.20;
    }

    return Math.min(score, 1.0);
}


// ============================================================
//  MAIN CALCULATION
// ============================================================

let lastResults = null;
let lastInputs = null;

function calculateHBU() {
    const inp = getInputs();

    // Score all uses
    const results = LAND_USES.map(use => {
        const legislation = getApplicableLegislation(use.id, inp);
        const effects = stackLegislationEffects(legislation);

        const legal      = scoreLegal(use.id, inp, effects);
        const physical   = scorePhysical(use.id, inp);
        const financial  = scoreFinancial(use.id, inp, effects);
        const productive = scoreProductive(use.id, inp, effects);

        // Compute actual dev margin for feasibility check
        const budget = generateBudget(use.id, inp, effects);
        const devMarginPct = budget.devMargin;

        // HBU must pass ALL four tests. Weight: Legal gateway, then others.
        // If legal = 0, overall = 0
        let overall;
        if (legal === 0) {
            overall = 0;
        } else {
            overall = legal * 0.25 + physical * 0.20 + financial * 0.30 + productive * 0.25;
            // Penalize further if legal is only conditional
            if (legal <= 0.5) overall *= 0.8;
            // Financial performance gate â€” reward high margins, penalize low/negative
            if (devMarginPct >= 0.30) overall *= 1.20;       // excellent deal â€” boost
            else if (devMarginPct >= 0.15) overall *= 1.10;  // strong deal â€” slight boost
            else if (devMarginPct >= 0.05) overall *= 1.0;   // acceptable â€” no change
            else if (devMarginPct >= 0) overall *= 0.75;     // barely feasible â€” penalize
            else if (devMarginPct >= -0.05) overall *= 0.55;
            else if (devMarginPct >= -0.15) overall *= 0.40;
            else overall *= 0.25;                            // major money loser
        }

        return {
            ...use,
            legal: Math.round(legal * 100),
            physical: Math.round(physical * 100),
            financial: Math.round(financial * 100),
            productive: Math.round(productive * 100),
            overall: Math.round(overall * 100),
            devMarginPct,
            legislation,
        };
    });

    // Sort by overall descending
    results.sort((a, b) => b.overall - a.overall);

    // Store for modal access
    lastResults = results;
    lastInputs = inp;

    // Render
    renderResults(results, inp);

    // Auto-save to My Sites
    saveToAgentSites(results, inp);

    // SB 79 Map â€” show if we have geocoded coordinates
    if (window.lastGeocode && typeof L !== 'undefined') {
        const { lat, lon } = window.lastGeocode;
        const sb79 = detectSB79Eligibility(lat, lon);
        document.getElementById('mapSection').style.display = 'block';
        initSB79Map(lat, lon);
        renderSB79Eligibility(sb79);
    }
}

function renderResults(results, inp) {
    const container = document.getElementById('results');
    container.classList.add('visible');

    // Summary
    document.getElementById('resultsSummary').textContent =
        `Analysis for a ${inp.parcelSize.toLocaleString()} SF parcel, zoned ${inp.zoning}, in ${document.getElementById('neighborhood').selectedOptions[0].text}.`;

    // Feasibility warning banner
    const topMargin = results[0] ? results[0].devMarginPct : 0;
    const anyFeasible = results.slice(0, 3).some(r => r.devMarginPct >= 0);
    let warningHTML = '';
    if (!anyFeasible) {
        warningHTML = `<div style="background:#fff5f5;border:1px solid #fc8181;border-radius:10px;padding:1rem 1.25rem;margin-bottom:1.25rem;font-size:0.88rem;color:#c53030;">
            <strong>No Feasible Development Identified</strong> â€” Based on current market rents, construction costs, and land values, none of the evaluated uses produce a positive development margin at this site. Consider: (1) acquiring the land below market, (2) a condo/for-sale exit strategy, (3) value-add renovation of the existing structure, or (4) holding the property.
        </div>`;
    } else if (topMargin < 0.10) {
        warningHTML = `<div style="background:#fffff0;border:1px solid #ecc94b;border-radius:10px;padding:0.85rem 1.15rem;margin-bottom:1.25rem;font-size:0.85rem;color:#b7791f;">
            <strong>Marginal Feasibility</strong> â€” The top-ranked use shows a ${(topMargin * 100).toFixed(0)}% development margin. Most developers target 15-25%. Profitability depends on favorable execution, cost control, and rent achievement.
        </div>`;
    }

    // Top 3 cards
    const cardsDiv = document.getElementById('resultCards');
    cardsDiv.innerHTML = warningHTML;

    const rankLabels = ['1st â€” Best Use', '2nd â€” Alternative', '3rd â€” Alternative'];
    const rankClasses = ['rank-1', 'rank-2', 'rank-3'];

    // Compute market value once for opportunity ratio on cards
    const cardGeo = window.lastGeocode || {};
    let cardMarketValue = 0;
    if (cardGeo.assessedTotal && cardGeo.assessedTotal > 0) {
        cardMarketValue = Math.round(cardGeo.assessedTotal * 1.9);
    } else {
        const landValPSF = LAND_VALUE_PSF[inp.neighborhood] || 150;
        cardMarketValue = Math.round(landValPSF * inp.parcelSize * 1.3);
    }

    for (let i = 0; i < 3; i++) {
        const r = results[i];
        const effects = stackLegislationEffects(r.legislation || []);
        const metricsHTML = generateCardMetricsHTML(r.id, inp, effects, r);
        const legBadges = r.legislation && r.legislation.length > 0
            ? `<div class="legislation-badges">
                   <div class="leg-label">Applicable Legislation</div>
                   ${r.legislation.map(b => `<span class="legislation-badge clickable" onclick="event.stopPropagation();showLegislationDetail('${b.id}')">${b.name}</span>`).join('')}
               </div>`
            : '';

        // Feasibility badge
        let feasBadge = '';
        if (r.devMarginPct >= 0.15) feasBadge = '<span style="display:inline-block;font-size:0.7rem;font-weight:700;padding:0.15rem 0.5rem;border-radius:999px;background:#f0fff4;color:#276749;margin-left:0.5rem;">FEASIBLE</span>';
        else if (r.devMarginPct >= 0) feasBadge = '<span style="display:inline-block;font-size:0.7rem;font-weight:700;padding:0.15rem 0.5rem;border-radius:999px;background:#fffff0;color:#b7791f;margin-left:0.5rem;">MARGINAL</span>';
        else feasBadge = '<span style="display:inline-block;font-size:0.7rem;font-weight:700;padding:0.15rem 0.5rem;border-radius:999px;background:#fff5f5;color:#c53030;margin-left:0.5rem;">NOT FEASIBLE</span>';

        // Opportunity Ratio badge â€” dev land bid vs market value
        const cardBudget = generateBudget(r.id, inp, effects);
        const cardDevCosts = (cardBudget.totalHard || 0) + (cardBudget.totalSoft || 0);
        const cardDevBid = Math.max(0, (cardBudget.stabilizedValue || 0) - cardDevCosts);
        const cardOppRatio = cardMarketValue > 0 ? cardDevBid / cardMarketValue : 0;
        let oppBadge = '';
        if (cardOppRatio >= 1.5) oppBadge = `<span style="display:inline-block;font-size:0.7rem;font-weight:700;padding:0.15rem 0.5rem;border-radius:999px;background:#ecfdf5;color:#059669;margin-left:0.5rem;">ðŸŽ¯ ${cardOppRatio.toFixed(1)}x OPP</span>`;
        else if (cardOppRatio >= 1.0) oppBadge = `<span style="display:inline-block;font-size:0.7rem;font-weight:700;padding:0.15rem 0.5rem;border-radius:999px;background:#fffbeb;color:#b45309;margin-left:0.5rem;">${cardOppRatio.toFixed(1)}x OPP</span>`;
        else oppBadge = `<span style="display:inline-block;font-size:0.7rem;font-weight:700;padding:0.15rem 0.5rem;border-radius:999px;background:#fef2f2;color:#dc2626;margin-left:0.5rem;">${cardOppRatio.toFixed(1)}x OPP</span>`;

        const card = document.createElement('div');
        card.className = `result-card ${rankClasses[i]}`;
        card.style.cursor = 'pointer';
        card.onclick = function(e) { if (e.target.closest('button')) return; openAnalysis(i); };
        card.innerHTML = `
            <div class="rank-banner">
                <span class="rank-num">#${i + 1}</span>
                ${rankLabels[i]}${feasBadge}${oppBadge}
            </div>
            <div class="card-body">
                <div class="use-name">${r.icon} ${r.name}</div>

                <div class="score-bar-container">
                    <div class="score-label"><span>Legally Permissible</span><span>${r.legal}%</span></div>
                    <div class="score-bar"><div class="score-bar-fill legal" style="width: ${r.legal}%"></div></div>
                </div>
                <div class="score-bar-container">
                    <div class="score-label"><span>Physically Possible</span><span>${r.physical}%</span></div>
                    <div class="score-bar"><div class="score-bar-fill physical" style="width: ${r.physical}%"></div></div>
                </div>
                <div class="score-bar-container">
                    <div class="score-label"><span>Financially Feasible</span><span>${r.financial}%</span></div>
                    <div class="score-bar"><div class="score-bar-fill financial" style="width: ${r.financial}%"></div></div>
                </div>
                <div class="score-bar-container">
                    <div class="score-label"><span>Maximally Productive</span><span>${r.productive}%</span></div>
                    <div class="score-bar"><div class="score-bar-fill productive" style="width: ${r.productive}%"></div></div>
                </div>

                <div class="overall-score">
                    <div class="big-score">${r.overall}</div>
                    <span>/ 100<br>Overall Score</span>
                </div>

                ${metricsHTML}

                <div class="rationale">${RATIONALE[r.id] || ''}</div>
                ${legBadges}
                <div style="display:flex;gap:0.5rem;margin-top:0.75rem;">
                    <button type="button" class="btn-lookup" style="font-size:0.78rem;padding:6px 14px;" onclick="openAnalysis(${i})">View Detail</button>
                    <button type="button" class="btn-lookup" style="font-size:0.78rem;padding:6px 14px;background:#0f766e;" onclick="openListingOnePager(${i})">Listing One-Pager</button>
                </div>
            </div>
        `;
        cardsDiv.appendChild(card);
    }

    // ADU Quick-Win callout â€” show when ADU is legally permissible but not in top 3
    const aduResult = results.find(r => r.id === 'adu');
    const aduInTop3 = results.slice(0, 3).some(r => r.id === 'adu');
    if (aduResult && aduResult.legal > 0 && !aduInTop3) {
        const aduIdx = results.indexOf(aduResult);
        const aduEffects = stackLegislationEffects(aduResult.legislation || []);
        const aduMetrics = generateCardMetricsHTML('adu', inp, aduEffects, aduResult);
        const aduLeg = aduResult.legislation && aduResult.legislation.length > 0
            ? `<div class="legislation-badges"><div class="leg-label">Applicable Legislation</div>${aduResult.legislation.map(b => `<span class="legislation-badge clickable" onclick="event.stopPropagation();showLegislationDetail('${b.id}')">${b.name}</span>`).join('')}</div>` : '';
        let aduFeasBadge = '';
        if (aduResult.devMarginPct >= 0.15) aduFeasBadge = '<span style="display:inline-block;font-size:0.7rem;font-weight:700;padding:0.15rem 0.5rem;border-radius:999px;background:#f0fff4;color:#276749;margin-left:0.5rem;">FEASIBLE</span>';
        else if (aduResult.devMarginPct >= 0) aduFeasBadge = '<span style="display:inline-block;font-size:0.7rem;font-weight:700;padding:0.15rem 0.5rem;border-radius:999px;background:#fffff0;color:#b7791f;margin-left:0.5rem;">MARGINAL</span>';
        else aduFeasBadge = '<span style="display:inline-block;font-size:0.7rem;font-weight:700;padding:0.15rem 0.5rem;border-radius:999px;background:#fff5f5;color:#c53030;margin-left:0.5rem;">NOT FEASIBLE</span>';

        const aduCard = document.createElement('div');
        aduCard.className = 'result-card';
        aduCard.style.cssText = 'cursor:pointer;border-left:4px solid #48bb78;margin-top:1rem;';
        aduCard.onclick = function(e) { if (e.target.closest('button')) return; openAnalysis(aduIdx); };
        aduCard.innerHTML = `
            <div class="rank-banner" style="background:linear-gradient(135deg,#276749,#48bb78);color:white;">
                <span class="rank-num" style="background:rgba(255,255,255,0.25);color:white;">ADU</span>
                Quick Win â€” ADU Addition${aduFeasBadge}
            </div>
            <div class="card-body">
                <div class="use-name">${aduResult.icon} ${aduResult.name}</div>
                <div style="font-size:0.82rem;color:var(--text-light);margin-bottom:0.75rem;">
                    Lowest cost, shortest timeline (~13 months), by-right under CA law. Can be added to existing structures without full redevelopment. Zero parking required near transit.
                </div>
                <div class="score-bar-container">
                    <div class="score-label"><span>Legally Permissible</span><span>${aduResult.legal}%</span></div>
                    <div class="score-bar"><div class="score-bar-fill legal" style="width: ${aduResult.legal}%"></div></div>
                </div>
                <div class="score-bar-container">
                    <div class="score-label"><span>Physically Possible</span><span>${aduResult.physical}%</span></div>
                    <div class="score-bar"><div class="score-bar-fill physical" style="width: ${aduResult.physical}%"></div></div>
                </div>
                <div class="score-bar-container">
                    <div class="score-label"><span>Financially Feasible</span><span>${aduResult.financial}%</span></div>
                    <div class="score-bar"><div class="score-bar-fill financial" style="width: ${aduResult.financial}%"></div></div>
                </div>
                <div class="score-bar-container">
                    <div class="score-label"><span>Maximally Productive</span><span>${aduResult.productive}%</span></div>
                    <div class="score-bar"><div class="score-bar-fill productive" style="width: ${aduResult.productive}%"></div></div>
                </div>
                <div class="overall-score">
                    <div class="big-score">${aduResult.overall}</div>
                    <span>/ 100<br>Overall Score</span>
                </div>
                ${aduMetrics}
                <div class="rationale">${RATIONALE['adu'] || ''}</div>
                ${aduLeg}
                <div style="display:flex;gap:0.5rem;margin-top:0.75rem;">
                    <button type="button" class="btn-lookup" style="font-size:0.78rem;padding:6px 14px;" onclick="openAnalysis(${aduIdx})">View Detail</button>
                    <button type="button" class="btn-lookup" style="font-size:0.78rem;padding:6px 14px;background:#0f766e;" onclick="openListingOnePager(${aduIdx})">Listing One-Pager</button>
                </div>
            </div>
        `;
        cardsDiv.appendChild(aduCard);
    }

    // Legislation section â€” collect unique bills from top 3
    const legSection = document.getElementById('legislationSection');
    const allLegislation = new Map();
    for (let i = 0; i < 3 && i < results.length; i++) {
        if (results[i].legislation) {
            for (const bill of results[i].legislation) {
                if (!allLegislation.has(bill.id)) {
                    allLegislation.set(bill.id, bill);
                }
            }
        }
    }

    if (allLegislation.size > 0) {
        legSection.style.display = 'block';
        let legHTML = '<h3>Applicable California Housing Legislation</h3>';
        legHTML += '<div class="legislation-cards">';
        for (const bill of allLegislation.values()) {
            legHTML += `<div class="legislation-card clickable" onclick="showLegislationDetail('${bill.id}')"><strong>${bill.name}</strong><p>${bill.description}</p></div>`;
        }
        legHTML += '</div>';
        legSection.innerHTML = legHTML;
    } else {
        legSection.style.display = 'none';
        legSection.innerHTML = '';
    }

    // Full table â€” split into permissible vs excluded
    const tbody = document.getElementById('detailsBody');
    const excludedBody = document.getElementById('excludedBody');
    tbody.innerHTML = '';
    excludedBody.innerHTML = '';

    const formatCell = (val) => {
        if (val >= 70) return `<span class="pass">${val}%</span>`;
        if (val >= 40) return `<span class="partial">${val}%</span>`;
        if (val > 0)   return `<span class="fail">${val}%</span>`;
        return `<span class="fail">N/A</span>`;
    };

    let permissibleRank = 0;
    let excludedCount = 0;
    const zoningLabel = document.getElementById('zoning').selectedOptions[0].text;

    results.forEach((r) => {
        if (r.legal > 0) {
            permissibleRank++;
            const tr = document.createElement('tr');
            if (permissibleRank <= 3) tr.className = 'top-3';
            tr.innerHTML = `
                <td>${permissibleRank}</td>
                <td>${r.icon} ${r.name}</td>
                <td>${formatCell(r.legal)}</td>
                <td>${formatCell(r.physical)}</td>
                <td>${formatCell(r.financial)}</td>
                <td>${formatCell(r.productive)}</td>
                <td><strong>${r.overall}%</strong></td>
            `;
            tbody.appendChild(tr);
        } else {
            excludedCount++;
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${r.icon} ${r.name}</td>
                <td>${formatCell(r.physical)}</td>
                <td>${formatCell(r.financial)}</td>
                <td>${formatCell(r.productive)}</td>
                <td><span class="fail">Not permitted under ${zoningLabel} zoning</span></td>
            `;
            excludedBody.appendChild(tr);
        }
    });

    const excludedSection = document.getElementById('excludedSection');
    if (excludedCount > 0) {
        excludedSection.style.display = 'block';
        document.getElementById('excludedCount').textContent = excludedCount;
        // Reset toggle state
        document.getElementById('excludedTable').style.display = 'none';
        document.getElementById('toggleExcluded').innerHTML =
            `â–¶ Show <span id="excludedCount">${excludedCount}</span> uses not legally permissible under current zoning`;
    } else {
        excludedSection.style.display = 'none';
    }

    // Show print button
    document.getElementById('btnPrint').classList.add('visible');

    // Scroll to results
    container.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function exportPDF() {
    // Set the print date
    const now = new Date();
    const dateStr = now.toLocaleDateString('en-US', {
        year: 'numeric', month: 'long', day: 'numeric',
        hour: '2-digit', minute: '2-digit'
    });
    document.getElementById('printDate').textContent = `Report generated: ${dateStr}  |  Land to Yield â€” HBU Analysis`;

    // Trigger browser print dialog (user can select "Save as PDF")
    window.print();
}

function toggleExcludedUses() {
    const table = document.getElementById('excludedTable');
    const btn = document.getElementById('toggleExcluded');
    const count = document.getElementById('excludedCount')?.textContent || '0';
    if (table.style.display === 'none') {
        table.style.display = 'block';
        btn.innerHTML = `â–¼ Hide <span id="excludedCount">${count}</span> uses not legally permissible under current zoning`;
    } else {
        table.style.display = 'none';
        btn.innerHTML = `â–¶ Show <span id="excludedCount">${count}</span> uses not legally permissible under current zoning`;
    }
}


// ============================================================
//  DETAILED ANALYSIS MODAL
// ============================================================

// --- Debounce utility for heavy recalc functions ---
// Wraps a function so rapid successive calls only execute after a pause.
// Used on all slider/input recalc handlers to prevent excessive recomputation.
function _debounce(fn, delay) {
    var timer = null;
    return function() {
        var ctx = this, args = arguments;
        clearTimeout(timer);
        timer = setTimeout(function() { fn.apply(ctx, args); }, delay);
    };
}
// Self-debouncing wrapper: replaces a global function with a debounced version.
// The function still syncs slider display values immediately, but delays heavy DOM work.
var _recalcTimers = {};
function _debouncedCall(name, fn, delay) {
    clearTimeout(_recalcTimers[name]);
    _recalcTimers[name] = setTimeout(fn, delay);
}

function fmt(n) {
    return '$' + Math.round(n).toLocaleString();
}

function adjustColor(hex, amount) {
    let r = parseInt(hex.slice(1, 3), 16);
    let g = parseInt(hex.slice(3, 5), 16);
    let b = parseInt(hex.slice(5, 7), 16);
    r = Math.max(0, Math.min(255, r + amount));
    g = Math.max(0, Math.min(255, g + amount));
    b = Math.max(0, Math.min(255, b + amount));
    return '#' + [r, g, b].map(c => c.toString(16).padStart(2, '0')).join('');
}

function generateBudget(useId, inp, effects) {
    const params = BUILDING_PARAMS[useId];
    const baseFAR = FAR_TYPICAL[useId] || 1.0;
    let far = baseFAR;
    if (effects) {
        far = baseFAR * (1 + effects.densityBonus);
        if (effects.minFAR > 0) far = Math.max(far, effects.minFAR);
    }

    const gsf = Math.round(inp.parcelSize * far);
    const nsf = Math.round(gsf * params.eff);
    const stories = Math.max(params.stories, Math.ceil(gsf / (inp.parcelSize * 0.7)));
    const buildingHeight = stories * params.floorH;
    const buildingFootprint = Math.min(Math.round(inp.parcelSize * 0.7), Math.round(gsf / stories));
    const units = params.unitSF ? Math.max(1, Math.floor(nsf / params.unitSF)) : null;

    // Parking (use-specific cost per space)
    const baseParkRatio = params.parkRatio || 0;
    const parkReduction = effects ? effects.parkingReduction : 0;
    let parkingSpaces;
    if (useId === 'parking') {
        parkingSpaces = Math.round(gsf / 350);
    } else if (units) {
        parkingSpaces = Math.max(0, Math.ceil(units * baseParkRatio * (1 - parkReduction)));
    } else {
        parkingSpaces = Math.max(0, Math.ceil(gsf / 1000 * baseParkRatio * (1 - parkReduction)));
    }
    const parkingCostPerSpace = PARKING_COST_MAP[useId] || 35000;

    const landValuePSF = LAND_VALUE_PSF[inp.neighborhood] || 150;
    // ADU is an addition to an existing lot â€” no land acquisition needed
    const landCost = useId === 'adu' ? 0 : inp.parcelSize * landValuePSF;

    // Hard costs â€” Site work broken into sub-components
    const siteWorkBreakdown = calcSiteWorkBreakdown(useId, inp, gsf);
    const siteWork = siteWorkBreakdown.total;
    const demolition = (inp.siteCondition === 'demolition' && useId !== 'adu') ? inp.parcelSize * 12 : 0;
    let buildCostPSF = BUILD_COST_PSF[useId] || 300;
    if (effects && effects.parkingReduction > 0) {
        buildCostPSF *= (1 - effects.parkingReduction * 0.18);
    }
    const construction = gsf * buildCostPSF;
    const parkingCost = parkingSpaces * parkingCostPerSpace;
    const landscaping = Math.round(construction * 0.04);
    const hardContingency = Math.round((siteWork + demolition + construction + parkingCost + landscaping) * 0.07);
    const totalHard = siteWork + demolition + construction + parkingCost + landscaping + hardContingency;

    // Soft costs
    const archEng = Math.round(totalHard * 0.08);
    const permits = Math.round(totalHard * 0.05);
    const legal = Math.round(totalHard * 0.02);
    const financing = Math.round((landCost + totalHard) * 0.045);
    const rentMult = NEIGHBORHOOD_RENT_MULT[inp.neighborhood] || 1.0;
    const revenuePSF = (REVENUE_PSF[useId] || 30) * rentMult;
    const marketing = Math.round(nsf * revenuePSF * 0.02);
    const devFee = Math.round((totalHard + archEng + permits) * 0.04);
    const softCostMult = effects && effects.softCostReduction > 0 ? (1 - effects.softCostReduction * 0.20) : 1;
    const totalSoft = Math.round((archEng + permits + legal + financing + marketing + devFee) * softCostMult);

    const totalDev = landCost + totalHard + totalSoft;

    // Revenue & returns (neighborhood-adjusted)
    const grossRevenue = nsf * revenuePSF;
    const opex = Math.round(grossRevenue * params.opex);
    const noi = grossRevenue - opex;
    const capRate = params.cap || 0.05;
    const stabilizedValue = capRate > 0 ? Math.round(noi / capRate) : 0;
    const yieldOnCost = totalDev > 0 ? noi / totalDev : 0;
    const devMargin = totalDev > 0 ? (stabilizedValue - totalDev) / totalDev : 0;

    return {
        gsf, nsf, revenueNSF: nsf, stories, buildingHeight, buildingFootprint, units, parkingSpaces, far,
        landCost, landValuePSF, siteWork, siteWorkBreakdown, demolition, construction, buildCostPSF, parkingCost, parkingCostPerSpace, landscaping, hardContingency, totalHard,
        archEng, permits, legal, financing, marketing, devFee, totalSoft,
        totalDev,
        grossRevenue, opex, noi, capRate, stabilizedValue, yieldOnCost, devMargin,
        params, revenuePSF,
    };
}

// --- SVG Rendering ---

function generateSitePlanSVG(useId, inp, budget) {
    const w = 320, h = 270;
    const params = budget.params;
    const color = USE_COLORS[useId] || '#3182ce';

    const lotW = inp.frontage || Math.sqrt(inp.parcelSize * 2);
    const lotD = inp.parcelSize / lotW;
    const maxDim = Math.max(lotW, lotD);
    const scale = 170 / maxDim;
    const lw = lotW * scale, ld = lotD * scale;
    const ox = (w - lw) / 2, oy = 25;

    const sf = params.setF * scale, ss = params.setS * scale;
    const bw = Math.max(20, lw - 2 * ss);
    const bd = Math.max(20, ld - sf - ss);
    const bx = ox + ss, by = oy + ss;

    let s = `<svg viewBox="0 0 ${w} ${h}" xmlns="http://www.w3.org/2000/svg" style="background:#fafbfc;">`;
    s += `<defs><pattern id="ht" width="6" height="6" patternUnits="userSpaceOnUse"><path d="M0,6 L6,0" stroke="#ccc" stroke-width="0.5"/></pattern></defs>`;
    // Lot
    s += `<rect x="${ox}" y="${oy}" width="${lw}" height="${ld}" fill="#e8f5e9" stroke="#66bb6a" stroke-width="1.5" rx="2"/>`;
    // Setback hatching (front)
    if (sf > 2) s += `<rect x="${ox}" y="${oy + ld - sf}" width="${lw}" height="${sf}" fill="url(#ht)" opacity="0.5"/>`;
    // Building footprint
    s += `<rect x="${bx}" y="${by}" width="${bw}" height="${bd}" fill="${color}" opacity="0.75" stroke="${color}" stroke-width="1.5" rx="2"/>`;
    s += `<text x="${bx + bw/2}" y="${by + bd/2 - 5}" text-anchor="middle" font-size="10" fill="white" font-weight="600">BUILDING</text>`;
    s += `<text x="${bx + bw/2}" y="${by + bd/2 + 9}" text-anchor="middle" font-size="8" fill="rgba(255,255,255,0.85)">${budget.buildingFootprint.toLocaleString()} SF footprint</text>`;
    // Dimensions
    s += `<text x="${ox + lw/2}" y="${oy - 6}" text-anchor="middle" font-size="9" fill="#666">${Math.round(lotW)}' frontage</text>`;
    // Depth label (right side, rotated)
    s += `<text x="${ox + lw + 14}" y="${oy + ld/2}" text-anchor="middle" font-size="9" fill="#666" transform="rotate(90,${ox + lw + 14},${oy + ld/2})">${Math.round(lotD)}' depth</text>`;
    // Street
    s += `<rect x="${ox - 15}" y="${oy + ld + 8}" width="${lw + 30}" height="${22}" fill="#e2e8f0" rx="3"/>`;
    s += `<text x="${ox + lw/2}" y="${oy + ld + 23}" text-anchor="middle" font-size="9" fill="#718096" font-weight="600">STREET</text>`;
    // North arrow
    s += `<text x="${w - 22}" y="${oy + 12}" text-anchor="middle" font-size="14" fill="#999">&#8593;</text>`;
    s += `<text x="${w - 22}" y="${oy + 24}" text-anchor="middle" font-size="8" fill="#999" font-weight="600">N</text>`;
    // Title
    s += `<text x="${w/2}" y="${h - 6}" text-anchor="middle" font-size="10" fill="#999" font-weight="600">SITE PLAN</text>`;
    s += '</svg>';
    return s;
}

function generateElevationSVG(useId, inp, budget) {
    const w = 320, h = 270;
    const params = budget.params;
    const color = USE_COLORS[useId] || '#3182ce';
    const stories = budget.stories;
    const totalH = budget.buildingHeight;

    const maxSVGH = 190;
    const hScale = Math.min(maxSVGH / totalH, 3.0);
    const buildH = totalH * hScale;
    const buildW = 180;
    const ox = (w - buildW) / 2;
    const groundY = h - 45;
    const roofY = groundY - buildH;

    let s = `<svg viewBox="0 0 ${w} ${h}" xmlns="http://www.w3.org/2000/svg" style="background:#fafbfc;">`;
    // Sky
    s += `<defs><linearGradient id="sky" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#dbeafe"/><stop offset="100%" stop-color="#f0f9ff"/></linearGradient></defs>`;
    s += `<rect x="0" y="0" width="${w}" height="${groundY}" fill="url(#sky)"/>`;
    // Ground
    s += `<rect x="0" y="${groundY}" width="${w}" height="${h - groundY}" fill="#d4edda"/>`;
    s += `<line x1="0" y1="${groundY}" x2="${w}" y2="${groundY}" stroke="#888" stroke-width="1.5"/>`;
    // Building
    s += `<rect x="${ox}" y="${roofY}" width="${buildW}" height="${buildH}" fill="${color}" stroke="${adjustColor(color, -30)}" stroke-width="1.5" rx="2"/>`;
    // Floor lines
    const storyH = buildH / stories;
    for (let i = 1; i < stories; i++) {
        const y = groundY - i * storyH;
        s += `<line x1="${ox}" y1="${y}" x2="${ox + buildW}" y2="${y}" stroke="rgba(255,255,255,0.2)" stroke-width="0.5"/>`;
    }
    // Windows
    const cols = Math.min(7, Math.max(3, Math.floor(buildW / 25)));
    const winW = 12, winH = storyH * 0.45;
    const winSpacing = buildW / (cols + 1);
    for (let fl = 0; fl < stories; fl++) {
        const fy = groundY - (fl + 1) * storyH + (storyH - winH) / 2 + winH * 0.1;
        for (let c = 0; c < cols; c++) {
            const wx = ox + winSpacing * (c + 1) - winW / 2;
            s += `<rect x="${wx}" y="${fy}" width="${winW}" height="${winH}" fill="rgba(255,255,255,0.35)" rx="1"/>`;
        }
    }
    // Ground floor entrance
    if (['retail', 'mixeduse', 'hotel', 'office', 'medical', 'creative'].includes(useId)) {
        const doorW = buildW * 0.12, doorH = storyH * 0.65;
        s += `<rect x="${ox + buildW/2 - doorW/2}" y="${groundY - doorH}" width="${doorW}" height="${doorH}" fill="rgba(255,255,255,0.5)" rx="2"/>`;
    }
    // Roof line
    s += `<line x1="${ox - 4}" y1="${roofY}" x2="${ox + buildW + 4}" y2="${roofY}" stroke="${adjustColor(color, -40)}" stroke-width="2.5"/>`;
    // Height dimension
    const dx = ox + buildW + 18;
    s += `<line x1="${dx}" y1="${groundY}" x2="${dx}" y2="${roofY}" stroke="#999" stroke-width="0.75" stroke-dasharray="3,2"/>`;
    s += `<line x1="${dx - 4}" y1="${groundY}" x2="${dx + 4}" y2="${groundY}" stroke="#999" stroke-width="1"/>`;
    s += `<line x1="${dx - 4}" y1="${roofY}" x2="${dx + 4}" y2="${roofY}" stroke="#999" stroke-width="1"/>`;
    s += `<text x="${dx + 8}" y="${(groundY + roofY) / 2}" font-size="9" fill="#666" font-weight="600">${totalH} ft</text>`;
    s += `<text x="${dx + 8}" y="${(groundY + roofY) / 2 + 13}" font-size="8" fill="#999">${stories} stories</text>`;
    // Width
    s += `<text x="${ox + buildW/2}" y="${groundY + 16}" text-anchor="middle" font-size="9" fill="#666">${Math.round(inp.frontage || Math.sqrt(inp.parcelSize * 2))}' frontage</text>`;
    // Title
    s += `<text x="${w/2}" y="${h - 6}" text-anchor="middle" font-size="10" fill="#999" font-weight="600">BUILDING ELEVATION</text>`;
    s += '</svg>';
    return s;
}

// ============================================================
//  KEY METRICS HELPERS (for result cards)
// ============================================================

function formatCompactDollars(n) {
    if (n >= 1e9) return '$' + (n / 1e9).toFixed(1) + 'B';
    if (n >= 1e6) return '$' + (n / 1e6).toFixed(1) + 'M';
    if (n >= 1e3) return '$' + (n / 1e3).toFixed(0) + 'K';
    return '$' + Math.round(n).toLocaleString();
}

function approxIRR(devMargin, totalMonths) {
    if (totalMonths <= 0 || devMargin <= -1) return 0;
    return Math.pow(1 + devMargin, 12 / totalMonths) - 1;
}

function computeEaseOfExecution(useId, inp, effects, legalScore) {
    let ease = 50; // base score

    // Entitlement timeline â€” shorter is easier
    const tl = TIMELINE_MONTHS[useId] || { entitlement: 6, design: 4, permits: 3, construction: 18, leaseup: 6 };
    const totalMo = tl.entitlement + tl.design + tl.permits + tl.construction + tl.leaseup;
    if (totalMo <= 20) ease += 20;
    else if (totalMo <= 35) ease += 10;
    else if (totalMo >= 55) ease -= 15;
    else if (totalMo >= 45) ease -= 8;

    // Legal permissibility bonus
    if (legalScore >= 80) ease += 12;
    else if (legalScore >= 60) ease += 6;
    else if (legalScore < 30) ease -= 15;

    // Legislation streamlining bonuses
    if (effects && effects.legalOverride) ease += 8;
    if (effects && effects.softCostReduction > 0) ease += Math.round(effects.softCostReduction * 10);
    if (effects && effects.parkingReduction > 0) ease += 5;

    // Site constraints penalties
    if (inp.constHistoric) ease -= 10;
    if (inp.constHillside) ease -= 8;
    if (inp.constCoastal) ease -= 8;
    if (inp.constFault) ease -= 5;
    if (inp.constFlood) ease -= 5;
    if (inp.siteCondition === 'brownfield') ease -= 10;
    if (inp.topography === 'steep') ease -= 7;
    if (inp.utilities === 'none') ease -= 10;
    else if (inp.utilities === 'partial') ease -= 5;

    // Construction complexity â€” high-rise / hotel harder
    const params = BUILDING_PARAMS[useId];
    if (params && params.stories >= 10) ease -= 10;
    else if (params && params.stories >= 6) ease -= 5;

    return Math.max(0, Math.min(100, ease));
}

function computeRiskLevel(useId, inp, legalScore, physicalScore) {
    let riskPts = 0;

    // Site constraint risks
    if (inp.constFlood) riskPts += 12;
    if (inp.constHillside) riskPts += 10;
    if (inp.constHistoric) riskPts += 10;
    if (inp.constFault) riskPts += 12;
    if (inp.constCoastal) riskPts += 8;
    if (inp.siteCondition === 'brownfield') riskPts += 14;
    if (inp.topography === 'steep') riskPts += 8;
    if (inp.utilities === 'none') riskPts += 10;
    else if (inp.utilities === 'partial') riskPts += 5;

    // Score-based risk
    if (legalScore < 40) riskPts += 15;
    else if (legalScore < 60) riskPts += 8;
    if (physicalScore < 40) riskPts += 10;

    // Building complexity
    const params = BUILDING_PARAMS[useId];
    if (params && params.stories >= 10) riskPts += 10;
    else if (params && params.stories >= 6) riskPts += 5;

    // Market risk for certain types
    if (['office', 'retail', 'hotel'].includes(useId)) riskPts += 6;

    if (riskPts >= 35) return { level: 'High', color: '#c53030', bg: '#fff5f5' };
    if (riskPts >= 18) return { level: 'Moderate', color: '#b7791f', bg: '#fffff0' };
    return { level: 'Low', color: '#276749', bg: '#f0fff4' };
}

function generateCardMetricsHTML(useId, inp, effects, result) {
    const budget = generateBudget(useId, inp, effects);
    const tl = TIMELINE_MONTHS[useId] || { entitlement: 6, design: 4, permits: 3, construction: 18, leaseup: 6 };
    const totalMo = tl.entitlement + tl.design + tl.permits + tl.construction + tl.leaseup;

    const irr = approxIRR(budget.devMargin, totalMo);
    const ease = computeEaseOfExecution(useId, inp, effects, result.legal);
    const risk = computeRiskLevel(useId, inp, result.legal, result.physical);

    // Color helpers
    const marginClass = budget.devMargin >= 0.20 ? 'positive' : budget.devMargin >= 0.08 ? 'caution' : 'negative';
    const irrClass = irr >= 0.10 ? 'positive' : irr >= 0.06 ? 'caution' : 'negative';
    const yocClass = budget.yieldOnCost >= 0.065 ? 'positive' : budget.yieldOnCost >= 0.045 ? 'caution' : 'negative';
    const easeColor = ease >= 60 ? '#276749' : ease >= 35 ? '#b7791f' : '#c53030';
    const easeLabel = ease >= 70 ? 'Easy' : ease >= 50 ? 'Moderate' : ease >= 30 ? 'Difficult' : 'Very Hard';

    return `
        <div class="key-metrics">
            <div class="key-metrics-title">Key Metrics</div>
            <div class="metrics-grid">
                <div class="metric-item">
                    <div class="metric-icon-label">ðŸ’° Budget</div>
                    <div class="metric-value">${formatCompactDollars(budget.totalDev)}</div>
                </div>
                <div class="metric-item">
                    <div class="metric-icon-label">ðŸ“… Timeline</div>
                    <div class="metric-value">${totalMo} mo</div>
                </div>
                <div class="metric-item">
                    <div class="metric-icon-label">ðŸ“ˆ Dev Margin</div>
                    <div class="metric-value ${marginClass}">${(budget.devMargin * 100).toFixed(0)}%</div>
                </div>
                <div class="metric-item">
                    <div class="metric-icon-label">ðŸŽ¯ Est. IRR</div>
                    <div class="metric-value ${irrClass}">${(irr * 100).toFixed(1)}%</div>
                </div>
                <div class="metric-item">
                    <div class="metric-icon-label">ðŸ—ï¸ Yield on Cost</div>
                    <div class="metric-value ${yocClass}">${(budget.yieldOnCost * 100).toFixed(1)}%</div>
                </div>
                <div class="metric-item">
                    <div class="metric-icon-label">âš¡ Ease of Execution</div>
                    <div class="metric-value" style="font-size:0.78rem;color:${easeColor}">${ease} â€” ${easeLabel}</div>
                    <div class="ease-bar-bg"><div class="ease-bar-fill" style="width:${ease}%;background:${easeColor}"></div></div>
                </div>
                <div class="metric-item" style="grid-column:span 2">
                    <div class="metric-icon-label">âš ï¸ Risk Level</div>
                    <span class="risk-badge" style="color:${risk.color};background:${risk.bg}">
                        <span class="risk-dot" style="background:${risk.color}"></span>
                        ${risk.level}
                    </span>
                </div>
            </div>
        </div>`;
}

function showLegislationDetail(billId) {
    const bill = CA_HOUSING_LEGISLATION.find(b => b.id === billId);
    if (!bill) return;

    const modal = document.getElementById('legDetailModal');
    modal.innerHTML = `<div class="leg-detail-content">
        <div class="leg-detail-header">
            <h3>${bill.name}</h3>
            <button type="button" class="leg-detail-close" onclick="closeLegislationDetail()">&times;</button>
        </div>
        <div class="leg-detail-body">
            <p class="leg-summary">${bill.description}</p>
            <p class="leg-full">${bill.detail || bill.description}</p>
        </div>
    </div>`;
    modal.style.display = 'flex';
}

function closeLegislationDetail() {
    document.getElementById('legDetailModal').style.display = 'none';
}

let sb79Map = null;
let sb79Layers = { tier1: null, tier2: null, zones: null, property: null };
let sb79LayerState = { tier1: true, tier2: true, zones: true, property: true };
let sb79StationRadii = {};

function initSB79Map(lat, lon) {
    const mapEl = document.getElementById('sb79Map');
    if (!mapEl) return;

    // Destroy existing map
    if (sb79Map) { sb79Map.remove(); sb79Map = null; }
    sb79StationRadii = {};

    sb79Map = L.map('sb79Map').setView([lat, lon], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
        maxZoom: 18,
    }).addTo(sb79Map);

    // Layer groups
    sb79Layers.tier1 = L.layerGroup().addTo(sb79Map);
    sb79Layers.tier2 = L.layerGroup().addTo(sb79Map);
    sb79Layers.zones = L.layerGroup().addTo(sb79Map);
    sb79Layers.property = L.layerGroup().addTo(sb79Map);

    // Property marker
    const propIcon = L.divIcon({
        html: '<div style="background:#e53e3e;width:16px;height:16px;border-radius:50%;border:3px solid #fff;box-shadow:0 2px 6px rgba(0,0,0,0.4);"></div>',
        iconSize: [16, 16], iconAnchor: [8, 8], className: '',
    });
    L.marker([lat, lon], { icon: propIcon })
        .bindPopup('<strong>Your Property</strong>')
        .addTo(sb79Layers.property);

    // Station markers
    const seenCoords = new Set();
    METRO_STATIONS.forEach((s, idx) => {
        const key = `${s.lat.toFixed(4)},${s.lon.toFixed(4)},${s.line}`;
        if (seenCoords.has(key)) return;
        seenCoords.add(key);

        const color = LINE_COLORS[s.line] || '#718096';
        const icon = L.divIcon({
            html: `<div style="background:${color};width:10px;height:10px;border-radius:50%;border:2px solid #fff;box-shadow:0 1px 3px rgba(0,0,0,0.3);"></div>`,
            iconSize: [10, 10], iconAnchor: [5, 5], className: '',
        });
        const tierData = SB79_TIERS[s.tier];
        const lineName = LINE_LABELS[s.line] || s.line;
        const popupHtml = `<div class="station-popup">
            <div class="popup-title">${s.name}</div>
            <div class="popup-line">${lineName} &mdash; ${s.serviceType} &mdash; ${tierData.label}</div>
            <div class="popup-allowances">
                <span><strong>SB 79 Allowances:</strong></span>
                <span>Height: ${tierData.height} ft | Density: ${tierData.density} du/ac</span>
                <span>FAR: ${tierData.far} | Parking: 0 (inner), 0.5/unit (outer)</span>
            </div>
        </div>`;
        const marker = L.marker([s.lat, s.lon], { icon })
            .bindPopup(popupHtml)
            .on('click', () => { showStationRadii(idx); });

        const layerGroup = s.tier === 1 ? sb79Layers.tier1 : sb79Layers.tier2;
        marker.addTo(layerGroup);
    });

    // Draw radii for nearest qualifying station
    const eligibility = detectSB79Eligibility(lat, lon);
    if (eligibility.eligible && eligibility.nearestIdx >= 0) {
        drawSB79Radii(METRO_STATIONS[eligibility.nearestIdx]);
    }

    // Native DOM click handler for zone identification (bypasses all Leaflet layers)
    attachZoneClickHandler(sb79Map);

    // Render legend
    renderMapLegend();

    // Sync layer toggle button states
    document.querySelectorAll('#mapControls .layer-btn').forEach(btn => btn.classList.add('active'));
    sb79LayerState = { tier1: true, tier2: true, zones: true, property: true };

    // Force map to re-render tiles after display
    setTimeout(() => { if (sb79Map) sb79Map.invalidateSize(); }, 200);
}

// ---- ZONE CLICK SYSTEM (rebuilt from scratch) ----
// All zone circles are PURE VISUAL DECORATION (no Leaflet event handling).
// Zone identification uses a native DOM click listener on the map container,
// which cannot be blocked by SVG overlays or Leaflet layer event handling.

function showZonePopup(mapInstance, latlng, station, dist) {
    var tierData = SB79_TIERS[station.tier];
    var distFeet = Math.round(dist * 5280);
    var zoneName, zoneColor, zoneDetail;

    if (dist <= 0.038) {
        zoneName = '200ft Adjacent Zone';
        zoneColor = '#553c9a';
        zoneDetail = tierData.label + ' â€” Full tier benefits, zero parking';
    } else if (dist <= 0.25) {
        zoneName = '1/4 Mile Inner Zone';
        zoneColor = '#2b6cb0';
        zoneDetail = tierData.label + ' â€” Full tier benefits, zero parking';
    } else {
        zoneName = '1/2 Mile Outer Zone';
        zoneColor = '#4a5568';
        zoneDetail = tierData.label + ' â€” 65ft height, 3.25 FAR, 0.5 parking/unit';
    }

    L.popup()
        .setLatLng(latlng)
        .setContent(
            '<strong>' + station.name + '</strong><br>' +
            '<strong style="font-size:1.1em;color:' + zoneColor + ';">' + zoneName + '</strong><br>' +
            '<span style="font-size:0.85em;color:#666;">' + zoneDetail + '</span><br>' +
            '<span style="font-size:0.8em;color:#999;">' + distFeet.toLocaleString() + ' ft from station (' + station.serviceType + ')</span>'
        )
        .openOn(mapInstance);
}

function attachZoneClickHandler(mapInstance) {
    // Native DOM click listener â€” bypasses Leaflet's event system entirely.
    // Cannot be blocked by SVG overlays, circle layers, or bubblingMouseEvents.
    mapInstance.getContainer().addEventListener('click', function(evt) {
        // Small delay to let Leaflet process its own events first (marker popups etc.)
        setTimeout(function() {
            // If a Leaflet popup is already open from a marker click, don't override it
            if (mapInstance._popup && mapInstance._popup.isOpen && mapInstance._popup.isOpen()) {
                // Check if this popup was opened by a station marker (has station-popup class)
                var content = mapInstance._popup.getContent ? mapInstance._popup.getContent() : '';
                if (typeof content === 'string' && content.indexOf('station-popup') >= 0) return;
                if (typeof content === 'string' && content.indexOf('Your Property') >= 0) return;
            }

            // Convert pixel click position to lat/lng
            var rect = mapInstance.getContainer().getBoundingClientRect();
            var x = evt.clientX - rect.left;
            var y = evt.clientY - rect.top;
            var latlng = mapInstance.containerPointToLatLng(L.point(x, y));

            // Find nearest station
            var nearestStation = null;
            var nearestDist = Infinity;
            for (var i = 0; i < METRO_STATIONS.length; i++) {
                var s = METRO_STATIONS[i];
                var d = haversine(latlng.lat, latlng.lng, s.lat, s.lon);
                if (d < nearestDist) {
                    nearestDist = d;
                    nearestStation = s;
                }
            }

            // Only show zone popup if click is within 1/2 mile of a station
            if (nearestStation && nearestDist <= 0.50) {
                showZonePopup(mapInstance, latlng, nearestStation, nearestDist);
            }
        }, 50);
    });
}

function drawSB79Radii(station) {
    if (!sb79Layers.zones) return;
    var tierColor = station.tier === 1 ? '#805ad5' : '#3182ce';

    // ALL circles are purely visual â€” no click handling, no interactive flag
    // 1/2 mile = ~805m (outer)
    L.circle([station.lat, station.lon], {
        radius: 805, color: tierColor, weight: 2.5, opacity: 0.8,
        fillColor: tierColor, fillOpacity: 0.08,
        interactive: false, dashArray: '12,8',
    }).addTo(sb79Layers.zones);

    // 1/4 mile = ~402m (inner)
    L.circle([station.lat, station.lon], {
        radius: 402, color: tierColor, weight: 2.5, opacity: 0.8,
        fillColor: tierColor, fillOpacity: 0.12,
        interactive: false, dashArray: '8,6',
    }).addTo(sb79Layers.zones);

    // 200ft = ~61m (adjacent)
    L.circle([station.lat, station.lon], {
        radius: 61, color: tierColor, weight: 2.5, opacity: 0.9,
        fillColor: tierColor, fillOpacity: 0.20,
        interactive: false, dashArray: '4,4',
    }).addTo(sb79Layers.zones);
}

function showStationRadii(stationIdx) {
    const station = METRO_STATIONS[stationIdx];
    if (!station || !sb79Layers.zones) return;
    const key = `${station.lat},${station.lon}`;
    if (sb79StationRadii[key]) return; // already drawn
    sb79StationRadii[key] = true;
    drawSB79Radii(station);
}

function toggleMapLayer(layerName) {
    if (!sb79Map || !sb79Layers[layerName]) return;
    sb79LayerState[layerName] = !sb79LayerState[layerName];
    if (sb79LayerState[layerName]) {
        sb79Map.addLayer(sb79Layers[layerName]);
    } else {
        sb79Map.removeLayer(sb79Layers[layerName]);
    }
    // Update button state
    const btns = document.querySelectorAll('#mapControls .layer-btn');
    const labels = { tier1: 'Tier 1', tier2: 'Tier 2', zones: 'SB 79 Zones', property: 'Your Property' };
    btns.forEach(btn => {
        for (const [k, v] of Object.entries(labels)) {
            if (btn.textContent.includes(v)) {
                btn.classList.toggle('active', sb79LayerState[k]);
            }
        }
    });
}

function renderMapLegend() {
    const el = document.getElementById('mapLegend');
    if (!el) return;
    el.innerHTML = `
        <div class="legend-item"><span class="legend-dot" style="background:#e53e3e;"></span> Red/B Line</div>
        <div class="legend-item"><span class="legend-dot" style="background:#805ad5;"></span> Purple/D Line</div>
        <div class="legend-item"><span class="legend-dot" style="background:#3182ce;"></span> Blue/A Line</div>
        <div class="legend-item"><span class="legend-dot" style="background:#d69e2e;"></span> Expo/E Line</div>
        <div class="legend-item"><span class="legend-dot" style="background:#b7791f;"></span> Gold/L Line</div>
        <div class="legend-item"><span class="legend-dot" style="background:#38a169;"></span> Green/C Line</div>
        <div class="legend-item"><span class="legend-dot" style="background:#00bcd4;"></span> K Line</div>
        <div class="legend-item"><span class="legend-dot" style="background:#ed64a6;"></span> Regional Connector</div>
        <div class="legend-item"><span class="legend-dot" style="background:#e53e3e;border:2px solid #999;width:8px;height:8px;"></span> Metrolink</div>
        <div class="legend-item"><span class="legend-line" style="background:#805ad5;"></span> Tier 1 â€” Heavy Rail (Red/B, Purple/D)</div>
        <div class="legend-item"><span class="legend-line" style="background:#3182ce;"></span> Tier 2 â€” Light Rail / Commuter Rail</div>
        <div class="legend-item"><span class="legend-dot" style="background:#e53e3e;width:12px;height:12px;border:2px solid #fff;box-shadow:0 0 3px rgba(0,0,0,0.3);"></span> Your Property</div>
    `;
}

function renderSB79Eligibility(eligibility) {
    const el = document.getElementById('sb79Eligibility');
    if (!el) return;
    if (!eligibility || !eligibility.eligible) {
        el.style.display = 'none';
        return;
    }
    const a = eligibility.allowances;
    const tierClass = eligibility.tier === 1 ? 'tier1' : 'tier2';
    const zoneClass = eligibility.zone;
    el.style.display = 'block';
    el.innerHTML = `
        <h3>SB 79 Eligibility â€” Your Property</h3>
        <p style="font-size:0.85rem;color:var(--text-light);margin-bottom:0.75rem;">
            <span class="tier-badge ${tierClass}">${eligibility.tierLabel}</span>
            <span class="zone-badge ${zoneClass}">${eligibility.zoneLabel}</span>
            &mdash; ${eligibility.distMiles.toFixed(2)} mi from <strong>${eligibility.station.name}</strong>
            (${LINE_LABELS[eligibility.station.line] || eligibility.station.line})
        </p>
        <div class="sb79-grid">
            <div class="sb79-stat"><div class="stat-label">Max Height</div><div class="stat-value">${a.height} ft</div></div>
            <div class="sb79-stat"><div class="stat-label">Max Density</div><div class="stat-value">${a.density} du/ac</div></div>
            <div class="sb79-stat"><div class="stat-label">Max FAR</div><div class="stat-value">${a.far}</div></div>
            <div class="sb79-stat"><div class="stat-label">Parking Req</div><div class="stat-value">${a.parking === 0 ? 'None' : a.parking + '/unit'}</div></div>
            <div class="sb79-stat"><div class="stat-label">Affordable Req</div><div class="stat-value">15%</div></div>
            <div class="sb79-stat"><div class="stat-label">Effective Date</div><div class="stat-value">Jul 2026</div></div>
        </div>
    `;
}

// ============================================================
//  UNIT MIX PROFILES
// ============================================================
const UNIT_MIX_PROFILES = {
    dtla:         { studio: 0.30, br1: 0.40, br2: 0.25, br3: 0.05 },
    hollywood:    { studio: 0.25, br1: 0.40, br2: 0.28, br3: 0.07 },
    koreatown:    { studio: 0.22, br1: 0.38, br2: 0.30, br3: 0.10 },
    westside:     { studio: 0.15, br1: 0.35, br2: 0.35, br3: 0.15 },
    santamonica:  { studio: 0.18, br1: 0.37, br2: 0.32, br3: 0.13 },
    beverly:      { studio: 0.12, br1: 0.30, br2: 0.38, br3: 0.20 },
    midcity:      { studio: 0.20, br1: 0.38, br2: 0.30, br3: 0.12 },
    southla:      { studio: 0.10, br1: 0.28, br2: 0.38, br3: 0.24 },
    valleyeast:   { studio: 0.10, br1: 0.30, br2: 0.35, br3: 0.25 },
    valleywest:   { studio: 0.12, br1: 0.30, br2: 0.35, br3: 0.23 },
    silverlake:   { studio: 0.22, br1: 0.40, br2: 0.28, br3: 0.10 },
    highland:     { studio: 0.15, br1: 0.35, br2: 0.32, br3: 0.18 },
    venice:       { studio: 0.18, br1: 0.38, br2: 0.32, br3: 0.12 },
    culver:       { studio: 0.18, br1: 0.38, br2: 0.30, br3: 0.14 },
    exposition:   { studio: 0.20, br1: 0.35, br2: 0.30, br3: 0.15 },
    southbay:     { studio: 0.10, br1: 0.28, br2: 0.38, br3: 0.24 },
    harbor:       { studio: 0.08, br1: 0.25, br2: 0.40, br3: 0.27 },
    boyleheights: { studio: 0.10, br1: 0.30, br2: 0.35, br3: 0.25 },
};

// ============================================================
//  CSI DIVISIONS + BREAKDOWN
// ============================================================
const CSI_DIVISIONS = [
    { div: '01', name: 'General Requirements', basePct: 0.08 },
    { div: '02', name: 'Existing Conditions', basePct: 0.02 },
    { div: '03', name: 'Concrete', basePct: 0.10 },
    { div: '04', name: 'Masonry', basePct: 0.02 },
    { div: '05', name: 'Metals', basePct: 0.08 },
    { div: '06', name: 'Wood, Plastics & Composites', basePct: 0.10 },
    { div: '07', name: 'Thermal & Moisture Protection', basePct: 0.06 },
    { div: '08', name: 'Openings', basePct: 0.06 },
    { div: '09', name: 'Finishes', basePct: 0.12 },
    { div: '10', name: 'Specialties', basePct: 0.02 },
    { div: '11', name: 'Equipment', basePct: 0.02 },
    { div: '12', name: 'Furnishings', basePct: 0.01 },
    { div: '13', name: 'Special Construction', basePct: 0.01 },
    { div: '14', name: 'Conveying Equipment', basePct: 0.03 },
    { div: '21', name: 'Fire Suppression', basePct: 0.03 },
    { div: '22', name: 'Plumbing', basePct: 0.06 },
    { div: '23', name: 'HVAC', basePct: 0.08 },
    { div: '26', name: 'Electrical', basePct: 0.08 },
    { div: '27', name: 'Communications', basePct: 0.01 },
    { div: '28', name: 'Electronic Safety & Security', basePct: 0.01 },
];

function computeCSIBreakdown(useId, computed, constructionType, stories) {
    var totalConstruction = computed.construction || 0;
    var gsf = computed.gsf || 1;
    var divisions = [];
    for (var i = 0; i < CSI_DIVISIONS.length; i++) {
        var d = CSI_DIVISIONS[i];
        var pct = d.basePct;
        if (constructionType === 'I-A' || constructionType === 'I-B') {
            if (d.div === '03') pct = 0.18; if (d.div === '05') pct = 0.14;
            if (d.div === '06') pct = 0.02; if (d.div === '07') pct = 0.07;
            if (d.div === '14') pct = 0.05; if (d.div === '01') pct = 0.10;
        } else if (constructionType === 'II-A' || constructionType === 'II-B') {
            if (d.div === '03') pct = 0.14; if (d.div === '05') pct = 0.12; if (d.div === '06') pct = 0.04;
        } else if (constructionType === 'III-A') {
            if (d.div === '03') pct = 0.12; if (d.div === '06') pct = 0.11;
        } else if (constructionType === 'V-A' || constructionType === 'V-B') {
            if (d.div === '03') pct = 0.06; if (d.div === '05') pct = 0.04; if (d.div === '06') pct = 0.16;
        }
        if (stories >= 8) {
            if (d.div === '14') pct = Math.max(pct, 0.05);
            if (d.div === '21') pct = Math.max(pct, 0.04);
            if (d.div === '23') pct = Math.max(pct, 0.09);
        }
        if (stories <= 3 && d.div === '14') pct = 0;
        if (useId === 'hotel') { if (d.div === '09') pct = 0.14; if (d.div === '11') pct = 0.04; if (d.div === '12') pct = 0.03; }
        if (useId === 'office') { if (d.div === '23') pct = 0.10; if (d.div === '26') pct = 0.10; if (d.div === '09') pct = 0.10; }
        if (useId === 'retail' || useId === 'mixeduse') { if (d.div === '08') pct = 0.08; }
        if (useId === 'industrial' || useId === 'warehouse') { if (d.div === '09') pct = 0.04; if (d.div === '03') pct = 0.15; if (d.div === '05') pct = 0.18; if (d.div === '06') pct = 0.01; }
        if (useId === 'senior') { if (d.div === '14') pct = Math.max(pct, 0.04); if (d.div === '11') pct = 0.03; }
        var cost = Math.round(totalConstruction * pct);
        divisions.push({ div: d.div, name: d.name, pct: pct, cost: cost, costPSF: cost / gsf });
    }
    var allocatedTotal = divisions.reduce(function(s, d) { return s + d.cost; }, 0);
    if (allocatedTotal > 0 && Math.abs(allocatedTotal - totalConstruction) > 100) {
        var scale = totalConstruction / allocatedTotal;
        for (var j = 0; j < divisions.length; j++) {
            divisions[j].cost = Math.round(divisions[j].cost * scale);
            divisions[j].pct = divisions[j].pct * scale;
            divisions[j].costPSF = divisions[j].cost / gsf;
        }
    }
    return divisions;
}

// ============================================================
//  RISKS HTML GENERATOR
// ============================================================
function generateRisksHTML(useId, inp) {
    const risks = [];
    if (inp.constFlood) risks.push({ t: 'Flood Zone', d: 'Site is in a flood zone. Flood insurance required, ground-floor design constraints, potential FEMA elevation requirements.' });
    if (inp.constHillside) risks.push({ t: 'Hillside Ordinance', d: 'Hillside development restrictions limit grading, height, and density. Extended entitlement timeline expected.' });
    if (inp.constHistoric) risks.push({ t: 'Historic Overlay', d: 'Historic preservation review required. May limit demolition, facade changes, and building height.' });
    if (inp.constFault) risks.push({ t: 'Fault Zone', d: 'Alquist-Priolo fault zone â€” geotechnical study required. Structural reinforcement may increase costs 10-20%.' });
    if (inp.constCoastal) risks.push({ t: 'Coastal Zone', d: 'California Coastal Commission review required. Height, view corridor, and public access conditions likely.' });
    if (inp.siteCondition === 'brownfield') risks.push({ t: 'Environmental Contamination', d: 'Phase II ESA recommended. Remediation costs could range from $50K to $500K+ depending on contamination type.' });
    if (inp.siteCondition === 'demolition') risks.push({ t: 'Demolition Required', d: 'Existing structure requires demolition. Asbestos/lead survey required. Demo costs included in budget.' });
    if (inp.utilities === 'partial') risks.push({ t: 'Utility Upgrades Needed', d: 'Utility infrastructure requires upgrades. Coordinate with LADWP and LASAN. May add $50-200K.' });
    if (inp.utilities === 'none') risks.push({ t: 'No Utilities Available', d: 'Significant utility extension required. May add $200K-$1M+ and 6-12 months to timeline.' });
    if (inp.topography === 'steep') risks.push({ t: 'Steep Topography', d: 'Significant grading and retaining walls required. May add 15-30% to foundation costs.' });
    if (['multifamily_high', 'hotel'].includes(useId)) risks.push({ t: 'Construction Cost Escalation', d: 'High-rise construction is sensitive to material/labor cost changes. Lock in GMP contract early.' });
    if (useId === 'retail') risks.push({ t: 'Retail Market Uncertainty', d: 'Evolving retail landscape. Consider flexible ground-floor design for alternative uses.' });
    if (useId === 'office') risks.push({ t: 'Office Demand Shift', d: 'Remote work trends have shifted office demand. Consider amenity-rich design and flexible leases.' });
    risks.push({ t: 'Entitlement Risk', d: 'LA entitlement timelines are subject to CEQA review, community opposition, and council discretion. Budget for delays.' });
    risks.push({ t: 'Interest Rate Sensitivity', d: 'Construction and permanent financing costs fluctuate. Model scenarios at current rate +/- 100 bps.' });
    let html = '<div class="analysis-section"><h3>Key Risks &amp; Considerations</h3>';
    html += risks.map(r => `<div class="risk-card"><strong>${r.t}</strong><p>${r.d}</p></div>`).join('');
    html += '</div>';
    return html;
}

// ============================================================
//  EDITABLE ANALYSIS MODAL â€” STATE, COMPUTE, RENDER
// ============================================================

let analysisState = { resultIndex: null, useId: null, inp: null, effects: null, legislation: null, assumptions: null };

function getDefaultAssumptions(useId, inp, effects) {
    const params = BUILDING_PARAMS[useId];
    const baseFAR = FAR_TYPICAL[useId] || 1.0;
    let far = baseFAR;
    if (effects) { far = baseFAR * (1 + effects.densityBonus); if (effects.minFAR > 0) far = Math.max(far, effects.minFAR); }
    const gsf = Math.round(inp.parcelSize * far);
    const nsf = Math.round(gsf * params.eff);
    const hasUnits = !!params.unitSF;
    const unitsOrNSF = hasUnits ? Math.max(1, Math.floor(nsf / params.unitSF)) : nsf;
    const baseParkRatio = params.parkRatio || 0;
    const parkReduction = effects ? effects.parkingReduction : 0;
    let parkingSpaces;
    if (useId === 'parking') { parkingSpaces = Math.round(gsf / 350); }
    else if (hasUnits) { parkingSpaces = Math.max(0, Math.ceil(unitsOrNSF * baseParkRatio * (1 - parkReduction))); }
    else { parkingSpaces = Math.max(0, Math.ceil(gsf / 1000 * baseParkRatio * (1 - parkReduction))); }
    let buildCostPSF = BUILD_COST_PSF[useId] || 300;
    if (effects && effects.parkingReduction > 0) { buildCostPSF = Math.round(buildCostPSF * (1 - effects.parkingReduction * 0.18)); }
    const rentMult = NEIGHBORHOOD_RENT_MULT[inp.neighborhood] || 1.0;
    var swBreakdown = calcSiteWorkBreakdown(useId, inp, gsf);
    var siteWorkTotalPSF = inp.parcelSize > 0 ? Math.round(swBreakdown.total / inp.parcelSize) : 18;
    return {
        far: parseFloat(far.toFixed(2)), unitsOrNSF, parkingSpaces,
        buildCostPSF: Math.round(buildCostPSF),
        landValuePSF: LAND_VALUE_PSF[inp.neighborhood] || 150,
        revenuePSF: Math.round((REVENUE_PSF[useId] || 30) * rentMult),
        opexPct: Math.round(params.opex * 100),
        capRatePct: parseFloat((params.cap * 100).toFixed(1)),
        parkingCostPerSpace: PARKING_COST_MAP[useId] || 35000,
        siteWorkPSF: siteWorkTotalPSF, siteWorkTotal: swBreakdown.total, siteWorkOverride: null,
        parcelSize: inp.parcelSize || 10000,
        coveragePct: 70, efficiencyPct: Math.round(params.eff * 100),
        setbackFront: params.setF, setbackSide: params.setS, setbackRear: params.setS,
        amenityPct: 0, parkingType: 'surface',
        unitMixStudio: Math.round(((UNIT_MIX_PROFILES[inp.neighborhood] || UNIT_MIX_PROFILES.dtla).studio) * 100),
        unitMixBr1: Math.round(((UNIT_MIX_PROFILES[inp.neighborhood] || UNIT_MIX_PROFILES.dtla).br1) * 100),
        unitMixBr2: Math.round(((UNIT_MIX_PROFILES[inp.neighborhood] || UNIT_MIX_PROFILES.dtla).br2) * 100),
    };
}

function computeFromAssumptions(useId, inp, assumptions, effects) {
    const params = BUILDING_PARAMS[useId];
    const far = assumptions.far;
    const gsf = Math.round(inp.parcelSize * far);
    const effPct = (assumptions.efficiencyPct != null ? assumptions.efficiencyPct : Math.round(params.eff * 100)) / 100;
    const amenityPct = (assumptions.amenityPct || 0) / 100;
    const nsf = Math.round(gsf * effPct * (1 - amenityPct));
    const amenitySF = Math.round(gsf * effPct * amenityPct);
    const setF = assumptions.setbackFront != null ? assumptions.setbackFront : params.setF;
    const setS = assumptions.setbackSide != null ? assumptions.setbackSide : params.setS;
    const setR = assumptions.setbackRear != null ? assumptions.setbackRear : params.setS;
    const frontage = inp.frontage || Math.sqrt(inp.parcelSize * 2);
    const depth = inp.parcelSize / frontage;
    const buildableW = Math.max(0, frontage - 2 * setS);
    const buildableD = Math.max(0, depth - setF - setR);
    const buildableArea = Math.round(buildableW * buildableD);
    const covPct = (assumptions.coveragePct != null ? assumptions.coveragePct : 70) / 100;
    const maxFootprint = Math.min(Math.round(inp.parcelSize * covPct), buildableArea);
    const stories = Math.max(params.stories, Math.ceil(gsf / Math.max(maxFootprint, 1)));
    const buildingHeight = stories * params.floorH;
    const buildingFootprint = Math.min(maxFootprint, Math.round(gsf / stories));
    const hasUnits = !!params.unitSF;
    const units = hasUnits ? assumptions.unitsOrNSF : null;
    const revenueNSF = hasUnits ? assumptions.unitsOrNSF * params.unitSF : assumptions.unitsOrNSF;
    const parkingSpaces = assumptions.parkingSpaces;
    const landValuePSF = assumptions.landValuePSF;
    const landCost = useId === 'adu' ? 0 : inp.parcelSize * landValuePSF;
    let siteWorkBreakdown;
    if (assumptions.siteWorkOverride !== undefined && assumptions.siteWorkOverride !== null) {
        siteWorkBreakdown = { total: assumptions.siteWorkOverride, grading: 0, utilities: 0, erosion: 0, soilPrep: 0, clearing: 0, isOverride: true };
    } else { siteWorkBreakdown = calcSiteWorkBreakdown(useId, inp, gsf, assumptions.siteWorkRates); }
    const siteWork = siteWorkBreakdown.total;
    const demolition = (inp.siteCondition === 'demolition' && useId !== 'adu') ? inp.parcelSize * 12 : 0;
    const buildCostPSF = assumptions.buildCostPSF;
    const construction = gsf * buildCostPSF;
    const parkingCost = parkingSpaces * assumptions.parkingCostPerSpace;
    const landscaping = Math.round(construction * 0.04);
    const hardContingency = Math.round((siteWork + demolition + construction + parkingCost + landscaping) * 0.07);
    const totalHard = siteWork + demolition + construction + parkingCost + landscaping + hardContingency;
    const archEng = Math.round(totalHard * 0.08);
    const permits = Math.round(totalHard * 0.05);
    const legal = Math.round(totalHard * 0.02);
    const financing = Math.round((landCost + totalHard) * 0.045);
    const revenuePSF = assumptions.revenuePSF;
    const marketing = Math.round(revenueNSF * revenuePSF * 0.02);
    const devFee = Math.round((totalHard + archEng + permits) * 0.04);
    const softCostMult = effects && effects.softCostReduction > 0 ? (1 - effects.softCostReduction * 0.20) : 1;
    const totalSoft = Math.round((archEng + permits + legal + financing + marketing + devFee) * softCostMult);
    const totalDev = landCost + totalHard + totalSoft;
    const grossRevenue = revenueNSF * revenuePSF;
    const opexRate = assumptions.opexPct / 100;
    const opex = Math.round(grossRevenue * opexRate);
    const noi = grossRevenue - opex;
    const capRate = assumptions.capRatePct / 100;
    const stabilizedValue = capRate > 0 ? Math.round(noi / capRate) : 0;
    const yieldOnCost = totalDev > 0 ? noi / totalDev : 0;
    const devMargin = totalDev > 0 ? (stabilizedValue - totalDev) / totalDev : 0;
    return {
        gsf, nsf, revenueNSF, stories, buildingHeight, buildingFootprint, units, parkingSpaces, far,
        landCost, siteWork, siteWorkBreakdown, demolition, construction, buildCostPSF, parkingCost, landscaping, hardContingency, totalHard,
        archEng, permits, legal, financing, marketing, devFee, totalSoft, totalDev,
        grossRevenue, opex, noi, capRate, stabilizedValue, yieldOnCost, devMargin,
        params, landValuePSF, revenuePSF, parkingCostPerSpace: assumptions.parkingCostPerSpace,
        amenitySF, buildableArea, setbacks: { front: setF, side: setS, rear: setR },
        coveragePct: covPct * 100, efficiencyPct: effPct * 100,
    };
}

function renderProgramDisplay(computed) {
    return `<div class="program-grid">
        <div class="program-item"><div class="program-value">${computed.stories}</div><div class="program-label">Stories / ${computed.buildingHeight} ft</div></div>
        <div class="program-item"><div class="program-value">${computed.gsf.toLocaleString()}</div><div class="program-label">Gross SF</div></div>
        ${computed.units
            ? `<div class="program-item"><div class="program-value">${computed.units}</div><div class="program-label">Units</div></div>`
            : `<div class="program-item"><div class="program-value">${computed.nsf.toLocaleString()}</div><div class="program-label">Net Leasable SF</div></div>`}
        <div class="program-item"><div class="program-value">${computed.parkingSpaces}</div><div class="program-label">Parking Spaces</div></div>
    </div>`;
}

function renderAssumptions(assumptions, hasUnits) {
    return `<div class="assumptions-panel"><h4>Key Assumptions (editable)</h4><div class="assumptions-grid">
        <div class="assumption-field"><label>FAR</label><input type="number" class="assumption-input" id="a-far" step="0.1" min="0.1" max="20" value="${assumptions.far}" oninput="recalcAnalysis()"></div>
        <div class="assumption-field"><label>${hasUnits ? 'Units' : 'Net Leasable SF'}</label><input type="number" class="assumption-input" id="a-unitsOrNSF" step="1" min="1" value="${assumptions.unitsOrNSF}" oninput="recalcAnalysis()"></div>
        <div class="assumption-field"><label>Parking Spaces</label><input type="number" class="assumption-input" id="a-parkingSpaces" step="1" min="0" value="${assumptions.parkingSpaces}" oninput="recalcAnalysis()"></div>
        <div class="assumption-field"><label>Build Cost $/SF</label><input type="number" class="assumption-input" id="a-buildCostPSF" step="5" min="10" value="${assumptions.buildCostPSF}" oninput="recalcAnalysis()"></div>
        <div class="assumption-field"><label>Land Value $/SF</label><input type="number" class="assumption-input" id="a-landValuePSF" step="5" min="1" value="${assumptions.landValuePSF}" oninput="recalcAnalysis()"></div>
        <div class="assumption-field"><label>Revenue $/SF</label><input type="number" class="assumption-input" id="a-revenuePSF" step="1" min="1" value="${assumptions.revenuePSF}" oninput="recalcAnalysis()"></div>
        <div class="assumption-field"><label>OpEx %</label><input type="number" class="assumption-input" id="a-opexPct" step="1" min="0" max="100" value="${assumptions.opexPct}" oninput="recalcAnalysis()"></div>
        <div class="assumption-field"><label>Cap Rate %</label><input type="number" class="assumption-input" id="a-capRatePct" step="0.1" min="0.1" max="20" value="${assumptions.capRatePct}" oninput="recalcAnalysis()"></div>
        <div class="assumption-field"><label>Parking $/Space</label><input type="number" class="assumption-input" id="a-parkingCostPerSpace" step="1000" min="0" value="${assumptions.parkingCostPerSpace}" oninput="recalcAnalysis()"></div>
        <div class="assumption-field"><label>Site Work $/SF <span style="font-size:0.6rem;color:#a0aec0;">(of lot)</span></label><input type="number" class="assumption-input" id="a-siteWorkPSF" step="1" min="0" max="100" value="${assumptions.siteWorkPSF || Math.round(assumptions.siteWorkTotal / (assumptions.parcelSize || 10000))}" oninput="recalcAnalysis()" placeholder="auto"><span style="font-size:0.6rem;color:#a0aec0;">blank = auto-calc</span></div>
    </div></div>`;
}

function renderSiteWorkBreakdownInline(computed, inp) {
    var sw = computed.siteWorkBreakdown;
    if (!sw) return '<em style="color:#a0aec0;">No breakdown available</em>';
    var lot = inp.parcelSize || 10000;
    var f = function(v) { return '$' + Math.round(v).toLocaleString(); };
    var r = sw.rates || {};
    var html = '<div style="font-size:0.75rem;">';
    html += '<div style="font-weight:600;color:#2b6cb0;margin-bottom:0.4rem;">Site Work Sub-Components (' + lot.toLocaleString() + ' SF lot)</div>';
    html += '<table style="width:100%;font-size:0.72rem;border-collapse:collapse;"><thead><tr style="background:#edf2f7;"><th style="text-align:left;padding:3px 8px;">Component</th><th style="padding:3px 8px;">Rate</th><th style="padding:3px 8px;">Cost</th></tr></thead><tbody>';
    html += '<tr><td style="padding:3px 8px;">Clearing</td><td style="padding:3px 8px;text-align:center;">$' + (r.clearing || 0).toFixed(2) + '</td><td style="padding:3px 8px;text-align:center;">' + f(sw.clearing) + '</td></tr>';
    html += '<tr><td style="padding:3px 8px;">Grading</td><td style="padding:3px 8px;text-align:center;">$' + (r.grading || 0).toFixed(2) + '</td><td style="padding:3px 8px;text-align:center;">' + f(sw.grading) + '</td></tr>';
    html += '<tr><td style="padding:3px 8px;">Soil Prep</td><td style="padding:3px 8px;text-align:center;">$' + (r.soilPrep || 0).toFixed(2) + '</td><td style="padding:3px 8px;text-align:center;">' + f(sw.soilPrep) + '</td></tr>';
    html += '<tr><td style="padding:3px 8px;">Utilities</td><td style="padding:3px 8px;text-align:center;">$' + (r.utilities || 0).toFixed(2) + '</td><td style="padding:3px 8px;text-align:center;">' + f(sw.utilities) + '</td></tr>';
    html += '<tr><td style="padding:3px 8px;">Erosion</td><td style="padding:3px 8px;text-align:center;">$' + (r.erosion || 0).toFixed(2) + '</td><td style="padding:3px 8px;text-align:center;">' + f(sw.erosion) + '</td></tr>';
    html += '<tr style="font-weight:600;border-top:2px solid #cbd5e0;"><td style="padding:4px 8px;">Total</td><td></td><td style="padding:4px 8px;text-align:center;">' + f(sw.total) + '</td></tr>';
    html += '</tbody></table></div>';
    return html;
}

function renderCSIBreakdownInBudget(computed, inp) {
    var stories = computed.stories || 1;
    var constructionType = 'V-A';
    if (stories >= 10) constructionType = 'I-A';
    else if (stories >= 7) constructionType = 'I-B';
    else if (stories >= 5) constructionType = 'III-A';
    else if (stories >= 4) constructionType = 'II-A';
    var useId = (analysisState && analysisState.useId) || 'multifamily_mid';
    var divisions = computeCSIBreakdown(useId, computed, constructionType, stories);
    var f = function(v) { return '$' + Math.round(v).toLocaleString(); };
    var html = '<div style="font-size:0.75rem;"><div style="font-weight:600;color:#553c9a;margin-bottom:0.4rem;">CSI Division Breakdown â€” ' + constructionType + '</div>';
    html += '<table style="width:100%;font-size:0.72rem;border-collapse:collapse;"><thead><tr style="background:#f0e6ff;"><th style="padding:3px 6px;text-align:left;">Div</th><th style="padding:3px 6px;text-align:left;">Trade</th><th style="padding:3px 6px;text-align:right;">%</th><th style="padding:3px 6px;text-align:right;">$/SF</th><th style="padding:3px 6px;text-align:right;">Cost</th></tr></thead><tbody>';
    for (var i = 0; i < divisions.length; i++) {
        var d = divisions[i]; if (d.cost <= 0) continue;
        html += '<tr style="background:' + (i % 2 === 0 ? '#fff' : '#faf5ff') + ';"><td style="padding:2px 6px;color:#718096;">' + d.div + '</td><td style="padding:2px 6px;">' + d.name + '</td><td style="padding:2px 6px;text-align:right;">' + (d.pct * 100).toFixed(1) + '%</td><td style="padding:2px 6px;text-align:right;">$' + Math.round(d.costPSF) + '</td><td style="padding:2px 6px;text-align:right;">' + f(d.cost) + '</td></tr>';
    }
    html += '</tbody></table></div>';
    return html;
}

function renderBudgetTable(computed, inp) {
    const gsf = computed.gsf || 1;
    const units = computed.units;
    const hasUnits = units && units > 0;
    const perGSF = (v) => `$${Math.round(v / gsf).toLocaleString()}`;
    const perUnit = (v) => hasUnits ? `$${Math.round(v / units).toLocaleString()}` : 'â€”';
    const pct = (v) => computed.totalDev > 0 ? `${(v / computed.totalDev * 100).toFixed(1)}%` : '';
    return `<table class="budget-table">
        <thead><tr><th>Line Item</th><th>Total</th><th>$/GSF</th><th>${hasUnits ? '$/Unit' : '$/NSF'}</th><th>% of Total</th></tr></thead>
        <tbody>
        <tr class="section-header"><td colspan="5">LAND ACQUISITION</td></tr>
        <tr><td>Land Cost (${inp.parcelSize.toLocaleString()} SF &times; $${computed.landValuePSF.toLocaleString()}/SF)</td><td>${fmt(computed.landCost)}</td><td class="dim">${perGSF(computed.landCost)}</td><td class="dim">${hasUnits ? perUnit(computed.landCost) : '$' + Math.round(computed.landCost / (computed.nsf || 1)).toLocaleString()}</td><td class="pct-col">${pct(computed.landCost)}</td></tr>
        <tr class="section-header"><td colspan="5">HARD COSTS</td></tr>
        <tr style="cursor:pointer;" onclick="var el=document.getElementById('siteWorkDetail');el.style.display=el.style.display==='none'?'table-row':'none';"><td><strong>Site Work</strong> <span style="font-size:0.65rem;color:#4299e1;">&#9660; breakdown</span></td><td>${fmt(computed.siteWork)}</td><td class="dim">${perGSF(computed.siteWork)}</td><td class="dim">${hasUnits ? perUnit(computed.siteWork) : '$' + Math.round(computed.siteWork / (computed.nsf || 1)).toLocaleString()}</td><td class="pct-col">${pct(computed.siteWork)}</td></tr>
        <tr id="siteWorkDetail" style="display:none;"><td colspan="5" style="padding:0.5rem 1rem;background:#f7fafc;border-left:3px solid #4299e1;">${renderSiteWorkBreakdownInline(computed, inp)}</td></tr>
        ${computed.demolition > 0 ? `<tr><td>Demolition</td><td>${fmt(computed.demolition)}</td><td class="dim">${perGSF(computed.demolition)}</td><td class="dim">${hasUnits ? perUnit(computed.demolition) : '$' + Math.round(computed.demolition / (computed.nsf || 1)).toLocaleString()}</td><td class="pct-col">${pct(computed.demolition)}</td></tr>` : ''}
        <tr style="cursor:pointer;" onclick="var el=document.getElementById('csiDetail');if(el)el.style.display=el.style.display==='none'?'table-row':'none';"><td><strong>Building Construction</strong> (${computed.gsf.toLocaleString()} GSF &times; $${Math.round(computed.buildCostPSF).toLocaleString()}/SF) <span style="font-size:0.65rem;color:#4299e1;">&#9660; CSI</span></td><td>${fmt(computed.construction)}</td><td class="dim">$${Math.round(computed.buildCostPSF).toLocaleString()}</td><td class="dim">${hasUnits ? perUnit(computed.construction) : '$' + Math.round(computed.construction / (computed.nsf || 1)).toLocaleString()}</td><td class="pct-col">${pct(computed.construction)}</td></tr>
        <tr id="csiDetail" style="display:none;"><td colspan="5" style="padding:0.5rem 0.75rem;background:#f7fafc;border-left:3px solid #805ad5;">${renderCSIBreakdownInBudget(computed, inp)}</td></tr>
        <tr><td>Parking (${computed.parkingSpaces} spaces &times; $${(computed.parkingCostPerSpace || 0).toLocaleString()})</td><td>${fmt(computed.parkingCost)}</td><td class="dim">${perGSF(computed.parkingCost)}</td><td class="dim">${hasUnits ? perUnit(computed.parkingCost) : '$' + Math.round(computed.parkingCost / (computed.nsf || 1)).toLocaleString()}</td><td class="pct-col">${pct(computed.parkingCost)}</td></tr>
        <tr><td>Landscaping (4%)</td><td>${fmt(computed.landscaping)}</td><td class="dim">${perGSF(computed.landscaping)}</td><td class="dim">${hasUnits ? perUnit(computed.landscaping) : '$' + Math.round(computed.landscaping / (computed.nsf || 1)).toLocaleString()}</td><td class="pct-col">${pct(computed.landscaping)}</td></tr>
        <tr><td>Hard Contingency (7%)</td><td>${fmt(computed.hardContingency)}</td><td class="dim">${perGSF(computed.hardContingency)}</td><td class="dim">${hasUnits ? perUnit(computed.hardContingency) : '$' + Math.round(computed.hardContingency / (computed.nsf || 1)).toLocaleString()}</td><td class="pct-col">${pct(computed.hardContingency)}</td></tr>
        <tr class="subtotal"><td>Subtotal Hard</td><td>${fmt(computed.totalHard)}</td><td>${perGSF(computed.totalHard)}</td><td>${hasUnits ? perUnit(computed.totalHard) : '$' + Math.round(computed.totalHard / (computed.nsf || 1)).toLocaleString()}</td><td class="pct-col">${pct(computed.totalHard)}</td></tr>
        <tr class="section-header"><td colspan="5">SOFT COSTS</td></tr>
        <tr><td>Architecture &amp; Engineering (8%)</td><td>${fmt(computed.archEng)}</td><td class="dim">${perGSF(computed.archEng)}</td><td class="dim">${hasUnits ? perUnit(computed.archEng) : '$' + Math.round(computed.archEng / (computed.nsf || 1)).toLocaleString()}</td><td class="pct-col">${pct(computed.archEng)}</td></tr>
        <tr><td>Permits &amp; Fees (5%)</td><td>${fmt(computed.permits)}</td><td class="dim">${perGSF(computed.permits)}</td><td class="dim">${hasUnits ? perUnit(computed.permits) : '$' + Math.round(computed.permits / (computed.nsf || 1)).toLocaleString()}</td><td class="pct-col">${pct(computed.permits)}</td></tr>
        <tr><td>Legal (2%)</td><td>${fmt(computed.legal)}</td><td class="dim">${perGSF(computed.legal)}</td><td class="dim">${hasUnits ? perUnit(computed.legal) : '$' + Math.round(computed.legal / (computed.nsf || 1)).toLocaleString()}</td><td class="pct-col">${pct(computed.legal)}</td></tr>
        <tr><td>Financing (4.5%)</td><td>${fmt(computed.financing)}</td><td class="dim">${perGSF(computed.financing)}</td><td class="dim">${hasUnits ? perUnit(computed.financing) : '$' + Math.round(computed.financing / (computed.nsf || 1)).toLocaleString()}</td><td class="pct-col">${pct(computed.financing)}</td></tr>
        <tr><td>Marketing (2%)</td><td>${fmt(computed.marketing)}</td><td class="dim">${perGSF(computed.marketing)}</td><td class="dim">${hasUnits ? perUnit(computed.marketing) : '$' + Math.round(computed.marketing / (computed.nsf || 1)).toLocaleString()}</td><td class="pct-col">${pct(computed.marketing)}</td></tr>
        <tr><td>Developer Fee (4%)</td><td>${fmt(computed.devFee)}</td><td class="dim">${perGSF(computed.devFee)}</td><td class="dim">${hasUnits ? perUnit(computed.devFee) : '$' + Math.round(computed.devFee / (computed.nsf || 1)).toLocaleString()}</td><td class="pct-col">${pct(computed.devFee)}</td></tr>
        <tr class="subtotal"><td>Subtotal Soft</td><td>${fmt(computed.totalSoft)}</td><td>${perGSF(computed.totalSoft)}</td><td>${hasUnits ? perUnit(computed.totalSoft) : '$' + Math.round(computed.totalSoft / (computed.nsf || 1)).toLocaleString()}</td><td class="pct-col">${pct(computed.totalSoft)}</td></tr>
        <tr class="grand-total"><td>TOTAL DEVELOPMENT COST</td><td>${fmt(computed.totalDev)}</td><td>${perGSF(computed.totalDev)}</td><td>${hasUnits ? perUnit(computed.totalDev) : '$' + Math.round(computed.totalDev / (computed.nsf || 1)).toLocaleString()}</td><td>100%</td></tr>
        </tbody></table>`;
}

function renderReturnsSection(computed) {
    const spread = ((computed.yieldOnCost - computed.capRate) * 100).toFixed(0);
    const spreadLabel = spread >= 0 ? `+${spread} bps` : `${spread} bps`;
    const spreadColor = spread >= 150 ? '#276749' : spread >= 0 ? '#b7791f' : '#c53030';
    const marginColor = computed.devMargin >= 0.15 ? '#276749' : computed.devMargin >= 0 ? '#b7791f' : '#c53030';
    const hasUnits = computed.units && computed.units > 0;
    const perUnit = (v) => hasUnits ? `$${Math.round(v / computed.units).toLocaleString()}/unit` : '';
    const perNSF = (v) => `$${(v / (computed.revenueNSF || computed.nsf || 1)).toFixed(2)}/SF`;
    return `<div class="returns-grid">
        <div class="return-card"><div class="return-value">${(computed.yieldOnCost * 100).toFixed(1)}%</div><div class="return-label">Yield on Cost</div></div>
        <div class="return-card"><div class="return-value">${(computed.capRate * 100).toFixed(1)}%</div><div class="return-label">Market Cap Rate</div></div>
        <div class="return-card"><div class="return-value" style="color:${spreadColor}">${spreadLabel}</div><div class="return-label">Dev Spread</div></div>
        <div class="return-card"><div class="return-value" style="color:${marginColor}">${(computed.devMargin * 100).toFixed(0)}%</div><div class="return-label">Dev Margin</div></div>
    </div>
    <table class="budget-table">
        <thead><tr><th>Revenue &amp; Returns</th><th>Annual</th><th>${hasUnits ? '$/Unit' : '$/NSF'}</th></tr></thead>
        <tbody>
        <tr><td>Gross Revenue</td><td>${fmt(computed.grossRevenue)}</td><td class="dim">${hasUnits ? perUnit(computed.grossRevenue) : perNSF(computed.grossRevenue)}</td></tr>
        <tr><td>Less: OpEx</td><td>(${fmt(computed.opex)})</td><td class="dim">${hasUnits ? '(' + perUnit(computed.opex) + ')' : '(' + perNSF(computed.opex) + ')'}</td></tr>
        <tr class="subtotal"><td>NOI</td><td>${fmt(computed.noi)}</td><td>${hasUnits ? perUnit(computed.noi) : perNSF(computed.noi)}</td></tr>
        <tr><td>Stabilized Value</td><td>${fmt(computed.stabilizedValue)}</td><td class="dim">${hasUnits ? '$' + Math.round(computed.stabilizedValue / computed.units).toLocaleString() + '/unit' : '$' + Math.round(computed.stabilizedValue / (computed.gsf || 1)).toLocaleString() + '/GSF'}</td></tr>
        <tr><td>Total Dev Cost</td><td>${fmt(computed.totalDev)}</td><td class="dim">${hasUnits ? '$' + Math.round(computed.totalDev / computed.units).toLocaleString() + '/unit' : '$' + Math.round(computed.totalDev / (computed.gsf || 1)).toLocaleString() + '/GSF'}</td></tr>
        <tr class="subtotal"><td>Profit / (Loss)</td><td><strong style="color:${marginColor}">${fmt(computed.stabilizedValue - computed.totalDev)}</strong></td><td><strong style="color:${marginColor}">${(computed.devMargin * 100).toFixed(0)}%</strong></td></tr>
        </tbody></table>`;
}

function renderSVGs(useId, inp, computed) {
    return `${generateSitePlanSVG(useId, inp, computed)}${generateElevationSVG(useId, inp, computed)}`;
}

function recalcAnalysis() { _debouncedCall('analysis', _recalcAnalysisImpl, 200); }
function _recalcAnalysisImpl() {
    const st = analysisState;
    if (!st.useId || !st.inp) return;
    const assumptions = {
        far: parseFloat(document.getElementById('a-far').value) || st.assumptions.far,
        unitsOrNSF: parseInt(document.getElementById('a-unitsOrNSF').value) || st.assumptions.unitsOrNSF,
        parkingSpaces: parseInt(document.getElementById('a-parkingSpaces').value) || 0,
        buildCostPSF: parseFloat(document.getElementById('a-buildCostPSF').value) || st.assumptions.buildCostPSF,
        landValuePSF: parseFloat(document.getElementById('a-landValuePSF').value) || st.assumptions.landValuePSF,
        revenuePSF: parseFloat(document.getElementById('a-revenuePSF').value) || st.assumptions.revenuePSF,
        opexPct: parseFloat(document.getElementById('a-opexPct').value) || 0,
        capRatePct: parseFloat(document.getElementById('a-capRatePct').value) || st.assumptions.capRatePct,
        parkingCostPerSpace: parseFloat(document.getElementById('a-parkingCostPerSpace').value) || 0,
    };
    var siteWorkEl = document.getElementById('a-siteWorkPSF');
    if (siteWorkEl && siteWorkEl.value !== '' && parseFloat(siteWorkEl.value) > 0) {
        assumptions.siteWorkOverride = Math.round(parseFloat(siteWorkEl.value) * (st.inp.parcelSize || 10000));
    } else { assumptions.siteWorkOverride = null; }
    st.assumptions = assumptions;
    const computed = computeFromAssumptions(st.useId, st.inp, assumptions, st.effects);
    const progEl = document.getElementById('sect-program'); if (progEl) progEl.innerHTML = renderProgramDisplay(computed);
    const budgetEl = document.getElementById('sect-budget'); if (budgetEl) budgetEl.innerHTML = renderBudgetTable(computed, st.inp);
    const returnsEl = document.getElementById('sect-returns'); if (returnsEl) returnsEl.innerHTML = renderReturnsSection(computed);
    const svgEl = document.getElementById('sect-svg'); if (svgEl) svgEl.innerHTML = renderSVGs(st.useId, st.inp, computed);
}

function openAnalysis(resultIndex) {
    if (!lastResults || !lastInputs) return;
    const r = lastResults[resultIndex];
    const inp = lastInputs;
    const effects = stackLegislationEffects(r.legislation || []);
    const hasUnits = !!BUILDING_PARAMS[r.id].unitSF;
    const assumptions = getDefaultAssumptions(r.id, inp, effects);
    analysisState = { resultIndex, useId: r.id, inp, effects, legislation: r.legislation || [], assumptions };
    const computed = computeFromAssumptions(r.id, inp, assumptions, effects);
    const tl = TIMELINE_MONTHS[r.id] || { entitlement: 6, design: 4, permits: 3, construction: 18, leaseup: 6 };
    const totalMonths = tl.entitlement + tl.design + tl.permits + tl.construction + tl.leaseup;
    const neighborhoodText = document.getElementById('neighborhood').selectedOptions[0].text;
    document.getElementById('modalTitle').textContent = `${r.icon} ${r.name}`;
    document.getElementById('modalSubtitle').textContent = `Detailed Analysis  |  ${inp.parcelSize.toLocaleString()} SF  |  ${inp.zoning}  |  ${neighborhoodText}`;
    let html = '';
    html += `<div class="analysis-section"><h3>Building Program</h3><div id="sect-program">${renderProgramDisplay(computed)}</div></div>`;
    html += `<div class="analysis-section">${renderAssumptions(assumptions, hasUnits)}</div>`;
    html += `<div class="analysis-section"><h3>Conceptual Massing</h3><div class="rendering-container" id="sect-svg">${renderSVGs(r.id, inp, computed)}</div></div>`;
    html += `<div class="analysis-section"><h3>Development Pro Forma</h3><div id="sect-budget">${renderBudgetTable(computed, inp)}</div></div>`;
    html += `<div class="analysis-section"><h3>Revenue &amp; Returns</h3><div id="sect-returns">${renderReturnsSection(computed)}</div></div>`;
    html += `<div class="analysis-section"><h3>Timeline â€” ${totalMonths} Months</h3>
    <div class="timeline-bar">
        <div class="timeline-segment" style="flex:${tl.entitlement};background:#805ad5;">Entitle<br>${tl.entitlement}mo</div>
        <div class="timeline-segment" style="flex:${tl.design};background:#3182ce;">Design<br>${tl.design}mo</div>
        <div class="timeline-segment" style="flex:${tl.permits};background:#38a169;">Permits<br>${tl.permits}mo</div>
        <div class="timeline-segment" style="flex:${tl.construction};background:#dd6b20;">Construction<br>${tl.construction}mo</div>
        <div class="timeline-segment" style="flex:${tl.leaseup};background:#e53e3e;">Lease-Up<br>${tl.leaseup}mo</div>
    </div></div>`;
    if (r.legislation && r.legislation.length > 0) {
        html += `<div class="analysis-section"><h3>Applicable Legislation</h3><div class="legislation-cards">${r.legislation.map(b => `<div class="legislation-card clickable" onclick="showLegislationDetail('${b.id}')"><strong>${b.name}</strong><p>${b.description}</p></div>`).join('')}</div></div>`;
    }
    html += generateRisksHTML(r.id, inp);
    html += `<div class="disclaimer" style="margin-top:1.5rem;"><strong>Disclaimer:</strong> This pro forma is a preliminary estimate for educational purposes only.</div>`;
    document.getElementById('modalBody').innerHTML = html;
    document.getElementById('analysisModal').style.display = 'block';
    document.body.style.overflow = 'hidden';
    document.getElementById('analysisModal').scrollTop = 0;
}

function closeAnalysis() { document.getElementById('analysisModal').style.display = 'none'; document.body.style.overflow = ''; }
function printAnalysis() { document.body.classList.add('printing-analysis'); window.print(); document.body.classList.remove('printing-analysis'); }

// ============================================================
//  TAB NAVIGATION
// ============================================================
let activeTab = 'Calculator';
let contactsInitialized = false;
let finderMapInitialized = false;
let finderMapInstance = null;
let finderResults2 = [];
let finderSortCol2 = 'impRatio';
let finderSortAsc2 = true;
let finderParcelLayer2 = null;
let finderSelectedSet = new Set();
let sitesMapInitialized = false;
let sitesMapInstance = null;

function switchTab(tab) {
    activeTab = tab;
    document.querySelectorAll('.tab-btn').forEach((btn, i) => {
        const tabs = ['Calculator','Finder','Pipeline','Contacts','Sites'];
        btn.classList.toggle('active', tabs[i] === tab);
    });
    ['tabCalculator','tabFinder','tabPipeline','tabContacts','tabSites'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.toggle('active', id === 'tab' + tab);
    });
    if (tab === 'Contacts' && !contactsInitialized) { renderContactsDirectory(); contactsInitialized = true; }
    if (tab === 'Finder' && !finderMapInitialized) { setTimeout(() => initFinderMap(), 100); }
    else if (tab === 'Finder' && finderMapInstance) { setTimeout(() => finderMapInstance.invalidateSize(), 100); }
    if (tab === 'Pipeline' && !pipelineMapInitialized) { setTimeout(() => initPipelineMap(), 100); }
    else if (tab === 'Pipeline' && pipelineMapInstance) { setTimeout(() => pipelineMapInstance.invalidateSize(), 100); }
    if (tab === 'Sites' && !sitesMapInitialized) { setTimeout(() => initSitesMap(), 100); }
    else if (tab === 'Sites' && sitesMapInstance) { setTimeout(() => sitesMapInstance.invalidateSize(), 100); }
}

// ============================================================
//  CONTACTS DIRECTORY
// ============================================================
const CONTACTS_DATA = [
    // === Title & Escrow ===
    { name: 'Chicago Title â€” Los Angeles', category: 'title', role: 'Title & Escrow', phone: '(213) 612-4100', email: '', website: 'https://www.chicagotitle.com', address: '700 S Flower St, Suite 900, Los Angeles, CA 90017', notes: 'Full-service title, escrow, residential & commercial' },
    { name: 'Fidelity National Title', category: 'title', role: 'Title & Escrow', phone: '(213) 253-9500', email: '', website: 'https://www.fidelitynational.com', address: '777 S Figueroa St, Suite 3000, Los Angeles, CA 90017', notes: 'Title insurance, escrow, 1031 exchange QI' },
    { name: 'First American Title', category: 'title', role: 'Title & Escrow', phone: '(714) 250-3000', email: '', website: 'https://www.firstam.com', address: '1 First American Way, Santa Ana, CA 92707', notes: 'Title insurance, home warranty, escrow' },
    { name: 'Old Republic Title', category: 'title', role: 'Title & Escrow', phone: '(213) 273-1730', email: '', website: 'https://www.oldrepublictitle.com', address: '445 S Figueroa St, Suite 3100, Los Angeles, CA 90071', notes: 'Residential title, escrow, commercial' },
    { name: 'Stewart Title of California', category: 'title', role: 'Title & Escrow', phone: '(310) 820-0850', email: '', website: 'https://www.stewart.com', address: '11150 Santa Monica Blvd, Suite 800, Los Angeles, CA 90025', notes: 'Title insurance, escrow services' },
    { name: 'Glen Oaks Escrow', category: 'title', role: 'Escrow', phone: '(818) 241-4114', email: '', website: 'https://glenoaksescrow.com', address: '530 S Lake Ave, Suite 200, Pasadena, CA 91101', notes: 'Independent escrow, residential specialist' },

    // === Mortgage Lenders ===
    { name: 'Guaranteed Rate', category: 'mortgage', role: 'Mortgage Lender', phone: '(866) 934-7283', email: '', website: 'https://www.rate.com', address: '3940 Laurel Canyon Blvd, Suite 609, Studio City, CA 91604', notes: 'Conventional, FHA, VA, jumbo loans' },
    { name: 'loanDepot', category: 'mortgage', role: 'Mortgage Lender', phone: '(888) 337-6888', email: '', website: 'https://www.loandepot.com', address: '6561 Irvine Center Dr, Irvine, CA 92618', notes: 'Purchase, refi, FHA, VA, jumbo' },
    { name: 'CrossCountry Mortgage', category: 'mortgage', role: 'Mortgage Lender', phone: '(877) 351-3400', email: '', website: 'https://www.crosscountrymortgage.com', address: '11601 Wilshire Blvd, Suite 300, Los Angeles, CA 90025', notes: 'First-time buyer programs, FHA, conventional' },
    { name: 'Kinecta Federal Credit Union', category: 'mortgage', role: 'Credit Union Lender', phone: '(800) 854-9846', email: '', website: 'https://www.kinecta.org', address: '1440 Rosecrans Ave, Manhattan Beach, CA 90266', notes: 'Competitive rates, local CU, residential' },
    { name: 'United Wholesale Mortgage (UWM)', category: 'mortgage', role: 'Wholesale Lender', phone: '(800) 981-8898', email: '', website: 'https://www.uwm.com', address: '585 S Blvd E, Pontiac, MI 48341', notes: 'Largest wholesale lender, broker channel' },

    // === Home Inspectors ===
    { name: 'Inspection Experts', category: 'inspector', role: 'Home Inspector', phone: '(800) 400-0407', email: '', website: 'https://www.inspectionexperts.com', address: 'Serving all Los Angeles County', notes: 'Full home inspection, sewer scope, pool/spa' },
    { name: 'The Real Estate Inspection Co.', category: 'inspector', role: 'Home Inspector', phone: '(310) 396-0606', email: '', website: 'https://www.therealestateInspection.com', address: 'Santa Monica, CA', notes: 'Residential inspections, foundation, roof, HVAC' },
    { name: 'WIN Home Inspection â€” LA', category: 'inspector', role: 'Home Inspector', phone: '(800) 309-6753', email: '', website: 'https://www.wini.com', address: 'Serving Los Angeles metro area', notes: 'Same-day reports, mold, radon, sewer' },
    { name: 'Insight Property Inspections', category: 'inspector', role: 'Home Inspector', phone: '(818) 694-6665', email: '', website: 'https://www.insightpi.com', address: 'Serving LA County & Ventura County', notes: 'InterNACHI certified, thermal imaging' },

    // === Appraisers ===
    { name: 'CBRE Valuation & Advisory', category: 'appraiser', role: 'Appraiser (Residential & Commercial)', phone: '(213) 613-3333', email: '', website: 'https://www.cbre.com/services/valuation', address: '400 S Hope St, 25th Floor, Los Angeles, CA 90071', notes: 'Certified appraisals, market value, estate, litigation' },
    { name: 'Pacific Appraisal Associates', category: 'appraiser', role: 'Residential Appraiser', phone: '(310) 474-3130', email: '', website: '', address: '11440 W Olympic Blvd, Suite 600, Los Angeles, CA 90064', notes: 'FHA, VA, conventional, estate appraisals' },
    { name: 'Westside Appraisal Group', category: 'appraiser', role: 'Residential Appraiser', phone: '(310) 839-3993', email: '', website: '', address: 'Culver City, CA 90232', notes: 'Single-family, condo, multifamily 2-4 units' },
    { name: 'BBG (formerly Bowman Consulting)', category: 'appraiser', role: 'Commercial Appraiser', phone: '(214) 855-0700', email: '', website: 'https://www.bbgres.com', address: '515 S Flower St, Suite 1200, Los Angeles, CA 90071', notes: 'Land valuation, HBU studies, litigation support' },

    // === Photography & Media ===
    { name: 'HomeJab Real Estate Photography', category: 'photo', role: 'RE Photography', phone: '(855) 466-3522', email: '', website: 'https://www.homejab.com', address: 'Serving all Los Angeles County', notes: 'MLS-ready photos, drone, video, 3D tours' },
    { name: 'Matterport 3D Tours (LA providers)', category: 'photo', role: '3D Virtual Tours', phone: '', email: '', website: 'https://matterport.com/industries/real-estate', address: 'Multiple LA-area providers', notes: '3D walkthroughs, floor plans, dollhouse view' },
    { name: 'BoxBrownie.com', category: 'photo', role: 'Virtual Staging & Editing', phone: '', email: '', website: 'https://www.boxbrownie.com', address: 'Online service', notes: 'Virtual staging, twilight conversion, photo editing, floor plans' },
    { name: 'Tourfactory', category: 'photo', role: 'RE Media', phone: '(800) 768-3892', email: '', website: 'https://www.tourfactory.com', address: 'Serving Los Angeles metro', notes: 'Professional photography, video, drone, Zillow 3D' },

    // === Staging ===
    { name: 'Meridith Baer Home', category: 'staging', role: 'Luxury Staging', phone: '(310) 472-4500', email: '', website: 'https://www.meridithbaer.com', address: '13030 Saticoy St, North Hollywood, CA 91605', notes: 'High-end staging, luxury homes, celebrity listings' },
    { name: 'STAGE by Sarah Richardson', category: 'staging', role: 'Home Staging', phone: '(310) 562-8260', email: '', website: '', address: 'Los Angeles, CA', notes: 'Vacant & occupied staging, consultations' },
    { name: 'White Orchid Interiors', category: 'staging', role: 'Home Staging', phone: '(818) 510-5488', email: '', website: 'https://www.whiteorchidinteriors.com', address: 'Los Angeles, CA', notes: 'Staging, interior design, furniture rental' },
    { name: 'Showhomes', category: 'staging', role: 'Home Staging', phone: '(888) 882-4743', email: '', website: 'https://www.showhomes.com', address: 'Multiple LA-area franchises', notes: 'Vacant staging, home manager program, consultations' },

    // === Termite & Pest ===
    { name: 'Terminix â€” Los Angeles', category: 'termite', role: 'Termite & Pest Control', phone: '(877) 837-6464', email: '', website: 'https://www.terminix.com', address: 'Multiple LA-area offices', notes: 'Termite inspections, Section 1 & 2 reports, fumigation' },
    { name: 'Western Exterminator', category: 'termite', role: 'Termite & Pest Control', phone: '(888) 444-6138', email: '', website: 'https://www.westernexterminator.com', address: 'Multiple LA-area offices', notes: 'Termite reports, wood damage repair, pest control' },
    { name: 'Dewey Pest & Termite Control', category: 'termite', role: 'Termite & Pest Control', phone: '(866) 933-3939', email: '', website: 'https://www.deweypest.com', address: 'Serving all of Southern California', notes: 'Residential termite, local family-owned since 1929' },

    // === Insurance ===
    { name: 'State Farm â€” LA Metro', category: 'insurance', role: 'Homeowners Insurance', phone: '(800) 732-5246', email: '', website: 'https://www.statefarm.com', address: 'Multiple LA-area agents', notes: 'Home, fire, earthquake, umbrella' },
    { name: 'Farmers Insurance â€” LA', category: 'insurance', role: 'Homeowners Insurance', phone: '(888) 327-6335', email: '', website: 'https://www.farmers.com', address: 'Multiple LA-area agents', notes: 'Home, fire, earthquake, flood, umbrella' },
    { name: 'California Earthquake Authority (CEA)', category: 'insurance', role: 'Earthquake Insurance', phone: '(877) 797-4300', email: '', website: 'https://www.earthquakeauthority.com', address: 'Sacramento, CA', notes: 'State earthquake insurance, available through participating insurers' },
    { name: 'California FAIR Plan', category: 'insurance', role: 'Fire Insurance (Last Resort)', phone: '(800) 339-4099', email: '', website: 'https://www.cfpnet.com', address: 'Los Angeles, CA', notes: 'Basic fire coverage for high-risk areas, insurer of last resort' },

    // === Notary & Signing ===
    { name: 'National Notary Association (NNA) â€” Find a Notary', category: 'notary', role: 'Notary Locator', phone: '(800) 876-6827', email: '', website: 'https://www.nationalnotary.org/notary-signing-agent/find-a-notary', address: '9350 De Soto Ave, Chatsworth, CA 91311', notes: 'Find certified notary signing agents in LA' },
    { name: 'Snapdocs', category: 'notary', role: 'Signing Service', phone: '', email: '', website: 'https://www.snapdocs.com', address: 'Online platform', notes: 'Digital notary scheduling, e-closings, signing agent network' },
    { name: 'SigningOrder.com', category: 'notary', role: 'Signing Service', phone: '(888) 744-6464', email: '', website: 'https://www.signingorder.com', address: 'Online platform', notes: 'Mobile notary dispatch, same-day closings' },

    // === Moving & Junk Removal ===
    { name: 'PODS Moving & Storage', category: 'moving', role: 'Moving Containers', phone: '(877) 770-7637', email: '', website: 'https://www.pods.com', address: 'Serving all Los Angeles County', notes: 'Portable storage, local & long-distance moving' },
    { name: '1-800-GOT-JUNK?', category: 'moving', role: 'Junk Removal', phone: '(800) 468-5865', email: '', website: 'https://www.1800gotjunk.com', address: 'Multiple LA-area franchises', notes: 'Full-service junk removal, estate cleanouts, appliances' },
    { name: 'Two Men and a Truck â€” LA', category: 'moving', role: 'Moving Company', phone: '(310) 734-6803', email: '', website: 'https://twomenandatruck.com', address: 'Serving Los Angeles metro', notes: 'Local & long-distance moves, packing services' },

    // === Handyman & Repair ===
    { name: 'Mr. Handyman â€” LA West', category: 'handyman', role: 'Handyman Service', phone: '(310) 906-1720', email: '', website: 'https://www.mrhandyman.com', address: 'Serving West Los Angeles', notes: 'Pre-listing repairs, drywall, paint, plumbing, doors' },
    { name: 'ABC Plumbing, Heating & Air', category: 'handyman', role: 'Plumbing & HVAC', phone: '(310) 644-7717', email: '', website: '', address: 'Serving LA County', notes: 'Plumbing repairs, water heaters, HVAC tune-ups' },
    { name: 'Mike Diamond Services', category: 'handyman', role: 'Plumbing & HVAC', phone: '(800) 439-2833', email: '', website: 'https://www.mikediamondservices.com', address: 'Serving all of LA County', notes: '"Smell Good Plumber," sewer line, HVAC, electrical' },
    { name: 'Larchmont Painting & Decorating', category: 'handyman', role: 'Painting', phone: '(323) 644-4200', email: '', website: '', address: 'Los Angeles, CA', notes: 'Interior & exterior painting, pre-sale prep' },

    // === Legal ===
    { name: 'Keller Williams Legal (RE Division)', category: 'legal', role: 'RE Transaction Attorney', phone: '(310) 807-0404', email: '', website: '', address: 'Los Angeles, CA', notes: 'Purchase agreements, disclosures, disputes' },
    { name: 'Esquire Real Estate Brokerage', category: 'legal', role: 'Attorney-Broker', phone: '(213) 985-4163', email: '', website: 'https://www.esquirereb.com', address: '444 S Flower St, Suite 1700, Los Angeles, CA 90071', notes: 'Licensed attorney + broker, transaction support' },
    { name: 'Schorr Law (RE Litigation)', category: 'legal', role: 'RE Litigation Attorney', phone: '(310) 954-1877', email: '', website: 'https://www.schorr-law.com', address: '1901 Avenue of the Stars, Suite 615, Los Angeles, CA 90067', notes: 'Boundary disputes, title issues, seller disclosure' },
];

const CATEGORY_ICONS = { title: 'ðŸ“‹', mortgage: 'ðŸ¦', inspector: 'ðŸ”', appraiser: 'ðŸ“Š', photo: 'ðŸ“·', staging: 'ðŸ›‹ï¸', termite: 'ðŸ›', insurance: 'ðŸ›¡ï¸', notary: 'âœï¸', moving: 'ðŸ“¦', handyman: 'ðŸ”§', legal: 'âš–ï¸' };
const CATEGORY_LABELS = { title: 'Title & Escrow', mortgage: 'Mortgage Lenders', inspector: 'Home Inspectors', appraiser: 'Appraisers', photo: 'Photography & Media', staging: 'Staging', termite: 'Termite & Pest', insurance: 'Insurance', notary: 'Notary & Signing', moving: 'Moving & Junk', handyman: 'Handyman & Repair', legal: 'Legal' };

function renderContactsDirectory() { var grid = document.getElementById('contactsGrid'); if (!grid) return; renderContactCards(CONTACTS_DATA, grid); }
function renderContactCards(contacts, container) {
    var html = '';
    contacts.forEach(function(c) {
        var icon = CATEGORY_ICONS[c.category] || 'ðŸ“‹';
        var catLabel = CATEGORY_LABELS[c.category] || c.category;
        html += '<div class="contact-card" style="background:var(--card);border:1px solid var(--border);border-radius:10px;padding:1rem;">';
        html += '<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:0.5rem;">';
        html += '<div><div style="font-size:0.88rem;font-weight:700;">' + icon + ' ' + c.name + '</div>';
        html += '<div style="font-size:0.72rem;color:var(--text-light);">' + c.role + '</div></div>';
        html += '<span style="background:#edf2f7;padding:2px 8px;border-radius:4px;font-size:0.65rem;color:#4a5568;">' + catLabel + '</span></div>';
        if (c.phone) html += '<div style="font-size:0.75rem;margin-bottom:0.25rem;">ðŸ“ž <a href="tel:' + c.phone.replace(/[^0-9+]/g, '') + '" style="color:#3182ce;">' + c.phone + '</a></div>';
        if (c.email) html += '<div style="font-size:0.75rem;margin-bottom:0.25rem;">âœ‰ï¸ <a href="mailto:' + c.email + '" style="color:#3182ce;">' + c.email + '</a></div>';
        if (c.website) html += '<div style="font-size:0.75rem;margin-bottom:0.25rem;">ðŸŒ <a href="' + c.website + '" target="_blank" style="color:#3182ce;">' + c.website.replace('https://', '').replace('http://', '') + '</a></div>';
        if (c.address) html += '<div style="font-size:0.72rem;color:var(--text-light);margin-bottom:0.25rem;">ðŸ“ ' + c.address + '</div>';
        if (c.notes) html += '<div style="font-size:0.7rem;color:#718096;font-style:italic;border-top:1px solid var(--border);padding-top:0.4rem;margin-top:0.4rem;">' + c.notes + '</div>';
        html += '</div>';
    });
    if (contacts.length === 0) html = '<div style="grid-column:1/-1;text-align:center;padding:2rem;color:var(--text-light);">No contacts match your search.</div>';
    container.innerHTML = html;
}
function filterContacts() {
    var search = (document.getElementById('contactSearch').value || '').toLowerCase();
    var category = document.getElementById('contactCategory').value;
    var filtered = CONTACTS_DATA.filter(function(c) {
        var matchCat = !category || c.category === category;
        var matchSearch = !search || c.name.toLowerCase().indexOf(search) >= 0 || c.role.toLowerCase().indexOf(search) >= 0 || (c.notes || '').toLowerCase().indexOf(search) >= 0;
        return matchCat && matchSearch;
    });
    renderContactCards(filtered, document.getElementById('contactsGrid'));
}

// ============================================================
//  DEVELOPMENT PIPELINE
// ============================================================
const PIPELINE_STAGE_MAP = {
    'submitted': 'submitted', 'permit submitted': 'submitted', 'application submitted': 'submitted',
    'plan check': 'plan_check', 'plan check submitted': 'plan_check', 'pcis job in plan check': 'plan_check', 'plan check correction(s) made': 'plan_check',
    'issued': 'issued', 'permit issued': 'issued',
    'under inspection': 'inspection', 'inspections started': 'inspection',
    'finaled': 'finaled', 'permit finaled': 'finaled',
    'coo issued': 'coo', 'certificate of occupancy': 'coo', 'co issued': 'coo', 'temporary certificate of occupancy': 'coo',
};
const PIPELINE_STAGE_LABELS = { submitted: 'Submitted', plan_check: 'Plan Check', issued: 'Issued', inspection: 'Under Inspection', finaled: 'Finaled', coo: 'Cert of Occ' };
const PIPELINE_COLORS = { submitted: '#d69e2e', plan_check: '#dd6b20', issued: '#3182ce', inspection: '#38a169', finaled: '#718096', coo: '#276749' };
let pipelineMapInstance = null, pipelineMapInitialized = false, pipelineMarkerLayer = null, pipelineSearchCenter = null;
let pipelineResults = [], pipelineSortCol = 'valuation', pipelineSortAsc = false;
let pipelineOverlayActive = false, pipelineOverlayLayer = null;
let pipelineCache = new Map();

function initPipelineMap() {
    const mapEl = document.getElementById('pipelineMap'); if (!mapEl) return;
    if (pipelineMapInstance) { pipelineMapInstance.remove(); pipelineMapInstance = null; }
    pipelineMapInstance = L.map('pipelineMap').setView([34.05, -118.25], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors', maxZoom: 18 }).addTo(pipelineMapInstance);
    pipelineMarkerLayer = L.layerGroup().addTo(pipelineMapInstance);
    pipelineMapInstance.on('click', function(e) { setPipelineSearchCenter(e.latlng.lat, e.latlng.lng, `${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}`); });
    renderPipelineMapLegend();
    const twoYearsAgo = new Date(); twoYearsAgo.setFullYear(twoYearsAgo.getFullYear() - 2);
    const dateFromEl = document.getElementById('pipelineDateFrom');
    if (dateFromEl && !dateFromEl.value) dateFromEl.value = twoYearsAgo.toISOString().split('T')[0];
    pipelineMapInitialized = true;
    setTimeout(() => { if (pipelineMapInstance) pipelineMapInstance.invalidateSize(); }, 200);
}
function renderPipelineMapLegend() {
    const el = document.getElementById('pipelineLegend'); if (!el) return;
    el.innerHTML = Object.entries(PIPELINE_COLORS).map(([key, color]) => `<div class="pipeline-legend-item"><span class="pipeline-legend-dot" style="background:${color};"></span>${PIPELINE_STAGE_LABELS[key]}</div>`).join('');
}
function setPipelineSearchCenter(lat, lon, label) {
    pipelineSearchCenter = { lat, lon, label };
    if (pipelineMapInstance._centerMarker) pipelineMapInstance.removeLayer(pipelineMapInstance._centerMarker);
    const icon = L.divIcon({ html: '<div style="width:16px;height:16px;border-radius:50%;background:#e53e3e;border:3px solid #fff;box-shadow:0 2px 6px rgba(0,0,0,0.4);"></div>', iconSize: [16, 16], iconAnchor: [8, 8], className: '' });
    pipelineMapInstance._centerMarker = L.marker([lat, lon], { icon }).addTo(pipelineMapInstance);
    pipelineMapInstance.setView([lat, lon], 14);
    document.getElementById('pipelineMapStatus').textContent = `Search center: ${label}`;
}
async function geocodePipelineAddress() {
    const input = document.getElementById('pipelineAddress'); const addr = input.value.trim();
    if (!addr) { alert('Please enter an address.'); return; }
    try { input.disabled = true; const result = await geocodeAddress(addr); setPipelineSearchCenter(result.lat, result.lon, addr); }
    catch (e) { alert('Geocoding failed: ' + e.message); }
    finally { input.disabled = false; }
}
function normalizePipelineRecord(raw, source) {
    let lat, lon;
    if (source === 'issued') { if (raw.geolocation) { lat = parseFloat(raw.geolocation.latitude || raw.geolocation.coordinates?.[1]); lon = parseFloat(raw.geolocation.longitude || raw.geolocation.coordinates?.[0]); } if (!lat && raw.latitude) lat = parseFloat(raw.latitude); if (!lon && raw.longitude) lon = parseFloat(raw.longitude); }
    else { lat = parseFloat(raw.latitude_y_coordinate || raw.latitude); lon = parseFloat(raw.longitude_x_coordinate || raw.longitude); }
    const statusRaw = (raw.status_desc || raw.status || raw.permit_status || '').toLowerCase().trim();
    const stage = PIPELINE_STAGE_MAP[statusRaw] || guessStage(statusRaw);
    const permitType = (raw.permit_type || raw.type || raw.permit_type_desc || '').toLowerCase();
    let typeKey = 'bldg';
    if (/grad/i.test(permitType)) typeKey = 'grading'; else if (/elec/i.test(permitType)) typeKey = 'elec'; else if (/plumb/i.test(permitType)) typeKey = 'plumb'; else if (/mech/i.test(permitType)) typeKey = 'mech';
    return { permit_nbr: raw.permit_nbr || raw.pcis_permit || raw.permit_number || '', address: raw.address || raw.address_street || raw.project_address || '', permit_type: typeKey, permit_type_label: (raw.permit_type || raw.type || raw.permit_type_desc || 'Building').replace(/^\w/, c => c.toUpperCase()), stage, status_raw: raw.status_desc || raw.status || '', valuation: parseFloat(raw.valuation || raw.project_valuation || 0) || 0, date: raw.issue_date || raw.submitted_date || raw.status_date || raw.filed_date || '', zone: raw.zone || raw.existing_zoning || '', description: raw.work_description || raw.project_description || raw.description || '', lat, lon, source };
}
function guessStage(s) { if (/submit|appli/i.test(s)) return 'submitted'; if (/plan.*check|pcis/i.test(s)) return 'plan_check'; if (/issue/i.test(s)) return 'issued'; if (/inspect/i.test(s)) return 'inspection'; if (/final/i.test(s)) return 'finaled'; if (/co |certificate|occupan/i.test(s)) return 'coo'; return 'submitted'; }
function buildBoundingBox(lat, lon, radiusMiles) { const latDeg = radiusMiles / 69.0; const lonDeg = radiusMiles / (69.0 * Math.cos(lat * Math.PI / 180)); return { minLat: lat - latDeg, maxLat: lat + latDeg, minLon: lon - lonDeg, maxLon: lon + lonDeg }; }

async function queryPipelineIssuedPermits(lat, lon, radiusMiles, onProgress) {
    const radiusMeters = radiusMiles * 1609.34; const baseUrl = 'https://data.lacity.org/resource/pi9x-tg5x.json'; const limit = 1000; let offset = 0; let allRecords = []; const cap = 5000;
    while (offset < cap) { const where = `within_circle(geolocation, ${lat}, ${lon}, ${radiusMeters})`; const url = `${baseUrl}?$where=${encodeURIComponent(where)}&$limit=${limit}&$offset=${offset}&$order=issue_date DESC`; const resp = await fetch(url); if (!resp.ok) break; const data = await resp.json(); if (!data || data.length === 0) break; allRecords = allRecords.concat(data.map(r => normalizePipelineRecord(r, 'issued'))); if (onProgress) onProgress(`Fetched ${allRecords.length} issued permits...`, Math.min(allRecords.length / cap * 50, 45)); if (data.length < limit) break; offset += limit; }
    return allRecords;
}
async function queryPipelinePreIssuancePermits(lat, lon, radiusMiles, onProgress) {
    const bb = buildBoundingBox(lat, lon, radiusMiles); const baseUrl = 'https://data.lacity.org/resource/gwh9-jnip.json'; const limit = 1000; let offset = 0; let allRecords = []; const cap = 3000;
    while (offset < cap) { const where = `latitude_y_coordinate >= ${bb.minLat} AND latitude_y_coordinate <= ${bb.maxLat} AND longitude_x_coordinate >= ${bb.minLon} AND longitude_x_coordinate <= ${bb.maxLon}`; const url = `${baseUrl}?$where=${encodeURIComponent(where)}&$limit=${limit}&$offset=${offset}&$order=submitted_date DESC`; const resp = await fetch(url); if (!resp.ok) break; const data = await resp.json(); if (!data || data.length === 0) break; const normalized = data.map(r => normalizePipelineRecord(r, 'pre_issuance')); const filtered = normalized.filter(r => r.lat && r.lon && haversine(lat, lon, r.lat, r.lon) <= radiusMiles); allRecords = allRecords.concat(filtered); if (onProgress) onProgress(`Fetched ${allRecords.length} pre-issuance permits...`, 50 + Math.min(allRecords.length / cap * 45, 45)); if (data.length < limit) break; offset += limit; }
    return allRecords;
}
async function fetchAllPipelinePermits(lat, lon, radiusMiles, onProgress) {
    const cacheKey = `${lat.toFixed(4)}_${lon.toFixed(4)}_${radiusMiles}`; const cached = pipelineCache.get(cacheKey);
    if (cached && (Date.now() - cached.ts < 5 * 60 * 1000)) { if (onProgress) onProgress('Using cached results', 100); return cached.data; }
    const [issued, preIssue] = await Promise.all([queryPipelineIssuedPermits(lat, lon, radiusMiles, onProgress), queryPipelinePreIssuancePermits(lat, lon, radiusMiles, onProgress)]);
    const seen = new Set(); const combined = [];
    for (const r of [...issued, ...preIssue]) { const key = r.permit_nbr || `${r.lat}_${r.lon}_${r.address}`; if (!seen.has(key)) { seen.add(key); combined.push(r); } }
    pipelineCache.set(cacheKey, { ts: Date.now(), data: combined }); return combined;
}

async function runPipelineSearch() {
    if (!pipelineSearchCenter) { alert('Please set a search center first.'); return; }
    const radiusEl = document.querySelector('input[name="pipelineRadius"]:checked'); const radius = radiusEl ? parseFloat(radiusEl.value) : 0.5;
    const progressEl = document.getElementById('pipelineProgress'); const fillEl = document.getElementById('pipelineProgressFill'); const textEl = document.getElementById('pipelineProgressText');
    progressEl.classList.add('active'); fillEl.style.width = '5%'; textEl.textContent = 'Starting...';
    try {
        const allRecords = await fetchAllPipelinePermits(pipelineSearchCenter.lat, pipelineSearchCenter.lon, radius, (msg, pct) => { textEl.textContent = msg; fillEl.style.width = pct + '%'; });
        fillEl.style.width = '95%'; textEl.textContent = `Processing ${allRecords.length} records...`;
        let filtered = applyPipelineFilters(allRecords);
        const dateFrom = document.getElementById('pipelineDateFrom').value; const dateTo = document.getElementById('pipelineDateTo').value;
        if (dateFrom) filtered = filtered.filter(r => r.date >= dateFrom); if (dateTo) filtered = filtered.filter(r => r.date <= dateTo + 'T23:59:59');
        pipelineResults = filtered; sortPipelineResults(pipelineResults); renderPipelineResults(); renderPipelineMarkers();
        fillEl.style.width = '100%'; textEl.textContent = `Found ${filtered.length} permits`; setTimeout(() => progressEl.classList.remove('active'), 2000);
    } catch (e) { fillEl.style.width = '0%'; textEl.textContent = 'Error: ' + e.message; }
}
function applyPipelineFilters(records) {
    const checkedStages = new Set(); document.querySelectorAll('.pipelineStage:checked').forEach(cb => checkedStages.add(cb.value));
    const checkedTypes = new Set(); document.querySelectorAll('.pipelinePermitType:checked').forEach(cb => checkedTypes.add(cb.value));
    const minVal = parseFloat(document.getElementById('pipelineMinVal').value) || 0;
    return records.filter(r => { if (checkedStages.size > 0 && !checkedStages.has(r.stage)) return false; if (checkedTypes.size > 0 && !checkedTypes.has(r.permit_type)) return false; if (r.valuation < minVal) return false; return true; });
}
function sortPipelineResults(records) { records.sort((a, b) => { let va = a[pipelineSortCol], vb = b[pipelineSortCol]; if (pipelineSortCol === 'valuation') { va = va || 0; vb = vb || 0; } if (typeof va === 'string') va = va.toLowerCase(); if (typeof vb === 'string') vb = vb.toLowerCase(); if (va < vb) return pipelineSortAsc ? -1 : 1; if (va > vb) return pipelineSortAsc ? 1 : -1; return 0; }); }
function setPipelineSort(col) { if (pipelineSortCol === col) pipelineSortAsc = !pipelineSortAsc; else { pipelineSortCol = col; pipelineSortAsc = col === 'address'; } sortPipelineResults(pipelineResults); renderPipelineResults(); document.querySelectorAll('#pipelineTable th').forEach(th => { th.classList.remove('sort-asc', 'sort-desc'); if (th.dataset.col === col) th.classList.add(pipelineSortAsc ? 'sort-asc' : 'sort-desc'); }); }
function renderPipelineResults() {
    const area = document.getElementById('pipelineResultsArea'); const tbody = document.getElementById('pipelineTableBody'); const title = document.getElementById('pipelineResultsTitle'); const summary = document.getElementById('pipelineResultsSummary'); const exportBtn = document.getElementById('pipelineExportBtn');
    if (!pipelineResults.length) { area.style.display = 'none'; exportBtn.style.display = 'none'; return; }
    area.style.display = 'block'; exportBtn.style.display = 'inline-block'; title.textContent = 'Permit Results';
    const totalVal = pipelineResults.reduce((s, r) => s + (r.valuation || 0), 0); summary.textContent = `${pipelineResults.length} permits Â· $${totalVal.toLocaleString()} total valuation`;
    tbody.innerHTML = pipelineResults.map((r, i) => { const valStr = r.valuation ? '$' + r.valuation.toLocaleString() : 'â€”'; const dateStr = r.date ? r.date.substring(0, 10) : 'â€”'; const stageLabel = PIPELINE_STAGE_LABELS[r.stage] || r.stage; return `<tr onclick="highlightPipelineMarker(${i})" style="cursor:pointer;"><td onclick="event.stopPropagation()"><input type="checkbox" class="pipeline-select" data-idx="${i}" onchange="updatePipelineSelectUI()"></td><td>${r.address || 'â€”'}</td><td style="font-family:monospace;font-size:0.78rem;">${r.permit_nbr || 'â€”'}</td><td>${r.permit_type_label}</td><td><span class="pipeline-badge ${r.stage}">${stageLabel}</span></td><td>${valStr}</td><td>${dateStr}</td><td>${r.zone || 'â€”'}</td><td style="max-width:200px;font-size:0.75rem;color:var(--text-light);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${(r.description || '').replace(/"/g, '&quot;')}">${r.description || 'â€”'}</td></tr>`; }).join('');
    renderPipelineSavedList();
}
function renderPipelineMarkers() {
    if (!pipelineMarkerLayer) return; pipelineMarkerLayer.clearLayers(); const cap = 500;
    pipelineResults.slice(0, cap).forEach((r, i) => { if (!r.lat || !r.lon) return; const color = PIPELINE_COLORS[r.stage] || '#718096'; const marker = L.circleMarker([r.lat, r.lon], { radius: 6, fillColor: color, fillOpacity: 0.8, color: '#fff', weight: 1.5 }); marker.bindPopup(`<div style="font-size:0.82rem;"><strong>${r.address || 'Unknown'}</strong><br>Permit: ${r.permit_nbr}<br>Stage: ${PIPELINE_STAGE_LABELS[r.stage] || r.stage}<br>Valuation: ${r.valuation ? '$' + r.valuation.toLocaleString() : 'N/A'}</div>`, { maxWidth: 280 }); marker.on('click', () => highlightPipelineRow(i)); marker.addTo(pipelineMarkerLayer); });
}
function highlightPipelineMarker(idx) { const r = pipelineResults[idx]; if (!r) return; document.querySelectorAll('#pipelineTable tr.highlighted').forEach(tr => tr.classList.remove('highlighted')); const rows = document.querySelectorAll('#pipelineTableBody tr'); if (rows[idx]) { rows[idx].classList.add('highlighted'); rows[idx].scrollIntoView({ behavior: 'smooth', block: 'nearest' }); } if (r.lat && r.lon && pipelineMapInstance) pipelineMapInstance.setView([r.lat, r.lon], 16); }
function highlightPipelineRow(idx) { document.querySelectorAll('#pipelineTable tr.highlighted').forEach(tr => tr.classList.remove('highlighted')); const rows = document.querySelectorAll('#pipelineTableBody tr'); if (rows[idx]) { rows[idx].classList.add('highlighted'); rows[idx].scrollIntoView({ behavior: 'smooth', block: 'nearest' }); } }
function clearPipelineSearch() { pipelineResults = []; pipelineSearchCenter = null; if (pipelineMarkerLayer) pipelineMarkerLayer.clearLayers(); if (pipelineMapInstance && pipelineMapInstance._centerMarker) { pipelineMapInstance.removeLayer(pipelineMapInstance._centerMarker); pipelineMapInstance._centerMarker = null; } document.getElementById('pipelineResultsArea').style.display = 'none'; document.getElementById('pipelineExportBtn').style.display = 'none'; document.getElementById('pipelineProgress').classList.remove('active'); document.getElementById('pipelineMapStatus').textContent = 'Enter an address or click the map to set a search center'; document.getElementById('pipelineAddress').value = ''; document.getElementById('pipelineMinVal').value = ''; if (pipelineMapInstance) pipelineMapInstance.setView([34.05, -118.25], 12); }
function exportPipelineCSV() { if (!pipelineResults.length) return; const headers = ['Address','Permit #','Type','Stage','Valuation','Date','Zone','Description','Lat','Lon']; const rows = pipelineResults.map(r => [r.address, r.permit_nbr, r.permit_type_label, PIPELINE_STAGE_LABELS[r.stage] || r.stage, r.valuation, r.date ? r.date.substring(0,10) : '', r.zone, (r.description||'').replace(/"/g,'""'), r.lat, r.lon]); let csv = headers.join(',') + '\n'; rows.forEach(row => { csv += row.map(v => `"${v}"`).join(',') + '\n'; }); const blob = new Blob([csv], { type: 'text/csv' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `pipeline_permits_${new Date().toISOString().slice(0,10)}.csv`; a.click(); URL.revokeObjectURL(url); }
function togglePipelineSelectAll() { var allCB = document.getElementById('pipelineSelectAll'); document.querySelectorAll('.pipeline-select').forEach(cb => { cb.checked = allCB.checked; }); updatePipelineSelectUI(); }
function updatePipelineSelectUI() { var checks = document.querySelectorAll('.pipeline-select:checked'); var saveBtn = document.getElementById('pipelineSaveBtn'); if (saveBtn) saveBtn.style.display = checks.length > 0 ? 'inline-block' : 'none'; }
function getPipelineSaved() { try { return JSON.parse(localStorage.getItem('pipeline_saved_list')) || []; } catch(e) { return []; } }
function setPipelineSaved(list) { localStorage.setItem('pipeline_saved_list', JSON.stringify(list)); }
function savePipelineSelected() {
    var checks = document.querySelectorAll('.pipeline-select:checked'); if (checks.length === 0) return;
    var saved = getPipelineSaved(); var existingPermits = new Set(saved.map(s => s.permit_nbr)); var added = 0;
    checks.forEach(cb => { var idx = parseInt(cb.getAttribute('data-idx')); var r = pipelineResults[idx]; if (r && !existingPermits.has(r.permit_nbr)) { saved.push({ address: r.address||'', permit_nbr: r.permit_nbr||'', permit_type: r.permit_type_label||'', stage: r.stage||'', stageLabel: PIPELINE_STAGE_LABELS[r.stage]||r.stage||'', valuation: r.valuation||0, date: r.date ? r.date.substring(0,10) : '', zone: r.zone||'', description: r.description||'', lat: r.lat, lon: r.lon }); added++; } cb.checked = false; });
    setPipelineSaved(saved); updatePipelineSelectUI(); renderPipelineSavedList(); if (added > 0) alert(added + ' site(s) saved.');
}
function renderPipelineSavedList() {
    var saved = getPipelineSaved(); var panel = document.getElementById('pipelineSavedPanel'); var body = document.getElementById('pipelineSavedBody'); var countEl = document.getElementById('pipelineSavedCount'); if (!panel || !body) return;
    if (saved.length === 0) { panel.style.display = 'none'; return; }
    panel.style.display = 'block'; countEl.textContent = saved.length + ' site' + (saved.length === 1 ? '' : 's');
    body.innerHTML = saved.map((r, i) => '<tr><td>' + (r.address||'â€”') + '</td><td style="font-family:monospace;font-size:0.78rem;">' + (r.permit_nbr||'â€”') + '</td><td>' + (r.permit_type||'â€”') + '</td><td>' + (r.stageLabel||'â€”') + '</td><td>' + (r.valuation ? '$' + r.valuation.toLocaleString() : 'â€”') + '</td><td style="max-width:150px;font-size:0.72rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + (r.description||'â€”') + '</td><td><button type="button" class="saved-btn-remove" onclick="removePipelineSaved(' + i + ')">Remove</button></td></tr>').join('');
}
function removePipelineSaved(idx) { var saved = getPipelineSaved(); saved.splice(idx, 1); setPipelineSaved(saved); renderPipelineSavedList(); }
function clearPipelineSaved() { if (!confirm('Remove all saved pipeline sites?')) return; setPipelineSaved([]); renderPipelineSavedList(); }
function exportPipelineSavedCSV() { var saved = getPipelineSaved(); if (saved.length === 0) return; var csv = 'Address,Permit #,Type,Stage,Valuation,Date,Zone,Description,Lat,Lon\n'; saved.forEach(r => { csv += [r.address, r.permit_nbr, r.permit_type, r.stageLabel, r.valuation, r.date, r.zone, '"'+(r.description||'').replace(/"/g,'""')+'"', r.lat, r.lon].join(',') + '\n'; }); var blob = new Blob([csv], { type: 'text/csv' }); var url = URL.createObjectURL(blob); var a = document.createElement('a'); a.href = url; a.download = 'pipeline_saved_' + new Date().toISOString().slice(0,10) + '.csv'; a.click(); URL.revokeObjectURL(url); }

// Pipeline overlay on finder map
function injectPipelineOverlayButton() {
    const container = document.getElementById('finderMapContainer'); if (!container || container.querySelector('.pipeline-overlay-btn')) return;
    const btn = document.createElement('button'); btn.type = 'button'; btn.className = 'pipeline-overlay-btn'; btn.textContent = 'Show Permits Nearby'; btn.onclick = togglePipelineOverlay; container.style.position = 'relative'; container.appendChild(btn);
}
async function togglePipelineOverlay() {
    const btn = document.querySelector('.pipeline-overlay-btn'); if (!btn) return;
    if (pipelineOverlayActive) { if (pipelineOverlayLayer && finderMapInstance) { finderMapInstance.removeLayer(pipelineOverlayLayer); pipelineOverlayLayer = null; } pipelineOverlayActive = false; btn.classList.remove('active'); btn.textContent = 'Show Permits Nearby'; return; }
    const stationSelect = document.getElementById('finderStation2'); if (!stationSelect || stationSelect.selectedIndex < 0) { alert('Select a station first.'); return; }
    const idx = parseInt(stationSelect.value); const station = METRO_STATIONS[idx]; if (!station) return;
    btn.textContent = 'Loading...'; btn.disabled = true;
    try { const permits = await fetchAllPipelinePermits(station.lat, station.lon, 0.5, null); pipelineOverlayLayer = L.layerGroup(); permits.slice(0, 300).forEach(r => { if (!r.lat || !r.lon) return; const m = L.circleMarker([r.lat, r.lon], { radius: 4, fillColor: PIPELINE_COLORS[r.stage]||'#718096', fillOpacity: 0.7, color: '#fff', weight: 1 }); m.bindPopup(`<strong>${r.address||'Permit'}</strong><br>${r.permit_nbr}<br>${PIPELINE_STAGE_LABELS[r.stage]||r.stage}`); m.addTo(pipelineOverlayLayer); }); pipelineOverlayLayer.addTo(finderMapInstance); pipelineOverlayActive = true; btn.classList.add('active'); btn.textContent = `Hide Permits (${Math.min(permits.length, 300)})`; }
    catch (e) { alert('Failed: ' + e.message); btn.textContent = 'Show Permits Nearby'; }
    finally { btn.disabled = false; }
}

// ============================================================
//  SB 79 OPPORTUNITY FINDER
// ============================================================

async function queryParcelsNearStation(lat, lon, radiusFt, onProgress) {
    const baseUrl = 'https://public.gis.lacounty.gov/public/rest/services/LACounty_Cache/LACounty_Parcel/MapServer/0/query';
    const outFields = 'APN,SitusFullAddress,UseType,UseDescription,UseCode,Roll_LandValue,Roll_ImpValue,YearBuilt1,SQFTmain1,Units1,CENTER_LAT,CENTER_LON,Shape.STArea()';
    const allFeatures = []; let offset = 0; const pageSize = 1000; let total = null;
    while (true) {
        const params = new URLSearchParams({ geometry: `${lon},${lat}`, geometryType: 'esriGeometryPoint', inSR: '4326', spatialRel: 'esriSpatialRelIntersects', distance: radiusFt, units: 'esriSRUnit_Foot', outFields, returnGeometry: false, returnCountOnly: false, resultOffset: offset, resultRecordCount: pageSize, f: 'json' });
        const resp = await fetch(`${baseUrl}?${params}`); if (!resp.ok) throw new Error(`HTTP ${resp.status}`); const data = await resp.json(); if (data.error) throw new Error(data.error.message || 'GIS API error');
        const features = data.features || []; allFeatures.push(...features);
        if (onProgress) onProgress(allFeatures.length, total || allFeatures.length + (features.length === pageSize ? pageSize : 0));
        if (features.length < pageSize) break; offset += pageSize; if (offset > 5000) break;
    }
    return allFeatures;
}

function classifyParcelUseType(useType, useDesc, useCode) {
    const ut = (useType || '').toLowerCase(); const ud = (useDesc || '').toLowerCase(); const uc = (useCode || '').toString();
    if (ut.includes('vacant') || ud.includes('vacant') || uc === '0000' || uc === '0100') return 'Vacant';
    if (ut.includes('resident') || ud.includes('resident') || ud.includes('single') || ud.includes('duplex') || ud.includes('apartment') || ud.includes('condo') || uc.startsWith('01') || uc.startsWith('02') || uc.startsWith('03') || uc.startsWith('04')) return 'Residential';
    if (ut.includes('commerc') || ud.includes('commerc') || ud.includes('office') || ud.includes('retail') || uc.startsWith('1') || uc.startsWith('2')) return 'Commercial';
    if (ut.includes('industr') || ud.includes('industr') || ud.includes('warehouse') || uc.startsWith('3') || uc.startsWith('4')) return 'Industrial';
    return 'Commercial';
}
function classifySB79Zone(parcelLat, parcelLon, stationLat, stationLon) { const dist = haversine(parcelLat, parcelLon, stationLat, stationLon); if (dist <= SB79_ZONES.adjacent.maxDist) return { key: 'adjacent', dist }; if (dist <= SB79_ZONES.inner.maxDist) return { key: 'inner', dist }; if (dist <= SB79_ZONES.outer.maxDist) return { key: 'outer', dist }; return { key: 'outside', dist }; }
function getSB79Allowances(tier, zoneKey) { const tierData = SB79_TIERS[tier]; const zone = SB79_ZONES[zoneKey]; if (!tierData || !zone) return null; return { height: Math.round(tierData.height * zone.heightMult), density: Math.round(tierData.density * zone.heightMult), far: parseFloat((tierData.far * zone.heightMult).toFixed(2)), parking: zone.parking }; }

function getAllNearbyTransit(lat, lon, maxMiles) {
    if (!maxMiles) maxMiles = 0.75; var nearby = [];
    for (var i = 0; i < METRO_STATIONS.length; i++) { var s = METRO_STATIONS[i]; var d = haversine(lat, lon, s.lat, s.lon); if (d <= maxMiles) { var tierData = SB79_TIERS[s.tier] || {}; var zoneKey = 'outside', parking = 1.0, heightMult = 0; if (d <= SB79_ZONES.adjacent.maxDist) { zoneKey = 'adjacent'; parking = 0; heightMult = 1.0; } else if (d <= SB79_ZONES.inner.maxDist) { zoneKey = 'inner'; parking = 0; heightMult = 1.0; } else if (d <= SB79_ZONES.outer.maxDist) { zoneKey = 'outer'; parking = 0.5; heightMult = 0.68; } var allowances = null; if (zoneKey !== 'outside') { allowances = { height: Math.round((tierData.height||0)*heightMult), density: Math.round((tierData.density||0)*heightMult), far: parseFloat(((tierData.far||0)*heightMult).toFixed(2)), parking }; } nearby.push({ station: s, stationIdx: i, distMiles: Math.round(d*1000)/1000, tier: s.tier, tierLabel: tierData.label||('Tier '+s.tier), line: s.line, lineLabel: LINE_LABELS[s.line]||s.line, zoneKey, allowances }); } }
    nearby.sort((a,b) => a.distMiles - b.distMiles); return nearby;
}

function getLegislationForResult(result) {
    var useTypes = ['multifamily_high','multifamily_mid','multifamily_low','mixeduse','senior','hotel','duplex','adu'];
    var allBills = {}; var bestUseType = 'multifamily_mid'; var bestCount = 0;
    var lotSf = result.lotSizeSqFt || 10000; var transit = 'moderate';
    if (result.zone === 'adjacent') transit = 'adjacent'; else if (result.zone === 'inner' || result.zone === 'outer') transit = 'near';
    var zoning = 'C2'; if ((result.allowances && result.allowances.far >= 4.0) || result.zone === 'adjacent' || result.zone === 'inner') zoning = 'TOD';
    var prevGeocode = window.lastGeocode; if (result.lat && result.lon) window.lastGeocode = { lat: result.lat, lon: result.lon };
    var inp = { parcelSize: lotSf, frontage: Math.round(Math.sqrt(lotSf)*0.8), zoning, neighborhood: 'dtla', siteCondition: result.useType === 'Vacant' ? 'vacant' : 'demolition', topography: 'flat', cornerLot: false, transit, arterial: 'major', utilities: 'full', constFlood: false, constHillside: false, constHistoric: false, constFault: false, constCoastal: false, constParking: false };
    for (var u = 0; u < useTypes.length; u++) { try { var bills = getApplicableLegislation(useTypes[u], inp); for (var b = 0; b < bills.length; b++) allBills[bills[b].id] = bills[b]; if (bills.length > bestCount) { bestCount = bills.length; bestUseType = useTypes[u]; } } catch(e) {} }
    window.lastGeocode = prevGeocode;
    var billList = []; for (var key in allBills) { if (allBills.hasOwnProperty(key)) billList.push(allBills[key]); }
    return { bills: billList, effects: stackLegislationEffects(billList), bestUseType, inp };
}

function filterAndScoreResults(features, station, filters) {
    const results = [];
    for (const f of features) {
        const a = f.attributes; const lat = parseFloat(a.CENTER_LAT); const lon = parseFloat(a.CENTER_LON); if (!lat || !lon) continue;
        const lotSizeSqFt = Math.round(a['Shape.STArea()'] || a['Shape__Area'] || 0);
        const landVal = parseFloat(a.Roll_LandValue) || 0; const impVal = parseFloat(a.Roll_ImpValue) || 0;
        const impRatio = landVal > 0 ? impVal / landVal : (impVal === 0 ? 0 : 999);
        const yearBuilt = parseInt(a.YearBuilt1) || 0; const useType = classifyParcelUseType(a.UseType, a.UseDescription, a.UseCode);
        const address = a.SitusFullAddress || 'No address'; const apn = a.APN || '';
        const zoneInfo = classifySB79Zone(lat, lon, station.lat, station.lon); if (zoneInfo.key === 'outside') continue;
        if (filters.selectedZones && filters.selectedZones.length > 0 && !filters.selectedZones.includes(zoneInfo.key)) continue;
        if (filters.minLot && lotSizeSqFt < filters.minLot) continue; if (filters.maxLot && lotSizeSqFt > filters.maxLot) continue;
        if (filters.useTypes.length > 0 && !filters.useTypes.includes(useType)) continue;
        const allowances = getSB79Allowances(station.tier, zoneInfo.key);
        var nearbyTransit = getAllNearbyTransit(lat, lon, 0.75);
        var resultObj = { address, apn, lotSizeSqFt, useType, yearBuilt, landVal, impVal, impRatio, lat, lon, zone: zoneInfo.key, zoneDist: zoneInfo.dist, allowances, tier: station.tier, nearbyTransit };
        var legInfo = getLegislationForResult(resultObj); resultObj.legislation = legInfo.bills; resultObj.legislationEffects = legInfo.effects;
        results.push(resultObj);
    }
    return results;
}

function initFinderMap() {
    const mapEl = document.getElementById('finderMap'); if (!mapEl) return;
    if (finderMapInstance) { finderMapInstance.remove(); finderMapInstance = null; }
    finderMapInstance = L.map('finderMap').setView([34.05, -118.25], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors', maxZoom: 18 }).addTo(finderMapInstance);
    const seenCoords = new Set();
    METRO_STATIONS.forEach((s, idx) => { const key = `${s.lat.toFixed(4)},${s.lon.toFixed(4)},${s.line}`; if (seenCoords.has(key)) return; seenCoords.add(key); const color = LINE_COLORS[s.line]||'#718096'; const icon = L.divIcon({ html: `<div style="background:${color};width:10px;height:10px;border-radius:50%;border:2px solid #fff;box-shadow:0 1px 3px rgba(0,0,0,0.3);"></div>`, iconSize: [10,10], iconAnchor: [5,5], className: '' }); const marker = L.marker([s.lat, s.lon], { icon }).bindPopup(`<strong>${s.name}</strong><br>${LINE_LABELS[s.line]||s.line}`).on('click', () => { selectFinderStation2(idx); drawFinderStationRadii(s); }); marker.addTo(finderMapInstance); });
    attachZoneClickHandler(finderMapInstance); renderFinderMapLegend(); populateFinderStations2();
    finderMapInitialized = true; setTimeout(() => { if (finderMapInstance) finderMapInstance.invalidateSize(); }, 200); injectPipelineOverlayButton();
}
function drawFinderStationRadii(station) {
    if (finderMapInstance._finderRadii) finderMapInstance._finderRadii.forEach(c => finderMapInstance.removeLayer(c));
    var tierColor = station.tier === 1 ? '#805ad5' : '#3182ce'; var circles = [];
    circles.push(L.circle([station.lat, station.lon], { radius: 805, color: tierColor, weight: 2.5, opacity: 0.8, fillColor: tierColor, fillOpacity: 0.08, interactive: false, dashArray: '12,8' }).addTo(finderMapInstance));
    circles.push(L.circle([station.lat, station.lon], { radius: 402, color: tierColor, weight: 2.5, opacity: 0.8, fillColor: tierColor, fillOpacity: 0.12, interactive: false, dashArray: '8,6' }).addTo(finderMapInstance));
    circles.push(L.circle([station.lat, station.lon], { radius: 61, color: tierColor, weight: 2.5, opacity: 0.9, fillColor: tierColor, fillOpacity: 0.20, interactive: false, dashArray: '4,4' }).addTo(finderMapInstance));
    finderMapInstance._finderRadii = circles; finderMapInstance.setView([station.lat, station.lon], 14);
}
function renderFinderMapLegend() { const el = document.getElementById('finderMapLegend'); if (!el) return; el.innerHTML = `<div class="legend-item"><span class="legend-dot" style="background:#e53e3e;"></span> Red/B</div><div class="legend-item"><span class="legend-dot" style="background:#805ad5;"></span> Purple/D</div><div class="legend-item"><span class="legend-dot" style="background:#3182ce;"></span> Blue/A</div><div class="legend-item"><span class="legend-dot" style="background:#d69e2e;"></span> Expo/E</div><div class="legend-item"><span class="legend-dot" style="background:#b7791f;"></span> Gold/L</div><div class="legend-item"><span class="legend-dot" style="background:#38a169;"></span> Green/C</div><div class="legend-item"><span class="legend-dot" style="background:#00bcd4;"></span> K Line</div><div class="legend-item"><span class="legend-dot" style="background:#ed64a6;"></span> Regional Connector</div><div class="legend-item"><span class="legend-dot" style="background:#e53e3e;border:2px solid #999;"></span> Metrolink</div>`; }
function populateFinderStations2() { const sel = document.getElementById('finderStation2'); if (!sel) return; sel.innerHTML = ''; const grouped = {}; METRO_STATIONS.forEach((s, idx) => { if (!grouped[s.line]) grouped[s.line] = []; grouped[s.line].push({ ...s, idx }); }); const lineOrder = ['red','purple','blue_a','expo_e','gold_l','green_c','k_line','connector','metrolink']; for (const lineKey of lineOrder) { if (!grouped[lineKey]) continue; const grp = document.createElement('optgroup'); grp.label = LINE_LABELS[lineKey]||lineKey; for (const s of grouped[lineKey]) { const opt = document.createElement('option'); opt.value = s.idx; opt.textContent = s.name; grp.appendChild(opt); } sel.appendChild(grp); } }
function selectFinderStation2(idx) { const sel = document.getElementById('finderStation2'); if (sel && sel.querySelector(`option[value="${idx}"]`)) sel.value = idx; }
document.addEventListener('change', (e) => { if (e.target.id === 'finderStation2' && finderMapInstance) { const station = METRO_STATIONS[parseInt(e.target.value)]; if (station) drawFinderStationRadii(station); } });

async function runStandaloneSearch() {
    const sel = document.getElementById('finderStation2'); const station = METRO_STATIONS[parseInt(sel.value)]; if (!station) return;
    const radiusChecks = document.querySelectorAll('.finderRadius2:checked'); const selectedRadii = Array.from(radiusChecks).map(c => parseInt(c.value)); if (selectedRadii.length === 0) { alert('Select at least one search radius.'); return; }
    const radiusFt = Math.max(...selectedRadii); const useTypes = Array.from(document.querySelectorAll('.finderUseType2:checked')).map(c => c.value);
    const minLot = parseInt(document.getElementById('finderMinLot2').value)||0; const maxLot = parseInt(document.getElementById('finderMaxLot2').value)||999999;
    const selectedZones = []; if (selectedRadii.includes(200)) selectedZones.push('adjacent'); if (selectedRadii.includes(1320)) selectedZones.push('inner'); if (selectedRadii.includes(2640)) selectedZones.push('outer');
    const filters = { useTypes, minLot, maxLot, maxRatio: null, yearBefore: null, selectedZones }; finderSelectedSet.clear();
    const progressEl = document.getElementById('finderProgress2'); const fillEl = document.getElementById('finderProgressFill2'); const textEl = document.getElementById('finderProgressText2'); const btn = document.getElementById('finderSearchBtn2');
    progressEl.classList.add('active'); fillEl.style.width = '0%'; textEl.textContent = 'Querying parcels near ' + station.name + '...'; btn.disabled = true; document.getElementById('finderResultsArea2').innerHTML = '';
    drawFinderStationRadii(station);
    try {
        const features = await queryParcelsNearStation(station.lat, station.lon, radiusFt, (loaded, est) => { fillEl.style.width = Math.min(90, Math.round((loaded/Math.max(est,1))*90)) + '%'; textEl.textContent = `Loading... ${loaded} parcels`; });
        fillEl.style.width = '95%'; textEl.textContent = `Filtering ${features.length} parcels...`;
        finderResults2 = filterAndScoreResults(features, station, filters); finderSortCol2 = 'impRatio'; finderSortAsc2 = true; finderResults2.sort((a,b) => a.impRatio - b.impRatio);
        fillEl.style.width = '100%'; textEl.textContent = `Found ${finderResults2.length} opportunities`; renderFinderResults2(station); addFinderParcelsToMap2(station);
    } catch (e) { document.getElementById('finderResultsArea2').innerHTML = `<div class="finder-error"><strong>Search failed:</strong> ${e.message}</div>`; }
    btn.disabled = false; setTimeout(() => progressEl.classList.remove('active'), 2000);
}

function renderFinderResults2(station) {
    const area = document.getElementById('finderResultsArea2');
    if (finderResults2.length === 0) { area.innerHTML = '<div class="finder-no-results">No parcels matched your filters.</div>'; return; }
    const zoneBadge = (z) => `<span class="zone-badge ${z}">${z.charAt(0).toUpperCase()+z.slice(1)}</span>`;
    const ratioClass = (r) => r < 0.5 ? 'imp-ratio-hot' : r < 1.0 ? 'imp-ratio-warm' : 'imp-ratio-cool';
    const f = (v) => v ? '$'+v.toLocaleString() : '-';
    let html = `<div id="finderSelectionBar" class="selection-bar" style="display:none;"><span id="finderSelCount">0</span><button type="button" class="finder-btn-export" onclick="addSelectionToSaved()" style="margin:0 0.5rem;">Add to Saved</button><button type="button" class="finder-btn-export" onclick="clearFinderSelection()">Clear</button></div>`;
    html += `<div class="finder-summary">${finderResults2.length} opportunities near <strong>${station.name}</strong></div>`;
    html += `<div class="finder-table-wrapper"><table class="finder-table" id="finderTable2"><thead><tr><th onclick="event.stopPropagation();toggleSelectAll()"><input type="checkbox" id="finderSelectAll" onclick="event.stopPropagation();toggleSelectAll()"></th><th onclick="sortFinderTable2('address')">Address</th><th onclick="sortFinderTable2('apn')">APN</th><th onclick="sortFinderTable2('lotSizeSqFt')">Lot Size</th><th onclick="sortFinderTable2('useType')">Use</th><th onclick="sortFinderTable2('yearBuilt')">Year</th><th onclick="sortFinderTable2('landVal')">Land Val</th><th onclick="sortFinderTable2('impVal')">Imp Val</th><th onclick="sortFinderTable2('impRatio')">Imp/Land</th><th onclick="sortFinderTable2('zone')">Zone</th><th>Allowances</th><th>Links</th></tr></thead><tbody>`;
    finderResults2.forEach((r, i) => { const allow = r.allowances; const allowStr = allow ? `${allow.height}ft/${allow.density}du/${allow.far}FAR` : '-'; const checked = finderSelectedSet.has(i) ? 'checked' : ''; const enc = encodeURIComponent(r.address); const apnClean = (r.apn||'').replace(/[^0-9]/g,''); html += `<tr onclick="highlightFinderParcel2(${i})" id="finderRow2_${i}"><td onclick="event.stopPropagation()"><input type="checkbox" class="finder-row-check" data-idx="${i}" ${checked} onchange="onFinderCheckChange()"></td><td>${r.address}</td><td>${r.apn}</td><td>${r.lotSizeSqFt > 0 ? r.lotSizeSqFt.toLocaleString()+' sf' : '-'}</td><td>${r.useType}</td><td>${r.yearBuilt > 0 ? r.yearBuilt : '-'}</td><td>${f(r.landVal)}</td><td>${f(r.impVal)}</td><td class="${ratioClass(r.impRatio)}">${r.impRatio < 100 ? r.impRatio.toFixed(2) : 'N/A'}</td><td>${zoneBadge(r.zone)}</td><td style="font-size:0.75rem;">${allowStr}</td><td><span class="prop-links" onclick="event.stopPropagation()"><a href="https://www.zillow.com/homes/${enc}_rb/" target="_blank">Z</a> | <a href="https://portal.assessor.lacounty.gov/parceldetail/${apnClean}" target="_blank">LA</a></span></td></tr>`; });
    html += '</tbody></table></div>';
    html += `<button type="button" class="finder-btn-export" onclick="exportFinderCSV2()">Export CSV (${finderResults2.length})</button>`;
    area.innerHTML = html; updateSelectionBar();
}
function sortFinderTable2(col) { if (finderSortCol2 === col) finderSortAsc2 = !finderSortAsc2; else { finderSortCol2 = col; finderSortAsc2 = true; } finderResults2.sort((a,b) => { let va = a[col], vb = b[col]; if (typeof va === 'string') { va = va.toLowerCase(); vb = (vb||'').toLowerCase(); return finderSortAsc2 ? va.localeCompare(vb) : vb.localeCompare(va); } va = va||0; vb = vb||0; return finderSortAsc2 ? va - vb : vb - va; }); const station = METRO_STATIONS[parseInt(document.getElementById('finderStation2').value)]; renderFinderResults2(station); }
function addFinderParcelsToMap2(station) { if (!finderMapInstance) return; if (finderParcelLayer2) finderMapInstance.removeLayer(finderParcelLayer2); finderParcelLayer2 = L.layerGroup().addTo(finderMapInstance); finderResults2.forEach((r, i) => { if (!r.lat || !r.lon) return; let color = '#38a169'; if (r.impRatio < 0.5) color = '#e53e3e'; else if (r.impRatio < 1.0) color = '#dd6b20'; const marker = L.circleMarker([r.lat, r.lon], { radius: 5, fillColor: color, color: '#fff', weight: 1, opacity: 0.9, fillOpacity: 0.8 }); marker.bindPopup(`<strong>${r.address}</strong><br>APN: ${r.apn}<br>Lot: ${r.lotSizeSqFt > 0 ? r.lotSizeSqFt.toLocaleString()+' sf' : '-'}<br>Imp/Land: ${r.impRatio < 100 ? r.impRatio.toFixed(2) : 'N/A'}`); marker.on('click', () => { const row = document.getElementById('finderRow2_'+i); if (row) { row.classList.add('highlighted'); row.scrollIntoView({ behavior: 'smooth', block: 'center' }); } }); marker.addTo(finderParcelLayer2); }); }
function highlightFinderParcel2(idx) { const r = finderResults2[idx]; if (!r || !finderMapInstance) return; document.querySelectorAll('#finderTable2 tr.highlighted').forEach(tr => tr.classList.remove('highlighted')); const row = document.getElementById('finderRow2_'+idx); if (row) row.classList.add('highlighted'); finderMapInstance.setView([r.lat, r.lon], 17); }
function exportFinderCSV2() { if (finderResults2.length === 0) return; const headers = ['Address','APN','Lot Size','Use','Year','Land Value','Imp Value','Imp/Land','Zone','Height','Density','FAR','Lat','Lon']; const rows = finderResults2.map(r => { const a = r.allowances||{}; return [`"${(r.address||'').replace(/"/g,'""')}"`,r.apn,r.lotSizeSqFt,r.useType,r.yearBuilt||'',r.landVal,r.impVal,r.impRatio < 100 ? r.impRatio.toFixed(3):'',r.zone,a.height||'',a.density||'',a.far||'',r.lat,r.lon].join(','); }); const csv = [headers.join(','), ...rows].join('\n'); const blob = new Blob([csv], { type: 'text/csv' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `sb79-opportunities-${new Date().toISOString().slice(0,10)}.csv`; a.click(); URL.revokeObjectURL(url); }

// Selection & Saved List
function onFinderCheckChange() { finderSelectedSet.clear(); document.querySelectorAll('.finder-row-check:checked').forEach(cb => finderSelectedSet.add(parseInt(cb.dataset.idx))); const allCb = document.getElementById('finderSelectAll'); if (allCb) allCb.checked = finderSelectedSet.size === document.querySelectorAll('.finder-row-check').length && finderSelectedSet.size > 0; updateSelectionBar(); }
function toggleSelectAll() { const allCb = document.getElementById('finderSelectAll'); const checks = document.querySelectorAll('.finder-row-check'); const shouldCheck = allCb ? allCb.checked : false; finderSelectedSet.clear(); checks.forEach(cb => { cb.checked = shouldCheck; if (shouldCheck) finderSelectedSet.add(parseInt(cb.dataset.idx)); }); updateSelectionBar(); }
function updateSelectionBar() { const bar = document.getElementById('finderSelectionBar'); if (!bar) return; if (finderSelectedSet.size > 0) { bar.style.display = 'flex'; document.getElementById('finderSelCount').textContent = finderSelectedSet.size + ' selected'; } else bar.style.display = 'none'; }
function clearFinderSelection() { finderSelectedSet.clear(); document.querySelectorAll('.finder-row-check').forEach(cb => cb.checked = false); const allCb = document.getElementById('finderSelectAll'); if (allCb) allCb.checked = false; updateSelectionBar(); }
function addSelectionToSaved() { if (finderSelectedSet.size === 0) return; const saved = getSavedList(); const existingApns = new Set(saved.map(s => s.apn)); let added = 0; finderSelectedSet.forEach(idx => { const r = finderResults2[idx]; if (r && !existingApns.has(r.apn)) { saved.push({ address: r.address, apn: r.apn, lotSizeSqFt: r.lotSizeSqFt, useType: r.useType, yearBuilt: r.yearBuilt, landVal: r.landVal, impVal: r.impVal, impRatio: r.impRatio, zone: r.zone, allowances: r.allowances, lat: r.lat, lon: r.lon, tier: r.tier }); added++; } }); setSavedList(saved); clearFinderSelection(); renderSavedList(); if (added > 0) { const panel = document.getElementById('savedListPanel'); if (panel) panel.scrollIntoView({ behavior: 'smooth' }); } }
function getSavedList() { try { return JSON.parse(localStorage.getItem('sb79_saved_list')) || []; } catch { return []; } }
function setSavedList(list) { localStorage.setItem('sb79_saved_list', JSON.stringify(list)); }
function renderSavedList() {
    const saved = getSavedList(); const panel = document.getElementById('savedListPanel'); const body = document.getElementById('savedListBody'); const countEl = document.getElementById('savedListCount'); if (!panel || !body) return;
    if (saved.length === 0) { panel.style.display = 'none'; return; }
    panel.style.display = 'block'; countEl.textContent = saved.length + ' propert' + (saved.length === 1 ? 'y' : 'ies');
    body.innerHTML = saved.map((r, i) => { const enc = encodeURIComponent(r.address||''); const apnClean = (r.apn||'').replace(/[^0-9]/g,''); return `<tr><td><input type="checkbox" class="saved-select" data-idx="${i}"></td><td>${r.address}</td><td>${r.apn}</td><td>${r.lotSizeSqFt > 0 ? r.lotSizeSqFt.toLocaleString()+' sf' : '-'}</td><td>${r.zone||'-'}</td><td><span class="prop-links"><a href="https://www.zillow.com/homes/${enc}_rb/" target="_blank">Z</a> | <a href="https://portal.assessor.lacounty.gov/parceldetail/${apnClean}" target="_blank">LA</a></span></td><td><button type="button" class="saved-btn-remove" onclick="removeSavedItem(${i})">Remove</button></td></tr>`; }).join('');
}
function removeSavedItem(idx) { const saved = getSavedList(); saved.splice(idx, 1); setSavedList(saved); renderSavedList(); }
function clearSavedList() { if (!confirm('Remove all saved properties?')) return; setSavedList([]); renderSavedList(); }
function toggleSavedSelectAll() { var allCB = document.getElementById('savedSelectAll'); document.querySelectorAll('.saved-select').forEach(cb => { cb.checked = allCB.checked; }); }
function combineContiguousParcels() {
    var checks = document.querySelectorAll('.saved-select:checked'); if (checks.length < 2 || checks.length > 4) { alert('Select 2-4 parcels.'); return; }
    var saved = getSavedList(); var selected = []; checks.forEach(cb => { var idx = parseInt(cb.getAttribute('data-idx')); if (saved[idx]) selected.push(saved[idx]); });
    var combinedLotSize = selected.reduce((s,p) => s + (p.lotSizeSqFt||0), 0); var avgLat = selected.reduce((s,p) => s + (p.lat||0), 0)/selected.length; var avgLon = selected.reduce((s,p) => s + (p.lon||0), 0)/selected.length;
    var bestFar = 0; selected.forEach(p => { if (p.allowances && (p.allowances.far||0) > bestFar) bestFar = p.allowances.far; });
    var combined = { address: 'COMBINED: ' + selected.map(p => p.address||p.apn).join(' + '), apn: selected.map(p => p.apn).join('+'), lotSizeSqFt: combinedLotSize, useType: selected[0].useType||'Commercial', yearBuilt: 0, landVal: selected.reduce((s,p)=>s+(p.landVal||0),0), impVal: selected.reduce((s,p)=>s+(p.impVal||0),0), lat: avgLat, lon: avgLon, zone: selected[0].zone||'inner', allowances: { far: bestFar||3.0, height: 55, density: 70, parking: '0.5/unit' }, isCombined: true };
    combined.impRatio = combined.landVal > 0 ? combined.impVal/combined.landVal : 0;
    saved.unshift(combined); setSavedList(saved); renderSavedList(); alert('Combined parcel created!');
}
function exportSavedCSV() { const saved = getSavedList(); if (saved.length === 0) return; const headers = ['Address','APN','Lot Size','Use','Year','Land Value','Imp Value','Imp/Land','Zone','Height','Density','FAR','Lat','Lon']; const rows = saved.map(r => { const a = r.allowances||{}; return [`"${(r.address||'').replace(/"/g,'""')}"`,r.apn,r.lotSizeSqFt,r.useType,r.yearBuilt||'',r.landVal,r.impVal,r.impRatio < 100 ? r.impRatio.toFixed(3):'',r.zone,a.height||'',a.density||'',a.far||'',r.lat,r.lon].join(','); }); const csv = [headers.join(','), ...rows].join('\n'); const blob = new Blob([csv], { type: 'text/csv' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `sb79-saved-${new Date().toISOString().slice(0,10)}.csv`; a.click(); URL.revokeObjectURL(url); }

// Load saved list on page init
document.addEventListener('DOMContentLoaded', () => { renderSavedList(); renderPipelineSavedList(); renderAgentSites(); });

// ============================================================
//  Listing One-Pager
// ============================================================
function generateListingOnePager(result, inp, address) {
    const effects = stackLegislationEffects(result.legislation || []);
    const budget = generateBudget(result.id, inp, effects);
    const ease = computeEaseOfExecution(result.id, inp, effects);
    const risk = computeRiskLevel(result.id, inp, effects);

    // Values â€” Residual Land Value approach
    // What a developer would pay: Stabilized Value minus all costs except land
    const devCostsExLand = (budget.totalHard || 0) + (budget.totalSoft || 0);
    const residualLandValue = Math.max(0, (budget.stabilizedValue || 0) - devCostsExLand);

    // Estimated current market value â€” use county assessed value with Prop 13 multiplier
    // CA Prop 13 assessed values are typically 40-60% of market for older properties
    const geo = window.lastGeocode || {};
    let estimatedMarketValue = 0;
    let marketValueSource = '';
    if (geo.assessedTotal && geo.assessedTotal > 0) {
        // Prop 13 adjustment: assessed values lag market by ~1.8-2.2x in LA
        const prop13Mult = 1.9;
        estimatedMarketValue = Math.round(geo.assessedTotal * prop13Mult);
        marketValueSource = 'County assessed value adjusted for Prop 13';
    } else {
        // Fallback: use land PSF estimate (less accurate)
        const landValPSF = LAND_VALUE_PSF[inp.neighborhood] || 150;
        estimatedMarketValue = Math.round(landValPSF * inp.parcelSize * 1.3);
        marketValueSource = 'Estimated from neighborhood land values';
    }

    // Premium a developer would pay over current market value
    const premium = residualLandValue - estimatedMarketValue;
    const premiumPct = estimatedMarketValue > 0 ? ((premium / estimatedMarketValue) * 100).toFixed(0) : 'N/A';

    // Opportunity Ratio â€” dev land bid / market value. >= 1.5x is a strong opportunity
    const oppRatio = estimatedMarketValue > 0 ? residualLandValue / estimatedMarketValue : 0;
    let oppBanner = '';
    if (oppRatio >= 1.5) {
        oppBanner = `<div style="background:#059669;color:white;padding:0.75rem 1.25rem;text-align:center;font-weight:700;font-size:0.95rem;border-radius:10px;margin-bottom:1rem;">
            STRONG LISTING OPPORTUNITY &mdash; Developer would pay <span style="font-size:1.15rem;">${oppRatio.toFixed(1)}x</span> current market value
        </div>`;
    } else if (oppRatio >= 1.0) {
        oppBanner = `<div style="background:#ca8a04;color:white;padding:0.75rem 1.25rem;text-align:center;font-weight:700;font-size:0.95rem;border-radius:10px;margin-bottom:1rem;">
            MODERATE OPPORTUNITY &mdash; Developer would pay <span style="font-size:1.15rem;">${oppRatio.toFixed(1)}x</span> current market value. Upside is limited.
        </div>`;
    } else {
        oppBanner = `<div style="background:#dc2626;color:white;padding:0.75rem 1.25rem;text-align:center;font-weight:700;font-size:0.90rem;border-radius:10px;margin-bottom:1rem;">
            NOT A STRONG LISTING OPPORTUNITY &mdash; Developer land bid (${fmt(residualLandValue)}) is <em>below</em> current market value (${fmt(estimatedMarketValue)}). The property is worth more as-is than what a developer would pay to redevelop it. Ratio: ${oppRatio.toFixed(2)}x
        </div>`;
    }

    // Building params
    const bp = BUILDING_PARAMS[result.id] || {};
    const far = FAR_TYPICAL[result.id] || 2.5;
    const effectiveFAR = effects.farBonus ? far * (1 + effects.farBonus) : far;
    const buildableSF = Math.round(inp.parcelSize * effectiveFAR);
    const avgUnit = bp.avgUnitSF || 850;
    const units = bp.hasUnits !== false ? Math.max(1, Math.floor(buildableSF * 0.85 / avgUnit)) : 0;
    const stories = bp.stories || Math.min(Math.ceil(effectiveFAR / 0.85), 8);
    const timeline = TIMELINE_MONTHS[result.id] || 36;

    // Ease meter color
    let easeColor = '#ef4444';
    if (ease >= 75) easeColor = '#22c55e';
    else if (ease >= 50) easeColor = '#eab308';
    else if (ease >= 25) easeColor = '#f97316';

    // SB 79 section
    let sb79HTML = '';
    if (window.lastGeocode) {
        const sb79 = detectSB79Eligibility(window.lastGeocode.lat, window.lastGeocode.lon);
        if (sb79 && sb79.eligible) {
            const st = sb79.nearestStation;
            sb79HTML = `
            <div class="onepager-sb79">
                <h4 style="margin:0 0 0.5rem;font-size:0.85rem;color:#0f766e;">SB 79 Transit-Oriented Development</h4>
                <div style="font-size:0.8rem;color:#334155;">
                    <strong>Eligible</strong> â€” ${st.zone.charAt(0).toUpperCase()+st.zone.slice(1)} Zone (${(st.distance).toFixed(2)} mi from ${st.name})<br>
                    Tier ${st.tier} (${st.tier===1?'Heavy Rail':'Light Rail / Commuter Rail'})
                    ${st.allowances ? `<br>Height: ${st.allowances.height} ft &bull; Density: ${st.allowances.density} du/ac &bull; FAR: ${st.allowances.far} &bull; Parking: ${st.allowances.parking}` : ''}
                </div>
            </div>`;
        }
    }

    // Legislation section
    let legHTML = '';
    if (result.legislation && result.legislation.length > 0) {
        legHTML = `
        <div class="onepager-legislation">
            <h4 style="font-size:0.85rem;color:var(--primary);margin-bottom:0.5rem;">Applicable Legislation</h4>
            <div class="leg-pills">
                ${result.legislation.map(l => `<span class="leg-pill">${l.name}</span>`).join('')}
            </div>
        </div>`;
    }

    // Use name
    const useDef = LAND_USES.find(u => u.id === result.id) || { name: result.name, icon: '' };

    return `
    <div class="onepager-hero">
        <h2>Your Land Is Worth More Than You Think</h2>
        <div class="address">${address || 'Subject Property'}</div>
        <div class="value-trio">
            <div class="value-box">
                <div class="val-label">Est. Current Market Value</div>
                <div class="val-amount">${fmt(estimatedMarketValue)}</div>
            </div>
            <div class="value-arrow">&rarr;</div>
            <div class="value-box">
                <div class="val-label">What a Developer Would Pay</div>
                <div class="val-amount uplift" style="color:#fde68a;">${fmt(residualLandValue)}</div>
            </div>
        </div>
        <div style="margin-top:1rem;font-size:0.92rem;opacity:0.9;">
            ${oppRatio >= 1.5 ? `That\u2019s <strong style="color:#fde68a;font-size:1.15rem;">${oppRatio.toFixed(1)}x</strong> the current market value &mdash; a <strong style="color:#fde68a;">+${fmt(premium)}</strong> premium` : oppRatio >= 1.0 ? `Developer would pay <strong style="color:#fde68a;">${oppRatio.toFixed(1)}x</strong> current value &mdash; modest upside of +${fmt(premium)}` : `Developer land bid is <strong style="color:#fca5a5;">${oppRatio.toFixed(2)}x</strong> of current market value`}
        </div>
        <div style="font-size:0.7rem;opacity:0.6;margin-top:0.5rem;">${marketValueSource} &mdash; verify with Zillow/Redfin comps</div>
    </div>
    <div class="onepager-body">
        ${oppBanner}
        <div class="onepager-grid">
            <div class="onepager-section">
                <h4>Best Use Recommendation</h4>
                <div style="font-size:1.1rem;font-weight:700;margin-bottom:0.5rem;">${useDef.icon} ${useDef.name}</div>
                <div class="onepager-metric"><span class="m-label">HBU Score</span><span class="m-value">${result.overall}/100</span></div>
                <div class="onepager-metric"><span class="m-label">Feasibility</span><span class="m-value" style="color:${result.devMarginPct >= 0.15 ? '#16a34a' : result.devMarginPct >= 0 ? '#ca8a04' : '#dc2626'}">${result.devMarginPct >= 0.15 ? 'Feasible' : result.devMarginPct >= 0 ? 'Marginal' : 'Not Feasible'}</span></div>
                <div class="onepager-metric"><span class="m-label">Risk Level</span><span class="m-value">${risk}</span></div>
                <h4 style="margin-top:1rem;">Ease of Build</h4>
                <div class="ease-meter">
                    <span style="font-weight:700;font-size:0.85rem;">${ease}/100</span>
                    <div class="ease-meter-bar"><div class="ease-meter-fill" style="width:${ease}%;background:${easeColor};"></div></div>
                </div>
                <div style="font-size:0.72rem;color:#94a3b8;margin-top:0.25rem;">${ease >= 75 ? 'Streamlined by-right approvals expected' : ease >= 50 ? 'Standard entitlement process' : 'Complex discretionary approvals likely'}</div>
            </div>
            <div class="onepager-section">
                <h4>Key Development Metrics</h4>
                <div class="onepager-metric"><span class="m-label">Lot Size</span><span class="m-value">${inp.parcelSize.toLocaleString()} SF</span></div>
                <div class="onepager-metric"><span class="m-label">Buildable Area</span><span class="m-value">${buildableSF.toLocaleString()} SF</span></div>
                ${units > 0 ? `<div class="onepager-metric"><span class="m-label">Est. Units</span><span class="m-value">${units}</span></div>` : ''}
                <div class="onepager-metric"><span class="m-label">Stories</span><span class="m-value">${stories}</span></div>
                <div class="onepager-metric"><span class="m-label">FAR</span><span class="m-value">${effectiveFAR.toFixed(2)}</span></div>
                <div class="onepager-metric"><span class="m-label">Stabilized Value</span><span class="m-value">${fmt(budget.stabilizedValue || 0)}</span></div>
                <div class="onepager-metric"><span class="m-label">Dev Costs (ex. Land)</span><span class="m-value">${fmt(devCostsExLand)}</span></div>
                <div class="onepager-metric"><span class="m-label">Developer Land Bid</span><span class="m-value" style="color:#059669;font-weight:800;">${fmt(residualLandValue)}</span></div>
                <div class="onepager-metric"><span class="m-label">Timeline</span><span class="m-value">~${timeline} months</span></div>
            </div>
        </div>
        ${sb79HTML}
        ${legHTML}
        <div class="onepager-branding">
            <div class="agent-name">Prepared by CLS CRE &mdash; Land to Yield</div>
            <div style="font-size:0.75rem;color:#94a3b8;">landtoyield.com</div>
        </div>
        <div class="onepager-disclaimer">
            This report is for informational purposes only and does not constitute an appraisal, legal opinion, or guarantee of development feasibility.
            All estimates are based on publicly available data, zoning assumptions, and market averages. Actual values, costs, and entitlement outcomes may vary.
            Consult licensed professionals before making investment decisions. &copy; ${new Date().getFullYear()} CLS CRE.
        </div>
    </div>`;
}

function openListingOnePager(resultIndex) {
    if (!lastResults || !lastInputs) { alert('Please run a calculation first.'); return; }
    const result = lastResults[resultIndex];
    if (!result) return;
    const address = document.getElementById('addressInput').value.trim() || 'Subject Property';
    const html = generateListingOnePager(result, lastInputs, address);
    document.getElementById('onepagerContent').innerHTML = html;
    document.getElementById('onepagerModal').style.display = '';
    document.body.style.overflow = 'hidden';
}

function openListingOnePagerFromData(siteData) {
    // Rebuild inputs and result from saved site data (My Sites tab)
    const inp = siteData.inputs || buildInpFromSaved(siteData);
    const useId = siteData.bestUseId || determineBestUse(inp);
    const legislation = getApplicableLegislation(useId, inp);
    const effects = stackLegislationEffects(legislation);
    const legal = scoreLegal(useId, inp, effects);
    const physical = scorePhysical(useId, inp);
    const financial = scoreFinancial(useId, inp, effects);
    const productive = scoreProductive(useId, inp, effects);
    const budget = generateBudget(useId, inp, effects);
    let overall;
    if (legal === 0) { overall = 0; } else {
        overall = legal * 0.25 + physical * 0.20 + financial * 0.30 + productive * 0.25;
        if (legal <= 0.5) overall *= 0.8;
        if (budget.devMargin < -0.15) overall *= 0.50;
        else if (budget.devMargin < -0.05) overall *= 0.65;
        else if (budget.devMargin < 0) overall *= 0.80;
    }
    const useDef = LAND_USES.find(u => u.id === useId) || {};
    const result = {
        id: useId, name: useDef.name || useId, icon: useDef.icon || '',
        legal: Math.round(legal * 100), physical: Math.round(physical * 100),
        financial: Math.round(financial * 100), productive: Math.round(productive * 100),
        overall: Math.round(overall * 100), devMarginPct: budget.devMargin, legislation
    };
    // Restore geocode if available
    if (siteData.lat && siteData.lon) window.lastGeocode = { lat: siteData.lat, lon: siteData.lon };
    const html = generateListingOnePager(result, inp, siteData.address || 'Subject Property');
    document.getElementById('onepagerContent').innerHTML = html;
    document.getElementById('onepagerModal').style.display = '';
    document.body.style.overflow = 'hidden';
}

function closeOnePager() {
    document.getElementById('onepagerModal').style.display = 'none';
    document.body.style.overflow = '';
}

function printOnePager() {
    document.body.classList.add('printing-onepager');
    window.print();
    document.body.classList.remove('printing-onepager');
}

// ============================================================
//  buildInpFromSaved + determineBestUse (for finder/pipeline)
// ============================================================
function buildInpFromSaved(prop) {
    let neighborhood = 'dtla';
    if (prop.lat && prop.lon) { let minDist = Infinity; for (const [key, c] of Object.entries(NEIGHBORHOOD_CENTROIDS)) { const d = Math.sqrt(Math.pow(prop.lat - c.lat, 2) + Math.pow(prop.lon - c.lon, 2)); if (d < minDist) { minDist = d; neighborhood = key; } } }
    let zoning = 'C2'; if ((prop.allowances && prop.allowances.far >= 4.0) || prop.zone === 'adjacent' || prop.zone === 'inner') zoning = 'TOD';
    let transit = 'moderate'; if (prop.zone === 'adjacent') transit = 'adjacent'; else if (prop.zone === 'inner' || prop.zone === 'outer') transit = 'near';
    return { parcelSize: prop.lotSizeSqFt||10000, frontage: Math.round(Math.sqrt(prop.lotSizeSqFt||10000)*0.8), zoning, neighborhood, siteCondition: prop.useType === 'Vacant' ? 'vacant' : 'demolition', topography: 'flat', cornerLot: false, transit, arterial: 'major', utilities: 'full', constFlood: false, constHillside: false, constHistoric: false, constFault: false, constCoastal: false, constParking: false };
}
function determineBestUse(inp) {
    let bestId = 'multifamily_mid'; let bestScore = 0;
    for (const use of LAND_USES) { const legislation = getApplicableLegislation(use.id, inp); const effects = stackLegislationEffects(legislation); const legal = scoreLegal(use.id, inp, effects); const physical = scorePhysical(use.id, inp); const financial = scoreFinancial(use.id, inp, effects); const productive = scoreProductive(use.id, inp, effects); const composite = (legal*25 + physical*25 + financial*30 + productive*20)/100; if (composite > bestScore && legal > 0) { bestScore = composite; bestId = use.id; } }
    return bestId;
}

// ============================================================
//  My Sites â€” localStorage persistence + map + table
// ============================================================
function getAgentSites() {
    try { return JSON.parse(localStorage.getItem('agent_sites') || '[]'); } catch(e) { return []; }
}
function setAgentSites(sites) {
    localStorage.setItem('agent_sites', JSON.stringify(sites));
}

function computeAttractivenessScore(site) {
    // Opportunity Ratio drives the score â€” agents care about dev bid vs market value
    const oppRatio = site.oppRatio || (site.asIsValue > 0 ? site.devValue / site.asIsValue : 0);
    // oppRatio score: 0x=0, 1.0x=40, 1.5x=70, 2.0x=90, 2.5x+=100
    const oppScore = Math.min(100, Math.max(0, oppRatio * 45));
    const marginScore = Math.min(100, Math.max(0, (site.devMarginPct + 0.10) * 250)); // -10% = 0, 30% = 100
    const easeScore = Math.max(0, Math.min(100, site.ease || 0));
    // 50% opp ratio, 25% margin, 25% ease
    let score = Math.round(oppScore * 0.50 + marginScore * 0.25 + easeScore * 0.25);
    // Harsh penalty if dev bid is below market value â€” not worth pursuing
    if (oppRatio < 1.0) score = Math.min(score, 30);
    return score;
}

function saveToAgentSites(results, inp) {
    if (!results || results.length === 0) return;
    const topResult = results[0];
    const effects = stackLegislationEffects(topResult.legislation || []);
    const budget = generateBudget(topResult.id, inp, effects);
    const ease = computeEaseOfExecution(topResult.id, inp, effects);
    // Estimated market value using county assessed + Prop 13 multiplier
    const geo2 = window.lastGeocode || {};
    let asIsValue = 0;
    if (geo2.assessedTotal && geo2.assessedTotal > 0) {
        asIsValue = Math.round(geo2.assessedTotal * 1.9);
    } else {
        const landValPSF = LAND_VALUE_PSF[inp.neighborhood] || 150;
        asIsValue = Math.round(landValPSF * inp.parcelSize * 1.3);
    }
    // Developer land bid (residual)
    const devCostsExLand = (budget.totalHard || 0) + (budget.totalSoft || 0);
    const devValue = Math.max(0, (budget.stabilizedValue || 0) - devCostsExLand);
    const uplift = devValue - asIsValue;
    const address = document.getElementById('addressInput').value.trim() || 'Unknown Address';
    const geo = window.lastGeocode || {};

    const site = {
        id: Date.now().toString(),
        address: address,
        lat: geo.lat || null,
        lon: geo.lon || null,
        bestUseId: topResult.id,
        bestUseName: topResult.name,
        bestUseIcon: topResult.icon || '',
        overall: topResult.overall,
        lotSize: inp.parcelSize,
        asIsValue: asIsValue,
        devValue: devValue,
        uplift: uplift,
        devMarginPct: topResult.devMarginPct,
        ease: ease,
        oppRatio: asIsValue > 0 ? devValue / asIsValue : 0,
        status: 'not_contacted',
        inputs: inp,
        date: new Date().toISOString().slice(0, 10),
    };
    site.attractiveness = computeAttractivenessScore(site);

    const sites = getAgentSites();
    // Replace if same address exists
    const existIdx = sites.findIndex(s => s.address === site.address);
    if (existIdx >= 0) sites.splice(existIdx, 1);
    sites.unshift(site);
    setAgentSites(sites);
}

let sitesMapMarkers = [];
let sitesSortCol = 'score';
let sitesSortAsc = false;

function initSitesMap() {
    if (sitesMapInitialized) return;
    sitesMapInstance = L.map('sitesMap', { scrollWheelZoom: true }).setView([34.05, -118.25], 11);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap &copy; CARTO', maxZoom: 19
    }).addTo(sitesMapInstance);
    sitesMapInitialized = true;
    renderAgentSites();
}

function getAttractivenessColor(score) {
    if (score >= 75) return '#059669';
    if (score >= 50) return '#d69e2e';
    if (score >= 25) return '#ea580c';
    return '#dc2626';
}

const PROSPECT_STATUSES = {
    not_contacted: { label: 'Not Contacted', cls: 'ps-not-contacted' },
    contacted:     { label: 'Contacted',     cls: 'ps-contacted' },
    interested:    { label: 'Interested',    cls: 'ps-interested' },
    listed:        { label: 'Listed',        cls: 'ps-listed' },
    sold:          { label: 'Sold',          cls: 'ps-sold' },
    passed:        { label: 'Passed',        cls: 'ps-passed' }
};

function updateProspectStatus(id, newStatus) {
    const sites = getAgentSites();
    const site = sites.find(s => s.id === id);
    if (site) { site.status = newStatus; setAgentSites(sites); renderAgentSites(); }
}

function updatePipelineMetrics(allSites) {
    const counts = { not_contacted: 0, contacted: 0, interested: 0, listed: 0, sold: 0, passed: 0 };
    allSites.forEach(s => { const st = s.status || 'not_contacted'; if (counts[st] !== undefined) counts[st]++; });
    const el = (id, val) => { const e = document.getElementById(id); if (e) e.textContent = val; };
    el('pmTotal', allSites.length);
    el('pmContacted', counts.contacted);
    el('pmInterested', counts.interested);
    el('pmListed', counts.listed);
    el('pmSold', counts.sold);
    const contactedPlus = counts.contacted + counts.interested + counts.listed + counts.sold;
    const conversion = contactedPlus > 0 ? ((counts.listed + counts.sold) / contactedPlus * 100).toFixed(0) + '%' : '0%';
    el('pmConversion', conversion);
}

function renderAgentSites() {
    let sites = getAgentSites();
    const tbody = document.getElementById('sitesTableBody');
    const countEl = document.getElementById('sitesCount');

    // Update pipeline metrics from ALL sites before filtering
    updatePipelineMetrics(sites);

    // Filter by prospect status
    const statusFilter = document.getElementById('filterProspectStatus');
    if (statusFilter && statusFilter.value) {
        sites = sites.filter(s => (s.status || 'not_contacted') === statusFilter.value);
    }

    // Filter by strong opportunities if checkbox is checked
    const filterEl = document.getElementById('filterStrongOpp');
    if (filterEl && filterEl.checked) {
        sites = sites.filter(s => {
            const ratio = s.oppRatio || (s.asIsValue > 0 ? s.devValue / s.asIsValue : 0);
            return ratio >= 1.5;
        });
    }
    countEl.textContent = sites.length + ' propert' + (sites.length === 1 ? 'y' : 'ies');

    // Sort
    const sorted = [...sites].sort((a, b) => {
        let va, vb;
        switch (sitesSortCol) {
            case 'score': va = a.attractiveness; vb = b.attractiveness; break;
            case 'address': va = (a.address||'').toLowerCase(); vb = (b.address||'').toLowerCase(); return sitesSortAsc ? va.localeCompare(vb) : vb.localeCompare(va);
            case 'status': va = (a.status||'not_contacted'); vb = (b.status||'not_contacted'); return sitesSortAsc ? va.localeCompare(vb) : vb.localeCompare(va);
            case 'bestUse': va = (a.bestUseName||'').toLowerCase(); vb = (b.bestUseName||'').toLowerCase(); return sitesSortAsc ? va.localeCompare(vb) : vb.localeCompare(va);
            case 'lotSize': va = a.lotSize||0; vb = b.lotSize||0; break;
            case 'asIsValue': va = a.asIsValue||0; vb = b.asIsValue||0; break;
            case 'devValue': va = a.devValue||0; vb = b.devValue||0; break;
            case 'ease': va = a.ease||0; vb = b.ease||0; break;
            case 'oppRatio': va = a.oppRatio||(a.asIsValue>0?a.devValue/a.asIsValue:0); vb = b.oppRatio||(b.asIsValue>0?b.devValue/b.asIsValue:0); break;
            case 'date': va = a.date||''; vb = b.date||''; return sitesSortAsc ? va.localeCompare(vb) : vb.localeCompare(va);
            default: va = a.attractiveness; vb = b.attractiveness;
        }
        return sitesSortAsc ? va - vb : vb - va;
    });

    // Table
    if (sorted.length === 0) {
        tbody.innerHTML = '<tr><td colspan="11" style="text-align:center;padding:2rem;color:#94a3b8;">No properties saved yet. Run an HBU analysis to add properties automatically.</td></tr>';
    } else {
        tbody.innerHTML = sorted.map((s, i) => {
            const color = getAttractivenessColor(s.attractiveness);
            const ratio = s.oppRatio || (s.asIsValue > 0 ? s.devValue / s.asIsValue : 0);
            const ratioColor = ratio >= 1.5 ? '#059669' : ratio >= 1.0 ? '#ca8a04' : '#dc2626';
            const st = s.status || 'not_contacted';
            const stInfo = PROSPECT_STATUSES[st] || PROSPECT_STATUSES.not_contacted;
            const statusOptions = Object.entries(PROSPECT_STATUSES).map(([k, v]) =>
                `<option value="${k}" ${k === st ? 'selected' : ''}>${v.label}</option>`
            ).join('');
            return `<tr>
                <td><span style="display:inline-block;width:36px;height:36px;border-radius:50%;background:${color};color:white;font-weight:800;text-align:center;line-height:36px;font-size:0.82rem;">${s.attractiveness}</span></td>
                <td style="font-weight:600;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${(s.address||'').replace(/"/g,'&quot;')}">${s.address||'â€”'}</td>
                <td><select class="prospect-status ${stInfo.cls}" onchange="updateProspectStatus('${s.id}',this.value)" style="border:none;cursor:pointer;font-size:0.72rem;padding:0.15rem 0.3rem;border-radius:4px;">${statusOptions}</select></td>
                <td>${s.bestUseIcon||''} ${s.bestUseName||'â€”'}</td>
                <td>${(s.lotSize||0).toLocaleString()} SF</td>
                <td>${fmt(s.asIsValue||0)}</td>
                <td>${fmt(s.devValue||0)}</td>
                <td style="font-weight:700;color:${ratioColor};">${ratio.toFixed(1)}x</td>
                <td>${s.ease||0}/100</td>
                <td style="font-size:0.78rem;">${s.date||'â€”'}</td>
                <td>
                    <button type="button" class="btn-lookup" style="font-size:0.72rem;padding:4px 10px;" onclick="openListingOnePagerFromData(getAgentSites()[${sites.indexOf(s)}])">One-Pager</button>
                    <button type="button" style="font-size:0.72rem;padding:4px 8px;background:#e53e3e;color:white;border:none;border-radius:6px;cursor:pointer;" onclick="removeAgentSite('${s.id}')">âœ•</button>
                </td>
            </tr>`;
        }).join('');
    }

    // Update sort header indicators
    document.querySelectorAll('#sitesTable th[data-col]').forEach(th => {
        th.textContent = th.textContent.replace(/ [â–²â–¼]$/, '');
        if (th.dataset.col === sitesSortCol) th.textContent += sitesSortAsc ? ' â–²' : ' â–¼';
    });

    // Map markers
    if (sitesMapInstance) {
        sitesMapMarkers.forEach(m => sitesMapInstance.removeLayer(m));
        sitesMapMarkers = [];
        const bounds = [];
        sorted.forEach(s => {
            if (!s.lat || !s.lon) return;
            const color = getAttractivenessColor(s.attractiveness);
            const marker = L.circleMarker([s.lat, s.lon], {
                radius: 10, fillColor: color, color: '#fff', weight: 2, fillOpacity: 0.9
            }).addTo(sitesMapInstance);
            const popupRatio = s.oppRatio || (s.asIsValue > 0 ? s.devValue / s.asIsValue : 0);
            const stLabel = (PROSPECT_STATUSES[s.status] || PROSPECT_STATUSES.not_contacted).label;
            marker.bindPopup(`<strong>${s.address}</strong><br>${s.bestUseIcon||''} ${s.bestUseName}<br>Score: ${s.attractiveness}/100<br>Opp. Ratio: <strong style="color:${popupRatio >= 1.5 ? '#059669' : popupRatio >= 1.0 ? '#ca8a04' : '#dc2626'}">${popupRatio.toFixed(1)}x</strong><br>Status: ${stLabel}`);
            sitesMapMarkers.push(marker);
            bounds.push([s.lat, s.lon]);
        });
        if (bounds.length > 0) sitesMapInstance.fitBounds(bounds, { padding: [30, 30], maxZoom: 14 });
    }
}

function sortAgentSites(col) {
    if (sitesSortCol === col) sitesSortAsc = !sitesSortAsc;
    else { sitesSortCol = col; sitesSortAsc = false; }
    renderAgentSites();
}

function removeAgentSite(id) {
    const sites = getAgentSites();
    const idx = sites.findIndex(s => s.id === id);
    if (idx >= 0) { sites.splice(idx, 1); setAgentSites(sites); renderAgentSites(); }
}

function clearAgentSites() {
    if (!confirm('Remove all saved properties from My Sites?')) return;
    setAgentSites([]);
    renderAgentSites();
}

// ============================================================
//  AGENT PROFILE (localStorage)
// ============================================================
function getAgentProfile() { try { return JSON.parse(localStorage.getItem('agent_profile')) || {}; } catch(e) { return {}; } }
function setAgentProfile(p) { localStorage.setItem('agent_profile', JSON.stringify(p)); }

function openAgentProfileModal() {
    const p = getAgentProfile();
    const overlay = document.createElement('div');
    overlay.className = 'profile-modal-overlay';
    overlay.id = 'profileModalOverlay';
    overlay.innerHTML = `<div class="profile-modal">
        <h3>&#9881; Agent Profile</h3>
        <p style="font-size:0.82rem;color:var(--text-light);margin-bottom:1rem;">This information is used in prospecting letters and exports.</p>
        <div class="field"><label>Full Name</label><input type="text" id="profName" value="${(p.name||'').replace(/"/g,'&quot;')}"></div>
        <div class="field"><label>Phone</label><input type="tel" id="profPhone" value="${(p.phone||'').replace(/"/g,'&quot;')}"></div>
        <div class="field"><label>Email</label><input type="email" id="profEmail" value="${(p.email||'').replace(/"/g,'&quot;')}"></div>
        <div class="field"><label>Brokerage</label><input type="text" id="profBrokerage" value="${(p.brokerage||'').replace(/"/g,'&quot;')}"></div>
        <div class="field"><label>License #</label><input type="text" id="profLicense" value="${(p.licenseNo||'').replace(/"/g,'&quot;')}"></div>
        <div class="profile-modal-actions">
            <button onclick="closeAgentProfileModal()" style="background:var(--border);color:var(--text);">Cancel</button>
            <button onclick="saveAgentProfile()" style="background:var(--primary);color:white;">Save Profile</button>
        </div>
    </div>`;
    document.body.appendChild(overlay);
}

function saveAgentProfile() {
    setAgentProfile({
        name: document.getElementById('profName').value.trim(),
        phone: document.getElementById('profPhone').value.trim(),
        email: document.getElementById('profEmail').value.trim(),
        brokerage: document.getElementById('profBrokerage').value.trim(),
        licenseNo: document.getElementById('profLicense').value.trim(),
    });
    closeAgentProfileModal();
}

function closeAgentProfileModal() {
    const el = document.getElementById('profileModalOverlay');
    if (el) el.remove();
}

// ============================================================
//  SCANNER MODE SELECTOR
// ============================================================
let currentScannerMode = 'station';
let scannerDrawnLayer = null;
let scannerAddressLatLon = null;
let drawingToolsInitialized = false;

function setScannerMode(mode) {
    currentScannerMode = mode;
    document.querySelectorAll('.scanner-mode-btn').forEach((btn, i) => {
        const modes = ['station','draw','zip','radius'];
        btn.classList.toggle('active', modes[i] === mode);
    });
    document.querySelectorAll('.scanner-panel').forEach(p => p.classList.remove('active'));
    const panel = document.getElementById('scannerPanel_' + mode);
    if (panel) panel.classList.add('active');
    if (mode === 'draw' && finderMapInstance && !drawingToolsInitialized) initDrawingTools();
}

// Populate ZIP dropdown
function populateZipDropdown() {
    const sel = document.getElementById('scannerZip');
    if (!sel || sel.children.length > 1) return;
    const sorted = Object.keys(LA_ZIP_CENTROIDS).sort();
    for (const zip of sorted) {
        const opt = document.createElement('option');
        opt.value = zip;
        opt.textContent = `${zip} â€” ${LA_ZIP_CENTROIDS[zip].name}`;
        sel.appendChild(opt);
    }
}

// ============================================================
//  DRAWING TOOLS (Leaflet-Geoman)
// ============================================================
function initDrawingTools() {
    if (!finderMapInstance || drawingToolsInitialized) return;
    if (!finderMapInstance.pm) return; // geoman not loaded
    finderMapInstance.pm.addControls({
        position: 'topleft',
        drawCircle: true,
        drawCircleMarker: false,
        drawMarker: false,
        drawPolyline: false,
        drawText: false,
        drawPolygon: true,
        drawRectangle: true,
        editMode: false,
        dragMode: false,
        cutPolygon: false,
        rotateMode: false,
        removalMode: true,
    });
    finderMapInstance.on('pm:create', (e) => {
        if (scannerDrawnLayer) finderMapInstance.removeLayer(scannerDrawnLayer);
        scannerDrawnLayer = e.layer;
    });
    finderMapInstance.on('pm:remove', () => { scannerDrawnLayer = null; });
    drawingToolsInitialized = true;
}

// ============================================================
//  AREA QUERY FUNCTIONS
// ============================================================
const PARCEL_API_URL = 'https://public.gis.lacounty.gov/public/rest/services/LACounty_Cache/LACounty_Parcel/MapServer/0/query';
const PARCEL_OUT_FIELDS = 'APN,SitusFullAddress,UseType,UseDescription,UseCode,Roll_LandValue,Roll_ImpValue,YearBuilt1,SQFTmain1,Units1,CENTER_LAT,CENTER_LON,Shape.STArea()';

async function queryParcelsByRadius(lat, lon, radiusMeters, onProgress) {
    const radiusFt = radiusMeters * 3.28084;
    const allFeatures = []; let offset = 0; const pageSize = 1000;
    while (true) {
        const params = new URLSearchParams({ geometry: `${lon},${lat}`, geometryType: 'esriGeometryPoint', inSR: '4326', spatialRel: 'esriSpatialRelIntersects', distance: radiusFt, units: 'esriSRUnit_Foot', outFields: PARCEL_OUT_FIELDS, returnGeometry: false, resultOffset: offset, resultRecordCount: pageSize, f: 'json' });
        const resp = await fetch(`${PARCEL_API_URL}?${params}`); if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json(); if (data.error) throw new Error(data.error.message || 'GIS API error');
        const features = data.features || []; allFeatures.push(...features);
        if (onProgress) onProgress(allFeatures.length);
        if (features.length < pageSize) break; offset += pageSize; if (offset > 5000) break;
    }
    return allFeatures;
}

async function queryParcelsByBbox(south, west, north, east, onProgress) {
    const allFeatures = []; let offset = 0; const pageSize = 1000;
    while (true) {
        const params = new URLSearchParams({ geometry: `${west},${south},${east},${north}`, geometryType: 'esriGeometryEnvelope', inSR: '4326', spatialRel: 'esriSpatialRelIntersects', outFields: PARCEL_OUT_FIELDS, returnGeometry: false, resultOffset: offset, resultRecordCount: pageSize, f: 'json' });
        const resp = await fetch(`${PARCEL_API_URL}?${params}`); if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json(); if (data.error) throw new Error(data.error.message || 'GIS API error');
        const features = data.features || []; allFeatures.push(...features);
        if (onProgress) onProgress(allFeatures.length);
        if (features.length < pageSize) break; offset += pageSize; if (offset > 5000) break;
    }
    return allFeatures;
}

async function queryParcelsByPolygon(latlngs, onProgress) {
    const rings = [latlngs.map(ll => [ll.lng, ll.lat])];
    // Close the ring
    if (rings[0].length > 0 && (rings[0][0][0] !== rings[0][rings[0].length-1][0] || rings[0][0][1] !== rings[0][rings[0].length-1][1])) {
        rings[0].push(rings[0][0]);
    }
    const geomJson = JSON.stringify({ rings, spatialReference: { wkid: 4326 } });
    const allFeatures = []; let offset = 0; const pageSize = 1000;
    while (true) {
        const params = new URLSearchParams({ geometry: geomJson, geometryType: 'esriGeometryPolygon', inSR: '4326', spatialRel: 'esriSpatialRelIntersects', outFields: PARCEL_OUT_FIELDS, returnGeometry: false, resultOffset: offset, resultRecordCount: pageSize, f: 'json' });
        const resp = await fetch(`${PARCEL_API_URL}?${params}`); if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json(); if (data.error) throw new Error(data.error.message || 'GIS API error');
        const features = data.features || []; allFeatures.push(...features);
        if (onProgress) onProgress(allFeatures.length);
        if (features.length < pageSize) break; offset += pageSize; if (offset > 5000) break;
    }
    return allFeatures;
}

// Geocode an address for scanner radius mode
async function geocodeScannerAddress() {
    const addr = document.getElementById('scannerAddress').value.trim();
    const status = document.getElementById('scannerAddressStatus');
    if (!addr) { status.textContent = 'Enter an address.'; return; }
    status.textContent = 'Geocoding...';
    try {
        const resp = await fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(addr)}`);
        const results = await resp.json();
        if (results.length === 0) { status.textContent = 'Address not found. Try including city/state.'; return; }
        const lat = parseFloat(results[0].lat), lon = parseFloat(results[0].lon);
        scannerAddressLatLon = { lat, lon };
        status.innerHTML = `Found: <strong>${results[0].display_name.substring(0, 60)}</strong> (${lat.toFixed(4)}, ${lon.toFixed(4)})`;
        if (finderMapInstance) {
            finderMapInstance.setView([lat, lon], 15);
            if (finderMapInstance._scannerPin) finderMapInstance.removeLayer(finderMapInstance._scannerPin);
            finderMapInstance._scannerPin = L.marker([lat, lon]).addTo(finderMapInstance).bindPopup(addr).openPopup();
        }
    } catch(e) { status.textContent = 'Geocoding failed: ' + e.message; }
}

// ============================================================
//  BATCH OPPORTUNITY SCORING â€” FAST PATH
// ============================================================
// Fast-path: only evaluate top 3-5 likely uses per parcel based on lot size + zoning
function getLikelyUses(lotSF, zoning, useType) {
    // For residential parcels near transit, focus on density plays
    if (zoning === 'TOD') return ['multifamily_mid','multifamily_high','mixeduse','senior','multifamily_low'];
    if (lotSF > 20000) return ['multifamily_mid','mixeduse','multifamily_low','hotel','senior'];
    if (lotSF > 7500) return ['multifamily_low','mixeduse','duplex','multifamily_mid','adu'];
    if (lotSF > 3000) return ['duplex','multifamily_low','adu','sfr','mixeduse'];
    return ['adu','sfr','duplex'];
}

// Process parcels in batches with UI yield
function yieldToUI() { return new Promise(r => setTimeout(r, 0)); }

async function batchScoreOpportunities(features, centerLat, centerLon, onProgress) {
    const scored = [];
    const useTypes = Array.from(document.querySelectorAll('.finderUseType2:checked')).map(c => c.value);
    const minLot = parseInt(document.getElementById('finderMinLot2').value) || 0;
    const maxLot = parseInt(document.getElementById('finderMaxLot2').value) || 999999;

    // Pre-compute neighborhood centroids array for faster lookup
    const nhoods = Object.entries(NEIGHBORHOOD_CENTROIDS);

    const BATCH_SIZE = 50; // Process 50 parcels then yield to UI
    let processed = 0;

    for (let i = 0; i < features.length; i++) {
        const a = features[i].attributes;
        const lat = parseFloat(a.CENTER_LAT); const lon = parseFloat(a.CENTER_LON);
        if (!lat || !lon) continue;
        const lotSizeSqFt = Math.round(a['Shape.STArea()'] || a['Shape__Area'] || 0);
        const landVal = parseFloat(a.Roll_LandValue) || 0;
        const impVal = parseFloat(a.Roll_ImpValue) || 0;
        const yearBuilt = parseInt(a.YearBuilt1) || 0;
        const useType = classifyParcelUseType(a.UseType, a.UseDescription, a.UseCode);
        const address = a.SitusFullAddress || 'No address';
        const apn = a.APN || '';

        // Apply basic filters
        if (useTypes.length > 0 && !useTypes.includes(useType)) continue;
        if (lotSizeSqFt < minLot || lotSizeSqFt > maxLot) continue;

        // Pre-filter: skip heavily improved small parcels
        const impRatio = landVal > 0 ? impVal / landVal : (impVal === 0 ? 0 : 999);
        if (useType !== 'Vacant' && impRatio > 2.5 && lotSizeSqFt < 5000) continue;

        // Find nearest neighborhood
        let neighborhood = 'dtla'; let minDist = Infinity;
        for (let n = 0; n < nhoods.length; n++) {
            const d = Math.abs(lat - nhoods[n][1].lat) + Math.abs(lon - nhoods[n][1].lon); // Manhattan distance (faster)
            if (d < minDist) { minDist = d; neighborhood = nhoods[n][0]; }
        }

        // Check SB 79 eligibility
        const nearbyTransit = getAllNearbyTransit(lat, lon, 0.75);
        let zone = 'outside', allowances = null, tier = 0, bestStation = null;
        if (nearbyTransit.length > 0) {
            const best = nearbyTransit[0];
            zone = best.zoneKey; allowances = best.allowances; tier = best.tier; bestStation = best.station;
        }

        let zoning = 'C2';
        if ((allowances && allowances.far >= 4.0) || zone === 'adjacent' || zone === 'inner') zoning = 'TOD';
        let transit = 'moderate';
        if (zone === 'adjacent') transit = 'adjacent';
        else if (zone === 'inner' || zone === 'outer') transit = 'near';

        const inp = {
            parcelSize: lotSizeSqFt || 10000,
            frontage: Math.round(Math.sqrt(lotSizeSqFt || 10000) * 0.8),
            zoning, neighborhood,
            siteCondition: useType === 'Vacant' ? 'vacant' : 'demolition',
            topography: 'flat', cornerLot: false, transit, arterial: 'major', utilities: 'full',
            constFlood: false, constHillside: false, constHistoric: false, constFault: false, constCoastal: false, constParking: false
        };

        // FAST PATH: only check 3-5 likely uses instead of all 16
        const likelyUses = getLikelyUses(lotSizeSqFt, zoning, useType);
        let bestUseId = likelyUses[0]; let bestScore = 0;
        for (const uid of likelyUses) {
            try {
                const leg = getApplicableLegislation(uid, inp);
                const eff = stackLegislationEffects(leg);
                const lgl = scoreLegal(uid, inp, eff);
                if (lgl <= 0) continue;
                const phy = scorePhysical(uid, inp);
                const fin = scoreFinancial(uid, inp, eff);
                const prd = scoreProductive(uid, inp, eff);
                const composite = (lgl*25 + phy*25 + fin*30 + prd*20) / 100;
                if (composite > bestScore) { bestScore = composite; bestUseId = uid; }
            } catch(e) {}
        }

        const legislation = getApplicableLegislation(bestUseId, inp);
        const effects = stackLegislationEffects(legislation);
        const budget = generateBudget(bestUseId, inp, effects);
        const ease = computeEaseOfExecution(bestUseId, inp, effects);

        // Residual land value
        const devCostsExLand = (budget.totalHard || 0) + (budget.totalSoft || 0);
        const residualLandValue = Math.max(0, (budget.stabilizedValue || 0) - devCostsExLand);

        // Market value estimate
        const assessedTotal = landVal + impVal;
        const prop13Mult = 1.9;
        let estimatedMarketValue = assessedTotal > 0 ? Math.round(assessedTotal * prop13Mult) : Math.round((LAND_VALUE_PSF[neighborhood] || 150) * lotSizeSqFt * 1.3);

        const oppRatio = estimatedMarketValue > 0 ? residualLandValue / estimatedMarketValue : 0;
        const premium = residualLandValue - estimatedMarketValue;

        const useDef = LAND_USES.find(u => u.id === bestUseId) || { name: bestUseId, icon: '' };
        const bp = BUILDING_PARAMS[bestUseId] || {};
        const far = FAR_TYPICAL[bestUseId] || 2.5;
        const effectiveFAR = effects.farBonus ? far * (1 + effects.farBonus) : far;
        const buildableSF = Math.round(inp.parcelSize * effectiveFAR);
        const avgUnit = bp.avgUnitSF || bp.unitSF || 850;
        const units = bp.unitSF ? Math.max(1, Math.floor(buildableSF * 0.85 / avgUnit)) : 0;
        const stories = bp.stories || Math.min(Math.ceil(effectiveFAR / 0.85), 8);
        const hbuScore = Math.round(bestScore);

        scored.push({
            address, apn, lotSizeSqFt, useType, yearBuilt, landVal, impVal, impRatio,
            lat, lon, zone, allowances, tier, nearbyTransit,
            bestStation, bestUse: useDef.name, bestUseId, oppRatio, estimatedMarketValue,
            residualLandValue, premium, hbuScore, ease, units, stories,
            sb79Eligible: zone !== 'outside',
            legislation, effects, inp, budget
        });

        // Yield to UI every BATCH_SIZE parcels
        processed++;
        if (processed % BATCH_SIZE === 0) {
            if (onProgress) onProgress(processed, features.length);
            await yieldToUI();
        }
    }

    scored.sort((a, b) => b.oppRatio - a.oppRatio);
    return scored;
}

// ============================================================
//  RUN AREA SCAN â€” UNIFIED DISPATCHER
// ============================================================
let scannerResults = [];     // filtered view
let allScannerResults = [];  // all scored results (unfiltered)
let scannerSortCol = 'oppRatio';
let scannerSortAsc = false;

// Smart filter state
const smartFilters = {
    tierHot: true,       // 2x+
    tierStrong: true,    // 1.5-2x
    tierModerate: true,  // 1.0-1.5x
    tierWeak: true,      // <1x
    minPremium: 0,       // minimum $ premium
    maxYearBuilt: 0,     // 0 = no filter
    sb79Only: false,
    residentialOnly: false,
    lotSizePreset: 'all' // 'all', 'small', 'medium', 'large'
};

function applySmartFilters() {
    scannerResults = allScannerResults.filter(r => {
        // Tier filters
        if (r.oppRatio >= 2.0 && !smartFilters.tierHot) return false;
        if (r.oppRatio >= 1.5 && r.oppRatio < 2.0 && !smartFilters.tierStrong) return false;
        if (r.oppRatio >= 1.0 && r.oppRatio < 1.5 && !smartFilters.tierModerate) return false;
        if (r.oppRatio < 1.0 && !smartFilters.tierWeak) return false;

        // Minimum premium
        if (smartFilters.minPremium > 0 && r.premium < smartFilters.minPremium) return false;

        // Year built
        if (smartFilters.maxYearBuilt > 0 && r.yearBuilt > 0 && r.yearBuilt > smartFilters.maxYearBuilt) return false;

        // SB 79 only
        if (smartFilters.sb79Only && !r.sb79Eligible) return false;

        // Residential only
        if (smartFilters.residentialOnly && r.useType !== 'Residential') return false;

        // Lot size preset
        if (smartFilters.lotSizePreset === 'small' && (r.lotSizeSqFt < 2500 || r.lotSizeSqFt > 7500)) return false;
        if (smartFilters.lotSizePreset === 'medium' && (r.lotSizeSqFt < 7500 || r.lotSizeSqFt > 15000)) return false;
        if (smartFilters.lotSizePreset === 'large' && r.lotSizeSqFt < 15000) return false;

        return true;
    });
    finderResults2 = scannerResults;
}

function onSmartFilterChange() {
    applySmartFilters();
    renderSmartFilterPanel();
    renderScannerResults();
    addScannerParcelsToMap();
}

function toggleTier(tier) {
    smartFilters[tier] = !smartFilters[tier];
    onSmartFilterChange();
}

function setLotPreset(preset) {
    smartFilters.lotSizePreset = smartFilters.lotSizePreset === preset ? 'all' : preset;
    onSmartFilterChange();
}

function renderSmartFilterPanel() {
    const panel = document.getElementById('smartFilterPanel');
    if (!panel || allScannerResults.length === 0) { if (panel) panel.style.display = 'none'; return; }

    // Count by tier
    const counts = { hot: 0, strong: 0, moderate: 0, weak: 0 };
    allScannerResults.forEach(r => {
        if (r.oppRatio >= 2.0) counts.hot++;
        else if (r.oppRatio >= 1.5) counts.strong++;
        else if (r.oppRatio >= 1.0) counts.moderate++;
        else counts.weak++;
    });

    panel.style.display = 'block';
    panel.innerHTML = `<div class="smart-filters">
        <h4>Smart Filters <span style="font-weight:400;color:var(--primary);">(${scannerResults.length} of ${allScannerResults.length} shown)</span></h4>

        <div class="filter-row">
            <span class="filter-label">Opportunity</span>
            <button class="tier-btn tier-hot ${smartFilters.tierHot?'active':''}" onclick="toggleTier('tierHot')">&#128293; Hot 2x+ <span class="tier-count">(${counts.hot})</span></button>
            <button class="tier-btn tier-strong ${smartFilters.tierStrong?'active':''}" onclick="toggleTier('tierStrong')">&#128170; Strong 1.5x+ <span class="tier-count">(${counts.strong})</span></button>
            <button class="tier-btn tier-moderate ${smartFilters.tierModerate?'active':''}" onclick="toggleTier('tierModerate')">&#9889; Moderate 1-1.5x <span class="tier-count">(${counts.moderate})</span></button>
            <button class="tier-btn tier-weak ${smartFilters.tierWeak?'active':''}" onclick="toggleTier('tierWeak')">&#10060; Weak &lt;1x <span class="tier-count">(${counts.weak})</span></button>
        </div>

        <div class="filter-row">
            <span class="filter-label">Min Premium</span>
            <span style="font-size:0.78rem;">$</span>
            <input type="number" class="filter-input-sm" id="filterMinPremium" value="${smartFilters.minPremium||''}" placeholder="e.g. 200000" min="0" step="50000" onchange="smartFilters.minPremium=parseInt(this.value)||0;onSmartFilterChange();">
            <button class="lot-size-btn ${smartFilters.minPremium>=100000?'':'active'}" onclick="document.getElementById('filterMinPremium').value='';smartFilters.minPremium=0;onSmartFilterChange();" style="font-size:0.72rem;">Any</button>
            <button class="lot-size-btn ${smartFilters.minPremium===100000?'active':''}" onclick="document.getElementById('filterMinPremium').value='100000';smartFilters.minPremium=100000;onSmartFilterChange();">$100K+</button>
            <button class="lot-size-btn ${smartFilters.minPremium===250000?'active':''}" onclick="document.getElementById('filterMinPremium').value='250000';smartFilters.minPremium=250000;onSmartFilterChange();">$250K+</button>
            <button class="lot-size-btn ${smartFilters.minPremium===500000?'active':''}" onclick="document.getElementById('filterMinPremium').value='500000';smartFilters.minPremium=500000;onSmartFilterChange();">$500K+</button>
        </div>

        <div class="filter-row">
            <span class="filter-label">Year Built</span>
            <button class="lot-size-btn ${smartFilters.maxYearBuilt===0?'active':''}" onclick="smartFilters.maxYearBuilt=0;onSmartFilterChange();">Any</button>
            <button class="lot-size-btn ${smartFilters.maxYearBuilt===1950?'active':''}" onclick="smartFilters.maxYearBuilt=1950;onSmartFilterChange();">Pre-1950</button>
            <button class="lot-size-btn ${smartFilters.maxYearBuilt===1960?'active':''}" onclick="smartFilters.maxYearBuilt=1960;onSmartFilterChange();">Pre-1960</button>
            <button class="lot-size-btn ${smartFilters.maxYearBuilt===1980?'active':''}" onclick="smartFilters.maxYearBuilt=1980;onSmartFilterChange();">Pre-1980</button>
            <button class="lot-size-btn ${smartFilters.maxYearBuilt===2000?'active':''}" onclick="smartFilters.maxYearBuilt=2000;onSmartFilterChange();">Pre-2000</button>
        </div>

        <div class="filter-row">
            <span class="filter-label">Lot Size</span>
            <button class="lot-size-btn ${smartFilters.lotSizePreset==='all'?'active':''}" onclick="setLotPreset('all')">All Sizes</button>
            <button class="lot-size-btn ${smartFilters.lotSizePreset==='small'?'active':''}" onclick="setLotPreset('small')">Small (2.5-7.5K sf)</button>
            <button class="lot-size-btn ${smartFilters.lotSizePreset==='medium'?'active':''}" onclick="setLotPreset('medium')">Medium (7.5-15K sf)</button>
            <button class="lot-size-btn ${smartFilters.lotSizePreset==='large'?'active':''}" onclick="setLotPreset('large')">Large (15K+ sf)</button>
        </div>

        <div class="filter-row">
            <span class="filter-label">Quick</span>
            <label class="filter-toggle"><input type="checkbox" ${smartFilters.sb79Only?'checked':''} onchange="smartFilters.sb79Only=this.checked;onSmartFilterChange();"> SB 79 Transit Zone Only</label>
            <label class="filter-toggle"><input type="checkbox" ${smartFilters.residentialOnly?'checked':''} onchange="smartFilters.residentialOnly=this.checked;onSmartFilterChange();"> Residential Only</label>
        </div>
    </div>`;
}

async function runAreaScan() {
    const btn = document.getElementById('finderSearchBtn2');
    const progressEl = document.getElementById('finderProgress2');
    const fillEl = document.getElementById('finderProgressFill2');
    const textEl = document.getElementById('finderProgressText2');
    const resultsArea = document.getElementById('finderResultsArea2');

    btn.disabled = true; progressEl.classList.add('active');
    fillEl.style.width = '0%'; resultsArea.innerHTML = '';

    try {
        let features = [];
        let centerLat = 34.05, centerLon = -118.25;

        if (currentScannerMode === 'station') {
            // Existing metro station search
            const sel = document.getElementById('finderStation2');
            const station = METRO_STATIONS[parseInt(sel.value)];
            if (!station) { alert('Select a metro station.'); return; }
            const radiusChecks = document.querySelectorAll('.finderRadius2:checked');
            const selectedRadii = Array.from(radiusChecks).map(c => parseInt(c.value));
            if (selectedRadii.length === 0) { alert('Select at least one search radius.'); return; }
            const radiusFt = Math.max(...selectedRadii);
            centerLat = station.lat; centerLon = station.lon;
            textEl.textContent = `Querying parcels near ${station.name}...`;
            drawFinderStationRadii(station);
            features = await queryParcelsNearStation(station.lat, station.lon, radiusFt, (loaded) => {
                fillEl.style.width = Math.min(50, Math.round(loaded / 20)) + '%';
                textEl.textContent = `Loading... ${loaded} parcels`;
            });

        } else if (currentScannerMode === 'draw') {
            if (!scannerDrawnLayer) { alert('Draw a shape on the map first (use the polygon, rectangle, or circle tool).'); return; }
            textEl.textContent = 'Querying parcels in drawn area...';
            if (scannerDrawnLayer instanceof L.Circle) {
                const c = scannerDrawnLayer.getLatLng();
                const r = scannerDrawnLayer.getRadius();
                centerLat = c.lat; centerLon = c.lng;
                features = await queryParcelsByRadius(c.lat, c.lng, r, (loaded) => {
                    fillEl.style.width = Math.min(50, Math.round(loaded / 20)) + '%';
                    textEl.textContent = `Loading... ${loaded} parcels`;
                });
            } else if (scannerDrawnLayer instanceof L.Rectangle) {
                const b = scannerDrawnLayer.getBounds();
                centerLat = b.getCenter().lat; centerLon = b.getCenter().lng;
                features = await queryParcelsByBbox(b.getSouth(), b.getWest(), b.getNorth(), b.getEast(), (loaded) => {
                    fillEl.style.width = Math.min(50, Math.round(loaded / 20)) + '%';
                    textEl.textContent = `Loading... ${loaded} parcels`;
                });
            } else {
                const latlngs = scannerDrawnLayer.getLatLngs()[0];
                const c = scannerDrawnLayer.getBounds().getCenter();
                centerLat = c.lat; centerLon = c.lng;
                features = await queryParcelsByPolygon(latlngs, (loaded) => {
                    fillEl.style.width = Math.min(50, Math.round(loaded / 20)) + '%';
                    textEl.textContent = `Loading... ${loaded} parcels`;
                });
            }

        } else if (currentScannerMode === 'zip') {
            const zip = document.getElementById('scannerZip').value;
            if (!zip || !LA_ZIP_CENTROIDS[zip]) { alert('Select a ZIP code.'); return; }
            const zd = LA_ZIP_CENTROIDS[zip];
            centerLat = zd.lat; centerLon = zd.lon;
            const radiusMi = parseFloat(document.querySelector('input[name="zipRadius"]:checked').value) || 0.75;
            const radiusMeters = radiusMi * 1609.34;
            textEl.textContent = `Querying parcels in ${zip} (${zd.name})...`;
            if (finderMapInstance) finderMapInstance.setView([zd.lat, zd.lon], 14);
            features = await queryParcelsByRadius(zd.lat, zd.lon, radiusMeters, (loaded) => {
                fillEl.style.width = Math.min(50, Math.round(loaded / 20)) + '%';
                textEl.textContent = `Loading... ${loaded} parcels`;
            });

        } else if (currentScannerMode === 'radius') {
            if (!scannerAddressLatLon) { alert('Enter and locate an address first.'); return; }
            centerLat = scannerAddressLatLon.lat; centerLon = scannerAddressLatLon.lon;
            const radiusMi = parseFloat(document.querySelector('input[name="addrRadius"]:checked').value) || 0.5;
            const radiusMeters = radiusMi * 1609.34;
            textEl.textContent = `Querying parcels within ${radiusMi} mi...`;
            features = await queryParcelsByRadius(centerLat, centerLon, radiusMeters, (loaded) => {
                fillEl.style.width = Math.min(50, Math.round(loaded / 20)) + '%';
                textEl.textContent = `Loading... ${loaded} parcels`;
            });
        }

        fillEl.style.width = '55%';
        textEl.textContent = `Scoring ${features.length} parcels...`;

        // Batch score with progress callback
        allScannerResults = await batchScoreOpportunities(features, centerLat, centerLon, (done, total) => {
            const pct = 55 + Math.round((done / Math.max(total, 1)) * 40);
            fillEl.style.width = pct + '%';
            textEl.textContent = `Scoring parcels... ${done}/${total}`;
        });

        // Apply smart filters for display
        applySmartFilters();
        finderResults2 = scannerResults;

        fillEl.style.width = '100%';
        textEl.textContent = `Found ${allScannerResults.length} opportunities (${scannerResults.length} shown)`;
        renderSmartFilterPanel();
        renderScannerResults();
        addScannerParcelsToMap();

    } catch(e) {
        resultsArea.innerHTML = `<div class="finder-error"><strong>Search failed:</strong> ${e.message}</div>`;
    }
    btn.disabled = false;
    setTimeout(() => progressEl.classList.remove('active'), 2000);
}

// ============================================================
//  ENHANCED RESULTS TABLE
// ============================================================
function renderScannerResults() {
    const area = document.getElementById('finderResultsArea2');
    if (scannerResults.length === 0) { area.innerHTML = '<div class="finder-no-results">No opportunities matched your filters.</div>'; return; }

    const fmt = (v) => v ? '$' + Math.round(v).toLocaleString() : '-';
    const oppClass = (r) => r >= 1.5 ? 'opp-strong' : r >= 1.0 ? 'opp-moderate' : 'opp-weak';

    let html = `<div id="finderSelectionBar" class="selection-bar" style="display:none;">
        <span id="finderSelCount">0</span>
        <button type="button" class="finder-btn-export" onclick="addSelectionToSaved()" style="margin:0 0.5rem;">Add to Saved</button>
        <button type="button" class="finder-btn-export" onclick="exportCallList()" style="margin:0 0.5rem;">Export Call List</button>
        <button type="button" class="finder-btn-export" onclick="printBatchLetters()" style="margin:0 0.5rem;">Generate Letters</button>
        <button type="button" class="finder-btn-export" onclick="clearFinderSelection()">Clear</button>
    </div>`;

    const strongCount = scannerResults.filter(r => r.oppRatio >= 1.5).length;
    html += `<div class="finder-summary">${scannerResults.length} opportunities found &mdash; <span style="color:#059669;font-weight:700;">${strongCount} strong (1.5x+)</span></div>`;

    html += `<div class="finder-table-wrapper"><table class="finder-table" id="finderTable2"><thead><tr>
        <th onclick="event.stopPropagation();toggleSelectAll()"><input type="checkbox" id="finderSelectAll" onclick="event.stopPropagation();toggleSelectAll()"></th>
        <th onclick="sortScannerTable('address')">Address</th>
        <th onclick="sortScannerTable('apn')">APN</th>
        <th onclick="sortScannerTable('lotSizeSqFt')">Lot Size</th>
        <th onclick="sortScannerTable('useType')">Use</th>
        <th onclick="sortScannerTable('oppRatio')">Opp. Ratio</th>
        <th onclick="sortScannerTable('estimatedMarketValue')">Market Value</th>
        <th onclick="sortScannerTable('residualLandValue')">Dev Land Bid</th>
        <th onclick="sortScannerTable('hbuScore')">HBU Score</th>
        <th onclick="sortScannerTable('bestUse')">Best Use</th>
        <th>Actions</th>
    </tr></thead><tbody>`;

    scannerResults.forEach((r, i) => {
        const checked = finderSelectedSet.has(i) ? 'checked' : '';
        const enc = encodeURIComponent(r.address);
        const apnClean = (r.apn || '').replace(/[^0-9]/g, '');
        const ratioStr = r.oppRatio >= 0.01 ? r.oppRatio.toFixed(1) + 'x' : '-';
        html += `<tr onclick="highlightScannerParcel(${i})" id="finderRow2_${i}">
            <td onclick="event.stopPropagation()"><input type="checkbox" class="finder-row-check" data-idx="${i}" ${checked} onchange="onFinderCheckChange()"></td>
            <td>${r.address}</td>
            <td><span style="font-size:0.78rem;">${r.apn}</span> <button class="btn-copy-apn" onclick="event.stopPropagation();copyAPN('${apnClean}')" title="Copy APN">&#128203;</button></td>
            <td>${r.lotSizeSqFt > 0 ? r.lotSizeSqFt.toLocaleString() + ' sf' : '-'}</td>
            <td>${r.useType}</td>
            <td><span class="opp-badge ${oppClass(r.oppRatio)}">${ratioStr}</span></td>
            <td>${fmt(r.estimatedMarketValue)}</td>
            <td>${fmt(r.residualLandValue)}</td>
            <td>${r.hbuScore}/100</td>
            <td style="font-size:0.78rem;">${r.bestUse}</td>
            <td onclick="event.stopPropagation()">
                <span class="prop-links">
                    <a href="https://portal.assessor.lacounty.gov/parceldetail/${apnClean}" target="_blank" title="Lookup Owner on LA County Assessor">Owner</a> |
                    <a href="https://www.zillow.com/homes/${enc}_rb/" target="_blank" title="View on Zillow">Z</a> |
                    <a href="javascript:void(0)" onclick="openOnePagerFromScan(${i})" title="Generate One-Pager">1-Pg</a> |
                    <a href="javascript:void(0)" onclick="openLetterModal(${i})" title="Generate Letter">Letter</a>
                </span>
            </td>
        </tr>`;
    });

    html += '</tbody></table></div>';
    html += `<div style="display:flex;gap:0.75rem;margin-top:1rem;flex-wrap:wrap;">
        <button type="button" class="finder-btn-export" onclick="exportCallList()">Export Call List (${scannerResults.length})</button>
        <button type="button" class="finder-btn-export" onclick="exportFinderCSV2()">Export Basic CSV</button>
    </div>`;
    area.innerHTML = html;
    updateSelectionBar();
}

function sortScannerTable(col) {
    if (scannerSortCol === col) scannerSortAsc = !scannerSortAsc;
    else { scannerSortCol = col; scannerSortAsc = col === 'address' || col === 'bestUse'; }
    scannerResults.sort((a, b) => {
        let va = a[col], vb = b[col];
        if (typeof va === 'string') { va = va.toLowerCase(); vb = (vb || '').toLowerCase(); return scannerSortAsc ? va.localeCompare(vb) : vb.localeCompare(va); }
        va = va || 0; vb = vb || 0; return scannerSortAsc ? va - vb : vb - va;
    });
    renderScannerResults();
}

function highlightScannerParcel(idx) {
    const r = scannerResults[idx]; if (!r || !finderMapInstance) return;
    document.querySelectorAll('#finderTable2 tr.highlighted').forEach(tr => tr.classList.remove('highlighted'));
    const row = document.getElementById('finderRow2_' + idx);
    if (row) row.classList.add('highlighted');
    finderMapInstance.setView([r.lat, r.lon], 17);
}

function addScannerParcelsToMap() {
    if (!finderMapInstance) return;
    if (finderParcelLayer2) finderMapInstance.removeLayer(finderParcelLayer2);
    finderParcelLayer2 = L.layerGroup().addTo(finderMapInstance);
    scannerResults.forEach((r, i) => {
        if (!r.lat || !r.lon) return;
        let color = '#94a3b8';
        if (r.oppRatio >= 1.5) color = '#059669';
        else if (r.oppRatio >= 1.0) color = '#ca8a04';
        else color = '#dc2626';
        const marker = L.circleMarker([r.lat, r.lon], { radius: 5, fillColor: color, color: '#fff', weight: 1, opacity: 0.9, fillOpacity: 0.8 });
        marker.bindPopup(`<strong>${r.address}</strong><br>Opp. Ratio: ${r.oppRatio.toFixed(1)}x<br>Dev Bid: $${Math.round(r.residualLandValue).toLocaleString()}<br>Best Use: ${r.bestUse}`);
        marker.on('click', () => { const row = document.getElementById('finderRow2_' + i); if (row) { row.classList.add('highlighted'); row.scrollIntoView({ behavior: 'smooth', block: 'center' }); } });
        marker.addTo(finderParcelLayer2);
    });
}

function copyAPN(apn) {
    navigator.clipboard.writeText(apn).then(() => {
        const btn = event.target;
        const orig = btn.textContent;
        btn.textContent = '\u2713';
        setTimeout(() => btn.textContent = orig, 1000);
    });
}

// Open one-pager from scanner results
function openOnePagerFromScan(idx) {
    const r = scannerResults[idx]; if (!r) return;
    const prevGeocode = window.lastGeocode;
    window.lastGeocode = { lat: r.lat, lon: r.lon, assessedTotal: r.landVal + r.impVal };

    const topResult = {
        id: r.bestUseId,
        name: r.bestUse,
        overall: r.hbuScore,
        devMarginPct: r.budget ? r.budget.devMargin : 0,
        legislation: r.legislation || []
    };
    const html = generateListingOnePager(topResult, r.inp, r.address);
    window.lastGeocode = prevGeocode;

    const modal = document.createElement('div');
    modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:9990;overflow-y:auto;padding:2rem;';
    modal.innerHTML = `<div style="max-width:800px;margin:0 auto;background:white;border-radius:16px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
        <div style="padding:0.75rem 1.5rem;background:#f1f5f9;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:0.85rem;">One-Pager: ${r.address}</span>
            <div>
                <button onclick="window.print()" style="padding:0.4rem 1rem;background:var(--primary);color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600;margin-right:0.5rem;">Print</button>
                <button onclick="this.closest('div').closest('div').closest('div').remove()" style="padding:0.4rem 1rem;background:#e2e8f0;border:none;border-radius:6px;cursor:pointer;font-weight:600;">Close</button>
            </div>
        </div>
        <div class="onepager-container">${html}</div>
    </div>`;
    modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
    document.body.appendChild(modal);
}

// ============================================================
//  EXPORT TO CALL LIST (CRM-ready CSV)
// ============================================================
function exportCallList() {
    const results = finderSelectedSet.size > 0
        ? Array.from(finderSelectedSet).map(i => scannerResults[i]).filter(Boolean)
        : scannerResults;
    if (results.length === 0) { alert('No results to export.'); return; }

    const headers = ['Address','APN','Lot Size (SF)','Use Type','Year Built','Est. Market Value','Developer Land Bid','Opp. Ratio','Premium ($)','Premium (%)','Best Use','HBU Score','Ease of Build','SB 79 Eligible','Zone','Owner Name','Mailing Address','Phone','Notes','Zillow URL','Assessor URL'];
    const rows = results.map(r => {
        const apnClean = (r.apn || '').replace(/[^0-9]/g, '');
        const enc = encodeURIComponent(r.address);
        const premium = r.residualLandValue - r.estimatedMarketValue;
        const premiumPct = r.estimatedMarketValue > 0 ? ((premium / r.estimatedMarketValue) * 100).toFixed(0) : '';
        return [
            `"${(r.address || '').replace(/"/g, '""')}"`,
            apnClean,
            r.lotSizeSqFt,
            r.useType,
            r.yearBuilt || '',
            Math.round(r.estimatedMarketValue),
            Math.round(r.residualLandValue),
            r.oppRatio.toFixed(2),
            Math.round(premium),
            premiumPct,
            `"${r.bestUse}"`,
            r.hbuScore,
            r.ease || '',
            r.sb79Eligible ? 'Yes' : 'No',
            r.zone || '',
            '', // Owner Name (blank)
            '', // Mailing Address (blank)
            '', // Phone (blank)
            '', // Notes
            `https://www.zillow.com/homes/${enc}_rb/`,
            `https://portal.assessor.lacounty.gov/parceldetail/${apnClean}`
        ].join(',');
    });
    const csv = [headers.join(','), ...rows].join('\n');
    const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `call-list-${new Date().toISOString().slice(0, 10)}.csv`;
    a.click();
    URL.revokeObjectURL(url);
}

// Export from My Portfolio tab
function exportPortfolioCallList() {
    const sites = getAgentSites();
    if (sites.length === 0) { alert('No properties in your portfolio.'); return; }
    const headers = ['Address','APN','Status','Lot Size (SF)','Best Use','Dev Value','As-Is Value','Opp. Ratio','HBU Score','Ease','Owner Name','Mailing Address','Phone','Notes','Zillow URL','Assessor URL'];
    const rows = sites.map(s => {
        const apnClean = (s.apn || '').replace(/[^0-9]/g, '');
        const enc = encodeURIComponent(s.address || '');
        const ratio = s.oppRatio || (s.asIsValue > 0 ? s.devValue / s.asIsValue : 0);
        const stLabel = (PROSPECT_STATUSES[s.status] || PROSPECT_STATUSES.not_contacted).label;
        return [
            `"${(s.address || '').replace(/"/g, '""')}"`,
            apnClean, `"${stLabel}"`, s.lotSizeSqFt || '', `"${s.bestUse || ''}"`,
            Math.round(s.devValue || 0), Math.round(s.asIsValue || 0),
            ratio.toFixed(2), s.score || '', s.ease || '',
            '', '', '', '',
            `https://www.zillow.com/homes/${enc}_rb/`,
            `https://portal.assessor.lacounty.gov/parceldetail/${apnClean}`
        ].join(',');
    });
    const csv = [headers.join(','), ...rows].join('\n');
    const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url;
    a.download = `portfolio-call-list-${new Date().toISOString().slice(0, 10)}.csv`;
    a.click(); URL.revokeObjectURL(url);
}

// ============================================================
//  DIRECT MAIL LETTER GENERATOR
// ============================================================
function generateProspectingLetter(r, agentProfile) {
    const p = agentProfile || getAgentProfile();
    const fmt = (v) => v ? '$' + Math.round(v).toLocaleString() : '$0';
    const premium = r.residualLandValue - r.estimatedMarketValue;

    let sb79Section = '';
    if (r.sb79Eligible && r.bestStation) {
        sb79Section = `<p>Your property is located within the <strong>SB 79 transit zone</strong> near ${r.bestStation.name} station, which allows significantly increased density and height under California's new transit-oriented development legislation (effective July 2026). This is a major value driver.</p>`;
    }

    return `<div class="letter-content">
        <p style="text-align:right;color:#64748b;font-size:0.85rem;">${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
        <p>Dear Homeowner,</p>
        <p>I'm reaching out because recent California legislation has dramatically changed what can be built on properties like yours at <strong>${r.address}</strong>.</p>
        <p>Based on my analysis, a developer could pay approximately <strong>${fmt(r.residualLandValue)}</strong> for your property &mdash; that's <strong>${r.oppRatio.toFixed(1)}x</strong> what it's currently valued at (${fmt(r.estimatedMarketValue)}). The highest and best use for your land is <strong>${r.bestUse}</strong>${r.units > 0 ? `, which could support <strong>${r.units} units</strong> across <strong>${r.stories} stories</strong>` : ''}.</p>
        ${sb79Section}
        <p>That represents a potential premium of <strong>${fmt(premium)}</strong> over the current market value of your property.</p>
        <p>I specialize in helping homeowners maximize their property's value by connecting them with qualified developers. There's no obligation &mdash; I'd love to show you what your options are.</p>
        <p style="margin-top:2rem;">Sincerely,</p>
        <p style="margin-bottom:0.25rem;"><strong>${p.name || '[Your Name]'}</strong></p>
        ${p.phone ? `<p style="margin:0;font-size:0.9rem;">${p.phone}</p>` : ''}
        ${p.email ? `<p style="margin:0;font-size:0.9rem;">${p.email}</p>` : ''}
        ${p.brokerage ? `<p style="margin:0;font-size:0.9rem;">${p.brokerage}</p>` : ''}
        ${p.licenseNo ? `<p style="margin:0;font-size:0.82rem;color:#64748b;">DRE# ${p.licenseNo}</p>` : ''}
    </div>`;
}

function openLetterModal(idx) {
    const r = scannerResults[idx]; if (!r) return;
    const agentProfile = getAgentProfile();
    if (!agentProfile.name) {
        if (confirm('Set up your agent profile first? Your name and contact info will appear on the letter.')) {
            openAgentProfileModal();
            return;
        }
    }
    const letterHtml = generateProspectingLetter(r, agentProfile);
    const overlay = document.createElement('div');
    overlay.className = 'letter-modal-overlay';
    overlay.id = 'letterModalOverlay';
    overlay.innerHTML = `<div class="letter-modal">
        ${letterHtml}
        <div class="letter-actions">
            <button onclick="document.getElementById('letterModalOverlay').remove()" style="background:#e2e8f0;color:var(--text);">Close</button>
            <button onclick="window.print()" style="background:var(--primary);color:white;">Print Letter</button>
        </div>
    </div>`;
    overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.remove(); });
    document.body.appendChild(overlay);
}

function printBatchLetters() {
    const selected = finderSelectedSet.size > 0
        ? Array.from(finderSelectedSet).map(i => scannerResults[i]).filter(Boolean)
        : scannerResults;
    if (selected.length === 0) { alert('No properties selected.'); return; }
    if (selected.length > 50) { if (!confirm(`Generate letters for ${selected.length} properties? This may take a moment.`)) return; }

    const agentProfile = getAgentProfile();
    if (!agentProfile.name) {
        if (confirm('Set up your agent profile first? Your name and contact info will appear on the letters.')) {
            openAgentProfileModal();
            return;
        }
    }

    let allLetters = '';
    selected.forEach((r, i) => {
        const pageBreak = i < selected.length - 1 ? 'page-break-after: always;' : '';
        allLetters += `<div style="${pageBreak} padding: 1rem 0;">${generateProspectingLetter(r, agentProfile)}<hr style="border:none;border-top:1px solid #e2e8f0;margin-top:1.5rem;"></div>`;
    });

    const overlay = document.createElement('div');
    overlay.className = 'letter-modal-overlay';
    overlay.id = 'letterModalOverlay';
    overlay.innerHTML = `<div class="letter-modal" style="max-width:750px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;padding-bottom:0.75rem;border-bottom:2px solid var(--border);">
            <span style="font-weight:700;font-size:1rem;">Batch Letters (${selected.length} properties)</span>
            <div>
                <button onclick="document.getElementById('letterModalOverlay').remove()" style="padding:0.4rem 1rem;background:#e2e8f0;border:none;border-radius:6px;cursor:pointer;font-weight:600;margin-right:0.5rem;">Close</button>
                <button onclick="window.print()" style="padding:0.4rem 1rem;background:var(--primary);color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600;">Print All</button>
            </div>
        </div>
        ${allLetters}
    </div>`;
    overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.remove(); });
    document.body.appendChild(overlay);
}

// ============================================================
//  INITIALIZATION â€” populate ZIP dropdown, init drawing tools
// ============================================================
document.addEventListener('DOMContentLoaded', () => {
    populateZipDropdown();
});

// Hook into existing finder map init to add drawing tools when in draw mode
const _origInitFinderMap = initFinderMap;
initFinderMap = function() {
    _origInitFinderMap();
    // Drawing tools will be initialized when user switches to draw mode
};

</script>
</body>
</html>
