<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Highest &amp; Best Use Calculator — Los Angeles, CA</title>
    <style>
        :root {
            --primary: #1a365d;
            --primary-light: #2b6cb0;
            --accent: #e8a838;
            --accent-dark: #c77e1a;
            --bg: #f7fafc;
            --card: #ffffff;
            --text: #2d3748;
            --text-light: #718096;
            --border: #e2e8f0;
            --success: #38a169;
            --gold: #d4a020;
            --silver: #8a8a8a;
            --bronze: #b87333;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        header {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        header h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        header p {
            font-size: 1rem;
            opacity: 0.85;
        }

        .badge {
            display: inline-block;
            background: var(--accent);
            color: var(--primary);
            font-weight: 700;
            padding: 0.2rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-top: 0.5rem;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
        }

        .intro-box {
            background: var(--card);
            border-left: 4px solid var(--accent);
            padding: 1.25rem 1.5rem;
            border-radius: 0 8px 8px 0;
            margin-bottom: 2rem;
            box-shadow: 0 2px 6px rgba(0,0,0,0.06);
        }

        .intro-box h3 { color: var(--primary); margin-bottom: 0.5rem; }
        .intro-box p { font-size: 0.92rem; color: var(--text-light); }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        @media (max-width: 768px) {
            .form-grid { grid-template-columns: 1fr; }
            header h1 { font-size: 1.5rem; }
        }

        .section {
            background: var(--card);
            border-radius: 12px;
            padding: 1.75rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .section h2 {
            font-size: 1.1rem;
            color: var(--primary);
            border-bottom: 2px solid var(--border);
            padding-bottom: 0.5rem;
            margin-bottom: 1.25rem;
        }

        .field { margin-bottom: 1.1rem; }
        .field:last-child { margin-bottom: 0; }

        label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 0.3rem;
        }

        label .hint {
            font-weight: 400;
            color: var(--text-light);
            font-size: 0.78rem;
        }

        select, input[type="number"], input[type="text"] {
            width: 100%;
            padding: 0.6rem 0.75rem;
            border: 1.5px solid var(--border);
            border-radius: 8px;
            font-size: 0.92rem;
            color: var(--text);
            background: #fff;
            transition: border-color 0.2s;
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(43,108,176,0.12);
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.88rem;
        }

        .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--primary-light);
        }

        /* Address Lookup */
        .address-section {
            background: var(--card);
            border-radius: 12px;
            padding: 1.75rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            margin-bottom: 2rem;
            border: 2px solid var(--primary-light);
        }

        .address-section h2 {
            font-size: 1.1rem;
            color: var(--primary);
            border-bottom: 2px solid var(--border);
            padding-bottom: 0.5rem;
            margin-bottom: 1.25rem;
        }

        .address-row {
            display: flex;
            gap: 0.75rem;
            align-items: flex-end;
        }

        .address-row .field { flex: 1; margin-bottom: 0; }

        .btn-lookup {
            padding: 0.6rem 1.5rem;
            font-size: 0.92rem;
            font-weight: 700;
            color: white;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border: none;
            border-radius: 8px;
            cursor: pointer;
            white-space: nowrap;
            transition: transform 0.15s, box-shadow 0.15s;
            box-shadow: 0 2px 8px rgba(26,54,93,0.25);
            height: 40px;
        }

        .btn-lookup:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(26,54,93,0.35);
        }

        .btn-lookup:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .lookup-status {
            margin-top: 0.75rem;
            font-size: 0.85rem;
            min-height: 1.4em;
        }

        .lookup-status .status-item {
            display: inline-block;
            margin-right: 1rem;
            margin-bottom: 0.25rem;
        }

        .lookup-status .ok { color: var(--success); }
        .lookup-status .warn { color: var(--accent-dark); }
        .lookup-status .err { color: #e53e3e; }
        .lookup-status .loading { color: var(--primary-light); }

        .autofill-notice {
            display: none;
            background: #ebf8ff;
            border: 1px solid #bee3f8;
            border-radius: 8px;
            padding: 0.7rem 1rem;
            font-size: 0.82rem;
            color: #2b6cb0;
            margin-top: 0.75rem;
        }

        .autofill-notice.visible { display: block; }

        .field.autofilled select,
        .field.autofilled input {
            border-color: #4299e1;
            background: #ebf8ff;
        }

        .field .autofill-badge {
            display: none;
            font-size: 0.7rem;
            color: #4299e1;
            font-weight: 400;
            margin-left: 0.4rem;
        }

        .field.autofilled .autofill-badge { display: inline; }

        @media (max-width: 768px) {
            .address-row { flex-direction: column; }
            .btn-lookup { width: 100%; }
        }

        .btn-calculate {
            display: block;
            width: 100%;
            max-width: 400px;
            margin: 2rem auto;
            padding: 1rem 2rem;
            font-size: 1.15rem;
            font-weight: 700;
            color: white;
            background: linear-gradient(135deg, var(--accent-dark), var(--accent));
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
            box-shadow: 0 4px 12px rgba(232,168,56,0.35);
        }

        .btn-calculate:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(232,168,56,0.45);
        }

        .btn-calculate:active { transform: translateY(0); }

        /* Results */
        #results {
            display: none;
            margin-top: 1rem;
        }

        #results.visible { display: block; }

        .results-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .results-header h2 {
            font-size: 1.5rem;
            color: var(--primary);
        }

        .results-header p {
            color: var(--text-light);
            font-size: 0.92rem;
        }

        .result-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 900px) {
            .result-cards { grid-template-columns: 1fr; }
        }

        .result-card {
            background: var(--card);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            transition: transform 0.2s;
        }

        .result-card:hover { transform: translateY(-4px); }

        .result-card .rank-banner {
            text-align: center;
            padding: 1rem;
            color: white;
            font-size: 0.9rem;
            font-weight: 700;
        }

        .rank-1 .rank-banner { background: linear-gradient(135deg, #b8860b, #daa520); }
        .rank-2 .rank-banner { background: linear-gradient(135deg, #6a6a6a, #a0a0a0); }
        .rank-3 .rank-banner { background: linear-gradient(135deg, #8b4513, #cd853f); }

        .rank-banner .rank-num {
            display: block;
            font-size: 2rem;
            line-height: 1;
        }

        .result-card .card-body {
            padding: 1.5rem;
        }

        .result-card .use-name {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.75rem;
        }

        .score-bar-container {
            margin-bottom: 0.75rem;
        }

        .score-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .score-bar {
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }

        .score-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.8s ease-out;
        }

        .score-bar-fill.legal { background: #4299e1; }
        .score-bar-fill.physical { background: #48bb78; }
        .score-bar-fill.financial { background: #ed8936; }
        .score-bar-fill.productive { background: #9f7aea; }

        .overall-score {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .overall-score .big-score {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary);
        }

        .overall-score span {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .rationale {
            margin-top: 1rem;
            font-size: 0.85rem;
            color: var(--text-light);
            line-height: 1.5;
        }

        /* Key Metrics section on result cards */
        .key-metrics {
            margin-top: 1rem;
            padding-top: 0.85rem;
            border-top: 1px dashed var(--border);
        }

        .key-metrics-title {
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-light);
            margin-bottom: 0.5rem;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.4rem;
        }

        .metric-item {
            background: #f7fafc;
            border-radius: 6px;
            padding: 0.4rem 0.55rem;
        }

        .metric-icon-label {
            font-size: 0.68rem;
            color: var(--text-light);
            margin-bottom: 0.15rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .metric-value {
            font-size: 0.88rem;
            font-weight: 700;
            color: var(--text);
        }

        .metric-value.positive { color: #276749; }
        .metric-value.caution  { color: #b7791f; }
        .metric-value.negative { color: #c53030; }

        .risk-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.78rem;
            font-weight: 700;
            padding: 0.15rem 0.5rem;
            border-radius: 999px;
        }

        .risk-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            display: inline-block;
        }

        .ease-bar-bg {
            width: 100%;
            height: 5px;
            background: #e2e8f0;
            border-radius: 3px;
            margin-top: 0.25rem;
            overflow: hidden;
        }

        .ease-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.4s ease;
        }

        /* Details table */
        .details-section {
            background: var(--card);
            border-radius: 12px;
            padding: 1.75rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            margin-bottom: 2rem;
        }

        .details-section h3 {
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .details-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.88rem;
        }

        .details-table th {
            background: var(--primary);
            color: white;
            padding: 0.65rem 0.75rem;
            text-align: left;
            font-weight: 600;
        }

        .details-table th:first-child { border-radius: 8px 0 0 0; }
        .details-table th:last-child { border-radius: 0 8px 0 0; }

        .details-table td {
            padding: 0.6rem 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .details-table tr:nth-child(even) { background: #f8fafc; }
        .details-table tr.top-3 { font-weight: 600; }
        .details-table tr.top-3 td:first-child { color: var(--primary); }

        .pass { color: var(--success); font-weight: 600; }
        .fail { color: #e53e3e; font-weight: 600; }
        .partial { color: var(--accent-dark); font-weight: 600; }

        .disclaimer {
            background: #fffbeb;
            border: 1px solid #f6e05e;
            border-radius: 8px;
            padding: 1rem 1.25rem;
            font-size: 0.82rem;
            color: #744210;
            margin-top: 1rem;
        }

        footer {
            text-align: center;
            padding: 2rem;
            color: var(--text-light);
            font-size: 0.82rem;
            border-top: 1px solid var(--border);
            margin-top: 2rem;
        }

        /* Print / Export Button */
        .btn-print {
            display: none;
            width: 100%;
            max-width: 400px;
            margin: 0 auto 2rem;
            padding: 0.85rem 2rem;
            font-size: 1rem;
            font-weight: 700;
            color: white;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
            box-shadow: 0 4px 12px rgba(26,54,93,0.3);
        }

        .btn-print.visible { display: block; }

        .btn-print:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(26,54,93,0.4);
        }

        .btn-print:active { transform: translateY(0); }

        .print-date {
            display: none;
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-light);
            margin-bottom: 1rem;
        }

        /* Print Styles */
        @media print {
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; color-adjust: exact !important; }

            body { background: white; font-size: 11pt; }

            header {
                background: var(--primary) !important;
                -webkit-print-color-adjust: exact;
                padding: 1.25rem;
                box-shadow: none;
            }

            header h1 { font-size: 1.5rem; }

            .container { padding: 1rem; }

            .intro-box, .btn-calculate, .btn-print, .address-section, footer { display: none !important; }

            .form-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 1rem;
                margin-bottom: 1rem;
            }

            .section {
                box-shadow: none;
                border: 1px solid #ddd;
                padding: 1rem;
                page-break-inside: avoid;
            }

            .section h2 { font-size: 0.95rem; margin-bottom: 0.75rem; }

            .field { margin-bottom: 0.5rem; }
            label { font-size: 0.78rem; }

            select, input[type="number"], input[type="text"] {
                border: none;
                padding: 0;
                font-size: 0.82rem;
                font-weight: 600;
                color: var(--primary);
                background: transparent;
                -webkit-appearance: none;
                appearance: none;
            }

            .checkbox-item { font-size: 0.78rem; }

            #results { display: block !important; page-break-before: auto; }

            .results-header { margin-bottom: 1rem; }
            .results-header h2 { font-size: 1.2rem; }

            .result-cards {
                grid-template-columns: repeat(3, 1fr);
                gap: 0.75rem;
                margin-bottom: 1rem;
            }

            .result-card {
                box-shadow: none;
                border: 1px solid #ddd;
                page-break-inside: avoid;
            }

            .result-card:hover { transform: none; }

            .rank-banner { padding: 0.6rem; font-size: 0.8rem; }
            .rank-banner .rank-num { font-size: 1.4rem; }
            .result-card .card-body { padding: 1rem; }
            .result-card .use-name { font-size: 1rem; margin-bottom: 0.5rem; }
            .score-bar-container { margin-bottom: 0.4rem; }
            .overall-score { margin-top: 0.5rem; padding-top: 0.5rem; }
            .overall-score .big-score { font-size: 1.5rem; }
            .rationale { font-size: 0.78rem; margin-top: 0.5rem; }

            .key-metrics { margin-top: 0.5rem; padding-top: 0.5rem; }
            .key-metrics-title { font-size: 0.6rem; margin-bottom: 0.3rem; }
            .metrics-grid { gap: 0.25rem; }
            .metric-item { padding: 0.25rem 0.4rem; }
            .metric-icon-label { font-size: 0.6rem; }
            .metric-value { font-size: 0.75rem; }

            .details-section {
                box-shadow: none;
                border: 1px solid #ddd;
                padding: 1rem;
                page-break-inside: avoid;
            }

            .details-table { font-size: 0.78rem; }
            .details-table th { padding: 0.4rem 0.5rem; }
            .details-table td { padding: 0.35rem 0.5rem; }

            .disclaimer {
                font-size: 0.72rem;
                padding: 0.75rem;
                page-break-inside: avoid;
            }

            .print-date { display: block !important; }

            .legislation-section {
                page-break-inside: avoid;
                box-shadow: none;
                border: 1px solid #ddd;
                padding: 1rem;
            }
            .legislation-section .legislation-card {
                page-break-inside: avoid;
                border-left-color: #4299e1 !important;
            }
        }

        /* Legislation Section */
        .legislation-section {
            background: var(--card);
            border-radius: 12px;
            padding: 1.75rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            margin-bottom: 2rem;
        }

        .legislation-section h3 {
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .legislation-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }

        .legislation-card {
            background: #f8fafc;
            border-left: 4px solid #4299e1;
            border-radius: 0 8px 8px 0;
            padding: 1rem 1.25rem;
        }

        .legislation-card strong {
            color: var(--primary);
            font-size: 0.92rem;
            display: block;
            margin-bottom: 0.35rem;
        }

        .legislation-card p {
            color: var(--text-light);
            font-size: 0.82rem;
            margin: 0;
            line-height: 1.45;
        }

        .legislation-badge {
            display: inline-block;
            background: #ebf8ff;
            color: #2b6cb0;
            font-size: 0.7rem;
            font-weight: 600;
            padding: 0.15rem 0.5rem;
            border-radius: 12px;
            margin-right: 0.3rem;
            margin-bottom: 0.25rem;
            border: 1px solid #bee3f8;
        }

        .legislation-badges {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border);
        }

        .legislation-badges .leg-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 0.35rem;
        }

        /* Analysis Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            overflow-y: auto;
            padding: 2rem 1rem;
        }

        .modal-content {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            position: relative;
        }

        .modal-top-bar {
            position: sticky;
            top: 0;
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: rgba(255,255,255,0.95);
            border-radius: 16px 16px 0 0;
            z-index: 10;
            backdrop-filter: blur(6px);
        }

        .modal-close {
            width: 36px; height: 36px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: #f7fafc;
            font-size: 1.3rem;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            color: var(--text-light);
            transition: background 0.15s;
        }
        .modal-close:hover { background: #edf2f7; }

        .modal-print-btn {
            padding: 0.45rem 1.25rem;
            font-size: 0.85rem;
            font-weight: 700;
            color: white;
            background: var(--primary-light);
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        .modal-print-btn:hover { background: var(--primary); }

        .modal-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            padding: 1.75rem 2rem;
        }
        .modal-header h2 { font-size: 1.4rem; margin-bottom: 0.25rem; }
        .modal-header p { font-size: 0.88rem; opacity: 0.85; }

        .modal-body { padding: 2rem; }

        .analysis-section { margin-bottom: 2rem; }
        .analysis-section h3 {
            color: var(--primary);
            border-bottom: 2px solid var(--border);
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
            font-size: 1rem;
        }

        .program-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
        }
        @media (max-width: 600px) { .program-grid { grid-template-columns: repeat(2, 1fr); } }
        .program-item {
            text-align: center;
            padding: 0.85rem;
            background: #f8fafc;
            border-radius: 8px;
        }
        .program-item .program-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary);
        }
        .program-item .program-label {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-top: 0.15rem;
        }

        .rendering-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }
        @media (max-width: 700px) { .rendering-container { grid-template-columns: 1fr; } }
        .rendering-container svg {
            width: 100%;
            height: auto;
            border: 1px solid var(--border);
            border-radius: 8px;
        }

        .budget-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.82rem;
        }
        .budget-table th {
            padding: 0.35rem 0.6rem;
            text-align: right;
            font-weight: 600;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            color: var(--text-light);
            border-bottom: 2px solid var(--border);
        }
        .budget-table th:first-child { text-align: left; }
        .budget-table td {
            padding: 0.35rem 0.6rem;
            border-bottom: 1px solid var(--border);
            font-variant-numeric: tabular-nums;
        }
        .budget-table td:not(:first-child) {
            text-align: right;
            white-space: nowrap;
        }
        .budget-table td.dim {
            color: var(--text-light);
            font-size: 0.78rem;
        }
        .budget-table .section-header td {
            font-weight: 700;
            background: #f8fafc;
            color: var(--primary);
            padding-top: 0.65rem;
            border-bottom: 2px solid var(--border);
        }
        .budget-table .subtotal td {
            font-weight: 700;
            background: #f0f4f8;
        }
        .budget-table .grand-total td {
            font-weight: 700;
            background: var(--primary);
            color: white;
            font-size: 0.88rem;
            padding: 0.55rem 0.6rem;
        }
        .budget-table .pct-col {
            font-size: 0.72rem;
            color: var(--text-light);
        }

        .returns-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
            margin-bottom: 1.25rem;
        }
        @media (max-width: 700px) { .returns-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 400px) { .returns-grid { grid-template-columns: 1fr; } }
        .return-card {
            text-align: center;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 8px;
        }
        .return-card .return-value {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
        }
        .return-card .return-label {
            font-size: 0.78rem;
            color: var(--text-light);
            margin-top: 0.15rem;
        }

        .timeline-bar {
            display: flex;
            border-radius: 8px;
            overflow: hidden;
            height: 36px;
            margin-bottom: 0.5rem;
        }
        .timeline-segment {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.68rem;
            font-weight: 600;
            color: white;
            line-height: 1.2;
            text-align: center;
            padding: 0 0.25rem;
        }
        .timeline-legend {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-top: 0.35rem;
        }

        .risk-card {
            background: #fff5f5;
            border-left: 4px solid #fc8181;
            border-radius: 0 8px 8px 0;
            padding: 0.85rem 1.1rem;
            margin-bottom: 0.6rem;
        }
        .risk-card strong { color: #c53030; font-size: 0.88rem; display: block; margin-bottom: 0.2rem; }
        .risk-card p { color: var(--text-light); font-size: 0.82rem; margin: 0; line-height: 1.45; }

        .click-hint {
            font-size: 0.75rem;
            color: var(--primary-light);
            text-align: center;
            margin-top: 0.5rem;
            font-weight: 600;
        }

        /* Print: analysis modal */
        @media print {
            body.printing-analysis > *:not(#analysisModal) { display: none !important; }
            body.printing-analysis #analysisModal {
                position: static;
                padding: 0;
                background: white;
                overflow: visible;
            }
            body.printing-analysis .modal-content {
                box-shadow: none;
                border-radius: 0;
            }
            body.printing-analysis .modal-top-bar { display: none !important; }
            body.printing-analysis .modal-header {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            body.printing-analysis .analysis-section { page-break-inside: avoid; }
            body.printing-analysis .rendering-container svg { border: 1px solid #ddd; }
            body.printing-analysis .budget-table .grand-total td {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            body.printing-analysis .assumptions-panel { border-color: #ddd; background: #fafafa; }
            body.printing-analysis .assumption-input { border: none; background: transparent; padding: 0; }
            body.printing-analysis .leg-detail-overlay { display: none !important; }
        }

        /* Editable Assumptions Panel */
        .assumptions-panel {
            background: #fffdf5;
            border: 1.5px solid var(--accent);
            border-radius: 10px;
            padding: 1rem 1.25rem;
            margin-bottom: 1.5rem;
        }
        .assumptions-panel h4 {
            font-size: 0.88rem;
            color: var(--accent-dark);
            margin-bottom: 0.75rem;
            font-weight: 700;
        }
        .assumptions-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
        }
        @media (max-width: 600px) { .assumptions-grid { grid-template-columns: repeat(2, 1fr); } }
        .assumption-field {
            display: flex;
            flex-direction: column;
        }
        .assumption-field label {
            font-size: 0.72rem;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 0.2rem;
        }
        .assumption-input {
            width: 100%;
            padding: 0.45rem 0.5rem;
            border: 1.5px solid var(--border);
            border-radius: 6px;
            font-size: 0.88rem;
            font-weight: 600;
            color: var(--primary);
            background: #fffdf5;
            transition: border-color 0.2s;
        }
        .assumption-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(232,168,56,0.15);
        }

        /* Clickable Legislation Cards & Badges */
        .legislation-card.clickable {
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
        }
        .legislation-card.clickable:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .legislation-badge.clickable {
            cursor: pointer;
            transition: background 0.15s;
        }
        .legislation-badge.clickable:hover {
            background: #bee3f8;
        }

        /* Legislation Detail Popup */
        .leg-detail-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.45);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        .leg-detail-content {
            background: white;
            border-radius: 14px;
            max-width: 520px;
            width: 100%;
            box-shadow: 0 16px 48px rgba(0,0,0,0.25);
            overflow: hidden;
        }
        .leg-detail-header {
            background: linear-gradient(135deg, #2b6cb0, #4299e1);
            color: white;
            padding: 1.25rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        .leg-detail-header h3 { font-size: 1.1rem; margin: 0; }
        .leg-detail-close {
            width: 28px; height: 28px;
            border-radius: 50%;
            border: none;
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 1.1rem;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }
        .leg-detail-close:hover { background: rgba(255,255,255,0.35); }
        .leg-detail-body {
            padding: 1.5rem;
        }
        .leg-detail-body .leg-summary {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-bottom: 0.75rem;
            font-style: italic;
        }
        .leg-detail-body .leg-full {
            font-size: 0.88rem;
            color: var(--text);
            line-height: 1.65;
        }
        /* SB 79 Transit Map */
        .map-section {
            background: var(--card);
            border-radius: 12px;
            padding: 1.75rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            margin-top: 2rem;
        }
        .map-section .section-header { text-align: center; margin-bottom: 1.25rem; }
        .map-section .section-header h2 { font-size: 1.3rem; color: var(--primary); margin-bottom: 0.25rem; }
        .map-section .section-subtitle { font-size: 0.88rem; color: var(--text-light); }
        #sb79Map { width: 100%; height: 500px; border-radius: 10px; border: 1.5px solid var(--border); z-index: 1; }
        .map-controls { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.75rem; justify-content: center; }
        .layer-btn {
            padding: 0.4rem 1rem; font-size: 0.82rem; font-weight: 600; border: 1.5px solid var(--border);
            border-radius: 20px; background: #fff; color: var(--text-light); cursor: pointer; transition: all 0.2s;
        }
        .layer-btn:hover { border-color: var(--primary-light); color: var(--primary); }
        .layer-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); }
        .map-legend {
            display: flex; flex-wrap: wrap; gap: 0.75rem 1.5rem; margin-top: 0.75rem;
            padding: 0.75rem 1rem; background: #f7fafc; border-radius: 8px; font-size: 0.78rem; color: var(--text-light);
        }
        .map-legend .legend-item { display: flex; align-items: center; gap: 0.35rem; }
        .legend-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
        .legend-line { width: 18px; height: 3px; border-radius: 2px; display: inline-block; }
        .sb79-eligibility {
            margin-top: 1rem; padding: 1.25rem; border-radius: 10px;
            background: linear-gradient(135deg, #ebf8ff, #f0fff4); border: 1.5px solid #bee3f8;
        }
        .sb79-eligibility h3 { font-size: 1rem; color: var(--primary); margin-bottom: 0.75rem; }
        .sb79-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.6rem; }
        .sb79-stat { background: #fff; border-radius: 8px; padding: 0.6rem 0.75rem; text-align: center; }
        .sb79-stat .stat-label { font-size: 0.7rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.05em; }
        .sb79-stat .stat-value { font-size: 1.1rem; font-weight: 700; color: var(--primary); }
        .tier-badge, .zone-badge {
            display: inline-block; font-size: 0.72rem; font-weight: 700; padding: 0.15rem 0.55rem;
            border-radius: 10px; margin-right: 0.3rem;
        }
        .tier-badge.tier1 { background: #e9d8fd; color: #553c9a; }
        .tier-badge.tier2 { background: #bee3f8; color: #2b6cb0; }
        .zone-badge.adjacent { background: #fed7d7; color: #c53030; }
        .zone-badge.inner { background: #fefcbf; color: #975a16; }
        .zone-badge.outer { background: #c6f6d5; color: #276749; }
        .station-popup .popup-title { font-weight: 700; font-size: 0.92rem; margin-bottom: 0.3rem; }
        .station-popup .popup-line { font-size: 0.8rem; color: #555; }
        .station-popup .popup-allowances { margin-top: 0.4rem; font-size: 0.78rem; }
        .station-popup .popup-allowances span { display: block; }
        @media print { .map-section { display: none !important; } }
        @media (max-width: 768px) { #sb79Map, #finderMap { height: 350px; } }

        /* Tab Bar */
        .tab-bar {
            display: flex;
            justify-content: center;
            gap: 0;
            background: #fff;
            border-bottom: 2px solid var(--border);
            box-shadow: 0 2px 6px rgba(0,0,0,0.06);
        }
        .tab-btn {
            flex: 1;
            max-width: 320px;
            padding: 1rem 2rem;
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-light);
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            transition: color 0.2s, border-color 0.2s, background 0.2s;
        }
        .tab-btn:hover {
            color: var(--primary);
            background: #f7fafc;
        }
        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--accent);
            background: #fff;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        @media print {
            .tab-bar { display: none !important; }
            #tabFinder { display: none !important; }
            #tabCalculator { display: block !important; }
        }

        /* Auth Overlay */
        #authOverlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, #1a365d 0%, #2b6cb0 50%, #1a365d 100%);
            z-index: 9999;
            display: flex; align-items: center; justify-content: center;
            transition: opacity 0.4s ease;
        }
        #authOverlay.fade-out { opacity: 0; pointer-events: none; }
        .auth-box {
            background: white; border-radius: 16px; padding: 2.5rem 2rem;
            text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 380px; width: 90%;
        }
        .auth-box h2 { color: var(--primary); font-size: 1.4rem; margin-bottom: 0.25rem; }
        .auth-box > p { color: var(--text-light); font-size: 0.92rem; margin-bottom: 1.5rem; }
        .auth-box input[type="password"] {
            width: 100%; padding: 0.7rem 1rem; border: 1.5px solid var(--border);
            border-radius: 8px; font-size: 1rem; text-align: center; margin-bottom: 1rem;
        }
        .auth-box input[type="password"]:focus {
            outline: none; border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(43,108,176,0.12);
        }
        .auth-btn {
            display: block; width: 100%; padding: 0.75rem; font-size: 1rem; font-weight: 700;
            color: white; background: linear-gradient(135deg, var(--accent-dark), var(--accent));
            border: none; border-radius: 10px; cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
            box-shadow: 0 4px 12px rgba(232,168,56,0.35);
        }
        .auth-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(232,168,56,0.45); }
        .auth-error { color: #e53e3e; font-size: 0.85rem; margin-top: 0.75rem; min-height: 1.2em; }
        @media print { #authOverlay { display: none !important; } }

        /* Opportunity Finder */
        .finder-section {
            margin-top: 1.5rem; padding: 1.25rem; border-radius: 10px;
            background: var(--card); border: 1.5px solid var(--border);
        }
        .finder-toggle {
            display: flex; align-items: center; justify-content: space-between;
            cursor: pointer; user-select: none;
        }
        .finder-toggle h3 { font-size: 1.05rem; color: var(--primary); margin: 0; }
        .finder-toggle .finder-arrow {
            font-size: 1.2rem; color: var(--text-light); transition: transform 0.2s;
        }
        .finder-toggle .finder-arrow.open { transform: rotate(90deg); }
        .finder-body { display: none; margin-top: 1rem; }
        .finder-body.open { display: block; }
        .finder-controls {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem; margin-bottom: 1rem;
        }
        .finder-field label { font-size: 0.78rem; font-weight: 600; color: var(--text-light); margin-bottom: 0.2rem; display: block; }
        .finder-field select, .finder-field input {
            width: 100%; padding: 0.5rem 0.6rem; border: 1.5px solid var(--border);
            border-radius: 6px; font-size: 0.88rem;
        }
        .finder-field select:focus, .finder-field input:focus {
            outline: none; border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(43,108,176,0.12);
        }
        .finder-radios { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .finder-radios label {
            font-size: 0.82rem; font-weight: 500; color: var(--text);
            display: flex; align-items: center; gap: 0.25rem; cursor: pointer;
        }
        .finder-checks { display: flex; gap: 0.75rem; flex-wrap: wrap; }
        .finder-checks label {
            font-size: 0.82rem; font-weight: 500; color: var(--text);
            display: flex; align-items: center; gap: 0.25rem; cursor: pointer;
        }
        .finder-range-wrap { display: flex; align-items: center; gap: 0.5rem; }
        .finder-range-wrap input[type="range"] { flex: 1; }
        .finder-range-wrap .range-val { font-size: 0.85rem; font-weight: 700; color: var(--primary); min-width: 2.5rem; text-align: right; }
        .finder-btn-search {
            padding: 0.65rem 2rem; font-size: 0.95rem; font-weight: 700;
            color: white; background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border: none; border-radius: 8px; cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
            box-shadow: 0 2px 8px rgba(26,54,93,0.25);
        }
        .finder-btn-search:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(26,54,93,0.35); }
        .finder-btn-search:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .finder-progress { display: none; margin: 1rem 0; }
        .finder-progress.active { display: block; }
        .finder-progress-bar { height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; }
        .finder-progress-fill { height: 100%; background: var(--primary-light); border-radius: 3px; transition: width 0.3s; width: 0; }
        .finder-progress-text { font-size: 0.78rem; color: var(--text-light); margin-top: 0.35rem; }
        .finder-table-wrapper { overflow-x: auto; margin-top: 1rem; }
        .finder-table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
        .finder-table th {
            background: var(--primary); color: white; padding: 0.5rem 0.6rem;
            text-align: left; font-weight: 600; cursor: pointer; white-space: nowrap; user-select: none;
        }
        .finder-table th:first-child { border-radius: 8px 0 0 0; }
        .finder-table th:last-child { border-radius: 0 8px 0 0; }
        .finder-table th:hover { background: var(--primary-light); }
        .finder-table th.sort-asc::after { content: ' \u25B2'; font-size: 0.7rem; }
        .finder-table th.sort-desc::after { content: ' \u25BC'; font-size: 0.7rem; }
        .finder-table td { padding: 0.45rem 0.6rem; border-bottom: 1px solid var(--border); }
        .finder-table tr:nth-child(even) { background: #f8fafc; }
        .finder-table tr:hover { background: #ebf8ff; cursor: pointer; }
        .finder-table tr.highlighted { background: #bee3f8 !important; }
        .imp-ratio-hot { color: #e53e3e; font-weight: 700; }
        .imp-ratio-warm { color: #dd6b20; font-weight: 600; }
        .imp-ratio-cool { color: #38a169; }
        .finder-btn-export {
            margin-top: 0.75rem; padding: 0.5rem 1.25rem; font-size: 0.85rem; font-weight: 600;
            color: var(--primary); background: #ebf8ff; border: 1.5px solid #bee3f8;
            border-radius: 8px; cursor: pointer; transition: background 0.15s;
        }
        .finder-btn-export:hover { background: #bee3f8; }
        .finder-no-results { text-align: center; padding: 2rem 1rem; color: var(--text-light); font-size: 0.92rem; }
        .finder-error { background: #fff5f5; border: 1px solid #fc8181; border-radius: 8px; padding: 1rem; color: #c53030; font-size: 0.88rem; margin-top: 1rem; }
        .finder-summary { font-size: 0.85rem; color: var(--text-light); margin-top: 0.5rem; }
        @media print { .finder-section { display: none !important; } }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>

<div id="authOverlay">
    <div class="auth-box">
        <h2>CLS CRE Brokerage</h2>
        <p>HBU Land Use Calculator</p>
        <input type="password" id="authPassword" placeholder="Password" onkeydown="if(event.key==='Enter')checkAuth();">
        <button type="button" class="auth-btn" onclick="checkAuth()">Enter</button>
        <div class="auth-error" id="authError"></div>
    </div>
</div>

<header>
    <h1>Highest &amp; Best Use Calculator</h1>
    <p>Land Use Analysis for Los Angeles, CA</p>
    <span class="badge">HBU Analysis Tool</span>
</header>

<div class="tab-bar">
    <button class="tab-btn active" onclick="switchTab('calculator')">HBU Calculator</button>
    <button class="tab-btn" onclick="switchTab('finder')">SB 79 Opportunity Finder</button>
</div>

<div id="tabCalculator" class="tab-content active">
<div class="container">
    <div class="intro-box">
        <h3>How It Works</h3>
        <p>Enter your parcel details below. The calculator evaluates potential land uses against the four standard HBU tests&mdash;<strong>Legally Permissible</strong>, <strong>Physically Possible</strong>, <strong>Financially Feasible</strong>, and <strong>Maximally Productive</strong>&mdash;then ranks the top 3 uses for your site.</p>
    </div>

    <div class="address-section">
        <h2>Address Lookup</h2>
        <div class="address-row">
            <div class="field">
                <label>Property Address <span class="hint">(Los Angeles, CA)</span></label>
                <input type="text" id="addressInput" placeholder="e.g. 6801 Hollywood Blvd, Los Angeles, CA 90028" onkeydown="if(event.key==='Enter'){event.preventDefault();lookupAddress();}">
            </div>
            <button type="button" class="btn-lookup" id="btnLookup" onclick="lookupAddress()">Look Up</button>
        </div>
        <div class="lookup-status" id="lookupStatus"></div>
        <div class="autofill-notice" id="autofillNotice">
            Fields highlighted in blue were auto-populated from public data. <strong>You can modify any value</strong> before running the calculation. Click a field to edit it.
        </div>
    </div>

    <form id="hbuForm" onsubmit="return false;">
        <div class="form-grid">
            <!-- LEFT COLUMN -->
            <div>
                <div class="section">
                    <h2>Parcel Information</h2>

                    <div class="field" id="field-parcelSize">
                        <label>Parcel Size (sq ft) <span class="autofill-badge">auto-filled</span></label>
                        <input type="number" id="parcelSize" value="10000" min="500" max="5000000" step="100">
                    </div>

                    <div class="field" id="field-frontage">
                        <label>Street Frontage (linear ft) <span class="autofill-badge">auto-filled</span></label>
                        <input type="number" id="frontage" value="80" min="10" max="2000" step="5">
                    </div>

                    <div class="field" id="field-zoning">
                        <label>Zoning Designation <span class="autofill-badge">auto-filled</span></label>
                        <select id="zoning">
                            <option value="R1" selected>R1 — Single-Family Residential</option>
                            <option value="R2">R2 — Two-Family Residential</option>
                            <option value="R3">R3 — Multi-Family (Low Density)</option>
                            <option value="R4">R4 — Multi-Family (Medium Density)</option>
                            <option value="R5">R5 — Multi-Family (High Density)</option>
                            <option value="C1">C1 — Limited Commercial</option>
                            <option value="C1.5">C1.5 — Limited Commercial (Mixed)</option>
                            <option value="C2">C2 — General Commercial</option>
                            <option value="C4">C4 — Commercial Zone</option>
                            <option value="C5">C5 — Commercial (Highway)</option>
                            <option value="CM">CM — Commercial Manufacturing</option>
                            <option value="M1">M1 — Limited Industrial</option>
                            <option value="M2">M2 — Light Industrial</option>
                            <option value="M3">M3 — Heavy Industrial</option>
                            <option value="PF">PF — Public Facilities</option>
                            <option value="OS">OS — Open Space</option>
                            <option value="LAX">LAX — Airport</option>
                            <option value="TOD">TOD — Transit-Oriented Development</option>
                        </select>
                    </div>

                    <div class="field" id="field-neighborhood">
                        <label>Neighborhood / Submarket <span class="autofill-badge">auto-filled</span></label>
                        <select id="neighborhood">
                            <option value="dtla">Downtown LA (DTLA)</option>
                            <option value="hollywood">Hollywood / East Hollywood</option>
                            <option value="koreatown">Koreatown</option>
                            <option value="westside" selected>Westside (West LA / Sawtelle)</option>
                            <option value="santamonica">Santa Monica Blvd Corridor</option>
                            <option value="beverly">Beverly Hills Adjacent</option>
                            <option value="midcity">Mid-City / Mid-Wilshire</option>
                            <option value="southla">South LA</option>
                            <option value="valleyeast">San Fernando Valley — East</option>
                            <option value="valleywest">San Fernando Valley — West</option>
                            <option value="silverlake">Silver Lake / Echo Park</option>
                            <option value="highland">Highland Park / Eagle Rock</option>
                            <option value="venice">Venice / Mar Vista</option>
                            <option value="culver">Culver City Adjacent</option>
                            <option value="exposition">Exposition Corridor</option>
                            <option value="southbay">South Bay (Torrance / Gardena)</option>
                            <option value="harbor">Harbor / San Pedro</option>
                            <option value="boyleheights">Boyle Heights / East LA</option>
                        </select>
                    </div>

                    <div class="field" id="field-siteCondition">
                        <label>Current Site Condition <span class="autofill-badge">auto-filled</span></label>
                        <select id="siteCondition">
                            <option value="vacant" selected>Vacant Land</option>
                            <option value="improved_under">Improved — Underutilized</option>
                            <option value="improved_functional">Improved — Functional</option>
                            <option value="demolition">Structure — Requires Demolition</option>
                            <option value="brownfield">Brownfield / Environmental Issues</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- RIGHT COLUMN -->
            <div>
                <div class="section">
                    <h2>Site Characteristics</h2>

                    <div class="field">
                        <label>Topography</label>
                        <select id="topography">
                            <option value="flat" selected>Flat / Level</option>
                            <option value="gentle">Gentle Slope (&lt;10%)</option>
                            <option value="moderate">Moderate Slope (10–25%)</option>
                            <option value="steep">Steep Slope (&gt;25%)</option>
                        </select>
                    </div>

                    <div class="field">
                        <label>Is this a corner lot?</label>
                        <select id="cornerLot">
                            <option value="yes">Yes</option>
                            <option value="no" selected>No</option>
                        </select>
                    </div>

                    <div class="field" id="field-transit">
                        <label>Proximity to Public Transit <span class="autofill-badge">auto-filled</span></label>
                        <select id="transit">
                            <option value="adjacent">Adjacent to Metro Rail Station (&lt;0.25 mi)</option>
                            <option value="near" selected>Near Transit (0.25–0.5 mi)</option>
                            <option value="moderate">Moderate (0.5–1 mi)</option>
                            <option value="far">Far (&gt;1 mi)</option>
                        </select>
                    </div>

                    <div class="field" id="field-arterial">
                        <label>Major Street / Arterial Frontage? <span class="autofill-badge">auto-filled</span></label>
                        <select id="arterial">
                            <option value="major">Yes — Major Arterial (e.g. Wilshire, Sunset)</option>
                            <option value="secondary" selected>Secondary Road</option>
                            <option value="residential">Residential / Side Street</option>
                        </select>
                    </div>

                    <div class="field">
                        <label>Site Constraints <span class="hint">(select all that apply)</span></label>
                        <div class="checkbox-group">
                            <label class="checkbox-item"><input type="checkbox" id="constFlood"> Flood Zone</label>
                            <label class="checkbox-item"><input type="checkbox" id="constHillside"> Hillside Ordinance</label>
                            <label class="checkbox-item"><input type="checkbox" id="constHistoric"> Historic Overlay</label>
                            <label class="checkbox-item"><input type="checkbox" id="constFault"> Fault Zone</label>
                            <label class="checkbox-item"><input type="checkbox" id="constCoastal"> Coastal Zone</label>
                            <label class="checkbox-item"><input type="checkbox" id="constParking"> Parking Constraints</label>
                        </div>
                    </div>

                    <div class="field">
                        <label>Utilities Available</label>
                        <select id="utilities">
                            <option value="full" selected>All Utilities Available</option>
                            <option value="partial">Partial — Needs Upgrades</option>
                            <option value="none">No Utilities — Requires Extension</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <button type="button" class="btn-calculate" onclick="calculateHBU()">Calculate Top 3 Highest &amp; Best Uses</button>
    </form>

    <button type="button" class="btn-print" id="btnPrint" onclick="exportPDF()">Print / Export to PDF</button>

    <!-- RESULTS -->
    <div id="results">
        <div class="print-date" id="printDate"></div>
        <div class="results-header">
            <h2>Top 3 Highest &amp; Best Use Results</h2>
            <p id="resultsSummary"></p>
        </div>

        <div class="result-cards" id="resultCards"></div>

        <div class="legislation-section" id="legislationSection" style="display:none;"></div>

        <div class="details-section">
            <h3>Scoring Breakdown — Legally Permissible Uses</h3>
            <div style="overflow-x: auto;">
                <table class="details-table" id="detailsTable">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Land Use</th>
                            <th>Legal</th>
                            <th>Physical</th>
                            <th>Financial</th>
                            <th>Productive</th>
                            <th>Overall</th>
                        </tr>
                    </thead>
                    <tbody id="detailsBody"></tbody>
                </table>
            </div>

            <div id="excludedSection" style="display:none; margin-top:1.25rem;">
                <button id="toggleExcluded" onclick="toggleExcludedUses()" style="background:none;border:1px solid var(--border);border-radius:8px;padding:0.5rem 1rem;font-size:0.82rem;color:var(--text-light);cursor:pointer;width:100%;text-align:left;">
                    ▶ Show <span id="excludedCount">0</span> uses not legally permissible under current zoning
                </button>
                <div id="excludedTable" style="display:none; margin-top:0.75rem; opacity:0.65;">
                    <div style="overflow-x: auto;">
                        <table class="details-table">
                            <thead>
                                <tr>
                                    <th>Land Use</th>
                                    <th>Physical</th>
                                    <th>Financial</th>
                                    <th>Productive</th>
                                    <th>Why Excluded</th>
                                </tr>
                            </thead>
                            <tbody id="excludedBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="disclaimer">
            <strong>Disclaimer:</strong> This tool provides a preliminary, educational estimate only. Highest and Best Use analysis for real estate investment or appraisal purposes should be performed by a qualified MAI appraiser or licensed professional. Actual HBU depends on detailed market studies, entitlement feasibility, construction cost analysis, and site-specific due diligence. Zoning codes, overlay districts, and specific plan areas in Los Angeles change frequently — always verify with the LA Department of City Planning (ZIMAS).
        </div>

        <!-- SB 79 Transit Opportunity Map -->
        <div class="map-section" id="mapSection" style="display:none;">
            <div class="section-header">
                <h2>SB 79 Transit Opportunity Map</h2>
                <p class="section-subtitle">Interactive map showing transit stations, SB 79 zones, and development opportunities</p>
            </div>
            <div class="map-controls" id="mapControls">
                <button type="button" class="layer-btn active" onclick="toggleMapLayer('tier1')">Tier 1 (Heavy Rail)</button>
                <button type="button" class="layer-btn active" onclick="toggleMapLayer('tier2')">Tier 2 (Metrolink)</button>
                <button type="button" class="layer-btn active" onclick="toggleMapLayer('zones')">SB 79 Zones</button>
                <button type="button" class="layer-btn active" onclick="toggleMapLayer('property')">Your Property</button>
            </div>
            <div id="sb79Map" style="height:500px;"></div>
            <div class="map-legend" id="mapLegend"></div>
            <div class="sb79-eligibility" id="sb79Eligibility" style="display:none;"></div>
        </div>
    </div>
</div>
</div><!-- /tabCalculator -->

<div id="tabFinder" class="tab-content">
<div class="container">
    <div class="intro-box" style="border-left-color:#805ad5;">
        <h3>SB 79 Opportunity Finder</h3>
        <p><strong>SB 79</strong> (effective July 1, 2026) overrides local zoning near qualifying transit stations, allowing up to <strong>95ft height, 160 du/acre, and 4.5 FAR</strong> for Tier 1 heavy rail and <strong>85ft, 140 du/acre, 4.0 FAR</strong> for Tier 2 light rail/Metrolink. Select a transit station below (or click one on the map) and set filters to find underbuilt parcels that SB 79 unlocks for higher-density development.</p>
    </div>

    <div id="finderMapContainer" style="background:var(--card);border-radius:12px;padding:1.75rem;box-shadow:0 2px 8px rgba(0,0,0,0.06);margin-bottom:2rem;">
        <div style="text-align:center;margin-bottom:1rem;">
            <h2 style="font-size:1.3rem;color:var(--primary);margin-bottom:0.25rem;">LA Metro Transit Stations</h2>
            <p style="font-size:0.88rem;color:var(--text-light);">Click any station to select it, then configure filters and search for opportunities</p>
        </div>
        <div id="finderMap" style="width:100%;height:500px;border-radius:10px;border:1.5px solid var(--border);z-index:1;"></div>
        <div class="map-legend" id="finderMapLegend"></div>
    </div>

    <div style="background:var(--card);border-radius:12px;padding:1.75rem;box-shadow:0 2px 8px rgba(0,0,0,0.06);margin-bottom:2rem;">
        <h2 style="font-size:1.1rem;color:var(--primary);border-bottom:2px solid var(--border);padding-bottom:0.5rem;margin-bottom:1.25rem;">Search Filters</h2>
        <div class="finder-controls">
            <div class="finder-field" style="grid-column: span 2;">
                <label>Transit Station</label>
                <select id="finderStation2"></select>
            </div>
            <div class="finder-field">
                <label>Search Radius</label>
                <div class="finder-radios">
                    <label><input type="radio" name="finderRadius2" value="200"> Adjacent (200ft)</label>
                    <label><input type="radio" name="finderRadius2" value="1320"> Inner (1/4 mi)</label>
                    <label><input type="radio" name="finderRadius2" value="2640" checked> Outer (1/2 mi)</label>
                </div>
            </div>
            <div class="finder-field">
                <label>Use Type</label>
                <div class="finder-checks">
                    <label><input type="checkbox" class="finderUseType2" value="Residential" checked> Residential</label>
                    <label><input type="checkbox" class="finderUseType2" value="Commercial" checked> Commercial</label>
                    <label><input type="checkbox" class="finderUseType2" value="Industrial"> Industrial</label>
                    <label><input type="checkbox" class="finderUseType2" value="Vacant" checked> Vacant</label>
                </div>
            </div>
            <div class="finder-field">
                <label>Min Lot Size (sq ft)</label>
                <input type="number" id="finderMinLot2" value="2500" min="0" step="500">
            </div>
            <div class="finder-field">
                <label>Max Lot Size (sq ft)</label>
                <input type="number" id="finderMaxLot2" value="100000" min="0" step="500">
            </div>
            <div class="finder-field">
                <label>Max Improvement Ratio (lower = more underbuilt)</label>
                <div class="finder-range-wrap">
                    <input type="range" id="finderMaxRatio2" min="0" max="5" step="0.1" value="2.0" oninput="document.getElementById('finderRatioVal2').textContent=this.value">
                    <span class="range-val" id="finderRatioVal2">2.0</span>
                </div>
            </div>
            <div class="finder-field">
                <label>Year Built Before</label>
                <input type="number" id="finderYearBefore2" value="2000" min="1900" max="2026">
            </div>
        </div>
        <button type="button" class="finder-btn-search" id="finderSearchBtn2" onclick="runStandaloneSearch()">Find Opportunities</button>
        <div class="finder-progress" id="finderProgress2">
            <div class="finder-progress-bar"><div class="finder-progress-fill" id="finderProgressFill2"></div></div>
            <div class="finder-progress-text" id="finderProgressText2">Querying parcels...</div>
        </div>
        <div id="finderResultsArea2"></div>
    </div>
</div>
</div><!-- /tabFinder -->

<!-- Analysis Detail Modal -->
<div class="modal-overlay" id="analysisModal" style="display:none;" onclick="if(event.target===this)closeAnalysis();">
    <div class="modal-content">
        <div class="modal-top-bar">
            <button type="button" class="modal-print-btn" onclick="printAnalysis()">Print / PDF</button>
            <button type="button" class="modal-close" onclick="closeAnalysis()">&times;</button>
        </div>
        <div class="modal-header">
            <h2 id="modalTitle"></h2>
            <p id="modalSubtitle"></p>
        </div>
        <div class="modal-body" id="modalBody"></div>
    </div>
</div>

<!-- Legislation Detail Popup -->
<div class="leg-detail-overlay" id="legDetailModal" style="display:none;" onclick="if(event.target===this)closeLegislationDetail();"></div>

<footer>
    CLS CRE Brokerage &mdash; HBU Land Use Calculator &mdash; Los Angeles, CA<br>
    For educational and preliminary analysis purposes only.
</footer>

<script>
// ============================================================
//  AUTH GATE
// ============================================================
const AUTH_HASH = '74a763fdc61ca8d18e1810035075eb910db56488993cbcdffe6715d466690658';
async function sha256(str) {
    const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
    return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('');
}
async function checkAuth() {
    const pw = document.getElementById('authPassword').value;
    const hash = await sha256(pw);
    if (hash === AUTH_HASH) {
        sessionStorage.setItem('hbu_auth', '1');
        const overlay = document.getElementById('authOverlay');
        overlay.classList.add('fade-out');
        setTimeout(() => overlay.remove(), 500);
    } else {
        document.getElementById('authError').textContent = 'Incorrect password. Please try again.';
        document.getElementById('authPassword').value = '';
        document.getElementById('authPassword').focus();
    }
}
(function() {
    if (sessionStorage.getItem('hbu_auth') === '1') {
        const overlay = document.getElementById('authOverlay');
        if (overlay) overlay.remove();
    }
})();

// ============================================================
//  ADDRESS LOOKUP ENGINE
// ============================================================

// Neighborhood centroids (lat, lon)
const NEIGHBORHOOD_CENTROIDS = {
    dtla:         { lat: 34.0407, lon: -118.2468 },
    hollywood:    { lat: 34.0928, lon: -118.3287 },
    koreatown:    { lat: 34.0578, lon: -118.3010 },
    westside:     { lat: 34.0367, lon: -118.4376 },
    santamonica:  { lat: 34.0906, lon: -118.3856 },
    beverly:      { lat: 34.0736, lon: -118.4004 },
    midcity:      { lat: 34.0483, lon: -118.3396 },
    southla:      { lat: 33.9425, lon: -118.2820 },
    valleyeast:   { lat: 34.2219, lon: -118.4157 },
    valleywest:   { lat: 34.1866, lon: -118.5353 },
    silverlake:   { lat: 34.0869, lon: -118.2697 },
    highland:     { lat: 34.1133, lon: -118.1902 },
    venice:       { lat: 33.9850, lon: -118.4695 },
    culver:       { lat: 34.0211, lon: -118.3965 },
    exposition:   { lat: 34.0183, lon: -118.2932 },
    southbay:     { lat: 33.8358, lon: -118.3406 },
    harbor:       { lat: 33.7361, lon: -118.2922 },
    boyleheights: { lat: 34.0345, lon: -118.2120 },
};

// Map Nominatim suburb/neighbourhood names → our dropdown IDs
const SUBURB_TO_NEIGHBORHOOD = {
    'downtown': 'dtla',
    'downtown los angeles': 'dtla',
    'little tokyo': 'dtla',
    'arts district': 'dtla',
    'chinatown': 'dtla',
    'civic center': 'dtla',
    'bunker hill': 'dtla',
    'financial district': 'dtla',
    'skid row': 'dtla',
    'hollywood': 'hollywood',
    'east hollywood': 'hollywood',
    'thai town': 'hollywood',
    'hollywood hills': 'hollywood',
    'los feliz': 'silverlake',
    'koreatown': 'koreatown',
    'pico-union': 'koreatown',
    'westlake': 'koreatown',
    'west los angeles': 'westside',
    'west la': 'westside',
    'sawtelle': 'westside',
    'westwood': 'westside',
    'brentwood': 'westside',
    'bel air': 'westside',
    'santa monica': 'santamonica',
    'west hollywood': 'santamonica',
    'weho': 'santamonica',
    'beverly hills': 'beverly',
    'beverly grove': 'beverly',
    'beverlywood': 'beverly',
    'century city': 'beverly',
    'mid-wilshire': 'midcity',
    'mid wilshire': 'midcity',
    'mid-city': 'midcity',
    'mid city': 'midcity',
    'miracle mile': 'midcity',
    'hancock park': 'midcity',
    'larchmont': 'midcity',
    'windsor square': 'midcity',
    'park la brea': 'midcity',
    'fairfax': 'midcity',
    'south los angeles': 'southla',
    'south la': 'southla',
    'watts': 'southla',
    'florence': 'southla',
    'vermont square': 'southla',
    'vermont-slauson': 'southla',
    'green meadows': 'southla',
    'north hollywood': 'valleyeast',
    'noho': 'valleyeast',
    'studio city': 'valleyeast',
    'valley village': 'valleyeast',
    'sun valley': 'valleyeast',
    'panorama city': 'valleyeast',
    'arleta': 'valleyeast',
    'pacoima': 'valleyeast',
    'sylmar': 'valleyeast',
    'sherman oaks': 'valleywest',
    'encino': 'valleywest',
    'tarzana': 'valleywest',
    'woodland hills': 'valleywest',
    'reseda': 'valleywest',
    'canoga park': 'valleywest',
    'winnetka': 'valleywest',
    'chatsworth': 'valleywest',
    'northridge': 'valleywest',
    'granada hills': 'valleywest',
    'west hills': 'valleywest',
    'silver lake': 'silverlake',
    'silverlake': 'silverlake',
    'echo park': 'silverlake',
    'elysian valley': 'silverlake',
    'atwater village': 'silverlake',
    'highland park': 'highland',
    'eagle rock': 'highland',
    'glassell park': 'highland',
    'mount washington': 'highland',
    'cypress park': 'highland',
    'el sereno': 'highland',
    'venice': 'venice',
    'mar vista': 'venice',
    'del rey': 'venice',
    'playa vista': 'venice',
    'playa del rey': 'venice',
    'marina del rey': 'venice',
    'culver city': 'culver',
    'palms': 'culver',
    'rancho park': 'culver',
    'cheviot hills': 'culver',
    'castle heights': 'culver',
    'exposition park': 'exposition',
    'university park': 'exposition',
    'leimert park': 'exposition',
    'jefferson park': 'exposition',
    'west adams': 'exposition',
    'baldwin hills': 'exposition',
    'crenshaw': 'exposition',
    'torrance': 'southbay',
    'gardena': 'southbay',
    'carson': 'southbay',
    'hawthorne': 'southbay',
    'inglewood': 'southbay',
    'lawndale': 'southbay',
    'el segundo': 'southbay',
    'manhattan beach': 'southbay',
    'hermosa beach': 'southbay',
    'redondo beach': 'southbay',
    'san pedro': 'harbor',
    'wilmington': 'harbor',
    'harbor city': 'harbor',
    'harbor gateway': 'harbor',
    'boyle heights': 'boyleheights',
    'east los angeles': 'boyleheights',
    'east la': 'boyleheights',
    'lincoln heights': 'boyleheights',
};

// LA Metro Rail & Metrolink stations { lat, lon, name, line, tier }
// tier 1 = heavy rail (Metro Rail), tier 2 = light rail/BRT/Metrolink
const METRO_STATIONS = [
    // --- Red Line (B Line): Union Station → North Hollywood ---
    { lat: 34.0561, lon: -118.2365, name: 'Union Station', line: 'red', tier: 1 },
    { lat: 34.0562, lon: -118.2500, name: 'Civic Center/Grand Park', line: 'red', tier: 1 },
    { lat: 34.0469, lon: -118.2600, name: 'Pershing Square', line: 'red', tier: 1 },
    { lat: 34.0488, lon: -118.2588, name: '7th St/Metro Center', line: 'red', tier: 1 },
    { lat: 34.0678, lon: -118.2915, name: 'Wilshire/Vermont', line: 'red', tier: 1 },
    { lat: 34.1017, lon: -118.3070, name: 'Hollywood/Western', line: 'red', tier: 1 },
    { lat: 34.1017, lon: -118.3250, name: 'Hollywood/Vine', line: 'red', tier: 1 },
    { lat: 34.1014, lon: -118.3388, name: 'Hollywood/Highland', line: 'red', tier: 1 },
    { lat: 34.1381, lon: -118.3623, name: 'Universal City/Studio City', line: 'red', tier: 1 },
    { lat: 34.1687, lon: -118.3765, name: 'North Hollywood', line: 'red', tier: 1 },
    // --- Purple Line (D Line): Wilshire corridor ---
    { lat: 34.0624, lon: -118.3080, name: 'Wilshire/Normandie', line: 'purple', tier: 1 },
    { lat: 34.0573, lon: -118.3273, name: 'Wilshire/Western', line: 'purple', tier: 1 },
    { lat: 34.0620, lon: -118.3440, name: 'Wilshire/La Brea', line: 'purple', tier: 1 },
    { lat: 34.0622, lon: -118.3615, name: 'Wilshire/Fairfax', line: 'purple', tier: 1 },
    { lat: 34.0626, lon: -118.3766, name: 'Wilshire/La Cienega', line: 'purple', tier: 1 },
    { lat: 34.0630, lon: -118.3945, name: 'Wilshire/Rodeo', line: 'purple', tier: 1 },
    { lat: 34.0632, lon: -118.4170, name: 'Century City/Constellation', line: 'purple', tier: 1 },
    { lat: 34.0638, lon: -118.4385, name: 'Westwood/UCLA', line: 'purple', tier: 1 },
    { lat: 34.0640, lon: -118.4510, name: 'Westwood/VA Hospital', line: 'purple', tier: 1 },
    // --- Blue/A Line: 7th/Metro → Long Beach ---
    { lat: 34.0398, lon: -118.2610, name: 'Pico', line: 'blue_a', tier: 1 },
    { lat: 34.0295, lon: -118.2435, name: 'LATTC/Ortho Institute', line: 'blue_a', tier: 1 },
    { lat: 34.0222, lon: -118.2344, name: 'San Pedro St', line: 'blue_a', tier: 1 },
    { lat: 34.0030, lon: -118.2297, name: 'Washington', line: 'blue_a', tier: 1 },
    { lat: 33.9938, lon: -118.2296, name: 'Vernon', line: 'blue_a', tier: 1 },
    { lat: 33.9830, lon: -118.2295, name: 'Slauson', line: 'blue_a', tier: 1 },
    { lat: 33.9722, lon: -118.2293, name: 'Florence', line: 'blue_a', tier: 1 },
    { lat: 33.9612, lon: -118.2340, name: 'Firestone', line: 'blue_a', tier: 1 },
    { lat: 33.9450, lon: -118.2362, name: '103rd St/Watts Towers', line: 'blue_a', tier: 1 },
    { lat: 33.9268, lon: -118.2377, name: 'Willowbrook/Rosa Parks', line: 'blue_a', tier: 1 },
    { lat: 33.9160, lon: -118.2382, name: 'Compton', line: 'blue_a', tier: 1 },
    { lat: 33.9029, lon: -118.2382, name: 'Artesia', line: 'blue_a', tier: 1 },
    { lat: 33.8862, lon: -118.2284, name: 'Del Amo', line: 'blue_a', tier: 1 },
    { lat: 33.8697, lon: -118.2119, name: 'Wardlow', line: 'blue_a', tier: 1 },
    { lat: 33.8567, lon: -118.2100, name: 'Willow St', line: 'blue_a', tier: 1 },
    { lat: 33.8470, lon: -118.1890, name: 'Pacific Coast Hwy', line: 'blue_a', tier: 1 },
    { lat: 33.7686, lon: -118.1891, name: '1st St (Long Beach)', line: 'blue_a', tier: 1 },
    { lat: 33.7676, lon: -118.1935, name: 'Downtown Long Beach', line: 'blue_a', tier: 1 },
    // --- Expo/E Line: 7th/Metro → Downtown Santa Monica ---
    { lat: 34.0222, lon: -118.2580, name: 'Expo Park/USC', line: 'expo_e', tier: 1 },
    { lat: 34.0186, lon: -118.2862, name: 'Expo/Vermont', line: 'expo_e', tier: 1 },
    { lat: 34.0183, lon: -118.3088, name: 'Expo/Western', line: 'expo_e', tier: 1 },
    { lat: 34.0227, lon: -118.3310, name: 'Expo/Crenshaw', line: 'expo_e', tier: 1 },
    { lat: 34.0252, lon: -118.3418, name: 'Farmdale', line: 'expo_e', tier: 1 },
    { lat: 34.0289, lon: -118.3520, name: 'Expo/La Brea', line: 'expo_e', tier: 1 },
    { lat: 34.0270, lon: -118.3710, name: 'La Cienega/Jefferson', line: 'expo_e', tier: 1 },
    { lat: 34.0248, lon: -118.3860, name: 'Culver City', line: 'expo_e', tier: 1 },
    { lat: 34.0209, lon: -118.3520, name: 'Palms', line: 'expo_e', tier: 1 },
    { lat: 34.0124, lon: -118.3908, name: 'Expo/Sepulveda', line: 'expo_e', tier: 1 },
    { lat: 34.0168, lon: -118.3685, name: 'Westwood/Rancho Park', line: 'expo_e', tier: 1 },
    { lat: 34.0135, lon: -118.4330, name: 'Expo/Bundy', line: 'expo_e', tier: 1 },
    { lat: 34.0156, lon: -118.4694, name: '26th St/Bergamot', line: 'expo_e', tier: 1 },
    { lat: 34.0154, lon: -118.4960, name: 'Downtown Santa Monica', line: 'expo_e', tier: 1 },
    // --- Gold/L Line: East LA → Azusa/APU ---
    { lat: 34.0566, lon: -118.2338, name: 'Little Tokyo/Arts District', line: 'gold_l', tier: 1 },
    { lat: 34.0561, lon: -118.2365, name: 'Union Station (Gold)', line: 'gold_l', tier: 1 },
    { lat: 34.0620, lon: -118.2360, name: 'Chinatown', line: 'gold_l', tier: 1 },
    { lat: 34.0672, lon: -118.2350, name: 'Lincoln/Cypress', line: 'gold_l', tier: 1 },
    { lat: 34.0760, lon: -118.2260, name: 'Heritage Square/Arroyo', line: 'gold_l', tier: 1 },
    { lat: 34.0890, lon: -118.2100, name: 'Southwest Museum', line: 'gold_l', tier: 1 },
    { lat: 34.0960, lon: -118.1990, name: 'Highland Park', line: 'gold_l', tier: 1 },
    { lat: 34.1118, lon: -118.1868, name: 'South Pasadena', line: 'gold_l', tier: 1 },
    { lat: 34.1175, lon: -118.1560, name: 'Fillmore', line: 'gold_l', tier: 1 },
    { lat: 34.1285, lon: -118.1340, name: 'Del Mar', line: 'gold_l', tier: 1 },
    { lat: 34.1360, lon: -118.1230, name: 'Memorial Park', line: 'gold_l', tier: 1 },
    { lat: 34.1421, lon: -118.1150, name: 'Lake', line: 'gold_l', tier: 1 },
    { lat: 34.1497, lon: -118.1030, name: 'Allen', line: 'gold_l', tier: 1 },
    { lat: 34.1500, lon: -118.0830, name: 'Sierra Madre Villa', line: 'gold_l', tier: 1 },
    { lat: 34.1520, lon: -118.0520, name: 'Arcadia', line: 'gold_l', tier: 1 },
    { lat: 34.1425, lon: -118.0310, name: 'Monrovia', line: 'gold_l', tier: 1 },
    { lat: 34.1365, lon: -118.0090, name: 'Duarte/City of Hope', line: 'gold_l', tier: 1 },
    { lat: 34.1360, lon: -117.9870, name: 'Irwindale', line: 'gold_l', tier: 1 },
    { lat: 34.1370, lon: -117.9620, name: 'Azusa Downtown', line: 'gold_l', tier: 1 },
    { lat: 34.1380, lon: -117.9440, name: 'APU/Citrus College', line: 'gold_l', tier: 1 },
    // Gold/L Line East LA branch
    { lat: 34.0441, lon: -118.2120, name: 'Mariachi Plaza/Boyle Heights', line: 'gold_l', tier: 1 },
    { lat: 34.0395, lon: -118.1938, name: 'Soto', line: 'gold_l', tier: 1 },
    { lat: 34.0335, lon: -118.1770, name: 'Indiana', line: 'gold_l', tier: 1 },
    { lat: 34.0290, lon: -118.1620, name: 'Maravilla', line: 'gold_l', tier: 1 },
    { lat: 34.0245, lon: -118.1475, name: 'East LA Civic Center', line: 'gold_l', tier: 1 },
    { lat: 34.0220, lon: -118.1280, name: 'Atlantic', line: 'gold_l', tier: 1 },
    // --- Green/C Line: Norwalk → Redondo Beach ---
    { lat: 33.9190, lon: -118.0570, name: 'Norwalk', line: 'green_c', tier: 1 },
    { lat: 33.9198, lon: -118.0940, name: 'Lakewood Blvd', line: 'green_c', tier: 1 },
    { lat: 33.9204, lon: -118.1262, name: 'Long Beach Blvd', line: 'green_c', tier: 1 },
    { lat: 33.9230, lon: -118.1706, name: 'Avalon', line: 'green_c', tier: 1 },
    { lat: 33.9268, lon: -118.2377, name: 'Willowbrook/Rosa Parks (Green)', line: 'green_c', tier: 1 },
    { lat: 33.9252, lon: -118.2565, name: 'Vermont/Athens', line: 'green_c', tier: 1 },
    { lat: 33.9289, lon: -118.2735, name: 'Harbor Freeway', line: 'green_c', tier: 1 },
    { lat: 33.9324, lon: -118.2915, name: 'Crenshaw (Green)', line: 'green_c', tier: 1 },
    { lat: 33.9525, lon: -118.3518, name: 'Hawthorne/Lennox', line: 'green_c', tier: 1 },
    { lat: 33.9340, lon: -118.3828, name: 'Aviation/LAX', line: 'green_c', tier: 1 },
    { lat: 33.9262, lon: -118.3960, name: 'Mariposa', line: 'green_c', tier: 1 },
    { lat: 33.9130, lon: -118.4030, name: 'El Segundo', line: 'green_c', tier: 1 },
    { lat: 33.9030, lon: -118.4093, name: 'Douglas', line: 'green_c', tier: 1 },
    { lat: 33.8920, lon: -118.4128, name: 'Redondo Beach', line: 'green_c', tier: 1 },
    // --- K Line (Crenshaw/LAX) ---
    { lat: 34.0227, lon: -118.3310, name: 'Expo/Crenshaw (K)', line: 'k_line', tier: 1 },
    { lat: 34.0100, lon: -118.3340, name: 'Leimert Park', line: 'k_line', tier: 1 },
    { lat: 33.9978, lon: -118.3320, name: 'Hyde Park', line: 'k_line', tier: 1 },
    { lat: 33.9838, lon: -118.3290, name: 'Fairview Heights', line: 'k_line', tier: 1 },
    { lat: 33.9680, lon: -118.3380, name: 'Downtown Inglewood', line: 'k_line', tier: 1 },
    { lat: 33.9530, lon: -118.3560, name: 'Westchester/Veterans', line: 'k_line', tier: 1 },
    { lat: 33.9340, lon: -118.3828, name: 'Aviation/Century (K)', line: 'k_line', tier: 1 },
    // --- Regional Connector ---
    { lat: 34.0458, lon: -118.2562, name: 'Grand Av Arts/Bunker Hill', line: 'connector', tier: 1 },
    { lat: 34.0489, lon: -118.2468, name: 'Historic Broadway', line: 'connector', tier: 1 },
    // --- Key Metrolink Stations (LA County, tier 2) ---
    { lat: 34.0561, lon: -118.2365, name: 'LA Union Station (Metrolink)', line: 'metrolink', tier: 2 },
    { lat: 34.1900, lon: -118.4500, name: 'Van Nuys (Metrolink)', line: 'metrolink', tier: 2 },
    { lat: 34.2083, lon: -118.4958, name: 'Chatsworth', line: 'metrolink', tier: 2 },
    { lat: 34.2600, lon: -118.4400, name: 'Sylmar/San Fernando', line: 'metrolink', tier: 2 },
    { lat: 34.1480, lon: -118.2555, name: 'Glendale', line: 'metrolink', tier: 2 },
    { lat: 34.1360, lon: -118.2410, name: 'Glendale (Tropico)', line: 'metrolink', tier: 2 },
    { lat: 34.0930, lon: -118.2360, name: 'Lincoln Heights (Metrolink)', line: 'metrolink', tier: 2 },
    { lat: 34.1766, lon: -118.3080, name: 'Burbank Airport North', line: 'metrolink', tier: 2 },
    { lat: 34.1834, lon: -118.3268, name: 'Burbank Downtown', line: 'metrolink', tier: 2 },
    { lat: 33.9017, lon: -118.2260, name: 'Compton (Metrolink)', line: 'metrolink', tier: 2 },
    { lat: 34.0513, lon: -118.2310, name: 'LA Downtown (Commercial St)', line: 'metrolink', tier: 2 },
    { lat: 34.0670, lon: -118.1650, name: 'Cal State LA', line: 'metrolink', tier: 2 },
    { lat: 34.0870, lon: -118.1300, name: 'El Monte', line: 'metrolink', tier: 2 },
    { lat: 34.1010, lon: -118.1030, name: 'Baldwin Park', line: 'metrolink', tier: 2 },
    { lat: 34.1160, lon: -118.0550, name: 'Covina', line: 'metrolink', tier: 2 },
    { lat: 34.0500, lon: -117.7510, name: 'Pomona Downtown', line: 'metrolink', tier: 2 },
    { lat: 33.7710, lon: -118.1890, name: 'Long Beach (Metrolink)', line: 'metrolink', tier: 2 },
];

// SB 79 Transit-Oriented Development tier definitions (effective July 1, 2026)
const SB79_TIERS = {
    1: { label: 'Tier 1 (Heavy Rail)', height: 95, density: 160, far: 4.5 },
    2: { label: 'Tier 2 (Light Rail/BRT)', height: 85, density: 140, far: 4.0 },
};
const SB79_ZONES = {
    adjacent: { maxDist: 0.038, label: '200ft (Adjacent)', parking: 0, heightMult: 1.0 },
    inner:    { maxDist: 0.25,  label: '1/4 Mile (Inner)',  parking: 0, heightMult: 1.0 },
    outer:    { maxDist: 0.50,  label: '1/2 Mile (Outer)',  parking: 0.5, heightMult: 0.68 },
};

// Line display colors for map markers
const LINE_COLORS = {
    red: '#e53e3e', purple: '#805ad5', blue_a: '#3182ce', expo_e: '#d69e2e',
    gold_l: '#b7791f', green_c: '#38a169', k_line: '#00bcd4', connector: '#ed64a6',
    metrolink: '#e53e3e',
};
const LINE_LABELS = {
    red: 'Red/B Line', purple: 'Purple/D Line', blue_a: 'Blue/A Line', expo_e: 'Expo/E Line',
    gold_l: 'Gold/L Line', green_c: 'Green/C Line', k_line: 'K Line (Crenshaw)', connector: 'Regional Connector',
    metrolink: 'Metrolink',
};

// Major LA arterials for street detection
const MAJOR_ARTERIALS = [
    'wilshire', 'sunset', 'santa monica', 'hollywood', 'venice', 'olympic',
    'pico', 'la cienega', 'figueroa', 'vermont', 'western', 'crenshaw',
    'sepulveda', 'van nuys', 'ventura', 'victory', 'sherman way', 'lincoln',
    'pacific coast', 'pch', 'florence', 'manchester', 'century', 'imperial',
    'alameda', 'broadway', 'spring', 'main st', 'san fernando', 'glendale',
    'beverly', 'la brea', 'fairfax', 'robertson', 'melrose', 'highland',
    'cahuenga', 'vine', 'western ave', 'normandie', 'hoover', 'alvarado',
    'temple', 'cesar chavez', 'first', '1st st', '3rd st', '6th st',
    'whittier', 'washington', 'jefferson', 'exposition', 'mlk',
    'martin luther king', 'slauson', 'gage', 'rosecrans', 'artesia',
    'el segundo', 'hawthorne', 'inglewood', 'prairie', 'aviation',
    'centinela', 'overland', 'motor', 'sawtelle', 'barrington',
    'balboa', 'reseda', 'tampa', 'winnetka', 'de soto', 'topanga',
    'canoga', 'fallbrook', 'laurel canyon', 'coldwater canyon',
    'lankershim', 'vineland', 'tujunga', 'foothill', 'glenoaks',
    'brand', 'colorado', 'huntington', 'atlantic', 'soto',
];

// Haversine distance in miles
function haversine(lat1, lon1, lat2, lon2) {
    const R = 3958.8; // Earth radius in miles
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat / 2) ** 2 +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon / 2) ** 2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

// Detect nearest neighborhood from coordinates + Nominatim address details
function detectNeighborhood(lat, lon, addressDetails) {
    // Try Nominatim address fields (neighbourhood is most specific, then suburb)
    if (addressDetails) {
        const fields = [
            addressDetails.neighbourhood,
            addressDetails.suburb,
            addressDetails.city_district,
            addressDetails.quarter,
        ];
        for (const field of fields) {
            if (field) {
                const key = field.toLowerCase().trim();
                if (SUBURB_TO_NEIGHBORHOOD[key]) {
                    return SUBURB_TO_NEIGHBORHOOD[key];
                }
            }
        }
    }
    // Fall back to centroid distance
    let best = 'westside';
    let bestDist = Infinity;
    for (const [key, c] of Object.entries(NEIGHBORHOOD_CENTROIDS)) {
        const d = haversine(lat, lon, c.lat, c.lon);
        if (d < bestDist) { bestDist = d; best = key; }
    }
    return best;
}

// Detect transit proximity from coordinates
function detectTransitProximity(lat, lon) {
    let minDist = Infinity;
    for (const s of METRO_STATIONS) {
        const d = haversine(lat, lon, s.lat, s.lon);
        if (d < minDist) minDist = d;
    }
    if (minDist <= 0.25) return 'adjacent';
    if (minDist <= 0.5) return 'near';
    if (minDist <= 1.0) return 'moderate';
    return 'far';
}

// Detect SB 79 eligibility from coordinates
function detectSB79Eligibility(lat, lon) {
    let nearest = null;
    let nearestDist = Infinity;
    let nearestIdx = -1;
    for (let i = 0; i < METRO_STATIONS.length; i++) {
        const s = METRO_STATIONS[i];
        const d = haversine(lat, lon, s.lat, s.lon);
        if (d < nearestDist) {
            nearestDist = d;
            nearest = s;
            nearestIdx = i;
        }
    }
    if (!nearest || nearestDist > 0.5) {
        return { eligible: false, station: nearest, distMiles: nearestDist, nearestIdx };
    }
    const tier = nearest.tier;
    const tierData = SB79_TIERS[tier];
    let zone, zoneKey;
    if (nearestDist <= SB79_ZONES.adjacent.maxDist) { zone = SB79_ZONES.adjacent; zoneKey = 'adjacent'; }
    else if (nearestDist <= SB79_ZONES.inner.maxDist) { zone = SB79_ZONES.inner; zoneKey = 'inner'; }
    else { zone = SB79_ZONES.outer; zoneKey = 'outer'; }

    const height = Math.round(tierData.height * zone.heightMult);
    const far = parseFloat((tierData.far * zone.heightMult).toFixed(2));
    const density = Math.round(tierData.density * zone.heightMult);
    return {
        eligible: true,
        station: nearest,
        nearestIdx,
        tier,
        tierLabel: tierData.label,
        zone: zoneKey,
        zoneLabel: zone.label,
        distMiles: nearestDist,
        allowances: { height, density, far, parking: zone.parking },
    };
}

// Detect if address is on a major arterial
function detectArterial(addressString, addressDetails) {
    // Try Nominatim road field first (most accurate — avoids matching neighborhood names)
    if (addressDetails && addressDetails.road) {
        const road = addressDetails.road.toLowerCase();
        for (const art of MAJOR_ARTERIALS) {
            if (road.includes(art)) return 'major';
        }
        if (/\bblvd\b|\bboulevard\b|\bave\b|\bavenue\b/.test(road)) return 'secondary';
        return 'residential';
    }
    // Fall back to full address string
    const lower = addressString.toLowerCase();
    for (const art of MAJOR_ARTERIALS) {
        if (lower.includes(art)) return 'major';
    }
    if (/\bblvd\b|\bboulevard\b|\bave\b|\bavenue\b/.test(lower)) return 'secondary';
    return 'residential';
}

// Detect site condition from Nominatim result
// For HBU analysis, any existing structure implies redevelopment → demolition
function detectSiteCondition(osmClass, osmType) {
    // Named structures (buildings, amenities, commercial, etc.)
    const structureClasses = ['building', 'amenity', 'shop', 'office', 'tourism', 'leisure', 'craft', 'club', 'healthcare'];
    if (structureClasses.includes(osmClass)) return 'demolition';
    // Address resolving to a house/building → existing structure for HBU redevelopment
    if (osmClass === 'place' && ['house', 'building', 'apartments', 'residential'].includes(osmType)) return 'demolition';
    // Other place types (most LA parcels have structures)
    if (osmClass === 'place') return 'demolition';
    return 'vacant';
}

// Estimate zoning when ZIMAS is blocked (fallback heuristic)
function estimateZoningFallback(addressString, addressDetails, neighborhood) {
    const lower = (addressString || '').toLowerCase();
    const road = (addressDetails && addressDetails.road) ? addressDetails.road.toLowerCase() : '';

    // Check if on a major commercial corridor
    const commercialCorridors = [
        'wilshire', 'sunset blvd', 'santa monica blvd', 'hollywood blvd', 'venice blvd',
        'olympic', 'pico blvd', 'beverly blvd', 'melrose ave', '3rd st', 'la brea',
        'la cienega', 'fairfax ave', 'robertson', 'highland ave', 'western ave',
        'vermont ave', 'figueroa', 'broadway', 'spring st', 'main st',
        'ventura blvd', 'lankershim', 'sepulveda blvd', 'van nuys blvd',
        'colorado blvd', 'brand blvd', 'glendale ave',
    ];
    const isCommercialCorridor = commercialCorridors.some(c => road.includes(c) || lower.includes(c));

    // Industrial areas
    const industrialAreas = ['arts district', 'vernon', 'commerce', 'boyle heights industrial'];
    const isIndustrial = industrialAreas.some(a => lower.includes(a));

    // DTLA is mostly commercial/mixed
    if (neighborhood === 'dtla') return isIndustrial ? 'M1' : 'C2';

    // Commercial corridors
    if (isCommercialCorridor) return 'C2';

    // Check for apartment-style addresses (Nominatim type)
    if (addressDetails && addressDetails.type === 'apartments') return 'R3';

    // Residential streets — check street suffix patterns
    const residentialSuffixes = /\b(ave|avenue|st|street|dr|drive|pl|place|way|ln|lane|ct|court|rd|road|blvd|ter|terrace|cir|circle)\b/i;
    const isResidential = residentialSuffixes.test(road) && !isCommercialCorridor;

    // Residential neighborhoods default to R1
    const residentialHoods = ['beverly', 'westside', 'santamonica', 'valleyeast', 'valleywest',
        'silverlake', 'highland', 'venice', 'culver', 'southbay', 'harbor'];
    if (residentialHoods.includes(neighborhood) && isResidential) return 'R1';

    // Dense residential neighborhoods
    const denseHoods = ['koreatown', 'hollywood', 'midcity', 'exposition'];
    if (denseHoods.includes(neighborhood) && isResidential) return 'R3';

    // South LA residential
    if (['southla', 'boyleheights'].includes(neighborhood) && isResidential) return 'R1';

    // Default: R1 for residential streets, C2 for commercial
    if (isResidential) return 'R1';
    return null; // Can't determine — let user select
}

// Map ZIMAS zoning code to our dropdown values
function mapZoningCode(rawZone) {
    if (!rawZone) return null;
    // ZIMAS returns codes like "C2-1VL", "[Q]R3-1XL", "M1-1", "R1-1-HCR" etc.
    // Strip Q conditions, D limitations, and supplemental use districts
    let z = rawZone.toUpperCase().replace(/\[.*?\]/g, '').trim();
    // Extract the base zone (letters + optional digits before the dash-height suffix)
    const match = z.match(/^(R[1-5]|C[1-5]|C1\.5|CM|M[1-3]|PF|OS|LAX)/);
    if (match) return match[1];
    // TOD areas are usually identified via overlay, not base zone
    return null;
}

// === API CALLS ===

// Geocode via OpenStreetMap Nominatim (CORS-friendly)
async function geocodeAddress(address) {
    // Append Los Angeles CA if not already present to improve results
    let query = address;
    if (!/los\s*angeles/i.test(query) && !/\bLA\b/.test(query)) {
        query += ', Los Angeles, CA';
    }
    const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&addressdetails=1&limit=1&countrycodes=us`;
    const resp = await fetch(url, {
        headers: { 'Accept': 'application/json' }
    });
    if (!resp.ok) throw new Error('Geocoding service unavailable');
    const data = await resp.json();
    if (!data || data.length === 0) throw new Error('Address not found. Try including city and zip code.');
    const m = data[0];
    return {
        lat: parseFloat(m.lat),
        lon: parseFloat(m.lon),
        matched: m.display_name,
        address: m.address || {},
        osmClass: m.class || '',
        osmType: m.type || '',
    };
}

// Query ZIMAS zoning layer
async function fetchZoning(lat, lon) {
    try {
        // ZIMAS uses CA State Plane Zone 5 (feet) but we can pass WGS84 with inSR=4326
        const url = `https://zimas.lacity.org/arcgis/rest/services/zma/zoning/MapServer/1102/query?` +
            `geometry=${lon},${lat}&geometryType=esriGeometryPoint&inSR=4326` +
            `&spatialRel=esriSpatialRelIntersects&outFields=ZONE_CMPLT&returnGeometry=false&f=json`;
        const resp = await fetch(url);
        if (!resp.ok) throw new Error('ZIMAS unavailable');
        const data = await resp.json();
        if (data.features && data.features.length > 0) {
            const raw = data.features[0].attributes.ZONE_CMPLT || data.features[0].attributes.zone_cmplt;
            return { raw, mapped: mapZoningCode(raw) };
        }
        return null;
    } catch (e) {
        console.warn('ZIMAS zoning query failed (may be CORS):', e);
        return { error: 'cors' };
    }
}

// Query LA County parcel layer for lot size
async function fetchParcelInfo(lat, lon) {
    try {
        const url = `https://public.gis.lacounty.gov/public/rest/services/LACounty_Cache/LACounty_Parcel/MapServer/0/query?` +
            `geometry=${lon},${lat}&geometryType=esriGeometryPoint&inSR=4326` +
            `&spatialRel=esriSpatialRelIntersects&outFields=*&returnGeometry=true&f=json`;
        const resp = await fetch(url);
        if (!resp.ok) throw new Error('Parcel service unavailable');
        const data = await resp.json();
        if (data.features && data.features.length > 0) {
            const attrs = data.features[0].attributes;
            // Try different field names for area
            let area = attrs['Shape.STArea()'] || attrs['Shape__Area'] || attrs['ShapeSTArea'] || attrs['SHAPE.STArea()'] || null;
            // If geometry is returned, try to compute from rings
            if (!area && data.features[0].geometry && data.features[0].geometry.rings) {
                area = computePolygonArea(data.features[0].geometry.rings, data.spatialReference);
            }
            return { area, attrs };
        }
        return null;
    } catch (e) {
        console.warn('Parcel query failed (may be CORS):', e);
        return { error: 'cors' };
    }
}

// Compute polygon area from rings (in sq ft if Web Mercator, approximate otherwise)
function computePolygonArea(rings, sr) {
    // Shoelace formula — gives area in the spatial reference units
    let totalArea = 0;
    for (const ring of rings) {
        let a = 0;
        for (let i = 0; i < ring.length - 1; i++) {
            a += ring[i][0] * ring[i + 1][1] - ring[i + 1][0] * ring[i][1];
        }
        totalArea += Math.abs(a) / 2;
    }
    // If Web Mercator (meters), convert to sq ft
    if (sr && (sr.wkid === 102100 || sr.wkid === 3857)) {
        // At LA latitude (~34°), 1 Web Mercator meter ≈ 0.829 real meters
        const latRad = 34.05 * Math.PI / 180;
        const scaleFactor = Math.cos(latRad);
        const realSqMeters = totalArea * scaleFactor * scaleFactor;
        return Math.round(realSqMeters * 10.7639); // sq meters to sq ft
    }
    // If State Plane feet
    if (sr && (sr.wkid === 2229 || sr.wkid === 102645)) {
        return Math.round(totalArea);
    }
    // Fallback: assume sq ft
    return Math.round(totalArea);
}

// Estimate frontage from parcel area (rough: assume ~2:1 lot ratio)
function estimateFrontage(areaSqFt) {
    if (!areaSqFt || areaSqFt <= 0) return 80;
    // Assume lot depth ≈ 2× frontage → area = frontage × (2 × frontage) = 2f²
    const f = Math.sqrt(areaSqFt / 2);
    return Math.round(Math.max(20, Math.min(500, f)));
}

// Lookup status helpers
function setStatus(html) {
    document.getElementById('lookupStatus').innerHTML = html;
}

function addStatus(html) {
    document.getElementById('lookupStatus').innerHTML += html;
}

// Mark a field as autofilled
function markAutofill(fieldId) {
    const el = document.getElementById('field-' + fieldId);
    if (el) el.classList.add('autofilled');
}

// Clear all autofill markers
function clearAutofill() {
    document.querySelectorAll('.field.autofilled').forEach(el => el.classList.remove('autofilled'));
    document.getElementById('autofillNotice').classList.remove('visible');
}

// === MAIN LOOKUP ORCHESTRATOR ===

async function lookupAddress() {
    const address = document.getElementById('addressInput').value.trim();
    if (!address) {
        setStatus('<span class="err">Please enter an address.</span>');
        return;
    }

    const btn = document.getElementById('btnLookup');
    btn.disabled = true;
    btn.textContent = 'Looking up...';
    clearAutofill();
    setStatus('<span class="loading">Geocoding address...</span>');

    let coords;
    try {
        coords = await geocodeAddress(address);
        setStatus(`<span class="status-item ok">Matched: ${coords.matched}</span>`);
    } catch (e) {
        setStatus(`<span class="err">${e.message}</span>`);
        btn.disabled = false;
        btn.textContent = 'Look Up';
        return;
    }

    // Store coordinates globally for map & SB 79 detection
    window.lastGeocode = { lat: coords.lat, lon: coords.lon };

    let filledCount = 0;

    // Run zoning + parcel queries in parallel
    addStatus('<br><span class="loading">Querying zoning &amp; parcel data...</span>');

    const [zoningResult, parcelResult] = await Promise.all([
        fetchZoning(coords.lat, coords.lon),
        fetchParcelInfo(coords.lat, coords.lon),
    ]);

    // Build status summary
    let statusParts = [`<span class="status-item ok">Matched: ${coords.matched}</span>`];

    // Apply zoning
    if (zoningResult && zoningResult.error === 'cors') {
        // Estimate zoning from street type and neighborhood when ZIMAS blocked
        const estZone = estimateZoningFallback(coords.matched || address, coords.address, hood);
        if (estZone) {
            document.getElementById('zoning').value = estZone;
            markAutofill('zoning');
            filledCount++;
            statusParts.push(`<span class="status-item warn">Zoning: ZIMAS blocked — estimated ${estZone} from location (verify manually)</span>`);
        } else {
            statusParts.push(`<span class="status-item warn">Zoning: ZIMAS blocked by browser — select manually</span>`);
        }
    } else if (zoningResult && zoningResult.mapped) {
        const sel = document.getElementById('zoning');
        const opt = sel.querySelector(`option[value="${zoningResult.mapped}"]`);
        if (opt) {
            sel.value = zoningResult.mapped;
            markAutofill('zoning');
            filledCount++;
            statusParts.push(`<span class="status-item ok">Zoning: ${zoningResult.raw}</span>`);
        } else {
            statusParts.push(`<span class="status-item warn">Zoning "${zoningResult.raw}" — not in dropdown, please select manually</span>`);
        }
    } else if (zoningResult && zoningResult.raw) {
        statusParts.push(`<span class="status-item warn">Zoning "${zoningResult.raw}" — please select closest match</span>`);
    } else {
        // Also try fallback estimation when ZIMAS returns nothing
        const estZone = estimateZoningFallback(coords.matched || address, coords.address, hood);
        if (estZone) {
            document.getElementById('zoning').value = estZone;
            markAutofill('zoning');
            filledCount++;
            statusParts.push(`<span class="status-item warn">Zoning: estimated ${estZone} from location (verify manually)</span>`);
        } else {
            statusParts.push(`<span class="status-item warn">Zoning: could not retrieve — please select manually</span>`);
        }
    }

    // Apply parcel size
    if (parcelResult && parcelResult.error === 'cors') {
        statusParts.push(`<span class="status-item warn">Parcel size: County GIS blocked by browser — enter manually</span>`);
    } else if (parcelResult && parcelResult.area && parcelResult.area > 0) {
        document.getElementById('parcelSize').value = Math.round(parcelResult.area);
        markAutofill('parcelSize');
        filledCount++;
        statusParts.push(`<span class="status-item ok">Lot: ${Math.round(parcelResult.area).toLocaleString()} SF</span>`);

        // Estimate frontage
        const est = estimateFrontage(parcelResult.area);
        document.getElementById('frontage').value = est;
        markAutofill('frontage');
        filledCount++;
    } else {
        statusParts.push(`<span class="status-item warn">Parcel size: could not retrieve — enter manually</span>`);
    }

    // Detect neighborhood (using Nominatim address details when available)
    const hood = detectNeighborhood(coords.lat, coords.lon, coords.address);
    document.getElementById('neighborhood').value = hood;
    markAutofill('neighborhood');
    filledCount++;

    // Detect transit
    const transit = detectTransitProximity(coords.lat, coords.lon);
    document.getElementById('transit').value = transit;
    markAutofill('transit');
    filledCount++;

    // Detect arterial (using Nominatim road field when available)
    const arterial = detectArterial(coords.matched || address, coords.address);
    document.getElementById('arterial').value = arterial;
    markAutofill('arterial');
    filledCount++;

    // Detect site condition from Nominatim class/type
    const siteCondition = detectSiteCondition(coords.osmClass, coords.osmType);
    document.getElementById('siteCondition').value = siteCondition;
    markAutofill('siteCondition');
    filledCount++;

    // Show status
    setStatus(statusParts.join('<br>'));

    // Show autofill notice
    if (filledCount > 0) {
        document.getElementById('autofillNotice').classList.add('visible');
    }

    btn.disabled = false;
    btn.textContent = 'Look Up';
}


// ============================================================
//  LA-Specific Data & Scoring Engine
// ============================================================

const LAND_USES = [
    { id: 'sfr',            name: 'Single-Family Residential',      icon: '🏡' },
    { id: 'duplex',         name: 'Duplex / Two-Unit',              icon: '🏘️' },
    { id: 'multifamily_low', name: 'Multi-Family (Low-Rise)',       icon: '🏢' },
    { id: 'multifamily_mid', name: 'Multi-Family (Mid-Rise)',       icon: '🏙️' },
    { id: 'multifamily_high', name: 'Multi-Family (High-Rise)',     icon: '🏗️' },
    { id: 'mixeduse',       name: 'Mixed-Use (Retail + Residential)', icon: '🏬' },
    { id: 'retail',         name: 'Retail / Restaurant',            icon: '🛍️' },
    { id: 'office',         name: 'Office / Professional',          icon: '🏛️' },
    { id: 'medical',        name: 'Medical Office',                 icon: '🏥' },
    { id: 'hotel',          name: 'Hotel / Hospitality',            icon: '🏨' },
    { id: 'industrial',     name: 'Industrial / Warehouse',         icon: '🏭' },
    { id: 'selfstorage',    name: 'Self-Storage',                   icon: '📦' },
    { id: 'senior',         name: 'Senior Living / Assisted',       icon: '🧓' },
    { id: 'parking',        name: 'Parking Structure / Lot',        icon: '🅿️' },
    { id: 'creative',       name: 'Creative Office / Flex',         icon: '🎨' },
    { id: 'adu',            name: 'ADU / Small-Lot Subdivision',    icon: '🏠' },
];

// Zoning → which uses are legally permissible
// 0 = not permitted, 0.5 = conditional/CUP required, 1.0 = by-right
const ZONING_MATRIX = {
    'R1':  { sfr:1, duplex:0, multifamily_low:0, multifamily_mid:0, multifamily_high:0, mixeduse:0, retail:0, office:0, medical:0, hotel:0, industrial:0, selfstorage:0, senior:0.5, parking:0, creative:0, adu:1 },
    'R2':  { sfr:1, duplex:1, multifamily_low:0.5, multifamily_mid:0, multifamily_high:0, mixeduse:0, retail:0, office:0, medical:0, hotel:0, industrial:0, selfstorage:0, senior:0.5, parking:0, creative:0, adu:1 },
    'R3':  { sfr:1, duplex:1, multifamily_low:1, multifamily_mid:0.5, multifamily_high:0, mixeduse:0, retail:0, office:0, medical:0, hotel:0, industrial:0, selfstorage:0, senior:0.5, parking:0.5, creative:0, adu:1 },
    'R4':  { sfr:0.5, duplex:1, multifamily_low:1, multifamily_mid:1, multifamily_high:0.5, mixeduse:0, retail:0, office:0, medical:0, hotel:0, industrial:0, selfstorage:0, senior:1, parking:0.5, creative:0, adu:0.5 },
    'R5':  { sfr:0, duplex:0.5, multifamily_low:1, multifamily_mid:1, multifamily_high:1, mixeduse:0, retail:0, office:0, medical:0, hotel:0.5, industrial:0, selfstorage:0, senior:1, parking:0.5, creative:0, adu:0 },
    'C1':  { sfr:0, duplex:0, multifamily_low:0.5, multifamily_mid:0, multifamily_high:0, mixeduse:0.5, retail:1, office:1, medical:1, hotel:0, industrial:0, selfstorage:0, senior:0, parking:1, creative:0.5, adu:0 },
    'C1.5':{ sfr:0, duplex:0, multifamily_low:0.5, multifamily_mid:0.5, multifamily_high:0, mixeduse:1, retail:1, office:1, medical:1, hotel:0.5, industrial:0, selfstorage:0, senior:0.5, parking:1, creative:0.5, adu:0 },
    'C2':  { sfr:0, duplex:0, multifamily_low:1, multifamily_mid:1, multifamily_high:0.5, mixeduse:1, retail:1, office:1, medical:1, hotel:1, industrial:0, selfstorage:0.5, senior:1, parking:1, creative:1, adu:0 },
    'C4':  { sfr:0, duplex:0, multifamily_low:0.5, multifamily_mid:1, multifamily_high:0.5, mixeduse:1, retail:1, office:1, medical:1, hotel:1, industrial:0, selfstorage:0.5, senior:0.5, parking:1, creative:1, adu:0 },
    'C5':  { sfr:0, duplex:0, multifamily_low:0, multifamily_mid:0.5, multifamily_high:0, mixeduse:0.5, retail:1, office:1, medical:0.5, hotel:0.5, industrial:0, selfstorage:0.5, senior:0, parking:1, creative:0.5, adu:0 },
    'CM':  { sfr:0, duplex:0, multifamily_low:0, multifamily_mid:0, multifamily_high:0, mixeduse:0.5, retail:0.5, office:1, medical:0.5, hotel:0, industrial:0.5, selfstorage:1, senior:0, parking:1, creative:1, adu:0 },
    'M1':  { sfr:0, duplex:0, multifamily_low:0, multifamily_mid:0, multifamily_high:0, mixeduse:0, retail:0.5, office:0.5, medical:0, hotel:0, industrial:1, selfstorage:1, senior:0, parking:1, creative:1, adu:0 },
    'M2':  { sfr:0, duplex:0, multifamily_low:0, multifamily_mid:0, multifamily_high:0, mixeduse:0, retail:0, office:0, medical:0, hotel:0, industrial:1, selfstorage:1, senior:0, parking:1, creative:0.5, adu:0 },
    'M3':  { sfr:0, duplex:0, multifamily_low:0, multifamily_mid:0, multifamily_high:0, mixeduse:0, retail:0, office:0, medical:0, hotel:0, industrial:1, selfstorage:0.5, senior:0, parking:1, creative:0, adu:0 },
    'PF':  { sfr:0, duplex:0, multifamily_low:0, multifamily_mid:0, multifamily_high:0, mixeduse:0, retail:0, office:0.5, medical:0.5, hotel:0, industrial:0, selfstorage:0, senior:0.5, parking:0.5, creative:0, adu:0 },
    'OS':  { sfr:0, duplex:0, multifamily_low:0, multifamily_mid:0, multifamily_high:0, mixeduse:0, retail:0, office:0, medical:0, hotel:0, industrial:0, selfstorage:0, senior:0, parking:0, creative:0, adu:0 },
    'LAX': { sfr:0, duplex:0, multifamily_low:0, multifamily_mid:0, multifamily_high:0, mixeduse:0, retail:0.5, office:0.5, medical:0, hotel:0.5, industrial:0.5, selfstorage:0.5, senior:0, parking:1, creative:0, adu:0 },
    'TOD': { sfr:0, duplex:0.5, multifamily_low:1, multifamily_mid:1, multifamily_high:1, mixeduse:1, retail:1, office:1, medical:1, hotel:1, industrial:0, selfstorage:0, senior:1, parking:0.5, creative:1, adu:0.5 },
};

// Neighborhood market demand multipliers (1.0 = average)
const NEIGHBORHOOD_DEMAND = {
    dtla:         { sfr:0.3, duplex:0.4, multifamily_low:1.1, multifamily_mid:1.3, multifamily_high:1.4, mixeduse:1.4, retail:1.2, office:1.3, medical:0.7, hotel:1.3, industrial:0.5, selfstorage:0.7, senior:0.6, parking:1.3, creative:1.4, adu:0.3 },
    hollywood:    { sfr:0.5, duplex:0.7, multifamily_low:1.2, multifamily_mid:1.3, multifamily_high:1.1, mixeduse:1.3, retail:1.2, office:1.0, medical:0.8, hotel:1.2, industrial:0.3, selfstorage:0.7, senior:0.5, parking:1.1, creative:1.3, adu:0.6 },
    koreatown:    { sfr:0.4, duplex:0.6, multifamily_low:1.3, multifamily_mid:1.4, multifamily_high:1.2, mixeduse:1.3, retail:1.2, office:0.9, medical:1.1, hotel:1.0, industrial:0.3, selfstorage:0.8, senior:0.8, parking:1.2, creative:0.9, adu:0.5 },
    westside:     { sfr:1.0, duplex:0.9, multifamily_low:1.1, multifamily_mid:1.2, multifamily_high:0.9, mixeduse:1.2, retail:1.1, office:1.2, medical:1.3, hotel:1.0, industrial:0.2, selfstorage:0.6, senior:1.0, parking:1.0, creative:1.1, adu:0.9 },
    santamonica:  { sfr:0.8, duplex:0.8, multifamily_low:1.0, multifamily_mid:1.1, multifamily_high:0.8, mixeduse:1.2, retail:1.3, office:1.1, medical:1.0, hotel:1.1, industrial:0.2, selfstorage:0.4, senior:0.8, parking:1.0, creative:1.2, adu:0.7 },
    beverly:      { sfr:1.2, duplex:0.8, multifamily_low:1.0, multifamily_mid:1.1, multifamily_high:0.9, mixeduse:1.1, retail:1.1, office:1.3, medical:1.4, hotel:1.1, industrial:0.1, selfstorage:0.3, senior:1.0, parking:0.9, creative:0.9, adu:0.7 },
    midcity:      { sfr:0.7, duplex:0.8, multifamily_low:1.2, multifamily_mid:1.2, multifamily_high:0.8, mixeduse:1.2, retail:1.0, office:0.9, medical:1.0, hotel:0.8, industrial:0.3, selfstorage:0.8, senior:0.9, parking:0.9, creative:1.0, adu:0.8 },
    southla:      { sfr:0.9, duplex:1.0, multifamily_low:1.1, multifamily_mid:0.8, multifamily_high:0.4, mixeduse:0.8, retail:0.8, office:0.5, medical:0.7, hotel:0.4, industrial:0.9, selfstorage:1.1, senior:0.7, parking:0.6, creative:0.6, adu:1.1 },
    valleyeast:   { sfr:1.1, duplex:1.0, multifamily_low:1.0, multifamily_mid:0.8, multifamily_high:0.5, mixeduse:0.9, retail:0.9, office:0.8, medical:0.9, hotel:0.6, industrial:1.0, selfstorage:1.1, senior:0.9, parking:0.7, creative:0.7, adu:1.0 },
    valleywest:   { sfr:1.2, duplex:1.0, multifamily_low:0.9, multifamily_mid:0.8, multifamily_high:0.4, mixeduse:0.9, retail:0.9, office:0.9, medical:1.0, hotel:0.6, industrial:0.8, selfstorage:1.0, senior:1.0, parking:0.6, creative:0.7, adu:1.0 },
    silverlake:   { sfr:0.9, duplex:0.9, multifamily_low:1.2, multifamily_mid:1.0, multifamily_high:0.5, mixeduse:1.2, retail:1.1, office:0.8, medical:0.7, hotel:0.7, industrial:0.3, selfstorage:0.5, senior:0.5, parking:0.7, creative:1.3, adu:1.0 },
    highland:     { sfr:0.9, duplex:0.9, multifamily_low:1.1, multifamily_mid:0.9, multifamily_high:0.4, mixeduse:1.1, retail:1.0, office:0.7, medical:0.7, hotel:0.5, industrial:0.5, selfstorage:0.7, senior:0.5, parking:0.6, creative:1.1, adu:1.0 },
    venice:       { sfr:0.9, duplex:0.8, multifamily_low:1.0, multifamily_mid:0.9, multifamily_high:0.5, mixeduse:1.2, retail:1.2, office:1.0, medical:0.7, hotel:1.0, industrial:0.2, selfstorage:0.3, senior:0.6, parking:0.8, creative:1.3, adu:0.8 },
    culver:       { sfr:0.8, duplex:0.8, multifamily_low:1.1, multifamily_mid:1.1, multifamily_high:0.7, mixeduse:1.2, retail:1.0, office:1.2, medical:1.0, hotel:0.9, industrial:0.5, selfstorage:0.7, senior:0.8, parking:0.8, creative:1.3, adu:0.8 },
    exposition:   { sfr:0.6, duplex:0.7, multifamily_low:1.2, multifamily_mid:1.2, multifamily_high:0.9, mixeduse:1.2, retail:1.0, office:0.9, medical:0.8, hotel:0.7, industrial:0.4, selfstorage:0.8, senior:0.7, parking:0.9, creative:1.0, adu:0.8 },
    southbay:     { sfr:1.0, duplex:0.9, multifamily_low:0.9, multifamily_mid:0.7, multifamily_high:0.3, mixeduse:0.8, retail:0.9, office:0.8, medical:1.0, hotel:0.7, industrial:1.2, selfstorage:1.1, senior:0.9, parking:0.6, creative:0.6, adu:0.9 },
    harbor:       { sfr:0.7, duplex:0.7, multifamily_low:0.8, multifamily_mid:0.6, multifamily_high:0.3, mixeduse:0.7, retail:0.7, office:0.5, medical:0.6, hotel:0.6, industrial:1.3, selfstorage:1.1, senior:0.7, parking:0.7, creative:0.5, adu:0.7 },
    boyleheights: { sfr:0.9, duplex:1.0, multifamily_low:1.1, multifamily_mid:0.7, multifamily_high:0.3, mixeduse:0.9, retail:0.9, office:0.5, medical:0.6, hotel:0.3, industrial:0.8, selfstorage:0.9, senior:0.6, parking:0.5, creative:0.8, adu:1.1 },
};

// Minimum parcel sizes (sq ft) for feasibility
const MIN_PARCEL = {
    sfr: 2500, duplex: 3500, multifamily_low: 5000, multifamily_mid: 10000,
    multifamily_high: 20000, mixeduse: 5000, retail: 2000, office: 3000,
    medical: 3000, hotel: 15000, industrial: 5000, selfstorage: 8000,
    senior: 15000, parking: 3000, creative: 3000, adu: 1200
};

// Approx LA land value per SF by neighborhood (for relative comparisons)
const LAND_VALUE_PSF = {
    dtla: 250, hollywood: 250, koreatown: 200, westside: 350, santamonica: 400,
    beverly: 450, midcity: 180, southla: 85, valleyeast: 110, valleywest: 130,
    silverlake: 220, highland: 150, venice: 350, culver: 260, exposition: 160,
    southbay: 120, harbor: 80, boyleheights: 110
};

// Revenue potential per NSF of building (annual $/SF, new-construction achievable rents)
const REVENUE_PSF = {
    sfr: 40, duplex: 42, multifamily_low: 52, multifamily_mid: 58,
    multifamily_high: 66, mixeduse: 56, retail: 52, office: 52,
    medical: 62, hotel: 90, industrial: 22, selfstorage: 24,
    senior: 62, parking: 30, creative: 52, adu: 46
};

// Neighborhood rent multiplier — adjusts REVENUE_PSF by submarket
const NEIGHBORHOOD_RENT_MULT = {
    dtla: 0.95, hollywood: 1.10, koreatown: 0.88, westside: 1.25, santamonica: 1.35,
    beverly: 1.40, midcity: 1.00, southla: 0.70, valleyeast: 0.82, valleywest: 0.85,
    silverlake: 1.08, highland: 0.88, venice: 1.25, culver: 1.12, exposition: 0.88,
    southbay: 0.85, harbor: 0.70, boyleheights: 0.75
};

// Parking cost per space by building type
const PARKING_COST_MAP = {
    sfr: 8000, duplex: 8000, multifamily_low: 30000, multifamily_mid: 40000,
    multifamily_high: 65000, mixeduse: 40000, retail: 8000, office: 40000,
    medical: 40000, hotel: 55000, industrial: 5000, selfstorage: 5000,
    senior: 30000, parking: 35000, creative: 8000, adu: 5000
};

// Build cost per SF (LA 2024-2025 market)
const BUILD_COST_PSF = {
    sfr: 300, duplex: 275, multifamily_low: 310, multifamily_mid: 400,
    multifamily_high: 575, mixeduse: 420, retail: 260, office: 365,
    medical: 430, hotel: 480, industrial: 150, selfstorage: 110,
    senior: 400, parking: 85, creative: 290, adu: 280
};

// FAR (floor area ratio) by use — typical LA densities
const FAR_TYPICAL = {
    sfr: 0.5, duplex: 0.6, multifamily_low: 1.5, multifamily_mid: 3.0,
    multifamily_high: 6.0, mixeduse: 3.0, retail: 0.5, office: 2.0,
    medical: 1.5, hotel: 4.0, industrial: 0.5, selfstorage: 2.5,
    senior: 2.5, parking: 3.0, creative: 1.5, adu: 0.5
};

// Rationale templates
const RATIONALE = {
    sfr:             'Single-family development suits the site due to residential zoning, neighborhood character, and stable demand for ownership housing.',
    duplex:          'Duplex development provides moderate density with manageable entitlement complexity, strong for owner-occupant or rental income strategies.',
    multifamily_low: 'Low-rise multifamily maximizes unit count within a manageable building type, aligning well with LA\'s housing demand and density incentives.',
    multifamily_mid: 'Mid-rise multifamily leverages the parcel size and zoning to achieve meaningful density, supported by strong rental market fundamentals.',
    multifamily_high:'High-rise multifamily captures maximum density bonus potential in a high-demand corridor, though construction costs are significantly higher.',
    mixeduse:        'Mixed-use development combines ground-floor commercial revenue with residential density above, ideal for transit-accessible commercial corridors.',
    retail:          'Retail use leverages street frontage, visibility, and pedestrian traffic in a commercial corridor with demonstrated consumer demand.',
    office:          'Office development responds to professional service demand in the submarket, with viable access and infrastructure to support employment density.',
    medical:         'Medical office benefits from proximity to health care services, strong tenant demand, and premium rents typical of medical-zoned uses.',
    hotel:           'Hotel/hospitality use leverages tourism and business travel demand, arterial visibility, and transit proximity for viable room-night revenue.',
    industrial:      'Industrial/warehouse use provides strong yield potential with lower construction costs, supported by limited industrial land supply in LA.',
    selfstorage:     'Self-storage is operationally efficient with low staffing costs, serves population density demand, and tolerates suboptimal site configurations.',
    senior:          'Senior living addresses the growing aging population with premium per-unit revenue and purpose-built care facilities.',
    parking:         'Parking structure use addresses chronic parking deficits in dense urban areas, with modest build costs and reliable demand.',
    creative:        'Creative office/flex space appeals to tech and media tenants seeking character space, commanding premium rents in emerging neighborhoods.',
    adu:             'ADU or small-lot subdivision maximizes yield on smaller parcels under CA housing legislation (SB 9, AB 68) with minimal entitlement friction.',
};


// ============================================================
//  CA HOUSING LEGISLATION
// ============================================================

const CA_HOUSING_LEGISLATION = [
    {
        id: 'sb9',
        name: 'SB 9 (HOME Act)',
        description: 'By-right duplex and lot splits on single-family parcels statewide.',
        detail: 'The California HOME Act (2021) allows property owners to split single-family lots and build duplexes by-right, bypassing traditional zoning restrictions. Applies to parcels of at least 2,400 SF in urbanized areas, not in historic districts, fire hazard zones, or conservation areas. Each resulting lot must be at least 1,200 SF. Owner-occupancy is required for 3 years on one of the units if a lot split is pursued. This effectively doubles the allowed density on R1-zoned land without requiring a zone change or CUP. Impact: Significant for small infill developers targeting R1 neighborhoods.',
        applies: (useId, inp) => inp.zoning === 'R1' && inp.parcelSize >= 2400 && ['duplex', 'adu'].includes(useId),
        densityBonus: 1.0,
        parkingReduction: 0,
        softCostReduction: 0,
        legalOverride: true,
    },
    {
        id: 'ab2011',
        name: 'AB 2011',
        description: 'By-right affordable housing on commercially zoned land.',
        detail: 'AB 2011 (2022) creates a streamlined, ministerial (by-right) approval pathway for 100% affordable housing on commercially zoned land. Projects must pay prevailing wages and meet affordability requirements — mixed-income projects require a percentage of units at below-market rents. Applies to sites zoned for office, retail, or parking that are not in industrial zones, coastal zones, or high fire areas. Overrides local zoning that would otherwise prohibit residential uses on commercial parcels. Impact: Unlocks large swaths of commercial land for affordable housing development across California.',
        applies: (useId, inp) => ['C1','C1.5','C2','C4','C5','CM'].includes(inp.zoning) && ['multifamily_low','multifamily_mid','multifamily_high','mixeduse'].includes(useId),
        densityBonus: 0.35,
        parkingReduction: 0,
        softCostReduction: 0,
        legalOverride: true,
    },
    {
        id: 'sb6',
        name: 'SB 6',
        description: 'Market-rate housing permitted on commercially zoned land.',
        detail: 'SB 6, the Middle Class Housing Act (2022), allows market-rate residential development on commercially zoned land, provided the project meets specified objective design standards and at least 20% of units are affordable. Unlike AB 2011, SB 6 allows market-rate projects but requires the local approval process. Projects must comply with local height and FAR limits. Applies to parcels zoned for office, retail, or parking uses. Impact: Enables market-rate housing on commercial corridors where residential was previously prohibited.',
        applies: (useId, inp) => ['C1','C1.5','C2','C4','C5','CM'].includes(inp.zoning) && ['multifamily_low','multifamily_mid','multifamily_high','mixeduse'].includes(useId),
        densityBonus: 0.25,
        parkingReduction: 0,
        softCostReduction: 0,
        legalOverride: false,
    },
    {
        id: 'sb423',
        name: 'SB 423 (Streamlined)',
        description: 'Streamlined ministerial approval for multifamily projects meeting affordability thresholds.',
        detail: 'SB 423 (2023) extends and strengthens SB 35\'s streamlined ministerial approval process for multifamily housing projects meeting affordability thresholds. Projects with 10%+ affordable units in jurisdictions that have not met housing production goals qualify for ministerial approval. Eliminates discretionary review, CEQA requirements, and public hearings for qualifying projects. Applies to urban infill sites in areas meeting RHNA progress standards. Impact: Dramatically reduces entitlement timelines and costs for projects meeting affordability thresholds.',
        applies: (useId, inp) => ['R2','R3','R4','R5','C1.5','C2','C4','TOD'].includes(inp.zoning) && ['multifamily_low','multifamily_mid','multifamily_high','mixeduse'].includes(useId),
        densityBonus: 0,
        parkingReduction: 0,
        softCostReduction: 0.15,
        legalOverride: false,
    },
    {
        id: 'ab2345',
        name: 'AB 2345 (Density Bonus)',
        description: 'Up to 50% density bonus and reduced parking for projects including affordable units.',
        detail: 'AB 2345 (2020) enhances California\'s Density Bonus Law, increasing the maximum density bonus from 35% to 50% for projects including affordable units. Provides up to 4 incentives or concessions such as reduced setbacks, increased height, and reduced parking. Parking minimums reduced to 0.5 spaces per unit for projects near transit. Applies to all residential and mixed-use zones with affordable set-asides meeting specified thresholds. Impact: One of the most widely used tools by LA developers to significantly increase project density and reduce parking requirements.',
        applies: (useId, inp) => ['R2','R3','R4','R5','C1','C1.5','C2','C4','TOD'].includes(inp.zoning) && ['duplex','multifamily_low','multifamily_mid','multifamily_high','mixeduse','senior'].includes(useId),
        densityBonus: 0.50,
        parkingReduction: 0.20,
        softCostReduction: 0,
        legalOverride: false,
    },
    {
        id: 'ab1763',
        name: 'AB 1763',
        description: 'Unlimited density for 100% affordable housing projects near transit.',
        detail: 'AB 1763 (2019) provides unlimited density for 100% affordable housing projects located within half a mile of a major transit stop. Eliminates maximum FAR and unit count restrictions entirely. Parking requirements are set to zero for projects within half a mile of transit. Projects must be 100% affordable with an allowance for manager units. Impact: Enables very high-density affordable development near transit without the typical density caps, making transit-adjacent sites extremely valuable for affordable housing developers.',
        applies: (useId, inp) => ['adjacent','near'].includes(inp.transit) && ['multifamily_low','multifamily_mid','multifamily_high','senior'].includes(useId),
        densityBonus: 1.0,
        parkingReduction: 0,
        softCostReduction: 0,
        legalOverride: true,
    },
    {
        id: 'toc',
        name: 'TOC (LA Local)',
        description: 'Transit Oriented Communities incentives — up to 80% density bonus and parking reductions near transit.',
        detail: 'The Transit Oriented Communities (TOC) program is an LA-specific incentive providing density bonuses of up to 80% and significant parking reductions for housing projects near transit. Projects are tiered by proximity: Tier 1 (within 750 ft of a major stop) through Tier 4 (within 2,640 ft), with each tier providing increasing incentives. Affordable units must be included at specified set-aside levels. Impact: The most impactful local density incentive in Los Angeles, enabling significantly larger buildings near Metro stations.',
        applies: (useId, inp) => ['adjacent','near'].includes(inp.transit) && ['multifamily_low','multifamily_mid','multifamily_high','mixeduse'].includes(useId),
        densityBonus: 0.80,
        parkingReduction: 0.30,
        softCostReduction: 0,
        legalOverride: false,
    },
    {
        id: 'ab2097',
        name: 'AB 2097',
        description: 'Eliminates minimum parking requirements within 1/2 mile of major transit stops.',
        detail: 'AB 2097 (2022) eliminates minimum parking requirements for any development within half a mile of a major transit stop in California. Applies to all land use types — residential, commercial, and mixed-use — not just affordable housing. Local jurisdictions cannot impose minimum parking requirements in these areas. Developers can still choose to build parking, but it is not mandated. Impact: Reduces development costs by $30,000 to $80,000 per eliminated parking space and enables more efficient site utilization near transit.',
        applies: (useId, inp) => ['adjacent','near'].includes(inp.transit),
        densityBonus: 0,
        parkingReduction: 1.0,
        softCostReduction: 0,
        legalOverride: false,
    },
    {
        id: 'adu_reform',
        name: 'ADU Reform (AB 68/SB 13/AB 881)',
        description: 'By-right ADU construction on residential lots; no parking required near transit.',
        detail: 'California\'s ADU reform package (2019-2020) established a comprehensive by-right framework for Accessory Dwelling Units on residential lots. AB 68 allows at least one ADU on any residential lot regardless of local zoning. SB 13 eliminates impact fees for ADUs under 750 SF and caps fees for larger units. AB 881 prohibits local agencies from requiring owner-occupancy or imposing minimum lot sizes. No additional parking is required near transit. Impact: Has generated tens of thousands of new housing units statewide, particularly in single-family neighborhoods.',
        applies: (useId, inp) => ['R1','R2','R3','R4','R5'].includes(inp.zoning) && useId === 'adu',
        densityBonus: 0,
        parkingReduction: 0,
        softCostReduction: 0,
        legalOverride: true,
    },
    {
        id: 'sb478',
        name: 'SB 478',
        description: 'Sets minimum 1.0 FAR for multifamily projects on parcels up to 10,000 SF.',
        detail: 'SB 478 (2021) establishes a minimum floor area ratio (FAR) of 1.0 for multifamily housing projects on parcels of 10,000 SF or less in areas zoned for at least two residential units. Prohibits local jurisdictions from imposing lot coverage limits below 60% on qualifying parcels. Prevents cities from using low FAR limits to effectively block apartment construction on small lots. Applies only to urban infill locations. Impact: Ensures meaningful development potential on small multifamily parcels that might otherwise be restricted by overly conservative FAR limits.',
        applies: (useId, inp) => inp.parcelSize <= 10000 && ['R3','R4','R5','C1.5','C2','C4','TOD'].includes(inp.zoning) && ['multifamily_low','multifamily_mid','multifamily_high'].includes(useId),
        densityBonus: 0,
        parkingReduction: 0,
        softCostReduction: 0,
        legalOverride: false,
        minFAR: 1.0,
    },
    {
        id: 'ed1',
        name: 'ED1 (LA Local)',
        description: 'Executive Directive 1 — streamlined approvals and density bonus for 100% affordable and senior housing.',
        detail: 'Executive Directive 1 (2022) is an LA mayoral order streamlining approvals for 100% affordable and senior housing projects in Los Angeles. Provides expedited processing, priority permitting, and fee waivers for qualifying projects. Includes density bonus provisions beyond state law for affordable projects. Directs all city departments to prioritize affordable housing applications and reduce bureaucratic barriers. Impact: Significantly reduces entitlement timelines for affordable housing, with some projects receiving permits in weeks rather than months.',
        applies: (useId, inp) => ['multifamily_low','multifamily_mid','multifamily_high','senior'].includes(useId),
        densityBonus: 0.35,
        parkingReduction: 0,
        softCostReduction: 0.20,
        legalOverride: false,
    },
    {
        id: 'sb684',
        name: 'SB 684',
        description: 'By-right approval for 10+ unit housing projects on commercially zoned land.',
        detail: 'SB 684 (2023) establishes a by-right (ministerial) approval pathway for housing projects of 10 or more units on commercially zoned land. Projects must meet objective design and development standards. Requires compliance with density, height, and FAR limits as defined by local jurisdictions. Overrides local discretionary review requirements and CEQA for qualifying projects on infill sites. Impact: Provides certainty and speed for developers building housing on commercial sites, reducing entitlement risk and project timelines substantially.',
        applies: (useId, inp) => ['C1','C1.5','C2','C4','C5','CM'].includes(inp.zoning) && ['multifamily_low','multifamily_mid','multifamily_high','mixeduse'].includes(useId),
        densityBonus: 0,
        parkingReduction: 0,
        softCostReduction: 0,
        legalOverride: true,
    },
    {
        id: 'sb79',
        name: 'SB 79 (Transit-Oriented)',
        description: 'Overrides local zoning near qualifying transit stations — up to 95ft, 160 du/acre, 4.5 FAR.',
        detail: 'SB 79 (effective July 1, 2026) is California\'s transit-oriented development bill that overrides local zoning near qualifying heavy and light rail stations. Tier 1 (heavy rail, including all Metro Rail lines) allows 95ft height, 160 du/acre, and 4.5 FAR. Tier 2 (light rail, BRT, qualifying Metrolink) allows 85ft height, 140 du/acre, and 4.0 FAR. Three distance zones apply: Adjacent (within 200ft of station entrance) and Inner (within 1/4 mile) get full tier benefits and zero parking requirements. Outer zone (1/4 to 1/2 mile) is limited to 65ft height and 3.25 FAR, with 0.5 parking spaces per unit. All projects require 15% affordable units. 100% affordable projects receive the full tier benefits regardless of zone. Impact: Unlocks massive upzoning near every Metro station in LA County, making transit-adjacent parcels significantly more valuable for higher-density development.',
        applies: (useId, inp) => {
            if (!window.lastGeocode) return false;
            if (!['multifamily_low','multifamily_mid','multifamily_high','mixeduse','senior','hotel'].includes(useId)) return false;
            const sb79 = detectSB79Eligibility(window.lastGeocode.lat, window.lastGeocode.lon);
            return sb79.eligible;
        },
        get densityBonus() {
            if (!window.lastGeocode) return 0;
            const sb79 = detectSB79Eligibility(window.lastGeocode.lat, window.lastGeocode.lon);
            if (!sb79.eligible) return 0;
            return sb79.allowances.far / 3.0 - 1;
        },
        get parkingReduction() {
            if (!window.lastGeocode) return 0;
            const sb79 = detectSB79Eligibility(window.lastGeocode.lat, window.lastGeocode.lon);
            if (!sb79.eligible) return 0;
            return sb79.allowances.parking === 0 ? 1.0 : 0.5;
        },
        softCostReduction: 0.10,
        legalOverride: true,
        get minFAR() {
            if (!window.lastGeocode) return 0;
            const sb79 = detectSB79Eligibility(window.lastGeocode.lat, window.lastGeocode.lon);
            if (!sb79.eligible) return 0;
            return sb79.allowances.far;
        },
    },
];

function getApplicableLegislation(useId, inp) {
    return CA_HOUSING_LEGISLATION.filter(bill => bill.applies(useId, inp));
}

function stackLegislationEffects(legislationList) {
    let densityBonus = 0;
    let parkingReduction = 0;
    let softCostReduction = 0;
    let legalOverride = false;
    let minFAR = 0;

    for (const bill of legislationList) {
        densityBonus = Math.max(densityBonus, bill.densityBonus || 0);
        parkingReduction = Math.max(parkingReduction, bill.parkingReduction || 0);
        softCostReduction += (bill.softCostReduction || 0);
        if (bill.legalOverride) legalOverride = true;
        minFAR = Math.max(minFAR, bill.minFAR || 0);
    }

    softCostReduction = Math.min(softCostReduction, 0.50);
    return { densityBonus, parkingReduction, softCostReduction, legalOverride, minFAR };
}


// ============================================================
//  BUILDING PROGRAM & BUDGET DATA
// ============================================================

const BUILDING_PARAMS = {
    sfr:              { stories: 2,  floorH: 10, eff: 0.92, unitSF: 1800, parkRatio: 2.0,  setF: 20, setS: 5,  opex: 0.30, cap: 0.045 },
    duplex:           { stories: 2,  floorH: 10, eff: 0.90, unitSF: 1200, parkRatio: 1.5,  setF: 15, setS: 5,  opex: 0.32, cap: 0.047 },
    multifamily_low:  { stories: 4,  floorH: 10, eff: 0.82, unitSF: 850,  parkRatio: 1.25, setF: 10, setS: 5,  opex: 0.35, cap: 0.047 },
    multifamily_mid:  { stories: 7,  floorH: 10, eff: 0.80, unitSF: 800,  parkRatio: 1.0,  setF: 10, setS: 5,  opex: 0.35, cap: 0.045 },
    multifamily_high: { stories: 18, floorH: 10, eff: 0.78, unitSF: 750,  parkRatio: 1.0,  setF: 10, setS: 10, opex: 0.38, cap: 0.042 },
    mixeduse:         { stories: 6,  floorH: 12, eff: 0.80, unitSF: 850,  parkRatio: 1.0,  setF: 0,  setS: 0,  opex: 0.36, cap: 0.048 },
    retail:           { stories: 1,  floorH: 16, eff: 0.88, unitSF: null, parkRatio: 4.0,  setF: 0,  setS: 0,  opex: 0.32, cap: 0.058 },
    office:           { stories: 5,  floorH: 13, eff: 0.85, unitSF: null, parkRatio: 3.0,  setF: 5,  setS: 5,  opex: 0.38, cap: 0.065 },
    medical:          { stories: 4,  floorH: 13, eff: 0.82, unitSF: null, parkRatio: 4.0,  setF: 10, setS: 5,  opex: 0.40, cap: 0.055 },
    hotel:            { stories: 10, floorH: 11, eff: 0.75, unitSF: 400,  parkRatio: 0.5,  setF: 5,  setS: 5,  opex: 0.55, cap: 0.070 },
    industrial:       { stories: 1,  floorH: 24, eff: 0.92, unitSF: null, parkRatio: 1.0,  setF: 10, setS: 5,  opex: 0.28, cap: 0.052 },
    selfstorage:      { stories: 4,  floorH: 9,  eff: 0.88, unitSF: null, parkRatio: 0.2,  setF: 5,  setS: 5,  opex: 0.30, cap: 0.062 },
    senior:           { stories: 5,  floorH: 10, eff: 0.78, unitSF: 600,  parkRatio: 0.5,  setF: 10, setS: 5,  opex: 0.50, cap: 0.058 },
    parking:          { stories: 5,  floorH: 11, eff: 0.90, unitSF: null, parkRatio: null, setF: 0,  setS: 0,  opex: 0.25, cap: 0.065 },
    creative:         { stories: 3,  floorH: 14, eff: 0.85, unitSF: null, parkRatio: 2.5,  setF: 0,  setS: 0,  opex: 0.32, cap: 0.058 },
    adu:              { stories: 2,  floorH: 9,  eff: 0.90, unitSF: 600,  parkRatio: 0,    setF: 5,  setS: 4,  opex: 0.30, cap: 0.048 },
};

const TIMELINE_MONTHS = {
    sfr:              { entitlement: 2,  design: 2,  permits: 2, construction: 10, leaseup: 1 },
    duplex:           { entitlement: 3,  design: 2,  permits: 2, construction: 12, leaseup: 1 },
    multifamily_low:  { entitlement: 6,  design: 4,  permits: 3, construction: 18, leaseup: 6 },
    multifamily_mid:  { entitlement: 8,  design: 5,  permits: 4, construction: 24, leaseup: 8 },
    multifamily_high: { entitlement: 12, design: 8,  permits: 6, construction: 36, leaseup: 10 },
    mixeduse:         { entitlement: 8,  design: 5,  permits: 4, construction: 22, leaseup: 8 },
    retail:           { entitlement: 4,  design: 3,  permits: 2, construction: 10, leaseup: 4 },
    office:           { entitlement: 6,  design: 4,  permits: 3, construction: 18, leaseup: 8 },
    medical:          { entitlement: 6,  design: 5,  permits: 4, construction: 16, leaseup: 6 },
    hotel:            { entitlement: 10, design: 6,  permits: 5, construction: 28, leaseup: 12 },
    industrial:       { entitlement: 4,  design: 3,  permits: 2, construction: 10, leaseup: 3 },
    selfstorage:      { entitlement: 4,  design: 3,  permits: 2, construction: 12, leaseup: 12 },
    senior:           { entitlement: 8,  design: 5,  permits: 4, construction: 22, leaseup: 10 },
    parking:          { entitlement: 4,  design: 3,  permits: 2, construction: 14, leaseup: 2 },
    creative:         { entitlement: 4,  design: 3,  permits: 2, construction: 14, leaseup: 6 },
    adu:              { entitlement: 1,  design: 1,  permits: 2, construction: 8,  leaseup: 1 },
};

const USE_COLORS = {
    sfr: '#4a9e5c', duplex: '#5ba86e', multifamily_low: '#3182ce', multifamily_mid: '#2b6cb0',
    multifamily_high: '#1a4791', mixeduse: '#805ad5', retail: '#dd6b20', office: '#2c5282',
    medical: '#38a169', hotel: '#b83280', industrial: '#718096', selfstorage: '#a0aec0',
    senior: '#d69e2e', parking: '#4a5568', creative: '#ed8936', adu: '#48bb78',
};


// ============================================================
//  SCORING FUNCTIONS
// ============================================================

function getInputs() {
    return {
        parcelSize:    parseFloat(document.getElementById('parcelSize').value) || 10000,
        frontage:      parseFloat(document.getElementById('frontage').value) || 80,
        zoning:        document.getElementById('zoning').value,
        neighborhood:  document.getElementById('neighborhood').value,
        siteCondition: document.getElementById('siteCondition').value,
        topography:    document.getElementById('topography').value,
        cornerLot:     document.getElementById('cornerLot').value === 'yes',
        transit:       document.getElementById('transit').value,
        arterial:      document.getElementById('arterial').value,
        utilities:     document.getElementById('utilities').value,
        constFlood:    document.getElementById('constFlood').checked,
        constHillside: document.getElementById('constHillside').checked,
        constHistoric: document.getElementById('constHistoric').checked,
        constFault:    document.getElementById('constFault').checked,
        constCoastal:  document.getElementById('constCoastal').checked,
        constParking:  document.getElementById('constParking').checked,
    };
}

function scoreLegal(useId, inp, effects) {
    const zoneRow = ZONING_MATRIX[inp.zoning];
    if (!zoneRow) return 0;
    let base = zoneRow[useId] || 0;

    // CA Housing Legislation: by-right override
    if (effects && effects.legalOverride) {
        base = 1.0;
    }

    // Historic overlay reduces redevelopment permission
    if (inp.constHistoric && ['multifamily_high', 'hotel', 'industrial'].includes(useId)) {
        base *= 0.5;
    }
    // Coastal zone limits industrial, dense residential
    if (inp.constCoastal && ['industrial', 'multifamily_high', 'selfstorage'].includes(useId)) {
        base *= 0.4;
    }
    // Hillside ordinance restricts density
    if (inp.constHillside && ['multifamily_mid', 'multifamily_high', 'hotel', 'industrial'].includes(useId)) {
        base *= 0.3;
    }
    return Math.min(base, 1.0);
}

function scorePhysical(useId, inp) {
    let score = 1.0;

    // Parcel size check
    const minSqFt = MIN_PARCEL[useId] || 2000;
    if (inp.parcelSize < minSqFt) {
        score *= Math.max(0.1, inp.parcelSize / minSqFt);
    } else if (inp.parcelSize > minSqFt * 3) {
        score *= 1.0; // plenty of room
    }

    // Frontage adequacy
    const needsFrontage = ['retail', 'mixeduse', 'hotel', 'office', 'medical'];
    if (needsFrontage.includes(useId) && inp.frontage < 50) {
        score *= 0.6;
    }

    // Topography
    const topoPenalty = { flat: 1.0, gentle: 0.9, moderate: 0.65, steep: 0.3 };
    const baseTopo = topoPenalty[inp.topography] || 1.0;
    // Some uses are more topo-tolerant
    if (['parking', 'selfstorage'].includes(useId)) {
        score *= Math.max(baseTopo, 0.7);
    } else if (['industrial', 'multifamily_high', 'hotel'].includes(useId)) {
        score *= baseTopo * 0.9; // extra sensitive
    } else {
        score *= baseTopo;
    }

    // Utilities
    if (inp.utilities === 'partial') score *= 0.85;
    if (inp.utilities === 'none') score *= 0.5;

    // Site condition
    if (inp.siteCondition === 'demolition') score *= 0.85;
    if (inp.siteCondition === 'brownfield') score *= 0.6;

    // Flood zone
    if (inp.constFlood) score *= 0.7;

    // Fault zone — penalizes tall structures
    if (inp.constFault && ['multifamily_high', 'hotel', 'office'].includes(useId)) {
        score *= 0.7;
    }

    return Math.min(score, 1.0);
}

function scoreFinancial(useId, inp, effects) {
    // Compute effective FAR with legislation bonuses
    const baseFAR = FAR_TYPICAL[useId] || 1.0;
    let far = baseFAR;
    if (effects) {
        far = baseFAR * (1 + effects.densityBonus);
        if (effects.minFAR > 0) far = Math.max(far, effects.minFAR);
    }

    const params = BUILDING_PARAMS[useId];
    const buildableSF = inp.parcelSize * far;
    const nsf = buildableSF * (params ? params.eff : 0.82);
    const landValuePSF = LAND_VALUE_PSF[inp.neighborhood] || 150;
    const landCost = inp.parcelSize * landValuePSF;

    // Build cost with parking reduction from legislation
    let buildCostPerSF = BUILD_COST_PSF[useId] || 300;
    if (effects && effects.parkingReduction > 0) {
        buildCostPerSF *= (1 - effects.parkingReduction * 0.18);
    }
    const buildCost = buildableSF * buildCostPerSF;

    // Parking cost (use-specific)
    const parkCostPerSpace = PARKING_COST_MAP[useId] || 35000;
    const baseParkRatio = params ? (params.parkRatio || 0) : 0;
    const parkReduction = effects ? effects.parkingReduction : 0;
    const hasUnits = params && params.unitSF;
    let parkSpaces = 0;
    if (useId === 'parking') parkSpaces = Math.round(buildableSF / 350);
    else if (hasUnits) parkSpaces = Math.max(0, Math.ceil(Math.floor(nsf / params.unitSF) * baseParkRatio * (1 - parkReduction)));
    else parkSpaces = Math.max(0, Math.ceil(buildableSF / 1000 * baseParkRatio * (1 - parkReduction)));
    const parkingCost = parkSpaces * parkCostPerSpace;

    // Total cost including overhead (parking, contingency, soft costs)
    const hardCostBase = buildCost + parkingCost + inp.parcelSize * 18;
    const totalHard = hardCostBase * 1.11; // ~4% landscaping + 7% contingency
    const totalSoft = totalHard * 0.235; // ~23.5% (A&E 8%, permits 5%, legal 2%, financing 4.5%, dev fee 4%)
    let totalCost = landCost + totalHard + totalSoft;
    if (effects && effects.softCostReduction > 0) {
        totalCost -= totalSoft * effects.softCostReduction * 0.20;
    }

    // Annual NOI with neighborhood rent adjustment
    const rentMult = NEIGHBORHOOD_RENT_MULT[inp.neighborhood] || 1.0;
    const opexRate = params ? params.opex : 0.35;
    const annualNOI = nsf * (REVENUE_PSF[useId] || 30) * rentMult * (1 - opexRate);

    // Yield-on-cost and development margin
    const yieldOnCost = annualNOI / totalCost;
    const capRate = params ? params.cap : 0.05;
    const devMargin = capRate > 0 ? (yieldOnCost / capRate - 1) : 0;

    // Score based on dev margin — directly ties to project profitability
    let score;
    if (devMargin >= 0.25) score = 1.0;
    else if (devMargin >= 0.15) score = 0.75 + (devMargin - 0.15) / 0.10 * 0.25;
    else if (devMargin >= 0.05) score = 0.45 + (devMargin - 0.05) / 0.10 * 0.30;
    else if (devMargin >= 0) score = 0.20 + (devMargin / 0.05) * 0.25;
    else if (devMargin >= -0.15) score = Math.max(0.02, 0.20 + devMargin * 1.2);
    else score = 0.02;

    // Neighborhood demand multiplier
    const demandRow = NEIGHBORHOOD_DEMAND[inp.neighborhood];
    const demand = demandRow ? (demandRow[useId] || 0.7) : 0.7;
    score *= demand;

    // Corner lot bonus for visibility-dependent uses
    if (inp.cornerLot && ['retail', 'mixeduse', 'hotel', 'office', 'medical'].includes(useId)) {
        score *= 1.15;
    }

    // Transit proximity bonus
    const transitBonus = { adjacent: 1.2, near: 1.1, moderate: 1.0, far: 0.85 };
    if (['multifamily_mid', 'multifamily_high', 'mixeduse', 'office', 'hotel'].includes(useId)) {
        score *= (transitBonus[inp.transit] || 1.0);
    }

    // Arterial bonus
    if (inp.arterial === 'major' && ['retail', 'mixeduse', 'hotel', 'office'].includes(useId)) {
        score *= 1.1;
    }
    if (inp.arterial === 'residential' && ['retail', 'hotel', 'industrial'].includes(useId)) {
        score *= 0.7;
    }

    // Site condition cost adjustments
    if (inp.siteCondition === 'demolition') score *= 0.9;
    if (inp.siteCondition === 'brownfield') score *= 0.7;

    // Parking constraints
    if (inp.constParking && ['retail', 'office', 'medical', 'hotel'].includes(useId)) {
        score *= 0.8;
    }

    return Math.min(score, 1.0);
}

function scoreProductive(useId, inp, effects) {
    // Compute effective FAR with legislation bonuses
    const baseFAR = FAR_TYPICAL[useId] || 1.0;
    let far = baseFAR;
    if (effects) {
        far = baseFAR * (1 + effects.densityBonus);
        if (effects.minFAR > 0) far = Math.max(far, effects.minFAR);
    }

    const buildableSF = inp.parcelSize * far;
    const revenuePSF = REVENUE_PSF[useId] || 30;
    const rentMult = NEIGHBORHOOD_RENT_MULT[inp.neighborhood] || 1.0;
    const totalAnnualRev = buildableSF * revenuePSF * rentMult;
    const landValuePSF = LAND_VALUE_PSF[inp.neighborhood] || 150;

    // Revenue-to-land-value ratio (higher = more productive per dollar of land)
    const revToLand = totalAnnualRev / (inp.parcelSize * landValuePSF);

    // Normalize
    let score;
    if (revToLand >= 0.20) score = 1.0;
    else if (revToLand >= 0.10) score = 0.5 + (revToLand - 0.10) / 0.10 * 0.5;
    else score = revToLand / 0.10 * 0.5;

    // Demand multiplier
    const demandRow = NEIGHBORHOOD_DEMAND[inp.neighborhood];
    const demand = demandRow ? (demandRow[useId] || 0.7) : 0.7;
    score *= demand;

    return Math.min(score, 1.0);
}


// ============================================================
//  MAIN CALCULATION
// ============================================================

let lastResults = null;
let lastInputs = null;

function calculateHBU() {
    const inp = getInputs();

    // Score all uses
    const results = LAND_USES.map(use => {
        const legislation = getApplicableLegislation(use.id, inp);
        const effects = stackLegislationEffects(legislation);

        const legal      = scoreLegal(use.id, inp, effects);
        const physical   = scorePhysical(use.id, inp);
        const financial  = scoreFinancial(use.id, inp, effects);
        const productive = scoreProductive(use.id, inp, effects);

        // Compute actual dev margin for feasibility check
        const budget = generateBudget(use.id, inp, effects);
        const devMarginPct = budget.devMargin;

        // HBU must pass ALL four tests. Weight: Legal gateway, then others.
        // If legal = 0, overall = 0
        let overall;
        if (legal === 0) {
            overall = 0;
        } else {
            overall = legal * 0.25 + physical * 0.20 + financial * 0.30 + productive * 0.25;
            // Penalize further if legal is only conditional
            if (legal <= 0.5) overall *= 0.8;
            // Feasibility gate — penalize uses that lose money
            if (devMarginPct < -0.15) overall *= 0.50;
            else if (devMarginPct < -0.05) overall *= 0.65;
            else if (devMarginPct < 0) overall *= 0.80;
        }

        return {
            ...use,
            legal: Math.round(legal * 100),
            physical: Math.round(physical * 100),
            financial: Math.round(financial * 100),
            productive: Math.round(productive * 100),
            overall: Math.round(overall * 100),
            devMarginPct,
            legislation,
        };
    });

    // Sort by overall descending
    results.sort((a, b) => b.overall - a.overall);

    // Store for modal access
    lastResults = results;
    lastInputs = inp;

    // Render
    renderResults(results, inp);

    // SB 79 Map — show if we have geocoded coordinates
    if (window.lastGeocode && typeof L !== 'undefined') {
        const { lat, lon } = window.lastGeocode;
        const sb79 = detectSB79Eligibility(lat, lon);
        document.getElementById('mapSection').style.display = 'block';
        initSB79Map(lat, lon);
        renderSB79Eligibility(sb79);
    }
}


// ============================================================
//  RENDER
// ============================================================

function renderResults(results, inp) {
    const container = document.getElementById('results');
    container.classList.add('visible');

    // Summary
    document.getElementById('resultsSummary').textContent =
        `Analysis for a ${inp.parcelSize.toLocaleString()} SF parcel, zoned ${inp.zoning}, in ${document.getElementById('neighborhood').selectedOptions[0].text}.`;

    // Feasibility warning banner
    const topMargin = results[0] ? results[0].devMarginPct : 0;
    const anyFeasible = results.slice(0, 3).some(r => r.devMarginPct >= 0);
    let warningHTML = '';
    if (!anyFeasible) {
        warningHTML = `<div style="background:#fff5f5;border:1px solid #fc8181;border-radius:10px;padding:1rem 1.25rem;margin-bottom:1.25rem;font-size:0.88rem;color:#c53030;">
            <strong>No Feasible Development Identified</strong> — Based on current market rents, construction costs, and land values, none of the evaluated uses produce a positive development margin at this site. Consider: (1) acquiring the land below market, (2) a condo/for-sale exit strategy, (3) value-add renovation of the existing structure, or (4) holding the property.
        </div>`;
    } else if (topMargin < 0.10) {
        warningHTML = `<div style="background:#fffff0;border:1px solid #ecc94b;border-radius:10px;padding:0.85rem 1.15rem;margin-bottom:1.25rem;font-size:0.85rem;color:#b7791f;">
            <strong>Marginal Feasibility</strong> — The top-ranked use shows a ${(topMargin * 100).toFixed(0)}% development margin. Most developers target 15-25%. Profitability depends on favorable execution, cost control, and rent achievement.
        </div>`;
    }

    // Top 3 cards
    const cardsDiv = document.getElementById('resultCards');
    cardsDiv.innerHTML = warningHTML;

    const rankLabels = ['1st — Best Use', '2nd — Alternative', '3rd — Alternative'];
    const rankClasses = ['rank-1', 'rank-2', 'rank-3'];

    for (let i = 0; i < 3; i++) {
        const r = results[i];
        const effects = stackLegislationEffects(r.legislation || []);
        const metricsHTML = generateCardMetricsHTML(r.id, inp, effects, r);
        const legBadges = r.legislation && r.legislation.length > 0
            ? `<div class="legislation-badges">
                   <div class="leg-label">Applicable Legislation</div>
                   ${r.legislation.map(b => `<span class="legislation-badge clickable" onclick="event.stopPropagation();showLegislationDetail('${b.id}')">${b.name}</span>`).join('')}
               </div>`
            : '';

        // Feasibility badge
        let feasBadge = '';
        if (r.devMarginPct >= 0.15) feasBadge = '<span style="display:inline-block;font-size:0.7rem;font-weight:700;padding:0.15rem 0.5rem;border-radius:999px;background:#f0fff4;color:#276749;margin-left:0.5rem;">FEASIBLE</span>';
        else if (r.devMarginPct >= 0) feasBadge = '<span style="display:inline-block;font-size:0.7rem;font-weight:700;padding:0.15rem 0.5rem;border-radius:999px;background:#fffff0;color:#b7791f;margin-left:0.5rem;">MARGINAL</span>';
        else feasBadge = '<span style="display:inline-block;font-size:0.7rem;font-weight:700;padding:0.15rem 0.5rem;border-radius:999px;background:#fff5f5;color:#c53030;margin-left:0.5rem;">NOT FEASIBLE</span>';

        const card = document.createElement('div');
        card.className = `result-card ${rankClasses[i]}`;
        card.style.cursor = 'pointer';
        card.onclick = ((idx) => () => openAnalysis(idx))(i);
        card.innerHTML = `
            <div class="rank-banner">
                <span class="rank-num">#${i + 1}</span>
                ${rankLabels[i]}${feasBadge}
            </div>
            <div class="card-body">
                <div class="use-name">${r.icon} ${r.name}</div>

                <div class="score-bar-container">
                    <div class="score-label"><span>Legally Permissible</span><span>${r.legal}%</span></div>
                    <div class="score-bar"><div class="score-bar-fill legal" style="width: ${r.legal}%"></div></div>
                </div>
                <div class="score-bar-container">
                    <div class="score-label"><span>Physically Possible</span><span>${r.physical}%</span></div>
                    <div class="score-bar"><div class="score-bar-fill physical" style="width: ${r.physical}%"></div></div>
                </div>
                <div class="score-bar-container">
                    <div class="score-label"><span>Financially Feasible</span><span>${r.financial}%</span></div>
                    <div class="score-bar"><div class="score-bar-fill financial" style="width: ${r.financial}%"></div></div>
                </div>
                <div class="score-bar-container">
                    <div class="score-label"><span>Maximally Productive</span><span>${r.productive}%</span></div>
                    <div class="score-bar"><div class="score-bar-fill productive" style="width: ${r.productive}%"></div></div>
                </div>

                <div class="overall-score">
                    <div class="big-score">${r.overall}</div>
                    <span>/ 100<br>Overall Score</span>
                </div>

                ${metricsHTML}

                <div class="rationale">${RATIONALE[r.id] || ''}</div>
                ${legBadges}
                <div class="click-hint">Click for detailed analysis</div>
            </div>
        `;
        cardsDiv.appendChild(card);
    }

    // Legislation section — collect unique bills from top 3
    const legSection = document.getElementById('legislationSection');
    const allLegislation = new Map();
    for (let i = 0; i < 3 && i < results.length; i++) {
        if (results[i].legislation) {
            for (const bill of results[i].legislation) {
                if (!allLegislation.has(bill.id)) {
                    allLegislation.set(bill.id, bill);
                }
            }
        }
    }

    if (allLegislation.size > 0) {
        legSection.style.display = 'block';
        let legHTML = '<h3>Applicable California Housing Legislation</h3>';
        legHTML += '<div class="legislation-cards">';
        for (const bill of allLegislation.values()) {
            legHTML += `<div class="legislation-card clickable" onclick="showLegislationDetail('${bill.id}')"><strong>${bill.name}</strong><p>${bill.description}</p></div>`;
        }
        legHTML += '</div>';
        legSection.innerHTML = legHTML;
    } else {
        legSection.style.display = 'none';
        legSection.innerHTML = '';
    }

    // Full table — split into permissible vs excluded
    const tbody = document.getElementById('detailsBody');
    const excludedBody = document.getElementById('excludedBody');
    tbody.innerHTML = '';
    excludedBody.innerHTML = '';

    const formatCell = (val) => {
        if (val >= 70) return `<span class="pass">${val}%</span>`;
        if (val >= 40) return `<span class="partial">${val}%</span>`;
        if (val > 0)   return `<span class="fail">${val}%</span>`;
        return `<span class="fail">N/A</span>`;
    };

    let permissibleRank = 0;
    let excludedCount = 0;
    const zoningLabel = document.getElementById('zoning').selectedOptions[0].text;

    results.forEach((r) => {
        if (r.legal > 0) {
            permissibleRank++;
            const tr = document.createElement('tr');
            if (permissibleRank <= 3) tr.className = 'top-3';
            tr.innerHTML = `
                <td>${permissibleRank}</td>
                <td>${r.icon} ${r.name}</td>
                <td>${formatCell(r.legal)}</td>
                <td>${formatCell(r.physical)}</td>
                <td>${formatCell(r.financial)}</td>
                <td>${formatCell(r.productive)}</td>
                <td><strong>${r.overall}%</strong></td>
            `;
            tbody.appendChild(tr);
        } else {
            excludedCount++;
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${r.icon} ${r.name}</td>
                <td>${formatCell(r.physical)}</td>
                <td>${formatCell(r.financial)}</td>
                <td>${formatCell(r.productive)}</td>
                <td><span class="fail">Not permitted under ${zoningLabel} zoning</span></td>
            `;
            excludedBody.appendChild(tr);
        }
    });

    const excludedSection = document.getElementById('excludedSection');
    if (excludedCount > 0) {
        excludedSection.style.display = 'block';
        document.getElementById('excludedCount').textContent = excludedCount;
        // Reset toggle state
        document.getElementById('excludedTable').style.display = 'none';
        document.getElementById('toggleExcluded').innerHTML =
            `▶ Show <span id="excludedCount">${excludedCount}</span> uses not legally permissible under current zoning`;
    } else {
        excludedSection.style.display = 'none';
    }

    // Show print button
    document.getElementById('btnPrint').classList.add('visible');

    // Scroll to results
    container.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function exportPDF() {
    // Set the print date
    const now = new Date();
    const dateStr = now.toLocaleDateString('en-US', {
        year: 'numeric', month: 'long', day: 'numeric',
        hour: '2-digit', minute: '2-digit'
    });
    document.getElementById('printDate').textContent = `Report generated: ${dateStr}  |  CLS CRE Brokerage — HBU Analysis`;

    // Trigger browser print dialog (user can select "Save as PDF")
    window.print();
}

function toggleExcludedUses() {
    const table = document.getElementById('excludedTable');
    const btn = document.getElementById('toggleExcluded');
    const count = document.getElementById('excludedCount')?.textContent || '0';
    if (table.style.display === 'none') {
        table.style.display = 'block';
        btn.innerHTML = `▼ Hide <span id="excludedCount">${count}</span> uses not legally permissible under current zoning`;
    } else {
        table.style.display = 'none';
        btn.innerHTML = `▶ Show <span id="excludedCount">${count}</span> uses not legally permissible under current zoning`;
    }
}


// ============================================================
//  DETAILED ANALYSIS MODAL
// ============================================================

function fmt(n) {
    return '$' + Math.round(n).toLocaleString();
}

function adjustColor(hex, amount) {
    let r = parseInt(hex.slice(1, 3), 16);
    let g = parseInt(hex.slice(3, 5), 16);
    let b = parseInt(hex.slice(5, 7), 16);
    r = Math.max(0, Math.min(255, r + amount));
    g = Math.max(0, Math.min(255, g + amount));
    b = Math.max(0, Math.min(255, b + amount));
    return '#' + [r, g, b].map(c => c.toString(16).padStart(2, '0')).join('');
}

function generateBudget(useId, inp, effects) {
    const params = BUILDING_PARAMS[useId];
    const baseFAR = FAR_TYPICAL[useId] || 1.0;
    let far = baseFAR;
    if (effects) {
        far = baseFAR * (1 + effects.densityBonus);
        if (effects.minFAR > 0) far = Math.max(far, effects.minFAR);
    }

    const gsf = Math.round(inp.parcelSize * far);
    const nsf = Math.round(gsf * params.eff);
    const stories = Math.max(params.stories, Math.ceil(gsf / (inp.parcelSize * 0.7)));
    const buildingHeight = stories * params.floorH;
    const buildingFootprint = Math.min(Math.round(inp.parcelSize * 0.7), Math.round(gsf / stories));
    const units = params.unitSF ? Math.max(1, Math.floor(nsf / params.unitSF)) : null;

    // Parking (use-specific cost per space)
    const baseParkRatio = params.parkRatio || 0;
    const parkReduction = effects ? effects.parkingReduction : 0;
    let parkingSpaces;
    if (useId === 'parking') {
        parkingSpaces = Math.round(gsf / 350);
    } else if (units) {
        parkingSpaces = Math.max(0, Math.ceil(units * baseParkRatio * (1 - parkReduction)));
    } else {
        parkingSpaces = Math.max(0, Math.ceil(gsf / 1000 * baseParkRatio * (1 - parkReduction)));
    }
    const parkingCostPerSpace = PARKING_COST_MAP[useId] || 35000;

    const landValuePSF = LAND_VALUE_PSF[inp.neighborhood] || 150;
    const landCost = inp.parcelSize * landValuePSF;

    // Hard costs
    const siteWork = inp.parcelSize * 18;
    const demolition = (inp.siteCondition === 'demolition') ? inp.parcelSize * 12 : 0;
    let buildCostPSF = BUILD_COST_PSF[useId] || 300;
    if (effects && effects.parkingReduction > 0) {
        buildCostPSF *= (1 - effects.parkingReduction * 0.18);
    }
    const construction = gsf * buildCostPSF;
    const parkingCost = parkingSpaces * parkingCostPerSpace;
    const landscaping = Math.round(construction * 0.04);
    const hardContingency = Math.round((siteWork + demolition + construction + parkingCost + landscaping) * 0.07);
    const totalHard = siteWork + demolition + construction + parkingCost + landscaping + hardContingency;

    // Soft costs
    const archEng = Math.round(totalHard * 0.08);
    const permits = Math.round(totalHard * 0.05);
    const legal = Math.round(totalHard * 0.02);
    const financing = Math.round((landCost + totalHard) * 0.045);
    const rentMult = NEIGHBORHOOD_RENT_MULT[inp.neighborhood] || 1.0;
    const revenuePSF = (REVENUE_PSF[useId] || 30) * rentMult;
    const marketing = Math.round(nsf * revenuePSF * 0.02);
    const devFee = Math.round((totalHard + archEng + permits) * 0.04);
    const softCostMult = effects && effects.softCostReduction > 0 ? (1 - effects.softCostReduction * 0.20) : 1;
    const totalSoft = Math.round((archEng + permits + legal + financing + marketing + devFee) * softCostMult);

    const totalDev = landCost + totalHard + totalSoft;

    // Revenue & returns (neighborhood-adjusted)
    const grossRevenue = nsf * revenuePSF;
    const opex = Math.round(grossRevenue * params.opex);
    const noi = grossRevenue - opex;
    const capRate = params.cap;
    const stabilizedValue = Math.round(noi / capRate);
    const yieldOnCost = noi / totalDev;
    const devMargin = (stabilizedValue - totalDev) / totalDev;

    return {
        gsf, nsf, revenueNSF: nsf, stories, buildingHeight, buildingFootprint, units, parkingSpaces, far,
        landCost, landValuePSF, siteWork, demolition, construction, buildCostPSF, parkingCost, parkingCostPerSpace, landscaping, hardContingency, totalHard,
        archEng, permits, legal, financing, marketing, devFee, totalSoft,
        totalDev,
        grossRevenue, opex, noi, capRate, stabilizedValue, yieldOnCost, devMargin,
        params, revenuePSF,
    };
}

// --- SVG Rendering ---

function generateSitePlanSVG(useId, inp, budget) {
    const w = 320, h = 270;
    const params = budget.params;
    const color = USE_COLORS[useId] || '#3182ce';

    const lotW = inp.frontage || Math.sqrt(inp.parcelSize * 2);
    const lotD = inp.parcelSize / lotW;
    const maxDim = Math.max(lotW, lotD);
    const scale = 170 / maxDim;
    const lw = lotW * scale, ld = lotD * scale;
    const ox = (w - lw) / 2, oy = 25;

    const sf = params.setF * scale, ss = params.setS * scale;
    const bw = Math.max(20, lw - 2 * ss);
    const bd = Math.max(20, ld - sf - ss);
    const bx = ox + ss, by = oy + ss;

    let s = `<svg viewBox="0 0 ${w} ${h}" xmlns="http://www.w3.org/2000/svg" style="background:#fafbfc;">`;
    s += `<defs><pattern id="ht" width="6" height="6" patternUnits="userSpaceOnUse"><path d="M0,6 L6,0" stroke="#ccc" stroke-width="0.5"/></pattern></defs>`;
    // Lot
    s += `<rect x="${ox}" y="${oy}" width="${lw}" height="${ld}" fill="#e8f5e9" stroke="#66bb6a" stroke-width="1.5" rx="2"/>`;
    // Setback hatching (front)
    if (sf > 2) s += `<rect x="${ox}" y="${oy + ld - sf}" width="${lw}" height="${sf}" fill="url(#ht)" opacity="0.5"/>`;
    // Building footprint
    s += `<rect x="${bx}" y="${by}" width="${bw}" height="${bd}" fill="${color}" opacity="0.75" stroke="${color}" stroke-width="1.5" rx="2"/>`;
    s += `<text x="${bx + bw/2}" y="${by + bd/2 - 5}" text-anchor="middle" font-size="10" fill="white" font-weight="600">BUILDING</text>`;
    s += `<text x="${bx + bw/2}" y="${by + bd/2 + 9}" text-anchor="middle" font-size="8" fill="rgba(255,255,255,0.85)">${budget.buildingFootprint.toLocaleString()} SF footprint</text>`;
    // Dimensions
    s += `<text x="${ox + lw/2}" y="${oy - 6}" text-anchor="middle" font-size="9" fill="#666">${Math.round(lotW)}' frontage</text>`;
    // Depth label (right side, rotated)
    s += `<text x="${ox + lw + 14}" y="${oy + ld/2}" text-anchor="middle" font-size="9" fill="#666" transform="rotate(90,${ox + lw + 14},${oy + ld/2})">${Math.round(lotD)}' depth</text>`;
    // Street
    s += `<rect x="${ox - 15}" y="${oy + ld + 8}" width="${lw + 30}" height="${22}" fill="#e2e8f0" rx="3"/>`;
    s += `<text x="${ox + lw/2}" y="${oy + ld + 23}" text-anchor="middle" font-size="9" fill="#718096" font-weight="600">STREET</text>`;
    // North arrow
    s += `<text x="${w - 22}" y="${oy + 12}" text-anchor="middle" font-size="14" fill="#999">&#8593;</text>`;
    s += `<text x="${w - 22}" y="${oy + 24}" text-anchor="middle" font-size="8" fill="#999" font-weight="600">N</text>`;
    // Title
    s += `<text x="${w/2}" y="${h - 6}" text-anchor="middle" font-size="10" fill="#999" font-weight="600">SITE PLAN</text>`;
    s += '</svg>';
    return s;
}

function generateElevationSVG(useId, inp, budget) {
    const w = 320, h = 270;
    const params = budget.params;
    const color = USE_COLORS[useId] || '#3182ce';
    const stories = budget.stories;
    const totalH = budget.buildingHeight;

    const maxSVGH = 190;
    const hScale = Math.min(maxSVGH / totalH, 3.0);
    const buildH = totalH * hScale;
    const buildW = 180;
    const ox = (w - buildW) / 2;
    const groundY = h - 45;
    const roofY = groundY - buildH;

    let s = `<svg viewBox="0 0 ${w} ${h}" xmlns="http://www.w3.org/2000/svg" style="background:#fafbfc;">`;
    // Sky
    s += `<defs><linearGradient id="sky" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#dbeafe"/><stop offset="100%" stop-color="#f0f9ff"/></linearGradient></defs>`;
    s += `<rect x="0" y="0" width="${w}" height="${groundY}" fill="url(#sky)"/>`;
    // Ground
    s += `<rect x="0" y="${groundY}" width="${w}" height="${h - groundY}" fill="#d4edda"/>`;
    s += `<line x1="0" y1="${groundY}" x2="${w}" y2="${groundY}" stroke="#888" stroke-width="1.5"/>`;
    // Building
    s += `<rect x="${ox}" y="${roofY}" width="${buildW}" height="${buildH}" fill="${color}" stroke="${adjustColor(color, -30)}" stroke-width="1.5" rx="2"/>`;
    // Floor lines
    const storyH = buildH / stories;
    for (let i = 1; i < stories; i++) {
        const y = groundY - i * storyH;
        s += `<line x1="${ox}" y1="${y}" x2="${ox + buildW}" y2="${y}" stroke="rgba(255,255,255,0.2)" stroke-width="0.5"/>`;
    }
    // Windows
    const cols = Math.min(7, Math.max(3, Math.floor(buildW / 25)));
    const winW = 12, winH = storyH * 0.45;
    const winSpacing = buildW / (cols + 1);
    for (let fl = 0; fl < stories; fl++) {
        const fy = groundY - (fl + 1) * storyH + (storyH - winH) / 2 + winH * 0.1;
        for (let c = 0; c < cols; c++) {
            const wx = ox + winSpacing * (c + 1) - winW / 2;
            s += `<rect x="${wx}" y="${fy}" width="${winW}" height="${winH}" fill="rgba(255,255,255,0.35)" rx="1"/>`;
        }
    }
    // Ground floor entrance
    if (['retail', 'mixeduse', 'hotel', 'office', 'medical', 'creative'].includes(useId)) {
        const doorW = buildW * 0.12, doorH = storyH * 0.65;
        s += `<rect x="${ox + buildW/2 - doorW/2}" y="${groundY - doorH}" width="${doorW}" height="${doorH}" fill="rgba(255,255,255,0.5)" rx="2"/>`;
    }
    // Roof line
    s += `<line x1="${ox - 4}" y1="${roofY}" x2="${ox + buildW + 4}" y2="${roofY}" stroke="${adjustColor(color, -40)}" stroke-width="2.5"/>`;
    // Height dimension
    const dx = ox + buildW + 18;
    s += `<line x1="${dx}" y1="${groundY}" x2="${dx}" y2="${roofY}" stroke="#999" stroke-width="0.75" stroke-dasharray="3,2"/>`;
    s += `<line x1="${dx - 4}" y1="${groundY}" x2="${dx + 4}" y2="${groundY}" stroke="#999" stroke-width="1"/>`;
    s += `<line x1="${dx - 4}" y1="${roofY}" x2="${dx + 4}" y2="${roofY}" stroke="#999" stroke-width="1"/>`;
    s += `<text x="${dx + 8}" y="${(groundY + roofY) / 2}" font-size="9" fill="#666" font-weight="600">${totalH} ft</text>`;
    s += `<text x="${dx + 8}" y="${(groundY + roofY) / 2 + 13}" font-size="8" fill="#999">${stories} stories</text>`;
    // Width
    s += `<text x="${ox + buildW/2}" y="${groundY + 16}" text-anchor="middle" font-size="9" fill="#666">${Math.round(inp.frontage || Math.sqrt(inp.parcelSize * 2))}' frontage</text>`;
    // Title
    s += `<text x="${w/2}" y="${h - 6}" text-anchor="middle" font-size="10" fill="#999" font-weight="600">BUILDING ELEVATION</text>`;
    s += '</svg>';
    return s;
}

// ============================================================
//  KEY METRICS HELPERS (for result cards)
// ============================================================

function formatCompactDollars(n) {
    if (n >= 1e9) return '$' + (n / 1e9).toFixed(1) + 'B';
    if (n >= 1e6) return '$' + (n / 1e6).toFixed(1) + 'M';
    if (n >= 1e3) return '$' + (n / 1e3).toFixed(0) + 'K';
    return '$' + Math.round(n).toLocaleString();
}

function approxIRR(devMargin, totalMonths) {
    if (totalMonths <= 0 || devMargin <= -1) return 0;
    return Math.pow(1 + devMargin, 12 / totalMonths) - 1;
}

function computeEaseOfExecution(useId, inp, effects, legalScore) {
    let ease = 50; // base score

    // Entitlement timeline — shorter is easier
    const tl = TIMELINE_MONTHS[useId] || { entitlement: 6, design: 4, permits: 3, construction: 18, leaseup: 6 };
    const totalMo = tl.entitlement + tl.design + tl.permits + tl.construction + tl.leaseup;
    if (totalMo <= 20) ease += 20;
    else if (totalMo <= 35) ease += 10;
    else if (totalMo >= 55) ease -= 15;
    else if (totalMo >= 45) ease -= 8;

    // Legal permissibility bonus
    if (legalScore >= 80) ease += 12;
    else if (legalScore >= 60) ease += 6;
    else if (legalScore < 30) ease -= 15;

    // Legislation streamlining bonuses
    if (effects && effects.legalOverride) ease += 8;
    if (effects && effects.softCostReduction > 0) ease += Math.round(effects.softCostReduction * 10);
    if (effects && effects.parkingReduction > 0) ease += 5;

    // Site constraints penalties
    if (inp.constHistoric) ease -= 10;
    if (inp.constHillside) ease -= 8;
    if (inp.constCoastal) ease -= 8;
    if (inp.constFault) ease -= 5;
    if (inp.constFlood) ease -= 5;
    if (inp.siteCondition === 'brownfield') ease -= 10;
    if (inp.topography === 'steep') ease -= 7;
    if (inp.utilities === 'none') ease -= 10;
    else if (inp.utilities === 'partial') ease -= 5;

    // Construction complexity — high-rise / hotel harder
    const params = BUILDING_PARAMS[useId];
    if (params && params.stories >= 10) ease -= 10;
    else if (params && params.stories >= 6) ease -= 5;

    return Math.max(0, Math.min(100, ease));
}

function computeRiskLevel(useId, inp, legalScore, physicalScore) {
    let riskPts = 0;

    // Site constraint risks
    if (inp.constFlood) riskPts += 12;
    if (inp.constHillside) riskPts += 10;
    if (inp.constHistoric) riskPts += 10;
    if (inp.constFault) riskPts += 12;
    if (inp.constCoastal) riskPts += 8;
    if (inp.siteCondition === 'brownfield') riskPts += 14;
    if (inp.topography === 'steep') riskPts += 8;
    if (inp.utilities === 'none') riskPts += 10;
    else if (inp.utilities === 'partial') riskPts += 5;

    // Score-based risk
    if (legalScore < 40) riskPts += 15;
    else if (legalScore < 60) riskPts += 8;
    if (physicalScore < 40) riskPts += 10;

    // Building complexity
    const params = BUILDING_PARAMS[useId];
    if (params && params.stories >= 10) riskPts += 10;
    else if (params && params.stories >= 6) riskPts += 5;

    // Market risk for certain types
    if (['office', 'retail', 'hotel'].includes(useId)) riskPts += 6;

    if (riskPts >= 35) return { level: 'High', color: '#c53030', bg: '#fff5f5' };
    if (riskPts >= 18) return { level: 'Moderate', color: '#b7791f', bg: '#fffff0' };
    return { level: 'Low', color: '#276749', bg: '#f0fff4' };
}

function generateCardMetricsHTML(useId, inp, effects, result) {
    const budget = generateBudget(useId, inp, effects);
    const tl = TIMELINE_MONTHS[useId] || { entitlement: 6, design: 4, permits: 3, construction: 18, leaseup: 6 };
    const totalMo = tl.entitlement + tl.design + tl.permits + tl.construction + tl.leaseup;

    const irr = approxIRR(budget.devMargin, totalMo);
    const ease = computeEaseOfExecution(useId, inp, effects, result.legal);
    const risk = computeRiskLevel(useId, inp, result.legal, result.physical);

    // Color helpers
    const marginClass = budget.devMargin >= 0.20 ? 'positive' : budget.devMargin >= 0.08 ? 'caution' : 'negative';
    const irrClass = irr >= 0.10 ? 'positive' : irr >= 0.06 ? 'caution' : 'negative';
    const yocClass = budget.yieldOnCost >= 0.065 ? 'positive' : budget.yieldOnCost >= 0.045 ? 'caution' : 'negative';
    const easeColor = ease >= 60 ? '#276749' : ease >= 35 ? '#b7791f' : '#c53030';
    const easeLabel = ease >= 70 ? 'Easy' : ease >= 50 ? 'Moderate' : ease >= 30 ? 'Difficult' : 'Very Hard';

    return `
        <div class="key-metrics">
            <div class="key-metrics-title">Key Metrics</div>
            <div class="metrics-grid">
                <div class="metric-item">
                    <div class="metric-icon-label">💰 Budget</div>
                    <div class="metric-value">${formatCompactDollars(budget.totalDev)}</div>
                </div>
                <div class="metric-item">
                    <div class="metric-icon-label">📅 Timeline</div>
                    <div class="metric-value">${totalMo} mo</div>
                </div>
                <div class="metric-item">
                    <div class="metric-icon-label">📈 Dev Margin</div>
                    <div class="metric-value ${marginClass}">${(budget.devMargin * 100).toFixed(0)}%</div>
                </div>
                <div class="metric-item">
                    <div class="metric-icon-label">🎯 Est. IRR</div>
                    <div class="metric-value ${irrClass}">${(irr * 100).toFixed(1)}%</div>
                </div>
                <div class="metric-item">
                    <div class="metric-icon-label">🏗️ Yield on Cost</div>
                    <div class="metric-value ${yocClass}">${(budget.yieldOnCost * 100).toFixed(1)}%</div>
                </div>
                <div class="metric-item">
                    <div class="metric-icon-label">⚡ Ease of Execution</div>
                    <div class="metric-value" style="font-size:0.78rem;color:${easeColor}">${ease} — ${easeLabel}</div>
                    <div class="ease-bar-bg"><div class="ease-bar-fill" style="width:${ease}%;background:${easeColor}"></div></div>
                </div>
                <div class="metric-item" style="grid-column:span 2">
                    <div class="metric-icon-label">⚠️ Risk Level</div>
                    <span class="risk-badge" style="color:${risk.color};background:${risk.bg}">
                        <span class="risk-dot" style="background:${risk.color}"></span>
                        ${risk.level}
                    </span>
                </div>
            </div>
        </div>`;
}

function generateRisksHTML(useId, inp) {
    const risks = [];
    if (inp.constFlood) risks.push({ t: 'Flood Zone', d: 'Site is in a flood zone. Flood insurance required, ground-floor design constraints, potential FEMA elevation requirements.' });
    if (inp.constHillside) risks.push({ t: 'Hillside Ordinance', d: 'Hillside development restrictions limit grading, height, and density. Extended entitlement timeline expected.' });
    if (inp.constHistoric) risks.push({ t: 'Historic Overlay', d: 'Historic preservation review required. May limit demolition, facade changes, and building height.' });
    if (inp.constFault) risks.push({ t: 'Fault Zone', d: 'Alquist-Priolo fault zone — geotechnical study required. Structural reinforcement may increase costs 10-20%.' });
    if (inp.constCoastal) risks.push({ t: 'Coastal Zone', d: 'California Coastal Commission review required. Height, view corridor, and public access conditions likely.' });
    if (inp.siteCondition === 'brownfield') risks.push({ t: 'Environmental Contamination', d: 'Phase II ESA recommended. Remediation costs could range from $50K to $500K+ depending on contamination type.' });
    if (inp.siteCondition === 'demolition') risks.push({ t: 'Demolition Required', d: 'Existing structure requires demolition. Asbestos/lead survey required. Demo costs included in budget.' });
    if (inp.utilities === 'partial') risks.push({ t: 'Utility Upgrades Needed', d: 'Utility infrastructure requires upgrades. Coordinate with LADWP and LASAN. May add $50-200K.' });
    if (inp.utilities === 'none') risks.push({ t: 'No Utilities Available', d: 'Significant utility extension required. May add $200K-$1M+ and 6-12 months to timeline.' });
    if (inp.topography === 'steep') risks.push({ t: 'Steep Topography', d: 'Significant grading and retaining walls required. May add 15-30% to foundation costs.' });
    if (['multifamily_high', 'hotel'].includes(useId)) risks.push({ t: 'Construction Cost Escalation', d: 'High-rise construction is sensitive to material/labor cost changes. Lock in GMP contract early.' });
    if (useId === 'retail') risks.push({ t: 'Retail Market Uncertainty', d: 'Evolving retail landscape. Consider flexible ground-floor design for alternative uses.' });
    if (useId === 'office') risks.push({ t: 'Office Demand Shift', d: 'Remote work trends have shifted office demand. Consider amenity-rich design and flexible leases.' });
    risks.push({ t: 'Entitlement Risk', d: 'LA entitlement timelines are subject to CEQA review, community opposition, and council discretion. Budget for delays.' });
    risks.push({ t: 'Interest Rate Sensitivity', d: 'Construction and permanent financing costs fluctuate. Model scenarios at current rate +/- 100 bps.' });

    let html = '<div class="analysis-section"><h3>Key Risks &amp; Considerations</h3>';
    html += risks.map(r => `<div class="risk-card"><strong>${r.t}</strong><p>${r.d}</p></div>`).join('');
    html += '</div>';
    return html;
}


// ============================================================
//  EDITABLE ANALYSIS — STATE, COMPUTE, RENDER HELPERS
// ============================================================

let analysisState = {
    resultIndex: null,
    useId: null,
    inp: null,
    effects: null,
    legislation: null,
    assumptions: null,
};

function getDefaultAssumptions(useId, inp, effects) {
    const params = BUILDING_PARAMS[useId];
    const baseFAR = FAR_TYPICAL[useId] || 1.0;
    let far = baseFAR;
    if (effects) {
        far = baseFAR * (1 + effects.densityBonus);
        if (effects.minFAR > 0) far = Math.max(far, effects.minFAR);
    }

    const gsf = Math.round(inp.parcelSize * far);
    const nsf = Math.round(gsf * params.eff);
    const hasUnits = !!params.unitSF;
    const unitsOrNSF = hasUnits ? Math.max(1, Math.floor(nsf / params.unitSF)) : nsf;

    const baseParkRatio = params.parkRatio || 0;
    const parkReduction = effects ? effects.parkingReduction : 0;
    let parkingSpaces;
    if (useId === 'parking') {
        parkingSpaces = Math.round(gsf / 350);
    } else if (hasUnits) {
        parkingSpaces = Math.max(0, Math.ceil(unitsOrNSF * baseParkRatio * (1 - parkReduction)));
    } else {
        parkingSpaces = Math.max(0, Math.ceil(gsf / 1000 * baseParkRatio * (1 - parkReduction)));
    }

    let buildCostPSF = BUILD_COST_PSF[useId] || 300;
    if (effects && effects.parkingReduction > 0) {
        buildCostPSF = Math.round(buildCostPSF * (1 - effects.parkingReduction * 0.18));
    }

    const rentMult = NEIGHBORHOOD_RENT_MULT[inp.neighborhood] || 1.0;

    return {
        far: parseFloat(far.toFixed(2)),
        unitsOrNSF,
        parkingSpaces,
        buildCostPSF: Math.round(buildCostPSF),
        landValuePSF: LAND_VALUE_PSF[inp.neighborhood] || 150,
        revenuePSF: Math.round((REVENUE_PSF[useId] || 30) * rentMult),
        opexPct: Math.round(params.opex * 100),
        capRatePct: parseFloat((params.cap * 100).toFixed(1)),
        parkingCostPerSpace: PARKING_COST_MAP[useId] || 35000,
    };
}

function computeFromAssumptions(useId, inp, assumptions, effects) {
    const params = BUILDING_PARAMS[useId];
    const far = assumptions.far;
    const gsf = Math.round(inp.parcelSize * far);
    const nsf = Math.round(gsf * params.eff);
    const stories = Math.max(params.stories, Math.ceil(gsf / (inp.parcelSize * 0.7)));
    const buildingHeight = stories * params.floorH;
    const buildingFootprint = Math.min(Math.round(inp.parcelSize * 0.7), Math.round(gsf / stories));

    const hasUnits = !!params.unitSF;
    const units = hasUnits ? assumptions.unitsOrNSF : null;
    // For revenue: use user-edited NSF for non-unit uses, or units * unitSF for unit-based uses
    const revenueNSF = hasUnits ? assumptions.unitsOrNSF * params.unitSF : assumptions.unitsOrNSF;
    const parkingSpaces = assumptions.parkingSpaces;

    const landValuePSF = assumptions.landValuePSF;
    const landCost = inp.parcelSize * landValuePSF;

    // Hard costs
    const siteWork = inp.parcelSize * 18;
    const demolition = (inp.siteCondition === 'demolition') ? inp.parcelSize * 12 : 0;
    const buildCostPSF = assumptions.buildCostPSF;
    const construction = gsf * buildCostPSF;
    const parkingCost = parkingSpaces * assumptions.parkingCostPerSpace;
    const landscaping = Math.round(construction * 0.04);
    const hardContingency = Math.round((siteWork + demolition + construction + parkingCost + landscaping) * 0.07);
    const totalHard = siteWork + demolition + construction + parkingCost + landscaping + hardContingency;

    // Soft costs
    const archEng = Math.round(totalHard * 0.08);
    const permits = Math.round(totalHard * 0.05);
    const legal = Math.round(totalHard * 0.02);
    const financing = Math.round((landCost + totalHard) * 0.045);
    const revenuePSF = assumptions.revenuePSF;
    const marketing = Math.round(revenueNSF * revenuePSF * 0.02);
    const devFee = Math.round((totalHard + archEng + permits) * 0.04);
    const softCostMult = effects && effects.softCostReduction > 0 ? (1 - effects.softCostReduction * 0.20) : 1;
    const totalSoft = Math.round((archEng + permits + legal + financing + marketing + devFee) * softCostMult);

    const totalDev = landCost + totalHard + totalSoft;

    // Revenue & returns — use revenueNSF so user edits to units/NSF flow through
    const grossRevenue = revenueNSF * revenuePSF;
    const opexRate = assumptions.opexPct / 100;
    const opex = Math.round(grossRevenue * opexRate);
    const noi = grossRevenue - opex;
    const capRate = assumptions.capRatePct / 100;
    const stabilizedValue = capRate > 0 ? Math.round(noi / capRate) : 0;
    const yieldOnCost = totalDev > 0 ? noi / totalDev : 0;
    const devMargin = totalDev > 0 ? (stabilizedValue - totalDev) / totalDev : 0;

    return {
        gsf, nsf, revenueNSF, stories, buildingHeight, buildingFootprint, units, parkingSpaces, far,
        landCost, siteWork, demolition, construction, buildCostPSF, parkingCost, landscaping, hardContingency, totalHard,
        archEng, permits, legal, financing, marketing, devFee, totalSoft,
        totalDev,
        grossRevenue, opex, noi, capRate, stabilizedValue, yieldOnCost, devMargin,
        params, landValuePSF, revenuePSF, parkingCostPerSpace: assumptions.parkingCostPerSpace,
    };
}

function renderProgramDisplay(computed) {
    return `<div class="program-grid">
        <div class="program-item"><div class="program-value">${computed.stories}</div><div class="program-label">Stories / ${computed.buildingHeight} ft</div></div>
        <div class="program-item"><div class="program-value">${computed.gsf.toLocaleString()}</div><div class="program-label">Gross SF</div></div>
        ${computed.units
            ? `<div class="program-item"><div class="program-value">${computed.units}</div><div class="program-label">Units</div></div>`
            : `<div class="program-item"><div class="program-value">${computed.nsf.toLocaleString()}</div><div class="program-label">Net Leasable SF</div></div>`}
        <div class="program-item"><div class="program-value">${computed.parkingSpaces}</div><div class="program-label">Parking Spaces</div></div>
    </div>`;
}

function renderAssumptions(assumptions, hasUnits) {
    return `<div class="assumptions-panel">
        <h4>Key Assumptions (editable)</h4>
        <div class="assumptions-grid">
            <div class="assumption-field">
                <label>FAR</label>
                <input type="number" class="assumption-input" id="a-far" step="0.1" min="0.1" max="20" value="${assumptions.far}" oninput="recalcAnalysis()">
            </div>
            <div class="assumption-field">
                <label>${hasUnits ? 'Units' : 'Net Leasable SF'}</label>
                <input type="number" class="assumption-input" id="a-unitsOrNSF" step="1" min="1" value="${assumptions.unitsOrNSF}" oninput="recalcAnalysis()">
            </div>
            <div class="assumption-field">
                <label>Parking Spaces</label>
                <input type="number" class="assumption-input" id="a-parkingSpaces" step="1" min="0" value="${assumptions.parkingSpaces}" oninput="recalcAnalysis()">
            </div>
            <div class="assumption-field">
                <label>Build Cost $/SF</label>
                <input type="number" class="assumption-input" id="a-buildCostPSF" step="5" min="10" value="${assumptions.buildCostPSF}" oninput="recalcAnalysis()">
            </div>
            <div class="assumption-field">
                <label>Land Value $/SF</label>
                <input type="number" class="assumption-input" id="a-landValuePSF" step="5" min="1" value="${assumptions.landValuePSF}" oninput="recalcAnalysis()">
            </div>
            <div class="assumption-field">
                <label>Revenue $/SF</label>
                <input type="number" class="assumption-input" id="a-revenuePSF" step="1" min="1" value="${assumptions.revenuePSF}" oninput="recalcAnalysis()">
            </div>
            <div class="assumption-field">
                <label>OpEx %</label>
                <input type="number" class="assumption-input" id="a-opexPct" step="1" min="0" max="100" value="${assumptions.opexPct}" oninput="recalcAnalysis()">
            </div>
            <div class="assumption-field">
                <label>Cap Rate %</label>
                <input type="number" class="assumption-input" id="a-capRatePct" step="0.1" min="0.1" max="20" value="${assumptions.capRatePct}" oninput="recalcAnalysis()">
            </div>
            <div class="assumption-field">
                <label>Parking $/Space</label>
                <input type="number" class="assumption-input" id="a-parkingCostPerSpace" step="1000" min="0" value="${assumptions.parkingCostPerSpace}" oninput="recalcAnalysis()">
            </div>
        </div>
    </div>`;
}

function renderBudgetTable(computed, inp) {
    const gsf = computed.gsf || 1;
    const units = computed.units;
    const hasUnits = units && units > 0;
    const perGSF = (v) => `$${Math.round(v / gsf).toLocaleString()}`;
    const perUnit = (v) => hasUnits ? `$${Math.round(v / units).toLocaleString()}` : '—';
    const pct = (v) => computed.totalDev > 0 ? `${(v / computed.totalDev * 100).toFixed(1)}%` : '';

    return `<table class="budget-table">
        <thead><tr>
            <th>Line Item</th>
            <th>Total</th>
            <th>$/GSF</th>
            <th>${hasUnits ? '$/Unit' : '$/NSF'}</th>
            <th>% of Total</th>
        </tr></thead>
        <tbody>
        <tr class="section-header"><td colspan="5">LAND ACQUISITION</td></tr>
        <tr>
            <td>Land Cost (${inp.parcelSize.toLocaleString()} SF &times; $${computed.landValuePSF.toLocaleString()}/SF)</td>
            <td>${fmt(computed.landCost)}</td>
            <td class="dim">${perGSF(computed.landCost)}</td>
            <td class="dim">${hasUnits ? perUnit(computed.landCost) : '$' + Math.round(computed.landCost / (computed.nsf || 1)).toLocaleString()}</td>
            <td class="pct-col">${pct(computed.landCost)}</td>
        </tr>

        <tr class="section-header"><td colspan="5">HARD COSTS</td></tr>
        <tr>
            <td>Site Work &amp; Preparation</td>
            <td>${fmt(computed.siteWork)}</td>
            <td class="dim">${perGSF(computed.siteWork)}</td>
            <td class="dim">${hasUnits ? perUnit(computed.siteWork) : '$' + Math.round(computed.siteWork / (computed.nsf || 1)).toLocaleString()}</td>
            <td class="pct-col">${pct(computed.siteWork)}</td>
        </tr>
        ${computed.demolition > 0 ? `<tr>
            <td>Demolition</td>
            <td>${fmt(computed.demolition)}</td>
            <td class="dim">${perGSF(computed.demolition)}</td>
            <td class="dim">${hasUnits ? perUnit(computed.demolition) : '$' + Math.round(computed.demolition / (computed.nsf || 1)).toLocaleString()}</td>
            <td class="pct-col">${pct(computed.demolition)}</td>
        </tr>` : ''}
        <tr>
            <td>Building Construction (${computed.gsf.toLocaleString()} GSF &times; $${Math.round(computed.buildCostPSF).toLocaleString()}/SF)</td>
            <td>${fmt(computed.construction)}</td>
            <td class="dim">$${Math.round(computed.buildCostPSF).toLocaleString()}</td>
            <td class="dim">${hasUnits ? perUnit(computed.construction) : '$' + Math.round(computed.construction / (computed.nsf || 1)).toLocaleString()}</td>
            <td class="pct-col">${pct(computed.construction)}</td>
        </tr>
        <tr>
            <td>Parking (${computed.parkingSpaces} spaces &times; $${(computed.parkingCostPerSpace || 0).toLocaleString()})</td>
            <td>${fmt(computed.parkingCost)}</td>
            <td class="dim">${perGSF(computed.parkingCost)}</td>
            <td class="dim">${hasUnits ? perUnit(computed.parkingCost) : '$' + Math.round(computed.parkingCost / (computed.nsf || 1)).toLocaleString()}</td>
            <td class="pct-col">${pct(computed.parkingCost)}</td>
        </tr>
        <tr>
            <td>Landscaping &amp; Hardscape (4%)</td>
            <td>${fmt(computed.landscaping)}</td>
            <td class="dim">${perGSF(computed.landscaping)}</td>
            <td class="dim">${hasUnits ? perUnit(computed.landscaping) : '$' + Math.round(computed.landscaping / (computed.nsf || 1)).toLocaleString()}</td>
            <td class="pct-col">${pct(computed.landscaping)}</td>
        </tr>
        <tr>
            <td>Hard Cost Contingency (7%)</td>
            <td>${fmt(computed.hardContingency)}</td>
            <td class="dim">${perGSF(computed.hardContingency)}</td>
            <td class="dim">${hasUnits ? perUnit(computed.hardContingency) : '$' + Math.round(computed.hardContingency / (computed.nsf || 1)).toLocaleString()}</td>
            <td class="pct-col">${pct(computed.hardContingency)}</td>
        </tr>
        <tr class="subtotal">
            <td>Subtotal Hard Costs</td>
            <td>${fmt(computed.totalHard)}</td>
            <td>${perGSF(computed.totalHard)}</td>
            <td>${hasUnits ? perUnit(computed.totalHard) : '$' + Math.round(computed.totalHard / (computed.nsf || 1)).toLocaleString()}</td>
            <td class="pct-col">${pct(computed.totalHard)}</td>
        </tr>

        <tr class="section-header"><td colspan="5">SOFT COSTS</td></tr>
        <tr>
            <td>Architecture &amp; Engineering (8%)</td>
            <td>${fmt(computed.archEng)}</td>
            <td class="dim">${perGSF(computed.archEng)}</td>
            <td class="dim">${hasUnits ? perUnit(computed.archEng) : '$' + Math.round(computed.archEng / (computed.nsf || 1)).toLocaleString()}</td>
            <td class="pct-col">${pct(computed.archEng)}</td>
        </tr>
        <tr>
            <td>Permits &amp; Impact Fees (5%)</td>
            <td>${fmt(computed.permits)}</td>
            <td class="dim">${perGSF(computed.permits)}</td>
            <td class="dim">${hasUnits ? perUnit(computed.permits) : '$' + Math.round(computed.permits / (computed.nsf || 1)).toLocaleString()}</td>
            <td class="pct-col">${pct(computed.permits)}</td>
        </tr>
        <tr>
            <td>Legal &amp; Accounting (2%)</td>
            <td>${fmt(computed.legal)}</td>
            <td class="dim">${perGSF(computed.legal)}</td>
            <td class="dim">${hasUnits ? perUnit(computed.legal) : '$' + Math.round(computed.legal / (computed.nsf || 1)).toLocaleString()}</td>
            <td class="pct-col">${pct(computed.legal)}</td>
        </tr>
        <tr>
            <td>Financing &amp; Interest Carry (4.5%)</td>
            <td>${fmt(computed.financing)}</td>
            <td class="dim">${perGSF(computed.financing)}</td>
            <td class="dim">${hasUnits ? perUnit(computed.financing) : '$' + Math.round(computed.financing / (computed.nsf || 1)).toLocaleString()}</td>
            <td class="pct-col">${pct(computed.financing)}</td>
        </tr>
        <tr>
            <td>Marketing &amp; Leasing (2%)</td>
            <td>${fmt(computed.marketing)}</td>
            <td class="dim">${perGSF(computed.marketing)}</td>
            <td class="dim">${hasUnits ? perUnit(computed.marketing) : '$' + Math.round(computed.marketing / (computed.nsf || 1)).toLocaleString()}</td>
            <td class="pct-col">${pct(computed.marketing)}</td>
        </tr>
        <tr>
            <td>Developer Fee (4%)</td>
            <td>${fmt(computed.devFee)}</td>
            <td class="dim">${perGSF(computed.devFee)}</td>
            <td class="dim">${hasUnits ? perUnit(computed.devFee) : '$' + Math.round(computed.devFee / (computed.nsf || 1)).toLocaleString()}</td>
            <td class="pct-col">${pct(computed.devFee)}</td>
        </tr>
        <tr class="subtotal">
            <td>Subtotal Soft Costs</td>
            <td>${fmt(computed.totalSoft)}</td>
            <td>${perGSF(computed.totalSoft)}</td>
            <td>${hasUnits ? perUnit(computed.totalSoft) : '$' + Math.round(computed.totalSoft / (computed.nsf || 1)).toLocaleString()}</td>
            <td class="pct-col">${pct(computed.totalSoft)}</td>
        </tr>

        <tr class="grand-total">
            <td>TOTAL DEVELOPMENT COST</td>
            <td>${fmt(computed.totalDev)}</td>
            <td>${perGSF(computed.totalDev)}</td>
            <td>${hasUnits ? perUnit(computed.totalDev) : '$' + Math.round(computed.totalDev / (computed.nsf || 1)).toLocaleString()}</td>
            <td>100%</td>
        </tr>
        </tbody>
    </table>`;
}

function renderReturnsSection(computed) {
    const spread = ((computed.yieldOnCost - computed.capRate) * 100).toFixed(0);
    const spreadLabel = spread >= 0 ? `+${spread} bps` : `${spread} bps`;
    const spreadColor = spread >= 150 ? '#276749' : spread >= 0 ? '#b7791f' : '#c53030';
    const marginColor = computed.devMargin >= 0.15 ? '#276749' : computed.devMargin >= 0 ? '#b7791f' : '#c53030';
    const hasUnits = computed.units && computed.units > 0;
    const perUnit = (v) => hasUnits ? `$${Math.round(v / computed.units).toLocaleString()}/unit` : '';
    const perNSF = (v) => `$${(v / (computed.revenueNSF || computed.nsf || 1)).toFixed(2)}/SF`;

    return `<div class="returns-grid">
        <div class="return-card"><div class="return-value">${(computed.yieldOnCost * 100).toFixed(1)}%</div><div class="return-label">Yield on Cost</div></div>
        <div class="return-card"><div class="return-value">${(computed.capRate * 100).toFixed(1)}%</div><div class="return-label">Market Cap Rate</div></div>
        <div class="return-card"><div class="return-value" style="color:${spreadColor}">${spreadLabel}</div><div class="return-label">Dev Spread (YoC − Cap)</div></div>
        <div class="return-card"><div class="return-value" style="color:${marginColor}">${(computed.devMargin * 100).toFixed(0)}%</div><div class="return-label">Development Margin</div></div>
    </div>
    <table class="budget-table">
        <thead><tr><th>Revenue &amp; Returns</th><th>Annual</th><th>${hasUnits ? '$/Unit' : '$/NSF'}</th></tr></thead>
        <tbody>
        <tr><td>Gross Revenue (${(computed.revenueNSF || computed.nsf || 0).toLocaleString()} NSF &times; $${computed.revenuePSF}/SF)</td><td>${fmt(computed.grossRevenue)}</td><td class="dim">${hasUnits ? perUnit(computed.grossRevenue) : perNSF(computed.grossRevenue)}</td></tr>
        <tr><td>Less: Operating Expenses (${computed.grossRevenue > 0 ? Math.round(computed.opex / computed.grossRevenue * 100) : 0}%)</td><td>(${fmt(computed.opex)})</td><td class="dim">${hasUnits ? '(' + perUnit(computed.opex).replace('$','$') + ')' : '(' + perNSF(computed.opex) + ')'}</td></tr>
        <tr class="subtotal"><td>Net Operating Income (NOI)</td><td>${fmt(computed.noi)}</td><td>${hasUnits ? perUnit(computed.noi) : perNSF(computed.noi)}</td></tr>
        <tr><td>Stabilized Value (NOI &divide; ${(computed.capRate * 100).toFixed(1)}% cap)</td><td>${fmt(computed.stabilizedValue)}</td><td class="dim">${hasUnits ? '$' + Math.round(computed.stabilizedValue / computed.units).toLocaleString() + '/unit' : '$' + Math.round(computed.stabilizedValue / (computed.gsf || 1)).toLocaleString() + '/GSF'}</td></tr>
        <tr><td>Total Development Cost</td><td>${fmt(computed.totalDev)}</td><td class="dim">${hasUnits ? '$' + Math.round(computed.totalDev / computed.units).toLocaleString() + '/unit' : '$' + Math.round(computed.totalDev / (computed.gsf || 1)).toLocaleString() + '/GSF'}</td></tr>
        <tr class="subtotal"><td>Development Profit / (Loss)</td><td><strong style="color:${marginColor}">${fmt(computed.stabilizedValue - computed.totalDev)}</strong></td><td><strong style="color:${marginColor}">${(computed.devMargin * 100).toFixed(0)}%</strong></td></tr>
        </tbody>
    </table>`;
}

function renderSVGs(useId, inp, computed) {
    return `${generateSitePlanSVG(useId, inp, computed)}
        ${generateElevationSVG(useId, inp, computed)}`;
}

function recalcAnalysis() {
    const st = analysisState;
    if (!st.useId || !st.inp) return;

    const assumptions = {
        far: parseFloat(document.getElementById('a-far').value) || st.assumptions.far,
        unitsOrNSF: parseInt(document.getElementById('a-unitsOrNSF').value) || st.assumptions.unitsOrNSF,
        parkingSpaces: parseInt(document.getElementById('a-parkingSpaces').value) || 0,
        buildCostPSF: parseFloat(document.getElementById('a-buildCostPSF').value) || st.assumptions.buildCostPSF,
        landValuePSF: parseFloat(document.getElementById('a-landValuePSF').value) || st.assumptions.landValuePSF,
        revenuePSF: parseFloat(document.getElementById('a-revenuePSF').value) || st.assumptions.revenuePSF,
        opexPct: parseFloat(document.getElementById('a-opexPct').value) || 0,
        capRatePct: parseFloat(document.getElementById('a-capRatePct').value) || st.assumptions.capRatePct,
        parkingCostPerSpace: parseFloat(document.getElementById('a-parkingCostPerSpace').value) || 0,
    };

    st.assumptions = assumptions;
    const computed = computeFromAssumptions(st.useId, st.inp, assumptions, st.effects);

    const progEl = document.getElementById('sect-program');
    if (progEl) progEl.innerHTML = renderProgramDisplay(computed);

    const budgetEl = document.getElementById('sect-budget');
    if (budgetEl) budgetEl.innerHTML = renderBudgetTable(computed, st.inp);

    const returnsEl = document.getElementById('sect-returns');
    if (returnsEl) returnsEl.innerHTML = renderReturnsSection(computed);

    const svgEl = document.getElementById('sect-svg');
    if (svgEl) svgEl.innerHTML = renderSVGs(st.useId, st.inp, computed);
}


function openAnalysis(resultIndex) {
    if (!lastResults || !lastInputs) return;
    const r = lastResults[resultIndex];
    const inp = lastInputs;
    const effects = stackLegislationEffects(r.legislation || []);
    const hasUnits = !!BUILDING_PARAMS[r.id].unitSF;

    // Set up analysisState
    const assumptions = getDefaultAssumptions(r.id, inp, effects);
    analysisState = {
        resultIndex,
        useId: r.id,
        inp,
        effects,
        legislation: r.legislation || [],
        assumptions,
    };

    const computed = computeFromAssumptions(r.id, inp, assumptions, effects);
    const tl = TIMELINE_MONTHS[r.id] || { entitlement: 6, design: 4, permits: 3, construction: 18, leaseup: 6 };
    const totalMonths = tl.entitlement + tl.design + tl.permits + tl.construction + tl.leaseup;
    const neighborhoodText = document.getElementById('neighborhood').selectedOptions[0].text;

    document.getElementById('modalTitle').textContent = `${r.icon} ${r.name}`;
    document.getElementById('modalSubtitle').textContent =
        `Detailed Development Analysis  |  ${inp.parcelSize.toLocaleString()} SF  |  ${inp.zoning} Zoning  |  ${neighborhoodText}`;

    let html = '';

    // --- Building Program (re-rendered on assumption change) ---
    html += `<div class="analysis-section"><h3>Building Program</h3><div id="sect-program">${renderProgramDisplay(computed)}</div></div>`;

    // --- Key Assumptions (editable — NOT re-rendered) ---
    html += `<div class="analysis-section">${renderAssumptions(assumptions, hasUnits)}</div>`;

    // --- Conceptual Renderings (re-rendered) ---
    html += `<div class="analysis-section"><h3>Conceptual Massing Study</h3><div class="rendering-container" id="sect-svg">${renderSVGs(r.id, inp, computed)}</div></div>`;

    // --- Line Item Budget (re-rendered) ---
    html += `<div class="analysis-section"><h3>Development Pro Forma &mdash; Line Item Budget</h3><div id="sect-budget">${renderBudgetTable(computed, inp)}</div></div>`;

    // --- Revenue & Returns (re-rendered) ---
    html += `<div class="analysis-section"><h3>Revenue &amp; Return Analysis</h3><div id="sect-returns">${renderReturnsSection(computed)}</div></div>`;

    // --- Timeline (static) ---
    html += `<div class="analysis-section"><h3>Development Timeline &mdash; ${totalMonths} Months</h3>
    <div class="timeline-bar">
        <div class="timeline-segment" style="flex:${tl.entitlement};background:#805ad5;">Entitle<br>${tl.entitlement}mo</div>
        <div class="timeline-segment" style="flex:${tl.design};background:#3182ce;">Design<br>${tl.design}mo</div>
        <div class="timeline-segment" style="flex:${tl.permits};background:#38a169;">Permits<br>${tl.permits}mo</div>
        <div class="timeline-segment" style="flex:${tl.construction};background:#dd6b20;">Construction<br>${tl.construction}mo</div>
        <div class="timeline-segment" style="flex:${tl.leaseup};background:#e53e3e;">Lease-Up<br>${tl.leaseup}mo</div>
    </div>
    <div class="timeline-legend">Entitlement &rarr; Design &rarr; Permits &rarr; Construction &rarr; Lease-Up / Stabilization</div>
    </div>`;

    // --- Legislation (with clickable cards) ---
    if (r.legislation && r.legislation.length > 0) {
        html += `<div class="analysis-section"><h3>Applicable California Housing Legislation</h3>
        <div class="legislation-cards">
            ${r.legislation.map(b => `<div class="legislation-card clickable" onclick="showLegislationDetail('${b.id}')"><strong>${b.name}</strong><p>${b.description}</p></div>`).join('')}
        </div></div>`;
    }

    // --- Risks ---
    html += generateRisksHTML(r.id, inp);

    // --- Disclaimer ---
    html += `<div class="disclaimer" style="margin-top:1.5rem;">
        <strong>Disclaimer:</strong> This pro forma is a preliminary estimate for educational purposes only. Actual development costs, revenues, and timelines vary significantly based on market conditions, design specifications, entitlement outcomes, and contractor pricing. All figures should be verified through independent feasibility analysis by qualified professionals before making investment decisions.
    </div>`;

    document.getElementById('modalBody').innerHTML = html;
    document.getElementById('analysisModal').style.display = 'block';
    document.body.style.overflow = 'hidden';
    document.getElementById('analysisModal').scrollTop = 0;
}

function closeAnalysis() {
    document.getElementById('analysisModal').style.display = 'none';
    document.body.style.overflow = '';
}

function printAnalysis() {
    document.body.classList.add('printing-analysis');
    window.print();
    document.body.classList.remove('printing-analysis');
}


// ============================================================
//  LEGISLATION DETAIL POPUP
// ============================================================

function showLegislationDetail(billId) {
    const bill = CA_HOUSING_LEGISLATION.find(b => b.id === billId);
    if (!bill) return;

    const modal = document.getElementById('legDetailModal');
    modal.innerHTML = `<div class="leg-detail-content">
        <div class="leg-detail-header">
            <h3>${bill.name}</h3>
            <button type="button" class="leg-detail-close" onclick="closeLegislationDetail()">&times;</button>
        </div>
        <div class="leg-detail-body">
            <p class="leg-summary">${bill.description}</p>
            <p class="leg-full">${bill.detail || bill.description}</p>
        </div>
    </div>`;
    modal.style.display = 'flex';
}

function closeLegislationDetail() {
    document.getElementById('legDetailModal').style.display = 'none';
}


// ============================================================
//  SB 79 TRANSIT MAP
// ============================================================

let sb79Map = null;
let sb79Layers = { tier1: null, tier2: null, zones: null, property: null };
let sb79LayerState = { tier1: true, tier2: true, zones: true, property: true };
let sb79StationRadii = {};

function initSB79Map(lat, lon) {
    const mapEl = document.getElementById('sb79Map');
    if (!mapEl) return;

    // Destroy existing map
    if (sb79Map) { sb79Map.remove(); sb79Map = null; }
    sb79StationRadii = {};

    sb79Map = L.map('sb79Map').setView([lat, lon], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
        maxZoom: 18,
    }).addTo(sb79Map);

    // Layer groups
    sb79Layers.tier1 = L.layerGroup().addTo(sb79Map);
    sb79Layers.tier2 = L.layerGroup().addTo(sb79Map);
    sb79Layers.zones = L.layerGroup().addTo(sb79Map);
    sb79Layers.property = L.layerGroup().addTo(sb79Map);

    // Property marker
    const propIcon = L.divIcon({
        html: '<div style="background:#e53e3e;width:16px;height:16px;border-radius:50%;border:3px solid #fff;box-shadow:0 2px 6px rgba(0,0,0,0.4);"></div>',
        iconSize: [16, 16], iconAnchor: [8, 8], className: '',
    });
    L.marker([lat, lon], { icon: propIcon })
        .bindPopup('<strong>Your Property</strong>')
        .addTo(sb79Layers.property);

    // Station markers
    const seenCoords = new Set();
    METRO_STATIONS.forEach((s, idx) => {
        const key = `${s.lat.toFixed(4)},${s.lon.toFixed(4)},${s.line}`;
        if (seenCoords.has(key)) return;
        seenCoords.add(key);

        const color = LINE_COLORS[s.line] || '#718096';
        const icon = L.divIcon({
            html: `<div style="background:${color};width:10px;height:10px;border-radius:50%;border:2px solid #fff;box-shadow:0 1px 3px rgba(0,0,0,0.3);"></div>`,
            iconSize: [10, 10], iconAnchor: [5, 5], className: '',
        });
        const tierData = SB79_TIERS[s.tier];
        const lineName = LINE_LABELS[s.line] || s.line;
        const popupHtml = `<div class="station-popup">
            <div class="popup-title">${s.name}</div>
            <div class="popup-line">${lineName} &mdash; ${tierData.label}</div>
            <div class="popup-allowances">
                <span><strong>SB 79 Allowances:</strong></span>
                <span>Height: ${tierData.height} ft | Density: ${tierData.density} du/ac</span>
                <span>FAR: ${tierData.far} | Parking: 0 (inner), 0.5/unit (outer)</span>
            </div>
        </div>`;
        const marker = L.marker([s.lat, s.lon], { icon })
            .bindPopup(popupHtml)
            .on('click', () => { showStationRadii(idx); });

        const layerGroup = s.tier === 1 ? sb79Layers.tier1 : sb79Layers.tier2;
        marker.addTo(layerGroup);
    });

    // Draw radii for nearest qualifying station
    const eligibility = detectSB79Eligibility(lat, lon);
    if (eligibility.eligible && eligibility.nearestIdx >= 0) {
        drawSB79Radii(METRO_STATIONS[eligibility.nearestIdx]);
    }

    // Render legend
    renderMapLegend();

    // Sync layer toggle button states
    document.querySelectorAll('#mapControls .layer-btn').forEach(btn => btn.classList.add('active'));
    sb79LayerState = { tier1: true, tier2: true, zones: true, property: true };

    // Force map to re-render tiles after display
    setTimeout(() => { if (sb79Map) sb79Map.invalidateSize(); }, 200);
}

function drawSB79Radii(station) {
    if (!sb79Layers.zones) return;
    const tierColor = station.tier === 1 ? '#805ad5' : '#3182ce';

    // 200ft = ~61m
    L.circle([station.lat, station.lon], {
        radius: 61, color: tierColor, weight: 2, opacity: 0.8,
        fillColor: tierColor, fillOpacity: 0.15, dashArray: null,
    }).bindPopup(`<strong>${station.name}</strong><br>200ft Adjacent Zone`).addTo(sb79Layers.zones);

    // 1/4 mile = ~402m
    L.circle([station.lat, station.lon], {
        radius: 402, color: tierColor, weight: 1.5, opacity: 0.6,
        fillColor: tierColor, fillOpacity: 0.07, dashArray: '8,6',
    }).bindPopup(`<strong>${station.name}</strong><br>1/4 Mile Inner Zone`).addTo(sb79Layers.zones);

    // 1/2 mile = ~805m
    L.circle([station.lat, station.lon], {
        radius: 805, color: tierColor, weight: 1, opacity: 0.4,
        fillColor: tierColor, fillOpacity: 0.03, dashArray: '4,8',
    }).bindPopup(`<strong>${station.name}</strong><br>1/2 Mile Outer Zone`).addTo(sb79Layers.zones);
}

function showStationRadii(stationIdx) {
    const station = METRO_STATIONS[stationIdx];
    if (!station || !sb79Layers.zones) return;
    const key = `${station.lat},${station.lon}`;
    if (sb79StationRadii[key]) return; // already drawn
    sb79StationRadii[key] = true;
    drawSB79Radii(station);
}

function toggleMapLayer(layerName) {
    if (!sb79Map || !sb79Layers[layerName]) return;
    sb79LayerState[layerName] = !sb79LayerState[layerName];
    if (sb79LayerState[layerName]) {
        sb79Map.addLayer(sb79Layers[layerName]);
    } else {
        sb79Map.removeLayer(sb79Layers[layerName]);
    }
    // Update button state
    const btns = document.querySelectorAll('#mapControls .layer-btn');
    const labels = { tier1: 'Tier 1', tier2: 'Tier 2', zones: 'SB 79 Zones', property: 'Your Property' };
    btns.forEach(btn => {
        for (const [k, v] of Object.entries(labels)) {
            if (btn.textContent.includes(v)) {
                btn.classList.toggle('active', sb79LayerState[k]);
            }
        }
    });
}

function renderMapLegend() {
    const el = document.getElementById('mapLegend');
    if (!el) return;
    el.innerHTML = `
        <div class="legend-item"><span class="legend-dot" style="background:#e53e3e;"></span> Red/B Line</div>
        <div class="legend-item"><span class="legend-dot" style="background:#805ad5;"></span> Purple/D Line</div>
        <div class="legend-item"><span class="legend-dot" style="background:#3182ce;"></span> Blue/A Line</div>
        <div class="legend-item"><span class="legend-dot" style="background:#d69e2e;"></span> Expo/E Line</div>
        <div class="legend-item"><span class="legend-dot" style="background:#b7791f;"></span> Gold/L Line</div>
        <div class="legend-item"><span class="legend-dot" style="background:#38a169;"></span> Green/C Line</div>
        <div class="legend-item"><span class="legend-dot" style="background:#00bcd4;"></span> K Line</div>
        <div class="legend-item"><span class="legend-dot" style="background:#ed64a6;"></span> Regional Connector</div>
        <div class="legend-item"><span class="legend-dot" style="background:#e53e3e;border:2px solid #999;width:8px;height:8px;"></span> Metrolink</div>
        <div class="legend-item"><span class="legend-line" style="background:#805ad5;"></span> Tier 1 Zone</div>
        <div class="legend-item"><span class="legend-line" style="background:#3182ce;"></span> Tier 2 Zone</div>
        <div class="legend-item"><span class="legend-dot" style="background:#e53e3e;width:12px;height:12px;border:2px solid #fff;box-shadow:0 0 3px rgba(0,0,0,0.3);"></span> Your Property</div>
    `;
}

function renderSB79Eligibility(eligibility) {
    const el = document.getElementById('sb79Eligibility');
    if (!el) return;
    if (!eligibility || !eligibility.eligible) {
        el.style.display = 'none';
        return;
    }
    const a = eligibility.allowances;
    const tierClass = eligibility.tier === 1 ? 'tier1' : 'tier2';
    const zoneClass = eligibility.zone;
    el.style.display = 'block';
    el.innerHTML = `
        <h3>SB 79 Eligibility — Your Property</h3>
        <p style="font-size:0.85rem;color:var(--text-light);margin-bottom:0.75rem;">
            <span class="tier-badge ${tierClass}">${eligibility.tierLabel}</span>
            <span class="zone-badge ${zoneClass}">${eligibility.zoneLabel}</span>
            &mdash; ${eligibility.distMiles.toFixed(2)} mi from <strong>${eligibility.station.name}</strong>
            (${LINE_LABELS[eligibility.station.line] || eligibility.station.line})
        </p>
        <div class="sb79-grid">
            <div class="sb79-stat"><div class="stat-label">Max Height</div><div class="stat-value">${a.height} ft</div></div>
            <div class="sb79-stat"><div class="stat-label">Max Density</div><div class="stat-value">${a.density} du/ac</div></div>
            <div class="sb79-stat"><div class="stat-label">Max FAR</div><div class="stat-value">${a.far}</div></div>
            <div class="sb79-stat"><div class="stat-label">Parking Req</div><div class="stat-value">${a.parking === 0 ? 'None' : a.parking + '/unit'}</div></div>
            <div class="sb79-stat"><div class="stat-label">Affordable Req</div><div class="stat-value">15%</div></div>
            <div class="sb79-stat"><div class="stat-label">Effective Date</div><div class="stat-value">Jul 2026</div></div>
        </div>
    `;
}

// ============================================================
//  SB 79 OPPORTUNITY FINDER
// ============================================================

let finderResults = [];
let finderParcelLayer = null;
let finderSortCol = 'impRatio';
let finderSortAsc = true;

function toggleFinder() {
    const body = document.getElementById('finderBody');
    const arrow = document.getElementById('finderArrow');
    const isOpen = body.classList.toggle('open');
    arrow.classList.toggle('open', isOpen);
    if (isOpen && document.getElementById('finderStation').options.length === 0) {
        populateFinderStations();
    }
}

function populateFinderStations() {
    const sel = document.getElementById('finderStation');
    sel.innerHTML = '';
    const grouped = {};
    METRO_STATIONS.forEach((s, idx) => {
        const lineKey = s.line;
        if (!grouped[lineKey]) grouped[lineKey] = [];
        grouped[lineKey].push({ ...s, idx });
    });
    // Sort lines in display order
    const lineOrder = ['red', 'purple', 'blue_a', 'expo_e', 'gold_l', 'green_c', 'k_line', 'connector', 'metrolink'];
    for (const lineKey of lineOrder) {
        if (!grouped[lineKey]) continue;
        const grp = document.createElement('optgroup');
        grp.label = LINE_LABELS[lineKey] || lineKey;
        for (const s of grouped[lineKey]) {
            const opt = document.createElement('option');
            opt.value = s.idx;
            opt.textContent = s.name;
            grp.appendChild(opt);
        }
        sel.appendChild(grp);
    }
    // Pre-select nearest station if we have geocoded coords
    if (window.lastGeocode) {
        let bestIdx = 0, bestDist = Infinity;
        METRO_STATIONS.forEach((s, i) => {
            const d = haversine(window.lastGeocode.lat, window.lastGeocode.lon, s.lat, s.lon);
            if (d < bestDist) { bestDist = d; bestIdx = i; }
        });
        sel.value = bestIdx;
    }
}

function selectFinderStation(idx) {
    const sel = document.getElementById('finderStation');
    if (sel && sel.querySelector(`option[value="${idx}"]`)) {
        sel.value = idx;
    }
    // Open the finder if closed
    const body = document.getElementById('finderBody');
    if (body && !body.classList.contains('open')) {
        toggleFinder();
    }
}

function getFinderRadius() {
    const checked = document.querySelector('input[name="finderRadius"]:checked');
    const ft = checked ? parseInt(checked.value) : 2640;
    let zone = 'outer';
    if (ft <= 200) zone = 'adjacent';
    else if (ft <= 1320) zone = 'inner';
    return { zone, radiusFt: ft };
}

async function queryParcelsNearStation(lat, lon, radiusFt, onProgress) {
    const baseUrl = 'https://public.gis.lacounty.gov/public/rest/services/LACounty_Cache/LACounty_Parcel/MapServer/0/query';
    const outFields = 'APN,SitusFullAddress,UseType,UseDescription,UseCode,Roll_LandValue,Roll_ImpValue,YearBuilt1,SQFTmain1,Units1,CENTER_LAT,CENTER_LON,Shape.STArea()';
    const allFeatures = [];
    let offset = 0;
    const pageSize = 1000;
    let total = null;

    while (true) {
        const params = new URLSearchParams({
            geometry: `${lon},${lat}`,
            geometryType: 'esriGeometryPoint',
            inSR: '4326',
            spatialRel: 'esriSpatialRelIntersects',
            distance: radiusFt,
            units: 'esriSRUnit_Foot',
            outFields: outFields,
            returnGeometry: false,
            returnCountOnly: false,
            resultOffset: offset,
            resultRecordCount: pageSize,
            f: 'json',
        });
        if (total === null) {
            params.set('returnCountOnly', 'false');
        }

        const resp = await fetch(`${baseUrl}?${params}`);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();

        if (data.error) throw new Error(data.error.message || 'GIS API error');

        const features = data.features || [];
        allFeatures.push(...features);

        if (onProgress) {
            onProgress(allFeatures.length, total || allFeatures.length + (features.length === pageSize ? pageSize : 0));
        }

        if (features.length < pageSize) break;
        offset += pageSize;
        if (offset > 5000) break; // Safety cap
    }
    return allFeatures;
}

function classifyParcelUseType(useType, useDesc, useCode) {
    const ut = (useType || '').toLowerCase();
    const ud = (useDesc || '').toLowerCase();
    const uc = (useCode || '').toString();

    if (ut.includes('vacant') || ud.includes('vacant') || uc === '0000' || uc === '0100') return 'Vacant';
    if (ut.includes('resident') || ud.includes('resident') || ud.includes('single') || ud.includes('duplex') || ud.includes('apartment') || ud.includes('condo') || uc.startsWith('01') || uc.startsWith('02') || uc.startsWith('03') || uc.startsWith('04')) return 'Residential';
    if (ut.includes('commerc') || ud.includes('commerc') || ud.includes('office') || ud.includes('retail') || ud.includes('store') || ud.includes('shop') || uc.startsWith('1') || uc.startsWith('2')) return 'Commercial';
    if (ut.includes('industr') || ud.includes('industr') || ud.includes('manufact') || ud.includes('warehouse') || uc.startsWith('3') || uc.startsWith('4')) return 'Industrial';
    return 'Commercial'; // default
}

function classifySB79Zone(parcelLat, parcelLon, stationLat, stationLon) {
    const dist = haversine(parcelLat, parcelLon, stationLat, stationLon);
    if (dist <= SB79_ZONES.adjacent.maxDist) return { key: 'adjacent', dist };
    if (dist <= SB79_ZONES.inner.maxDist) return { key: 'inner', dist };
    if (dist <= SB79_ZONES.outer.maxDist) return { key: 'outer', dist };
    return { key: 'outside', dist };
}

function getSB79Allowances(tier, zoneKey) {
    const tierData = SB79_TIERS[tier];
    const zone = SB79_ZONES[zoneKey];
    if (!tierData || !zone) return null;
    return {
        height: Math.round(tierData.height * zone.heightMult),
        density: Math.round(tierData.density * zone.heightMult),
        far: parseFloat((tierData.far * zone.heightMult).toFixed(2)),
        parking: zone.parking,
    };
}

function filterAndScoreResults(features, station, filters) {
    const results = [];
    for (const f of features) {
        const a = f.attributes;
        const lat = parseFloat(a.CENTER_LAT);
        const lon = parseFloat(a.CENTER_LON);
        if (!lat || !lon) continue;

        const lotSize = a['Shape.STArea()'] || a['Shape__Area'] || a['ShapeSTArea'] || 0;
        const lotSizeSqFt = Math.round(lotSize);
        const landVal = parseFloat(a.Roll_LandValue) || 0;
        const impVal = parseFloat(a.Roll_ImpValue) || 0;
        const impRatio = landVal > 0 ? impVal / landVal : (impVal === 0 ? 0 : 999);
        const yearBuilt = parseInt(a.YearBuilt1) || 0;
        const useType = classifyParcelUseType(a.UseType, a.UseDescription, a.UseCode);
        const sqft = parseInt(a.SQFTmain1) || 0;
        const units = parseInt(a.Units1) || 0;
        const address = a.SitusFullAddress || 'No address';
        const apn = a.APN || '';

        // Classify SB 79 zone
        const zoneInfo = classifySB79Zone(lat, lon, station.lat, station.lon);
        if (zoneInfo.key === 'outside') continue;

        // Apply filters
        if (filters.minLot && lotSizeSqFt < filters.minLot) continue;
        if (filters.maxLot && lotSizeSqFt > filters.maxLot) continue;
        if (filters.useTypes.length > 0 && !filters.useTypes.includes(useType)) continue;
        if (filters.maxRatio !== null && impRatio > filters.maxRatio) continue;
        if (filters.yearBefore && yearBuilt > 0 && yearBuilt >= filters.yearBefore) continue;

        const allowances = getSB79Allowances(station.tier, zoneInfo.key);

        results.push({
            address, apn, lotSizeSqFt, useType, yearBuilt, landVal, impVal,
            impRatio, sqft, units, lat, lon,
            zone: zoneInfo.key, zoneDist: zoneInfo.dist,
            allowances, tier: station.tier,
        });
    }
    return results;
}

async function runOpportunitySearch() {
    const sel = document.getElementById('finderStation');
    const stationIdx = parseInt(sel.value);
    const station = METRO_STATIONS[stationIdx];
    if (!station) return;

    const { radiusFt } = getFinderRadius();
    const useChecks = document.querySelectorAll('.finderUseType:checked');
    const useTypes = Array.from(useChecks).map(c => c.value);
    const minLot = parseInt(document.getElementById('finderMinLot').value) || 0;
    const maxLot = parseInt(document.getElementById('finderMaxLot').value) || 999999;
    const maxRatio = parseFloat(document.getElementById('finderMaxRatio').value);
    const yearBefore = parseInt(document.getElementById('finderYearBefore').value) || 0;

    const filters = { useTypes, minLot, maxLot, maxRatio, yearBefore };

    // Show progress
    const progressEl = document.getElementById('finderProgress');
    const fillEl = document.getElementById('finderProgressFill');
    const textEl = document.getElementById('finderProgressText');
    const btn = document.getElementById('finderSearchBtn');
    const resultsArea = document.getElementById('finderResultsArea');

    progressEl.classList.add('active');
    fillEl.style.width = '0%';
    textEl.textContent = 'Querying parcels near ' + station.name + '...';
    btn.disabled = true;
    resultsArea.innerHTML = '';

    try {
        const features = await queryParcelsNearStation(
            station.lat, station.lon, radiusFt,
            (loaded, est) => {
                const pct = Math.min(90, Math.round((loaded / Math.max(est, 1)) * 90));
                fillEl.style.width = pct + '%';
                textEl.textContent = `Loading... ${loaded} parcels fetched`;
            }
        );

        fillEl.style.width = '95%';
        textEl.textContent = `Filtering ${features.length} parcels...`;

        finderResults = filterAndScoreResults(features, station, filters);

        // Default sort: lowest imp ratio first
        finderSortCol = 'impRatio';
        finderSortAsc = true;
        finderResults.sort((a, b) => a.impRatio - b.impRatio);

        fillEl.style.width = '100%';
        textEl.textContent = `Found ${finderResults.length} opportunities from ${features.length} parcels`;

        renderFinderResults(station);
        addFinderParcelsToMap(station);

    } catch (e) {
        console.error('Opportunity search failed:', e);
        resultsArea.innerHTML = `<div class="finder-error">
            <strong>Search failed:</strong> ${e.message || 'Unknown error'}
            ${e.message && e.message.includes('Failed to fetch') ? '<br>This may be a CORS restriction. Try opening the page directly or using a local server.' : ''}
        </div>`;
    }

    btn.disabled = false;
    setTimeout(() => progressEl.classList.remove('active'), 2000);
}

function renderFinderResults(station) {
    const area = document.getElementById('finderResultsArea');
    if (finderResults.length === 0) {
        area.innerHTML = '<div class="finder-no-results">No parcels matched your filters. Try expanding the search radius or adjusting filters.</div>';
        return;
    }

    const zoneBadge = (z) => `<span class="zone-badge ${z}">${z.charAt(0).toUpperCase() + z.slice(1)}</span>`;
    const ratioClass = (r) => r < 0.5 ? 'imp-ratio-hot' : r < 1.0 ? 'imp-ratio-warm' : 'imp-ratio-cool';
    const fmt = (v) => v ? '$' + v.toLocaleString() : '-';

    let html = `<div class="finder-summary">${finderResults.length} opportunities near <strong>${station.name}</strong> sorted by development potential</div>`;
    html += `<div class="finder-table-wrapper"><table class="finder-table">
        <thead><tr>
            <th onclick="sortFinderTable('address')">Address</th>
            <th onclick="sortFinderTable('apn')">APN</th>
            <th onclick="sortFinderTable('lotSizeSqFt')">Lot Size</th>
            <th onclick="sortFinderTable('useType')">Use</th>
            <th onclick="sortFinderTable('yearBuilt')">Year Built</th>
            <th onclick="sortFinderTable('landVal')">Land Value</th>
            <th onclick="sortFinderTable('impVal')">Imp Value</th>
            <th onclick="sortFinderTable('impRatio')" class="${finderSortCol === 'impRatio' ? (finderSortAsc ? 'sort-asc' : 'sort-desc') : ''}">Imp/Land</th>
            <th onclick="sortFinderTable('zone')">SB 79 Zone</th>
            <th>Allowances</th>
        </tr></thead><tbody>`;

    finderResults.forEach((r, i) => {
        const allow = r.allowances;
        const allowStr = allow ? `${allow.height}ft / ${allow.density}du / ${allow.far}FAR` : '-';
        html += `<tr onclick="highlightFinderParcel(${i})" id="finderRow${i}">
            <td>${r.address}</td>
            <td>${r.apn}</td>
            <td>${r.lotSizeSqFt > 0 ? r.lotSizeSqFt.toLocaleString() + ' sf' : '-'}</td>
            <td>${r.useType}</td>
            <td>${r.yearBuilt > 0 ? r.yearBuilt : '-'}</td>
            <td>${fmt(r.landVal)}</td>
            <td>${fmt(r.impVal)}</td>
            <td class="${ratioClass(r.impRatio)}">${r.impRatio < 100 ? r.impRatio.toFixed(2) : 'N/A'}</td>
            <td>${zoneBadge(r.zone)}</td>
            <td style="font-size:0.75rem;">${allowStr}</td>
        </tr>`;
    });

    html += '</tbody></table></div>';
    html += `<button type="button" class="finder-btn-export" onclick="exportFinderCSV()">Export CSV (${finderResults.length} rows)</button>`;
    area.innerHTML = html;

    // Update sort indicators
    document.querySelectorAll('.finder-table th').forEach(th => {
        th.classList.remove('sort-asc', 'sort-desc');
    });
}

function sortFinderTable(col) {
    if (finderSortCol === col) {
        finderSortAsc = !finderSortAsc;
    } else {
        finderSortCol = col;
        finderSortAsc = true;
    }

    finderResults.sort((a, b) => {
        let va = a[col], vb = b[col];
        if (typeof va === 'string') {
            va = va.toLowerCase(); vb = (vb || '').toLowerCase();
            return finderSortAsc ? va.localeCompare(vb) : vb.localeCompare(va);
        }
        va = va || 0; vb = vb || 0;
        return finderSortAsc ? va - vb : vb - va;
    });

    // Re-render with current station
    const sel = document.getElementById('finderStation');
    const station = METRO_STATIONS[parseInt(sel.value)];
    renderFinderResults(station);

    // Re-apply sort indicator
    const headers = document.querySelectorAll('.finder-table th');
    const colMap = ['address', 'apn', 'lotSizeSqFt', 'useType', 'yearBuilt', 'landVal', 'impVal', 'impRatio', 'zone'];
    headers.forEach((th, i) => {
        if (colMap[i] === col) {
            th.classList.add(finderSortAsc ? 'sort-asc' : 'sort-desc');
        }
    });
}

function addFinderParcelsToMap(station) {
    if (!sb79Map) return;
    // Remove previous finder layer
    if (finderParcelLayer) {
        sb79Map.removeLayer(finderParcelLayer);
    }
    finderParcelLayer = L.layerGroup().addTo(sb79Map);

    finderResults.forEach((r, i) => {
        if (!r.lat || !r.lon) return;
        // Color by imp ratio: red=underbuilt, orange=moderate, green=built-out
        let color = '#38a169'; // green
        if (r.impRatio < 0.5) color = '#e53e3e'; // hot
        else if (r.impRatio < 1.0) color = '#dd6b20'; // warm

        const marker = L.circleMarker([r.lat, r.lon], {
            radius: 5, fillColor: color, color: '#fff',
            weight: 1, opacity: 0.9, fillOpacity: 0.8,
        });

        const allow = r.allowances;
        const allowStr = allow ? `Height: ${allow.height}ft | Density: ${allow.density}du/ac | FAR: ${allow.far}` : '';
        marker.bindPopup(`<div style="font-size:0.82rem;">
            <strong>${r.address}</strong><br>
            APN: ${r.apn}<br>
            Use: ${r.useType} | Lot: ${r.lotSizeSqFt > 0 ? r.lotSizeSqFt.toLocaleString() + ' sf' : '-'}<br>
            Imp/Land Ratio: <strong>${r.impRatio < 100 ? r.impRatio.toFixed(2) : 'N/A'}</strong><br>
            Land: $${(r.landVal || 0).toLocaleString()} | Imp: $${(r.impVal || 0).toLocaleString()}<br>
            <em>SB 79 Zone: ${r.zone} ${allowStr ? '| ' + allowStr : ''}</em>
        </div>`);

        marker.on('click', () => {
            // Highlight corresponding table row
            document.querySelectorAll('.finder-table tr.highlighted').forEach(tr => tr.classList.remove('highlighted'));
            const row = document.getElementById('finderRow' + i);
            if (row) {
                row.classList.add('highlighted');
                row.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        });

        marker.addTo(finderParcelLayer);
    });

    // Add legend items for finder
    const legend = document.getElementById('mapLegend');
    if (legend && finderResults.length > 0) {
        const finderLegend = document.createElement('div');
        finderLegend.className = 'legend-item';
        finderLegend.id = 'finderLegendItems';
        finderLegend.innerHTML = `
            <span class="legend-dot" style="background:#e53e3e;"></span> Hot Opp (&lt;0.5)
            &nbsp;<span class="legend-dot" style="background:#dd6b20;"></span> Warm (&lt;1.0)
            &nbsp;<span class="legend-dot" style="background:#38a169;"></span> Built-out
        `;
        // Remove old finder legend if present
        const old = document.getElementById('finderLegendItems');
        if (old) old.remove();
        legend.appendChild(finderLegend);
    }
}

function highlightFinderParcel(idx) {
    const r = finderResults[idx];
    if (!r || !sb79Map) return;

    // Highlight table row
    document.querySelectorAll('.finder-table tr.highlighted').forEach(tr => tr.classList.remove('highlighted'));
    const row = document.getElementById('finderRow' + idx);
    if (row) row.classList.add('highlighted');

    // Pan map to parcel
    sb79Map.setView([r.lat, r.lon], 17);

    // Open popup on the matching marker
    if (finderParcelLayer) {
        let i = 0;
        finderParcelLayer.eachLayer(layer => {
            if (i === idx && layer.openPopup) {
                layer.openPopup();
            }
            i++;
        });
    }
}

function exportFinderCSV() {
    if (finderResults.length === 0) return;
    const headers = ['Address', 'APN', 'Lot Size (sf)', 'Use Type', 'Year Built', 'Land Value', 'Imp Value', 'Imp/Land Ratio', 'SB79 Zone', 'Max Height (ft)', 'Max Density (du/ac)', 'Max FAR', 'Parking Req', 'Latitude', 'Longitude'];
    const rows = finderResults.map(r => {
        const a = r.allowances || {};
        return [
            `"${(r.address || '').replace(/"/g, '""')}"`,
            r.apn, r.lotSizeSqFt, r.useType, r.yearBuilt || '',
            r.landVal, r.impVal, r.impRatio < 100 ? r.impRatio.toFixed(3) : '',
            r.zone, a.height || '', a.density || '', a.far || '', a.parking ?? '',
            r.lat, r.lon,
        ].join(',');
    });
    const csv = [headers.join(','), ...rows].join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `sb79-opportunities-${new Date().toISOString().slice(0, 10)}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// ============================================================
//  TAB NAVIGATION & STANDALONE FINDER
// ============================================================

let activeTab = 'calculator';
let finderMapInstance = null;
let finderMapInitialized = false;
let finderParcelLayer2 = null;
let finderResults2 = [];
let finderSortCol2 = 'impRatio';
let finderSortAsc2 = true;

function switchTab(tab) {
    activeTab = tab;
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.textContent.toLowerCase().includes(
            tab === 'calculator' ? 'hbu' : 'opportunity'
        ));
    });
    document.getElementById('tabCalculator').classList.toggle('active', tab === 'calculator');
    document.getElementById('tabFinder').classList.toggle('active', tab === 'finder');

    if (tab === 'finder' && !finderMapInitialized) {
        setTimeout(() => initFinderMap(), 100);
    } else if (tab === 'finder' && finderMapInstance) {
        setTimeout(() => finderMapInstance.invalidateSize(), 100);
    }
}

function initFinderMap() {
    const mapEl = document.getElementById('finderMap');
    if (!mapEl) return;

    if (finderMapInstance) { finderMapInstance.remove(); finderMapInstance = null; }

    finderMapInstance = L.map('finderMap').setView([34.05, -118.25], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
        maxZoom: 18,
    }).addTo(finderMapInstance);

    // Add all station markers
    const seenCoords = new Set();
    METRO_STATIONS.forEach((s, idx) => {
        const key = `${s.lat.toFixed(4)},${s.lon.toFixed(4)},${s.line}`;
        if (seenCoords.has(key)) return;
        seenCoords.add(key);

        const color = LINE_COLORS[s.line] || '#718096';
        const icon = L.divIcon({
            html: `<div style="background:${color};width:10px;height:10px;border-radius:50%;border:2px solid #fff;box-shadow:0 1px 3px rgba(0,0,0,0.3);"></div>`,
            iconSize: [10, 10], iconAnchor: [5, 5], className: '',
        });
        const tierData = SB79_TIERS[s.tier];
        const lineName = LINE_LABELS[s.line] || s.line;
        const popupHtml = `<div class="station-popup">
            <div class="popup-title">${s.name}</div>
            <div class="popup-line">${lineName} &mdash; ${tierData.label}</div>
            <div class="popup-allowances">
                <span><strong>SB 79 Allowances:</strong></span>
                <span>Height: ${tierData.height} ft | Density: ${tierData.density} du/ac</span>
                <span>FAR: ${tierData.far} | Parking: 0 (inner), 0.5/unit (outer)</span>
            </div>
        </div>`;
        const marker = L.marker([s.lat, s.lon], { icon })
            .bindPopup(popupHtml)
            .on('click', () => {
                selectFinderStation2(idx);
                drawFinderStationRadii(s);
            });
        marker.addTo(finderMapInstance);
    });

    // Render legend
    renderFinderMapLegend();

    // Populate station dropdown
    populateFinderStations2();

    finderMapInitialized = true;
    setTimeout(() => { if (finderMapInstance) finderMapInstance.invalidateSize(); }, 200);
}

function drawFinderStationRadii(station) {
    // Remove old radii if any
    if (finderMapInstance._finderRadii) {
        finderMapInstance._finderRadii.forEach(c => finderMapInstance.removeLayer(c));
    }
    const tierColor = station.tier === 1 ? '#805ad5' : '#3182ce';
    const circles = [];

    circles.push(L.circle([station.lat, station.lon], {
        radius: 61, color: tierColor, weight: 2, opacity: 0.8,
        fillColor: tierColor, fillOpacity: 0.15,
    }).bindPopup(`<strong>${station.name}</strong><br>200ft Adjacent Zone`).addTo(finderMapInstance));

    circles.push(L.circle([station.lat, station.lon], {
        radius: 402, color: tierColor, weight: 1.5, opacity: 0.6,
        fillColor: tierColor, fillOpacity: 0.07, dashArray: '8,6',
    }).bindPopup(`<strong>${station.name}</strong><br>1/4 Mile Inner Zone`).addTo(finderMapInstance));

    circles.push(L.circle([station.lat, station.lon], {
        radius: 805, color: tierColor, weight: 1, opacity: 0.4,
        fillColor: tierColor, fillOpacity: 0.03, dashArray: '4,8',
    }).bindPopup(`<strong>${station.name}</strong><br>1/2 Mile Outer Zone`).addTo(finderMapInstance));

    finderMapInstance._finderRadii = circles;
    finderMapInstance.setView([station.lat, station.lon], 14);
}

function renderFinderMapLegend() {
    const el = document.getElementById('finderMapLegend');
    if (!el) return;
    el.innerHTML = `
        <div class="legend-item"><span class="legend-dot" style="background:#e53e3e;"></span> Red/B Line</div>
        <div class="legend-item"><span class="legend-dot" style="background:#805ad5;"></span> Purple/D Line</div>
        <div class="legend-item"><span class="legend-dot" style="background:#3182ce;"></span> Blue/A Line</div>
        <div class="legend-item"><span class="legend-dot" style="background:#d69e2e;"></span> Expo/E Line</div>
        <div class="legend-item"><span class="legend-dot" style="background:#b7791f;"></span> Gold/L Line</div>
        <div class="legend-item"><span class="legend-dot" style="background:#38a169;"></span> Green/C Line</div>
        <div class="legend-item"><span class="legend-dot" style="background:#00bcd4;"></span> K Line</div>
        <div class="legend-item"><span class="legend-dot" style="background:#ed64a6;"></span> Regional Connector</div>
        <div class="legend-item"><span class="legend-dot" style="background:#e53e3e;border:2px solid #999;width:8px;height:8px;"></span> Metrolink</div>
        <div class="legend-item"><span class="legend-line" style="background:#805ad5;"></span> Tier 1 Zone</div>
        <div class="legend-item"><span class="legend-line" style="background:#3182ce;"></span> Tier 2 Zone</div>
    `;
}

function populateFinderStations2() {
    const sel = document.getElementById('finderStation2');
    if (!sel) return;
    sel.innerHTML = '';
    const grouped = {};
    METRO_STATIONS.forEach((s, idx) => {
        const lineKey = s.line;
        if (!grouped[lineKey]) grouped[lineKey] = [];
        grouped[lineKey].push({ ...s, idx });
    });
    const lineOrder = ['red', 'purple', 'blue_a', 'expo_e', 'gold_l', 'green_c', 'k_line', 'connector', 'metrolink'];
    for (const lineKey of lineOrder) {
        if (!grouped[lineKey]) continue;
        const grp = document.createElement('optgroup');
        grp.label = LINE_LABELS[lineKey] || lineKey;
        for (const s of grouped[lineKey]) {
            const opt = document.createElement('option');
            opt.value = s.idx;
            opt.textContent = s.name;
            grp.appendChild(opt);
        }
        sel.appendChild(grp);
    }
}

function selectFinderStation2(idx) {
    const sel = document.getElementById('finderStation2');
    if (sel && sel.querySelector(`option[value="${idx}"]`)) {
        sel.value = idx;
    }
}

// Wire station dropdown change to zoom map
document.addEventListener('change', (e) => {
    if (e.target.id === 'finderStation2' && finderMapInstance) {
        const idx = parseInt(e.target.value);
        const station = METRO_STATIONS[idx];
        if (station) {
            drawFinderStationRadii(station);
        }
    }
});

async function runStandaloneSearch() {
    const sel = document.getElementById('finderStation2');
    const stationIdx = parseInt(sel.value);
    const station = METRO_STATIONS[stationIdx];
    if (!station) return;

    const checked = document.querySelector('input[name="finderRadius2"]:checked');
    const radiusFt = checked ? parseInt(checked.value) : 2640;
    const useChecks = document.querySelectorAll('.finderUseType2:checked');
    const useTypes = Array.from(useChecks).map(c => c.value);
    const minLot = parseInt(document.getElementById('finderMinLot2').value) || 0;
    const maxLot = parseInt(document.getElementById('finderMaxLot2').value) || 999999;
    const maxRatio = parseFloat(document.getElementById('finderMaxRatio2').value);
    const yearBefore = parseInt(document.getElementById('finderYearBefore2').value) || 0;

    const filters = { useTypes, minLot, maxLot, maxRatio, yearBefore };

    const progressEl = document.getElementById('finderProgress2');
    const fillEl = document.getElementById('finderProgressFill2');
    const textEl = document.getElementById('finderProgressText2');
    const btn = document.getElementById('finderSearchBtn2');
    const resultsArea = document.getElementById('finderResultsArea2');

    progressEl.classList.add('active');
    fillEl.style.width = '0%';
    textEl.textContent = 'Querying parcels near ' + station.name + '...';
    btn.disabled = true;
    resultsArea.innerHTML = '';

    // Draw station radii on map
    drawFinderStationRadii(station);

    try {
        const features = await queryParcelsNearStation(
            station.lat, station.lon, radiusFt,
            (loaded, est) => {
                const pct = Math.min(90, Math.round((loaded / Math.max(est, 1)) * 90));
                fillEl.style.width = pct + '%';
                textEl.textContent = `Loading... ${loaded} parcels fetched`;
            }
        );

        fillEl.style.width = '95%';
        textEl.textContent = `Filtering ${features.length} parcels...`;

        finderResults2 = filterAndScoreResults(features, station, filters);

        finderSortCol2 = 'impRatio';
        finderSortAsc2 = true;
        finderResults2.sort((a, b) => a.impRatio - b.impRatio);

        fillEl.style.width = '100%';
        textEl.textContent = `Found ${finderResults2.length} opportunities from ${features.length} parcels`;

        renderFinderResults2(station);
        addFinderParcelsToMap2(station);

    } catch (e) {
        console.error('Standalone opportunity search failed:', e);
        resultsArea.innerHTML = `<div class="finder-error">
            <strong>Search failed:</strong> ${e.message || 'Unknown error'}
            ${e.message && e.message.includes('Failed to fetch') ? '<br>This may be a CORS restriction. Try opening the page directly or using a local server.' : ''}
        </div>`;
    }

    btn.disabled = false;
    setTimeout(() => progressEl.classList.remove('active'), 2000);
}

function renderFinderResults2(station) {
    const area = document.getElementById('finderResultsArea2');
    if (finderResults2.length === 0) {
        area.innerHTML = '<div class="finder-no-results">No parcels matched your filters. Try expanding the search radius or adjusting filters.</div>';
        return;
    }

    const zoneBadge = (z) => `<span class="zone-badge ${z}">${z.charAt(0).toUpperCase() + z.slice(1)}</span>`;
    const ratioClass = (r) => r < 0.5 ? 'imp-ratio-hot' : r < 1.0 ? 'imp-ratio-warm' : 'imp-ratio-cool';
    const fmt = (v) => v ? '$' + v.toLocaleString() : '-';

    let html = `<div class="finder-summary">${finderResults2.length} opportunities near <strong>${station.name}</strong> sorted by development potential</div>`;
    html += `<div class="finder-table-wrapper"><table class="finder-table" id="finderTable2">
        <thead><tr>
            <th onclick="sortFinderTable2('address')">Address</th>
            <th onclick="sortFinderTable2('apn')">APN</th>
            <th onclick="sortFinderTable2('lotSizeSqFt')">Lot Size</th>
            <th onclick="sortFinderTable2('useType')">Use</th>
            <th onclick="sortFinderTable2('yearBuilt')">Year Built</th>
            <th onclick="sortFinderTable2('landVal')">Land Value</th>
            <th onclick="sortFinderTable2('impVal')">Imp Value</th>
            <th onclick="sortFinderTable2('impRatio')" class="${finderSortCol2 === 'impRatio' ? (finderSortAsc2 ? 'sort-asc' : 'sort-desc') : ''}">Imp/Land</th>
            <th onclick="sortFinderTable2('zone')">SB 79 Zone</th>
            <th>Allowances</th>
        </tr></thead><tbody>`;

    finderResults2.forEach((r, i) => {
        const allow = r.allowances;
        const allowStr = allow ? `${allow.height}ft / ${allow.density}du / ${allow.far}FAR` : '-';
        html += `<tr onclick="highlightFinderParcel2(${i})" id="finderRow2_${i}">
            <td>${r.address}</td>
            <td>${r.apn}</td>
            <td>${r.lotSizeSqFt > 0 ? r.lotSizeSqFt.toLocaleString() + ' sf' : '-'}</td>
            <td>${r.useType}</td>
            <td>${r.yearBuilt > 0 ? r.yearBuilt : '-'}</td>
            <td>${fmt(r.landVal)}</td>
            <td>${fmt(r.impVal)}</td>
            <td class="${ratioClass(r.impRatio)}">${r.impRatio < 100 ? r.impRatio.toFixed(2) : 'N/A'}</td>
            <td>${zoneBadge(r.zone)}</td>
            <td style="font-size:0.75rem;">${allowStr}</td>
        </tr>`;
    });

    html += '</tbody></table></div>';
    html += `<button type="button" class="finder-btn-export" onclick="exportFinderCSV2()">Export CSV (${finderResults2.length} rows)</button>`;
    area.innerHTML = html;
}

function sortFinderTable2(col) {
    if (finderSortCol2 === col) {
        finderSortAsc2 = !finderSortAsc2;
    } else {
        finderSortCol2 = col;
        finderSortAsc2 = true;
    }

    finderResults2.sort((a, b) => {
        let va = a[col], vb = b[col];
        if (typeof va === 'string') {
            va = va.toLowerCase(); vb = (vb || '').toLowerCase();
            return finderSortAsc2 ? va.localeCompare(vb) : vb.localeCompare(va);
        }
        va = va || 0; vb = vb || 0;
        return finderSortAsc2 ? va - vb : vb - va;
    });

    const sel = document.getElementById('finderStation2');
    const station = METRO_STATIONS[parseInt(sel.value)];
    renderFinderResults2(station);

    const headers = document.querySelectorAll('#finderTable2 th');
    const colMap = ['address', 'apn', 'lotSizeSqFt', 'useType', 'yearBuilt', 'landVal', 'impVal', 'impRatio', 'zone'];
    headers.forEach((th, i) => {
        if (colMap[i] === col) {
            th.classList.add(finderSortAsc2 ? 'sort-asc' : 'sort-desc');
        }
    });
}

function addFinderParcelsToMap2(station) {
    if (!finderMapInstance) return;
    if (finderParcelLayer2) {
        finderMapInstance.removeLayer(finderParcelLayer2);
    }
    finderParcelLayer2 = L.layerGroup().addTo(finderMapInstance);

    finderResults2.forEach((r, i) => {
        if (!r.lat || !r.lon) return;
        let color = '#38a169';
        if (r.impRatio < 0.5) color = '#e53e3e';
        else if (r.impRatio < 1.0) color = '#dd6b20';

        const marker = L.circleMarker([r.lat, r.lon], {
            radius: 5, fillColor: color, color: '#fff',
            weight: 1, opacity: 0.9, fillOpacity: 0.8,
        });

        const allow = r.allowances;
        const allowStr = allow ? `Height: ${allow.height}ft | Density: ${allow.density}du/ac | FAR: ${allow.far}` : '';
        marker.bindPopup(`<div style="font-size:0.82rem;">
            <strong>${r.address}</strong><br>
            APN: ${r.apn}<br>
            Use: ${r.useType} | Lot: ${r.lotSizeSqFt > 0 ? r.lotSizeSqFt.toLocaleString() + ' sf' : '-'}<br>
            Imp/Land Ratio: <strong>${r.impRatio < 100 ? r.impRatio.toFixed(2) : 'N/A'}</strong><br>
            Land: $${(r.landVal || 0).toLocaleString()} | Imp: $${(r.impVal || 0).toLocaleString()}<br>
            <em>SB 79 Zone: ${r.zone} ${allowStr ? '| ' + allowStr : ''}</em>
        </div>`);

        marker.on('click', () => {
            document.querySelectorAll('#finderTable2 tr.highlighted').forEach(tr => tr.classList.remove('highlighted'));
            const row = document.getElementById('finderRow2_' + i);
            if (row) {
                row.classList.add('highlighted');
                row.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        });

        marker.addTo(finderParcelLayer2);
    });

    // Add opportunity legend to finder map
    const legend = document.getElementById('finderMapLegend');
    if (legend && finderResults2.length > 0) {
        const oldLeg = document.getElementById('finderOppLegendItems');
        if (oldLeg) oldLeg.remove();
        const finderLegend = document.createElement('div');
        finderLegend.className = 'legend-item';
        finderLegend.id = 'finderOppLegendItems';
        finderLegend.innerHTML = `
            <span class="legend-dot" style="background:#e53e3e;"></span> Hot Opp (&lt;0.5)
            &nbsp;<span class="legend-dot" style="background:#dd6b20;"></span> Warm (&lt;1.0)
            &nbsp;<span class="legend-dot" style="background:#38a169;"></span> Built-out
        `;
        legend.appendChild(finderLegend);
    }
}

function highlightFinderParcel2(idx) {
    const r = finderResults2[idx];
    if (!r || !finderMapInstance) return;

    document.querySelectorAll('#finderTable2 tr.highlighted').forEach(tr => tr.classList.remove('highlighted'));
    const row = document.getElementById('finderRow2_' + idx);
    if (row) row.classList.add('highlighted');

    finderMapInstance.setView([r.lat, r.lon], 17);

    if (finderParcelLayer2) {
        let i = 0;
        finderParcelLayer2.eachLayer(layer => {
            if (i === idx && layer.openPopup) {
                layer.openPopup();
            }
            i++;
        });
    }
}

function exportFinderCSV2() {
    if (finderResults2.length === 0) return;
    const headers = ['Address', 'APN', 'Lot Size (sf)', 'Use Type', 'Year Built', 'Land Value', 'Imp Value', 'Imp/Land Ratio', 'SB79 Zone', 'Max Height (ft)', 'Max Density (du/ac)', 'Max FAR', 'Parking Req', 'Latitude', 'Longitude'];
    const rows = finderResults2.map(r => {
        const a = r.allowances || {};
        return [
            `"${(r.address || '').replace(/"/g, '""')}"`,
            r.apn, r.lotSizeSqFt, r.useType, r.yearBuilt || '',
            r.landVal, r.impVal, r.impRatio < 100 ? r.impRatio.toFixed(3) : '',
            r.zone, a.height || '', a.density || '', a.far || '', a.parking ?? '',
            r.lat, r.lon,
        ].join(',');
    });
    const csv = [headers.join(','), ...rows].join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `sb79-opportunities-${new Date().toISOString().slice(0, 10)}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}


// Close modals on Escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        const legModal = document.getElementById('legDetailModal');
        if (legModal && legModal.style.display !== 'none') {
            closeLegislationDetail();
            return;
        }
        if (document.getElementById('analysisModal').style.display === 'block') {
            closeAnalysis();
        }
    }
});
</script>

</body>
</html>
