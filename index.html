<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Highest &amp; Best Use Calculator â€” Los Angeles, CA</title>
    <style>
        :root {
            --primary: #1a365d;
            --primary-light: #2b6cb0;
            --accent: #e8a838;
            --accent-dark: #c77e1a;
            --bg: #f7fafc;
            --card: #ffffff;
            --text: #2d3748;
            --text-light: #718096;
            --border: #e2e8f0;
            --success: #38a169;
            --gold: #d4a020;
            --silver: #8a8a8a;
            --bronze: #b87333;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        header {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        header h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        header p {
            font-size: 1rem;
            opacity: 0.85;
        }

        .badge {
            display: inline-block;
            background: var(--accent);
            color: var(--primary);
            font-weight: 700;
            padding: 0.2rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-top: 0.5rem;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
        }

        .intro-box {
            background: var(--card);
            border-left: 4px solid var(--accent);
            padding: 1.25rem 1.5rem;
            border-radius: 0 8px 8px 0;
            margin-bottom: 2rem;
            box-shadow: 0 2px 6px rgba(0,0,0,0.06);
        }

        .intro-box h3 { color: var(--primary); margin-bottom: 0.5rem; }
        .intro-box p { font-size: 0.92rem; color: var(--text-light); }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        @media (max-width: 768px) {
            .form-grid { grid-template-columns: 1fr; }
            header h1 { font-size: 1.5rem; }
        }

        .section {
            background: var(--card);
            border-radius: 12px;
            padding: 1.75rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .section h2 {
            font-size: 1.1rem;
            color: var(--primary);
            border-bottom: 2px solid var(--border);
            padding-bottom: 0.5rem;
            margin-bottom: 1.25rem;
        }

        .field { margin-bottom: 1.1rem; }
        .field:last-child { margin-bottom: 0; }

        label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 0.3rem;
        }

        label .hint {
            font-weight: 400;
            color: var(--text-light);
            font-size: 0.78rem;
        }

        select, input[type="number"], input[type="text"] {
            width: 100%;
            padding: 0.6rem 0.75rem;
            border: 1.5px solid var(--border);
            border-radius: 8px;
            font-size: 0.92rem;
            color: var(--text);
            background: #fff;
            transition: border-color 0.2s;
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(43,108,176,0.12);
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.88rem;
        }

        .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--primary-light);
        }

        /* Address Lookup */
        .address-section {
            background: var(--card);
            border-radius: 12px;
            padding: 1.75rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            margin-bottom: 2rem;
            border: 2px solid var(--primary-light);
        }

        .address-section h2 {
            font-size: 1.1rem;
            color: var(--primary);
            border-bottom: 2px solid var(--border);
            padding-bottom: 0.5rem;
            margin-bottom: 1.25rem;
        }

        .address-row {
            display: flex;
            gap: 0.75rem;
            align-items: flex-end;
        }

        .address-row .field { flex: 1; margin-bottom: 0; }

        .btn-lookup {
            padding: 0.6rem 1.5rem;
            font-size: 0.92rem;
            font-weight: 700;
            color: white;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border: none;
            border-radius: 8px;
            cursor: pointer;
            white-space: nowrap;
            transition: transform 0.15s, box-shadow 0.15s;
            box-shadow: 0 2px 8px rgba(26,54,93,0.25);
            height: 40px;
        }

        .btn-lookup:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(26,54,93,0.35);
        }

        .btn-lookup:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .lookup-status {
            margin-top: 0.75rem;
            font-size: 0.85rem;
            min-height: 1.4em;
        }

        .lookup-status .status-item {
            display: inline-block;
            margin-right: 1rem;
            margin-bottom: 0.25rem;
        }

        .lookup-status .ok { color: var(--success); }
        .lookup-status .warn { color: var(--accent-dark); }
        .lookup-status .err { color: #e53e3e; }
        .lookup-status .loading { color: var(--primary-light); }

        .autofill-notice {
            display: none;
            background: #ebf8ff;
            border: 1px solid #bee3f8;
            border-radius: 8px;
            padding: 0.7rem 1rem;
            font-size: 0.82rem;
            color: #2b6cb0;
            margin-top: 0.75rem;
        }

        .autofill-notice.visible { display: block; }

        .field.autofilled select,
        .field.autofilled input {
            border-color: #4299e1;
            background: #ebf8ff;
        }

        .field .autofill-badge {
            display: none;
            font-size: 0.7rem;
            color: #4299e1;
            font-weight: 400;
            margin-left: 0.4rem;
        }

        .field.autofilled .autofill-badge { display: inline; }

        @media (max-width: 768px) {
            .address-row { flex-direction: column; }
            .btn-lookup { width: 100%; }
        }

        .btn-calculate {
            display: block;
            width: 100%;
            max-width: 400px;
            margin: 2rem auto;
            padding: 1rem 2rem;
            font-size: 1.15rem;
            font-weight: 700;
            color: white;
            background: linear-gradient(135deg, var(--accent-dark), var(--accent));
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
            box-shadow: 0 4px 12px rgba(232,168,56,0.35);
        }

        .btn-calculate:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(232,168,56,0.45);
        }

        .btn-calculate:active { transform: translateY(0); }

        /* Results */
        #results {
            display: none;
            margin-top: 1rem;
        }

        #results.visible { display: block; }

        .results-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .results-header h2 {
            font-size: 1.5rem;
            color: var(--primary);
        }

        .results-header p {
            color: var(--text-light);
            font-size: 0.92rem;
        }

        .result-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 900px) {
            .result-cards { grid-template-columns: 1fr; }
        }

        .result-card {
            background: var(--card);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            transition: transform 0.2s;
        }

        .result-card:hover { transform: translateY(-4px); }

        .result-card .rank-banner {
            text-align: center;
            padding: 1rem;
            color: white;
            font-size: 0.9rem;
            font-weight: 700;
        }

        .rank-1 .rank-banner { background: linear-gradient(135deg, #b8860b, #daa520); }
        .rank-2 .rank-banner { background: linear-gradient(135deg, #6a6a6a, #a0a0a0); }
        .rank-3 .rank-banner { background: linear-gradient(135deg, #8b4513, #cd853f); }

        .rank-banner .rank-num {
            display: block;
            font-size: 2rem;
            line-height: 1;
        }

        .result-card .card-body {
            padding: 1.5rem;
        }

        .result-card .use-name {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.75rem;
        }

        .score-bar-container {
            margin-bottom: 0.75rem;
        }

        .score-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .score-bar {
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }

        .score-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.8s ease-out;
        }

        .score-bar-fill.legal { background: #4299e1; }
        .score-bar-fill.physical { background: #48bb78; }
        .score-bar-fill.financial { background: #ed8936; }
        .score-bar-fill.productive { background: #9f7aea; }

        .overall-score {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .overall-score .big-score {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary);
        }

        .overall-score span {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .rationale {
            margin-top: 1rem;
            font-size: 0.85rem;
            color: var(--text-light);
            line-height: 1.5;
        }

        /* Key Metrics section on result cards */
        .key-metrics {
            margin-top: 1rem;
            padding-top: 0.85rem;
            border-top: 1px dashed var(--border);
        }

        .key-metrics-title {
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-light);
            margin-bottom: 0.5rem;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.4rem;
        }

        .metric-item {
            background: #f7fafc;
            border-radius: 6px;
            padding: 0.4rem 0.55rem;
        }

        .metric-icon-label {
            font-size: 0.68rem;
            color: var(--text-light);
            margin-bottom: 0.15rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .metric-value {
            font-size: 0.88rem;
            font-weight: 700;
            color: var(--text);
        }

        .metric-value.positive { color: #276749; }
        .metric-value.caution  { color: #b7791f; }
        .metric-value.negative { color: #c53030; }

        .risk-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.78rem;
            font-weight: 700;
            padding: 0.15rem 0.5rem;
            border-radius: 999px;
        }

        .risk-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            display: inline-block;
        }

        .ease-bar-bg {
            width: 100%;
            height: 5px;
            background: #e2e8f0;
            border-radius: 3px;
            margin-top: 0.25rem;
            overflow: hidden;
        }

        .ease-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.4s ease;
        }

        /* Details table */
        .details-section {
            background: var(--card);
            border-radius: 12px;
            padding: 1.75rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            margin-bottom: 2rem;
        }

        .details-section h3 {
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .details-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.88rem;
        }

        .details-table th {
            background: var(--primary);
            color: white;
            padding: 0.65rem 0.75rem;
            text-align: left;
            font-weight: 600;
        }

        .details-table th:first-child { border-radius: 8px 0 0 0; }
        .details-table th:last-child { border-radius: 0 8px 0 0; }

        .details-table td {
            padding: 0.6rem 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .details-table tr:nth-child(even) { background: #f8fafc; }
        .details-table tr.top-3 { font-weight: 600; }
        .details-table tr.top-3 td:first-child { color: var(--primary); }

        .pass { color: var(--success); font-weight: 600; }
        .fail { color: #e53e3e; font-weight: 600; }
        .partial { color: var(--accent-dark); font-weight: 600; }

        .disclaimer {
            background: #fffbeb;
            border: 1px solid #f6e05e;
            border-radius: 8px;
            padding: 1rem 1.25rem;
            font-size: 0.82rem;
            color: #744210;
            margin-top: 1rem;
        }

        footer {
            text-align: center;
            padding: 2rem;
            color: var(--text-light);
            font-size: 0.82rem;
            border-top: 1px solid var(--border);
            margin-top: 2rem;
        }

        /* Print / Export Button */
        .btn-print {
            display: none;
            width: 100%;
            max-width: 400px;
            margin: 0 auto 2rem;
            padding: 0.85rem 2rem;
            font-size: 1rem;
            font-weight: 700;
            color: white;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
            box-shadow: 0 4px 12px rgba(26,54,93,0.3);
        }

        .btn-print.visible { display: block; }

        .btn-print:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(26,54,93,0.4);
        }

        .btn-print:active { transform: translateY(0); }

        .print-date {
            display: none;
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-light);
            margin-bottom: 1rem;
        }

        /* Print Styles */
        @media print {
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; color-adjust: exact !important; }

            body { background: white; font-size: 11pt; }

            header {
                background: var(--primary) !important;
                -webkit-print-color-adjust: exact;
                padding: 1.25rem;
                box-shadow: none;
            }

            header h1 { font-size: 1.5rem; }

            .container { padding: 1rem; }

            .intro-box, .btn-calculate, .btn-print, .address-section, footer { display: none !important; }

            .form-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 1rem;
                margin-bottom: 1rem;
            }

            .section {
                box-shadow: none;
                border: 1px solid #ddd;
                padding: 1rem;
                page-break-inside: avoid;
            }

            .section h2 { font-size: 0.95rem; margin-bottom: 0.75rem; }

            .field { margin-bottom: 0.5rem; }
            label { font-size: 0.78rem; }

            select, input[type="number"], input[type="text"] {
                border: none;
                padding: 0;
                font-size: 0.82rem;
                font-weight: 600;
                color: var(--primary);
                background: transparent;
                -webkit-appearance: none;
                appearance: none;
            }

            .checkbox-item { font-size: 0.78rem; }

            #results { display: block !important; page-break-before: auto; }

            .results-header { margin-bottom: 1rem; }
            .results-header h2 { font-size: 1.2rem; }

            .result-cards {
                grid-template-columns: repeat(3, 1fr);
                gap: 0.75rem;
                margin-bottom: 1rem;
            }

            .result-card {
                box-shadow: none;
                border: 1px solid #ddd;
                page-break-inside: avoid;
            }

            .result-card:hover { transform: none; }

            .rank-banner { padding: 0.6rem; font-size: 0.8rem; }
            .rank-banner .rank-num { font-size: 1.4rem; }
            .result-card .card-body { padding: 1rem; }
            .result-card .use-name { font-size: 1rem; margin-bottom: 0.5rem; }
            .score-bar-container { margin-bottom: 0.4rem; }
            .overall-score { margin-top: 0.5rem; padding-top: 0.5rem; }
            .overall-score .big-score { font-size: 1.5rem; }
            .rationale { font-size: 0.78rem; margin-top: 0.5rem; }

            .key-metrics { margin-top: 0.5rem; padding-top: 0.5rem; }
            .key-metrics-title { font-size: 0.6rem; margin-bottom: 0.3rem; }
            .metrics-grid { gap: 0.25rem; }
            .metric-item { padding: 0.25rem 0.4rem; }
            .metric-icon-label { font-size: 0.6rem; }
            .metric-value { font-size: 0.75rem; }

            .details-section {
                box-shadow: none;
                border: 1px solid #ddd;
                padding: 1rem;
                page-break-inside: avoid;
            }

            .details-table { font-size: 0.78rem; }
            .details-table th { padding: 0.4rem 0.5rem; }
            .details-table td { padding: 0.35rem 0.5rem; }

            .disclaimer {
                font-size: 0.72rem;
                padding: 0.75rem;
                page-break-inside: avoid;
            }

            .print-date { display: block !important; }

            .legislation-section {
                page-break-inside: avoid;
                box-shadow: none;
                border: 1px solid #ddd;
                padding: 1rem;
            }
            .legislation-section .legislation-card {
                page-break-inside: avoid;
                border-left-color: #4299e1 !important;
            }
        }

        /* Legislation Section */
        .legislation-section {
            background: var(--card);
            border-radius: 12px;
            padding: 1.75rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            margin-bottom: 2rem;
        }

        .legislation-section h3 {
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .legislation-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }

        .legislation-card {
            background: #f8fafc;
            border-left: 4px solid #4299e1;
            border-radius: 0 8px 8px 0;
            padding: 1rem 1.25rem;
        }

        .legislation-card strong {
            color: var(--primary);
            font-size: 0.92rem;
            display: block;
            margin-bottom: 0.35rem;
        }

        .legislation-card p {
            color: var(--text-light);
            font-size: 0.82rem;
            margin: 0;
            line-height: 1.45;
        }

        .legislation-badge {
            display: inline-block;
            background: #ebf8ff;
            color: #2b6cb0;
            font-size: 0.7rem;
            font-weight: 600;
            padding: 0.15rem 0.5rem;
            border-radius: 12px;
            margin-right: 0.3rem;
            margin-bottom: 0.25rem;
            border: 1px solid #bee3f8;
        }

        .legislation-badges {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border);
        }

        .legislation-badges .leg-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 0.35rem;
        }

        /* Analysis Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            overflow-y: auto;
            padding: 2rem 1rem;
        }

        .modal-content {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            position: relative;
        }

        .modal-top-bar {
            position: sticky;
            top: 0;
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: rgba(255,255,255,0.95);
            border-radius: 16px 16px 0 0;
            z-index: 10;
            backdrop-filter: blur(6px);
        }

        .modal-close {
            width: 36px; height: 36px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: #f7fafc;
            font-size: 1.3rem;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            color: var(--text-light);
            transition: background 0.15s;
        }
        .modal-close:hover { background: #edf2f7; }

        .modal-print-btn {
            padding: 0.45rem 1.25rem;
            font-size: 0.85rem;
            font-weight: 700;
            color: white;
            background: var(--primary-light);
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        .modal-print-btn:hover { background: var(--primary); }

        .modal-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            padding: 1.75rem 2rem;
        }
        .modal-header h2 { font-size: 1.4rem; margin-bottom: 0.25rem; }
        .modal-header p { font-size: 0.88rem; opacity: 0.85; }

        .modal-body { padding: 2rem; }

        .analysis-section { margin-bottom: 2rem; }
        .analysis-section h3 {
            color: var(--primary);
            border-bottom: 2px solid var(--border);
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
            font-size: 1rem;
        }

        .program-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
        }
        @media (max-width: 600px) { .program-grid { grid-template-columns: repeat(2, 1fr); } }
        .program-item {
            text-align: center;
            padding: 0.85rem;
            background: #f8fafc;
            border-radius: 8px;
        }
        .program-item .program-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary);
        }
        .program-item .program-label {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-top: 0.15rem;
        }

        .rendering-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }
        @media (max-width: 700px) { .rendering-container { grid-template-columns: 1fr; } }
        .rendering-container svg {
            width: 100%;
            height: auto;
            border: 1px solid var(--border);
            border-radius: 8px;
        }

        .budget-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.82rem;
        }
        .budget-table th {
            padding: 0.35rem 0.6rem;
            text-align: right;
            font-weight: 600;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            color: var(--text-light);
            border-bottom: 2px solid var(--border);
        }
        .budget-table th:first-child { text-align: left; }
        .budget-table td {
            padding: 0.35rem 0.6rem;
            border-bottom: 1px solid var(--border);
            font-variant-numeric: tabular-nums;
        }
        .budget-table td:not(:first-child) {
            text-align: right;
            white-space: nowrap;
        }
        .budget-table td.dim {
            color: var(--text-light);
            font-size: 0.78rem;
        }
        .budget-table .section-header td {
            font-weight: 700;
            background: #f8fafc;
            color: var(--primary);
            padding-top: 0.65rem;
            border-bottom: 2px solid var(--border);
        }
        .budget-table .subtotal td {
            font-weight: 700;
            background: #f0f4f8;
        }
        .budget-table .grand-total td {
            font-weight: 700;
            background: var(--primary);
            color: white;
            font-size: 0.88rem;
            padding: 0.55rem 0.6rem;
        }
        .budget-table .pct-col {
            font-size: 0.72rem;
            color: var(--text-light);
        }

        .returns-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
            margin-bottom: 1.25rem;
        }
        @media (max-width: 700px) { .returns-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 400px) { .returns-grid { grid-template-columns: 1fr; } }
        .return-card {
            text-align: center;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 8px;
        }
        .return-card .return-value {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
        }
        .return-card .return-label {
            font-size: 0.78rem;
            color: var(--text-light);
            margin-top: 0.15rem;
        }

        .timeline-bar {
            display: flex;
            border-radius: 8px;
            overflow: hidden;
            height: 36px;
            margin-bottom: 0.5rem;
        }
        .timeline-segment {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.68rem;
            font-weight: 600;
            color: white;
            line-height: 1.2;
            text-align: center;
            padding: 0 0.25rem;
        }
        .timeline-legend {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-top: 0.35rem;
        }

        .risk-card {
            background: #fff5f5;
            border-left: 4px solid #fc8181;
            border-radius: 0 8px 8px 0;
            padding: 0.85rem 1.1rem;
            margin-bottom: 0.6rem;
        }
        .risk-card strong { color: #c53030; font-size: 0.88rem; display: block; margin-bottom: 0.2rem; }
        .risk-card p { color: var(--text-light); font-size: 0.82rem; margin: 0; line-height: 1.45; }

        .click-hint {
            font-size: 0.75rem;
            color: var(--primary-light);
            text-align: center;
            margin-top: 0.5rem;
            font-weight: 600;
        }

        /* Print: analysis modal */
        @media print {
            body.printing-analysis > *:not(#analysisModal) { display: none !important; }
            body.printing-analysis #analysisModal {
                position: static;
                padding: 0;
                background: white;
                overflow: visible;
            }
            body.printing-analysis .modal-content {
                box-shadow: none;
                border-radius: 0;
            }
            body.printing-analysis .modal-top-bar { display: none !important; }
            body.printing-analysis .modal-header {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            body.printing-analysis .analysis-section { page-break-inside: avoid; }
            body.printing-analysis .rendering-container svg { border: 1px solid #ddd; }
            body.printing-analysis .budget-table .grand-total td {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            body.printing-analysis .assumptions-panel { border-color: #ddd; background: #fafafa; }
            body.printing-analysis .assumption-input { border: none; background: transparent; padding: 0; }
            body.printing-analysis .leg-detail-overlay { display: none !important; }
        }

        /* Editable Assumptions Panel */
        .assumptions-panel {
            background: #fffdf5;
            border: 1.5px solid var(--accent);
            border-radius: 10px;
            padding: 1rem 1.25rem;
            margin-bottom: 1.5rem;
        }
        .assumptions-panel h4 {
            font-size: 0.88rem;
            color: var(--accent-dark);
            margin-bottom: 0.75rem;
            font-weight: 700;
        }
        .assumptions-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
        }
        @media (max-width: 600px) { .assumptions-grid { grid-template-columns: repeat(2, 1fr); } }
        .assumption-field {
            display: flex;
            flex-direction: column;
        }
        .assumption-field label {
            font-size: 0.72rem;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 0.2rem;
        }
        .assumption-input {
            width: 100%;
            padding: 0.45rem 0.5rem;
            border: 1.5px solid var(--border);
            border-radius: 6px;
            font-size: 0.88rem;
            font-weight: 600;
            color: var(--primary);
            background: #fffdf5;
            transition: border-color 0.2s;
        }
        .assumption-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(232,168,56,0.15);
        }
        /* Dynamic tab slider controls */
        .dt-controls {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 14px 18px;
            margin-bottom: 1.25rem;
        }
        .dt-controls-title {
            font-size: 0.78rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .dt-controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 10px 18px;
        }
        .dt-slider-group {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .dt-slider-label {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            font-size: 0.7rem;
            color: #4a5568;
        }
        .dt-slider-label .dt-val {
            font-weight: 700;
            color: var(--primary);
            font-size: 0.75rem;
        }
        .dt-slider-row {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .dt-slider-row input[type="range"] {
            flex: 1;
            height: 5px;
            -webkit-appearance: none;
            appearance: none;
            background: #e2e8f0;
            border-radius: 3px;
            outline: none;
        }
        .dt-slider-row input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            border: 2px solid #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.18);
        }
        .dt-slider-row input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            border: 2px solid #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.18);
        }
        .dt-slider-row input[type="number"] {
            width: 62px;
            padding: 3px 5px;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            font-size: 0.73rem;
            font-weight: 600;
            color: var(--primary);
            text-align: right;
            background: #fffdf5;
        }
        .dt-slider-row input[type="number"]:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(232,168,56,0.15);
        }
        .dt-reset-btn {
            font-size: 0.65rem;
            color: #a0aec0;
            border: 1px solid #e2e8f0;
            background: #fff;
            border-radius: 4px;
            padding: 2px 8px;
            cursor: pointer;
            margin-left: auto;
        }
        .dt-reset-btn:hover { color: #e53e3e; border-color: #feb2b2; }

        /* Design Configurator (Tab 11) */
        .configurator-layout {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 1.25rem;
            align-items: start;
        }
        @media (max-width: 900px) {
            .configurator-layout { grid-template-columns: 1fr; }
        }
        .configurator-panel {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 1rem 1rem 1.25rem;
            max-height: 80vh;
            overflow-y: auto;
        }
        .cfg-kpi-strip {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
            margin-bottom: 1.25rem;
        }
        @media (max-width: 600px) { .cfg-kpi-strip { grid-template-columns: repeat(2, 1fr); } }
        .cfg-kpi {
            text-align: center;
            background: #fff;
            border-radius: 8px;
            padding: 0.6rem 0.5rem;
            border: 1px solid var(--border);
        }
        .cfg-kpi-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
        }
        .cfg-kpi-label {
            font-size: 0.65rem;
            color: var(--text-light);
            margin-top: 2px;
        }
        .cfg-section-title {
            font-size: 0.7rem;
            font-weight: 700;
            color: #805ad5;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin: 0.85rem 0 0.4rem;
            padding-bottom: 0.2rem;
            border-bottom: 1px solid #e9d8fd;
        }
        .cfg-section-title:first-child { margin-top: 0; }
        .cfg-auto-display {
            font-size: 0.72rem;
            color: #718096;
            padding: 4px 0;
            display: flex;
            justify-content: space-between;
        }
        .cfg-auto-display .cfg-auto-val {
            font-weight: 700;
            color: var(--primary);
        }

        /* Clickable Legislation Cards & Badges */
        .legislation-card.clickable {
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
        }
        .legislation-card.clickable:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .legislation-badge.clickable {
            cursor: pointer;
            transition: background 0.15s;
        }
        .legislation-badge.clickable:hover {
            background: #bee3f8;
        }

        /* Legislation Detail Popup */
        .leg-detail-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.45);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        .leg-detail-content {
            background: white;
            border-radius: 14px;
            max-width: 520px;
            width: 100%;
            box-shadow: 0 16px 48px rgba(0,0,0,0.25);
            overflow: hidden;
        }
        .leg-detail-header {
            background: linear-gradient(135deg, #2b6cb0, #4299e1);
            color: white;
            padding: 1.25rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        .leg-detail-header h3 { font-size: 1.1rem; margin: 0; }
        .leg-detail-close {
            width: 28px; height: 28px;
            border-radius: 50%;
            border: none;
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 1.1rem;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }
        .leg-detail-close:hover { background: rgba(255,255,255,0.35); }
        .leg-detail-body {
            padding: 1.5rem;
        }
        .leg-detail-body .leg-summary {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-bottom: 0.75rem;
            font-style: italic;
        }
        .leg-detail-body .leg-full {
            font-size: 0.88rem;
            color: var(--text);
            line-height: 1.65;
        }
        /* SB 79 Transit Map */
        .map-section {
            background: var(--card);
            border-radius: 12px;
            padding: 1.75rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            margin-top: 2rem;
        }
        .map-section .section-header { text-align: center; margin-bottom: 1.25rem; }
        .map-section .section-header h2 { font-size: 1.3rem; color: var(--primary); margin-bottom: 0.25rem; }
        .map-section .section-subtitle { font-size: 0.88rem; color: var(--text-light); }
        #sb79Map { width: 100%; height: 500px; border-radius: 10px; border: 1.5px solid var(--border); z-index: 1; }
        .map-controls { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.75rem; justify-content: center; }
        .layer-btn {
            padding: 0.4rem 1rem; font-size: 0.82rem; font-weight: 600; border: 1.5px solid var(--border);
            border-radius: 20px; background: #fff; color: var(--text-light); cursor: pointer; transition: all 0.2s;
        }
        .layer-btn:hover { border-color: var(--primary-light); color: var(--primary); }
        .layer-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); }
        .map-legend {
            display: flex; flex-wrap: wrap; gap: 0.75rem 1.5rem; margin-top: 0.75rem;
            padding: 0.75rem 1rem; background: #f7fafc; border-radius: 8px; font-size: 0.78rem; color: var(--text-light);
        }
        .map-legend .legend-item { display: flex; align-items: center; gap: 0.35rem; }
        .legend-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
        .legend-line { width: 18px; height: 3px; border-radius: 2px; display: inline-block; }
        .sb79-eligibility {
            margin-top: 1rem; padding: 1.25rem; border-radius: 10px;
            background: linear-gradient(135deg, #ebf8ff, #f0fff4); border: 1.5px solid #bee3f8;
        }
        .sb79-eligibility h3 { font-size: 1rem; color: var(--primary); margin-bottom: 0.75rem; }
        .sb79-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.6rem; }
        .sb79-stat { background: #fff; border-radius: 8px; padding: 0.6rem 0.75rem; text-align: center; }
        .sb79-stat .stat-label { font-size: 0.7rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.05em; }
        .sb79-stat .stat-value { font-size: 1.1rem; font-weight: 700; color: var(--primary); }
        .tier-badge, .zone-badge {
            display: inline-block; font-size: 0.72rem; font-weight: 700; padding: 0.15rem 0.55rem;
            border-radius: 10px; margin-right: 0.3rem;
        }
        .tier-badge.tier1 { background: #e9d8fd; color: #553c9a; }
        .tier-badge.tier2 { background: #bee3f8; color: #2b6cb0; }
        .zone-badge.adjacent { background: #fed7d7; color: #c53030; }
        .zone-badge.inner { background: #fefcbf; color: #975a16; }
        .zone-badge.outer { background: #c6f6d5; color: #276749; }
        .station-popup .popup-title { font-weight: 700; font-size: 0.92rem; margin-bottom: 0.3rem; }
        .station-popup .popup-line { font-size: 0.8rem; color: #555; }
        .station-popup .popup-allowances { margin-top: 0.4rem; font-size: 0.78rem; }
        .station-popup .popup-allowances span { display: block; }
        @media print { .map-section { display: none !important; } }
        @media (max-width: 768px) { #sb79Map, #finderMap { height: 350px; } }

        /* Tab Bar */
        .tab-bar {
            display: flex;
            justify-content: center;
            gap: 0;
            background: #fff;
            border-bottom: 2px solid var(--border);
            box-shadow: 0 2px 6px rgba(0,0,0,0.06);
        }
        .tab-btn {
            flex: 1;
            max-width: 320px;
            padding: 1rem 2rem;
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-light);
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            transition: color 0.2s, border-color 0.2s, background 0.2s;
        }
        .tab-btn:hover {
            color: var(--primary);
            background: #f7fafc;
        }
        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--accent);
            background: #fff;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        @media print {
            .tab-bar { display: none !important; }
            #tabFinder { display: none !important; }
            #tabCalculator { display: block !important; }
        }

        /* Auth Overlay */
        #authOverlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, #1a365d 0%, #2b6cb0 50%, #1a365d 100%);
            z-index: 9999;
            display: flex; align-items: center; justify-content: center;
            transition: opacity 0.4s ease;
        }
        #authOverlay.fade-out { opacity: 0; pointer-events: none; }
        .auth-box {
            background: white; border-radius: 16px; padding: 2.5rem 2rem;
            text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 380px; width: 90%;
        }
        .auth-box h2 { color: var(--primary); font-size: 1.4rem; margin-bottom: 0.25rem; }
        .auth-box > p { color: var(--text-light); font-size: 0.92rem; margin-bottom: 1.5rem; }
        .auth-box input[type="password"] {
            width: 100%; padding: 0.7rem 1rem; border: 1.5px solid var(--border);
            border-radius: 8px; font-size: 1rem; text-align: center; margin-bottom: 1rem;
        }
        .auth-box input[type="password"]:focus {
            outline: none; border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(43,108,176,0.12);
        }
        .auth-btn {
            display: block; width: 100%; padding: 0.75rem; font-size: 1rem; font-weight: 700;
            color: white; background: linear-gradient(135deg, var(--accent-dark), var(--accent));
            border: none; border-radius: 10px; cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
            box-shadow: 0 4px 12px rgba(232,168,56,0.35);
        }
        .auth-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(232,168,56,0.45); }
        .auth-error { color: #e53e3e; font-size: 0.85rem; margin-top: 0.75rem; min-height: 1.2em; }
        @media print { #authOverlay { display: none !important; } }

        /* Opportunity Finder */
        .finder-section {
            margin-top: 1.5rem; padding: 1.25rem; border-radius: 10px;
            background: var(--card); border: 1.5px solid var(--border);
        }
        .finder-toggle {
            display: flex; align-items: center; justify-content: space-between;
            cursor: pointer; user-select: none;
        }
        .finder-toggle h3 { font-size: 1.05rem; color: var(--primary); margin: 0; }
        .finder-toggle .finder-arrow {
            font-size: 1.2rem; color: var(--text-light); transition: transform 0.2s;
        }
        .finder-toggle .finder-arrow.open { transform: rotate(90deg); }
        .finder-body { display: none; margin-top: 1rem; }
        .finder-body.open { display: block; }
        .finder-controls {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem; margin-bottom: 1rem;
        }
        .finder-field label { font-size: 0.78rem; font-weight: 600; color: var(--text-light); margin-bottom: 0.2rem; display: block; }
        .finder-field select, .finder-field input {
            width: 100%; padding: 0.5rem 0.6rem; border: 1.5px solid var(--border);
            border-radius: 6px; font-size: 0.88rem;
        }
        .finder-field select:focus, .finder-field input:focus {
            outline: none; border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(43,108,176,0.12);
        }
        .finder-radios { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .finder-radios label {
            font-size: 0.82rem; font-weight: 500; color: var(--text);
            display: flex; align-items: center; gap: 0.25rem; cursor: pointer;
        }
        .finder-checks { display: flex; gap: 0.75rem; flex-wrap: wrap; }
        .finder-checks label {
            font-size: 0.82rem; font-weight: 500; color: var(--text);
            display: flex; align-items: center; gap: 0.25rem; cursor: pointer;
        }
        .finder-range-wrap { display: flex; align-items: center; gap: 0.5rem; }
        .finder-range-wrap input[type="range"] { flex: 1; }
        .finder-range-wrap .range-val { font-size: 0.85rem; font-weight: 700; color: var(--primary); min-width: 2.5rem; text-align: right; }
        .finder-btn-search {
            padding: 0.65rem 2rem; font-size: 0.95rem; font-weight: 700;
            color: white; background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border: none; border-radius: 8px; cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
            box-shadow: 0 2px 8px rgba(26,54,93,0.25);
        }
        .finder-btn-search:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(26,54,93,0.35); }
        .finder-btn-search:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .finder-progress { display: none; margin: 1rem 0; }
        .finder-progress.active { display: block; }
        .finder-progress-bar { height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; }
        .finder-progress-fill { height: 100%; background: var(--primary-light); border-radius: 3px; transition: width 0.3s; width: 0; }
        .finder-progress-text { font-size: 0.78rem; color: var(--text-light); margin-top: 0.35rem; }
        .finder-table-wrapper { overflow-x: auto; margin-top: 1rem; }
        .finder-table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
        .finder-table th {
            background: var(--primary); color: white; padding: 0.5rem 0.6rem;
            text-align: left; font-weight: 600; cursor: pointer; white-space: nowrap; user-select: none;
        }
        .finder-table th:first-child { border-radius: 8px 0 0 0; }
        .finder-table th:last-child { border-radius: 0 8px 0 0; }
        .finder-table th:hover { background: var(--primary-light); }
        .finder-table th.sort-asc::after { content: ' \u25B2'; font-size: 0.7rem; }
        .finder-table th.sort-desc::after { content: ' \u25BC'; font-size: 0.7rem; }
        .finder-table td { padding: 0.45rem 0.6rem; border-bottom: 1px solid var(--border); }
        .finder-table tr:nth-child(even) { background: #f8fafc; }
        .finder-table tr:hover { background: #ebf8ff; cursor: pointer; }
        .finder-table tr.highlighted { background: #bee3f8 !important; }
        .imp-ratio-hot { color: #e53e3e; font-weight: 700; }
        .imp-ratio-warm { color: #dd6b20; font-weight: 600; }
        .imp-ratio-cool { color: #38a169; }
        .finder-btn-export {
            margin-top: 0.75rem; padding: 0.5rem 1.25rem; font-size: 0.85rem; font-weight: 600;
            color: var(--primary); background: #ebf8ff; border: 1.5px solid #bee3f8;
            border-radius: 8px; cursor: pointer; transition: background 0.15s;
        }
        .finder-btn-export:hover { background: #bee3f8; }
        .finder-no-results { text-align: center; padding: 2rem 1rem; color: var(--text-light); font-size: 0.92rem; }
        .finder-error { background: #fff5f5; border: 1px solid #fc8181; border-radius: 8px; padding: 1rem; color: #c53030; font-size: 0.88rem; margin-top: 1rem; }
        .finder-summary { font-size: 0.85rem; color: var(--text-light); margin-top: 0.5rem; }
        .prop-links a { font-weight: 700; font-size: 0.78rem; color: var(--primary); text-decoration: none; }
        .prop-links a:hover { text-decoration: underline; }
        .selection-bar {
            position: sticky; top: 0; z-index: 10; display: flex; align-items: center; gap: 0.75rem;
            background: #ebf8ff; border: 1.5px solid #bee3f8; border-radius: 8px;
            padding: 0.5rem 1rem; margin-bottom: 0.75rem; font-size: 0.88rem; font-weight: 600; color: var(--primary);
        }
        .saved-list-panel {
            background: var(--card); border-radius: 12px; padding: 1.75rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06); margin-bottom: 2rem;
            border-left: 4px solid #38a169;
        }
        .saved-list-panel h2 { font-size: 1.1rem; color: #276749; border-bottom: 2px solid var(--border); padding-bottom: 0.5rem; margin-bottom: 1rem; }
        .saved-list-header { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.75rem; }
        .saved-list-header span { font-size: 0.88rem; color: var(--text-light); font-weight: 600; }
        .saved-list-actions { display: flex; gap: 0.5rem; }
        .saved-btn { padding: 0.4rem 1rem; font-size: 0.82rem; font-weight: 600; border-radius: 6px; cursor: pointer; border: 1.5px solid; transition: background 0.15s; }
        .saved-btn-export { color: #276749; background: #f0fff4; border-color: #9ae6b4; }
        .saved-btn-export:hover { background: #c6f6d5; }
        .saved-btn-clear { color: #c53030; background: #fff5f5; border-color: #fc8181; }
        .saved-btn-clear:hover { background: #fed7d7; }
        .saved-btn-remove { background: none; border: none; color: #c53030; cursor: pointer; font-size: 0.85rem; padding: 0.2rem 0.4rem; }
        .saved-btn-remove:hover { text-decoration: underline; }

        /* Deep Analysis Button */
        .saved-btn-deep {
            color: white;
            background: linear-gradient(135deg, #805ad5, #6b46c1);
            border-color: #6b46c1;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(107,70,193,0.3);
        }
        .saved-btn-deep:hover { background: linear-gradient(135deg, #6b46c1, #553c9a); }

        /* Deep Analysis Modal */
        .deep-modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1100;
            overflow-y: auto;
            padding: 1rem;
        }
        .deep-modal-content {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.35);
            position: relative;
            min-height: 80vh;
        }
        .deep-modal-top-bar {
            position: sticky;
            top: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1.25rem;
            background: rgba(255,255,255,0.97);
            border-radius: 16px 16px 0 0;
            z-index: 10;
            backdrop-filter: blur(6px);
            border-bottom: 1px solid var(--border);
        }
        .deep-modal-top-bar h3 {
            font-size: 1rem;
            color: var(--primary);
            margin: 0;
        }
        .deep-modal-top-bar .btn-group { display: flex; gap: 0.5rem; }

        /* Tab Navigation */
        .deep-tabs {
            display: flex;
            align-items: flex-end;
            overflow-x: auto;
            background: #f8fafc;
            border-bottom: 2px solid var(--border);
            padding: 0 0.5rem;
            gap: 0;
        }
        .deep-tab-btn {
            padding: 0.65rem 1rem;
            font-size: 0.78rem;
            font-weight: 600;
            border: none;
            background: none;
            cursor: pointer;
            white-space: nowrap;
            color: var(--text-light);
            border-bottom: 3px solid transparent;
            transition: color 0.15s, border-color 0.15s;
        }
        .deep-tab-btn:hover { color: var(--primary); background: #edf2f7; }
        .deep-tab-btn.active {
            color: var(--primary);
            border-bottom-color: #805ad5;
            background: white;
        }
        .deep-tab-btn.coming-soon {
            color: #cbd5e0;
            cursor: default;
        }
        .deep-tab-btn.coming-soon::after {
            content: ' (Soon)';
            font-size: 0.65rem;
            font-weight: 400;
        }
        .deep-tab-btn.coming-soon:hover { color: #cbd5e0; background: none; }
        .deep-tab-group {
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        .deep-tab-group-label {
            font-size: 0.6rem;
            font-weight: 700;
            letter-spacing: 0.07em;
            text-transform: uppercase;
            color: #805ad5;
            text-align: center;
            padding: 0.35rem 0.5rem 0;
            user-select: none;
            white-space: nowrap;
        }
        .deep-tab-group-btns {
            display: flex;
        }

        .deep-tab-panel {
            display: none;
            padding: 2rem;
        }
        .deep-tab-panel.active { display: block; }

        /* Executive Summary */
        .exec-summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        @media (max-width: 768px) { .exec-summary-grid { grid-template-columns: 1fr; } }
        .exec-summary-card {
            background: #f8fafc;
            border-radius: 10px;
            padding: 1.25rem;
            border: 1px solid var(--border);
        }
        .exec-summary-card h4 {
            font-size: 0.85rem;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }
        .exec-metric-lg {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
        }
        .exec-metric-sub {
            font-size: 0.8rem;
            color: var(--text-light);
        }
        .exec-recommendation {
            background: linear-gradient(135deg, #f0fff4, #e6fffa);
            border: 2px solid #9ae6b4;
            border-radius: 10px;
            padding: 1.25rem;
            margin-top: 1.5rem;
        }
        .exec-recommendation h4 {
            color: #276749;
            margin-bottom: 0.5rem;
        }

        /* Entitlement Flowchart */
        .entitle-flow {
            display: flex;
            flex-wrap: wrap;
            gap: 0;
            align-items: center;
            margin: 1.5rem 0;
        }
        .entitle-step {
            flex: 0 0 auto;
            text-align: center;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 0.78rem;
            font-weight: 600;
            min-width: 110px;
            position: relative;
        }
        .entitle-step .step-duration {
            display: block;
            font-size: 0.7rem;
            font-weight: 400;
            color: rgba(255,255,255,0.85);
            margin-top: 0.2rem;
        }
        .entitle-step .step-cost {
            display: block;
            font-size: 0.68rem;
            font-weight: 400;
            color: rgba(255,255,255,0.75);
        }
        .entitle-arrow {
            font-size: 1.2rem;
            color: var(--text-light);
            padding: 0 0.35rem;
        }
        .entitle-type-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.78rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }
        .entitle-ministerial { background: #c6f6d5; color: #276749; }
        .entitle-discretionary { background: #fed7d7; color: #c53030; }
        .ceqa-badge { background: #fefcbf; color: #975a16; }

        .entitle-cost-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.82rem;
            margin-top: 1rem;
        }
        .entitle-cost-table th {
            text-align: left;
            padding: 0.4rem 0.6rem;
            background: #f8fafc;
            border-bottom: 2px solid var(--border);
            font-weight: 600;
            color: var(--primary);
        }
        .entitle-cost-table td {
            padding: 0.35rem 0.6rem;
            border-bottom: 1px solid #f0f0f0;
        }
        .entitle-cost-table td:last-child { text-align: right; font-weight: 600; }
        .entitle-cost-table tr.total-row td {
            font-weight: 700;
            border-top: 2px solid var(--primary);
            color: var(--primary);
        }

        /* Sensitivity / Tornado */
        .scenario-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.82rem;
            margin: 1rem 0;
        }
        .scenario-table th {
            padding: 0.5rem 0.6rem;
            text-align: center;
            font-weight: 700;
            border-bottom: 2px solid var(--border);
        }
        .scenario-table th:first-child { text-align: left; }
        .scenario-table td {
            padding: 0.4rem 0.6rem;
            text-align: center;
            border-bottom: 1px solid #f0f0f0;
        }
        .scenario-table td:first-child { text-align: left; font-weight: 500; }
        .scenario-bear { background: #fff5f5; }
        .scenario-base { background: #f0fff4; }
        .scenario-bull { background: #ebf8ff; }
        .tornado-container { margin: 1.5rem 0; }
        .tornado-bar-row {
            display: flex;
            align-items: center;
            margin-bottom: 0.4rem;
            font-size: 0.78rem;
        }
        .tornado-label {
            width: 120px;
            text-align: right;
            padding-right: 0.75rem;
            font-weight: 500;
            flex-shrink: 0;
        }
        .tornado-bar-area {
            flex: 1;
            display: flex;
            align-items: center;
            position: relative;
            height: 22px;
        }
        .tornado-bar-neg {
            height: 100%;
            background: #fc8181;
            border-radius: 4px 0 0 4px;
            position: absolute;
            right: 50%;
        }
        .tornado-bar-pos {
            height: 100%;
            background: #68d391;
            border-radius: 0 4px 4px 0;
            position: absolute;
            left: 50%;
        }
        .tornado-center-line {
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--text);
        }
        .tornado-value-left {
            position: absolute;
            right: calc(50% + 4px);
            font-size: 0.7rem;
            color: #c53030;
            top: 50%;
            transform: translateY(-50%) translateX(-100%);
        }
        .tornado-value-right {
            position: absolute;
            left: calc(50% + 4px);
            font-size: 0.7rem;
            color: #276749;
            top: 50%;
            transform: translateY(-50%) translateX(100%);
        }
        .breakeven-card {
            background: #fffff0;
            border: 2px solid #ecc94b;
            border-radius: 10px;
            padding: 1rem 1.25rem;
            margin-top: 1.5rem;
        }
        .breakeven-card h4 { color: #975a16; margin-bottom: 0.5rem; }
        .breakeven-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 0.75rem;
        }
        .breakeven-item {
            text-align: center;
            padding: 0.5rem;
            background: white;
            border-radius: 6px;
        }
        .breakeven-value { font-size: 1.3rem; font-weight: 700; color: #975a16; }
        .breakeven-label { font-size: 0.72rem; color: var(--text-light); }

        /* Heat Map */
        .heatmap-wrapper {
            overflow-x: auto;
            margin: 1.5rem 0;
        }
        .heatmap-table {
            border-collapse: collapse;
            font-size: 0.72rem;
        }
        .heatmap-table th {
            padding: 0.3rem 0.5rem;
            font-weight: 600;
            text-align: center;
            background: #f8fafc;
        }
        .heatmap-table td {
            padding: 0.3rem 0.5rem;
            text-align: center;
            font-weight: 600;
            min-width: 52px;
        }
        .heatmap-table .row-header { text-align: right; padding-right: 0.75rem; font-weight: 600; background: #f8fafc; }

        /* Affordable Housing */
        .afford-tier-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }
        .afford-tier-card {
            background: #f8fafc;
            border-radius: 10px;
            padding: 1rem;
            border: 1px solid var(--border);
        }
        .afford-tier-card h5 {
            font-size: 0.85rem;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }
        .afford-comparison-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.82rem;
            margin: 1rem 0;
        }
        .afford-comparison-table th {
            padding: 0.4rem 0.6rem;
            text-align: left;
            background: #f8fafc;
            border-bottom: 2px solid var(--border);
            font-weight: 600;
            color: var(--primary);
        }
        .afford-comparison-table td {
            padding: 0.35rem 0.6rem;
            border-bottom: 1px solid #f0f0f0;
        }
        .afford-comparison-table td:not(:first-child) { text-align: right; }
        .afford-strategy-card {
            background: linear-gradient(135deg, #ebf8ff, #e6fffa);
            border: 2px solid #63b3ed;
            border-radius: 10px;
            padding: 1.25rem;
            margin-top: 1.5rem;
        }
        .afford-strategy-card h4 {
            color: #2b6cb0;
            margin-bottom: 0.5rem;
        }
        .density-bonus-bar {
            height: 24px;
            background: #edf2f7;
            border-radius: 12px;
            overflow: hidden;
            margin: 0.5rem 0;
            position: relative;
        }
        .density-bonus-fill {
            height: 100%;
            border-radius: 12px;
            background: linear-gradient(90deg, #805ad5, #6b46c1);
            transition: width 0.5s;
        }
        .density-bonus-label {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.72rem;
            font-weight: 700;
            color: white;
        }

        /* Coming Soon placeholder */
        .coming-soon-panel {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-light);
        }
        .coming-soon-panel .icon { font-size: 3rem; margin-bottom: 1rem; }
        .coming-soon-panel h3 { color: var(--text-light); margin-bottom: 0.5rem; }

        /* Construction & Code Compliance */
        .code-matrix { width: 100%; border-collapse: collapse; font-size: 0.82rem; margin: 0.75rem 0; }
        .code-matrix th, .code-matrix td { padding: 0.5rem 0.75rem; border: 1px solid var(--border); text-align: left; }
        .code-matrix th { background: #f7fafc; font-weight: 600; color: var(--primary); }
        .code-badge { display: inline-block; padding: 0.2rem 0.6rem; border-radius: 4px; font-weight: 600; font-size: 0.78rem; }
        .code-badge.type-ia { background: #c6f6d5; color: #22543d; }
        .code-badge.type-iii { background: #fefcbf; color: #744210; }
        .code-badge.type-v { background: #fed7d7; color: #742a2a; }
        .risk-meter { height: 24px; background: #edf2f7; border-radius: 12px; overflow: hidden; margin: 0.5rem 0; }
        .risk-meter-fill { height: 100%; border-radius: 12px; transition: width 0.5s; }
        .risk-factor-list { list-style: none; padding: 0; }
        .risk-factor-list li { padding: 0.5rem 0; border-bottom: 1px solid #f0f0f0; font-size: 0.85rem; }
        .risk-factor-list li:last-child { border-bottom: none; }
        .engagement-card { background: #f0fff4; border: 1px solid #c6f6d5; border-radius: 8px; padding: 1rem; margin-top: 0.75rem; }
        .infra-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 0.75rem; }
        .infra-card { background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem; }
        .infra-card h5 { font-size: 0.82rem; color: var(--primary); margin-bottom: 0.5rem; }
        .infra-status { display: inline-block; padding: 0.15rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; }
        .infra-status.good { background: #c6f6d5; color: #22543d; }
        .infra-status.caution { background: #fefcbf; color: #744210; }
        .infra-status.upgrade { background: #fed7d7; color: #742a2a; }
        .comparison-table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
        .comparison-table th, .comparison-table td { padding: 0.5rem 0.75rem; border: 1px solid var(--border); text-align: center; }
        .comparison-table th { background: var(--primary); color: white; }
        .comparison-table td:first-child { text-align: left; font-weight: 600; background: #f7fafc; }
        .comparison-winner { background: #f0fff4 !important; font-weight: 700; }
        .site-plan-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1rem 0; }
        @media (max-width: 768px) { .site-plan-grid { grid-template-columns: 1fr; } }
        .site-plan-cell { background: #fafbfc; border: 1px solid var(--border); border-radius: 8px; padding: 0.5rem; text-align: center; }
        .site-plan-cell h5 { font-size: 0.78rem; color: var(--primary); margin-bottom: 0.25rem; }
        .coverage-bar { display: flex; height: 24px; border-radius: 4px; overflow: hidden; margin: 0.5rem 0; }
        .coverage-segment { display: flex; align-items: center; justify-content: center; font-size: 0.68rem; color: white; font-weight: 600; }
        .parking-strategy-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem; }
        .parking-strategy-card { background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem; position: relative; }
        .parking-strategy-card.recommended { border-color: var(--success); border-width: 2px; }
        .parking-strategy-card.recommended::after { content: 'BEST VALUE'; position: absolute; top: -10px; right: 10px; background: var(--success); color: white; font-size: 0.65rem; padding: 0.1rem 0.5rem; border-radius: 3px; font-weight: 700; }
        .scenario-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; }
        .scenario-card { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 1.25rem; box-shadow: 0 2px 6px rgba(0,0,0,0.04); }
        .scenario-card.winner { border-color: var(--accent); border-width: 2px; box-shadow: 0 4px 12px rgba(232,168,56,0.2); }
        .scenario-card .scenario-rank { font-size: 0.7rem; font-weight: 700; color: var(--accent-dark); text-transform: uppercase; margin-bottom: 0.5rem; }
        .scenario-metrics { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 0.75rem; }
        .scenario-metric { text-align: center; }
        .scenario-metric .val { font-size: 1rem; font-weight: 700; color: var(--primary); }
        .scenario-metric .lbl { font-size: 0.68rem; color: var(--text-light); }
        .opt-goal-btns { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem; }
        .opt-goal-btn { padding: 0.4rem 1rem; border: 1px solid var(--border); border-radius: 20px; background: white; cursor: pointer; font-size: 0.8rem; font-weight: 600; }
        .opt-goal-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 0.75rem; }
        .kpi-card { background: #f8fafc; border: 2px solid var(--border); border-radius: 10px; padding: 1rem; text-align: center; transition: all 0.2s; }
        .kpi-card.highlight { border-color: var(--primary); background: #ebf8ff; }
        .kpi-card .kpi-val { font-size: 1.3rem; font-weight: 700; }
        .kpi-card .kpi-label { font-size: 0.72rem; color: var(--text-light); margin-top: 0.25rem; }
        .kpi-card.green { border-color: #48bb78; } .kpi-card.green .kpi-val { color: #276749; }
        .kpi-card.yellow { border-color: #ecc94b; } .kpi-card.yellow .kpi-val { color: #744210; }
        .kpi-card.red { border-color: #fc8181; } .kpi-card.red .kpi-val { color: #c53030; }
        .preset-btns { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
        .preset-btn { padding: 0.35rem 0.9rem; border: 1px solid var(--border); border-radius: 6px; background: white; cursor: pointer; font-size: 0.78rem; font-weight: 600; }
        .preset-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .export-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; }
        .export-card { background: #f8fafc; border: 1px solid var(--border); border-radius: 10px; padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.2s; }
        .export-card:hover { border-color: var(--primary); box-shadow: 0 4px 12px rgba(0,0,0,0.08); transform: translateY(-2px); }
        .export-card .export-icon { font-size: 2rem; margin-bottom: 0.75rem; }
        .export-card h4 { font-size: 0.92rem; color: var(--primary); margin-bottom: 0.25rem; }
        .export-card p { font-size: 0.78rem; color: var(--text-light); }

        /* Market Comps */
        .market-rent-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.75rem;
            margin: 1rem 0;
        }
        .market-rent-card {
            background: #f8fafc;
            border-radius: 8px;
            padding: 0.85rem;
            text-align: center;
            border: 1px solid var(--border);
        }
        .market-rent-card .rent-value { font-size: 1.2rem; font-weight: 700; color: var(--primary); }
        .market-rent-card .rent-label { font-size: 0.72rem; color: var(--text-light); }
        .market-rent-card .rent-sub { font-size: 0.68rem; color: #a0aec0; }
        .vacancy-bar {
            height: 20px;
            background: #edf2f7;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            margin: 0.3rem 0;
        }
        .vacancy-fill {
            height: 100%;
            border-radius: 10px;
        }
        .vacancy-label {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.7rem;
            font-weight: 700;
        }
        .market-comp-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.82rem;
            margin: 1rem 0;
        }
        .market-comp-table th {
            padding: 0.45rem 0.6rem;
            text-align: left;
            background: #f8fafc;
            border-bottom: 2px solid var(--border);
            font-weight: 600;
            color: var(--primary);
        }
        .market-comp-table td {
            padding: 0.4rem 0.6rem;
            border-bottom: 1px solid #f0f0f0;
        }
        .market-comp-table td:not(:first-child) { text-align: right; }
        .residual-land-card {
            background: linear-gradient(135deg, #fffff0, #fefcbf);
            border: 2px solid #ecc94b;
            border-radius: 10px;
            padding: 1.25rem;
            margin-top: 1.5rem;
        }
        .residual-land-card h4 { color: #975a16; margin-bottom: 0.5rem; }
        .market-support-meter {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0.75rem 0;
        }
        .market-support-bar {
            flex: 1;
            height: 12px;
            background: #edf2f7;
            border-radius: 6px;
            overflow: hidden;
        }
        .market-support-fill {
            height: 100%;
            border-radius: 6px;
            transition: width 0.5s;
        }
        .market-support-score {
            font-size: 1rem;
            font-weight: 700;
            min-width: 45px;
            text-align: right;
        }

        /* Tax & Incentives */
        .tax-timeline-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
            margin: 1rem 0;
        }
        .tax-timeline-table th {
            padding: 0.4rem 0.5rem;
            text-align: center;
            font-weight: 600;
            background: #f8fafc;
            border-bottom: 2px solid var(--border);
            color: var(--primary);
        }
        .tax-timeline-table th:first-child { text-align: left; }
        .tax-timeline-table td {
            padding: 0.35rem 0.5rem;
            text-align: center;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.78rem;
        }
        .tax-timeline-table td:first-child { text-align: left; font-weight: 500; }
        .tax-incentive-card {
            background: #f8fafc;
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }
        .tax-incentive-card h5 {
            font-size: 0.85rem;
            color: var(--primary);
            margin-bottom: 0.4rem;
        }
        .tax-incentive-card .eligible { color: #276749; font-weight: 700; }
        .tax-incentive-card .ineligible { color: #c53030; font-weight: 700; }
        .tax-incentive-card .maybe { color: #b7791f; font-weight: 700; }
        .tax-summary-banner {
            background: linear-gradient(135deg, #ebf8ff, #f0fff4);
            border: 2px solid #63b3ed;
            border-radius: 10px;
            padding: 1.25rem;
            margin-top: 1.5rem;
        }
        .tax-summary-banner h4 { color: #2b6cb0; margin-bottom: 0.5rem; }

        /* Unit Mix */
        .unit-mix-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
            margin: 1rem 0;
        }
        @media (max-width: 700px) { .unit-mix-grid { grid-template-columns: repeat(2, 1fr); } }
        .unit-mix-card {
            background: #f8fafc;
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
            border: 2px solid var(--border);
            transition: border-color 0.2s;
        }
        .unit-mix-card.highlighted { border-color: #805ad5; background: #faf5ff; }
        .unit-mix-card .unit-pct { font-size: 1.5rem; font-weight: 800; color: var(--primary); }
        .unit-mix-card .unit-type { font-size: 0.82rem; font-weight: 600; }
        .unit-mix-card .unit-count { font-size: 0.78rem; color: var(--text-light); }
        .unit-mix-card .unit-rent { font-size: 0.85rem; font-weight: 600; color: #276749; }
        .unit-mix-card .unit-psf { font-size: 0.7rem; color: var(--text-light); }
        .unit-mix-slider-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
            font-size: 0.82rem;
        }
        .unit-mix-slider-row label {
            width: 80px;
            text-align: right;
            font-weight: 600;
            flex-shrink: 0;
        }
        .unit-mix-slider-row input[type="range"] {
            flex: 1;
            height: 6px;
            accent-color: #805ad5;
        }
        .unit-mix-slider-row .slider-val {
            width: 40px;
            text-align: center;
            font-weight: 700;
            color: var(--primary);
        }
        .rent-roll-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
            margin: 1rem 0;
        }
        .rent-roll-table th {
            padding: 0.4rem 0.6rem;
            text-align: right;
            font-weight: 600;
            background: #f8fafc;
            border-bottom: 2px solid var(--border);
            color: var(--primary);
        }
        .rent-roll-table th:first-child { text-align: left; }
        .rent-roll-table td {
            padding: 0.35rem 0.6rem;
            text-align: right;
            border-bottom: 1px solid #f0f0f0;
        }
        .rent-roll-table td:first-child { text-align: left; font-weight: 500; }
        .rent-roll-table tr.total-row td {
            font-weight: 700;
            border-top: 2px solid var(--primary);
            color: var(--primary);
        }
        .absorption-chart {
            display: flex;
            align-items: flex-end;
            gap: 4px;
            height: 100px;
            margin: 1rem 0;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
        }
        .absorption-bar {
            flex: 1;
            border-radius: 4px 4px 0 0;
            position: relative;
            min-width: 20px;
        }
        .absorption-bar .bar-label {
            position: absolute;
            bottom: -18px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.6rem;
            color: var(--text-light);
            white-space: nowrap;
        }
        .absorption-bar .bar-value {
            position: absolute;
            top: -16px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.65rem;
            font-weight: 700;
            white-space: nowrap;
        }

        @media print {
            .deep-modal-overlay { position: static; padding: 0; background: none; }
            .deep-modal-content { box-shadow: none; border-radius: 0; }
            .deep-modal-top-bar { display: none; }
            .deep-tabs { display: none; }
            .deep-tab-panel { display: block !important; page-break-before: always; }
            .deep-tab-panel:first-of-type { page-break-before: avoid; }
            .coming-soon-panel { display: none; }
        }

        @media print { .finder-section { display: none !important; } }
        @media print { #tabPipeline { display: none !important; } }

        /* Pipeline Tab Styles */
        .pipeline-badge {
            display: inline-block; padding: 0.15rem 0.55rem; border-radius: 10px;
            font-size: 0.72rem; font-weight: 700; color: #fff; white-space: nowrap;
        }
        .pipeline-badge.submitted { background: #d69e2e; }
        .pipeline-badge.plan_check { background: #dd6b20; }
        .pipeline-badge.issued { background: #3182ce; }
        .pipeline-badge.inspection { background: #38a169; }
        .pipeline-badge.finaled { background: #718096; }
        .pipeline-badge.coo { background: #276749; }
        .pipeline-val-high { color: #c53030; font-weight: 700; }
        .pipeline-val-mid { color: #dd6b20; font-weight: 600; }
        .pipeline-overlay-btn {
            position: absolute; top: 10px; right: 10px; z-index: 1000;
            padding: 0.4rem 0.85rem; font-size: 0.78rem; font-weight: 600;
            background: #fff; border: 1.5px solid var(--primary-light); border-radius: 8px;
            color: var(--primary); cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.12);
        }
        .pipeline-overlay-btn:hover { background: #ebf8ff; }
        .pipeline-overlay-btn.active { background: var(--primary); color: #fff; }
        .pipeline-legend {
            display: flex; flex-wrap: wrap; gap: 0.75rem; padding: 0.75rem 0; font-size: 0.78rem;
        }
        .pipeline-legend-item { display: flex; align-items: center; gap: 0.3rem; }
        .pipeline-legend-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }

        /* === Deep Analysis Mobile Responsiveness === */
        @media (max-width: 768px) {
            .deep-tab-panel { padding: 1rem; }
            .dt-controls-grid { grid-template-columns: 1fr !important; }
            .dt-slider-row { flex-wrap: wrap; }
            .dt-slider-row input[type="range"] { min-width: 0; flex: 1; }
            .dt-slider-row input[type="number"] { width: 60px !important; flex-shrink: 0; }
            /* Scenario table */
            .scenario-table { font-size: 0.72rem; }
            .scenario-table th, .scenario-table td { padding: 0.4rem 0.3rem; }
            /* Tornado */
            .tornado-bar-row { flex-wrap: wrap; gap: 0.2rem; }
            .tornado-label { width: 100%; font-size: 0.7rem; }
            .tornado-bar-area { flex: 1; min-width: 0; }
            /* Heatmap â€” already has overflow-x: auto via .heatmap-wrapper */
            .heatmap-table { font-size: 0.65rem; }
            .heatmap-table td, .heatmap-table th { padding: 0.2rem 0.3rem; min-width: 38px; }
            /* Comparison tables */
            .afford-comparison-table { font-size: 0.72rem; }
            .afford-comparison-table th, .afford-comparison-table td { padding: 0.3rem 0.4rem; }
            /* Sensitivity sliders grid */
            .sens-scenario-grid { grid-template-columns: 1fr !important; }
            /* Breakeven cards */
            .breakeven-grid { grid-template-columns: 1fr !important; }
            /* KPI grid */
            .kpi-grid { grid-template-columns: 1fr !important; }
            /* Deep tab navigation â€” horizontal scroll */
            #deepTabs { flex-wrap: nowrap; overflow-x: auto; -webkit-overflow-scrolling: touch; }
            .deep-tab-btn { white-space: nowrap; flex-shrink: 0; font-size: 0.65rem; padding: 0.4rem 0.6rem; }
            /* Summary cards */
            .exec-metric-lg { font-size: 1.3rem; }
        }
        @media (max-width: 480px) {
            .deep-tab-panel { padding: 0.5rem; }
            .analysis-section { padding: 0.75rem !important; }
            .analysis-section h3 { font-size: 0.9rem; }
            .exec-summary-grid { gap: 0.75rem; }
            .exec-summary-card { padding: 0.75rem; }
            .exec-metric-lg { font-size: 1.1rem; }
            .scenario-table { font-size: 0.65rem; }
            .tornado-container { margin: 0.75rem 0; }
            .breakeven-card { padding: 0.75rem; }
        }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>

<div id="authOverlay">
    <div class="auth-box">
        <h2>CLS CRE Brokerage</h2>
        <p>HBU Land Use Calculator</p>
        <input type="password" id="authPassword" placeholder="Password" onkeydown="if(event.key==='Enter')checkAuth();">
        <button type="button" class="auth-btn" onclick="checkAuth()">Enter</button>
        <div class="auth-error" id="authError"></div>
        <div style="margin-top:1.5rem;font-size:0.7rem;color:#a0aec0;">v4.2</div>
    </div>
</div>

<header>
    <h1>Highest &amp; Best Use Calculator</h1>
    <p>Land Use Analysis for Los Angeles, CA</p>
    <span class="badge">HBU Analysis Tool</span>
    <span style="font-size:0.65rem;color:#a0aec0;margin-left:0.5rem;" id="buildVersion">v4.2</span>
</header>

<div class="tab-bar">
    <button class="tab-btn active" data-tab="calculator" onclick="switchTab('calculator')">HBU Calculator</button>
    <button class="tab-btn" data-tab="finder" onclick="switchTab('finder')">SB 79 Opportunity Finder</button>
    <button class="tab-btn" data-tab="pipeline" onclick="switchTab('pipeline')">Development Pipeline</button>
    <button class="tab-btn" data-tab="contacts" onclick="switchTab('contacts')">Contacts Directory</button>
</div>

<div id="tabCalculator" class="tab-content active">
<div class="container">
    <div class="intro-box">
        <h3>How It Works</h3>
        <p>Enter your parcel details below. The calculator evaluates potential land uses against the four standard HBU tests&mdash;<strong>Legally Permissible</strong>, <strong>Physically Possible</strong>, <strong>Financially Feasible</strong>, and <strong>Maximally Productive</strong>&mdash;then ranks the top 3 uses for your site.</p>
    </div>

    <div class="address-section">
        <h2>Address Lookup</h2>
        <div class="address-row">
            <div class="field">
                <label>Property Address <span class="hint">(Los Angeles, CA)</span></label>
                <input type="text" id="addressInput" placeholder="e.g. 6801 Hollywood Blvd, Los Angeles, CA 90028" onkeydown="if(event.key==='Enter'){event.preventDefault();lookupAddress();}">
            </div>
            <button type="button" class="btn-lookup" id="btnLookup" onclick="lookupAddress()">Look Up</button>
        </div>
        <div class="lookup-status" id="lookupStatus"></div>
        <div class="autofill-notice" id="autofillNotice">
            Fields highlighted in blue were auto-populated from public data. <strong>You can modify any value</strong> before running the calculation. Click a field to edit it.
        </div>
    </div>

    <form id="hbuForm" onsubmit="return false;">
        <div class="form-grid">
            <!-- LEFT COLUMN -->
            <div>
                <div class="section">
                    <h2>Parcel Information</h2>

                    <div class="field" id="field-parcelSize">
                        <label>Parcel Size (sq ft) <span class="autofill-badge">auto-filled</span></label>
                        <input type="number" id="parcelSize" value="10000" min="500" max="5000000" step="100">
                    </div>

                    <div class="field" id="field-frontage">
                        <label>Street Frontage (linear ft) <span class="autofill-badge">auto-filled</span></label>
                        <input type="number" id="frontage" value="80" min="10" max="2000" step="5">
                    </div>

                    <div class="field" id="field-zoning">
                        <label>Zoning Designation <span class="autofill-badge">auto-filled</span></label>
                        <select id="zoning">
                            <option value="R1" selected>R1 â€” Single-Family Residential</option>
                            <option value="R2">R2 â€” Two-Family Residential</option>
                            <option value="R3">R3 â€” Multi-Family (Low Density)</option>
                            <option value="R4">R4 â€” Multi-Family (Medium Density)</option>
                            <option value="R5">R5 â€” Multi-Family (High Density)</option>
                            <option value="C1">C1 â€” Limited Commercial</option>
                            <option value="C1.5">C1.5 â€” Limited Commercial (Mixed)</option>
                            <option value="C2">C2 â€” General Commercial</option>
                            <option value="C4">C4 â€” Commercial Zone</option>
                            <option value="C5">C5 â€” Commercial (Highway)</option>
                            <option value="CM">CM â€” Commercial Manufacturing</option>
                            <option value="M1">M1 â€” Limited Industrial</option>
                            <option value="M2">M2 â€” Light Industrial</option>
                            <option value="M3">M3 â€” Heavy Industrial</option>
                            <option value="PF">PF â€” Public Facilities</option>
                            <option value="OS">OS â€” Open Space</option>
                            <option value="LAX">LAX â€” Airport</option>
                            <option value="TOD">TOD â€” Transit-Oriented Development</option>
                        </select>
                    </div>

                    <div class="field" id="field-neighborhood">
                        <label>Neighborhood / Submarket <span class="autofill-badge">auto-filled</span></label>
                        <select id="neighborhood">
                            <option value="dtla">Downtown LA (DTLA)</option>
                            <option value="hollywood">Hollywood / East Hollywood</option>
                            <option value="koreatown">Koreatown</option>
                            <option value="westside" selected>Westside (West LA / Sawtelle)</option>
                            <option value="santamonica">Santa Monica Blvd Corridor</option>
                            <option value="beverly">Beverly Hills Adjacent</option>
                            <option value="midcity">Mid-City / Mid-Wilshire</option>
                            <option value="southla">South LA</option>
                            <option value="valleyeast">San Fernando Valley â€” East</option>
                            <option value="valleywest">San Fernando Valley â€” West</option>
                            <option value="silverlake">Silver Lake / Echo Park</option>
                            <option value="highland">Highland Park / Eagle Rock</option>
                            <option value="venice">Venice / Mar Vista</option>
                            <option value="culver">Culver City Adjacent</option>
                            <option value="exposition">Exposition Corridor</option>
                            <option value="southbay">South Bay (Torrance / Gardena)</option>
                            <option value="harbor">Harbor / San Pedro</option>
                            <option value="boyleheights">Boyle Heights / East LA</option>
                        </select>
                    </div>

                    <div class="field" id="field-siteCondition">
                        <label>Current Site Condition <span class="autofill-badge">auto-filled</span></label>
                        <select id="siteCondition">
                            <option value="vacant" selected>Vacant Land</option>
                            <option value="improved_under">Improved â€” Underutilized</option>
                            <option value="improved_functional">Improved â€” Functional</option>
                            <option value="demolition">Structure â€” Requires Demolition</option>
                            <option value="brownfield">Brownfield / Environmental Issues</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- RIGHT COLUMN -->
            <div>
                <div class="section">
                    <h2>Site Characteristics</h2>

                    <div class="field">
                        <label>Topography</label>
                        <select id="topography">
                            <option value="flat" selected>Flat / Level</option>
                            <option value="gentle">Gentle Slope (&lt;10%)</option>
                            <option value="moderate">Moderate Slope (10â€“25%)</option>
                            <option value="steep">Steep Slope (&gt;25%)</option>
                        </select>
                    </div>

                    <div class="field">
                        <label>Is this a corner lot?</label>
                        <select id="cornerLot">
                            <option value="yes">Yes</option>
                            <option value="no" selected>No</option>
                        </select>
                    </div>

                    <div class="field" id="field-transit">
                        <label>Proximity to Public Transit <span class="autofill-badge">auto-filled</span></label>
                        <select id="transit">
                            <option value="adjacent">Adjacent to Metro Rail Station (&lt;0.25 mi)</option>
                            <option value="near" selected>Near Transit (0.25â€“0.5 mi)</option>
                            <option value="moderate">Moderate (0.5â€“1 mi)</option>
                            <option value="far">Far (&gt;1 mi)</option>
                        </select>
                    </div>

                    <div class="field" id="field-arterial">
                        <label>Major Street / Arterial Frontage? <span class="autofill-badge">auto-filled</span></label>
                        <select id="arterial">
                            <option value="major">Yes â€” Major Arterial (e.g. Wilshire, Sunset)</option>
                            <option value="secondary" selected>Secondary Road</option>
                            <option value="residential">Residential / Side Street</option>
                        </select>
                    </div>

                    <div class="field">
                        <label>Site Constraints <span class="hint">(select all that apply)</span></label>
                        <div class="checkbox-group">
                            <label class="checkbox-item"><input type="checkbox" id="constFlood"> Flood Zone</label>
                            <label class="checkbox-item"><input type="checkbox" id="constHillside"> Hillside Ordinance</label>
                            <label class="checkbox-item"><input type="checkbox" id="constHistoric"> Historic Overlay</label>
                            <label class="checkbox-item"><input type="checkbox" id="constFault"> Fault Zone</label>
                            <label class="checkbox-item"><input type="checkbox" id="constCoastal"> Coastal Zone</label>
                            <label class="checkbox-item"><input type="checkbox" id="constParking"> Parking Constraints</label>
                        </div>
                    </div>

                    <div class="field">
                        <label>Utilities Available</label>
                        <select id="utilities">
                            <option value="full" selected>All Utilities Available</option>
                            <option value="partial">Partial â€” Needs Upgrades</option>
                            <option value="none">No Utilities â€” Requires Extension</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <button type="button" class="btn-calculate" onclick="calculateHBU()">Calculate Top 3 Highest &amp; Best Uses</button>
    </form>

    <button type="button" class="btn-print" id="btnPrint" onclick="exportPDF()">Print / Export to PDF</button>

    <!-- RESULTS -->
    <div id="results">
        <div class="print-date" id="printDate"></div>
        <div class="results-header">
            <h2>Top 3 Highest &amp; Best Use Results</h2>
            <p id="resultsSummary"></p>
        </div>

        <div class="result-cards" id="resultCards"></div>

        <div class="legislation-section" id="legislationSection" style="display:none;"></div>

        <div class="details-section">
            <h3>Scoring Breakdown â€” Legally Permissible Uses</h3>
            <div style="overflow-x: auto;">
                <table class="details-table" id="detailsTable">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Land Use</th>
                            <th>Legal</th>
                            <th>Physical</th>
                            <th>Financial</th>
                            <th>Productive</th>
                            <th>Overall</th>
                        </tr>
                    </thead>
                    <tbody id="detailsBody"></tbody>
                </table>
            </div>

            <div id="excludedSection" style="display:none; margin-top:1.25rem;">
                <button id="toggleExcluded" onclick="toggleExcludedUses()" style="background:none;border:1px solid var(--border);border-radius:8px;padding:0.5rem 1rem;font-size:0.82rem;color:var(--text-light);cursor:pointer;width:100%;text-align:left;">
                    â–¶ Show <span id="excludedCount">0</span> uses not legally permissible under current zoning
                </button>
                <div id="excludedTable" style="display:none; margin-top:0.75rem; opacity:0.65;">
                    <div style="overflow-x: auto;">
                        <table class="details-table">
                            <thead>
                                <tr>
                                    <th>Land Use</th>
                                    <th>Physical</th>
                                    <th>Financial</th>
                                    <th>Productive</th>
                                    <th>Why Excluded</th>
                                </tr>
                            </thead>
                            <tbody id="excludedBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="disclaimer">
            <strong>Disclaimer:</strong> This tool provides a preliminary, educational estimate only. Highest and Best Use analysis for real estate investment or appraisal purposes should be performed by a qualified MAI appraiser or licensed professional. Actual HBU depends on detailed market studies, entitlement feasibility, construction cost analysis, and site-specific due diligence. Zoning codes, overlay districts, and specific plan areas in Los Angeles change frequently â€” always verify with the LA Department of City Planning (ZIMAS).
        </div>

        <!-- SB 79 Transit Opportunity Map -->
        <div class="map-section" id="mapSection" style="display:none;">
            <div class="section-header">
                <h2>SB 79 Transit Opportunity Map</h2>
                <p class="section-subtitle">Interactive map showing transit stations, SB 79 zones, and development opportunities</p>
            </div>
            <div class="map-controls" id="mapControls">
                <button type="button" class="layer-btn active" onclick="toggleMapLayer('tier1')">Tier 1 (Heavy Rail)</button>
                <button type="button" class="layer-btn active" onclick="toggleMapLayer('tier2')">Tier 2 (Metrolink)</button>
                <button type="button" class="layer-btn active" onclick="toggleMapLayer('zones')">SB 79 Zones</button>
                <button type="button" class="layer-btn active" onclick="toggleMapLayer('property')">Your Property</button>
            </div>
            <div id="sb79Map" style="height:500px;"></div>
            <div class="map-legend" id="mapLegend"></div>
            <div class="sb79-eligibility" id="sb79Eligibility" style="display:none;"></div>
        </div>
    </div>
</div>
</div><!-- /tabCalculator -->

<div id="tabFinder" class="tab-content">
<div class="container">
    <div class="intro-box" style="border-left-color:#805ad5;">
        <h3>SB 79 Opportunity Finder</h3>
        <p><strong>SB 79</strong> (effective July 1, 2026) overrides local zoning near qualifying transit stations, allowing up to <strong>95ft height, 160 du/acre, and 4.5 FAR</strong> for Tier 1 heavy rail and <strong>85ft, 140 du/acre, 4.0 FAR</strong> for Tier 2 light rail/Metrolink. Select a transit station below (or click one on the map) and set filters to find underbuilt parcels that SB 79 unlocks for higher-density development.</p>
    </div>

    <div id="finderMapContainer" style="background:var(--card);border-radius:12px;padding:1.75rem;box-shadow:0 2px 8px rgba(0,0,0,0.06);margin-bottom:2rem;">
        <div style="text-align:center;margin-bottom:1rem;">
            <h2 style="font-size:1.3rem;color:var(--primary);margin-bottom:0.25rem;">LA Metro Transit Stations</h2>
            <p style="font-size:0.88rem;color:var(--text-light);">Click any station to select it, then configure filters and search for opportunities</p>
        </div>
        <div id="finderMap" style="width:100%;height:500px;border-radius:10px;border:1.5px solid var(--border);z-index:1;"></div>
        <div class="map-legend" id="finderMapLegend"></div>
    </div>

    <div style="background:var(--card);border-radius:12px;padding:1.75rem;box-shadow:0 2px 8px rgba(0,0,0,0.06);margin-bottom:2rem;">
        <h2 style="font-size:1.1rem;color:var(--primary);border-bottom:2px solid var(--border);padding-bottom:0.5rem;margin-bottom:1.25rem;">Search Filters</h2>
        <div class="finder-controls">
            <div class="finder-field" style="grid-column: span 2;">
                <label>Transit Station</label>
                <select id="finderStation2"></select>
            </div>
            <div class="finder-field">
                <label>Search Radius (select one or more)</label>
                <div class="finder-checks">
                    <label><input type="checkbox" class="finderRadius2" value="200"> Adjacent (200ft)</label>
                    <label><input type="checkbox" class="finderRadius2" value="1320"> Inner (1/4 mi)</label>
                    <label><input type="checkbox" class="finderRadius2" value="2640" checked> Outer (1/2 mi)</label>
                </div>
            </div>
            <div class="finder-field">
                <label>Use Type</label>
                <div class="finder-checks">
                    <label><input type="checkbox" class="finderUseType2" value="Residential" checked> Residential</label>
                    <label><input type="checkbox" class="finderUseType2" value="Commercial" checked> Commercial</label>
                    <label><input type="checkbox" class="finderUseType2" value="Industrial"> Industrial</label>
                    <label><input type="checkbox" class="finderUseType2" value="Vacant" checked> Vacant</label>
                </div>
            </div>
            <div class="finder-field">
                <label>Min Lot Size (sq ft)</label>
                <input type="number" id="finderMinLot2" value="2500" min="0" step="500">
            </div>
            <div class="finder-field">
                <label>Max Lot Size (sq ft)</label>
                <input type="number" id="finderMaxLot2" value="100000" min="0" step="500">
            </div>
        </div>
        <button type="button" class="finder-btn-search" id="finderSearchBtn2" onclick="runStandaloneSearch()">Find Opportunities</button>
        <div class="finder-progress" id="finderProgress2">
            <div class="finder-progress-bar"><div class="finder-progress-fill" id="finderProgressFill2"></div></div>
            <div class="finder-progress-text" id="finderProgressText2">Querying parcels...</div>
        </div>
        <div id="finderResultsArea2"></div>
    </div>

    <div id="savedListPanel" class="saved-list-panel" style="display:none;">
        <h2>Saved Properties</h2>
        <div class="saved-list-header">
            <span id="savedListCount">0 properties</span>
            <div class="saved-list-actions">
                <button type="button" class="saved-btn saved-btn-deep" onclick="openDeepAnalysis()">Deep Analysis</button>
                <button type="button" class="saved-btn" onclick="combineContiguousParcels()" style="background:#805ad5;color:#fff;" id="combineBtn" title="Select 2-4 contiguous parcels to combine">Combine Parcels</button>
                <button type="button" class="saved-btn saved-btn-export" onclick="exportSavedCSV()">Export to Excel</button>
                <button type="button" class="saved-btn saved-btn-clear" onclick="clearSavedList()">Clear All</button>
            </div>
        </div>
        <div class="finder-table-wrapper">
            <table class="finder-table" id="savedListTable">
                <thead><tr>
                    <th style="cursor:default;width:30px;"><input type="checkbox" id="savedSelectAll" onclick="toggleSavedSelectAll()" title="Select for combining"></th>
                    <th style="cursor:default;">Address</th>
                    <th style="cursor:default;">APN</th>
                    <th style="cursor:default;">Lot Size</th>
                    <th style="cursor:default;">Zone</th>
                    <th style="cursor:default;">Links</th>
                    <th style="cursor:default;"></th>
                </tr></thead>
                <tbody id="savedListBody"></tbody>
            </table>
        </div>
    </div>
</div>
</div><!-- /tabFinder -->

<div id="tabPipeline" class="tab-content">
<div class="container">
    <div class="intro-box" style="border-left-color:#3182ce;">
        <h3>Development Pipeline</h3>
        <p>Search <strong>active LA City building permits</strong> near any address. Results are color-coded by pipeline stage â€” from initial submission through Certificate of Occupancy. Use this to evaluate the competitive development landscape around any site. Data sourced from LA City Open Data (updated daily).</p>
    </div>

    <div id="pipelineMapContainer" style="background:var(--card);border-radius:12px;padding:1.75rem;box-shadow:0 2px 8px rgba(0,0,0,0.06);margin-bottom:2rem;">
        <div style="text-align:center;margin-bottom:1rem;">
            <h2 style="font-size:1.3rem;color:var(--primary);margin-bottom:0.25rem;">Permit Activity Map</h2>
            <p style="font-size:0.88rem;color:var(--text-light);" id="pipelineMapStatus">Enter an address or click the map to set a search center</p>
        </div>
        <div id="pipelineMap" style="width:100%;height:500px;border-radius:10px;border:1.5px solid var(--border);z-index:1;"></div>
        <div class="pipeline-legend" id="pipelineLegend"></div>
    </div>

    <div style="background:var(--card);border-radius:12px;padding:1.75rem;box-shadow:0 2px 8px rgba(0,0,0,0.06);margin-bottom:2rem;">
        <h2 style="font-size:1.1rem;color:var(--primary);border-bottom:2px solid var(--border);padding-bottom:0.5rem;margin-bottom:1.25rem;">Search Filters</h2>
        <div class="finder-controls">
            <div class="finder-field" style="grid-column: span 2;">
                <label>Address</label>
                <div style="display:flex;gap:0.5rem;">
                    <input type="text" id="pipelineAddress" placeholder="e.g. 6801 Hollywood Blvd, Los Angeles, CA" style="flex:1;" onkeydown="if(event.key==='Enter'){event.preventDefault();geocodePipelineAddress();}">
                    <button type="button" class="btn-lookup" onclick="geocodePipelineAddress()" style="white-space:nowrap;">Locate</button>
                </div>
            </div>
            <div class="finder-field">
                <label>Search Radius</label>
                <div class="finder-radios">
                    <label><input type="radio" name="pipelineRadius" value="0.25"> 1/4 mi</label>
                    <label><input type="radio" name="pipelineRadius" value="0.5" checked> 1/2 mi</label>
                    <label><input type="radio" name="pipelineRadius" value="1"> 1 mi</label>
                </div>
            </div>
            <div class="finder-field">
                <label>Permit Type</label>
                <div class="finder-checks">
                    <label><input type="checkbox" class="pipelinePermitType" value="bldg" checked> Building</label>
                    <label><input type="checkbox" class="pipelinePermitType" value="grading"> Grading</label>
                    <label><input type="checkbox" class="pipelinePermitType" value="elec"> Electrical</label>
                    <label><input type="checkbox" class="pipelinePermitType" value="plumb"> Plumbing</label>
                    <label><input type="checkbox" class="pipelinePermitType" value="mech"> Mechanical</label>
                </div>
            </div>
            <div class="finder-field">
                <label>Pipeline Stage</label>
                <div class="finder-checks">
                    <label><input type="checkbox" class="pipelineStage" value="submitted" checked> Submitted</label>
                    <label><input type="checkbox" class="pipelineStage" value="plan_check" checked> Plan Check</label>
                    <label><input type="checkbox" class="pipelineStage" value="issued" checked> Issued</label>
                    <label><input type="checkbox" class="pipelineStage" value="inspection" checked> Under Inspection</label>
                    <label><input type="checkbox" class="pipelineStage" value="finaled" checked> Finaled</label>
                    <label><input type="checkbox" class="pipelineStage" value="coo" checked> Cert of Occ</label>
                </div>
            </div>
            <div class="finder-field">
                <label>Min Valuation ($)</label>
                <input type="number" id="pipelineMinVal" placeholder="e.g. 500000" min="0" step="10000">
            </div>
            <div class="finder-field">
                <label>Date From</label>
                <input type="date" id="pipelineDateFrom">
            </div>
            <div class="finder-field">
                <label>Date To</label>
                <input type="date" id="pipelineDateTo">
            </div>
        </div>
        <div style="display:flex;gap:0.75rem;margin-top:1rem;flex-wrap:wrap;">
            <button type="button" class="btn-lookup" onclick="runPipelineSearch()" style="padding:0.6rem 1.5rem;">Search Permits</button>
            <button type="button" class="btn-lookup" onclick="clearPipelineSearch()" style="padding:0.6rem 1.5rem;background:#fff;color:var(--primary);border:1.5px solid var(--primary-light);">Clear</button>
            <button type="button" class="btn-lookup" onclick="exportPipelineCSV()" id="pipelineExportBtn" style="padding:0.6rem 1.5rem;background:#f0fff4;color:#276749;border:1.5px solid #9ae6b4;display:none;">Export CSV</button>
        </div>
        <div class="finder-progress" id="pipelineProgress">
            <div class="finder-progress-bar"><div class="finder-progress-fill" id="pipelineProgressFill"></div></div>
            <div class="finder-progress-text" id="pipelineProgressText">Searching permits...</div>
        </div>
    </div>

    <div id="pipelineResultsArea" style="display:none;">
        <div style="background:var(--card);border-radius:12px;padding:1.75rem;box-shadow:0 2px 8px rgba(0,0,0,0.06);">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;flex-wrap:wrap;gap:0.5rem;">
                <h2 style="font-size:1.1rem;color:var(--primary);margin:0;" id="pipelineResultsTitle">Results</h2>
                <span style="font-size:0.82rem;color:var(--text-light);" id="pipelineResultsSummary"></span>
                <div style="display:flex;gap:0.5rem;">
                    <button type="button" class="btn-lookup" onclick="savePipelineSelected()" id="pipelineSaveBtn" style="display:none;font-size:0.78rem;padding:6px 14px;">Save Selected</button>
                    <button type="button" class="btn-lookup" onclick="deepAnalyzePipeline()" id="pipelineDeepBtn" style="display:none;font-size:0.78rem;padding:6px 14px;background:#805ad5;">Deep Analysis</button>
                </div>
            </div>
            <div class="finder-table-wrapper">
                <table class="finder-table" id="pipelineTable">
                    <thead><tr>
                        <th style="width:30px;cursor:default;"><input type="checkbox" id="pipelineSelectAll" onclick="togglePipelineSelectAll()" title="Select all"></th>
                        <th data-col="address" onclick="setPipelineSort('address')">Address</th>
                        <th data-col="permit_nbr" onclick="setPipelineSort('permit_nbr')">Permit #</th>
                        <th data-col="permit_type" onclick="setPipelineSort('permit_type')">Type</th>
                        <th data-col="stage" onclick="setPipelineSort('stage')">Stage</th>
                        <th data-col="valuation" onclick="setPipelineSort('valuation')">Valuation</th>
                        <th data-col="date" onclick="setPipelineSort('date')">Date</th>
                        <th data-col="zone" onclick="setPipelineSort('zone')">Zone</th>
                        <th style="cursor:default;">Details</th>
                    </tr></thead>
                    <tbody id="pipelineTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="pipelineSavedPanel" style="display:none;background:var(--card);border-radius:12px;padding:1.75rem;box-shadow:0 2px 8px rgba(0,0,0,0.06);margin-top:2rem;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;flex-wrap:wrap;gap:0.5rem;">
            <h2 style="font-size:1.1rem;color:#805ad5;margin:0;">Saved Pipeline Sites</h2>
            <span style="font-size:0.82rem;color:var(--text-light);" id="pipelineSavedCount">0 sites</span>
            <div style="display:flex;gap:0.5rem;">
                <button type="button" class="btn-lookup" onclick="deepAnalyzePipelineSaved()" style="font-size:0.78rem;padding:6px 14px;background:#805ad5;">Deep Analysis on Saved</button>
                <button type="button" class="btn-lookup" onclick="exportPipelineSavedCSV()" style="font-size:0.78rem;padding:6px 14px;">Export CSV</button>
                <button type="button" class="btn-lookup" onclick="clearPipelineSaved()" style="font-size:0.78rem;padding:6px 14px;background:#e53e3e;">Clear</button>
            </div>
        </div>
        <div class="finder-table-wrapper">
            <table class="finder-table">
                <thead><tr>
                    <th>Address</th><th>Permit #</th><th>Type</th><th>Stage</th><th>Valuation</th><th>Description</th><th>Action</th>
                </tr></thead>
                <tbody id="pipelineSavedBody"></tbody>
            </table>
        </div>
    </div>
</div>
</div><!-- /tabPipeline -->

<div id="tabContacts" class="tab-content">
<div class="container">
    <div class="intro-box" style="border-left-color:#805ad5;">
        <h3>Contacts Directory</h3>
        <p>Your <strong>one-stop shop</strong> for all development-related contacts in Los Angeles County. Planning departments, city officials, architects, engineers, contractors, lenders, and consultants. Filter by category or search by name.</p>
    </div>

    <div style="background:var(--card);border-radius:12px;padding:1.75rem;box-shadow:0 2px 8px rgba(0,0,0,0.06);margin-bottom:2rem;">
        <div style="display:flex;gap:0.75rem;flex-wrap:wrap;margin-bottom:1.25rem;">
            <input type="text" id="contactSearch" placeholder="Search contacts..." style="flex:1;min-width:200px;padding:8px 12px;border:1px solid var(--border);border-radius:6px;font-size:0.85rem;" oninput="filterContacts()">
            <select id="contactCategory" style="padding:8px 12px;border:1px solid var(--border);border-radius:6px;font-size:0.85rem;" onchange="filterContacts()">
                <option value="">All Categories</option>
                <option value="planning">Planning Departments</option>
                <option value="building">Building & Safety</option>
                <option value="housing">Housing Agencies</option>
                <option value="architect">Architects</option>
                <option value="engineer">Engineers</option>
                <option value="gc">General Contractors</option>
                <option value="lender">Lenders & Finance</option>
                <option value="legal">Legal / Land Use</option>
                <option value="consultant">Consultants</option>
                <option value="utility">Utilities</option>
            </select>
        </div>
        <div id="contactsGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:1rem;"></div>
    </div>
</div>
</div><!-- /tabContacts -->

<!-- Analysis Detail Modal -->
<div class="modal-overlay" id="analysisModal" style="display:none;" onclick="if(event.target===this)closeAnalysis();">
    <div class="modal-content">
        <div class="modal-top-bar">
            <button type="button" class="modal-print-btn" onclick="printAnalysis()">Print / PDF</button>
            <button type="button" class="modal-close" onclick="closeAnalysis()">&times;</button>
        </div>
        <div class="modal-header">
            <h2 id="modalTitle"></h2>
            <p id="modalSubtitle"></p>
        </div>
        <div class="modal-body" id="modalBody"></div>
    </div>
</div>

<!-- Deep Developability Analysis Modal -->
<div class="deep-modal-overlay" id="deepAnalysisModal" style="display:none;" onclick="if(event.target===this)closeDeepAnalysis();">
    <div class="deep-modal-content">
        <div class="deep-modal-top-bar">
            <h3 id="deepModalTitle">Deep Developability Analysis</h3>
            <div class="btn-group">
                <button type="button" class="modal-print-btn" onclick="printDeepAnalysis()">Print / PDF</button>
                <button type="button" class="modal-close" onclick="closeDeepAnalysis()">&times;</button>
            </div>
        </div>
        <div class="deep-tabs" id="deepTabs">
            <div class="deep-tab-group">
                <button class="deep-tab-btn active" onclick="switchDeepTab(0)">Executive Summary</button>
            </div>
            <div class="deep-tab-group">
                <div class="deep-tab-group-label">Due Diligence</div>
                <div class="deep-tab-group-btns">
                    <button class="deep-tab-btn" onclick="switchDeepTab(1)">Market Comps</button>
                    <button class="deep-tab-btn" onclick="switchDeepTab(2)">Environmental</button>
                    <button class="deep-tab-btn" onclick="switchDeepTab(3)">Earthwork</button>
                    <button class="deep-tab-btn" onclick="switchDeepTab(4)">Infrastructure</button>
                    <button class="deep-tab-btn" onclick="switchDeepTab(5)">Community Risk</button>
                </div>
            </div>
            <div class="deep-tab-group">
                <div class="deep-tab-group-label">Entitlements</div>
                <div class="deep-tab-group-btns">
                    <button class="deep-tab-btn" onclick="switchDeepTab(6)">Entitlement Pathway</button>
                    <button class="deep-tab-btn" onclick="switchDeepTab(7)">RHNA Compliance</button>
                    <button class="deep-tab-btn" onclick="switchDeepTab(8)">Affordable Compliance</button>
                    <button class="deep-tab-btn" onclick="switchDeepTab(9)">Dev Agreement</button>
                </div>
            </div>
            <div class="deep-tab-group">
                <div class="deep-tab-group-label">Design</div>
                <div class="deep-tab-group-btns">
                    <button class="deep-tab-btn" onclick="switchDeepTab(10)">Generative Design</button>
                    <button class="deep-tab-btn" onclick="switchDeepTab(11)">Site Plan &amp; 3D</button>
                    <button class="deep-tab-btn" onclick="switchDeepTab(12)">Unit Mix</button>
                    <button class="deep-tab-btn" onclick="switchDeepTab(13)">Parking Design</button>
                    <button class="deep-tab-btn" onclick="switchDeepTab(14)">Construction &amp; Code</button>
                </div>
            </div>
            <div class="deep-tab-group">
                <div class="deep-tab-group-label">Financial</div>
                <div class="deep-tab-group-btns">
                    <button class="deep-tab-btn" onclick="switchDeepTab(15)">Pro Forma &amp; Scenarios</button>
                    <button class="deep-tab-btn" onclick="switchDeepTab(16)">KPI Dashboard</button>
                    <button class="deep-tab-btn" onclick="switchDeepTab(17)">Public Finance</button>
                    <button class="deep-tab-btn" onclick="switchDeepTab(18)">Tax &amp; Incentives</button>
                    <button class="deep-tab-btn" onclick="switchDeepTab(19)">Incentive Matrix</button>
                    <button class="deep-tab-btn" onclick="switchDeepTab(20)">P3 Structuring</button>
                    <button class="deep-tab-btn" onclick="switchDeepTab(21)">Investor Module</button>
                </div>
            </div>
            <div class="deep-tab-group">
                <div class="deep-tab-group-label">Stabilized</div>
                <div class="deep-tab-group-btns">
                    <button class="deep-tab-btn" onclick="switchDeepTab(22)">Dev Timeline</button>
                    <button class="deep-tab-btn" onclick="switchDeepTab(23)">10-Yr Cash Flow</button>
                    <button class="deep-tab-btn" onclick="switchDeepTab(24)">Fiscal Impact</button>
                    <button class="deep-tab-btn" onclick="switchDeepTab(25)">Asset Strategy</button>
                </div>
            </div>
            <div class="deep-tab-group">
                <div class="deep-tab-group-label">Export</div>
                <div class="deep-tab-group-btns">
                    <button class="deep-tab-btn" onclick="switchDeepTab(26)">Export &amp; Reports</button>
                </div>
            </div>
        </div>
        <div id="deepTabPanels"></div>
    </div>
</div>

<!-- Legislation Detail Popup -->
<div class="leg-detail-overlay" id="legDetailModal" style="display:none;" onclick="if(event.target===this)closeLegislationDetail();"></div>

<footer>
    CLS CRE Brokerage &mdash; HBU Land Use Calculator &mdash; Los Angeles, CA<br>
    For educational and preliminary analysis purposes only.
</footer>

<script>
// ============================================================
//  AUTH GATE
// ============================================================
const AUTH_HASH = '08c5d8c40ac5bd96091f704d10989da4e7b65c5ee36be18b618848c4e91a22af';
async function sha256(str) {
    const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
    return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('');
}
async function checkAuth() {
    const pw = document.getElementById('authPassword').value;
    const hash = await sha256(pw);
    if (hash === AUTH_HASH) {
        sessionStorage.setItem('hbu_auth', '1');
        const overlay = document.getElementById('authOverlay');
        overlay.classList.add('fade-out');
        setTimeout(() => overlay.remove(), 500);
    } else {
        document.getElementById('authError').textContent = 'Incorrect password. Please try again.';
        document.getElementById('authPassword').value = '';
        document.getElementById('authPassword').focus();
    }
}
(function() {
    if (sessionStorage.getItem('hbu_auth') === '1') {
        const overlay = document.getElementById('authOverlay');
        if (overlay) overlay.remove();
    }
})();

// ============================================================
//  ADDRESS LOOKUP ENGINE
// ============================================================

// Neighborhood centroids (lat, lon)
const NEIGHBORHOOD_CENTROIDS = {
    dtla:         { lat: 34.0407, lon: -118.2468 },
    hollywood:    { lat: 34.0928, lon: -118.3287 },
    koreatown:    { lat: 34.0578, lon: -118.3010 },
    westside:     { lat: 34.0367, lon: -118.4376 },
    santamonica:  { lat: 34.0906, lon: -118.3856 },
    beverly:      { lat: 34.0736, lon: -118.4004 },
    midcity:      { lat: 34.0483, lon: -118.3396 },
    southla:      { lat: 33.9425, lon: -118.2820 },
    valleyeast:   { lat: 34.2219, lon: -118.4157 },
    valleywest:   { lat: 34.1866, lon: -118.5353 },
    silverlake:   { lat: 34.0869, lon: -118.2697 },
    highland:     { lat: 34.1133, lon: -118.1902 },
    venice:       { lat: 33.9850, lon: -118.4695 },
    culver:       { lat: 34.0211, lon: -118.3965 },
    exposition:   { lat: 34.0183, lon: -118.2932 },
    southbay:     { lat: 33.8358, lon: -118.3406 },
    harbor:       { lat: 33.7361, lon: -118.2922 },
    boyleheights: { lat: 34.0345, lon: -118.2120 },
};

// Map Nominatim suburb/neighbourhood names â†’ our dropdown IDs
const SUBURB_TO_NEIGHBORHOOD = {
    'downtown': 'dtla',
    'downtown los angeles': 'dtla',
    'little tokyo': 'dtla',
    'arts district': 'dtla',
    'chinatown': 'dtla',
    'civic center': 'dtla',
    'bunker hill': 'dtla',
    'financial district': 'dtla',
    'skid row': 'dtla',
    'hollywood': 'hollywood',
    'east hollywood': 'hollywood',
    'thai town': 'hollywood',
    'hollywood hills': 'hollywood',
    'los feliz': 'silverlake',
    'koreatown': 'koreatown',
    'pico-union': 'koreatown',
    'westlake': 'koreatown',
    'west los angeles': 'westside',
    'west la': 'westside',
    'sawtelle': 'westside',
    'westwood': 'westside',
    'brentwood': 'westside',
    'bel air': 'westside',
    'santa monica': 'santamonica',
    'west hollywood': 'santamonica',
    'weho': 'santamonica',
    'beverly hills': 'beverly',
    'beverly grove': 'beverly',
    'beverlywood': 'beverly',
    'century city': 'beverly',
    'mid-wilshire': 'midcity',
    'mid wilshire': 'midcity',
    'mid-city': 'midcity',
    'mid city': 'midcity',
    'miracle mile': 'midcity',
    'hancock park': 'midcity',
    'larchmont': 'midcity',
    'windsor square': 'midcity',
    'park la brea': 'midcity',
    'fairfax': 'midcity',
    'south los angeles': 'southla',
    'south la': 'southla',
    'watts': 'southla',
    'florence': 'southla',
    'vermont square': 'southla',
    'vermont-slauson': 'southla',
    'green meadows': 'southla',
    'north hollywood': 'valleyeast',
    'noho': 'valleyeast',
    'studio city': 'valleyeast',
    'valley village': 'valleyeast',
    'sun valley': 'valleyeast',
    'panorama city': 'valleyeast',
    'arleta': 'valleyeast',
    'pacoima': 'valleyeast',
    'sylmar': 'valleyeast',
    'sherman oaks': 'valleywest',
    'encino': 'valleywest',
    'tarzana': 'valleywest',
    'woodland hills': 'valleywest',
    'reseda': 'valleywest',
    'canoga park': 'valleywest',
    'winnetka': 'valleywest',
    'chatsworth': 'valleywest',
    'northridge': 'valleywest',
    'granada hills': 'valleywest',
    'west hills': 'valleywest',
    'silver lake': 'silverlake',
    'silverlake': 'silverlake',
    'echo park': 'silverlake',
    'elysian valley': 'silverlake',
    'atwater village': 'silverlake',
    'highland park': 'highland',
    'eagle rock': 'highland',
    'glassell park': 'highland',
    'mount washington': 'highland',
    'cypress park': 'highland',
    'el sereno': 'highland',
    'venice': 'venice',
    'mar vista': 'venice',
    'del rey': 'venice',
    'playa vista': 'venice',
    'playa del rey': 'venice',
    'marina del rey': 'venice',
    'culver city': 'culver',
    'palms': 'culver',
    'rancho park': 'culver',
    'cheviot hills': 'culver',
    'castle heights': 'culver',
    'exposition park': 'exposition',
    'university park': 'exposition',
    'leimert park': 'exposition',
    'jefferson park': 'exposition',
    'west adams': 'exposition',
    'baldwin hills': 'exposition',
    'crenshaw': 'exposition',
    'torrance': 'southbay',
    'gardena': 'southbay',
    'carson': 'southbay',
    'hawthorne': 'southbay',
    'inglewood': 'southbay',
    'lawndale': 'southbay',
    'el segundo': 'southbay',
    'manhattan beach': 'southbay',
    'hermosa beach': 'southbay',
    'redondo beach': 'southbay',
    'san pedro': 'harbor',
    'wilmington': 'harbor',
    'harbor city': 'harbor',
    'harbor gateway': 'harbor',
    'boyle heights': 'boyleheights',
    'east los angeles': 'boyleheights',
    'east la': 'boyleheights',
    'lincoln heights': 'boyleheights',
};

// LA Metro Rail & Metrolink stations { lat, lon, name, line, tier, serviceType }
// Tier is determined by SERVICE TYPE, not distance:
//   Tier 1 = Heavy Rail (subway): Red/B Line, Purple/D Line
//   Tier 2 = Light Rail: Blue/A, Expo/E, Gold/L, Green/C, K Line, Regional Connector
//   Tier 2 = Commuter Rail: Metrolink
const METRO_STATIONS = [
    // --- Red Line (B Line) â€” HEAVY RAIL (Tier 1): Union Station â†’ North Hollywood ---
    { lat: 34.0561, lon: -118.2365, name: 'Union Station', line: 'red', tier: 1, serviceType: 'Heavy Rail' },
    { lat: 34.0562, lon: -118.2500, name: 'Civic Center/Grand Park', line: 'red', tier: 1, serviceType: 'Heavy Rail' },
    { lat: 34.0469, lon: -118.2600, name: 'Pershing Square', line: 'red', tier: 1, serviceType: 'Heavy Rail' },
    { lat: 34.0488, lon: -118.2588, name: '7th St/Metro Center', line: 'red', tier: 1, serviceType: 'Heavy Rail' },
    { lat: 34.0678, lon: -118.2915, name: 'Wilshire/Vermont', line: 'red', tier: 1, serviceType: 'Heavy Rail' },
    { lat: 34.1017, lon: -118.3070, name: 'Hollywood/Western', line: 'red', tier: 1, serviceType: 'Heavy Rail' },
    { lat: 34.1017, lon: -118.3250, name: 'Hollywood/Vine', line: 'red', tier: 1, serviceType: 'Heavy Rail' },
    { lat: 34.1014, lon: -118.3388, name: 'Hollywood/Highland', line: 'red', tier: 1, serviceType: 'Heavy Rail' },
    { lat: 34.1381, lon: -118.3623, name: 'Universal City/Studio City', line: 'red', tier: 1, serviceType: 'Heavy Rail' },
    { lat: 34.1687, lon: -118.3765, name: 'North Hollywood', line: 'red', tier: 1, serviceType: 'Heavy Rail' },
    // --- Purple Line (D Line) â€” HEAVY RAIL (Tier 1): Wilshire corridor ---
    { lat: 34.0624, lon: -118.3080, name: 'Wilshire/Normandie', line: 'purple', tier: 1, serviceType: 'Heavy Rail' },
    { lat: 34.0573, lon: -118.3273, name: 'Wilshire/Western', line: 'purple', tier: 1, serviceType: 'Heavy Rail' },
    { lat: 34.0620, lon: -118.3440, name: 'Wilshire/La Brea', line: 'purple', tier: 1, serviceType: 'Heavy Rail' },
    { lat: 34.0622, lon: -118.3615, name: 'Wilshire/Fairfax', line: 'purple', tier: 1, serviceType: 'Heavy Rail' },
    { lat: 34.0626, lon: -118.3766, name: 'Wilshire/La Cienega', line: 'purple', tier: 1, serviceType: 'Heavy Rail' },
    { lat: 34.0630, lon: -118.3945, name: 'Wilshire/Rodeo', line: 'purple', tier: 1, serviceType: 'Heavy Rail' },
    { lat: 34.0632, lon: -118.4170, name: 'Century City/Constellation', line: 'purple', tier: 1, serviceType: 'Heavy Rail' },
    { lat: 34.0638, lon: -118.4385, name: 'Westwood/UCLA', line: 'purple', tier: 1, serviceType: 'Heavy Rail' },
    { lat: 34.0640, lon: -118.4510, name: 'Westwood/VA Hospital', line: 'purple', tier: 1, serviceType: 'Heavy Rail' },
    // --- Blue/A Line â€” LIGHT RAIL (Tier 2): 7th/Metro â†’ Long Beach ---
    { lat: 34.0398, lon: -118.2610, name: 'Pico', line: 'blue_a', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0295, lon: -118.2435, name: 'LATTC/Ortho Institute', line: 'blue_a', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0222, lon: -118.2344, name: 'San Pedro St', line: 'blue_a', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0030, lon: -118.2297, name: 'Washington', line: 'blue_a', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.9938, lon: -118.2296, name: 'Vernon', line: 'blue_a', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.9830, lon: -118.2295, name: 'Slauson', line: 'blue_a', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.9722, lon: -118.2293, name: 'Florence', line: 'blue_a', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.9612, lon: -118.2340, name: 'Firestone', line: 'blue_a', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.9450, lon: -118.2362, name: '103rd St/Watts Towers', line: 'blue_a', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.9268, lon: -118.2377, name: 'Willowbrook/Rosa Parks', line: 'blue_a', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.9160, lon: -118.2382, name: 'Compton', line: 'blue_a', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.9029, lon: -118.2382, name: 'Artesia', line: 'blue_a', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.8862, lon: -118.2284, name: 'Del Amo', line: 'blue_a', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.8697, lon: -118.2119, name: 'Wardlow', line: 'blue_a', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.8567, lon: -118.2100, name: 'Willow St', line: 'blue_a', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.8470, lon: -118.1890, name: 'Pacific Coast Hwy', line: 'blue_a', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.7686, lon: -118.1891, name: '1st St (Long Beach)', line: 'blue_a', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.7676, lon: -118.1935, name: 'Downtown Long Beach', line: 'blue_a', tier: 2, serviceType: 'Light Rail' },
    // --- Expo/E Line â€” LIGHT RAIL (Tier 2): 7th/Metro â†’ Downtown Santa Monica ---
    { lat: 34.0222, lon: -118.2580, name: 'Expo Park/USC', line: 'expo_e', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0186, lon: -118.2862, name: 'Expo/Vermont', line: 'expo_e', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0183, lon: -118.3088, name: 'Expo/Western', line: 'expo_e', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0227, lon: -118.3310, name: 'Expo/Crenshaw', line: 'expo_e', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0252, lon: -118.3418, name: 'Farmdale', line: 'expo_e', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0289, lon: -118.3520, name: 'Expo/La Brea', line: 'expo_e', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0270, lon: -118.3710, name: 'La Cienega/Jefferson', line: 'expo_e', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0248, lon: -118.3860, name: 'Culver City', line: 'expo_e', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0209, lon: -118.3520, name: 'Palms', line: 'expo_e', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0124, lon: -118.3908, name: 'Expo/Sepulveda', line: 'expo_e', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0168, lon: -118.3685, name: 'Westwood/Rancho Park', line: 'expo_e', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0135, lon: -118.4330, name: 'Expo/Bundy', line: 'expo_e', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0156, lon: -118.4694, name: '26th St/Bergamot', line: 'expo_e', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0154, lon: -118.4960, name: 'Downtown Santa Monica', line: 'expo_e', tier: 2, serviceType: 'Light Rail' },
    // --- Gold/L Line â€” LIGHT RAIL (Tier 2): East LA â†’ Azusa/APU ---
    { lat: 34.0566, lon: -118.2338, name: 'Little Tokyo/Arts District', line: 'gold_l', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0561, lon: -118.2365, name: 'Union Station (Gold)', line: 'gold_l', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0620, lon: -118.2360, name: 'Chinatown', line: 'gold_l', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0672, lon: -118.2350, name: 'Lincoln/Cypress', line: 'gold_l', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0760, lon: -118.2260, name: 'Heritage Square/Arroyo', line: 'gold_l', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0890, lon: -118.2100, name: 'Southwest Museum', line: 'gold_l', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0960, lon: -118.1990, name: 'Highland Park', line: 'gold_l', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.1118, lon: -118.1868, name: 'South Pasadena', line: 'gold_l', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.1175, lon: -118.1560, name: 'Fillmore', line: 'gold_l', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.1285, lon: -118.1340, name: 'Del Mar', line: 'gold_l', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.1360, lon: -118.1230, name: 'Memorial Park', line: 'gold_l', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.1421, lon: -118.1150, name: 'Lake', line: 'gold_l', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.1497, lon: -118.1030, name: 'Allen', line: 'gold_l', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.1500, lon: -118.0830, name: 'Sierra Madre Villa', line: 'gold_l', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.1520, lon: -118.0520, name: 'Arcadia', line: 'gold_l', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.1425, lon: -118.0310, name: 'Monrovia', line: 'gold_l', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.1365, lon: -118.0090, name: 'Duarte/City of Hope', line: 'gold_l', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.1360, lon: -117.9870, name: 'Irwindale', line: 'gold_l', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.1370, lon: -117.9620, name: 'Azusa Downtown', line: 'gold_l', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.1380, lon: -117.9440, name: 'APU/Citrus College', line: 'gold_l', tier: 2, serviceType: 'Light Rail' },
    // Gold/L Line East LA branch
    { lat: 34.0441, lon: -118.2120, name: 'Mariachi Plaza/Boyle Heights', line: 'gold_l', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0395, lon: -118.1938, name: 'Soto', line: 'gold_l', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0335, lon: -118.1770, name: 'Indiana', line: 'gold_l', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0290, lon: -118.1620, name: 'Maravilla', line: 'gold_l', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0245, lon: -118.1475, name: 'East LA Civic Center', line: 'gold_l', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0220, lon: -118.1280, name: 'Atlantic', line: 'gold_l', tier: 2, serviceType: 'Light Rail' },
    // --- Green/C Line â€” LIGHT RAIL (Tier 2): Norwalk â†’ Redondo Beach ---
    { lat: 33.9190, lon: -118.0570, name: 'Norwalk', line: 'green_c', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.9198, lon: -118.0940, name: 'Lakewood Blvd', line: 'green_c', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.9204, lon: -118.1262, name: 'Long Beach Blvd', line: 'green_c', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.9230, lon: -118.1706, name: 'Avalon', line: 'green_c', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.9268, lon: -118.2377, name: 'Willowbrook/Rosa Parks (Green)', line: 'green_c', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.9252, lon: -118.2565, name: 'Vermont/Athens', line: 'green_c', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.9289, lon: -118.2735, name: 'Harbor Freeway', line: 'green_c', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.9324, lon: -118.2915, name: 'Crenshaw (Green)', line: 'green_c', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.9525, lon: -118.3518, name: 'Hawthorne/Lennox', line: 'green_c', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.9340, lon: -118.3828, name: 'Aviation/LAX', line: 'green_c', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.9262, lon: -118.3960, name: 'Mariposa', line: 'green_c', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.9130, lon: -118.4030, name: 'El Segundo', line: 'green_c', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.9030, lon: -118.4093, name: 'Douglas', line: 'green_c', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.8920, lon: -118.4128, name: 'Redondo Beach', line: 'green_c', tier: 2, serviceType: 'Light Rail' },
    // --- K Line (Crenshaw/LAX) â€” LIGHT RAIL (Tier 2) ---
    { lat: 34.0227, lon: -118.3310, name: 'Expo/Crenshaw (K)', line: 'k_line', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0100, lon: -118.3340, name: 'Leimert Park', line: 'k_line', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.9978, lon: -118.3320, name: 'Hyde Park', line: 'k_line', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.9838, lon: -118.3290, name: 'Fairview Heights', line: 'k_line', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.9680, lon: -118.3380, name: 'Downtown Inglewood', line: 'k_line', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.9530, lon: -118.3560, name: 'Westchester/Veterans', line: 'k_line', tier: 2, serviceType: 'Light Rail' },
    { lat: 33.9340, lon: -118.3828, name: 'Aviation/Century (K)', line: 'k_line', tier: 2, serviceType: 'Light Rail' },
    // --- Regional Connector â€” LIGHT RAIL (Tier 2) ---
    { lat: 34.0458, lon: -118.2562, name: 'Grand Av Arts/Bunker Hill', line: 'connector', tier: 2, serviceType: 'Light Rail' },
    { lat: 34.0489, lon: -118.2468, name: 'Historic Broadway', line: 'connector', tier: 2, serviceType: 'Light Rail' },
    // --- Key Metrolink Stations (LA County) â€” COMMUTER RAIL (Tier 2) ---
    { lat: 34.0561, lon: -118.2365, name: 'LA Union Station (Metrolink)', line: 'metrolink', tier: 2, serviceType: 'Commuter Rail' },
    { lat: 34.1900, lon: -118.4500, name: 'Van Nuys (Metrolink)', line: 'metrolink', tier: 2, serviceType: 'Commuter Rail' },
    { lat: 34.2083, lon: -118.4958, name: 'Chatsworth', line: 'metrolink', tier: 2, serviceType: 'Commuter Rail' },
    { lat: 34.2600, lon: -118.4400, name: 'Sylmar/San Fernando', line: 'metrolink', tier: 2, serviceType: 'Commuter Rail' },
    { lat: 34.1480, lon: -118.2555, name: 'Glendale', line: 'metrolink', tier: 2, serviceType: 'Commuter Rail' },
    { lat: 34.1360, lon: -118.2410, name: 'Glendale (Tropico)', line: 'metrolink', tier: 2, serviceType: 'Commuter Rail' },
    { lat: 34.0930, lon: -118.2360, name: 'Lincoln Heights (Metrolink)', line: 'metrolink', tier: 2, serviceType: 'Commuter Rail' },
    { lat: 34.1766, lon: -118.3080, name: 'Burbank Airport North', line: 'metrolink', tier: 2, serviceType: 'Commuter Rail' },
    { lat: 34.1834, lon: -118.3268, name: 'Burbank Downtown', line: 'metrolink', tier: 2, serviceType: 'Commuter Rail' },
    { lat: 33.9017, lon: -118.2260, name: 'Compton (Metrolink)', line: 'metrolink', tier: 2, serviceType: 'Commuter Rail' },
    { lat: 34.0513, lon: -118.2310, name: 'LA Downtown (Commercial St)', line: 'metrolink', tier: 2, serviceType: 'Commuter Rail' },
    { lat: 34.0670, lon: -118.1650, name: 'Cal State LA', line: 'metrolink', tier: 2, serviceType: 'Commuter Rail' },
    { lat: 34.0870, lon: -118.1300, name: 'El Monte', line: 'metrolink', tier: 2, serviceType: 'Commuter Rail' },
    { lat: 34.1010, lon: -118.1030, name: 'Baldwin Park', line: 'metrolink', tier: 2, serviceType: 'Commuter Rail' },
    { lat: 34.1160, lon: -118.0550, name: 'Covina', line: 'metrolink', tier: 2, serviceType: 'Commuter Rail' },
    { lat: 34.0500, lon: -117.7510, name: 'Pomona Downtown', line: 'metrolink', tier: 2, serviceType: 'Commuter Rail' },
    { lat: 33.7710, lon: -118.1890, name: 'Long Beach (Metrolink)', line: 'metrolink', tier: 2, serviceType: 'Commuter Rail' },
];

// SB 79 Transit-Oriented Development tier definitions (effective July 1, 2026)
const SB79_TIERS = {
    1: { label: 'Tier 1 (Heavy Rail)', height: 95, density: 160, far: 4.5 },
    2: { label: 'Tier 2 (Light Rail/BRT)', height: 85, density: 140, far: 4.0 },
};
const SB79_ZONES = {
    adjacent: { maxDist: 0.038, label: '200ft (Adjacent)', parking: 0, heightMult: 1.0 },
    inner:    { maxDist: 0.25,  label: '1/4 Mile (Inner)',  parking: 0, heightMult: 1.0 },
    outer:    { maxDist: 0.50,  label: '1/2 Mile (Outer)',  parking: 0.5, heightMult: 0.68 },
};

// Line display colors for map markers
const LINE_COLORS = {
    red: '#e53e3e', purple: '#805ad5', blue_a: '#3182ce', expo_e: '#d69e2e',
    gold_l: '#b7791f', green_c: '#38a169', k_line: '#00bcd4', connector: '#ed64a6',
    metrolink: '#e53e3e',
};
const LINE_LABELS = {
    red: 'Red/B Line', purple: 'Purple/D Line', blue_a: 'Blue/A Line', expo_e: 'Expo/E Line',
    gold_l: 'Gold/L Line', green_c: 'Green/C Line', k_line: 'K Line (Crenshaw)', connector: 'Regional Connector',
    metrolink: 'Metrolink',
};

// Major LA arterials for street detection
const MAJOR_ARTERIALS = [
    'wilshire', 'sunset', 'santa monica', 'hollywood', 'venice', 'olympic',
    'pico', 'la cienega', 'figueroa', 'vermont', 'western', 'crenshaw',
    'sepulveda', 'van nuys', 'ventura', 'victory', 'sherman way', 'lincoln',
    'pacific coast', 'pch', 'florence', 'manchester', 'century', 'imperial',
    'alameda', 'broadway', 'spring', 'main st', 'san fernando', 'glendale',
    'beverly', 'la brea', 'fairfax', 'robertson', 'melrose', 'highland',
    'cahuenga', 'vine', 'western ave', 'normandie', 'hoover', 'alvarado',
    'temple', 'cesar chavez', 'first', '1st st', '3rd st', '6th st',
    'whittier', 'washington', 'jefferson', 'exposition', 'mlk',
    'martin luther king', 'slauson', 'gage', 'rosecrans', 'artesia',
    'el segundo', 'hawthorne', 'inglewood', 'prairie', 'aviation',
    'centinela', 'overland', 'motor', 'sawtelle', 'barrington',
    'balboa', 'reseda', 'tampa', 'winnetka', 'de soto', 'topanga',
    'canoga', 'fallbrook', 'laurel canyon', 'coldwater canyon',
    'lankershim', 'vineland', 'tujunga', 'foothill', 'glenoaks',
    'brand', 'colorado', 'huntington', 'atlantic', 'soto',
];

// Haversine distance in miles
function haversine(lat1, lon1, lat2, lon2) {
    const R = 3958.8; // Earth radius in miles
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat / 2) ** 2 +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon / 2) ** 2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

// Detect nearest neighborhood from coordinates + Nominatim address details
function detectNeighborhood(lat, lon, addressDetails) {
    // Try Nominatim address fields (neighbourhood is most specific, then suburb)
    if (addressDetails) {
        const fields = [
            addressDetails.neighbourhood,
            addressDetails.suburb,
            addressDetails.city_district,
            addressDetails.quarter,
        ];
        for (const field of fields) {
            if (field) {
                const key = field.toLowerCase().trim();
                if (SUBURB_TO_NEIGHBORHOOD[key]) {
                    return SUBURB_TO_NEIGHBORHOOD[key];
                }
            }
        }
    }
    // Fall back to centroid distance
    let best = 'westside';
    let bestDist = Infinity;
    for (const [key, c] of Object.entries(NEIGHBORHOOD_CENTROIDS)) {
        const d = haversine(lat, lon, c.lat, c.lon);
        if (d < bestDist) { bestDist = d; best = key; }
    }
    return best;
}

// Detect transit proximity from coordinates
function detectTransitProximity(lat, lon) {
    let minDist = Infinity;
    for (const s of METRO_STATIONS) {
        const d = haversine(lat, lon, s.lat, s.lon);
        if (d < minDist) minDist = d;
    }
    if (minDist <= 0.25) return 'adjacent';
    if (minDist <= 0.5) return 'near';
    if (minDist <= 1.0) return 'moderate';
    return 'far';
}

// Detect SB 79 eligibility from coordinates
function detectSB79Eligibility(lat, lon) {
    let nearest = null;
    let nearestDist = Infinity;
    let nearestIdx = -1;
    for (let i = 0; i < METRO_STATIONS.length; i++) {
        const s = METRO_STATIONS[i];
        const d = haversine(lat, lon, s.lat, s.lon);
        if (d < nearestDist) {
            nearestDist = d;
            nearest = s;
            nearestIdx = i;
        }
    }
    if (!nearest || nearestDist > 0.5) {
        return { eligible: false, station: nearest, distMiles: nearestDist, nearestIdx };
    }
    const tier = nearest.tier;
    const tierData = SB79_TIERS[tier];
    let zone, zoneKey;
    if (nearestDist <= SB79_ZONES.adjacent.maxDist) { zone = SB79_ZONES.adjacent; zoneKey = 'adjacent'; }
    else if (nearestDist <= SB79_ZONES.inner.maxDist) { zone = SB79_ZONES.inner; zoneKey = 'inner'; }
    else { zone = SB79_ZONES.outer; zoneKey = 'outer'; }

    const height = Math.round(tierData.height * zone.heightMult);
    const far = parseFloat((tierData.far * zone.heightMult).toFixed(2));
    const density = Math.round(tierData.density * zone.heightMult);
    return {
        eligible: true,
        station: nearest,
        nearestIdx,
        tier,
        tierLabel: tierData.label,
        zone: zoneKey,
        zoneLabel: zone.label,
        distMiles: nearestDist,
        allowances: { height, density, far, parking: zone.parking },
    };
}

// Detect if address is on a major arterial
function detectArterial(addressString, addressDetails) {
    // Try Nominatim road field first (most accurate â€” avoids matching neighborhood names)
    if (addressDetails && addressDetails.road) {
        const road = addressDetails.road.toLowerCase();
        for (const art of MAJOR_ARTERIALS) {
            if (road.includes(art)) return 'major';
        }
        if (/\bblvd\b|\bboulevard\b|\bave\b|\bavenue\b/.test(road)) return 'secondary';
        return 'residential';
    }
    // Fall back to full address string
    const lower = addressString.toLowerCase();
    for (const art of MAJOR_ARTERIALS) {
        if (lower.includes(art)) return 'major';
    }
    if (/\bblvd\b|\bboulevard\b|\bave\b|\bavenue\b/.test(lower)) return 'secondary';
    return 'residential';
}

// Detect site condition from Nominatim result
// For HBU analysis, any existing structure implies redevelopment â†’ demolition
function detectSiteCondition(osmClass, osmType) {
    // Named structures (buildings, amenities, commercial, etc.)
    const structureClasses = ['building', 'amenity', 'shop', 'office', 'tourism', 'leisure', 'craft', 'club', 'healthcare'];
    if (structureClasses.includes(osmClass)) return 'demolition';
    // Address resolving to a house/building â†’ existing structure for HBU redevelopment
    if (osmClass === 'place' && ['house', 'building', 'apartments', 'residential'].includes(osmType)) return 'demolition';
    // Other place types (most LA parcels have structures)
    if (osmClass === 'place') return 'demolition';
    return 'vacant';
}

// Estimate zoning when ZIMAS is blocked (fallback heuristic)
function estimateZoningFallback(addressString, addressDetails, neighborhood) {
    const lower = (addressString || '').toLowerCase();
    const road = (addressDetails && addressDetails.road) ? addressDetails.road.toLowerCase() : '';

    // Check if on a major commercial corridor
    const commercialCorridors = [
        'wilshire', 'sunset blvd', 'santa monica blvd', 'hollywood blvd', 'venice blvd',
        'olympic', 'pico blvd', 'beverly blvd', 'melrose ave', '3rd st', 'la brea',
        'la cienega', 'fairfax ave', 'robertson', 'highland ave', 'western ave',
        'vermont ave', 'figueroa', 'broadway', 'spring st', 'main st',
        'ventura blvd', 'lankershim', 'sepulveda blvd', 'van nuys blvd',
        'colorado blvd', 'brand blvd', 'glendale ave',
    ];
    const isCommercialCorridor = commercialCorridors.some(c => road.includes(c) || lower.includes(c));

    // Industrial areas
    const industrialAreas = ['arts district', 'vernon', 'commerce', 'boyle heights industrial'];
    const isIndustrial = industrialAreas.some(a => lower.includes(a));

    // DTLA is mostly commercial/mixed
    if (neighborhood === 'dtla') return isIndustrial ? 'M1' : 'C2';

    // Commercial corridors
    if (isCommercialCorridor) return 'C2';

    // Check for apartment-style addresses (Nominatim type)
    if (addressDetails && addressDetails.type === 'apartments') return 'R3';

    // Residential streets â€” check street suffix patterns
    const residentialSuffixes = /\b(ave|avenue|st|street|dr|drive|pl|place|way|ln|lane|ct|court|rd|road|blvd|ter|terrace|cir|circle)\b/i;
    const isResidential = residentialSuffixes.test(road) && !isCommercialCorridor;

    // Residential neighborhoods default to R1
    const residentialHoods = ['beverly', 'westside', 'santamonica', 'valleyeast', 'valleywest',
        'silverlake', 'highland', 'venice', 'culver', 'southbay', 'harbor'];
    if (residentialHoods.includes(neighborhood) && isResidential) return 'R1';

    // Dense residential neighborhoods
    const denseHoods = ['koreatown', 'hollywood', 'midcity', 'exposition'];
    if (denseHoods.includes(neighborhood) && isResidential) return 'R3';

    // South LA residential
    if (['southla', 'boyleheights'].includes(neighborhood) && isResidential) return 'R1';

    // Default: R1 for residential streets, C2 for commercial
    if (isResidential) return 'R1';
    return null; // Can't determine â€” let user select
}

// Map ZIMAS zoning code to our dropdown values
function mapZoningCode(rawZone) {
    if (!rawZone) return null;
    // ZIMAS returns codes like "C2-1VL", "[Q]R3-1XL", "M1-1", "R1-1-HCR" etc.
    // Strip Q conditions, D limitations, and supplemental use districts
    let z = rawZone.toUpperCase().replace(/\[.*?\]/g, '').trim();
    // Extract the base zone (letters + optional digits before the dash-height suffix)
    const match = z.match(/^(R[1-5]|C[1-5]|C1\.5|CM|M[1-3]|PF|OS|LAX)/);
    if (match) return match[1];
    // TOD areas are usually identified via overlay, not base zone
    return null;
}

// === API CALLS ===

// Geocode via OpenStreetMap Nominatim (CORS-friendly)
async function geocodeAddress(address) {
    // Append Los Angeles CA if not already present to improve results
    let query = address;
    if (!/los\s*angeles/i.test(query) && !/\bLA\b/.test(query)) {
        query += ', Los Angeles, CA';
    }
    const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&addressdetails=1&limit=1&countrycodes=us`;
    const resp = await fetch(url, {
        headers: { 'Accept': 'application/json' }
    });
    if (!resp.ok) throw new Error('Geocoding service unavailable');
    const data = await resp.json();
    if (!data || data.length === 0) throw new Error('Address not found. Try including city and zip code.');
    const m = data[0];
    return {
        lat: parseFloat(m.lat),
        lon: parseFloat(m.lon),
        matched: m.display_name,
        address: m.address || {},
        osmClass: m.class || '',
        osmType: m.type || '',
    };
}

// Query ZIMAS zoning layer
async function fetchZoning(lat, lon) {
    try {
        // ZIMAS uses CA State Plane Zone 5 (feet) but we can pass WGS84 with inSR=4326
        const url = `https://zimas.lacity.org/arcgis/rest/services/zma/zoning/MapServer/1102/query?` +
            `geometry=${lon},${lat}&geometryType=esriGeometryPoint&inSR=4326` +
            `&spatialRel=esriSpatialRelIntersects&outFields=ZONE_CMPLT&returnGeometry=false&f=json`;
        const resp = await fetch(url);
        if (!resp.ok) throw new Error('ZIMAS unavailable');
        const data = await resp.json();
        if (data.features && data.features.length > 0) {
            const raw = data.features[0].attributes.ZONE_CMPLT || data.features[0].attributes.zone_cmplt;
            return { raw, mapped: mapZoningCode(raw) };
        }
        return null;
    } catch (e) {
        console.warn('ZIMAS zoning query failed (may be CORS):', e);
        return { error: 'cors' };
    }
}

// Query LA County parcel layer for lot size
async function fetchParcelInfo(lat, lon) {
    try {
        const url = `https://public.gis.lacounty.gov/public/rest/services/LACounty_Cache/LACounty_Parcel/MapServer/0/query?` +
            `geometry=${lon},${lat}&geometryType=esriGeometryPoint&inSR=4326` +
            `&spatialRel=esriSpatialRelIntersects&outFields=*&returnGeometry=true&f=json`;
        const resp = await fetch(url);
        if (!resp.ok) throw new Error('Parcel service unavailable');
        const data = await resp.json();
        if (data.features && data.features.length > 0) {
            const attrs = data.features[0].attributes;
            // Try different field names for area
            let area = attrs['Shape.STArea()'] || attrs['Shape__Area'] || attrs['ShapeSTArea'] || attrs['SHAPE.STArea()'] || null;
            // If geometry is returned, try to compute from rings
            if (!area && data.features[0].geometry && data.features[0].geometry.rings) {
                area = computePolygonArea(data.features[0].geometry.rings, data.spatialReference);
            }
            return { area, attrs };
        }
        return null;
    } catch (e) {
        console.warn('Parcel query failed (may be CORS):', e);
        return { error: 'cors' };
    }
}

// Compute polygon area from rings (in sq ft if Web Mercator, approximate otherwise)
function computePolygonArea(rings, sr) {
    // Shoelace formula â€” gives area in the spatial reference units
    let totalArea = 0;
    for (const ring of rings) {
        let a = 0;
        for (let i = 0; i < ring.length - 1; i++) {
            a += ring[i][0] * ring[i + 1][1] - ring[i + 1][0] * ring[i][1];
        }
        totalArea += Math.abs(a) / 2;
    }
    // If Web Mercator (meters), convert to sq ft
    if (sr && (sr.wkid === 102100 || sr.wkid === 3857)) {
        // At LA latitude (~34Â°), 1 Web Mercator meter â‰ˆ 0.829 real meters
        const latRad = 34.05 * Math.PI / 180;
        const scaleFactor = Math.cos(latRad);
        const realSqMeters = totalArea * scaleFactor * scaleFactor;
        return Math.round(realSqMeters * 10.7639); // sq meters to sq ft
    }
    // If State Plane feet
    if (sr && (sr.wkid === 2229 || sr.wkid === 102645)) {
        return Math.round(totalArea);
    }
    // Fallback: assume sq ft
    return Math.round(totalArea);
}

// Estimate frontage from parcel area (rough: assume ~2:1 lot ratio)
function estimateFrontage(areaSqFt) {
    if (!areaSqFt || areaSqFt <= 0) return 80;
    // Assume lot depth â‰ˆ 2Ã— frontage â†’ area = frontage Ã— (2 Ã— frontage) = 2fÂ²
    const f = Math.sqrt(areaSqFt / 2);
    return Math.round(Math.max(20, Math.min(500, f)));
}

// Lookup status helpers
function setStatus(html) {
    document.getElementById('lookupStatus').innerHTML = html;
}

function addStatus(html) {
    document.getElementById('lookupStatus').innerHTML += html;
}

// Mark a field as autofilled
function markAutofill(fieldId) {
    const el = document.getElementById('field-' + fieldId);
    if (el) el.classList.add('autofilled');
}

// Clear all autofill markers
function clearAutofill() {
    document.querySelectorAll('.field.autofilled').forEach(el => el.classList.remove('autofilled'));
    document.getElementById('autofillNotice').classList.remove('visible');
}

// === MAIN LOOKUP ORCHESTRATOR ===

async function lookupAddress() {
    const address = document.getElementById('addressInput').value.trim();
    if (!address) {
        setStatus('<span class="err">Please enter an address.</span>');
        return;
    }

    const btn = document.getElementById('btnLookup');
    btn.disabled = true;
    btn.textContent = 'Looking up...';
    clearAutofill();
    setStatus('<span class="loading">Geocoding address...</span>');

    let coords;
    try {
        coords = await geocodeAddress(address);
        setStatus(`<span class="status-item ok">Matched: ${coords.matched}</span>`);
    } catch (e) {
        setStatus(`<span class="err">${e.message}</span>`);
        btn.disabled = false;
        btn.textContent = 'Look Up';
        return;
    }

    // Store coordinates globally for map & SB 79 detection
    window.lastGeocode = { lat: coords.lat, lon: coords.lon };

    let filledCount = 0;

    // Run zoning + parcel queries in parallel
    addStatus('<br><span class="loading">Querying zoning &amp; parcel data...</span>');

    const [zoningResult, parcelResult] = await Promise.all([
        fetchZoning(coords.lat, coords.lon),
        fetchParcelInfo(coords.lat, coords.lon),
    ]);

    // Build status summary
    let statusParts = [`<span class="status-item ok">Matched: ${coords.matched}</span>`];

    // Apply zoning
    if (zoningResult && zoningResult.error === 'cors') {
        // Estimate zoning from street type and neighborhood when ZIMAS blocked
        const estZone = estimateZoningFallback(coords.matched || address, coords.address, hood);
        if (estZone) {
            document.getElementById('zoning').value = estZone;
            markAutofill('zoning');
            filledCount++;
            statusParts.push(`<span class="status-item warn">Zoning: ZIMAS blocked â€” estimated ${estZone} from location (verify manually)</span>`);
        } else {
            statusParts.push(`<span class="status-item warn">Zoning: ZIMAS blocked by browser â€” select manually</span>`);
        }
    } else if (zoningResult && zoningResult.mapped) {
        const sel = document.getElementById('zoning');
        const opt = sel.querySelector(`option[value="${zoningResult.mapped}"]`);
        if (opt) {
            sel.value = zoningResult.mapped;
            markAutofill('zoning');
            filledCount++;
            statusParts.push(`<span class="status-item ok">Zoning: ${zoningResult.raw}</span>`);
        } else {
            statusParts.push(`<span class="status-item warn">Zoning "${zoningResult.raw}" â€” not in dropdown, please select manually</span>`);
        }
    } else if (zoningResult && zoningResult.raw) {
        statusParts.push(`<span class="status-item warn">Zoning "${zoningResult.raw}" â€” please select closest match</span>`);
    } else {
        // Also try fallback estimation when ZIMAS returns nothing
        const estZone = estimateZoningFallback(coords.matched || address, coords.address, hood);
        if (estZone) {
            document.getElementById('zoning').value = estZone;
            markAutofill('zoning');
            filledCount++;
            statusParts.push(`<span class="status-item warn">Zoning: estimated ${estZone} from location (verify manually)</span>`);
        } else {
            statusParts.push(`<span class="status-item warn">Zoning: could not retrieve â€” please select manually</span>`);
        }
    }

    // Apply parcel size
    if (parcelResult && parcelResult.error === 'cors') {
        statusParts.push(`<span class="status-item warn">Parcel size: County GIS blocked by browser â€” enter manually</span>`);
    } else if (parcelResult && parcelResult.area && parcelResult.area > 0) {
        document.getElementById('parcelSize').value = Math.round(parcelResult.area);
        markAutofill('parcelSize');
        filledCount++;
        statusParts.push(`<span class="status-item ok">Lot: ${Math.round(parcelResult.area).toLocaleString()} SF</span>`);

        // Estimate frontage
        const est = estimateFrontage(parcelResult.area);
        document.getElementById('frontage').value = est;
        markAutofill('frontage');
        filledCount++;
    } else {
        statusParts.push(`<span class="status-item warn">Parcel size: could not retrieve â€” enter manually</span>`);
    }

    // Detect neighborhood (using Nominatim address details when available)
    const hood = detectNeighborhood(coords.lat, coords.lon, coords.address);
    document.getElementById('neighborhood').value = hood;
    markAutofill('neighborhood');
    filledCount++;

    // Detect transit
    const transit = detectTransitProximity(coords.lat, coords.lon);
    document.getElementById('transit').value = transit;
    markAutofill('transit');
    filledCount++;

    // Detect arterial (using Nominatim road field when available)
    const arterial = detectArterial(coords.matched || address, coords.address);
    document.getElementById('arterial').value = arterial;
    markAutofill('arterial');
    filledCount++;

    // Detect site condition from Nominatim class/type
    const siteCondition = detectSiteCondition(coords.osmClass, coords.osmType);
    document.getElementById('siteCondition').value = siteCondition;
    markAutofill('siteCondition');
    filledCount++;

    // Show status
    setStatus(statusParts.join('<br>'));

    // Show autofill notice
    if (filledCount > 0) {
        document.getElementById('autofillNotice').classList.add('visible');
    }

    btn.disabled = false;
    btn.textContent = 'Look Up';
}


// ============================================================
//  LA-Specific Data & Scoring Engine
// ============================================================

const LAND_USES = [
    { id: 'sfr',            name: 'Single-Family Residential',      icon: 'ðŸ¡' },
    { id: 'duplex',         name: 'Duplex / Two-Unit',              icon: 'ðŸ˜ï¸' },
    { id: 'multifamily_low', name: 'Multi-Family (Low-Rise)',       icon: 'ðŸ¢' },
    { id: 'multifamily_mid', name: 'Multi-Family (Mid-Rise)',       icon: 'ðŸ™ï¸' },
    { id: 'multifamily_high', name: 'Multi-Family (High-Rise)',     icon: 'ðŸ—ï¸' },
    { id: 'mixeduse',       name: 'Mixed-Use (Retail + Residential)', icon: 'ðŸ¬' },
    { id: 'retail',         name: 'Retail / Restaurant',            icon: 'ðŸ›ï¸' },
    { id: 'office',         name: 'Office / Professional',          icon: 'ðŸ›ï¸' },
    { id: 'medical',        name: 'Medical Office',                 icon: 'ðŸ¥' },
    { id: 'hotel',          name: 'Hotel / Hospitality',            icon: 'ðŸ¨' },
    { id: 'industrial',     name: 'Industrial / Warehouse',         icon: 'ðŸ­' },
    { id: 'selfstorage',    name: 'Self-Storage',                   icon: 'ðŸ“¦' },
    { id: 'senior',         name: 'Senior Living / Assisted',       icon: 'ðŸ§“' },
    { id: 'parking',        name: 'Parking Structure / Lot',        icon: 'ðŸ…¿ï¸' },
    { id: 'creative',       name: 'Creative Office / Flex',         icon: 'ðŸŽ¨' },
    { id: 'adu',            name: 'ADU / Small-Lot Subdivision',    icon: 'ðŸ ' },
];

// Zoning â†’ which uses are legally permissible
// 0 = not permitted, 0.5 = conditional/CUP required, 1.0 = by-right
const ZONING_MATRIX = {
    'R1':  { sfr:1, duplex:0, multifamily_low:0, multifamily_mid:0, multifamily_high:0, mixeduse:0, retail:0, office:0, medical:0, hotel:0, industrial:0, selfstorage:0, senior:0.5, parking:0, creative:0, adu:1 },
    'R2':  { sfr:1, duplex:1, multifamily_low:0.5, multifamily_mid:0, multifamily_high:0, mixeduse:0, retail:0, office:0, medical:0, hotel:0, industrial:0, selfstorage:0, senior:0.5, parking:0, creative:0, adu:1 },
    'R3':  { sfr:1, duplex:1, multifamily_low:1, multifamily_mid:0.5, multifamily_high:0, mixeduse:0, retail:0, office:0, medical:0, hotel:0, industrial:0, selfstorage:0, senior:0.5, parking:0.5, creative:0, adu:1 },
    'R4':  { sfr:0.5, duplex:1, multifamily_low:1, multifamily_mid:1, multifamily_high:0.5, mixeduse:0, retail:0, office:0, medical:0, hotel:0, industrial:0, selfstorage:0, senior:1, parking:0.5, creative:0, adu:0.5 },
    'R5':  { sfr:0, duplex:0.5, multifamily_low:1, multifamily_mid:1, multifamily_high:1, mixeduse:0, retail:0, office:0, medical:0, hotel:0.5, industrial:0, selfstorage:0, senior:1, parking:0.5, creative:0, adu:0 },
    'C1':  { sfr:0, duplex:0, multifamily_low:0.5, multifamily_mid:0, multifamily_high:0, mixeduse:0.5, retail:1, office:1, medical:1, hotel:0, industrial:0, selfstorage:0, senior:0, parking:1, creative:0.5, adu:0 },
    'C1.5':{ sfr:0, duplex:0, multifamily_low:0.5, multifamily_mid:0.5, multifamily_high:0, mixeduse:1, retail:1, office:1, medical:1, hotel:0.5, industrial:0, selfstorage:0, senior:0.5, parking:1, creative:0.5, adu:0 },
    'C2':  { sfr:0, duplex:0, multifamily_low:1, multifamily_mid:1, multifamily_high:0.5, mixeduse:1, retail:1, office:1, medical:1, hotel:1, industrial:0, selfstorage:0.5, senior:1, parking:1, creative:1, adu:0 },
    'C4':  { sfr:0, duplex:0, multifamily_low:0.5, multifamily_mid:1, multifamily_high:0.5, mixeduse:1, retail:1, office:1, medical:1, hotel:1, industrial:0, selfstorage:0.5, senior:0.5, parking:1, creative:1, adu:0 },
    'C5':  { sfr:0, duplex:0, multifamily_low:0, multifamily_mid:0.5, multifamily_high:0, mixeduse:0.5, retail:1, office:1, medical:0.5, hotel:0.5, industrial:0, selfstorage:0.5, senior:0, parking:1, creative:0.5, adu:0 },
    'CM':  { sfr:0, duplex:0, multifamily_low:0, multifamily_mid:0, multifamily_high:0, mixeduse:0.5, retail:0.5, office:1, medical:0.5, hotel:0, industrial:0.5, selfstorage:1, senior:0, parking:1, creative:1, adu:0 },
    'M1':  { sfr:0, duplex:0, multifamily_low:0, multifamily_mid:0, multifamily_high:0, mixeduse:0, retail:0.5, office:0.5, medical:0, hotel:0, industrial:1, selfstorage:1, senior:0, parking:1, creative:1, adu:0 },
    'M2':  { sfr:0, duplex:0, multifamily_low:0, multifamily_mid:0, multifamily_high:0, mixeduse:0, retail:0, office:0, medical:0, hotel:0, industrial:1, selfstorage:1, senior:0, parking:1, creative:0.5, adu:0 },
    'M3':  { sfr:0, duplex:0, multifamily_low:0, multifamily_mid:0, multifamily_high:0, mixeduse:0, retail:0, office:0, medical:0, hotel:0, industrial:1, selfstorage:0.5, senior:0, parking:1, creative:0, adu:0 },
    'PF':  { sfr:0, duplex:0, multifamily_low:0, multifamily_mid:0, multifamily_high:0, mixeduse:0, retail:0, office:0.5, medical:0.5, hotel:0, industrial:0, selfstorage:0, senior:0.5, parking:0.5, creative:0, adu:0 },
    'OS':  { sfr:0, duplex:0, multifamily_low:0, multifamily_mid:0, multifamily_high:0, mixeduse:0, retail:0, office:0, medical:0, hotel:0, industrial:0, selfstorage:0, senior:0, parking:0, creative:0, adu:0 },
    'LAX': { sfr:0, duplex:0, multifamily_low:0, multifamily_mid:0, multifamily_high:0, mixeduse:0, retail:0.5, office:0.5, medical:0, hotel:0.5, industrial:0.5, selfstorage:0.5, senior:0, parking:1, creative:0, adu:0 },
    'TOD': { sfr:0, duplex:0.5, multifamily_low:1, multifamily_mid:1, multifamily_high:1, mixeduse:1, retail:1, office:1, medical:1, hotel:1, industrial:0, selfstorage:0, senior:1, parking:0.5, creative:1, adu:0.5 },
};

// Neighborhood market demand multipliers (1.0 = average)
const NEIGHBORHOOD_DEMAND = {
    dtla:         { sfr:0.3, duplex:0.4, multifamily_low:1.1, multifamily_mid:1.3, multifamily_high:1.4, mixeduse:1.4, retail:1.2, office:1.3, medical:0.7, hotel:1.3, industrial:0.5, selfstorage:0.7, senior:0.6, parking:1.3, creative:1.4, adu:0.3 },
    hollywood:    { sfr:0.5, duplex:0.7, multifamily_low:1.2, multifamily_mid:1.3, multifamily_high:1.1, mixeduse:1.3, retail:1.2, office:1.0, medical:0.8, hotel:1.2, industrial:0.3, selfstorage:0.7, senior:0.5, parking:1.1, creative:1.3, adu:0.6 },
    koreatown:    { sfr:0.4, duplex:0.6, multifamily_low:1.3, multifamily_mid:1.4, multifamily_high:1.2, mixeduse:1.3, retail:1.2, office:0.9, medical:1.1, hotel:1.0, industrial:0.3, selfstorage:0.8, senior:0.8, parking:1.2, creative:0.9, adu:0.5 },
    westside:     { sfr:1.0, duplex:0.9, multifamily_low:1.1, multifamily_mid:1.2, multifamily_high:0.9, mixeduse:1.2, retail:1.1, office:1.2, medical:1.3, hotel:1.0, industrial:0.2, selfstorage:0.6, senior:1.0, parking:1.0, creative:1.1, adu:0.9 },
    santamonica:  { sfr:0.8, duplex:0.8, multifamily_low:1.0, multifamily_mid:1.1, multifamily_high:0.8, mixeduse:1.2, retail:1.3, office:1.1, medical:1.0, hotel:1.1, industrial:0.2, selfstorage:0.4, senior:0.8, parking:1.0, creative:1.2, adu:0.7 },
    beverly:      { sfr:1.2, duplex:0.8, multifamily_low:1.0, multifamily_mid:1.1, multifamily_high:0.9, mixeduse:1.1, retail:1.1, office:1.3, medical:1.4, hotel:1.1, industrial:0.1, selfstorage:0.3, senior:1.0, parking:0.9, creative:0.9, adu:0.7 },
    midcity:      { sfr:0.7, duplex:0.8, multifamily_low:1.2, multifamily_mid:1.2, multifamily_high:0.8, mixeduse:1.2, retail:1.0, office:0.9, medical:1.0, hotel:0.8, industrial:0.3, selfstorage:0.8, senior:0.9, parking:0.9, creative:1.0, adu:0.8 },
    southla:      { sfr:0.9, duplex:1.0, multifamily_low:1.1, multifamily_mid:0.8, multifamily_high:0.4, mixeduse:0.8, retail:0.8, office:0.5, medical:0.7, hotel:0.4, industrial:0.9, selfstorage:1.1, senior:0.7, parking:0.6, creative:0.6, adu:1.1 },
    valleyeast:   { sfr:1.1, duplex:1.0, multifamily_low:1.0, multifamily_mid:0.8, multifamily_high:0.5, mixeduse:0.9, retail:0.9, office:0.8, medical:0.9, hotel:0.6, industrial:1.0, selfstorage:1.1, senior:0.9, parking:0.7, creative:0.7, adu:1.0 },
    valleywest:   { sfr:1.2, duplex:1.0, multifamily_low:0.9, multifamily_mid:0.8, multifamily_high:0.4, mixeduse:0.9, retail:0.9, office:0.9, medical:1.0, hotel:0.6, industrial:0.8, selfstorage:1.0, senior:1.0, parking:0.6, creative:0.7, adu:1.0 },
    silverlake:   { sfr:0.9, duplex:0.9, multifamily_low:1.2, multifamily_mid:1.0, multifamily_high:0.5, mixeduse:1.2, retail:1.1, office:0.8, medical:0.7, hotel:0.7, industrial:0.3, selfstorage:0.5, senior:0.5, parking:0.7, creative:1.3, adu:1.0 },
    highland:     { sfr:0.9, duplex:0.9, multifamily_low:1.1, multifamily_mid:0.9, multifamily_high:0.4, mixeduse:1.1, retail:1.0, office:0.7, medical:0.7, hotel:0.5, industrial:0.5, selfstorage:0.7, senior:0.5, parking:0.6, creative:1.1, adu:1.0 },
    venice:       { sfr:0.9, duplex:0.8, multifamily_low:1.0, multifamily_mid:0.9, multifamily_high:0.5, mixeduse:1.2, retail:1.2, office:1.0, medical:0.7, hotel:1.0, industrial:0.2, selfstorage:0.3, senior:0.6, parking:0.8, creative:1.3, adu:0.8 },
    culver:       { sfr:0.8, duplex:0.8, multifamily_low:1.1, multifamily_mid:1.1, multifamily_high:0.7, mixeduse:1.2, retail:1.0, office:1.2, medical:1.0, hotel:0.9, industrial:0.5, selfstorage:0.7, senior:0.8, parking:0.8, creative:1.3, adu:0.8 },
    exposition:   { sfr:0.6, duplex:0.7, multifamily_low:1.2, multifamily_mid:1.2, multifamily_high:0.9, mixeduse:1.2, retail:1.0, office:0.9, medical:0.8, hotel:0.7, industrial:0.4, selfstorage:0.8, senior:0.7, parking:0.9, creative:1.0, adu:0.8 },
    southbay:     { sfr:1.0, duplex:0.9, multifamily_low:0.9, multifamily_mid:0.7, multifamily_high:0.3, mixeduse:0.8, retail:0.9, office:0.8, medical:1.0, hotel:0.7, industrial:1.2, selfstorage:1.1, senior:0.9, parking:0.6, creative:0.6, adu:0.9 },
    harbor:       { sfr:0.7, duplex:0.7, multifamily_low:0.8, multifamily_mid:0.6, multifamily_high:0.3, mixeduse:0.7, retail:0.7, office:0.5, medical:0.6, hotel:0.6, industrial:1.3, selfstorage:1.1, senior:0.7, parking:0.7, creative:0.5, adu:0.7 },
    boyleheights: { sfr:0.9, duplex:1.0, multifamily_low:1.1, multifamily_mid:0.7, multifamily_high:0.3, mixeduse:0.9, retail:0.9, office:0.5, medical:0.6, hotel:0.3, industrial:0.8, selfstorage:0.9, senior:0.6, parking:0.5, creative:0.8, adu:1.1 },
};

// Minimum parcel sizes (sq ft) for feasibility
const MIN_PARCEL = {
    sfr: 2500, duplex: 3500, multifamily_low: 5000, multifamily_mid: 10000,
    multifamily_high: 20000, mixeduse: 5000, retail: 2000, office: 3000,
    medical: 3000, hotel: 15000, industrial: 5000, selfstorage: 8000,
    senior: 15000, parking: 3000, creative: 3000, adu: 1200
};

// Approx LA land value per SF by neighborhood (for relative comparisons)
const LAND_VALUE_PSF = {
    dtla: 250, hollywood: 250, koreatown: 200, westside: 350, santamonica: 400,
    beverly: 450, midcity: 180, southla: 85, valleyeast: 110, valleywest: 130,
    silverlake: 220, highland: 150, venice: 350, culver: 260, exposition: 160,
    southbay: 120, harbor: 80, boyleheights: 110
};

// Revenue potential per NSF of building (annual $/SF, new-construction achievable rents)
const REVENUE_PSF = {
    sfr: 40, duplex: 42, multifamily_low: 52, multifamily_mid: 58,
    multifamily_high: 66, mixeduse: 56, retail: 52, office: 52,
    medical: 62, hotel: 90, industrial: 22, selfstorage: 24,
    senior: 62, parking: 30, creative: 52, adu: 46
};

// Neighborhood rent multiplier â€” adjusts REVENUE_PSF by submarket
const NEIGHBORHOOD_RENT_MULT = {
    dtla: 0.95, hollywood: 1.10, koreatown: 0.88, westside: 1.25, santamonica: 1.35,
    beverly: 1.40, midcity: 1.00, southla: 0.70, valleyeast: 0.82, valleywest: 0.85,
    silverlake: 1.08, highland: 0.88, venice: 1.25, culver: 1.12, exposition: 0.88,
    southbay: 0.85, harbor: 0.70, boyleheights: 0.75
};

// Parking cost per space by building type
const PARKING_COST_MAP = {
    sfr: 8000, duplex: 8000, multifamily_low: 30000, multifamily_mid: 40000,
    multifamily_high: 65000, mixeduse: 40000, retail: 8000, office: 40000,
    medical: 40000, hotel: 55000, industrial: 5000, selfstorage: 5000,
    senior: 30000, parking: 35000, creative: 8000, adu: 5000
};

// Build cost per SF (LA 2024-2025 market)
const BUILD_COST_PSF = {
    sfr: 300, duplex: 275, multifamily_low: 310, multifamily_mid: 400,
    multifamily_high: 575, mixeduse: 420, retail: 260, office: 365,
    medical: 430, hotel: 480, industrial: 150, selfstorage: 110,
    senior: 400, parking: 85, creative: 290, adu: 280
};

// FAR (floor area ratio) by use â€” typical LA densities
const FAR_TYPICAL = {
    sfr: 0.5, duplex: 0.6, multifamily_low: 1.5, multifamily_mid: 3.0,
    multifamily_high: 6.0, mixeduse: 3.0, retail: 0.5, office: 2.0,
    medical: 1.5, hotel: 4.0, industrial: 0.5, selfstorage: 2.5,
    senior: 2.5, parking: 3.0, creative: 1.5, adu: 0.5
};

// Rationale templates
const RATIONALE = {
    sfr:             'Single-family development suits the site due to residential zoning, neighborhood character, and stable demand for ownership housing.',
    duplex:          'Duplex development provides moderate density with manageable entitlement complexity, strong for owner-occupant or rental income strategies.',
    multifamily_low: 'Low-rise multifamily maximizes unit count within a manageable building type, aligning well with LA\'s housing demand and density incentives.',
    multifamily_mid: 'Mid-rise multifamily leverages the parcel size and zoning to achieve meaningful density, supported by strong rental market fundamentals.',
    multifamily_high:'High-rise multifamily captures maximum density bonus potential in a high-demand corridor, though construction costs are significantly higher.',
    mixeduse:        'Mixed-use development combines ground-floor commercial revenue with residential density above, ideal for transit-accessible commercial corridors.',
    retail:          'Retail use leverages street frontage, visibility, and pedestrian traffic in a commercial corridor with demonstrated consumer demand.',
    office:          'Office development responds to professional service demand in the submarket, with viable access and infrastructure to support employment density.',
    medical:         'Medical office benefits from proximity to health care services, strong tenant demand, and premium rents typical of medical-zoned uses.',
    hotel:           'Hotel/hospitality use leverages tourism and business travel demand, arterial visibility, and transit proximity for viable room-night revenue.',
    industrial:      'Industrial/warehouse use provides strong yield potential with lower construction costs, supported by limited industrial land supply in LA.',
    selfstorage:     'Self-storage is operationally efficient with low staffing costs, serves population density demand, and tolerates suboptimal site configurations.',
    senior:          'Senior living addresses the growing aging population with premium per-unit revenue and purpose-built care facilities.',
    parking:         'Parking structure use addresses chronic parking deficits in dense urban areas, with modest build costs and reliable demand.',
    creative:        'Creative office/flex space appeals to tech and media tenants seeking character space, commanding premium rents in emerging neighborhoods.',
    adu:             'ADU or small-lot subdivision maximizes yield on smaller parcels under CA housing legislation (SB 9, AB 68) with minimal entitlement friction.',
};


// ============================================================
//  CA HOUSING LEGISLATION
// ============================================================

const CA_HOUSING_LEGISLATION = [
    {
        id: 'sb9',
        name: 'SB 9 (HOME Act)',
        description: 'By-right duplex and lot splits on single-family parcels statewide.',
        detail: 'The California HOME Act (2021) allows property owners to split single-family lots and build duplexes by-right, bypassing traditional zoning restrictions. Applies to parcels of at least 2,400 SF in urbanized areas, not in historic districts, fire hazard zones, or conservation areas. Each resulting lot must be at least 1,200 SF. Owner-occupancy is required for 3 years on one of the units if a lot split is pursued. This effectively doubles the allowed density on R1-zoned land without requiring a zone change or CUP. Impact: Significant for small infill developers targeting R1 neighborhoods.',
        applies: (useId, inp) => inp.zoning === 'R1' && inp.parcelSize >= 2400 && ['duplex', 'adu'].includes(useId),
        densityBonus: 1.0,
        parkingReduction: 0,
        softCostReduction: 0,
        legalOverride: true,
    },
    {
        id: 'ab2011',
        name: 'AB 2011',
        description: 'By-right affordable housing on commercially zoned land.',
        detail: 'AB 2011 (2022) creates a streamlined, ministerial (by-right) approval pathway for 100% affordable housing on commercially zoned land. Projects must pay prevailing wages and meet affordability requirements â€” mixed-income projects require a percentage of units at below-market rents. Applies to sites zoned for office, retail, or parking that are not in industrial zones, coastal zones, or high fire areas. Overrides local zoning that would otherwise prohibit residential uses on commercial parcels. Impact: Unlocks large swaths of commercial land for affordable housing development across California.',
        applies: (useId, inp) => ['C1','C1.5','C2','C4','C5','CM'].includes(inp.zoning) && ['multifamily_low','multifamily_mid','multifamily_high','mixeduse'].includes(useId),
        densityBonus: 0.35,
        parkingReduction: 0,
        softCostReduction: 0,
        legalOverride: true,
    },
    {
        id: 'sb6',
        name: 'SB 6',
        description: 'Market-rate housing permitted on commercially zoned land.',
        detail: 'SB 6, the Middle Class Housing Act (2022), allows market-rate residential development on commercially zoned land, provided the project meets specified objective design standards and at least 20% of units are affordable. Unlike AB 2011, SB 6 allows market-rate projects but requires the local approval process. Projects must comply with local height and FAR limits. Applies to parcels zoned for office, retail, or parking uses. Impact: Enables market-rate housing on commercial corridors where residential was previously prohibited.',
        applies: (useId, inp) => ['C1','C1.5','C2','C4','C5','CM'].includes(inp.zoning) && ['multifamily_low','multifamily_mid','multifamily_high','mixeduse'].includes(useId),
        densityBonus: 0.25,
        parkingReduction: 0,
        softCostReduction: 0,
        legalOverride: false,
    },
    {
        id: 'sb423',
        name: 'SB 423 (Streamlined)',
        description: 'Streamlined ministerial approval for multifamily projects meeting affordability thresholds.',
        detail: 'SB 423 (2023) extends and strengthens SB 35\'s streamlined ministerial approval process for multifamily housing projects meeting affordability thresholds. Projects with 10%+ affordable units in jurisdictions that have not met housing production goals qualify for ministerial approval. Eliminates discretionary review, CEQA requirements, and public hearings for qualifying projects. Applies to urban infill sites in areas meeting RHNA progress standards. Impact: Dramatically reduces entitlement timelines and costs for projects meeting affordability thresholds.',
        applies: (useId, inp) => ['R2','R3','R4','R5','C1.5','C2','C4','TOD'].includes(inp.zoning) && ['multifamily_low','multifamily_mid','multifamily_high','mixeduse'].includes(useId),
        densityBonus: 0,
        parkingReduction: 0,
        softCostReduction: 0.15,
        legalOverride: false,
    },
    {
        id: 'ab2345',
        name: 'AB 2345 (Density Bonus)',
        description: 'Up to 50% density bonus and reduced parking for projects including affordable units.',
        detail: 'AB 2345 (2020) enhances California\'s Density Bonus Law, increasing the maximum density bonus from 35% to 50% for projects including affordable units. Provides up to 4 incentives or concessions such as reduced setbacks, increased height, and reduced parking. Parking minimums reduced to 0.5 spaces per unit for projects near transit. Applies to all residential and mixed-use zones with affordable set-asides meeting specified thresholds. Impact: One of the most widely used tools by LA developers to significantly increase project density and reduce parking requirements.',
        applies: (useId, inp) => ['R2','R3','R4','R5','C1','C1.5','C2','C4','TOD'].includes(inp.zoning) && ['duplex','multifamily_low','multifamily_mid','multifamily_high','mixeduse','senior'].includes(useId),
        densityBonus: 0.50,
        parkingReduction: 0.20,
        softCostReduction: 0,
        legalOverride: false,
    },
    {
        id: 'ab1763',
        name: 'AB 1763',
        description: 'Unlimited density for 100% affordable housing projects near transit.',
        detail: 'AB 1763 (2019) provides unlimited density for 100% affordable housing projects located within half a mile of a major transit stop. Eliminates maximum FAR and unit count restrictions entirely. Parking requirements are set to zero for projects within half a mile of transit. Projects must be 100% affordable with an allowance for manager units. Impact: Enables very high-density affordable development near transit without the typical density caps, making transit-adjacent sites extremely valuable for affordable housing developers.',
        applies: (useId, inp) => ['adjacent','near'].includes(inp.transit) && ['multifamily_low','multifamily_mid','multifamily_high','senior'].includes(useId),
        densityBonus: 1.0,
        parkingReduction: 0,
        softCostReduction: 0,
        legalOverride: true,
    },
    {
        id: 'toc',
        name: 'TOC (LA Local)',
        description: 'Transit Oriented Communities incentives â€” up to 80% density bonus and parking reductions near transit.',
        detail: 'The Transit Oriented Communities (TOC) program is an LA-specific incentive providing density bonuses of up to 80% and significant parking reductions for housing projects near transit. Projects are tiered by proximity: Tier 1 (within 750 ft of a major stop) through Tier 4 (within 2,640 ft), with each tier providing increasing incentives. Affordable units must be included at specified set-aside levels. Impact: The most impactful local density incentive in Los Angeles, enabling significantly larger buildings near Metro stations.',
        applies: (useId, inp) => ['adjacent','near'].includes(inp.transit) && ['multifamily_low','multifamily_mid','multifamily_high','mixeduse'].includes(useId),
        densityBonus: 0.80,
        parkingReduction: 0.30,
        softCostReduction: 0,
        legalOverride: false,
    },
    {
        id: 'ab2097',
        name: 'AB 2097',
        description: 'Eliminates minimum parking requirements within 1/2 mile of major transit stops.',
        detail: 'AB 2097 (2022) eliminates minimum parking requirements for any development within half a mile of a major transit stop in California. Applies to all land use types â€” residential, commercial, and mixed-use â€” not just affordable housing. Local jurisdictions cannot impose minimum parking requirements in these areas. Developers can still choose to build parking, but it is not mandated. Impact: Reduces development costs by $30,000 to $80,000 per eliminated parking space and enables more efficient site utilization near transit.',
        applies: (useId, inp) => ['adjacent','near'].includes(inp.transit),
        densityBonus: 0,
        parkingReduction: 1.0,
        softCostReduction: 0,
        legalOverride: false,
    },
    {
        id: 'adu_reform',
        name: 'ADU Reform (AB 68/SB 13/AB 881)',
        description: 'By-right ADU construction on residential lots; no parking required near transit.',
        detail: 'California\'s ADU reform package (2019-2020) established a comprehensive by-right framework for Accessory Dwelling Units on residential lots. AB 68 allows at least one ADU on any residential lot regardless of local zoning. SB 13 eliminates impact fees for ADUs under 750 SF and caps fees for larger units. AB 881 prohibits local agencies from requiring owner-occupancy or imposing minimum lot sizes. No additional parking is required near transit. Impact: Has generated tens of thousands of new housing units statewide, particularly in single-family neighborhoods.',
        applies: (useId, inp) => ['R1','R2','R3','R4','R5'].includes(inp.zoning) && useId === 'adu',
        densityBonus: 0,
        parkingReduction: 0,
        softCostReduction: 0,
        legalOverride: true,
    },
    {
        id: 'sb478',
        name: 'SB 478',
        description: 'Sets minimum 1.0 FAR for multifamily projects on parcels up to 10,000 SF.',
        detail: 'SB 478 (2021) establishes a minimum floor area ratio (FAR) of 1.0 for multifamily housing projects on parcels of 10,000 SF or less in areas zoned for at least two residential units. Prohibits local jurisdictions from imposing lot coverage limits below 60% on qualifying parcels. Prevents cities from using low FAR limits to effectively block apartment construction on small lots. Applies only to urban infill locations. Impact: Ensures meaningful development potential on small multifamily parcels that might otherwise be restricted by overly conservative FAR limits.',
        applies: (useId, inp) => inp.parcelSize <= 10000 && ['R3','R4','R5','C1.5','C2','C4','TOD'].includes(inp.zoning) && ['multifamily_low','multifamily_mid','multifamily_high'].includes(useId),
        densityBonus: 0,
        parkingReduction: 0,
        softCostReduction: 0,
        legalOverride: false,
        minFAR: 1.0,
    },
    {
        id: 'ed1',
        name: 'ED1 (LA Local)',
        description: 'Executive Directive 1 â€” streamlined approvals and density bonus for 100% affordable and senior housing.',
        detail: 'Executive Directive 1 (2022) is an LA mayoral order streamlining approvals for 100% affordable and senior housing projects in Los Angeles. Provides expedited processing, priority permitting, and fee waivers for qualifying projects. Includes density bonus provisions beyond state law for affordable projects. Directs all city departments to prioritize affordable housing applications and reduce bureaucratic barriers. Impact: Significantly reduces entitlement timelines for affordable housing, with some projects receiving permits in weeks rather than months.',
        applies: (useId, inp) => ['multifamily_low','multifamily_mid','multifamily_high','senior'].includes(useId),
        densityBonus: 0.35,
        parkingReduction: 0,
        softCostReduction: 0.20,
        legalOverride: false,
    },
    {
        id: 'sb684',
        name: 'SB 684',
        description: 'By-right approval for 10+ unit housing projects on commercially zoned land.',
        detail: 'SB 684 (2023) establishes a by-right (ministerial) approval pathway for housing projects of 10 or more units on commercially zoned land. Projects must meet objective design and development standards. Requires compliance with density, height, and FAR limits as defined by local jurisdictions. Overrides local discretionary review requirements and CEQA for qualifying projects on infill sites. Impact: Provides certainty and speed for developers building housing on commercial sites, reducing entitlement risk and project timelines substantially.',
        applies: (useId, inp) => ['C1','C1.5','C2','C4','C5','CM'].includes(inp.zoning) && ['multifamily_low','multifamily_mid','multifamily_high','mixeduse'].includes(useId),
        densityBonus: 0,
        parkingReduction: 0,
        softCostReduction: 0,
        legalOverride: true,
    },
    {
        id: 'sb79',
        name: 'SB 79 (Transit-Oriented)',
        description: 'Overrides local zoning near qualifying transit stations â€” up to 95ft, 160 du/acre, 4.5 FAR.',
        detail: 'SB 79 (effective July 1, 2026) is California\'s transit-oriented development bill that overrides local zoning near qualifying heavy and light rail stations. Tier 1 (heavy rail, including all Metro Rail lines) allows 95ft height, 160 du/acre, and 4.5 FAR. Tier 2 (light rail, BRT, qualifying Metrolink) allows 85ft height, 140 du/acre, and 4.0 FAR. Three distance zones apply: Adjacent (within 200ft of station entrance) and Inner (within 1/4 mile) get full tier benefits and zero parking requirements. Outer zone (1/4 to 1/2 mile) is limited to 65ft height and 3.25 FAR, with 0.5 parking spaces per unit. All projects require 15% affordable units. 100% affordable projects receive the full tier benefits regardless of zone. Impact: Unlocks massive upzoning near every Metro station in LA County, making transit-adjacent parcels significantly more valuable for higher-density development.',
        applies: (useId, inp) => {
            if (!window.lastGeocode) return false;
            if (!['multifamily_low','multifamily_mid','multifamily_high','mixeduse','senior','hotel'].includes(useId)) return false;
            const sb79 = detectSB79Eligibility(window.lastGeocode.lat, window.lastGeocode.lon);
            return sb79.eligible;
        },
        get densityBonus() {
            if (!window.lastGeocode) return 0;
            const sb79 = detectSB79Eligibility(window.lastGeocode.lat, window.lastGeocode.lon);
            if (!sb79.eligible) return 0;
            return sb79.allowances.far / 3.0 - 1;
        },
        get parkingReduction() {
            if (!window.lastGeocode) return 0;
            const sb79 = detectSB79Eligibility(window.lastGeocode.lat, window.lastGeocode.lon);
            if (!sb79.eligible) return 0;
            return sb79.allowances.parking === 0 ? 1.0 : 0.5;
        },
        softCostReduction: 0.10,
        legalOverride: true,
        get minFAR() {
            if (!window.lastGeocode) return 0;
            const sb79 = detectSB79Eligibility(window.lastGeocode.lat, window.lastGeocode.lon);
            if (!sb79.eligible) return 0;
            return sb79.allowances.far;
        },
    },
];

function getApplicableLegislation(useId, inp) {
    return CA_HOUSING_LEGISLATION.filter(bill => bill.applies(useId, inp));
}

function stackLegislationEffects(legislationList) {
    let densityBonus = 0;
    let parkingReduction = 0;
    let softCostReduction = 0;
    let legalOverride = false;
    let minFAR = 0;

    for (const bill of legislationList) {
        densityBonus = Math.max(densityBonus, bill.densityBonus || 0);
        parkingReduction = Math.max(parkingReduction, bill.parkingReduction || 0);
        softCostReduction += (bill.softCostReduction || 0);
        if (bill.legalOverride) legalOverride = true;
        minFAR = Math.max(minFAR, bill.minFAR || 0);
    }

    softCostReduction = Math.min(softCostReduction, 0.50);
    return { densityBonus, parkingReduction, softCostReduction, legalOverride, minFAR };
}


// ============================================================
//  SITE WORK COST BREAKDOWN
// ============================================================

/**
 * Calculate site work cost broken into sub-components.
 * Adjusts for topography, soil conditions, site condition, and use type.
 *
 * Sub-components (all $/SF of lot area unless noted):
 *   1. Clearing & Grubbing  â€” remove vegetation, trees, debris ($1.50-$4.50/SF)
 *   2. Rough Grading         â€” cut/fill, grade to design elevations ($2-$12/SF depending on slope)
 *   3. Soil Prep / Compaction â€” scarify, moisture condition, compact subgrade ($1.50-$5/SF)
 *   4. Utility Rough-In      â€” trench, stub water/sewer/storm/electric/gas to building pad ($3-$8/SF)
 *   5. Erosion / SWPPP        â€” silt fence, BMP, SWPPP compliance during grading ($0.75-$2/SF)
 *
 * @param {string} useId â€” land use type
 * @param {object} inp â€” site input (parcelSize, topography, siteCondition, etc.)
 * @param {number} gsf â€” gross square footage of building
 * @param {object} [rateOverrides] â€” optional user-overridden $/SF rates for each sub-component
 * @returns {object} { clearing, grading, soilPrep, utilities, erosion, total, rates, assumptions }
 */
function calcSiteWorkBreakdown(useId, inp, gsf, rateOverrides) {
    var lot = inp.parcelSize || 10000;

    // ADU: minimal site work scoped to footprint
    if (useId === 'adu') {
        var aduArea = Math.min(lot * 0.3, gsf || 800);
        return { clearing: 0, grading: Math.round(aduArea * 3), soilPrep: Math.round(aduArea * 2),
                 utilities: Math.round(aduArea * 5), erosion: Math.round(aduArea * 1),
                 total: Math.round(aduArea * 11), rates: { clearing: 0, grading: 3, soilPrep: 2, utilities: 5, erosion: 1 },
                 assumptions: 'ADU â€” site work scoped to ADU footprint only (~' + Math.round(aduArea).toLocaleString() + ' SF). Minimal grading, shared utility laterals.' };
    }

    // Base rates ($/SF of lot) â€” typical flat urban infill in LA
    var rates = {
        clearing:  2.00,  // vegetation/debris removal
        grading:   3.50,  // rough grading, cut/fill
        soilPrep:  2.50,  // compaction, moisture conditioning
        utilities: 5.00,  // trench & stub all utilities to pad
        erosion:   1.25,  // SWPPP, silt fence, BMPs
    };

    // --- Adjust for TOPOGRAPHY ---
    if (inp.topography === 'steep') {
        rates.grading = 10.00;   // heavy cut/fill, retaining walls, export
        rates.soilPrep = 4.50;   // deeper compaction, engineered fill
        rates.erosion = 2.00;    // extended SWPPP, slope stabilization
    } else if (inp.topography === 'moderate' || inp.topography === 'sloped') {
        rates.grading = 6.00;    // moderate cut/fill
        rates.soilPrep = 3.25;
        rates.erosion = 1.50;
    }
    // flat = base rates

    // --- Adjust for SITE CONDITION ---
    if (inp.siteCondition === 'vacant') {
        rates.clearing = 1.50;   // minimal â€” empty lot, weeds/fence
    } else if (inp.siteCondition === 'brownfield') {
        rates.clearing = 4.00;   // hazmat screening, debris, potential contaminated soil handling
        rates.soilPrep = 4.00;   // over-excavation, clean fill import
    } else if (inp.siteCondition === 'demolition') {
        rates.clearing = 3.50;   // post-demo debris, asbestos survey area
    }

    // --- Adjust for UTILITIES ---
    if (inp.utilities === 'partial') {
        rates.utilities = 7.00;  // some laterals need extension
    } else if (inp.utilities === 'none') {
        rates.utilities = 12.00; // full utility extension from main to site
    }

    // --- Adjust for CONSTRAINTS ---
    if (inp.constFlood) {
        rates.grading += 2.00;   // flood mitigation grading, raised pad
        rates.erosion += 0.75;   // extra drainage BMPs
    }
    if (inp.constHillside) {
        rates.grading += 3.00;   // hillside grading ordinance compliance
    }
    if (inp.constFault) {
        rates.soilPrep += 1.50;  // fault zone geotech compliance
    }

    // Apply user overrides if provided
    if (rateOverrides) {
        if (rateOverrides.clearing !== undefined) rates.clearing = rateOverrides.clearing;
        if (rateOverrides.grading !== undefined) rates.grading = rateOverrides.grading;
        if (rateOverrides.soilPrep !== undefined) rates.soilPrep = rateOverrides.soilPrep;
        if (rateOverrides.utilities !== undefined) rates.utilities = rateOverrides.utilities;
        if (rateOverrides.erosion !== undefined) rates.erosion = rateOverrides.erosion;
    }

    var clearing  = Math.round(lot * rates.clearing);
    var grading   = Math.round(lot * rates.grading);
    var soilPrep  = Math.round(lot * rates.soilPrep);
    var utilities = Math.round(lot * rates.utilities);
    var erosion   = Math.round(lot * rates.erosion);
    var total     = clearing + grading + soilPrep + utilities + erosion;

    // Build human-readable assumption string
    var assumptionParts = [];
    if (inp.topography === 'steep') assumptionParts.push('steep slope (+heavy grading, retaining, export)');
    else if (inp.topography === 'moderate' || inp.topography === 'sloped') assumptionParts.push('moderate slope (+additional grading)');
    else assumptionParts.push('flat/level grade (standard grading)');
    if (inp.siteCondition === 'brownfield') assumptionParts.push('brownfield (+over-excavation, clean fill)');
    else if (inp.siteCondition === 'demolition') assumptionParts.push('post-demo site (+debris handling)');
    else if (inp.siteCondition === 'vacant') assumptionParts.push('vacant lot (minimal clearing)');
    if (inp.utilities === 'none') assumptionParts.push('no utilities (+full lateral extension)');
    else if (inp.utilities === 'partial') assumptionParts.push('partial utilities (+lateral extensions)');
    if (inp.constFlood) assumptionParts.push('flood zone (+raised pad, drainage)');
    if (inp.constHillside) assumptionParts.push('hillside (+ordinance compliance)');
    if (inp.constFault) assumptionParts.push('fault zone (+geotech)');

    return {
        clearing: clearing, grading: grading, soilPrep: soilPrep, utilities: utilities, erosion: erosion,
        total: total, rates: rates,
        assumptions: assumptionParts.join('; '),
    };
}

// ============================================================
//  BUILDING PROGRAM & BUDGET DATA
// ============================================================

const BUILDING_PARAMS = {
    sfr:              { stories: 2,  floorH: 10, eff: 0.92, unitSF: 1800, parkRatio: 2.0,  setF: 20, setS: 5,  opex: 0.30, cap: 0.045 },
    duplex:           { stories: 2,  floorH: 10, eff: 0.90, unitSF: 1200, parkRatio: 1.5,  setF: 15, setS: 5,  opex: 0.32, cap: 0.047 },
    multifamily_low:  { stories: 4,  floorH: 10, eff: 0.82, unitSF: 850,  parkRatio: 1.25, setF: 10, setS: 5,  opex: 0.35, cap: 0.047 },
    multifamily_mid:  { stories: 7,  floorH: 10, eff: 0.80, unitSF: 800,  parkRatio: 1.0,  setF: 10, setS: 5,  opex: 0.35, cap: 0.045 },
    multifamily_high: { stories: 18, floorH: 10, eff: 0.78, unitSF: 750,  parkRatio: 1.0,  setF: 10, setS: 10, opex: 0.38, cap: 0.042 },
    mixeduse:         { stories: 6,  floorH: 12, eff: 0.80, unitSF: 850,  parkRatio: 1.0,  setF: 0,  setS: 0,  opex: 0.36, cap: 0.048 },
    retail:           { stories: 1,  floorH: 16, eff: 0.88, unitSF: null, parkRatio: 4.0,  setF: 0,  setS: 0,  opex: 0.32, cap: 0.058 },
    office:           { stories: 5,  floorH: 13, eff: 0.85, unitSF: null, parkRatio: 3.0,  setF: 5,  setS: 5,  opex: 0.38, cap: 0.065 },
    medical:          { stories: 4,  floorH: 13, eff: 0.82, unitSF: null, parkRatio: 4.0,  setF: 10, setS: 5,  opex: 0.40, cap: 0.055 },
    hotel:            { stories: 10, floorH: 11, eff: 0.75, unitSF: 400,  parkRatio: 0.5,  setF: 5,  setS: 5,  opex: 0.55, cap: 0.070 },
    industrial:       { stories: 1,  floorH: 24, eff: 0.92, unitSF: null, parkRatio: 1.0,  setF: 10, setS: 5,  opex: 0.28, cap: 0.052 },
    selfstorage:      { stories: 4,  floorH: 9,  eff: 0.88, unitSF: null, parkRatio: 0.2,  setF: 5,  setS: 5,  opex: 0.30, cap: 0.062 },
    senior:           { stories: 5,  floorH: 10, eff: 0.78, unitSF: 600,  parkRatio: 0.5,  setF: 10, setS: 5,  opex: 0.50, cap: 0.058 },
    parking:          { stories: 5,  floorH: 11, eff: 0.90, unitSF: null, parkRatio: null, setF: 0,  setS: 0,  opex: 0.25, cap: 0.065 },
    creative:         { stories: 3,  floorH: 14, eff: 0.85, unitSF: null, parkRatio: 2.5,  setF: 0,  setS: 0,  opex: 0.32, cap: 0.058 },
    adu:              { stories: 2,  floorH: 9,  eff: 0.90, unitSF: 600,  parkRatio: 0,    setF: 5,  setS: 4,  opex: 0.30, cap: 0.048 },
};

const TIMELINE_MONTHS = {
    sfr:              { entitlement: 2,  design: 2,  permits: 2, construction: 10, leaseup: 1 },
    duplex:           { entitlement: 3,  design: 2,  permits: 2, construction: 12, leaseup: 1 },
    multifamily_low:  { entitlement: 6,  design: 4,  permits: 3, construction: 18, leaseup: 6 },
    multifamily_mid:  { entitlement: 8,  design: 5,  permits: 4, construction: 24, leaseup: 8 },
    multifamily_high: { entitlement: 12, design: 8,  permits: 6, construction: 36, leaseup: 10 },
    mixeduse:         { entitlement: 8,  design: 5,  permits: 4, construction: 22, leaseup: 8 },
    retail:           { entitlement: 4,  design: 3,  permits: 2, construction: 10, leaseup: 4 },
    office:           { entitlement: 6,  design: 4,  permits: 3, construction: 18, leaseup: 8 },
    medical:          { entitlement: 6,  design: 5,  permits: 4, construction: 16, leaseup: 6 },
    hotel:            { entitlement: 10, design: 6,  permits: 5, construction: 28, leaseup: 12 },
    industrial:       { entitlement: 4,  design: 3,  permits: 2, construction: 10, leaseup: 3 },
    selfstorage:      { entitlement: 4,  design: 3,  permits: 2, construction: 12, leaseup: 12 },
    senior:           { entitlement: 8,  design: 5,  permits: 4, construction: 22, leaseup: 10 },
    parking:          { entitlement: 4,  design: 3,  permits: 2, construction: 14, leaseup: 2 },
    creative:         { entitlement: 4,  design: 3,  permits: 2, construction: 14, leaseup: 6 },
    adu:              { entitlement: 1,  design: 1,  permits: 2, construction: 8,  leaseup: 1 },
};

const USE_COLORS = {
    sfr: '#4a9e5c', duplex: '#5ba86e', multifamily_low: '#3182ce', multifamily_mid: '#2b6cb0',
    multifamily_high: '#1a4791', mixeduse: '#805ad5', retail: '#dd6b20', office: '#2c5282',
    medical: '#38a169', hotel: '#b83280', industrial: '#718096', selfstorage: '#a0aec0',
    senior: '#d69e2e', parking: '#4a5568', creative: '#ed8936', adu: '#48bb78',
};


// ============================================================
//  SCORING FUNCTIONS
// ============================================================

function getInputs() {
    return {
        parcelSize:    parseFloat(document.getElementById('parcelSize').value) || 10000,
        frontage:      parseFloat(document.getElementById('frontage').value) || 80,
        zoning:        document.getElementById('zoning').value,
        neighborhood:  document.getElementById('neighborhood').value,
        siteCondition: document.getElementById('siteCondition').value,
        topography:    document.getElementById('topography').value,
        cornerLot:     document.getElementById('cornerLot').value === 'yes',
        transit:       document.getElementById('transit').value,
        arterial:      document.getElementById('arterial').value,
        utilities:     document.getElementById('utilities').value,
        constFlood:    document.getElementById('constFlood').checked,
        constHillside: document.getElementById('constHillside').checked,
        constHistoric: document.getElementById('constHistoric').checked,
        constFault:    document.getElementById('constFault').checked,
        constCoastal:  document.getElementById('constCoastal').checked,
        constParking:  document.getElementById('constParking').checked,
    };
}

function scoreLegal(useId, inp, effects) {
    const zoneRow = ZONING_MATRIX[inp.zoning];
    if (!zoneRow) return 0;
    let base = zoneRow[useId] || 0;

    // CA Housing Legislation: by-right override
    if (effects && effects.legalOverride) {
        base = 1.0;
    }

    // Historic overlay reduces redevelopment permission
    if (inp.constHistoric && ['multifamily_high', 'hotel', 'industrial'].includes(useId)) {
        base *= 0.5;
    }
    // Coastal zone limits industrial, dense residential
    if (inp.constCoastal && ['industrial', 'multifamily_high', 'selfstorage'].includes(useId)) {
        base *= 0.4;
    }
    // Hillside ordinance restricts density
    if (inp.constHillside && ['multifamily_mid', 'multifamily_high', 'hotel', 'industrial'].includes(useId)) {
        base *= 0.3;
    }
    return Math.min(base, 1.0);
}

function scorePhysical(useId, inp) {
    let score = 1.0;

    // Parcel size check
    const minSqFt = MIN_PARCEL[useId] || 2000;
    if (inp.parcelSize < minSqFt) {
        score *= Math.max(0.1, inp.parcelSize / minSqFt);
    } else if (inp.parcelSize > minSqFt * 3) {
        score *= 1.0; // plenty of room
    }

    // Frontage adequacy
    const needsFrontage = ['retail', 'mixeduse', 'hotel', 'office', 'medical'];
    if (needsFrontage.includes(useId) && inp.frontage < 50) {
        score *= 0.6;
    }

    // Topography
    const topoPenalty = { flat: 1.0, gentle: 0.9, moderate: 0.65, steep: 0.3 };
    const baseTopo = topoPenalty[inp.topography] || 1.0;
    // Some uses are more topo-tolerant
    if (['parking', 'selfstorage'].includes(useId)) {
        score *= Math.max(baseTopo, 0.7);
    } else if (['industrial', 'multifamily_high', 'hotel'].includes(useId)) {
        score *= baseTopo * 0.9; // extra sensitive
    } else {
        score *= baseTopo;
    }

    // Utilities
    if (inp.utilities === 'partial') score *= 0.85;
    if (inp.utilities === 'none') score *= 0.5;

    // Site condition
    if (inp.siteCondition === 'demolition') score *= 0.85;
    if (inp.siteCondition === 'brownfield') score *= 0.6;

    // Flood zone
    if (inp.constFlood) score *= 0.7;

    // Fault zone â€” penalizes tall structures
    if (inp.constFault && ['multifamily_high', 'hotel', 'office'].includes(useId)) {
        score *= 0.7;
    }

    return Math.min(score, 1.0);
}

function scoreFinancial(useId, inp, effects) {
    // Compute effective FAR with legislation bonuses
    const baseFAR = FAR_TYPICAL[useId] || 1.0;
    let far = baseFAR;
    if (effects) {
        far = baseFAR * (1 + effects.densityBonus);
        if (effects.minFAR > 0) far = Math.max(far, effects.minFAR);
    }

    const params = BUILDING_PARAMS[useId];
    const buildableSF = inp.parcelSize * far;
    const nsf = buildableSF * (params ? params.eff : 0.82);
    const landValuePSF = LAND_VALUE_PSF[inp.neighborhood] || 150;
    // ADU is an addition â€” no land acquisition cost
    const landCost = useId === 'adu' ? 0 : inp.parcelSize * landValuePSF;

    // Build cost with parking reduction from legislation
    let buildCostPerSF = BUILD_COST_PSF[useId] || 300;
    if (effects && effects.parkingReduction > 0) {
        buildCostPerSF *= (1 - effects.parkingReduction * 0.18);
    }
    const buildCost = buildableSF * buildCostPerSF;

    // Parking cost (use-specific)
    const parkCostPerSpace = PARKING_COST_MAP[useId] || 35000;
    const baseParkRatio = params ? (params.parkRatio || 0) : 0;
    const parkReduction = effects ? effects.parkingReduction : 0;
    const hasUnits = params && params.unitSF;
    let parkSpaces = 0;
    if (useId === 'parking') parkSpaces = Math.round(buildableSF / 350);
    else if (hasUnits) parkSpaces = Math.max(0, Math.ceil(Math.floor(nsf / params.unitSF) * baseParkRatio * (1 - parkReduction)));
    else parkSpaces = Math.max(0, Math.ceil(buildableSF / 1000 * baseParkRatio * (1 - parkReduction)));
    const parkingCost = parkSpaces * parkCostPerSpace;

    // Total cost including overhead (parking, contingency, soft costs)
    // Site work cost (uses breakdown function for consistency)
    const siteWorkCost = calcSiteWorkBreakdown(useId, inp, buildableSF).total;
    const hardCostBase = buildCost + parkingCost + siteWorkCost;
    const totalHard = hardCostBase * 1.11; // ~4% landscaping + 7% contingency
    const totalSoft = totalHard * 0.235; // ~23.5% (A&E 8%, permits 5%, legal 2%, financing 4.5%, dev fee 4%)
    let totalCost = landCost + totalHard + totalSoft;
    if (effects && effects.softCostReduction > 0) {
        totalCost -= totalSoft * effects.softCostReduction * 0.20;
    }

    // Annual NOI with neighborhood rent adjustment
    const rentMult = NEIGHBORHOOD_RENT_MULT[inp.neighborhood] || 1.0;
    const opexRate = params ? params.opex : 0.35;
    const annualNOI = nsf * (REVENUE_PSF[useId] || 30) * rentMult * (1 - opexRate);

    // Yield-on-cost and development margin
    const yieldOnCost = annualNOI / totalCost;
    const capRate = params ? params.cap : 0.05;
    const devMargin = capRate > 0 ? (yieldOnCost / capRate - 1) : 0;

    // Score based on dev margin â€” directly ties to project profitability
    let score;
    if (devMargin >= 0.25) score = 1.0;
    else if (devMargin >= 0.15) score = 0.75 + (devMargin - 0.15) / 0.10 * 0.25;
    else if (devMargin >= 0.05) score = 0.45 + (devMargin - 0.05) / 0.10 * 0.30;
    else if (devMargin >= 0) score = 0.20 + (devMargin / 0.05) * 0.25;
    else if (devMargin >= -0.15) score = Math.max(0.02, 0.20 + devMargin * 1.2);
    else score = 0.02;

    // Neighborhood demand multiplier
    const demandRow = NEIGHBORHOOD_DEMAND[inp.neighborhood];
    const demand = demandRow ? (demandRow[useId] || 0.7) : 0.7;
    score *= demand;

    // Corner lot bonus for visibility-dependent uses
    if (inp.cornerLot && ['retail', 'mixeduse', 'hotel', 'office', 'medical'].includes(useId)) {
        score *= 1.15;
    }

    // Transit proximity bonus
    const transitBonus = { adjacent: 1.2, near: 1.1, moderate: 1.0, far: 0.85 };
    if (['multifamily_mid', 'multifamily_high', 'mixeduse', 'office', 'hotel'].includes(useId)) {
        score *= (transitBonus[inp.transit] || 1.0);
    }

    // Arterial bonus
    if (inp.arterial === 'major' && ['retail', 'mixeduse', 'hotel', 'office'].includes(useId)) {
        score *= 1.1;
    }
    if (inp.arterial === 'residential' && ['retail', 'hotel', 'industrial'].includes(useId)) {
        score *= 0.7;
    }

    // Site condition cost adjustments
    if (inp.siteCondition === 'demolition') score *= 0.9;
    if (inp.siteCondition === 'brownfield') score *= 0.7;

    // Parking constraints
    if (inp.constParking && ['retail', 'office', 'medical', 'hotel'].includes(useId)) {
        score *= 0.8;
    }

    // ADU bonus: low total cost, zero parking, by-right, fastest timeline,
    // can add to existing structure â€” highest ROI per dollar invested
    if (useId === 'adu') {
        // ADU total investment is a fraction of ground-up projects, so the dev-margin
        // math (which divides NOI by total cost incl. land) understates its attractiveness.
        // Boost reflects: minimal entitlement risk, 13-month timeline, no parking cost.
        score = Math.max(score, 0.55);
        // Extra lift for residential zones where ADU is by-right
        if (['R1','R2','R3'].includes(inp.zoning)) score *= 1.25;
        // ADU excels on smaller/mid-size parcels with existing structures
        if (inp.siteCondition === 'improved' || inp.siteCondition === 'vacant') score *= 1.10;
    }

    return Math.min(score, 1.0);
}

function scoreProductive(useId, inp, effects) {
    // Compute effective FAR with legislation bonuses
    const baseFAR = FAR_TYPICAL[useId] || 1.0;
    let far = baseFAR;
    if (effects) {
        far = baseFAR * (1 + effects.densityBonus);
        if (effects.minFAR > 0) far = Math.max(far, effects.minFAR);
    }

    const buildableSF = inp.parcelSize * far;
    const revenuePSF = REVENUE_PSF[useId] || 30;
    const rentMult = NEIGHBORHOOD_RENT_MULT[inp.neighborhood] || 1.0;
    const totalAnnualRev = buildableSF * revenuePSF * rentMult;
    const landValuePSF = LAND_VALUE_PSF[inp.neighborhood] || 150;

    // Revenue-to-land-value ratio (higher = more productive per dollar of land)
    const revToLand = totalAnnualRev / (inp.parcelSize * landValuePSF);

    // Normalize
    let score;
    if (revToLand >= 0.20) score = 1.0;
    else if (revToLand >= 0.10) score = 0.5 + (revToLand - 0.10) / 0.10 * 0.5;
    else score = revToLand / 0.10 * 0.5;

    // Demand multiplier
    const demandRow = NEIGHBORHOOD_DEMAND[inp.neighborhood];
    const demand = demandRow ? (demandRow[useId] || 0.7) : 0.7;
    score *= demand;

    // ADU productivity: revenue-to-land-value underrates ADU because it
    // doesn't require using the full parcel â€” it adds income to an existing
    // property. Adjust to reflect incremental value-add ROI.
    if (useId === 'adu') {
        score = Math.max(score, 0.45);
        if (['R1','R2','R3'].includes(inp.zoning)) score *= 1.20;
    }

    return Math.min(score, 1.0);
}


// ============================================================
//  MAIN CALCULATION
// ============================================================

let lastResults = null;
let lastInputs = null;

function calculateHBU() {
    const inp = getInputs();

    // Score all uses
    const results = LAND_USES.map(use => {
        const legislation = getApplicableLegislation(use.id, inp);
        const effects = stackLegislationEffects(legislation);

        const legal      = scoreLegal(use.id, inp, effects);
        const physical   = scorePhysical(use.id, inp);
        const financial  = scoreFinancial(use.id, inp, effects);
        const productive = scoreProductive(use.id, inp, effects);

        // Compute actual dev margin for feasibility check
        const budget = generateBudget(use.id, inp, effects);
        const devMarginPct = budget.devMargin;

        // HBU must pass ALL four tests. Weight: Legal gateway, then others.
        // If legal = 0, overall = 0
        let overall;
        if (legal === 0) {
            overall = 0;
        } else {
            overall = legal * 0.25 + physical * 0.20 + financial * 0.30 + productive * 0.25;
            // Penalize further if legal is only conditional
            if (legal <= 0.5) overall *= 0.8;
            // Feasibility gate â€” penalize uses that lose money
            if (devMarginPct < -0.15) overall *= 0.50;
            else if (devMarginPct < -0.05) overall *= 0.65;
            else if (devMarginPct < 0) overall *= 0.80;
        }

        return {
            ...use,
            legal: Math.round(legal * 100),
            physical: Math.round(physical * 100),
            financial: Math.round(financial * 100),
            productive: Math.round(productive * 100),
            overall: Math.round(overall * 100),
            devMarginPct,
            legislation,
        };
    });

    // Sort by overall descending
    results.sort((a, b) => b.overall - a.overall);

    // Store for modal access
    lastResults = results;
    lastInputs = inp;

    // Render
    renderResults(results, inp);

    // SB 79 Map â€” show if we have geocoded coordinates
    if (window.lastGeocode && typeof L !== 'undefined') {
        const { lat, lon } = window.lastGeocode;
        const sb79 = detectSB79Eligibility(lat, lon);
        document.getElementById('mapSection').style.display = 'block';
        initSB79Map(lat, lon);
        renderSB79Eligibility(sb79);
    }
}


// ============================================================
//  RENDER
// ============================================================

function renderResults(results, inp) {
    const container = document.getElementById('results');
    container.classList.add('visible');

    // Summary
    document.getElementById('resultsSummary').textContent =
        `Analysis for a ${inp.parcelSize.toLocaleString()} SF parcel, zoned ${inp.zoning}, in ${document.getElementById('neighborhood').selectedOptions[0].text}.`;

    // Feasibility warning banner
    const topMargin = results[0] ? results[0].devMarginPct : 0;
    const anyFeasible = results.slice(0, 3).some(r => r.devMarginPct >= 0);
    let warningHTML = '';
    if (!anyFeasible) {
        warningHTML = `<div style="background:#fff5f5;border:1px solid #fc8181;border-radius:10px;padding:1rem 1.25rem;margin-bottom:1.25rem;font-size:0.88rem;color:#c53030;">
            <strong>No Feasible Development Identified</strong> â€” Based on current market rents, construction costs, and land values, none of the evaluated uses produce a positive development margin at this site. Consider: (1) acquiring the land below market, (2) a condo/for-sale exit strategy, (3) value-add renovation of the existing structure, or (4) holding the property.
        </div>`;
    } else if (topMargin < 0.10) {
        warningHTML = `<div style="background:#fffff0;border:1px solid #ecc94b;border-radius:10px;padding:0.85rem 1.15rem;margin-bottom:1.25rem;font-size:0.85rem;color:#b7791f;">
            <strong>Marginal Feasibility</strong> â€” The top-ranked use shows a ${(topMargin * 100).toFixed(0)}% development margin. Most developers target 15-25%. Profitability depends on favorable execution, cost control, and rent achievement.
        </div>`;
    }

    // Top 3 cards
    const cardsDiv = document.getElementById('resultCards');
    cardsDiv.innerHTML = warningHTML;

    const rankLabels = ['1st â€” Best Use', '2nd â€” Alternative', '3rd â€” Alternative'];
    const rankClasses = ['rank-1', 'rank-2', 'rank-3'];

    for (let i = 0; i < 3; i++) {
        const r = results[i];
        const effects = stackLegislationEffects(r.legislation || []);
        const metricsHTML = generateCardMetricsHTML(r.id, inp, effects, r);
        const legBadges = r.legislation && r.legislation.length > 0
            ? `<div class="legislation-badges">
                   <div class="leg-label">Applicable Legislation</div>
                   ${r.legislation.map(b => `<span class="legislation-badge clickable" onclick="event.stopPropagation();showLegislationDetail('${b.id}')">${b.name}</span>`).join('')}
               </div>`
            : '';

        // Feasibility badge
        let feasBadge = '';
        if (r.devMarginPct >= 0.15) feasBadge = '<span style="display:inline-block;font-size:0.7rem;font-weight:700;padding:0.15rem 0.5rem;border-radius:999px;background:#f0fff4;color:#276749;margin-left:0.5rem;">FEASIBLE</span>';
        else if (r.devMarginPct >= 0) feasBadge = '<span style="display:inline-block;font-size:0.7rem;font-weight:700;padding:0.15rem 0.5rem;border-radius:999px;background:#fffff0;color:#b7791f;margin-left:0.5rem;">MARGINAL</span>';
        else feasBadge = '<span style="display:inline-block;font-size:0.7rem;font-weight:700;padding:0.15rem 0.5rem;border-radius:999px;background:#fff5f5;color:#c53030;margin-left:0.5rem;">NOT FEASIBLE</span>';

        const card = document.createElement('div');
        card.className = `result-card ${rankClasses[i]}`;
        card.style.cursor = 'pointer';
        card.onclick = ((idx) => () => openAnalysis(idx))(i);
        card.innerHTML = `
            <div class="rank-banner">
                <span class="rank-num">#${i + 1}</span>
                ${rankLabels[i]}${feasBadge}
            </div>
            <div class="card-body">
                <div class="use-name">${r.icon} ${r.name}</div>

                <div class="score-bar-container">
                    <div class="score-label"><span>Legally Permissible</span><span>${r.legal}%</span></div>
                    <div class="score-bar"><div class="score-bar-fill legal" style="width: ${r.legal}%"></div></div>
                </div>
                <div class="score-bar-container">
                    <div class="score-label"><span>Physically Possible</span><span>${r.physical}%</span></div>
                    <div class="score-bar"><div class="score-bar-fill physical" style="width: ${r.physical}%"></div></div>
                </div>
                <div class="score-bar-container">
                    <div class="score-label"><span>Financially Feasible</span><span>${r.financial}%</span></div>
                    <div class="score-bar"><div class="score-bar-fill financial" style="width: ${r.financial}%"></div></div>
                </div>
                <div class="score-bar-container">
                    <div class="score-label"><span>Maximally Productive</span><span>${r.productive}%</span></div>
                    <div class="score-bar"><div class="score-bar-fill productive" style="width: ${r.productive}%"></div></div>
                </div>

                <div class="overall-score">
                    <div class="big-score">${r.overall}</div>
                    <span>/ 100<br>Overall Score</span>
                </div>

                ${metricsHTML}

                <div class="rationale">${RATIONALE[r.id] || ''}</div>
                ${legBadges}
                <div class="click-hint">Click for detailed analysis</div>
            </div>
        `;
        cardsDiv.appendChild(card);
    }

    // ADU Quick-Win callout â€” show when ADU is legally permissible but not in top 3
    const aduResult = results.find(r => r.id === 'adu');
    const aduInTop3 = results.slice(0, 3).some(r => r.id === 'adu');
    if (aduResult && aduResult.legal > 0 && !aduInTop3) {
        const aduIdx = results.indexOf(aduResult);
        const aduEffects = stackLegislationEffects(aduResult.legislation || []);
        const aduMetrics = generateCardMetricsHTML('adu', inp, aduEffects, aduResult);
        const aduLeg = aduResult.legislation && aduResult.legislation.length > 0
            ? `<div class="legislation-badges"><div class="leg-label">Applicable Legislation</div>${aduResult.legislation.map(b => `<span class="legislation-badge clickable" onclick="event.stopPropagation();showLegislationDetail('${b.id}')">${b.name}</span>`).join('')}</div>` : '';
        let aduFeasBadge = '';
        if (aduResult.devMarginPct >= 0.15) aduFeasBadge = '<span style="display:inline-block;font-size:0.7rem;font-weight:700;padding:0.15rem 0.5rem;border-radius:999px;background:#f0fff4;color:#276749;margin-left:0.5rem;">FEASIBLE</span>';
        else if (aduResult.devMarginPct >= 0) aduFeasBadge = '<span style="display:inline-block;font-size:0.7rem;font-weight:700;padding:0.15rem 0.5rem;border-radius:999px;background:#fffff0;color:#b7791f;margin-left:0.5rem;">MARGINAL</span>';
        else aduFeasBadge = '<span style="display:inline-block;font-size:0.7rem;font-weight:700;padding:0.15rem 0.5rem;border-radius:999px;background:#fff5f5;color:#c53030;margin-left:0.5rem;">NOT FEASIBLE</span>';

        const aduCard = document.createElement('div');
        aduCard.className = 'result-card';
        aduCard.style.cssText = 'cursor:pointer;border-left:4px solid #48bb78;margin-top:1rem;';
        aduCard.onclick = () => openAnalysis(aduIdx);
        aduCard.innerHTML = `
            <div class="rank-banner" style="background:linear-gradient(135deg,#276749,#48bb78);color:white;">
                <span class="rank-num" style="background:rgba(255,255,255,0.25);color:white;">ADU</span>
                Quick Win â€” ADU Addition${aduFeasBadge}
            </div>
            <div class="card-body">
                <div class="use-name">${aduResult.icon} ${aduResult.name}</div>
                <div style="font-size:0.82rem;color:var(--text-light);margin-bottom:0.75rem;">
                    Lowest cost, shortest timeline (~13 months), by-right under CA law. Can be added to existing structures without full redevelopment. Zero parking required near transit.
                </div>
                <div class="score-bar-container">
                    <div class="score-label"><span>Legally Permissible</span><span>${aduResult.legal}%</span></div>
                    <div class="score-bar"><div class="score-bar-fill legal" style="width: ${aduResult.legal}%"></div></div>
                </div>
                <div class="score-bar-container">
                    <div class="score-label"><span>Physically Possible</span><span>${aduResult.physical}%</span></div>
                    <div class="score-bar"><div class="score-bar-fill physical" style="width: ${aduResult.physical}%"></div></div>
                </div>
                <div class="score-bar-container">
                    <div class="score-label"><span>Financially Feasible</span><span>${aduResult.financial}%</span></div>
                    <div class="score-bar"><div class="score-bar-fill financial" style="width: ${aduResult.financial}%"></div></div>
                </div>
                <div class="score-bar-container">
                    <div class="score-label"><span>Maximally Productive</span><span>${aduResult.productive}%</span></div>
                    <div class="score-bar"><div class="score-bar-fill productive" style="width: ${aduResult.productive}%"></div></div>
                </div>
                <div class="overall-score">
                    <div class="big-score">${aduResult.overall}</div>
                    <span>/ 100<br>Overall Score</span>
                </div>
                ${aduMetrics}
                <div class="rationale">${RATIONALE['adu'] || ''}</div>
                ${aduLeg}
                <div class="click-hint">Click for detailed analysis</div>
            </div>
        `;
        cardsDiv.appendChild(aduCard);
    }

    // Legislation section â€” collect unique bills from top 3
    const legSection = document.getElementById('legislationSection');
    const allLegislation = new Map();
    for (let i = 0; i < 3 && i < results.length; i++) {
        if (results[i].legislation) {
            for (const bill of results[i].legislation) {
                if (!allLegislation.has(bill.id)) {
                    allLegislation.set(bill.id, bill);
                }
            }
        }
    }

    if (allLegislation.size > 0) {
        legSection.style.display = 'block';
        let legHTML = '<h3>Applicable California Housing Legislation</h3>';
        legHTML += '<div class="legislation-cards">';
        for (const bill of allLegislation.values()) {
            legHTML += `<div class="legislation-card clickable" onclick="showLegislationDetail('${bill.id}')"><strong>${bill.name}</strong><p>${bill.description}</p></div>`;
        }
        legHTML += '</div>';
        legSection.innerHTML = legHTML;
    } else {
        legSection.style.display = 'none';
        legSection.innerHTML = '';
    }

    // Full table â€” split into permissible vs excluded
    const tbody = document.getElementById('detailsBody');
    const excludedBody = document.getElementById('excludedBody');
    tbody.innerHTML = '';
    excludedBody.innerHTML = '';

    const formatCell = (val) => {
        if (val >= 70) return `<span class="pass">${val}%</span>`;
        if (val >= 40) return `<span class="partial">${val}%</span>`;
        if (val > 0)   return `<span class="fail">${val}%</span>`;
        return `<span class="fail">N/A</span>`;
    };

    let permissibleRank = 0;
    let excludedCount = 0;
    const zoningLabel = document.getElementById('zoning').selectedOptions[0].text;

    results.forEach((r) => {
        if (r.legal > 0) {
            permissibleRank++;
            const tr = document.createElement('tr');
            if (permissibleRank <= 3) tr.className = 'top-3';
            tr.innerHTML = `
                <td>${permissibleRank}</td>
                <td>${r.icon} ${r.name}</td>
                <td>${formatCell(r.legal)}</td>
                <td>${formatCell(r.physical)}</td>
                <td>${formatCell(r.financial)}</td>
                <td>${formatCell(r.productive)}</td>
                <td><strong>${r.overall}%</strong></td>
            `;
            tbody.appendChild(tr);
        } else {
            excludedCount++;
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${r.icon} ${r.name}</td>
                <td>${formatCell(r.physical)}</td>
                <td>${formatCell(r.financial)}</td>
                <td>${formatCell(r.productive)}</td>
                <td><span class="fail">Not permitted under ${zoningLabel} zoning</span></td>
            `;
            excludedBody.appendChild(tr);
        }
    });

    const excludedSection = document.getElementById('excludedSection');
    if (excludedCount > 0) {
        excludedSection.style.display = 'block';
        document.getElementById('excludedCount').textContent = excludedCount;
        // Reset toggle state
        document.getElementById('excludedTable').style.display = 'none';
        document.getElementById('toggleExcluded').innerHTML =
            `â–¶ Show <span id="excludedCount">${excludedCount}</span> uses not legally permissible under current zoning`;
    } else {
        excludedSection.style.display = 'none';
    }

    // Show print button
    document.getElementById('btnPrint').classList.add('visible');

    // Scroll to results
    container.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function exportPDF() {
    // Set the print date
    const now = new Date();
    const dateStr = now.toLocaleDateString('en-US', {
        year: 'numeric', month: 'long', day: 'numeric',
        hour: '2-digit', minute: '2-digit'
    });
    document.getElementById('printDate').textContent = `Report generated: ${dateStr}  |  CLS CRE Brokerage â€” HBU Analysis`;

    // Trigger browser print dialog (user can select "Save as PDF")
    window.print();
}

function toggleExcludedUses() {
    const table = document.getElementById('excludedTable');
    const btn = document.getElementById('toggleExcluded');
    const count = document.getElementById('excludedCount')?.textContent || '0';
    if (table.style.display === 'none') {
        table.style.display = 'block';
        btn.innerHTML = `â–¼ Hide <span id="excludedCount">${count}</span> uses not legally permissible under current zoning`;
    } else {
        table.style.display = 'none';
        btn.innerHTML = `â–¶ Show <span id="excludedCount">${count}</span> uses not legally permissible under current zoning`;
    }
}


// ============================================================
//  DETAILED ANALYSIS MODAL
// ============================================================

// --- Debounce utility for heavy recalc functions ---
// Wraps a function so rapid successive calls only execute after a pause.
// Used on all slider/input recalc handlers to prevent excessive recomputation.
function _debounce(fn, delay) {
    var timer = null;
    return function() {
        var ctx = this, args = arguments;
        clearTimeout(timer);
        timer = setTimeout(function() { fn.apply(ctx, args); }, delay);
    };
}
// Self-debouncing wrapper: replaces a global function with a debounced version.
// The function still syncs slider display values immediately, but delays heavy DOM work.
var _recalcTimers = {};
function _debouncedCall(name, fn, delay) {
    clearTimeout(_recalcTimers[name]);
    _recalcTimers[name] = setTimeout(fn, delay);
}

function fmt(n) {
    return '$' + Math.round(n).toLocaleString();
}

function adjustColor(hex, amount) {
    let r = parseInt(hex.slice(1, 3), 16);
    let g = parseInt(hex.slice(3, 5), 16);
    let b = parseInt(hex.slice(5, 7), 16);
    r = Math.max(0, Math.min(255, r + amount));
    g = Math.max(0, Math.min(255, g + amount));
    b = Math.max(0, Math.min(255, b + amount));
    return '#' + [r, g, b].map(c => c.toString(16).padStart(2, '0')).join('');
}

function generateBudget(useId, inp, effects) {
    const params = BUILDING_PARAMS[useId];
    const baseFAR = FAR_TYPICAL[useId] || 1.0;
    let far = baseFAR;
    if (effects) {
        far = baseFAR * (1 + effects.densityBonus);
        if (effects.minFAR > 0) far = Math.max(far, effects.minFAR);
    }

    const gsf = Math.round(inp.parcelSize * far);
    const nsf = Math.round(gsf * params.eff);
    const stories = Math.max(params.stories, Math.ceil(gsf / (inp.parcelSize * 0.7)));
    const buildingHeight = stories * params.floorH;
    const buildingFootprint = Math.min(Math.round(inp.parcelSize * 0.7), Math.round(gsf / stories));
    const units = params.unitSF ? Math.max(1, Math.floor(nsf / params.unitSF)) : null;

    // Parking (use-specific cost per space)
    const baseParkRatio = params.parkRatio || 0;
    const parkReduction = effects ? effects.parkingReduction : 0;
    let parkingSpaces;
    if (useId === 'parking') {
        parkingSpaces = Math.round(gsf / 350);
    } else if (units) {
        parkingSpaces = Math.max(0, Math.ceil(units * baseParkRatio * (1 - parkReduction)));
    } else {
        parkingSpaces = Math.max(0, Math.ceil(gsf / 1000 * baseParkRatio * (1 - parkReduction)));
    }
    const parkingCostPerSpace = PARKING_COST_MAP[useId] || 35000;

    const landValuePSF = LAND_VALUE_PSF[inp.neighborhood] || 150;
    // ADU is an addition to an existing lot â€” no land acquisition needed
    const landCost = useId === 'adu' ? 0 : inp.parcelSize * landValuePSF;

    // Hard costs â€” Site work broken into sub-components
    const siteWorkBreakdown = calcSiteWorkBreakdown(useId, inp, gsf);
    const siteWork = siteWorkBreakdown.total;
    const demolition = (inp.siteCondition === 'demolition' && useId !== 'adu') ? inp.parcelSize * 12 : 0;
    let buildCostPSF = BUILD_COST_PSF[useId] || 300;
    if (effects && effects.parkingReduction > 0) {
        buildCostPSF *= (1 - effects.parkingReduction * 0.18);
    }
    const construction = gsf * buildCostPSF;
    const parkingCost = parkingSpaces * parkingCostPerSpace;
    const landscaping = Math.round(construction * 0.04);
    const hardContingency = Math.round((siteWork + demolition + construction + parkingCost + landscaping) * 0.07);
    const totalHard = siteWork + demolition + construction + parkingCost + landscaping + hardContingency;

    // Soft costs
    const archEng = Math.round(totalHard * 0.08);
    const permits = Math.round(totalHard * 0.05);
    const legal = Math.round(totalHard * 0.02);
    const financing = Math.round((landCost + totalHard) * 0.045);
    const rentMult = NEIGHBORHOOD_RENT_MULT[inp.neighborhood] || 1.0;
    const revenuePSF = (REVENUE_PSF[useId] || 30) * rentMult;
    const marketing = Math.round(nsf * revenuePSF * 0.02);
    const devFee = Math.round((totalHard + archEng + permits) * 0.04);
    const softCostMult = effects && effects.softCostReduction > 0 ? (1 - effects.softCostReduction * 0.20) : 1;
    const totalSoft = Math.round((archEng + permits + legal + financing + marketing + devFee) * softCostMult);

    const totalDev = landCost + totalHard + totalSoft;

    // Revenue & returns (neighborhood-adjusted)
    const grossRevenue = nsf * revenuePSF;
    const opex = Math.round(grossRevenue * params.opex);
    const noi = grossRevenue - opex;
    const capRate = params.cap || 0.05;
    const stabilizedValue = capRate > 0 ? Math.round(noi / capRate) : 0;
    const yieldOnCost = totalDev > 0 ? noi / totalDev : 0;
    const devMargin = totalDev > 0 ? (stabilizedValue - totalDev) / totalDev : 0;

    return {
        gsf, nsf, revenueNSF: nsf, stories, buildingHeight, buildingFootprint, units, parkingSpaces, far,
        landCost, landValuePSF, siteWork, siteWorkBreakdown, demolition, construction, buildCostPSF, parkingCost, parkingCostPerSpace, landscaping, hardContingency, totalHard,
        archEng, permits, legal, financing, marketing, devFee, totalSoft,
        totalDev,
        grossRevenue, opex, noi, capRate, stabilizedValue, yieldOnCost, devMargin,
        params, revenuePSF,
    };
}

// --- SVG Rendering ---

function generateSitePlanSVG(useId, inp, budget) {
    const w = 320, h = 270;
    const params = budget.params;
    const color = USE_COLORS[useId] || '#3182ce';

    const lotW = inp.frontage || Math.sqrt(inp.parcelSize * 2);
    const lotD = inp.parcelSize / lotW;
    const maxDim = Math.max(lotW, lotD);
    const scale = 170 / maxDim;
    const lw = lotW * scale, ld = lotD * scale;
    const ox = (w - lw) / 2, oy = 25;

    const sf = params.setF * scale, ss = params.setS * scale;
    const bw = Math.max(20, lw - 2 * ss);
    const bd = Math.max(20, ld - sf - ss);
    const bx = ox + ss, by = oy + ss;

    let s = `<svg viewBox="0 0 ${w} ${h}" xmlns="http://www.w3.org/2000/svg" style="background:#fafbfc;">`;
    s += `<defs><pattern id="ht" width="6" height="6" patternUnits="userSpaceOnUse"><path d="M0,6 L6,0" stroke="#ccc" stroke-width="0.5"/></pattern></defs>`;
    // Lot
    s += `<rect x="${ox}" y="${oy}" width="${lw}" height="${ld}" fill="#e8f5e9" stroke="#66bb6a" stroke-width="1.5" rx="2"/>`;
    // Setback hatching (front)
    if (sf > 2) s += `<rect x="${ox}" y="${oy + ld - sf}" width="${lw}" height="${sf}" fill="url(#ht)" opacity="0.5"/>`;
    // Building footprint
    s += `<rect x="${bx}" y="${by}" width="${bw}" height="${bd}" fill="${color}" opacity="0.75" stroke="${color}" stroke-width="1.5" rx="2"/>`;
    s += `<text x="${bx + bw/2}" y="${by + bd/2 - 5}" text-anchor="middle" font-size="10" fill="white" font-weight="600">BUILDING</text>`;
    s += `<text x="${bx + bw/2}" y="${by + bd/2 + 9}" text-anchor="middle" font-size="8" fill="rgba(255,255,255,0.85)">${budget.buildingFootprint.toLocaleString()} SF footprint</text>`;
    // Dimensions
    s += `<text x="${ox + lw/2}" y="${oy - 6}" text-anchor="middle" font-size="9" fill="#666">${Math.round(lotW)}' frontage</text>`;
    // Depth label (right side, rotated)
    s += `<text x="${ox + lw + 14}" y="${oy + ld/2}" text-anchor="middle" font-size="9" fill="#666" transform="rotate(90,${ox + lw + 14},${oy + ld/2})">${Math.round(lotD)}' depth</text>`;
    // Street
    s += `<rect x="${ox - 15}" y="${oy + ld + 8}" width="${lw + 30}" height="${22}" fill="#e2e8f0" rx="3"/>`;
    s += `<text x="${ox + lw/2}" y="${oy + ld + 23}" text-anchor="middle" font-size="9" fill="#718096" font-weight="600">STREET</text>`;
    // North arrow
    s += `<text x="${w - 22}" y="${oy + 12}" text-anchor="middle" font-size="14" fill="#999">&#8593;</text>`;
    s += `<text x="${w - 22}" y="${oy + 24}" text-anchor="middle" font-size="8" fill="#999" font-weight="600">N</text>`;
    // Title
    s += `<text x="${w/2}" y="${h - 6}" text-anchor="middle" font-size="10" fill="#999" font-weight="600">SITE PLAN</text>`;
    s += '</svg>';
    return s;
}

function generateElevationSVG(useId, inp, budget) {
    const w = 320, h = 270;
    const params = budget.params;
    const color = USE_COLORS[useId] || '#3182ce';
    const stories = budget.stories;
    const totalH = budget.buildingHeight;

    const maxSVGH = 190;
    const hScale = Math.min(maxSVGH / totalH, 3.0);
    const buildH = totalH * hScale;
    const buildW = 180;
    const ox = (w - buildW) / 2;
    const groundY = h - 45;
    const roofY = groundY - buildH;

    let s = `<svg viewBox="0 0 ${w} ${h}" xmlns="http://www.w3.org/2000/svg" style="background:#fafbfc;">`;
    // Sky
    s += `<defs><linearGradient id="sky" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#dbeafe"/><stop offset="100%" stop-color="#f0f9ff"/></linearGradient></defs>`;
    s += `<rect x="0" y="0" width="${w}" height="${groundY}" fill="url(#sky)"/>`;
    // Ground
    s += `<rect x="0" y="${groundY}" width="${w}" height="${h - groundY}" fill="#d4edda"/>`;
    s += `<line x1="0" y1="${groundY}" x2="${w}" y2="${groundY}" stroke="#888" stroke-width="1.5"/>`;
    // Building
    s += `<rect x="${ox}" y="${roofY}" width="${buildW}" height="${buildH}" fill="${color}" stroke="${adjustColor(color, -30)}" stroke-width="1.5" rx="2"/>`;
    // Floor lines
    const storyH = buildH / stories;
    for (let i = 1; i < stories; i++) {
        const y = groundY - i * storyH;
        s += `<line x1="${ox}" y1="${y}" x2="${ox + buildW}" y2="${y}" stroke="rgba(255,255,255,0.2)" stroke-width="0.5"/>`;
    }
    // Windows
    const cols = Math.min(7, Math.max(3, Math.floor(buildW / 25)));
    const winW = 12, winH = storyH * 0.45;
    const winSpacing = buildW / (cols + 1);
    for (let fl = 0; fl < stories; fl++) {
        const fy = groundY - (fl + 1) * storyH + (storyH - winH) / 2 + winH * 0.1;
        for (let c = 0; c < cols; c++) {
            const wx = ox + winSpacing * (c + 1) - winW / 2;
            s += `<rect x="${wx}" y="${fy}" width="${winW}" height="${winH}" fill="rgba(255,255,255,0.35)" rx="1"/>`;
        }
    }
    // Ground floor entrance
    if (['retail', 'mixeduse', 'hotel', 'office', 'medical', 'creative'].includes(useId)) {
        const doorW = buildW * 0.12, doorH = storyH * 0.65;
        s += `<rect x="${ox + buildW/2 - doorW/2}" y="${groundY - doorH}" width="${doorW}" height="${doorH}" fill="rgba(255,255,255,0.5)" rx="2"/>`;
    }
    // Roof line
    s += `<line x1="${ox - 4}" y1="${roofY}" x2="${ox + buildW + 4}" y2="${roofY}" stroke="${adjustColor(color, -40)}" stroke-width="2.5"/>`;
    // Height dimension
    const dx = ox + buildW + 18;
    s += `<line x1="${dx}" y1="${groundY}" x2="${dx}" y2="${roofY}" stroke="#999" stroke-width="0.75" stroke-dasharray="3,2"/>`;
    s += `<line x1="${dx - 4}" y1="${groundY}" x2="${dx + 4}" y2="${groundY}" stroke="#999" stroke-width="1"/>`;
    s += `<line x1="${dx - 4}" y1="${roofY}" x2="${dx + 4}" y2="${roofY}" stroke="#999" stroke-width="1"/>`;
    s += `<text x="${dx + 8}" y="${(groundY + roofY) / 2}" font-size="9" fill="#666" font-weight="600">${totalH} ft</text>`;
    s += `<text x="${dx + 8}" y="${(groundY + roofY) / 2 + 13}" font-size="8" fill="#999">${stories} stories</text>`;
    // Width
    s += `<text x="${ox + buildW/2}" y="${groundY + 16}" text-anchor="middle" font-size="9" fill="#666">${Math.round(inp.frontage || Math.sqrt(inp.parcelSize * 2))}' frontage</text>`;
    // Title
    s += `<text x="${w/2}" y="${h - 6}" text-anchor="middle" font-size="10" fill="#999" font-weight="600">BUILDING ELEVATION</text>`;
    s += '</svg>';
    return s;
}

// ============================================================
//  KEY METRICS HELPERS (for result cards)
// ============================================================

function formatCompactDollars(n) {
    if (n >= 1e9) return '$' + (n / 1e9).toFixed(1) + 'B';
    if (n >= 1e6) return '$' + (n / 1e6).toFixed(1) + 'M';
    if (n >= 1e3) return '$' + (n / 1e3).toFixed(0) + 'K';
    return '$' + Math.round(n).toLocaleString();
}

function approxIRR(devMargin, totalMonths) {
    if (totalMonths <= 0 || devMargin <= -1) return 0;
    return Math.pow(1 + devMargin, 12 / totalMonths) - 1;
}

function computeEaseOfExecution(useId, inp, effects, legalScore) {
    let ease = 50; // base score

    // Entitlement timeline â€” shorter is easier
    const tl = TIMELINE_MONTHS[useId] || { entitlement: 6, design: 4, permits: 3, construction: 18, leaseup: 6 };
    const totalMo = tl.entitlement + tl.design + tl.permits + tl.construction + tl.leaseup;
    if (totalMo <= 20) ease += 20;
    else if (totalMo <= 35) ease += 10;
    else if (totalMo >= 55) ease -= 15;
    else if (totalMo >= 45) ease -= 8;

    // Legal permissibility bonus
    if (legalScore >= 80) ease += 12;
    else if (legalScore >= 60) ease += 6;
    else if (legalScore < 30) ease -= 15;

    // Legislation streamlining bonuses
    if (effects && effects.legalOverride) ease += 8;
    if (effects && effects.softCostReduction > 0) ease += Math.round(effects.softCostReduction * 10);
    if (effects && effects.parkingReduction > 0) ease += 5;

    // Site constraints penalties
    if (inp.constHistoric) ease -= 10;
    if (inp.constHillside) ease -= 8;
    if (inp.constCoastal) ease -= 8;
    if (inp.constFault) ease -= 5;
    if (inp.constFlood) ease -= 5;
    if (inp.siteCondition === 'brownfield') ease -= 10;
    if (inp.topography === 'steep') ease -= 7;
    if (inp.utilities === 'none') ease -= 10;
    else if (inp.utilities === 'partial') ease -= 5;

    // Construction complexity â€” high-rise / hotel harder
    const params = BUILDING_PARAMS[useId];
    if (params && params.stories >= 10) ease -= 10;
    else if (params && params.stories >= 6) ease -= 5;

    return Math.max(0, Math.min(100, ease));
}

function computeRiskLevel(useId, inp, legalScore, physicalScore) {
    let riskPts = 0;

    // Site constraint risks
    if (inp.constFlood) riskPts += 12;
    if (inp.constHillside) riskPts += 10;
    if (inp.constHistoric) riskPts += 10;
    if (inp.constFault) riskPts += 12;
    if (inp.constCoastal) riskPts += 8;
    if (inp.siteCondition === 'brownfield') riskPts += 14;
    if (inp.topography === 'steep') riskPts += 8;
    if (inp.utilities === 'none') riskPts += 10;
    else if (inp.utilities === 'partial') riskPts += 5;

    // Score-based risk
    if (legalScore < 40) riskPts += 15;
    else if (legalScore < 60) riskPts += 8;
    if (physicalScore < 40) riskPts += 10;

    // Building complexity
    const params = BUILDING_PARAMS[useId];
    if (params && params.stories >= 10) riskPts += 10;
    else if (params && params.stories >= 6) riskPts += 5;

    // Market risk for certain types
    if (['office', 'retail', 'hotel'].includes(useId)) riskPts += 6;

    if (riskPts >= 35) return { level: 'High', color: '#c53030', bg: '#fff5f5' };
    if (riskPts >= 18) return { level: 'Moderate', color: '#b7791f', bg: '#fffff0' };
    return { level: 'Low', color: '#276749', bg: '#f0fff4' };
}

function generateCardMetricsHTML(useId, inp, effects, result) {
    const budget = generateBudget(useId, inp, effects);
    const tl = TIMELINE_MONTHS[useId] || { entitlement: 6, design: 4, permits: 3, construction: 18, leaseup: 6 };
    const totalMo = tl.entitlement + tl.design + tl.permits + tl.construction + tl.leaseup;

    const irr = approxIRR(budget.devMargin, totalMo);
    const ease = computeEaseOfExecution(useId, inp, effects, result.legal);
    const risk = computeRiskLevel(useId, inp, result.legal, result.physical);

    // Color helpers
    const marginClass = budget.devMargin >= 0.20 ? 'positive' : budget.devMargin >= 0.08 ? 'caution' : 'negative';
    const irrClass = irr >= 0.10 ? 'positive' : irr >= 0.06 ? 'caution' : 'negative';
    const yocClass = budget.yieldOnCost >= 0.065 ? 'positive' : budget.yieldOnCost >= 0.045 ? 'caution' : 'negative';
    const easeColor = ease >= 60 ? '#276749' : ease >= 35 ? '#b7791f' : '#c53030';
    const easeLabel = ease >= 70 ? 'Easy' : ease >= 50 ? 'Moderate' : ease >= 30 ? 'Difficult' : 'Very Hard';

    return `
        <div class="key-metrics">
            <div class="key-metrics-title">Key Metrics</div>
            <div class="metrics-grid">
                <div class="metric-item">
                    <div class="metric-icon-label">ðŸ’° Budget</div>
                    <div class="metric-value">${formatCompactDollars(budget.totalDev)}</div>
                </div>
                <div class="metric-item">
                    <div class="metric-icon-label">ðŸ“… Timeline</div>
                    <div class="metric-value">${totalMo} mo</div>
                </div>
                <div class="metric-item">
                    <div class="metric-icon-label">ðŸ“ˆ Dev Margin</div>
                    <div class="metric-value ${marginClass}">${(budget.devMargin * 100).toFixed(0)}%</div>
                </div>
                <div class="metric-item">
                    <div class="metric-icon-label">ðŸŽ¯ Est. IRR</div>
                    <div class="metric-value ${irrClass}">${(irr * 100).toFixed(1)}%</div>
                </div>
                <div class="metric-item">
                    <div class="metric-icon-label">ðŸ—ï¸ Yield on Cost</div>
                    <div class="metric-value ${yocClass}">${(budget.yieldOnCost * 100).toFixed(1)}%</div>
                </div>
                <div class="metric-item">
                    <div class="metric-icon-label">âš¡ Ease of Execution</div>
                    <div class="metric-value" style="font-size:0.78rem;color:${easeColor}">${ease} â€” ${easeLabel}</div>
                    <div class="ease-bar-bg"><div class="ease-bar-fill" style="width:${ease}%;background:${easeColor}"></div></div>
                </div>
                <div class="metric-item" style="grid-column:span 2">
                    <div class="metric-icon-label">âš ï¸ Risk Level</div>
                    <span class="risk-badge" style="color:${risk.color};background:${risk.bg}">
                        <span class="risk-dot" style="background:${risk.color}"></span>
                        ${risk.level}
                    </span>
                </div>
            </div>
        </div>`;
}

function generateRisksHTML(useId, inp) {
    const risks = [];
    if (inp.constFlood) risks.push({ t: 'Flood Zone', d: 'Site is in a flood zone. Flood insurance required, ground-floor design constraints, potential FEMA elevation requirements.' });
    if (inp.constHillside) risks.push({ t: 'Hillside Ordinance', d: 'Hillside development restrictions limit grading, height, and density. Extended entitlement timeline expected.' });
    if (inp.constHistoric) risks.push({ t: 'Historic Overlay', d: 'Historic preservation review required. May limit demolition, facade changes, and building height.' });
    if (inp.constFault) risks.push({ t: 'Fault Zone', d: 'Alquist-Priolo fault zone â€” geotechnical study required. Structural reinforcement may increase costs 10-20%.' });
    if (inp.constCoastal) risks.push({ t: 'Coastal Zone', d: 'California Coastal Commission review required. Height, view corridor, and public access conditions likely.' });
    if (inp.siteCondition === 'brownfield') risks.push({ t: 'Environmental Contamination', d: 'Phase II ESA recommended. Remediation costs could range from $50K to $500K+ depending on contamination type.' });
    if (inp.siteCondition === 'demolition') risks.push({ t: 'Demolition Required', d: 'Existing structure requires demolition. Asbestos/lead survey required. Demo costs included in budget.' });
    if (inp.utilities === 'partial') risks.push({ t: 'Utility Upgrades Needed', d: 'Utility infrastructure requires upgrades. Coordinate with LADWP and LASAN. May add $50-200K.' });
    if (inp.utilities === 'none') risks.push({ t: 'No Utilities Available', d: 'Significant utility extension required. May add $200K-$1M+ and 6-12 months to timeline.' });
    if (inp.topography === 'steep') risks.push({ t: 'Steep Topography', d: 'Significant grading and retaining walls required. May add 15-30% to foundation costs.' });
    if (['multifamily_high', 'hotel'].includes(useId)) risks.push({ t: 'Construction Cost Escalation', d: 'High-rise construction is sensitive to material/labor cost changes. Lock in GMP contract early.' });
    if (useId === 'retail') risks.push({ t: 'Retail Market Uncertainty', d: 'Evolving retail landscape. Consider flexible ground-floor design for alternative uses.' });
    if (useId === 'office') risks.push({ t: 'Office Demand Shift', d: 'Remote work trends have shifted office demand. Consider amenity-rich design and flexible leases.' });
    risks.push({ t: 'Entitlement Risk', d: 'LA entitlement timelines are subject to CEQA review, community opposition, and council discretion. Budget for delays.' });
    risks.push({ t: 'Interest Rate Sensitivity', d: 'Construction and permanent financing costs fluctuate. Model scenarios at current rate +/- 100 bps.' });

    let html = '<div class="analysis-section"><h3>Key Risks &amp; Considerations</h3>';
    html += risks.map(r => `<div class="risk-card"><strong>${r.t}</strong><p>${r.d}</p></div>`).join('');
    html += '</div>';
    return html;
}


// ============================================================
//  EDITABLE ANALYSIS â€” STATE, COMPUTE, RENDER HELPERS
// ============================================================

let analysisState = {
    resultIndex: null,
    useId: null,
    inp: null,
    effects: null,
    legislation: null,
    assumptions: null,
};

function getDefaultAssumptions(useId, inp, effects) {
    const params = BUILDING_PARAMS[useId];
    const baseFAR = FAR_TYPICAL[useId] || 1.0;
    let far = baseFAR;
    if (effects) {
        far = baseFAR * (1 + effects.densityBonus);
        if (effects.minFAR > 0) far = Math.max(far, effects.minFAR);
    }

    const gsf = Math.round(inp.parcelSize * far);
    const nsf = Math.round(gsf * params.eff);
    const hasUnits = !!params.unitSF;
    const unitsOrNSF = hasUnits ? Math.max(1, Math.floor(nsf / params.unitSF)) : nsf;

    const baseParkRatio = params.parkRatio || 0;
    const parkReduction = effects ? effects.parkingReduction : 0;
    let parkingSpaces;
    if (useId === 'parking') {
        parkingSpaces = Math.round(gsf / 350);
    } else if (hasUnits) {
        parkingSpaces = Math.max(0, Math.ceil(unitsOrNSF * baseParkRatio * (1 - parkReduction)));
    } else {
        parkingSpaces = Math.max(0, Math.ceil(gsf / 1000 * baseParkRatio * (1 - parkReduction)));
    }

    let buildCostPSF = BUILD_COST_PSF[useId] || 300;
    if (effects && effects.parkingReduction > 0) {
        buildCostPSF = Math.round(buildCostPSF * (1 - effects.parkingReduction * 0.18));
    }

    const rentMult = NEIGHBORHOOD_RENT_MULT[inp.neighborhood] || 1.0;

    // Calculate default site work for display
    var swBreakdown = calcSiteWorkBreakdown(useId, inp, gsf);
    var siteWorkTotalPSF = inp.parcelSize > 0 ? Math.round(swBreakdown.total / inp.parcelSize) : 18;

    return {
        far: parseFloat(far.toFixed(2)),
        unitsOrNSF,
        parkingSpaces,
        buildCostPSF: Math.round(buildCostPSF),
        landValuePSF: LAND_VALUE_PSF[inp.neighborhood] || 150,
        revenuePSF: Math.round((REVENUE_PSF[useId] || 30) * rentMult),
        opexPct: Math.round(params.opex * 100),
        capRatePct: parseFloat((params.cap * 100).toFixed(1)),
        parkingCostPerSpace: PARKING_COST_MAP[useId] || 35000,
        siteWorkPSF: siteWorkTotalPSF,
        siteWorkTotal: swBreakdown.total,
        siteWorkOverride: null,
        parcelSize: inp.parcelSize || 10000,
        // Design Configurator fields
        coveragePct: 70,
        efficiencyPct: Math.round(params.eff * 100),
        setbackFront: params.setF,
        setbackSide: params.setS,
        setbackRear: params.setS,
        amenityPct: 0,
        parkingType: 'surface',
        unitMixStudio: Math.round(((UNIT_MIX_PROFILES[inp.neighborhood] || UNIT_MIX_PROFILES.dtla).studio) * 100),
        unitMixBr1: Math.round(((UNIT_MIX_PROFILES[inp.neighborhood] || UNIT_MIX_PROFILES.dtla).br1) * 100),
        unitMixBr2: Math.round(((UNIT_MIX_PROFILES[inp.neighborhood] || UNIT_MIX_PROFILES.dtla).br2) * 100),
    };
}

function computeFromAssumptions(useId, inp, assumptions, effects) {
    const params = BUILDING_PARAMS[useId];
    const far = assumptions.far;
    const gsf = Math.round(inp.parcelSize * far);

    // Configurator-aware efficiency & amenity
    const effPct = (assumptions.efficiencyPct != null ? assumptions.efficiencyPct : Math.round(params.eff * 100)) / 100;
    const amenityPct = (assumptions.amenityPct || 0) / 100;
    const nsf = Math.round(gsf * effPct * (1 - amenityPct));
    const amenitySF = Math.round(gsf * effPct * amenityPct);

    // Configurator-aware setbacks & coverage
    const setF = assumptions.setbackFront != null ? assumptions.setbackFront : params.setF;
    const setS = assumptions.setbackSide != null ? assumptions.setbackSide : params.setS;
    const setR = assumptions.setbackRear != null ? assumptions.setbackRear : params.setS;
    const frontage = inp.frontage || Math.sqrt(inp.parcelSize * 2);
    const depth = inp.parcelSize / frontage;
    const buildableW = Math.max(0, frontage - 2 * setS);
    const buildableD = Math.max(0, depth - setF - setR);
    const buildableArea = Math.round(buildableW * buildableD);
    const covPct = (assumptions.coveragePct != null ? assumptions.coveragePct : 70) / 100;
    const maxFootprint = Math.min(Math.round(inp.parcelSize * covPct), buildableArea);
    const stories = Math.max(params.stories, Math.ceil(gsf / Math.max(maxFootprint, 1)));
    const buildingHeight = stories * params.floorH;
    const buildingFootprint = Math.min(maxFootprint, Math.round(gsf / stories));

    const hasUnits = !!params.unitSF;
    const units = hasUnits ? assumptions.unitsOrNSF : null;
    // For revenue: use user-edited NSF for non-unit uses, or units * unitSF for unit-based uses
    const revenueNSF = hasUnits ? assumptions.unitsOrNSF * params.unitSF : assumptions.unitsOrNSF;
    const parkingSpaces = assumptions.parkingSpaces;

    const landValuePSF = assumptions.landValuePSF;
    // ADU is an addition â€” no land acquisition cost
    const landCost = useId === 'adu' ? 0 : inp.parcelSize * landValuePSF;

    // Hard costs â€” Site work with user-overridable sub-components
    let siteWorkBreakdown;
    if (assumptions.siteWorkOverride !== undefined && assumptions.siteWorkOverride !== null) {
        // User manually set a total site work cost
        siteWorkBreakdown = { total: assumptions.siteWorkOverride, grading: 0, utilities: 0, erosion: 0, soilPrep: 0, clearing: 0, isOverride: true };
    } else {
        siteWorkBreakdown = calcSiteWorkBreakdown(useId, inp, gsf, assumptions.siteWorkRates);
    }
    const siteWork = siteWorkBreakdown.total;
    const demolition = (inp.siteCondition === 'demolition' && useId !== 'adu') ? inp.parcelSize * 12 : 0;
    const buildCostPSF = assumptions.buildCostPSF;
    const construction = gsf * buildCostPSF;
    const parkingCost = parkingSpaces * assumptions.parkingCostPerSpace;
    const landscaping = Math.round(construction * 0.04);
    const hardContingency = Math.round((siteWork + demolition + construction + parkingCost + landscaping) * 0.07);
    const totalHard = siteWork + demolition + construction + parkingCost + landscaping + hardContingency;

    // Soft costs
    const archEng = Math.round(totalHard * 0.08);
    const permits = Math.round(totalHard * 0.05);
    const legal = Math.round(totalHard * 0.02);
    const financing = Math.round((landCost + totalHard) * 0.045);
    const revenuePSF = assumptions.revenuePSF;
    const marketing = Math.round(revenueNSF * revenuePSF * 0.02);
    const devFee = Math.round((totalHard + archEng + permits) * 0.04);
    const softCostMult = effects && effects.softCostReduction > 0 ? (1 - effects.softCostReduction * 0.20) : 1;
    const totalSoft = Math.round((archEng + permits + legal + financing + marketing + devFee) * softCostMult);

    const totalDev = landCost + totalHard + totalSoft;

    // Revenue & returns â€” use revenueNSF so user edits to units/NSF flow through
    const grossRevenue = revenueNSF * revenuePSF;
    const opexRate = assumptions.opexPct / 100;
    const opex = Math.round(grossRevenue * opexRate);
    const noi = grossRevenue - opex;
    const capRate = assumptions.capRatePct / 100;
    const stabilizedValue = capRate > 0 ? Math.round(noi / capRate) : 0;
    const yieldOnCost = totalDev > 0 ? noi / totalDev : 0;
    const devMargin = totalDev > 0 ? (stabilizedValue - totalDev) / totalDev : 0;

    return {
        gsf, nsf, revenueNSF, stories, buildingHeight, buildingFootprint, units, parkingSpaces, far,
        landCost, siteWork, siteWorkBreakdown, demolition, construction, buildCostPSF, parkingCost, landscaping, hardContingency, totalHard,
        archEng, permits, legal, financing, marketing, devFee, totalSoft,
        totalDev,
        grossRevenue, opex, noi, capRate, stabilizedValue, yieldOnCost, devMargin,
        params, landValuePSF, revenuePSF, parkingCostPerSpace: assumptions.parkingCostPerSpace,
        // Design Configurator extras
        amenitySF, buildableArea,
        setbacks: { front: setF, side: setS, rear: setR },
        coveragePct: covPct * 100,
        efficiencyPct: effPct * 100,
    };
}

function renderProgramDisplay(computed) {
    return `<div class="program-grid">
        <div class="program-item"><div class="program-value">${computed.stories}</div><div class="program-label">Stories / ${computed.buildingHeight} ft</div></div>
        <div class="program-item"><div class="program-value">${computed.gsf.toLocaleString()}</div><div class="program-label">Gross SF</div></div>
        ${computed.units
            ? `<div class="program-item"><div class="program-value">${computed.units}</div><div class="program-label">Units</div></div>`
            : `<div class="program-item"><div class="program-value">${computed.nsf.toLocaleString()}</div><div class="program-label">Net Leasable SF</div></div>`}
        <div class="program-item"><div class="program-value">${computed.parkingSpaces}</div><div class="program-label">Parking Spaces</div></div>
    </div>`;
}

function renderAssumptions(assumptions, hasUnits) {
    return `<div class="assumptions-panel">
        <h4>Key Assumptions (editable)</h4>
        <div class="assumptions-grid">
            <div class="assumption-field">
                <label>FAR</label>
                <input type="number" class="assumption-input" id="a-far" step="0.1" min="0.1" max="20" value="${assumptions.far}" oninput="recalcAnalysis()">
            </div>
            <div class="assumption-field">
                <label>${hasUnits ? 'Units' : 'Net Leasable SF'}</label>
                <input type="number" class="assumption-input" id="a-unitsOrNSF" step="1" min="1" value="${assumptions.unitsOrNSF}" oninput="recalcAnalysis()">
            </div>
            <div class="assumption-field">
                <label>Parking Spaces</label>
                <input type="number" class="assumption-input" id="a-parkingSpaces" step="1" min="0" value="${assumptions.parkingSpaces}" oninput="recalcAnalysis()">
            </div>
            <div class="assumption-field">
                <label>Build Cost $/SF</label>
                <input type="number" class="assumption-input" id="a-buildCostPSF" step="5" min="10" value="${assumptions.buildCostPSF}" oninput="recalcAnalysis()">
            </div>
            <div class="assumption-field">
                <label>Land Value $/SF</label>
                <input type="number" class="assumption-input" id="a-landValuePSF" step="5" min="1" value="${assumptions.landValuePSF}" oninput="recalcAnalysis()">
            </div>
            <div class="assumption-field">
                <label>Revenue $/SF</label>
                <input type="number" class="assumption-input" id="a-revenuePSF" step="1" min="1" value="${assumptions.revenuePSF}" oninput="recalcAnalysis()">
            </div>
            <div class="assumption-field">
                <label>OpEx %</label>
                <input type="number" class="assumption-input" id="a-opexPct" step="1" min="0" max="100" value="${assumptions.opexPct}" oninput="recalcAnalysis()">
            </div>
            <div class="assumption-field">
                <label>Cap Rate %</label>
                <input type="number" class="assumption-input" id="a-capRatePct" step="0.1" min="0.1" max="20" value="${assumptions.capRatePct}" oninput="recalcAnalysis()">
            </div>
            <div class="assumption-field">
                <label>Parking $/Space</label>
                <input type="number" class="assumption-input" id="a-parkingCostPerSpace" step="1000" min="0" value="${assumptions.parkingCostPerSpace}" oninput="recalcAnalysis()">
            </div>
            <div class="assumption-field">
                <label>Site Work $/SF <span style="font-size:0.6rem;color:#a0aec0;">(of lot)</span></label>
                <input type="number" class="assumption-input" id="a-siteWorkPSF" step="1" min="0" max="100" value="${assumptions.siteWorkPSF || Math.round(assumptions.siteWorkTotal / (assumptions.parcelSize || 10000))}" oninput="recalcAnalysis()" placeholder="auto">
                <span style="font-size:0.6rem;color:#a0aec0;">blank = auto-calc</span>
            </div>
        </div>
    </div>`;
}

function renderBudgetTable(computed, inp) {
    const gsf = computed.gsf || 1;
    const units = computed.units;
    const hasUnits = units && units > 0;
    const perGSF = (v) => `$${Math.round(v / gsf).toLocaleString()}`;
    const perUnit = (v) => hasUnits ? `$${Math.round(v / units).toLocaleString()}` : 'â€”';
    const pct = (v) => computed.totalDev > 0 ? `${(v / computed.totalDev * 100).toFixed(1)}%` : '';

    return `<table class="budget-table">
        <thead><tr>
            <th>Line Item</th>
            <th>Total</th>
            <th>$/GSF</th>
            <th>${hasUnits ? '$/Unit' : '$/NSF'}</th>
            <th>% of Total</th>
        </tr></thead>
        <tbody>
        <tr class="section-header"><td colspan="5">LAND ACQUISITION</td></tr>
        <tr>
            <td>Land Cost (${inp.parcelSize.toLocaleString()} SF &times; $${computed.landValuePSF.toLocaleString()}/SF)</td>
            <td>${fmt(computed.landCost)}</td>
            <td class="dim">${perGSF(computed.landCost)}</td>
            <td class="dim">${hasUnits ? perUnit(computed.landCost) : '$' + Math.round(computed.landCost / (computed.nsf || 1)).toLocaleString()}</td>
            <td class="pct-col">${pct(computed.landCost)}</td>
        </tr>

        <tr class="section-header"><td colspan="5">HARD COSTS</td></tr>
        <tr style="cursor:pointer;" onclick="var el=document.getElementById('siteWorkDetail');el.style.display=el.style.display==='none'?'table-row':'none';">
            <td><strong>Site Work &amp; Preparation</strong> <span style="font-size:0.65rem;color:#4299e1;">&#9660; click for breakdown</span></td>
            <td>${fmt(computed.siteWork)}</td>
            <td class="dim">${perGSF(computed.siteWork)}</td>
            <td class="dim">${hasUnits ? perUnit(computed.siteWork) : '$' + Math.round(computed.siteWork / (computed.nsf || 1)).toLocaleString()}</td>
            <td class="pct-col">${pct(computed.siteWork)}</td>
        </tr>
        <tr id="siteWorkDetail" style="display:none;">
            <td colspan="5" style="padding:0.5rem 1rem;background:#f7fafc;border-left:3px solid #4299e1;">
                ${renderSiteWorkBreakdownInline(computed, inp)}
            </td>
        </tr>
        ${computed.demolition > 0 ? `<tr>
            <td>Demolition</td>
            <td>${fmt(computed.demolition)}</td>
            <td class="dim">${perGSF(computed.demolition)}</td>
            <td class="dim">${hasUnits ? perUnit(computed.demolition) : '$' + Math.round(computed.demolition / (computed.nsf || 1)).toLocaleString()}</td>
            <td class="pct-col">${pct(computed.demolition)}</td>
        </tr>` : ''}
        <tr style="cursor:pointer;" onclick="var el=document.getElementById('csiDetail');if(el)el.style.display=el.style.display==='none'?'table-row':'none';">
            <td><strong>Building Construction</strong> (${computed.gsf.toLocaleString()} GSF &times; $${Math.round(computed.buildCostPSF).toLocaleString()}/SF) <span style="font-size:0.65rem;color:#4299e1;">&#9660; CSI trade breakdown</span></td>
            <td>${fmt(computed.construction)}</td>
            <td class="dim">$${Math.round(computed.buildCostPSF).toLocaleString()}</td>
            <td class="dim">${hasUnits ? perUnit(computed.construction) : '$' + Math.round(computed.construction / (computed.nsf || 1)).toLocaleString()}</td>
            <td class="pct-col">${pct(computed.construction)}</td>
        </tr>
        <tr id="csiDetail" style="display:none;">
            <td colspan="5" style="padding:0.5rem 0.75rem;background:#f7fafc;border-left:3px solid #805ad5;">
                ${renderCSIBreakdownInBudget(computed, inp)}
            </td>
        </tr>
        <tr>
            <td>Parking (${computed.parkingSpaces} spaces &times; $${(computed.parkingCostPerSpace || 0).toLocaleString()})</td>
            <td>${fmt(computed.parkingCost)}</td>
            <td class="dim">${perGSF(computed.parkingCost)}</td>
            <td class="dim">${hasUnits ? perUnit(computed.parkingCost) : '$' + Math.round(computed.parkingCost / (computed.nsf || 1)).toLocaleString()}</td>
            <td class="pct-col">${pct(computed.parkingCost)}</td>
        </tr>
        <tr>
            <td>Landscaping &amp; Hardscape (4%)</td>
            <td>${fmt(computed.landscaping)}</td>
            <td class="dim">${perGSF(computed.landscaping)}</td>
            <td class="dim">${hasUnits ? perUnit(computed.landscaping) : '$' + Math.round(computed.landscaping / (computed.nsf || 1)).toLocaleString()}</td>
            <td class="pct-col">${pct(computed.landscaping)}</td>
        </tr>
        <tr>
            <td>Hard Cost Contingency (7%)</td>
            <td>${fmt(computed.hardContingency)}</td>
            <td class="dim">${perGSF(computed.hardContingency)}</td>
            <td class="dim">${hasUnits ? perUnit(computed.hardContingency) : '$' + Math.round(computed.hardContingency / (computed.nsf || 1)).toLocaleString()}</td>
            <td class="pct-col">${pct(computed.hardContingency)}</td>
        </tr>
        <tr class="subtotal">
            <td>Subtotal Hard Costs</td>
            <td>${fmt(computed.totalHard)}</td>
            <td>${perGSF(computed.totalHard)}</td>
            <td>${hasUnits ? perUnit(computed.totalHard) : '$' + Math.round(computed.totalHard / (computed.nsf || 1)).toLocaleString()}</td>
            <td class="pct-col">${pct(computed.totalHard)}</td>
        </tr>

        <tr class="section-header"><td colspan="5">SOFT COSTS</td></tr>
        <tr>
            <td>Architecture &amp; Engineering (8%)</td>
            <td>${fmt(computed.archEng)}</td>
            <td class="dim">${perGSF(computed.archEng)}</td>
            <td class="dim">${hasUnits ? perUnit(computed.archEng) : '$' + Math.round(computed.archEng / (computed.nsf || 1)).toLocaleString()}</td>
            <td class="pct-col">${pct(computed.archEng)}</td>
        </tr>
        <tr>
            <td>Permits &amp; Impact Fees (5%)</td>
            <td>${fmt(computed.permits)}</td>
            <td class="dim">${perGSF(computed.permits)}</td>
            <td class="dim">${hasUnits ? perUnit(computed.permits) : '$' + Math.round(computed.permits / (computed.nsf || 1)).toLocaleString()}</td>
            <td class="pct-col">${pct(computed.permits)}</td>
        </tr>
        <tr>
            <td>Legal &amp; Accounting (2%)</td>
            <td>${fmt(computed.legal)}</td>
            <td class="dim">${perGSF(computed.legal)}</td>
            <td class="dim">${hasUnits ? perUnit(computed.legal) : '$' + Math.round(computed.legal / (computed.nsf || 1)).toLocaleString()}</td>
            <td class="pct-col">${pct(computed.legal)}</td>
        </tr>
        <tr>
            <td>Financing &amp; Interest Carry (4.5%)</td>
            <td>${fmt(computed.financing)}</td>
            <td class="dim">${perGSF(computed.financing)}</td>
            <td class="dim">${hasUnits ? perUnit(computed.financing) : '$' + Math.round(computed.financing / (computed.nsf || 1)).toLocaleString()}</td>
            <td class="pct-col">${pct(computed.financing)}</td>
        </tr>
        <tr>
            <td>Marketing &amp; Leasing (2%)</td>
            <td>${fmt(computed.marketing)}</td>
            <td class="dim">${perGSF(computed.marketing)}</td>
            <td class="dim">${hasUnits ? perUnit(computed.marketing) : '$' + Math.round(computed.marketing / (computed.nsf || 1)).toLocaleString()}</td>
            <td class="pct-col">${pct(computed.marketing)}</td>
        </tr>
        <tr>
            <td>Developer Fee (4%)</td>
            <td>${fmt(computed.devFee)}</td>
            <td class="dim">${perGSF(computed.devFee)}</td>
            <td class="dim">${hasUnits ? perUnit(computed.devFee) : '$' + Math.round(computed.devFee / (computed.nsf || 1)).toLocaleString()}</td>
            <td class="pct-col">${pct(computed.devFee)}</td>
        </tr>
        <tr class="subtotal">
            <td>Subtotal Soft Costs</td>
            <td>${fmt(computed.totalSoft)}</td>
            <td>${perGSF(computed.totalSoft)}</td>
            <td>${hasUnits ? perUnit(computed.totalSoft) : '$' + Math.round(computed.totalSoft / (computed.nsf || 1)).toLocaleString()}</td>
            <td class="pct-col">${pct(computed.totalSoft)}</td>
        </tr>

        <tr class="grand-total">
            <td>TOTAL DEVELOPMENT COST</td>
            <td>${fmt(computed.totalDev)}</td>
            <td>${perGSF(computed.totalDev)}</td>
            <td>${hasUnits ? perUnit(computed.totalDev) : '$' + Math.round(computed.totalDev / (computed.nsf || 1)).toLocaleString()}</td>
            <td>100%</td>
        </tr>
        </tbody>
    </table>`;
}

function renderSiteWorkBreakdownInline(computed, inp) {
    var sw = computed.siteWorkBreakdown;
    if (!sw) return '<em style="color:#a0aec0;">No breakdown available</em>';

    var lot = inp.parcelSize || 10000;
    var fmt = function(v) { return '$' + Math.round(v).toLocaleString(); };
    var r = sw.rates || {};

    var html = '<div style="font-size:0.75rem;">';
    html += '<div style="font-weight:600;color:#2b6cb0;margin-bottom:0.4rem;">Site Work Sub-Components (' + lot.toLocaleString() + ' SF lot)</div>';
    html += '<table style="width:100%;font-size:0.72rem;border-collapse:collapse;margin-bottom:0.5rem;">';
    html += '<thead><tr style="background:#edf2f7;"><th style="text-align:left;padding:3px 8px;">Component</th><th style="padding:3px 8px;">Rate ($/SF)</th><th style="padding:3px 8px;">Cost</th><th style="text-align:left;padding:3px 8px;">What It Covers</th></tr></thead>';
    html += '<tbody>';
    html += '<tr><td style="padding:3px 8px;">Clearing &amp; Grubbing</td><td style="padding:3px 8px;text-align:center;">$' + (r.clearing || 0).toFixed(2) + '</td><td style="padding:3px 8px;text-align:center;">' + fmt(sw.clearing) + '</td><td style="padding:3px 8px;color:#718096;">Remove vegetation, trees, fencing, surface debris</td></tr>';
    html += '<tr style="background:#f7fafc;"><td style="padding:3px 8px;">Rough Grading</td><td style="padding:3px 8px;text-align:center;">$' + (r.grading || 0).toFixed(2) + '</td><td style="padding:3px 8px;text-align:center;">' + fmt(sw.grading) + '</td><td style="padding:3px 8px;color:#718096;">Cut/fill to design elevations, soil export if needed, retaining walls on slopes</td></tr>';
    html += '<tr><td style="padding:3px 8px;">Soil Prep &amp; Compaction</td><td style="padding:3px 8px;text-align:center;">$' + (r.soilPrep || 0).toFixed(2) + '</td><td style="padding:3px 8px;text-align:center;">' + fmt(sw.soilPrep) + '</td><td style="padding:3px 8px;color:#718096;">Scarify, moisture condition, compact subgrade per geotech specs</td></tr>';
    html += '<tr style="background:#f7fafc;"><td style="padding:3px 8px;">Utility Rough-In</td><td style="padding:3px 8px;text-align:center;">$' + (r.utilities || 0).toFixed(2) + '</td><td style="padding:3px 8px;text-align:center;">' + fmt(sw.utilities) + '</td><td style="padding:3px 8px;color:#718096;">Trench &amp; stub water, sewer, storm drain, electric, gas to building pad</td></tr>';
    html += '<tr><td style="padding:3px 8px;">Erosion Control / SWPPP</td><td style="padding:3px 8px;text-align:center;">$' + (r.erosion || 0).toFixed(2) + '</td><td style="padding:3px 8px;text-align:center;">' + fmt(sw.erosion) + '</td><td style="padding:3px 8px;color:#718096;">Silt fence, fiber rolls, BMPs, SWPPP compliance during grading</td></tr>';
    html += '<tr style="font-weight:600;border-top:2px solid #cbd5e0;"><td style="padding:4px 8px;">Total Site Work</td><td style="padding:4px 8px;text-align:center;">$' + ((r.clearing + r.grading + r.soilPrep + r.utilities + r.erosion) || 0).toFixed(2) + '</td><td style="padding:4px 8px;text-align:center;">' + fmt(sw.total) + '</td><td></td></tr>';
    html += '</tbody></table>';

    // Assumption narrative
    html += '<div style="background:#fffaf0;border:1px solid #fbd38d;border-radius:6px;padding:0.4rem 0.6rem;font-size:0.7rem;">';
    html += '<strong style="color:#c05621;">Assumptions:</strong> ' + (sw.assumptions || 'Standard urban infill conditions.');
    html += '<br><span style="color:#718096;">Rates are per SF of lot area. Override these in the editable assumptions panel above (Site Work $/SF) to set a custom total, or use Deep Analysis Tab 25 for phase-level editing.</span>';
    html += '</div></div>';
    return html;
}

function renderCSIBreakdownInBudget(computed, inp) {
    // Determine construction type from stories (simplified â€” full analysis is in Deep Analysis)
    var stories = computed.stories || 1;
    var constructionType = 'V-A';
    if (stories >= 10) constructionType = 'I-A';
    else if (stories >= 7) constructionType = 'I-B';
    else if (stories >= 5) constructionType = 'III-A';
    else if (stories >= 4) constructionType = 'II-A';
    else if (stories >= 3) constructionType = 'V-A';

    // Determine use type from analysis state (main HBU or Deep Analysis)
    var useId = (typeof deepAnalysisState !== 'undefined' && deepAnalysisState && deepAnalysisState.bestUse) || (typeof analysisState !== 'undefined' && analysisState && analysisState.useId) || 'multifamily_mid';

    var divisions = computeCSIBreakdown(useId, computed, constructionType, stories);
    var fmt = function(v) { return '$' + Math.round(v).toLocaleString(); };
    var gsf = computed.gsf || 1;

    var html = '<div style="font-size:0.75rem;">';
    html += '<div style="font-weight:600;color:#553c9a;margin-bottom:0.4rem;">CSI MasterFormat Division Breakdown â€” ' + constructionType + ' Construction</div>';
    html += '<table style="width:100%;font-size:0.72rem;border-collapse:collapse;">';
    html += '<thead><tr style="background:#f0e6ff;"><th style="padding:3px 6px;text-align:left;">Div</th><th style="padding:3px 6px;text-align:left;">Trade</th><th style="padding:3px 6px;text-align:right;">%</th><th style="padding:3px 6px;text-align:right;">$/SF</th><th style="padding:3px 6px;text-align:right;">Cost</th></tr></thead><tbody>';

    for (var i = 0; i < divisions.length; i++) {
        var d = divisions[i];
        if (d.cost <= 0) continue;
        var bg = i % 2 === 0 ? '#fff' : '#faf5ff';
        html += '<tr style="background:' + bg + ';">';
        html += '<td style="padding:2px 6px;color:#718096;">' + d.div + '</td>';
        html += '<td style="padding:2px 6px;">' + d.name + '</td>';
        html += '<td style="padding:2px 6px;text-align:right;">' + (d.pct * 100).toFixed(1) + '%</td>';
        html += '<td style="padding:2px 6px;text-align:right;">$' + Math.round(d.costPSF) + '</td>';
        html += '<td style="padding:2px 6px;text-align:right;">' + fmt(d.cost) + '</td>';
        html += '</tr>';
    }
    html += '</tbody></table>';
    html += '<div style="font-size:0.65rem;color:#a0aec0;margin-top:0.3rem;">Based on CSI MasterFormat 2020. See Construction &amp; Code tab in Deep Analysis for full scope descriptions and code compliance costs.</div>';
    html += '</div>';
    return html;
}

function renderReturnsSection(computed) {
    const spread = ((computed.yieldOnCost - computed.capRate) * 100).toFixed(0);
    const spreadLabel = spread >= 0 ? `+${spread} bps` : `${spread} bps`;
    const spreadColor = spread >= 150 ? '#276749' : spread >= 0 ? '#b7791f' : '#c53030';
    const marginColor = computed.devMargin >= 0.15 ? '#276749' : computed.devMargin >= 0 ? '#b7791f' : '#c53030';
    const hasUnits = computed.units && computed.units > 0;
    const perUnit = (v) => hasUnits ? `$${Math.round(v / computed.units).toLocaleString()}/unit` : '';
    const perNSF = (v) => `$${(v / (computed.revenueNSF || computed.nsf || 1)).toFixed(2)}/SF`;

    return `<div class="returns-grid">
        <div class="return-card"><div class="return-value">${(computed.yieldOnCost * 100).toFixed(1)}%</div><div class="return-label">Yield on Cost</div></div>
        <div class="return-card"><div class="return-value">${(computed.capRate * 100).toFixed(1)}%</div><div class="return-label">Market Cap Rate</div></div>
        <div class="return-card"><div class="return-value" style="color:${spreadColor}">${spreadLabel}</div><div class="return-label">Dev Spread (YoC âˆ’ Cap)</div></div>
        <div class="return-card"><div class="return-value" style="color:${marginColor}">${(computed.devMargin * 100).toFixed(0)}%</div><div class="return-label">Development Margin</div></div>
    </div>
    <table class="budget-table">
        <thead><tr><th>Revenue &amp; Returns</th><th>Annual</th><th>${hasUnits ? '$/Unit' : '$/NSF'}</th></tr></thead>
        <tbody>
        <tr><td>Gross Revenue (${(computed.revenueNSF || computed.nsf || 0).toLocaleString()} NSF &times; $${computed.revenuePSF}/SF)</td><td>${fmt(computed.grossRevenue)}</td><td class="dim">${hasUnits ? perUnit(computed.grossRevenue) : perNSF(computed.grossRevenue)}</td></tr>
        <tr><td>Less: Operating Expenses (${computed.grossRevenue > 0 ? Math.round(computed.opex / computed.grossRevenue * 100) : 0}%)</td><td>(${fmt(computed.opex)})</td><td class="dim">${hasUnits ? '(' + perUnit(computed.opex).replace('$','$') + ')' : '(' + perNSF(computed.opex) + ')'}</td></tr>
        <tr class="subtotal"><td>Net Operating Income (NOI)</td><td>${fmt(computed.noi)}</td><td>${hasUnits ? perUnit(computed.noi) : perNSF(computed.noi)}</td></tr>
        <tr><td>Stabilized Value (NOI &divide; ${(computed.capRate * 100).toFixed(1)}% cap)</td><td>${fmt(computed.stabilizedValue)}</td><td class="dim">${hasUnits ? '$' + Math.round(computed.stabilizedValue / computed.units).toLocaleString() + '/unit' : '$' + Math.round(computed.stabilizedValue / (computed.gsf || 1)).toLocaleString() + '/GSF'}</td></tr>
        <tr><td>Total Development Cost</td><td>${fmt(computed.totalDev)}</td><td class="dim">${hasUnits ? '$' + Math.round(computed.totalDev / computed.units).toLocaleString() + '/unit' : '$' + Math.round(computed.totalDev / (computed.gsf || 1)).toLocaleString() + '/GSF'}</td></tr>
        <tr class="subtotal"><td>Development Profit / (Loss)</td><td><strong style="color:${marginColor}">${fmt(computed.stabilizedValue - computed.totalDev)}</strong></td><td><strong style="color:${marginColor}">${(computed.devMargin * 100).toFixed(0)}%</strong></td></tr>
        </tbody>
    </table>`;
}

function renderSVGs(useId, inp, computed) {
    return `${generateSitePlanSVG(useId, inp, computed)}
        ${generateElevationSVG(useId, inp, computed)}`;
}

function recalcAnalysis() {
    _debouncedCall('analysis', _recalcAnalysisImpl, 200);
}
function _recalcAnalysisImpl() {
    const st = analysisState;
    if (!st.useId || !st.inp) return;

    const assumptions = {
        far: parseFloat(document.getElementById('a-far').value) || st.assumptions.far,
        unitsOrNSF: parseInt(document.getElementById('a-unitsOrNSF').value) || st.assumptions.unitsOrNSF,
        parkingSpaces: parseInt(document.getElementById('a-parkingSpaces').value) || 0,
        buildCostPSF: parseFloat(document.getElementById('a-buildCostPSF').value) || st.assumptions.buildCostPSF,
        landValuePSF: parseFloat(document.getElementById('a-landValuePSF').value) || st.assumptions.landValuePSF,
        revenuePSF: parseFloat(document.getElementById('a-revenuePSF').value) || st.assumptions.revenuePSF,
        opexPct: parseFloat(document.getElementById('a-opexPct').value) || 0,
        capRatePct: parseFloat(document.getElementById('a-capRatePct').value) || st.assumptions.capRatePct,
        parkingCostPerSpace: parseFloat(document.getElementById('a-parkingCostPerSpace').value) || 0,
    };
    // Site work override: if user entered a $/SF value, compute total override
    var siteWorkEl = document.getElementById('a-siteWorkPSF');
    if (siteWorkEl && siteWorkEl.value !== '' && parseFloat(siteWorkEl.value) > 0) {
        assumptions.siteWorkOverride = Math.round(parseFloat(siteWorkEl.value) * (st.inp.parcelSize || 10000));
        assumptions.siteWorkPSF = parseFloat(siteWorkEl.value);
    } else {
        assumptions.siteWorkOverride = null;
        assumptions.siteWorkPSF = null;
    }

    st.assumptions = assumptions;
    const computed = computeFromAssumptions(st.useId, st.inp, assumptions, st.effects);

    const progEl = document.getElementById('sect-program');
    if (progEl) progEl.innerHTML = renderProgramDisplay(computed);

    const budgetEl = document.getElementById('sect-budget');
    if (budgetEl) budgetEl.innerHTML = renderBudgetTable(computed, st.inp);

    const returnsEl = document.getElementById('sect-returns');
    if (returnsEl) returnsEl.innerHTML = renderReturnsSection(computed);

    const svgEl = document.getElementById('sect-svg');
    if (svgEl) svgEl.innerHTML = renderSVGs(st.useId, st.inp, computed);
}

function renderDeepAssumptions(assumptions, hasUnits, useId, computed) {
    var isResidential = ['sfr','duplex','multifamily_low','multifamily_mid','multifamily_high','mixeduse','senior','adu'].includes(useId || '');
    var params = BUILDING_PARAMS[useId] || {};
    // For residential: compute avg rent/unit/month from revenuePSF
    var avgRentPerUnit = 0;
    if (isResidential && hasUnits && params.unitSF) {
        avgRentPerUnit = Math.round(assumptions.revenuePSF * params.unitSF / 12);
    }
    // Compute NOI for display
    var displayNOI = computed ? computed.noi : 0;

    var revenueLabel, revenueValue, revenueId, revenueStep;
    if (isResidential && hasUnits) {
        revenueLabel = 'Avg Rent/Unit/Mo';
        revenueValue = avgRentPerUnit;
        revenueId = 'da-rentPerUnit';
        revenueStep = '25';
    } else {
        revenueLabel = 'Revenue $/SF/Yr';
        revenueValue = assumptions.revenuePSF;
        revenueId = 'da-revenuePSF';
        revenueStep = '1';
    }

    var noiDisplay = displayNOI > 0 ? `<div class="assumption-field">
                <label>Est. NOI</label>
                <div class="assumption-input" style="background:#f0fff4;border-color:#c6f6d5;font-weight:600;color:#276749;text-align:center;">$${displayNOI.toLocaleString()}</div>
            </div>` : '';

    return `<div class="assumptions-panel" style="margin-bottom:1rem;">
        <h4>Key Assumptions (editable)</h4>
        <div class="assumptions-grid">
            <div class="assumption-field">
                <label>FAR</label>
                <input type="number" class="assumption-input" id="da-far" step="0.1" min="0.1" max="20" value="${assumptions.far}" oninput="recalcDeepAnalysis()">
            </div>
            <div class="assumption-field">
                <label>${hasUnits ? 'Units' : 'Net Leasable SF'}</label>
                <input type="number" class="assumption-input" id="da-unitsOrNSF" step="1" min="1" value="${assumptions.unitsOrNSF}" oninput="recalcDeepAnalysis()">
            </div>
            <div class="assumption-field">
                <label>Parking Spaces</label>
                <input type="number" class="assumption-input" id="da-parkingSpaces" step="1" min="0" value="${assumptions.parkingSpaces}" oninput="recalcDeepAnalysis()">
            </div>
            <div class="assumption-field">
                <label>Build Cost $/SF</label>
                <input type="number" class="assumption-input" id="da-buildCostPSF" step="5" min="10" value="${assumptions.buildCostPSF}" oninput="recalcDeepAnalysis()">
            </div>
            <div class="assumption-field">
                <label>Land Value $/SF</label>
                <input type="number" class="assumption-input" id="da-landValuePSF" step="5" min="1" value="${assumptions.landValuePSF}" oninput="recalcDeepAnalysis()">
            </div>
            <div class="assumption-field">
                <label>${revenueLabel}</label>
                <input type="number" class="assumption-input" id="${revenueId}" step="${revenueStep}" min="1" value="${revenueValue}" oninput="recalcDeepAnalysis()">
            </div>
            <div class="assumption-field">
                <label>OpEx %</label>
                <input type="number" class="assumption-input" id="da-opexPct" step="1" min="0" max="100" value="${assumptions.opexPct}" oninput="recalcDeepAnalysis()">
            </div>
            <div class="assumption-field">
                <label>Cap Rate %</label>
                <input type="number" class="assumption-input" id="da-capRatePct" step="0.1" min="0.1" max="20" value="${assumptions.capRatePct}" oninput="recalcDeepAnalysis()">
            </div>
            <div class="assumption-field">
                <label>Parking $/Space</label>
                <input type="number" class="assumption-input" id="da-parkingCostPerSpace" step="1000" min="0" value="${assumptions.parkingCostPerSpace}" oninput="recalcDeepAnalysis()">
            </div>
            <div class="assumption-field">
                <label>Site Work $/SF <span style="font-size:0.6rem;color:#a0aec0;">(of lot)</span></label>
                <input type="number" class="assumption-input" id="da-siteWorkPSF" step="1" min="0" max="100" value="${assumptions.siteWorkPSF || ''}" oninput="recalcDeepAnalysis()" placeholder="auto">
                <span style="font-size:0.6rem;color:#a0aec0;">blank = auto-calc</span>
            </div>
            ${noiDisplay}
        </div>
    </div>`;
}

// Snapshot current da- input values into st.assumptions so they persist across re-renders.
// Call this before any renderDeepTabPanels(true) that doesn't go through recalcDeepAnalysis.
function snapshotDeepAssumptions() {
    var st = deepAnalysisState;
    if (!st || !st.assumptions) return;
    var fields = ['far','unitsOrNSF','parkingSpaces','buildCostPSF','landValuePSF','opexPct','capRatePct','parkingCostPerSpace'];
    for (var i = 0; i < fields.length; i++) {
        var el = document.getElementById('da-' + fields[i]);
        if (el && el.value !== '') {
            var v = parseFloat(el.value);
            if (!isNaN(v)) st.assumptions[fields[i]] = v;
        }
    }
    // Revenue (residential = rentPerUnit, commercial = revenuePSF)
    var rentEl = document.getElementById('da-rentPerUnit');
    var revEl = document.getElementById('da-revenuePSF');
    if (rentEl && rentEl.value !== '') {
        var params = BUILDING_PARAMS[st.bestUse] || {};
        var rent = parseFloat(rentEl.value);
        if (!isNaN(rent) && rent > 0 && params.unitSF > 0) {
            st.assumptions.revenuePSF = Math.round(rent * 12 / params.unitSF);
        }
    } else if (revEl && revEl.value !== '') {
        var v = parseFloat(revEl.value);
        if (!isNaN(v)) st.assumptions.revenuePSF = v;
    }
    // Site work override
    var swEl = document.getElementById('da-siteWorkPSF');
    if (swEl && swEl.value !== '' && parseFloat(swEl.value) > 0) {
        st.assumptions.siteWorkOverride = Math.round(parseFloat(swEl.value) * (st.inp.parcelSize || 10000));
        st.assumptions.siteWorkPSF = parseFloat(swEl.value);
    }
}

function recalcDeepAnalysis() {
    const st = deepAnalysisState;
    if (!st || !st.bestUse || !st.inp) return;

    const params = BUILDING_PARAMS[st.bestUse] || {};
    const hasUnits = !!params.unitSF;
    const isResidential = ['sfr','duplex','multifamily_low','multifamily_mid','multifamily_high','mixeduse','senior','adu'].includes(st.bestUse);

    // Determine revenuePSF â€” convert from rent/unit/mo if residential
    var revenuePSF;
    if (isResidential && hasUnits) {
        var rentInput = document.getElementById('da-rentPerUnit');
        var rentPerUnit = rentInput ? parseFloat(rentInput.value) : 0;
        // Convert: rent/unit/mo â†’ revenuePSF = (rent * 12) / unitSF
        revenuePSF = rentPerUnit > 0 && params.unitSF > 0 ? Math.round(rentPerUnit * 12 / params.unitSF) : st.assumptions.revenuePSF;
    } else {
        var revInput = document.getElementById('da-revenuePSF');
        revenuePSF = revInput ? parseFloat(revInput.value) : st.assumptions.revenuePSF;
    }

    const assumptions = {
        far: parseFloat(document.getElementById('da-far').value) || st.assumptions.far,
        unitsOrNSF: parseInt(document.getElementById('da-unitsOrNSF').value) || st.assumptions.unitsOrNSF,
        parkingSpaces: parseInt(document.getElementById('da-parkingSpaces').value) || 0,
        buildCostPSF: parseFloat(document.getElementById('da-buildCostPSF').value) || st.assumptions.buildCostPSF,
        landValuePSF: parseFloat(document.getElementById('da-landValuePSF').value) || st.assumptions.landValuePSF,
        revenuePSF: revenuePSF || st.assumptions.revenuePSF,
        opexPct: parseFloat(document.getElementById('da-opexPct').value) || 0,
        capRatePct: parseFloat(document.getElementById('da-capRatePct').value) || st.assumptions.capRatePct,
        parkingCostPerSpace: parseFloat(document.getElementById('da-parkingCostPerSpace').value) || 0,
    };
    // Preserve design configurator fields from current assumptions
    assumptions.coveragePct = st.assumptions.coveragePct != null ? st.assumptions.coveragePct : 70;
    assumptions.efficiencyPct = st.assumptions.efficiencyPct != null ? st.assumptions.efficiencyPct : Math.round(params.eff * 100);
    assumptions.setbackFront = st.assumptions.setbackFront != null ? st.assumptions.setbackFront : params.setF;
    assumptions.setbackSide = st.assumptions.setbackSide != null ? st.assumptions.setbackSide : params.setS;
    assumptions.setbackRear = st.assumptions.setbackRear != null ? st.assumptions.setbackRear : params.setS;
    assumptions.amenityPct = st.assumptions.amenityPct || 0;
    assumptions.parkingType = st.assumptions.parkingType || 'surface';
    assumptions.unitMixStudio = st.assumptions.unitMixStudio;
    assumptions.unitMixBr1 = st.assumptions.unitMixBr1;
    assumptions.unitMixBr2 = st.assumptions.unitMixBr2;

    // Site work override for deep analysis
    var daSiteWorkEl = document.getElementById('da-siteWorkPSF');
    if (daSiteWorkEl && daSiteWorkEl.value !== '' && parseFloat(daSiteWorkEl.value) > 0) {
        assumptions.siteWorkOverride = Math.round(parseFloat(daSiteWorkEl.value) * (st.inp.parcelSize || 10000));
        assumptions.siteWorkPSF = parseFloat(daSiteWorkEl.value);
    } else {
        assumptions.siteWorkOverride = null;
        assumptions.siteWorkPSF = null;
    }

    st.assumptions = assumptions;

    // Debounced: heavy recomputation + full tab re-render
    _debouncedCall('deepAnalysis', function() {
        st.computed = computeFromAssumptions(st.bestUse, st.inp, st.assumptions, st.effects);
        renderDeepTabPanels(true);
        var activeBtn = document.querySelector('#deepTabs .deep-tab-btn.active');
        if (activeBtn) {
            var activeIdx = Array.from(document.querySelectorAll('#deepTabs .deep-tab-btn')).indexOf(activeBtn);
            if (activeIdx >= 0) switchDeepTab(activeIdx);
        }
    }, 200);
}

function openAnalysis(resultIndex) {
    if (!lastResults || !lastInputs) return;
    const r = lastResults[resultIndex];
    const inp = lastInputs;
    const effects = stackLegislationEffects(r.legislation || []);
    const hasUnits = !!BUILDING_PARAMS[r.id].unitSF;

    // Set up analysisState
    const assumptions = getDefaultAssumptions(r.id, inp, effects);
    analysisState = {
        resultIndex,
        useId: r.id,
        inp,
        effects,
        legislation: r.legislation || [],
        assumptions,
    };

    const computed = computeFromAssumptions(r.id, inp, assumptions, effects);
    const tl = TIMELINE_MONTHS[r.id] || { entitlement: 6, design: 4, permits: 3, construction: 18, leaseup: 6 };
    const totalMonths = tl.entitlement + tl.design + tl.permits + tl.construction + tl.leaseup;
    const neighborhoodText = document.getElementById('neighborhood').selectedOptions[0].text;

    document.getElementById('modalTitle').textContent = `${r.icon} ${r.name}`;
    document.getElementById('modalSubtitle').textContent =
        `Detailed Development Analysis  |  ${inp.parcelSize.toLocaleString()} SF  |  ${inp.zoning} Zoning  |  ${neighborhoodText}`;

    let html = '';

    // --- Building Program (re-rendered on assumption change) ---
    html += `<div class="analysis-section"><h3>Building Program</h3><div id="sect-program">${renderProgramDisplay(computed)}</div></div>`;

    // --- Key Assumptions (editable â€” NOT re-rendered) ---
    html += `<div class="analysis-section">${renderAssumptions(assumptions, hasUnits)}</div>`;

    // --- Conceptual Renderings (re-rendered) ---
    html += `<div class="analysis-section"><h3>Conceptual Massing Study</h3><div class="rendering-container" id="sect-svg">${renderSVGs(r.id, inp, computed)}</div></div>`;

    // --- Line Item Budget (re-rendered) ---
    html += `<div class="analysis-section"><h3>Development Pro Forma &mdash; Line Item Budget</h3><div id="sect-budget">${renderBudgetTable(computed, inp)}</div></div>`;

    // --- Revenue & Returns (re-rendered) ---
    html += `<div class="analysis-section"><h3>Revenue &amp; Return Analysis</h3><div id="sect-returns">${renderReturnsSection(computed)}</div></div>`;

    // --- Timeline (static) ---
    html += `<div class="analysis-section"><h3>Development Timeline &mdash; ${totalMonths} Months</h3>
    <div class="timeline-bar">
        <div class="timeline-segment" style="flex:${tl.entitlement};background:#805ad5;">Entitle<br>${tl.entitlement}mo</div>
        <div class="timeline-segment" style="flex:${tl.design};background:#3182ce;">Design<br>${tl.design}mo</div>
        <div class="timeline-segment" style="flex:${tl.permits};background:#38a169;">Permits<br>${tl.permits}mo</div>
        <div class="timeline-segment" style="flex:${tl.construction};background:#dd6b20;">Construction<br>${tl.construction}mo</div>
        <div class="timeline-segment" style="flex:${tl.leaseup};background:#e53e3e;">Lease-Up<br>${tl.leaseup}mo</div>
    </div>
    <div class="timeline-legend">Entitlement &rarr; Design &rarr; Permits &rarr; Construction &rarr; Lease-Up / Stabilization</div>
    </div>`;

    // --- Legislation (with clickable cards) ---
    if (r.legislation && r.legislation.length > 0) {
        html += `<div class="analysis-section"><h3>Applicable California Housing Legislation</h3>
        <div class="legislation-cards">
            ${r.legislation.map(b => `<div class="legislation-card clickable" onclick="showLegislationDetail('${b.id}')"><strong>${b.name}</strong><p>${b.description}</p></div>`).join('')}
        </div></div>`;
    }

    // --- Risks ---
    html += generateRisksHTML(r.id, inp);

    // --- Disclaimer ---
    html += `<div class="disclaimer" style="margin-top:1.5rem;">
        <strong>Disclaimer:</strong> This pro forma is a preliminary estimate for educational purposes only. Actual development costs, revenues, and timelines vary significantly based on market conditions, design specifications, entitlement outcomes, and contractor pricing. All figures should be verified through independent feasibility analysis by qualified professionals before making investment decisions.
    </div>`;

    document.getElementById('modalBody').innerHTML = html;
    document.getElementById('analysisModal').style.display = 'block';
    document.body.style.overflow = 'hidden';
    document.getElementById('analysisModal').scrollTop = 0;
}

function closeAnalysis() {
    document.getElementById('analysisModal').style.display = 'none';
    document.body.style.overflow = '';
}

function printAnalysis() {
    document.body.classList.add('printing-analysis');
    window.print();
    document.body.classList.remove('printing-analysis');
}


// ============================================================
//  LEGISLATION DETAIL POPUP
// ============================================================

function showLegislationDetail(billId) {
    const bill = CA_HOUSING_LEGISLATION.find(b => b.id === billId);
    if (!bill) return;

    const modal = document.getElementById('legDetailModal');
    modal.innerHTML = `<div class="leg-detail-content">
        <div class="leg-detail-header">
            <h3>${bill.name}</h3>
            <button type="button" class="leg-detail-close" onclick="closeLegislationDetail()">&times;</button>
        </div>
        <div class="leg-detail-body">
            <p class="leg-summary">${bill.description}</p>
            <p class="leg-full">${bill.detail || bill.description}</p>
        </div>
    </div>`;
    modal.style.display = 'flex';
}

function closeLegislationDetail() {
    document.getElementById('legDetailModal').style.display = 'none';
}


// ============================================================
//  SB 79 TRANSIT MAP
// ============================================================

let sb79Map = null;
let sb79Layers = { tier1: null, tier2: null, zones: null, property: null };
let sb79LayerState = { tier1: true, tier2: true, zones: true, property: true };
let sb79StationRadii = {};

function initSB79Map(lat, lon) {
    const mapEl = document.getElementById('sb79Map');
    if (!mapEl) return;

    // Destroy existing map
    if (sb79Map) { sb79Map.remove(); sb79Map = null; }
    sb79StationRadii = {};

    sb79Map = L.map('sb79Map').setView([lat, lon], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
        maxZoom: 18,
    }).addTo(sb79Map);

    // Layer groups
    sb79Layers.tier1 = L.layerGroup().addTo(sb79Map);
    sb79Layers.tier2 = L.layerGroup().addTo(sb79Map);
    sb79Layers.zones = L.layerGroup().addTo(sb79Map);
    sb79Layers.property = L.layerGroup().addTo(sb79Map);

    // Property marker
    const propIcon = L.divIcon({
        html: '<div style="background:#e53e3e;width:16px;height:16px;border-radius:50%;border:3px solid #fff;box-shadow:0 2px 6px rgba(0,0,0,0.4);"></div>',
        iconSize: [16, 16], iconAnchor: [8, 8], className: '',
    });
    L.marker([lat, lon], { icon: propIcon })
        .bindPopup('<strong>Your Property</strong>')
        .addTo(sb79Layers.property);

    // Station markers
    const seenCoords = new Set();
    METRO_STATIONS.forEach((s, idx) => {
        const key = `${s.lat.toFixed(4)},${s.lon.toFixed(4)},${s.line}`;
        if (seenCoords.has(key)) return;
        seenCoords.add(key);

        const color = LINE_COLORS[s.line] || '#718096';
        const icon = L.divIcon({
            html: `<div style="background:${color};width:10px;height:10px;border-radius:50%;border:2px solid #fff;box-shadow:0 1px 3px rgba(0,0,0,0.3);"></div>`,
            iconSize: [10, 10], iconAnchor: [5, 5], className: '',
        });
        const tierData = SB79_TIERS[s.tier];
        const lineName = LINE_LABELS[s.line] || s.line;
        const popupHtml = `<div class="station-popup">
            <div class="popup-title">${s.name}</div>
            <div class="popup-line">${lineName} &mdash; ${s.serviceType} &mdash; ${tierData.label}</div>
            <div class="popup-allowances">
                <span><strong>SB 79 Allowances:</strong></span>
                <span>Height: ${tierData.height} ft | Density: ${tierData.density} du/ac</span>
                <span>FAR: ${tierData.far} | Parking: 0 (inner), 0.5/unit (outer)</span>
            </div>
        </div>`;
        const marker = L.marker([s.lat, s.lon], { icon })
            .bindPopup(popupHtml)
            .on('click', () => { showStationRadii(idx); });

        const layerGroup = s.tier === 1 ? sb79Layers.tier1 : sb79Layers.tier2;
        marker.addTo(layerGroup);
    });

    // Draw radii for nearest qualifying station
    const eligibility = detectSB79Eligibility(lat, lon);
    if (eligibility.eligible && eligibility.nearestIdx >= 0) {
        drawSB79Radii(METRO_STATIONS[eligibility.nearestIdx]);
    }

    // Native DOM click handler for zone identification (bypasses all Leaflet layers)
    attachZoneClickHandler(sb79Map);

    // Render legend
    renderMapLegend();

    // Sync layer toggle button states
    document.querySelectorAll('#mapControls .layer-btn').forEach(btn => btn.classList.add('active'));
    sb79LayerState = { tier1: true, tier2: true, zones: true, property: true };

    // Force map to re-render tiles after display
    setTimeout(() => { if (sb79Map) sb79Map.invalidateSize(); }, 200);
}

// ---- ZONE CLICK SYSTEM (rebuilt from scratch) ----
// All zone circles are PURE VISUAL DECORATION (no Leaflet event handling).
// Zone identification uses a native DOM click listener on the map container,
// which cannot be blocked by SVG overlays or Leaflet layer event handling.

function showZonePopup(mapInstance, latlng, station, dist) {
    var tierData = SB79_TIERS[station.tier];
    var distFeet = Math.round(dist * 5280);
    var zoneName, zoneColor, zoneDetail;

    if (dist <= 0.038) {
        zoneName = '200ft Adjacent Zone';
        zoneColor = '#553c9a';
        zoneDetail = tierData.label + ' â€” Full tier benefits, zero parking';
    } else if (dist <= 0.25) {
        zoneName = '1/4 Mile Inner Zone';
        zoneColor = '#2b6cb0';
        zoneDetail = tierData.label + ' â€” Full tier benefits, zero parking';
    } else {
        zoneName = '1/2 Mile Outer Zone';
        zoneColor = '#4a5568';
        zoneDetail = tierData.label + ' â€” 65ft height, 3.25 FAR, 0.5 parking/unit';
    }

    L.popup()
        .setLatLng(latlng)
        .setContent(
            '<strong>' + station.name + '</strong><br>' +
            '<strong style="font-size:1.1em;color:' + zoneColor + ';">' + zoneName + '</strong><br>' +
            '<span style="font-size:0.85em;color:#666;">' + zoneDetail + '</span><br>' +
            '<span style="font-size:0.8em;color:#999;">' + distFeet.toLocaleString() + ' ft from station (' + station.serviceType + ')</span>'
        )
        .openOn(mapInstance);
}

function attachZoneClickHandler(mapInstance) {
    // Native DOM click listener â€” bypasses Leaflet's event system entirely.
    // Cannot be blocked by SVG overlays, circle layers, or bubblingMouseEvents.
    mapInstance.getContainer().addEventListener('click', function(evt) {
        // Small delay to let Leaflet process its own events first (marker popups etc.)
        setTimeout(function() {
            // If a Leaflet popup is already open from a marker click, don't override it
            if (mapInstance._popup && mapInstance._popup.isOpen && mapInstance._popup.isOpen()) {
                // Check if this popup was opened by a station marker (has station-popup class)
                var content = mapInstance._popup.getContent ? mapInstance._popup.getContent() : '';
                if (typeof content === 'string' && content.indexOf('station-popup') >= 0) return;
                if (typeof content === 'string' && content.indexOf('Your Property') >= 0) return;
            }

            // Convert pixel click position to lat/lng
            var rect = mapInstance.getContainer().getBoundingClientRect();
            var x = evt.clientX - rect.left;
            var y = evt.clientY - rect.top;
            var latlng = mapInstance.containerPointToLatLng(L.point(x, y));

            // Find nearest station
            var nearestStation = null;
            var nearestDist = Infinity;
            for (var i = 0; i < METRO_STATIONS.length; i++) {
                var s = METRO_STATIONS[i];
                var d = haversine(latlng.lat, latlng.lng, s.lat, s.lon);
                if (d < nearestDist) {
                    nearestDist = d;
                    nearestStation = s;
                }
            }

            // Only show zone popup if click is within 1/2 mile of a station
            if (nearestStation && nearestDist <= 0.50) {
                showZonePopup(mapInstance, latlng, nearestStation, nearestDist);
            }
        }, 50);
    });
}

function drawSB79Radii(station) {
    if (!sb79Layers.zones) return;
    var tierColor = station.tier === 1 ? '#805ad5' : '#3182ce';

    // ALL circles are purely visual â€” no click handling, no interactive flag
    // 1/2 mile = ~805m (outer)
    L.circle([station.lat, station.lon], {
        radius: 805, color: tierColor, weight: 2.5, opacity: 0.8,
        fillColor: tierColor, fillOpacity: 0.08,
        interactive: false, dashArray: '12,8',
    }).addTo(sb79Layers.zones);

    // 1/4 mile = ~402m (inner)
    L.circle([station.lat, station.lon], {
        radius: 402, color: tierColor, weight: 2.5, opacity: 0.8,
        fillColor: tierColor, fillOpacity: 0.12,
        interactive: false, dashArray: '8,6',
    }).addTo(sb79Layers.zones);

    // 200ft = ~61m (adjacent)
    L.circle([station.lat, station.lon], {
        radius: 61, color: tierColor, weight: 2.5, opacity: 0.9,
        fillColor: tierColor, fillOpacity: 0.20,
        interactive: false, dashArray: '4,4',
    }).addTo(sb79Layers.zones);
}

function showStationRadii(stationIdx) {
    const station = METRO_STATIONS[stationIdx];
    if (!station || !sb79Layers.zones) return;
    const key = `${station.lat},${station.lon}`;
    if (sb79StationRadii[key]) return; // already drawn
    sb79StationRadii[key] = true;
    drawSB79Radii(station);
}

function toggleMapLayer(layerName) {
    if (!sb79Map || !sb79Layers[layerName]) return;
    sb79LayerState[layerName] = !sb79LayerState[layerName];
    if (sb79LayerState[layerName]) {
        sb79Map.addLayer(sb79Layers[layerName]);
    } else {
        sb79Map.removeLayer(sb79Layers[layerName]);
    }
    // Update button state
    const btns = document.querySelectorAll('#mapControls .layer-btn');
    const labels = { tier1: 'Tier 1', tier2: 'Tier 2', zones: 'SB 79 Zones', property: 'Your Property' };
    btns.forEach(btn => {
        for (const [k, v] of Object.entries(labels)) {
            if (btn.textContent.includes(v)) {
                btn.classList.toggle('active', sb79LayerState[k]);
            }
        }
    });
}

function renderMapLegend() {
    const el = document.getElementById('mapLegend');
    if (!el) return;
    el.innerHTML = `
        <div class="legend-item"><span class="legend-dot" style="background:#e53e3e;"></span> Red/B Line</div>
        <div class="legend-item"><span class="legend-dot" style="background:#805ad5;"></span> Purple/D Line</div>
        <div class="legend-item"><span class="legend-dot" style="background:#3182ce;"></span> Blue/A Line</div>
        <div class="legend-item"><span class="legend-dot" style="background:#d69e2e;"></span> Expo/E Line</div>
        <div class="legend-item"><span class="legend-dot" style="background:#b7791f;"></span> Gold/L Line</div>
        <div class="legend-item"><span class="legend-dot" style="background:#38a169;"></span> Green/C Line</div>
        <div class="legend-item"><span class="legend-dot" style="background:#00bcd4;"></span> K Line</div>
        <div class="legend-item"><span class="legend-dot" style="background:#ed64a6;"></span> Regional Connector</div>
        <div class="legend-item"><span class="legend-dot" style="background:#e53e3e;border:2px solid #999;width:8px;height:8px;"></span> Metrolink</div>
        <div class="legend-item"><span class="legend-line" style="background:#805ad5;"></span> Tier 1 â€” Heavy Rail (Red/B, Purple/D)</div>
        <div class="legend-item"><span class="legend-line" style="background:#3182ce;"></span> Tier 2 â€” Light Rail / Commuter Rail</div>
        <div class="legend-item"><span class="legend-dot" style="background:#e53e3e;width:12px;height:12px;border:2px solid #fff;box-shadow:0 0 3px rgba(0,0,0,0.3);"></span> Your Property</div>
    `;
}

function renderSB79Eligibility(eligibility) {
    const el = document.getElementById('sb79Eligibility');
    if (!el) return;
    if (!eligibility || !eligibility.eligible) {
        el.style.display = 'none';
        return;
    }
    const a = eligibility.allowances;
    const tierClass = eligibility.tier === 1 ? 'tier1' : 'tier2';
    const zoneClass = eligibility.zone;
    el.style.display = 'block';
    el.innerHTML = `
        <h3>SB 79 Eligibility â€” Your Property</h3>
        <p style="font-size:0.85rem;color:var(--text-light);margin-bottom:0.75rem;">
            <span class="tier-badge ${tierClass}">${eligibility.tierLabel}</span>
            <span class="zone-badge ${zoneClass}">${eligibility.zoneLabel}</span>
            &mdash; ${eligibility.distMiles.toFixed(2)} mi from <strong>${eligibility.station.name}</strong>
            (${LINE_LABELS[eligibility.station.line] || eligibility.station.line})
        </p>
        <div class="sb79-grid">
            <div class="sb79-stat"><div class="stat-label">Max Height</div><div class="stat-value">${a.height} ft</div></div>
            <div class="sb79-stat"><div class="stat-label">Max Density</div><div class="stat-value">${a.density} du/ac</div></div>
            <div class="sb79-stat"><div class="stat-label">Max FAR</div><div class="stat-value">${a.far}</div></div>
            <div class="sb79-stat"><div class="stat-label">Parking Req</div><div class="stat-value">${a.parking === 0 ? 'None' : a.parking + '/unit'}</div></div>
            <div class="sb79-stat"><div class="stat-label">Affordable Req</div><div class="stat-value">15%</div></div>
            <div class="sb79-stat"><div class="stat-label">Effective Date</div><div class="stat-value">Jul 2026</div></div>
        </div>
    `;
}

// ============================================================
//  SB 79 OPPORTUNITY FINDER
// ============================================================

let finderResults = [];
let finderParcelLayer = null;
let finderSortCol = 'impRatio';
let finderSortAsc = true;

function toggleFinder() {
    const body = document.getElementById('finderBody');
    const arrow = document.getElementById('finderArrow');
    const isOpen = body.classList.toggle('open');
    arrow.classList.toggle('open', isOpen);
    if (isOpen && document.getElementById('finderStation').options.length === 0) {
        populateFinderStations();
    }
}

function populateFinderStations() {
    const sel = document.getElementById('finderStation');
    sel.innerHTML = '';
    const grouped = {};
    METRO_STATIONS.forEach((s, idx) => {
        const lineKey = s.line;
        if (!grouped[lineKey]) grouped[lineKey] = [];
        grouped[lineKey].push({ ...s, idx });
    });
    // Sort lines in display order
    const lineOrder = ['red', 'purple', 'blue_a', 'expo_e', 'gold_l', 'green_c', 'k_line', 'connector', 'metrolink'];
    for (const lineKey of lineOrder) {
        if (!grouped[lineKey]) continue;
        const grp = document.createElement('optgroup');
        grp.label = LINE_LABELS[lineKey] || lineKey;
        for (const s of grouped[lineKey]) {
            const opt = document.createElement('option');
            opt.value = s.idx;
            opt.textContent = s.name;
            grp.appendChild(opt);
        }
        sel.appendChild(grp);
    }
    // Pre-select nearest station if we have geocoded coords
    if (window.lastGeocode) {
        let bestIdx = 0, bestDist = Infinity;
        METRO_STATIONS.forEach((s, i) => {
            const d = haversine(window.lastGeocode.lat, window.lastGeocode.lon, s.lat, s.lon);
            if (d < bestDist) { bestDist = d; bestIdx = i; }
        });
        sel.value = bestIdx;
    }
}

function selectFinderStation(idx) {
    const sel = document.getElementById('finderStation');
    if (sel && sel.querySelector(`option[value="${idx}"]`)) {
        sel.value = idx;
    }
    // Open the finder if closed
    const body = document.getElementById('finderBody');
    if (body && !body.classList.contains('open')) {
        toggleFinder();
    }
}

function getFinderRadius() {
    const checked = document.querySelector('input[name="finderRadius"]:checked');
    const ft = checked ? parseInt(checked.value) : 2640;
    let zone = 'outer';
    if (ft <= 200) zone = 'adjacent';
    else if (ft <= 1320) zone = 'inner';
    return { zone, radiusFt: ft };
}

async function queryParcelsNearStation(lat, lon, radiusFt, onProgress) {
    const baseUrl = 'https://public.gis.lacounty.gov/public/rest/services/LACounty_Cache/LACounty_Parcel/MapServer/0/query';
    const outFields = 'APN,SitusFullAddress,UseType,UseDescription,UseCode,Roll_LandValue,Roll_ImpValue,YearBuilt1,SQFTmain1,Units1,CENTER_LAT,CENTER_LON,Shape.STArea()';
    const allFeatures = [];
    let offset = 0;
    const pageSize = 1000;
    let total = null;

    while (true) {
        const params = new URLSearchParams({
            geometry: `${lon},${lat}`,
            geometryType: 'esriGeometryPoint',
            inSR: '4326',
            spatialRel: 'esriSpatialRelIntersects',
            distance: radiusFt,
            units: 'esriSRUnit_Foot',
            outFields: outFields,
            returnGeometry: false,
            returnCountOnly: false,
            resultOffset: offset,
            resultRecordCount: pageSize,
            f: 'json',
        });
        if (total === null) {
            params.set('returnCountOnly', 'false');
        }

        const resp = await fetch(`${baseUrl}?${params}`);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();

        if (data.error) throw new Error(data.error.message || 'GIS API error');

        const features = data.features || [];
        allFeatures.push(...features);

        if (onProgress) {
            onProgress(allFeatures.length, total || allFeatures.length + (features.length === pageSize ? pageSize : 0));
        }

        if (features.length < pageSize) break;
        offset += pageSize;
        if (offset > 5000) break; // Safety cap
    }
    return allFeatures;
}

function classifyParcelUseType(useType, useDesc, useCode) {
    const ut = (useType || '').toLowerCase();
    const ud = (useDesc || '').toLowerCase();
    const uc = (useCode || '').toString();

    if (ut.includes('vacant') || ud.includes('vacant') || uc === '0000' || uc === '0100') return 'Vacant';
    if (ut.includes('resident') || ud.includes('resident') || ud.includes('single') || ud.includes('duplex') || ud.includes('apartment') || ud.includes('condo') || uc.startsWith('01') || uc.startsWith('02') || uc.startsWith('03') || uc.startsWith('04')) return 'Residential';
    if (ut.includes('commerc') || ud.includes('commerc') || ud.includes('office') || ud.includes('retail') || ud.includes('store') || ud.includes('shop') || uc.startsWith('1') || uc.startsWith('2')) return 'Commercial';
    if (ut.includes('industr') || ud.includes('industr') || ud.includes('manufact') || ud.includes('warehouse') || uc.startsWith('3') || uc.startsWith('4')) return 'Industrial';
    return 'Commercial'; // default
}

function classifySB79Zone(parcelLat, parcelLon, stationLat, stationLon) {
    const dist = haversine(parcelLat, parcelLon, stationLat, stationLon);
    if (dist <= SB79_ZONES.adjacent.maxDist) return { key: 'adjacent', dist };
    if (dist <= SB79_ZONES.inner.maxDist) return { key: 'inner', dist };
    if (dist <= SB79_ZONES.outer.maxDist) return { key: 'outer', dist };
    return { key: 'outside', dist };
}

function getSB79Allowances(tier, zoneKey) {
    const tierData = SB79_TIERS[tier];
    const zone = SB79_ZONES[zoneKey];
    if (!tierData || !zone) return null;
    return {
        height: Math.round(tierData.height * zone.heightMult),
        density: Math.round(tierData.density * zone.heightMult),
        far: parseFloat((tierData.far * zone.heightMult).toFixed(2)),
        parking: zone.parking,
    };
}

// ============================================================
//  TRANSIT PROXIMITY + ALL LEGISLATION FOR FINDER RESULTS
// ============================================================

/**
 * Find ALL transit stops within maxMiles of a lat/lon, with TOD tier/zone/bonuses.
 * Returns sorted by distance (closest first).
 */
function getAllNearbyTransit(lat, lon, maxMiles) {
    if (!maxMiles) maxMiles = 0.75;
    var nearby = [];
    for (var i = 0; i < METRO_STATIONS.length; i++) {
        var s = METRO_STATIONS[i];
        var d = haversine(lat, lon, s.lat, s.lon);
        if (d <= maxMiles) {
            var tierData = SB79_TIERS[s.tier] || {};
            var zoneKey = 'outside', zoneLabel = 'Outside', parking = 1.0, heightMult = 0;
            if (d <= SB79_ZONES.adjacent.maxDist) { zoneKey = 'adjacent'; zoneLabel = 'Adjacent (â‰¤200ft)'; parking = 0; heightMult = 1.0; }
            else if (d <= SB79_ZONES.inner.maxDist) { zoneKey = 'inner'; zoneLabel = 'Inner (â‰¤Â¼ mi)'; parking = 0; heightMult = 1.0; }
            else if (d <= SB79_ZONES.outer.maxDist) { zoneKey = 'outer'; zoneLabel = 'Outer (Â¼â€“Â½ mi)'; parking = 0.5; heightMult = 0.68; }
            var allowances = null;
            if (zoneKey !== 'outside') {
                allowances = {
                    height: Math.round((tierData.height || 0) * heightMult),
                    density: Math.round((tierData.density || 0) * heightMult),
                    far: parseFloat(((tierData.far || 0) * heightMult).toFixed(2)),
                    parking: parking,
                };
            }
            nearby.push({
                station: s,
                stationIdx: i,
                distMiles: Math.round(d * 1000) / 1000,
                distFt: Math.round(d * 5280),
                tier: s.tier,
                tierLabel: tierData.label || ('Tier ' + s.tier),
                serviceType: s.serviceType || (s.tier === 1 ? 'Heavy Rail' : 'Light Rail'),
                line: s.line,
                lineLabel: LINE_LABELS[s.line] || s.line,
                lineColor: LINE_COLORS[s.line] || '#718096',
                zoneKey: zoneKey,
                zoneLabel: zoneLabel,
                allowances: allowances,
            });
        }
    }
    nearby.sort(function(a, b) { return a.distMiles - b.distMiles; });
    return nearby;
}

/**
 * Determine all applicable CA housing legislation for a Finder result parcel.
 * Tests multiple use types to find the broadest set of applicable bills.
 */
function getLegislationForResult(result) {
    var useTypes = ['multifamily_high', 'multifamily_mid', 'multifamily_low', 'mixeduse', 'senior', 'hotel', 'duplex', 'adu'];
    var allBills = {};
    var bestUseType = 'multifamily_mid';
    var bestCount = 0;

    // Build inp from the result data
    var lotSf = result.lotSizeSqFt || 10000;
    var transit = 'moderate';
    if (result.zone === 'adjacent') transit = 'adjacent';
    else if (result.zone === 'inner') transit = 'near';
    else if (result.zone === 'outer') transit = 'near';

    var zoning = 'C2';
    if (result.allowances && result.allowances.far >= 4.0) zoning = 'TOD';
    else if (result.zone === 'adjacent' || result.zone === 'inner') zoning = 'TOD';

    // Set window.lastGeocode for SB 79 applies() check
    var prevGeocode = window.lastGeocode;
    if (result.lat && result.lon) {
        window.lastGeocode = { lat: result.lat, lon: result.lon };
    }

    var inp = {
        parcelSize: lotSf,
        frontage: Math.round(Math.sqrt(lotSf) * 0.8),
        zoning: zoning,
        neighborhood: 'dtla',
        siteCondition: result.useType === 'Vacant' ? 'vacant' : 'demolition',
        topography: 'flat',
        cornerLot: false,
        transit: transit,
        arterial: 'major',
        utilities: 'full',
        constFlood: false,
        constHillside: false,
        constHistoric: false,
        constFault: false,
        constCoastal: false,
        constParking: false,
    };

    // Test each use type
    for (var u = 0; u < useTypes.length; u++) {
        var useId = useTypes[u];
        try {
            var bills = getApplicableLegislation(useId, inp);
            for (var b = 0; b < bills.length; b++) {
                allBills[bills[b].id] = bills[b];
            }
            if (bills.length > bestCount) {
                bestCount = bills.length;
                bestUseType = useId;
            }
        } catch(e) { /* skip */ }
    }

    // Restore original geocode
    window.lastGeocode = prevGeocode;

    var billList = [];
    for (var key in allBills) {
        if (allBills.hasOwnProperty(key)) billList.push(allBills[key]);
    }
    var effects = stackLegislationEffects(billList);
    return {
        bills: billList,
        effects: effects,
        bestUseType: bestUseType,
        inp: inp,
    };
}

function filterAndScoreResults(features, station, filters) {
    const results = [];
    for (const f of features) {
        const a = f.attributes;
        const lat = parseFloat(a.CENTER_LAT);
        const lon = parseFloat(a.CENTER_LON);
        if (!lat || !lon) continue;

        const lotSize = a['Shape.STArea()'] || a['Shape__Area'] || a['ShapeSTArea'] || 0;
        const lotSizeSqFt = Math.round(lotSize);
        const landVal = parseFloat(a.Roll_LandValue) || 0;
        const impVal = parseFloat(a.Roll_ImpValue) || 0;
        const impRatio = landVal > 0 ? impVal / landVal : (impVal === 0 ? 0 : 999);
        const yearBuilt = parseInt(a.YearBuilt1) || 0;
        const useType = classifyParcelUseType(a.UseType, a.UseDescription, a.UseCode);
        const sqft = parseInt(a.SQFTmain1) || 0;
        const units = parseInt(a.Units1) || 0;
        const address = a.SitusFullAddress || 'No address';
        const apn = a.APN || '';

        // Classify SB 79 zone
        const zoneInfo = classifySB79Zone(lat, lon, station.lat, station.lon);
        if (zoneInfo.key === 'outside') continue;
        // If specific zones are selected, filter to only those zones
        if (filters.selectedZones && filters.selectedZones.length > 0 && !filters.selectedZones.includes(zoneInfo.key)) continue;

        // Apply filters
        if (filters.minLot && lotSizeSqFt < filters.minLot) continue;
        if (filters.maxLot && lotSizeSqFt > filters.maxLot) continue;
        if (filters.useTypes.length > 0 && !filters.useTypes.includes(useType)) continue;
        if (filters.maxRatio !== null && impRatio > filters.maxRatio) continue;
        if (filters.yearBefore && yearBuilt > 0 && yearBuilt >= filters.yearBefore) continue;

        const allowances = getSB79Allowances(station.tier, zoneInfo.key);

        // Get all nearby transit stops + TOD bonuses
        var nearbyTransit = getAllNearbyTransit(lat, lon, 0.75);

        // Get all applicable CA housing legislation
        var resultObj = {
            address: address, apn: apn, lotSizeSqFt: lotSizeSqFt, useType: useType,
            yearBuilt: yearBuilt, landVal: landVal, impVal: impVal,
            impRatio: impRatio, sqft: sqft, units: units, lat: lat, lon: lon,
            zone: zoneInfo.key, zoneDist: zoneInfo.dist,
            allowances: allowances, tier: station.tier,
            nearbyTransit: nearbyTransit,
        };
        var legInfo = getLegislationForResult(resultObj);
        resultObj.legislation = legInfo.bills;
        resultObj.legislationEffects = legInfo.effects;
        resultObj.legislationCount = legInfo.bills.length;

        results.push(resultObj);
    }
    return results;
}

async function runOpportunitySearch() {
    const sel = document.getElementById('finderStation');
    const stationIdx = parseInt(sel.value);
    const station = METRO_STATIONS[stationIdx];
    if (!station) return;

    const { radiusFt } = getFinderRadius();
    const useChecks = document.querySelectorAll('.finderUseType:checked');
    const useTypes = Array.from(useChecks).map(c => c.value);
    const minLot = parseInt(document.getElementById('finderMinLot').value) || 0;
    const maxLot = parseInt(document.getElementById('finderMaxLot').value) || 999999;
    const maxRatio = parseFloat(document.getElementById('finderMaxRatio').value);
    const yearBefore = parseInt(document.getElementById('finderYearBefore').value) || 0;

    const filters = { useTypes, minLot, maxLot, maxRatio, yearBefore };

    // Show progress
    const progressEl = document.getElementById('finderProgress');
    const fillEl = document.getElementById('finderProgressFill');
    const textEl = document.getElementById('finderProgressText');
    const btn = document.getElementById('finderSearchBtn');
    const resultsArea = document.getElementById('finderResultsArea');

    progressEl.classList.add('active');
    fillEl.style.width = '0%';
    textEl.textContent = 'Querying parcels near ' + station.name + '...';
    btn.disabled = true;
    resultsArea.innerHTML = '';

    try {
        const features = await queryParcelsNearStation(
            station.lat, station.lon, radiusFt,
            (loaded, est) => {
                const pct = Math.min(90, Math.round((loaded / Math.max(est, 1)) * 90));
                fillEl.style.width = pct + '%';
                textEl.textContent = `Loading... ${loaded} parcels fetched`;
            }
        );

        fillEl.style.width = '95%';
        textEl.textContent = `Filtering ${features.length} parcels...`;

        finderResults = filterAndScoreResults(features, station, filters);

        // Default sort: lowest imp ratio first
        finderSortCol = 'impRatio';
        finderSortAsc = true;
        finderResults.sort((a, b) => a.impRatio - b.impRatio);

        fillEl.style.width = '100%';
        textEl.textContent = `Found ${finderResults.length} opportunities from ${features.length} parcels`;

        renderFinderResults(station);
        addFinderParcelsToMap(station);

    } catch (e) {
        console.error('Opportunity search failed:', e);
        resultsArea.innerHTML = `<div class="finder-error">
            <strong>Search failed:</strong> ${e.message || 'Unknown error'}
            ${e.message && e.message.includes('Failed to fetch') ? '<br>This may be a CORS restriction. Try opening the page directly or using a local server.' : ''}
        </div>`;
    }

    btn.disabled = false;
    setTimeout(() => progressEl.classList.remove('active'), 2000);
}

function renderFinderResults(station) {
    const area = document.getElementById('finderResultsArea');
    if (finderResults.length === 0) {
        area.innerHTML = '<div class="finder-no-results">No parcels matched your filters. Try expanding the search radius or adjusting filters.</div>';
        return;
    }

    const zoneBadge = (z) => `<span class="zone-badge ${z}">${z.charAt(0).toUpperCase() + z.slice(1)}</span>`;
    const ratioClass = (r) => r < 0.5 ? 'imp-ratio-hot' : r < 1.0 ? 'imp-ratio-warm' : 'imp-ratio-cool';
    const fmt = (v) => v ? '$' + v.toLocaleString() : '-';

    let html = `<div class="finder-summary">${finderResults.length} opportunities near <strong>${station.name}</strong> sorted by development potential &mdash; click any row to expand transit &amp; legislation details</div>`;
    html += `<div class="finder-table-wrapper"><table class="finder-table">
        <thead><tr>
            <th onclick="sortFinderTable('address')">Address</th>
            <th onclick="sortFinderTable('apn')">APN</th>
            <th onclick="sortFinderTable('lotSizeSqFt')">Lot Size</th>
            <th onclick="sortFinderTable('useType')">Use</th>
            <th onclick="sortFinderTable('yearBuilt')">Year Built</th>
            <th onclick="sortFinderTable('landVal')">Land Value</th>
            <th onclick="sortFinderTable('impRatio')" class="${finderSortCol === 'impRatio' ? (finderSortAsc ? 'sort-asc' : 'sort-desc') : ''}">Imp/Land</th>
            <th onclick="sortFinderTable('zone')">SB 79 Zone</th>
            <th>Allowances</th>
            <th onclick="sortFinderTable('legislationCount')">Legislation</th>
            <th>Transit Stops</th>
        </tr></thead><tbody>`;

    finderResults.forEach((r, i) => {
        const allow = r.allowances;
        const allowStr = allow ? `${allow.height}ft / ${allow.density}du / ${allow.far}FAR` : '-';
        const legCount = r.legislationCount || 0;
        const transitCount = r.nearbyTransit ? r.nearbyTransit.length : 0;
        const legBadge = legCount > 0 ? `<span style="background:#48bb78;color:#fff;padding:1px 6px;border-radius:10px;font-size:0.7rem;font-weight:600;">${legCount} bills</span>` : '<span style="color:#a0aec0;font-size:0.7rem;">None</span>';
        const transitBadge = transitCount > 0 ? `<span style="background:#4299e1;color:#fff;padding:1px 6px;border-radius:10px;font-size:0.7rem;font-weight:600;">${transitCount} stops</span>` : '-';

        html += `<tr onclick="toggleFinderDetail(${i}); highlightFinderParcel(${i})" id="finderRow${i}" style="cursor:pointer;">
            <td>${r.address}</td>
            <td>${r.apn}</td>
            <td>${r.lotSizeSqFt > 0 ? r.lotSizeSqFt.toLocaleString() + ' sf' : '-'}</td>
            <td>${r.useType}</td>
            <td>${r.yearBuilt > 0 ? r.yearBuilt : '-'}</td>
            <td>${fmt(r.landVal)}</td>
            <td class="${ratioClass(r.impRatio)}">${r.impRatio < 100 ? r.impRatio.toFixed(2) : 'N/A'}</td>
            <td>${zoneBadge(r.zone)}</td>
            <td style="font-size:0.75rem;">${allowStr}</td>
            <td>${legBadge}</td>
            <td>${transitBadge}</td>
        </tr>`;

        // Expandable detail row for transit + legislation
        html += `<tr id="finderDetail${i}" style="display:none;" class="finder-detail-row">
            <td colspan="11" style="padding:0.75rem 1rem;background:#f7fafc;border-left:3px solid #4299e1;">`;
        html += renderFinderDetailPanel(r, i);
        html += `</td></tr>`;
    });

    html += '</tbody></table></div>';
    html += `<button type="button" class="finder-btn-export" onclick="exportFinderCSV()">Export CSV (${finderResults.length} rows)</button>`;
    area.innerHTML = html;

    // Update sort indicators
    document.querySelectorAll('.finder-table th').forEach(th => {
        th.classList.remove('sort-asc', 'sort-desc');
    });
}

function sortFinderTable(col) {
    if (finderSortCol === col) {
        finderSortAsc = !finderSortAsc;
    } else {
        finderSortCol = col;
        finderSortAsc = true;
    }

    finderResults.sort((a, b) => {
        let va = a[col], vb = b[col];
        if (typeof va === 'string') {
            va = va.toLowerCase(); vb = (vb || '').toLowerCase();
            return finderSortAsc ? va.localeCompare(vb) : vb.localeCompare(va);
        }
        va = va || 0; vb = vb || 0;
        return finderSortAsc ? va - vb : vb - va;
    });

    // Re-render with current station
    const sel = document.getElementById('finderStation');
    const station = METRO_STATIONS[parseInt(sel.value)];
    renderFinderResults(station);

    // Re-apply sort indicator
    const headers = document.querySelectorAll('.finder-table th');
    const colMap = ['address', 'apn', 'lotSizeSqFt', 'useType', 'yearBuilt', 'landVal', 'impRatio', 'zone', '', 'legislationCount', ''];
    headers.forEach((th, i) => {
        if (colMap[i] === col) {
            th.classList.add(finderSortAsc ? 'sort-asc' : 'sort-desc');
        }
    });
}

function addFinderParcelsToMap(station) {
    if (!sb79Map) return;
    // Remove previous finder layer
    if (finderParcelLayer) {
        sb79Map.removeLayer(finderParcelLayer);
    }
    finderParcelLayer = L.layerGroup().addTo(sb79Map);

    finderResults.forEach((r, i) => {
        if (!r.lat || !r.lon) return;
        // Color by imp ratio: red=underbuilt, orange=moderate, green=built-out
        let color = '#38a169'; // green
        if (r.impRatio < 0.5) color = '#e53e3e'; // hot
        else if (r.impRatio < 1.0) color = '#dd6b20'; // warm

        const marker = L.circleMarker([r.lat, r.lon], {
            radius: 5, fillColor: color, color: '#fff',
            weight: 1, opacity: 0.9, fillOpacity: 0.8,
        });

        const allow = r.allowances;
        const allowStr = allow ? `Height: ${allow.height}ft | Density: ${allow.density}du/ac | FAR: ${allow.far}` : '';
        let popupLeg = '';
        if (r.legislation && r.legislation.length > 0) {
            popupLeg = '<br><strong style="color:#276749;">Legislation (' + r.legislation.length + '):</strong> ' + r.legislation.map(function(b) { return b.name; }).join(', ');
        }
        let popupTransit = '';
        if (r.nearbyTransit && r.nearbyTransit.length > 0) {
            var closest3 = r.nearbyTransit.slice(0, 3);
            popupTransit = '<br><strong style="color:#2b6cb0;">Nearest Transit:</strong> ' + closest3.map(function(t) { return t.station.name + ' (' + t.distFt.toLocaleString() + 'ft)'; }).join(', ');
        }
        marker.bindPopup(`<div style="font-size:0.82rem;max-width:320px;">
            <strong>${r.address}</strong><br>
            APN: ${r.apn}<br>
            Use: ${r.useType} | Lot: ${r.lotSizeSqFt > 0 ? r.lotSizeSqFt.toLocaleString() + ' sf' : '-'}<br>
            Imp/Land Ratio: <strong>${r.impRatio < 100 ? r.impRatio.toFixed(2) : 'N/A'}</strong><br>
            Land: $${(r.landVal || 0).toLocaleString()} | Imp: $${(r.impVal || 0).toLocaleString()}<br>
            <em>SB 79 Zone: ${r.zone} ${allowStr ? '| ' + allowStr : ''}</em>
            ${popupLeg}${popupTransit}
        </div>`);

        marker.on('click', () => {
            // Highlight corresponding table row
            document.querySelectorAll('.finder-table tr.highlighted').forEach(tr => tr.classList.remove('highlighted'));
            const row = document.getElementById('finderRow' + i);
            if (row) {
                row.classList.add('highlighted');
                row.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        });

        marker.addTo(finderParcelLayer);
    });

    // Add legend items for finder
    const legend = document.getElementById('mapLegend');
    if (legend && finderResults.length > 0) {
        const finderLegend = document.createElement('div');
        finderLegend.className = 'legend-item';
        finderLegend.id = 'finderLegendItems';
        finderLegend.innerHTML = `
            <div style="margin-bottom:0.4rem;font-weight:600;font-size:0.8rem;color:var(--primary);">Opportunity Classification (Improvement-to-Land Value Ratio)</div>
            <div style="display:flex;flex-wrap:wrap;gap:0.75rem;align-items:flex-start;">
                <div style="flex:1;min-width:140px;background:#fff5f5;border:1px solid #feb2b2;border-radius:6px;padding:0.4rem 0.6rem;">
                    <span class="legend-dot" style="background:#e53e3e;"></span> <strong style="color:#e53e3e;">Hot Opportunity</strong> <span style="font-size:0.75rem;color:#718096;">(Ratio &lt; 0.5)</span>
                    <div style="font-size:0.72rem;color:#4a5568;margin-top:0.2rem;">Improvements worth less than half the land value â€” significantly underbuilt. High redevelopment viability; land value far exceeds structure value, signaling strong upside potential.</div>
                </div>
                <div style="flex:1;min-width:140px;background:#fffaf0;border:1px solid #fbd38d;border-radius:6px;padding:0.4rem 0.6rem;">
                    <span class="legend-dot" style="background:#dd6b20;"></span> <strong style="color:#dd6b20;">Warm Opportunity</strong> <span style="font-size:0.75rem;color:#718096;">(Ratio 0.5â€“1.0)</span>
                    <div style="font-size:0.72rem;color:#4a5568;margin-top:0.2rem;">Improvements worth less than the land â€” moderately underbuilt. Viable for redevelopment or value-add repositioning, especially with density bonuses or zoning changes.</div>
                </div>
                <div style="flex:1;min-width:140px;background:#f0fff4;border:1px solid #9ae6b4;border-radius:6px;padding:0.4rem 0.6rem;">
                    <span class="legend-dot" style="background:#38a169;"></span> <strong style="color:#38a169;">Built-Out</strong> <span style="font-size:0.75rem;color:#718096;">(Ratio &ge; 1.0)</span>
                    <div style="font-size:0.72rem;color:#4a5568;margin-top:0.2rem;">Improvements meet or exceed land value â€” fully developed to current potential. Lower redevelopment viability unless significant upzoning or legislation creates new capacity.</div>
                </div>
            </div>
        `;
        // Remove old finder legend if present
        const old = document.getElementById('finderLegendItems');
        if (old) old.remove();
        legend.appendChild(finderLegend);
    }
}

function highlightFinderParcel(idx) {
    const r = finderResults[idx];
    if (!r || !sb79Map) return;

    // Highlight table row
    document.querySelectorAll('.finder-table tr.highlighted').forEach(tr => tr.classList.remove('highlighted'));
    const row = document.getElementById('finderRow' + idx);
    if (row) row.classList.add('highlighted');

    // Pan map to parcel
    sb79Map.setView([r.lat, r.lon], 17);

    // Open popup on the matching marker
    if (finderParcelLayer) {
        let i = 0;
        finderParcelLayer.eachLayer(layer => {
            if (i === idx && layer.openPopup) {
                layer.openPopup();
            }
            i++;
        });
    }
}

function toggleFinderDetail(idx) {
    var row = document.getElementById('finderDetail' + idx);
    if (!row) return;
    row.style.display = row.style.display === 'none' ? 'table-row' : 'none';
}

function renderFinderDetailPanel(r, idx) {
    var html = '<div style="display:flex;gap:1.5rem;flex-wrap:wrap;">';

    // --- TRANSIT PROXIMITY SECTION ---
    html += '<div style="flex:1;min-width:280px;">';
    html += '<h4 style="margin:0 0 0.5rem;font-size:0.85rem;color:#2b6cb0;">Nearby Transit Stops &amp; TOD Bonuses</h4>';
    if (r.nearbyTransit && r.nearbyTransit.length > 0) {
        html += '<table style="width:100%;font-size:0.72rem;border-collapse:collapse;">';
        html += '<thead><tr style="background:#ebf8ff;"><th style="padding:3px 6px;text-align:left;">Station</th><th style="padding:3px 6px;">Line</th><th style="padding:3px 6px;">Distance</th><th style="padding:3px 6px;">Tier</th><th style="padding:3px 6px;">Zone</th><th style="padding:3px 6px;">Height</th><th style="padding:3px 6px;">Density</th><th style="padding:3px 6px;">FAR</th><th style="padding:3px 6px;">Parking</th></tr></thead><tbody>';
        for (var t = 0; t < Math.min(r.nearbyTransit.length, 8); t++) {
            var tr = r.nearbyTransit[t];
            var a = tr.allowances;
            var rowBg = t % 2 === 0 ? '#fff' : '#f7fafc';
            html += '<tr style="background:' + rowBg + ';">';
            html += '<td style="padding:3px 6px;font-weight:600;">' + tr.station.name + '</td>';
            html += '<td style="padding:3px 6px;"><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:' + tr.lineColor + ';margin-right:3px;"></span>' + tr.lineLabel + '</td>';
            html += '<td style="padding:3px 6px;text-align:center;">' + tr.distFt.toLocaleString() + ' ft<br><span style="color:#718096;">(' + tr.distMiles.toFixed(2) + ' mi)</span></td>';
            html += '<td style="padding:3px 6px;text-align:center;"><span style="background:' + (tr.tier === 1 ? '#e53e3e' : '#4299e1') + ';color:#fff;padding:1px 5px;border-radius:8px;font-size:0.65rem;">' + (tr.tier === 1 ? 'Tier 1' : 'Tier 2') + '</span><br><span style="font-size:0.65rem;color:#718096;">' + tr.serviceType + '</span></td>';
            if (a) {
                html += '<td style="padding:3px 6px;text-align:center;font-weight:600;">' + tr.zoneLabel + '</td>';
                html += '<td style="padding:3px 6px;text-align:center;">' + a.height + ' ft</td>';
                html += '<td style="padding:3px 6px;text-align:center;">' + a.density + ' du/ac</td>';
                html += '<td style="padding:3px 6px;text-align:center;">' + a.far + '</td>';
                html += '<td style="padding:3px 6px;text-align:center;">' + (a.parking === 0 ? '<span style="color:#38a169;font-weight:700;">None req.</span>' : a.parking + '/unit') + '</td>';
            } else {
                html += '<td style="padding:3px 6px;text-align:center;color:#a0aec0;">Outside</td>';
                html += '<td colspan="4" style="padding:3px 6px;text-align:center;color:#a0aec0;">No SB 79 bonuses (>Â½ mi)</td>';
            }
            html += '</tr>';
        }
        if (r.nearbyTransit.length > 8) {
            html += '<tr><td colspan="9" style="padding:3px 6px;color:#718096;font-style:italic;">+ ' + (r.nearbyTransit.length - 8) + ' more stops within Â¾ mile</td></tr>';
        }
        html += '</tbody></table>';
    } else {
        html += '<p style="color:#a0aec0;font-size:0.8rem;margin:0;">No transit stops within Â¾ mile</p>';
    }
    html += '</div>';

    // --- LEGISLATION SECTION ---
    html += '<div style="flex:1;min-width:280px;">';
    html += '<h4 style="margin:0 0 0.5rem;font-size:0.85rem;color:#276749;">Applicable CA Housing Legislation</h4>';
    if (r.legislation && r.legislation.length > 0) {
        for (var b = 0; b < r.legislation.length; b++) {
            var bill = r.legislation[b];
            var bonuses = [];
            if (bill.densityBonus > 0) bonuses.push('+' + Math.round((typeof bill.densityBonus === 'number' ? bill.densityBonus : 0) * 100) + '% density');
            if (bill.parkingReduction > 0) bonuses.push('-' + Math.round((typeof bill.parkingReduction === 'number' ? bill.parkingReduction : 0) * 100) + '% parking');
            if (bill.softCostReduction > 0) bonuses.push('-' + Math.round((typeof bill.softCostReduction === 'number' ? bill.softCostReduction : 0) * 100) + '% soft costs');
            if (bill.legalOverride) bonuses.push('By-Right Override');
            if (bill.minFAR > 0) bonuses.push('Min FAR ' + (typeof bill.minFAR === 'number' ? bill.minFAR : 0));
            var bonusStr = bonuses.length > 0 ? bonuses.join(' | ') : 'Streamlined approvals';
            html += '<div style="margin-bottom:0.4rem;padding:0.4rem 0.5rem;background:#f0fff4;border:1px solid #c6f6d5;border-radius:6px;">';
            html += '<div style="font-weight:600;font-size:0.78rem;color:#276749;">' + bill.name + '</div>';
            html += '<div style="font-size:0.7rem;color:#4a5568;">' + bill.description + '</div>';
            html += '<div style="font-size:0.68rem;color:#38a169;margin-top:2px;font-weight:500;">' + bonusStr + '</div>';
            html += '</div>';
        }
        // Stacked effects summary
        var eff = r.legislationEffects;
        if (eff) {
            html += '<div style="margin-top:0.4rem;padding:0.4rem 0.6rem;background:#ebf8ff;border:1px solid #bee3f8;border-radius:6px;">';
            html += '<div style="font-weight:700;font-size:0.78rem;color:#2b6cb0;margin-bottom:2px;">Cumulative Stacked Effects</div>';
            html += '<div style="font-size:0.72rem;display:flex;gap:0.75rem;flex-wrap:wrap;">';
            if (eff.densityBonus > 0) html += '<span>Density: <strong>+' + Math.round(eff.densityBonus * 100) + '%</strong></span>';
            if (eff.parkingReduction > 0) html += '<span>Parking: <strong>-' + Math.round(eff.parkingReduction * 100) + '%</strong></span>';
            if (eff.softCostReduction > 0) html += '<span>Soft Cost: <strong>-' + Math.round(eff.softCostReduction * 100) + '%</strong></span>';
            if (eff.minFAR > 0) html += '<span>Min FAR: <strong>' + eff.minFAR + '</strong></span>';
            if (eff.legalOverride) html += '<span style="color:#e53e3e;font-weight:600;">By-Right Override</span>';
            html += '</div></div>';
        }
    } else {
        html += '<p style="color:#a0aec0;font-size:0.8rem;margin:0;">No specific legislation applies to this parcel.</p>';
    }
    html += '</div>';

    html += '</div>'; // close flex container
    return html;
}

function exportFinderCSV() {
    if (finderResults.length === 0) return;
    const headers = ['Address', 'APN', 'Lot Size (sf)', 'Use Type', 'Year Built', 'Land Value', 'Imp Value', 'Imp/Land Ratio', 'SB79 Zone', 'Max Height (ft)', 'Max Density (du/ac)', 'Max FAR', 'Parking Req', 'Legislation Count', 'Transit Stops', 'Latitude', 'Longitude'];
    const rows = finderResults.map(r => {
        const a = r.allowances || {};
        return [
            `"${(r.address || '').replace(/"/g, '""')}"`,
            r.apn, r.lotSizeSqFt, r.useType, r.yearBuilt || '',
            r.landVal, r.impVal, r.impRatio < 100 ? r.impRatio.toFixed(3) : '',
            r.zone, a.height || '', a.density || '', a.far || '', a.parking ?? '',
            r.lat, r.lon,
        ].join(',');
    });
    const csv = [headers.join(','), ...rows].join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `sb79-opportunities-${new Date().toISOString().slice(0, 10)}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// ============================================================
//  TAB NAVIGATION & STANDALONE FINDER
// ============================================================

let activeTab = 'calculator';
let finderMapInstance = null;
let finderMapInitialized = false;
let finderParcelLayer2 = null;
let finderResults2 = [];
let finderSortCol2 = 'impRatio';
let finderSortAsc2 = true;
let finderSelectedSet = new Set();

function switchTab(tab) {
    activeTab = tab;
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tab);
    });
    document.getElementById('tabCalculator').classList.toggle('active', tab === 'calculator');
    document.getElementById('tabFinder').classList.toggle('active', tab === 'finder');
    document.getElementById('tabPipeline').classList.toggle('active', tab === 'pipeline');
    document.getElementById('tabContacts').classList.toggle('active', tab === 'contacts');

    if (tab === 'contacts' && !contactsInitialized) {
        renderContactsDirectory();
        contactsInitialized = true;
    }
    if (tab === 'finder' && !finderMapInitialized) {
        setTimeout(() => initFinderMap(), 100);
    } else if (tab === 'finder' && finderMapInstance) {
        setTimeout(() => finderMapInstance.invalidateSize(), 100);
    }
    if (tab === 'pipeline' && !pipelineMapInitialized) {
        setTimeout(() => initPipelineMap(), 100);
    } else if (tab === 'pipeline' && pipelineMapInstance) {
        setTimeout(() => pipelineMapInstance.invalidateSize(), 100);
    }
}

/* ========================================================
   DEVELOPMENT PIPELINE â€” State, constants, functions
   ======================================================== */

const PIPELINE_STAGE_MAP = {
    'submitted': 'submitted',
    'permit submitted': 'submitted',
    'application submitted': 'submitted',
    'plan check': 'plan_check',
    'plan check submitted': 'plan_check',
    'pcis job in plan check': 'plan_check',
    'plan check correction(s) made': 'plan_check',
    'issued': 'issued',
    'permit issued': 'issued',
    'under inspection': 'inspection',
    'inspections started': 'inspection',
    'finaled': 'finaled',
    'permit finaled': 'finaled',
    'coo issued': 'coo',
    'certificate of occupancy': 'coo',
    'co issued': 'coo',
    'temporary certificate of occupancy': 'coo',
};

const PIPELINE_STAGE_LABELS = {
    submitted: 'Submitted', plan_check: 'Plan Check', issued: 'Issued',
    inspection: 'Under Inspection', finaled: 'Finaled', coo: 'Cert of Occ',
};

const PIPELINE_COLORS = {
    submitted: '#d69e2e', plan_check: '#dd6b20', issued: '#3182ce',
    inspection: '#38a169', finaled: '#718096', coo: '#276749',
};

const PIPELINE_PERMIT_TYPE_MAP = {
    bldg: 'bldg', grading: 'grading', elec: 'elec', plumb: 'plumb', mech: 'mech',
};

let pipelineMapInstance = null;
let pipelineMapInitialized = false;
let pipelineMarkerLayer = null;
let pipelineSearchCenter = null; // {lat, lon, label}
let pipelineResults = [];
let pipelineSortCol = 'valuation';
let pipelineSortAsc = false;
let pipelineOverlayActive = false;
let pipelineOverlayLayer = null;
let pipelineCache = new Map(); // key â†’ {ts, data}

// ===================================================================
//  CONTACTS DIRECTORY
// ===================================================================
let contactsInitialized = false;

const CONTACTS_DATA = [
    // === Planning Departments ===
    { name: 'LA City Planning Dept', category: 'planning', role: 'City Planning', phone: '(213) 978-1271', email: 'planning.lacityplanning@lacity.org', website: 'https://planning.lacity.gov', address: '200 N Spring St, Room 525, Los Angeles, CA 90012', notes: 'Zoning, General Plan, entitlements, CEQA' },
    { name: 'LA County Dept of Regional Planning', category: 'planning', role: 'County Planning', phone: '(213) 974-6411', email: 'planning@planning.lacounty.gov', website: 'https://planning.lacounty.gov', address: '320 W Temple St, Los Angeles, CA 90012', notes: 'Unincorporated LA County areas' },
    { name: 'Santa Monica Planning', category: 'planning', role: 'City Planning', phone: '(310) 458-8341', email: 'planning@smgov.net', website: 'https://www.smgov.net/Departments/PCD/', address: '1685 Main St, Room 212, Santa Monica, CA 90401', notes: 'Planning, zoning, permits' },
    { name: 'Culver City Planning', category: 'planning', role: 'City Planning', phone: '(310) 253-5750', email: 'planning@culvercity.org', website: 'https://www.culvercity.org/City-Hall/Community-Development/Planning-Division', address: '9770 Culver Blvd, Culver City, CA 90232', notes: 'Current & advance planning' },
    { name: 'Beverly Hills Planning', category: 'planning', role: 'City Planning', phone: '(310) 285-1141', email: 'planning@beverlyhills.org', website: 'https://www.beverlyhills.org/departments/communitydevelopment/planningdivision/', address: '455 N Rexford Dr, Beverly Hills, CA 90210', notes: 'Planning Commission, design review' },
    { name: 'West Hollywood Planning', category: 'planning', role: 'City Planning', phone: '(323) 848-6475', email: '', website: 'https://www.weho.org/city-government/city-departments/community-development/planning-division', address: '8300 Santa Monica Blvd, West Hollywood, CA 90069', notes: 'Rent stabilization, planning' },
    { name: 'Pasadena Planning', category: 'planning', role: 'City Planning', phone: '(626) 744-4009', email: 'planning@cityofpasadena.net', website: 'https://www.cityofpasadena.net/planning/', address: '175 N Garfield Ave, Pasadena, CA 91101', notes: 'Historic preservation, design review' },
    { name: 'Glendale Community Development', category: 'planning', role: 'City Planning', phone: '(818) 548-2140', email: '', website: 'https://www.glendaleca.gov/government/departments/community-development', address: '633 E Broadway, Room 103, Glendale, CA 91206', notes: 'Planning, building, code compliance' },
    { name: 'Burbank Planning', category: 'planning', role: 'City Planning', phone: '(818) 238-5250', email: '', website: 'https://www.burbankca.gov/web/community-development/planning-division', address: '150 N Third St, Burbank, CA 91502', notes: 'Current planning, advance planning' },
    { name: 'Long Beach Development Services', category: 'planning', role: 'City Planning', phone: '(562) 570-6194', email: '', website: 'https://www.longbeach.gov/lbds/', address: '411 W Ocean Blvd, 3rd Floor, Long Beach, CA 90802', notes: 'Planning, building, code enforcement' },
    { name: 'Inglewood Planning', category: 'planning', role: 'City Planning', phone: '(310) 412-5230', email: '', website: 'https://www.cityofinglewood.org/148/Planning-Division', address: 'One Manchester Blvd, Inglewood, CA 90301', notes: 'SoFi Stadium area, TOC opportunities' },

    // === Building & Safety ===
    { name: 'LA Dept of Building & Safety (LADBS)', category: 'building', role: 'Building & Safety', phone: '(213) 482-0000', email: '', website: 'https://www.ladbs.org', address: '201 N Figueroa St, Suite 1000, Los Angeles, CA 90012', notes: 'Permits, inspections, code enforcement, plan check' },
    { name: 'LADBS Express Permit', category: 'building', role: 'Express Permits', phone: '(213) 482-0466', email: '', website: 'https://www.ladbs.org/services/check-status/express-permit', address: '201 N Figueroa St, Los Angeles, CA 90012', notes: 'Over-the-counter permits for minor work' },
    { name: 'LA County Building & Safety', category: 'building', role: 'County Building', phone: '(626) 458-3177', email: '', website: 'https://dpw.lacounty.gov/building-and-safety/', address: '900 S Fremont Ave, Alhambra, CA 91803', notes: 'Unincorporated areas' },
    { name: 'LA Fire Dept (LAFD) - Plan Check', category: 'building', role: 'Fire Dept Plan Check', phone: '(213) 978-3860', email: '', website: 'https://www.lafd.org/fire-prevention/plan-check', address: '200 N Main St, Room 1700, Los Angeles, CA 90012', notes: 'Fire life safety plan review' },

    // === Housing Agencies ===
    { name: 'LA Housing Dept (LAHD)', category: 'housing', role: 'Housing Authority', phone: '(866) 557-7368', email: '', website: 'https://housing.lacity.gov', address: '1200 W 7th St, Suite 100, Los Angeles, CA 90017', notes: 'Affordable housing, rent stabilization, REAP' },
    { name: 'HACLA (Housing Authority)', category: 'housing', role: 'Housing Authority', phone: '(213) 252-2500', email: '', website: 'https://www.hacla.org', address: '2600 Wilshire Blvd, Los Angeles, CA 90057', notes: 'Section 8, public housing, mixed-finance' },
    { name: 'CA HCD (Housing & Community Development)', category: 'housing', role: 'State Housing', phone: '(916) 263-2911', email: '', website: 'https://www.hcd.ca.gov', address: '2020 W El Camino Ave, Suite 500, Sacramento, CA 95833', notes: 'RHNA, housing element, state programs' },
    { name: 'CTCAC (Tax Credit Allocation)', category: 'housing', role: 'Tax Credits', phone: '(916) 654-6340', email: '', website: 'https://www.treasurer.ca.gov/ctcac/', address: '915 Capitol Mall, Suite 485, Sacramento, CA 95814', notes: 'LIHTC 4% and 9% allocations' },

    // === Architects ===
    { name: 'KTGY Architecture + Planning', category: 'architect', role: 'Architect (Multifamily)', phone: '(310) 394-2623', email: '', website: 'https://ktgy.com', address: '17911 Von Karman Ave, Irvine, CA 92614', notes: 'Multifamily, mixed-use, senior living' },
    { name: 'AC Martin Partners', category: 'architect', role: 'Architect (Mixed-Use)', phone: '(213) 683-1900', email: '', website: 'https://acmartin.com', address: '444 S Flower St, Suite 1200, Los Angeles, CA 90071', notes: 'DTLA towers, mixed-use, civic' },
    { name: 'HKS Architects', category: 'architect', role: 'Architect (Commercial)', phone: '(213) 542-5900', email: '', website: 'https://www.hksinc.com', address: '350 S Figueroa St, Suite 200, Los Angeles, CA 90071', notes: 'Office, hospitality, sports/entertainment' },
    { name: 'Steinberg Hart', category: 'architect', role: 'Architect (Community)', phone: '(213) 629-0500', email: '', website: 'https://www.steinberghart.com', address: '750 B St, Suite 2300, San Diego, CA 92101', notes: 'Affordable housing, community, education' },
    { name: 'Togawa Smith Martin', category: 'architect', role: 'Architect (Affordable)', phone: '(323) 258-7028', email: '', website: 'https://tsminc.com', address: '460 S Spring St, Suite 500, Los Angeles, CA 90013', notes: 'Affordable, supportive housing specialist' },

    // === Engineers ===
    { name: 'KPFF Consulting Engineers', category: 'engineer', role: 'Structural Engineer', phone: '(213) 318-4140', email: '', website: 'https://www.kpff.com', address: '515 S Flower St, Suite 4500, Los Angeles, CA 90071', notes: 'Structural, civil, seismic' },
    { name: 'Psomas Engineering', category: 'engineer', role: 'Civil Engineer', phone: '(213) 223-1400', email: '', website: 'https://www.psomas.com', address: '555 S Flower St, Suite 4300, Los Angeles, CA 90071', notes: 'Civil, surveying, environmental' },
    { name: 'ARUP', category: 'engineer', role: 'MEP / Multidiscipline', phone: '(213) 629-5575', email: '', website: 'https://www.arup.com', address: '900 Wilshire Blvd, Suite 700, Los Angeles, CA 90017', notes: 'Structural, MEP, fire, sustainability' },
    { name: 'Buro Happold', category: 'engineer', role: 'MEP Engineer', phone: '(213) 337-0025', email: '', website: 'https://www.burohappold.com', address: '6601 Center Dr West, Suite 500, Los Angeles, CA 90045', notes: 'MEP, sustainability, smart buildings' },

    // === General Contractors ===
    { name: 'AECOM-Hunt', category: 'gc', role: 'General Contractor', phone: '(213) 593-8000', email: '', website: 'https://www.aecom.com', address: '300 S Grand Ave, Suite 1000, Los Angeles, CA 90071', notes: 'Large-scale, infrastructure, mixed-use' },
    { name: 'Suffolk Construction', category: 'gc', role: 'General Contractor', phone: '(213) 787-3700', email: '', website: 'https://www.suffolk.com', address: '915 Wilshire Blvd, Suite 1700, Los Angeles, CA 90017', notes: 'High-rise, multifamily, healthcare' },
    { name: 'Bernards', category: 'gc', role: 'General Contractor', phone: '(909) 941-5225', email: '', website: 'https://www.bernards.com', address: '555 First St, San Fernando, CA 91340', notes: 'Affordable housing, education, healthcare' },
    { name: 'Morley Builders', category: 'gc', role: 'General Contractor', phone: '(310) 471-4900', email: '', website: 'https://www.morleybuilders.com', address: '2901 28th St, Suite 100, Santa Monica, CA 90405', notes: 'Mixed-use, multifamily, commercial' },
    { name: 'Webcor Builders', category: 'gc', role: 'General Contractor', phone: '(213) 271-1780', email: '', website: 'https://www.webcor.com', address: '555 S Flower St, Suite 4800, Los Angeles, CA 90071', notes: 'High-rise, lab/life science, hospitality' },

    // === Lenders & Finance ===
    { name: 'CBRE Capital Markets', category: 'lender', role: 'Capital Markets', phone: '(213) 613-3226', email: '', website: 'https://www.cbre.com/services/capital-markets', address: '400 S Hope St, 25th Floor, Los Angeles, CA 90071', notes: 'Debt placement, equity raise, investment sales' },
    { name: 'JLL Capital Markets', category: 'lender', role: 'Capital Markets', phone: '(213) 239-6000', email: '', website: 'https://www.jll.com', address: '515 S Flower St, Suite 3200, Los Angeles, CA 90071', notes: 'Debt, equity, structured finance' },
    { name: 'Pacific Western Bank (Banc of California)', category: 'lender', role: 'Construction Lender', phone: '(310) 887-8500', email: '', website: 'https://www.bancofcal.com', address: '3 MacArthur Pl, Santa Ana, CA 92707', notes: 'Construction, bridge, permanent loans' },
    { name: 'Ready Capital', category: 'lender', role: 'Bridge/Construction Lender', phone: '(212) 257-4600', email: '', website: 'https://readycapital.com', address: '1251 Avenue of the Americas, 50th Fl, NY, NY 10020', notes: 'Bridge, construction, SBA 504' },
    { name: 'Enterprise Community Investment (LIHTC)', category: 'lender', role: 'LIHTC Syndicator', phone: '(410) 964-1230', email: '', website: 'https://www.enterprisecommunity.org', address: '70 Corporate Center, Columbia, MD 21044', notes: 'LIHTC syndication, affordable housing finance' },
    { name: 'Raymond James Tax Credit Funds', category: 'lender', role: 'LIHTC Syndicator', phone: '(800) 438-8088', email: '', website: 'https://www.rjtcf.com', address: '880 Carillon Pkwy, St. Petersburg, FL 33716', notes: 'LIHTC, Historic Tax Credit, NMTC syndication' },

    // === Legal / Land Use ===
    { name: 'Armbruster Goldsmith & Delvac', category: 'legal', role: 'Land Use Attorney', phone: '(310) 209-8800', email: '', website: 'https://www.agd-landuse.com', address: '12100 Wilshire Blvd, Suite 1600, Los Angeles, CA 90025', notes: 'Entitlements, CEQA, development agreements' },
    { name: 'Latham & Watkins (Land Use)', category: 'legal', role: 'Land Use Attorney', phone: '(213) 485-1234', email: '', website: 'https://www.lw.com', address: '355 S Grand Ave, Suite 100, Los Angeles, CA 90071', notes: 'Complex entitlements, P3, environmental' },
    { name: 'Manatt Phelps & Phillips', category: 'legal', role: 'RE/Land Use Attorney', phone: '(310) 312-4000', email: '', website: 'https://www.manatt.com', address: '2049 Century Park E, Suite 1700, Los Angeles, CA 90067', notes: 'Real estate, land use, affordable housing' },
    { name: 'Cox Castle & Nicholson', category: 'legal', role: 'RE Attorney', phone: '(310) 284-2200', email: '', website: 'https://www.coxcastle.com', address: '2049 Century Park E, Suite 2800, Los Angeles, CA 90067', notes: 'Real estate transactions, construction, land use' },

    // === Consultants ===
    { name: 'Kosmont Companies', category: 'consultant', role: 'RE/Financial Advisory', phone: '(213) 417-3300', email: '', website: 'https://www.kosmont.com', address: '865 S Figueroa St, Suite 3500, Los Angeles, CA 90017', notes: 'P3, fiscal impact, EIFD/CRIA, economic development' },
    { name: 'HR&A Advisors', category: 'consultant', role: 'Economic Consultant', phone: '(212) 977-6200', email: '', website: 'https://www.hraadvisors.com', address: '700 S Flower St, Suite 2995, Los Angeles, CA 90017', notes: 'Economic analysis, housing policy, public finance' },
    { name: 'Keyser Marston Associates', category: 'consultant', role: 'RE Economics', phone: '(310) 396-4556', email: '', website: 'https://www.keysermarston.com', address: '1880 Century Park E, Suite 818, Los Angeles, CA 90067', notes: 'Feasibility, fiscal impact, affordable housing' },
    { name: 'CBRE Consulting', category: 'consultant', role: 'Market Research', phone: '(213) 613-3333', email: '', website: 'https://www.cbre.com/services/advisory-and-consulting', address: '400 S Hope St, 25th Floor, Los Angeles, CA 90071', notes: 'Market studies, valuations, HBU analysis' },
    { name: 'EPS (Economic & Planning Systems)', category: 'consultant', role: 'Economic Consultant', phone: '(510) 841-9190', email: '', website: 'https://www.epsys.com', address: '1 Kaiser Plaza, Suite 1410, Oakland, CA 94612', notes: 'Fiscal impact, public finance, housing policy' },

    // === Utilities ===
    { name: 'LADWP (Water & Power)', category: 'utility', role: 'Electric & Water', phone: '(800) 342-5397', email: '', website: 'https://www.ladwp.com', address: '111 N Hope St, Los Angeles, CA 90012', notes: 'Electric service, water connections, solar incentives' },
    { name: 'SoCalGas', category: 'utility', role: 'Natural Gas', phone: '(800) 427-2200', email: '', website: 'https://www.socalgas.com', address: '555 W 5th St, Los Angeles, CA 90013', notes: 'Gas service, energy efficiency programs' },
    { name: 'LA Bureau of Sanitation', category: 'utility', role: 'Sewer & Stormwater', phone: '(800) 773-2489', email: '', website: 'https://www.lacitysan.org', address: '2714 Media Center Dr, Los Angeles, CA 90065', notes: 'Sewer connections, S-permits, stormwater' },
    { name: 'Spectrum / Charter Business', category: 'utility', role: 'Telecom', phone: '(855) 222-0102', email: '', website: 'https://www.spectrum.com/business', address: '', notes: 'Fiber, internet, bulk building agreements' },
];

const CATEGORY_ICONS = {
    planning: 'ðŸ›ï¸', building: 'ðŸ”¨', housing: 'ðŸ ', architect: 'ðŸ“',
    engineer: 'âš™ï¸', gc: 'ðŸ—ï¸', lender: 'ðŸ’°', legal: 'âš–ï¸',
    consultant: 'ðŸ“Š', utility: 'âš¡',
};
const CATEGORY_LABELS = {
    planning: 'Planning', building: 'Building & Safety', housing: 'Housing',
    architect: 'Architecture', engineer: 'Engineering', gc: 'General Contractor',
    lender: 'Finance', legal: 'Legal', consultant: 'Consulting', utility: 'Utilities',
};

function renderContactsDirectory() {
    var grid = document.getElementById('contactsGrid');
    if (!grid) return;
    renderContactCards(CONTACTS_DATA, grid);
}

function renderContactCards(contacts, container) {
    var html = '';
    contacts.forEach(function(c) {
        var icon = CATEGORY_ICONS[c.category] || 'ðŸ“‹';
        var catLabel = CATEGORY_LABELS[c.category] || c.category;
        html += '<div class="contact-card" style="background:var(--card);border:1px solid var(--border);border-radius:10px;padding:1rem;transition:box-shadow 0.2s;">';
        html += '<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:0.5rem;">';
        html += '<div><div style="font-size:0.88rem;font-weight:700;color:var(--text);">' + icon + ' ' + c.name + '</div>';
        html += '<div style="font-size:0.72rem;color:var(--text-light);">' + c.role + '</div></div>';
        html += '<span style="background:#edf2f7;padding:2px 8px;border-radius:4px;font-size:0.65rem;color:#4a5568;white-space:nowrap;">' + catLabel + '</span>';
        html += '</div>';
        if (c.phone) html += '<div style="font-size:0.75rem;margin-bottom:0.25rem;">ðŸ“ž <a href="tel:' + c.phone.replace(/[^0-9+]/g, '') + '" style="color:#3182ce;">' + c.phone + '</a></div>';
        if (c.email) html += '<div style="font-size:0.75rem;margin-bottom:0.25rem;">âœ‰ï¸ <a href="mailto:' + c.email + '" style="color:#3182ce;">' + c.email + '</a></div>';
        if (c.website) html += '<div style="font-size:0.75rem;margin-bottom:0.25rem;">ðŸŒ <a href="' + c.website + '" target="_blank" style="color:#3182ce;">' + c.website.replace('https://', '').replace('http://', '') + '</a></div>';
        if (c.address) html += '<div style="font-size:0.72rem;color:var(--text-light);margin-bottom:0.25rem;">ðŸ“ ' + c.address + '</div>';
        if (c.notes) html += '<div style="font-size:0.7rem;color:#718096;font-style:italic;border-top:1px solid var(--border);padding-top:0.4rem;margin-top:0.4rem;">' + c.notes + '</div>';
        html += '</div>';
    });
    if (contacts.length === 0) {
        html = '<div style="grid-column:1/-1;text-align:center;padding:2rem;color:var(--text-light);font-size:0.88rem;">No contacts match your search.</div>';
    }
    container.innerHTML = html;
}

function filterContacts() {
    var search = (document.getElementById('contactSearch').value || '').toLowerCase();
    var category = document.getElementById('contactCategory').value;
    var filtered = CONTACTS_DATA.filter(function(c) {
        var matchCat = !category || c.category === category;
        var matchSearch = !search || c.name.toLowerCase().indexOf(search) >= 0 || c.role.toLowerCase().indexOf(search) >= 0 || (c.notes || '').toLowerCase().indexOf(search) >= 0 || (c.address || '').toLowerCase().indexOf(search) >= 0;
        return matchCat && matchSearch;
    });
    renderContactCards(filtered, document.getElementById('contactsGrid'));
}

function initPipelineMap() {
    const mapEl = document.getElementById('pipelineMap');
    if (!mapEl) return;
    if (pipelineMapInstance) { pipelineMapInstance.remove(); pipelineMapInstance = null; }

    pipelineMapInstance = L.map('pipelineMap').setView([34.05, -118.25], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors', maxZoom: 18,
    }).addTo(pipelineMapInstance);

    pipelineMarkerLayer = L.layerGroup().addTo(pipelineMapInstance);

    pipelineMapInstance.on('click', function(e) {
        setPipelineSearchCenter(e.latlng.lat, e.latlng.lng, `${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}`);
    });

    renderPipelineMapLegend();

    // Set default date-from to 2 years ago
    const twoYearsAgo = new Date();
    twoYearsAgo.setFullYear(twoYearsAgo.getFullYear() - 2);
    const dateFromEl = document.getElementById('pipelineDateFrom');
    if (dateFromEl && !dateFromEl.value) {
        dateFromEl.value = twoYearsAgo.toISOString().split('T')[0];
    }

    pipelineMapInitialized = true;
    setTimeout(() => { if (pipelineMapInstance) pipelineMapInstance.invalidateSize(); }, 200);
}

function renderPipelineMapLegend() {
    const el = document.getElementById('pipelineLegend');
    if (!el) return;
    el.innerHTML = Object.entries(PIPELINE_COLORS).map(([key, color]) =>
        `<div class="pipeline-legend-item"><span class="pipeline-legend-dot" style="background:${color};"></span>${PIPELINE_STAGE_LABELS[key]}</div>`
    ).join('');
}

function setPipelineSearchCenter(lat, lon, label) {
    pipelineSearchCenter = { lat, lon, label };
    // Remove old center marker
    if (pipelineMapInstance._centerMarker) {
        pipelineMapInstance.removeLayer(pipelineMapInstance._centerMarker);
    }
    const icon = L.divIcon({
        html: '<div style="width:16px;height:16px;border-radius:50%;background:#e53e3e;border:3px solid #fff;box-shadow:0 2px 6px rgba(0,0,0,0.4);"></div>',
        iconSize: [16, 16], iconAnchor: [8, 8], className: '',
    });
    pipelineMapInstance._centerMarker = L.marker([lat, lon], { icon }).addTo(pipelineMapInstance);
    pipelineMapInstance.setView([lat, lon], 14);
    document.getElementById('pipelineMapStatus').textContent = `Search center: ${label}`;
}

async function geocodePipelineAddress() {
    const input = document.getElementById('pipelineAddress');
    const addr = input.value.trim();
    if (!addr) { alert('Please enter an address.'); return; }
    try {
        input.disabled = true;
        const result = await geocodeAddress(addr);
        setPipelineSearchCenter(result.lat, result.lon, addr);
    } catch (e) {
        alert('Geocoding failed: ' + e.message);
    } finally {
        input.disabled = false;
    }
}

/* --- API Query Functions --- */

function normalizePipelineRecord(raw, source) {
    let lat, lon;
    if (source === 'issued') {
        // pi9x-tg5x has geolocation field
        if (raw.geolocation) {
            lat = parseFloat(raw.geolocation.latitude || raw.geolocation.coordinates?.[1]);
            lon = parseFloat(raw.geolocation.longitude || raw.geolocation.coordinates?.[0]);
        }
        if (!lat && raw.latitude) lat = parseFloat(raw.latitude);
        if (!lon && raw.longitude) lon = parseFloat(raw.longitude);
    } else {
        lat = parseFloat(raw.latitude_y_coordinate || raw.latitude);
        lon = parseFloat(raw.longitude_x_coordinate || raw.longitude);
    }

    const statusRaw = (raw.status_desc || raw.status || raw.permit_status || '').toLowerCase().trim();
    const stage = PIPELINE_STAGE_MAP[statusRaw] || guessStage(statusRaw);

    const permitType = (raw.permit_type || raw.type || raw.permit_type_desc || '').toLowerCase();
    let typeKey = 'bldg';
    if (/grad/i.test(permitType)) typeKey = 'grading';
    else if (/elec/i.test(permitType)) typeKey = 'elec';
    else if (/plumb/i.test(permitType)) typeKey = 'plumb';
    else if (/mech/i.test(permitType)) typeKey = 'mech';

    return {
        permit_nbr: raw.permit_nbr || raw.pcis_permit || raw.permit_number || '',
        address: raw.address || raw.address_street || raw.project_address || '',
        permit_type: typeKey,
        permit_type_label: (raw.permit_type || raw.type || raw.permit_type_desc || 'Building').replace(/^\w/, c => c.toUpperCase()),
        stage: stage,
        status_raw: raw.status_desc || raw.status || raw.permit_status || '',
        valuation: parseFloat(raw.valuation || raw.project_valuation || 0) || 0,
        date: raw.issue_date || raw.submitted_date || raw.status_date || raw.filed_date || '',
        zone: raw.zone || raw.existing_zoning || '',
        description: raw.work_description || raw.project_description || raw.description || '',
        lat: lat,
        lon: lon,
        source: source,
    };
}

function guessStage(s) {
    if (/submit|appli/i.test(s)) return 'submitted';
    if (/plan.*check|pcis/i.test(s)) return 'plan_check';
    if (/issue/i.test(s)) return 'issued';
    if (/inspect/i.test(s)) return 'inspection';
    if (/final/i.test(s)) return 'finaled';
    if (/co |certificate|occupan/i.test(s)) return 'coo';
    return 'submitted';
}

function buildBoundingBox(lat, lon, radiusMiles) {
    const latDeg = radiusMiles / 69.0;
    const lonDeg = radiusMiles / (69.0 * Math.cos(lat * Math.PI / 180));
    return {
        minLat: lat - latDeg, maxLat: lat + latDeg,
        minLon: lon - lonDeg, maxLon: lon + lonDeg,
    };
}

async function queryPipelineIssuedPermits(lat, lon, radiusMiles, onProgress) {
    // pi9x-tg5x â€” has geolocation for within_circle()
    const radiusMeters = radiusMiles * 1609.34;
    const baseUrl = 'https://data.lacity.org/resource/pi9x-tg5x.json';
    const limit = 1000;
    let offset = 0;
    let allRecords = [];
    const cap = 5000;

    while (offset < cap) {
        const where = `within_circle(geolocation, ${lat}, ${lon}, ${radiusMeters})`;
        const url = `${baseUrl}?$where=${encodeURIComponent(where)}&$limit=${limit}&$offset=${offset}&$order=issue_date DESC`;
        const resp = await fetch(url);
        if (!resp.ok) break;
        const data = await resp.json();
        if (!data || data.length === 0) break;
        allRecords = allRecords.concat(data.map(r => normalizePipelineRecord(r, 'issued')));
        if (onProgress) onProgress(`Fetched ${allRecords.length} issued permits...`, Math.min(allRecords.length / cap * 50, 45));
        if (data.length < limit) break;
        offset += limit;
    }
    return allRecords;
}

async function queryPipelinePreIssuancePermits(lat, lon, radiusMiles, onProgress) {
    // gwh9-jnip â€” no geolocation, use bounding box + haversine cull
    const bb = buildBoundingBox(lat, lon, radiusMiles);
    const baseUrl = 'https://data.lacity.org/resource/gwh9-jnip.json';
    const limit = 1000;
    let offset = 0;
    let allRecords = [];
    const cap = 3000;

    while (offset < cap) {
        const where = `latitude_y_coordinate >= ${bb.minLat} AND latitude_y_coordinate <= ${bb.maxLat} AND longitude_x_coordinate >= ${bb.minLon} AND longitude_x_coordinate <= ${bb.maxLon}`;
        const url = `${baseUrl}?$where=${encodeURIComponent(where)}&$limit=${limit}&$offset=${offset}&$order=submitted_date DESC`;
        const resp = await fetch(url);
        if (!resp.ok) break;
        const data = await resp.json();
        if (!data || data.length === 0) break;
        const normalized = data.map(r => normalizePipelineRecord(r, 'pre_issuance'));
        // Client-side haversine filter
        const filtered = normalized.filter(r => r.lat && r.lon && haversine(lat, lon, r.lat, r.lon) <= radiusMiles);
        allRecords = allRecords.concat(filtered);
        if (onProgress) onProgress(`Fetched ${allRecords.length} pre-issuance permits...`, 50 + Math.min(allRecords.length / cap * 45, 45));
        if (data.length < limit) break;
        offset += limit;
    }
    return allRecords;
}

async function fetchAllPipelinePermits(lat, lon, radiusMiles, onProgress) {
    // Check cache
    const cacheKey = `${lat.toFixed(4)}_${lon.toFixed(4)}_${radiusMiles}`;
    const cached = pipelineCache.get(cacheKey);
    if (cached && (Date.now() - cached.ts < 5 * 60 * 1000)) {
        if (onProgress) onProgress('Using cached results', 100);
        return cached.data;
    }

    const [issued, preIssue] = await Promise.all([
        queryPipelineIssuedPermits(lat, lon, radiusMiles, onProgress),
        queryPipelinePreIssuancePermits(lat, lon, radiusMiles, onProgress),
    ]);

    // Deduplicate by permit_nbr
    const seen = new Set();
    const combined = [];
    for (const r of [...issued, ...preIssue]) {
        const key = r.permit_nbr || `${r.lat}_${r.lon}_${r.address}`;
        if (!seen.has(key)) { seen.add(key); combined.push(r); }
    }

    pipelineCache.set(cacheKey, { ts: Date.now(), data: combined });
    return combined;
}

/* --- Search, Filter, Sort, Render --- */

async function runPipelineSearch() {
    if (!pipelineSearchCenter) {
        alert('Please set a search center first â€” enter an address or click on the map.');
        return;
    }

    const radiusEl = document.querySelector('input[name="pipelineRadius"]:checked');
    const radius = radiusEl ? parseFloat(radiusEl.value) : 0.5;

    const progressEl = document.getElementById('pipelineProgress');
    const fillEl = document.getElementById('pipelineProgressFill');
    const textEl = document.getElementById('pipelineProgressText');
    progressEl.classList.add('active');
    fillEl.style.width = '5%';
    textEl.textContent = 'Starting permit search...';

    try {
        const allRecords = await fetchAllPipelinePermits(
            pipelineSearchCenter.lat, pipelineSearchCenter.lon, radius,
            (msg, pct) => { textEl.textContent = msg; fillEl.style.width = pct + '%'; }
        );

        fillEl.style.width = '95%';
        textEl.textContent = `Processing ${allRecords.length} records...`;

        // Apply filters
        let filtered = applyPipelineFilters(allRecords);

        // Apply date filters
        const dateFrom = document.getElementById('pipelineDateFrom').value;
        const dateTo = document.getElementById('pipelineDateTo').value;
        if (dateFrom) filtered = filtered.filter(r => r.date >= dateFrom);
        if (dateTo) filtered = filtered.filter(r => r.date <= dateTo + 'T23:59:59');

        pipelineResults = filtered;
        sortPipelineResults(pipelineResults);
        renderPipelineResults();
        renderPipelineMarkers();

        fillEl.style.width = '100%';
        textEl.textContent = `Found ${filtered.length} permits (from ${allRecords.length} total in radius)`;
        setTimeout(() => progressEl.classList.remove('active'), 2000);
    } catch (e) {
        fillEl.style.width = '0%';
        textEl.textContent = 'Error: ' + e.message;
        console.error('Pipeline search error:', e);
    }
}

function applyPipelineFilters(records) {
    // Stage filter
    const checkedStages = new Set();
    document.querySelectorAll('.pipelineStage:checked').forEach(cb => checkedStages.add(cb.value));
    // Permit type filter
    const checkedTypes = new Set();
    document.querySelectorAll('.pipelinePermitType:checked').forEach(cb => checkedTypes.add(cb.value));
    // Min valuation
    const minVal = parseFloat(document.getElementById('pipelineMinVal').value) || 0;

    return records.filter(r => {
        if (checkedStages.size > 0 && !checkedStages.has(r.stage)) return false;
        if (checkedTypes.size > 0 && !checkedTypes.has(r.permit_type)) return false;
        if (r.valuation < minVal) return false;
        return true;
    });
}

function sortPipelineResults(records) {
    records.sort((a, b) => {
        let va = a[pipelineSortCol], vb = b[pipelineSortCol];
        if (pipelineSortCol === 'valuation') { va = va || 0; vb = vb || 0; }
        if (typeof va === 'string') va = va.toLowerCase();
        if (typeof vb === 'string') vb = vb.toLowerCase();
        if (va < vb) return pipelineSortAsc ? -1 : 1;
        if (va > vb) return pipelineSortAsc ? 1 : -1;
        return 0;
    });
}

function setPipelineSort(col) {
    if (pipelineSortCol === col) { pipelineSortAsc = !pipelineSortAsc; }
    else { pipelineSortCol = col; pipelineSortAsc = col === 'address'; }
    sortPipelineResults(pipelineResults);
    renderPipelineResults();
    // Update header indicators
    document.querySelectorAll('#pipelineTable th').forEach(th => {
        th.classList.remove('sort-asc', 'sort-desc');
        if (th.dataset.col === col) th.classList.add(pipelineSortAsc ? 'sort-asc' : 'sort-desc');
    });
}

function renderPipelineResults() {
    const area = document.getElementById('pipelineResultsArea');
    const tbody = document.getElementById('pipelineTableBody');
    const title = document.getElementById('pipelineResultsTitle');
    const summary = document.getElementById('pipelineResultsSummary');
    const exportBtn = document.getElementById('pipelineExportBtn');

    if (!pipelineResults.length) {
        area.style.display = 'none';
        exportBtn.style.display = 'none';
        return;
    }

    area.style.display = 'block';
    exportBtn.style.display = 'inline-block';
    title.textContent = `Permit Results`;
    const totalVal = pipelineResults.reduce((s, r) => s + (r.valuation || 0), 0);
    summary.textContent = `${pipelineResults.length} permits Â· $${totalVal.toLocaleString()} total valuation`;

    tbody.innerHTML = pipelineResults.map((r, i) => {
        const valClass = r.valuation >= 5000000 ? 'pipeline-val-high' : r.valuation >= 500000 ? 'pipeline-val-mid' : '';
        const valStr = r.valuation ? '$' + r.valuation.toLocaleString() : 'â€”';
        const dateStr = r.date ? r.date.substring(0, 10) : 'â€”';
        const stageLabel = PIPELINE_STAGE_LABELS[r.stage] || r.status_raw || r.stage;
        return `<tr onclick="highlightPipelineMarker(${i})" style="cursor:pointer;">
            <td onclick="event.stopPropagation()"><input type="checkbox" class="pipeline-select" data-idx="${i}" onchange="updatePipelineSelectUI()"></td>
            <td>${r.address || 'â€”'}</td>
            <td style="font-family:monospace;font-size:0.78rem;">${r.permit_nbr || 'â€”'}</td>
            <td>${r.permit_type_label}</td>
            <td><span class="pipeline-badge ${r.stage}">${stageLabel}</span></td>
            <td class="${valClass}">${valStr}</td>
            <td>${dateStr}</td>
            <td>${r.zone || 'â€”'}</td>
            <td style="max-width:200px;font-size:0.75rem;color:var(--text-light);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${(r.description || '').replace(/"/g, '&quot;')}">${r.description || 'â€”'}</td>
        </tr>`;
    }).join('');
    // Show saved panel if has saved
    renderPipelineSavedList();
}

function renderPipelineMarkers() {
    if (!pipelineMarkerLayer) return;
    pipelineMarkerLayer.clearLayers();

    const cap = 500;
    const toShow = pipelineResults.slice(0, cap);
    toShow.forEach((r, i) => {
        if (!r.lat || !r.lon) return;
        const color = PIPELINE_COLORS[r.stage] || '#718096';
        const marker = L.circleMarker([r.lat, r.lon], {
            radius: 6, fillColor: color, fillOpacity: 0.8,
            color: '#fff', weight: 1.5,
        });
        const valStr = r.valuation ? '$' + r.valuation.toLocaleString() : 'N/A';
        const stageLabel = PIPELINE_STAGE_LABELS[r.stage] || r.stage;
        marker.bindPopup(`<div style="font-size:0.82rem;line-height:1.4;">
            <strong>${r.address || 'Unknown'}</strong><br>
            Permit: ${r.permit_nbr}<br>
            Stage: <span class="pipeline-badge ${r.stage}" style="font-size:0.7rem;">${stageLabel}</span><br>
            Valuation: ${valStr}<br>
            ${r.description ? '<em>' + r.description.substring(0, 120) + '</em>' : ''}
        </div>`, { maxWidth: 280 });
        marker.on('click', () => highlightPipelineRow(i));
        marker.addTo(pipelineMarkerLayer);
    });

    if (pipelineResults.length > cap) {
        document.getElementById('pipelineResultsSummary').textContent += ` (showing ${cap} of ${pipelineResults.length} on map)`;
    }
}

function highlightPipelineMarker(idx) {
    const r = pipelineResults[idx];
    if (!r) return;
    // Highlight table row
    document.querySelectorAll('#pipelineTable tr.highlighted').forEach(tr => tr.classList.remove('highlighted'));
    const rows = document.querySelectorAll('#pipelineTableBody tr');
    if (rows[idx]) {
        rows[idx].classList.add('highlighted');
        rows[idx].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
    // Pan map
    if (r.lat && r.lon && pipelineMapInstance) {
        pipelineMapInstance.setView([r.lat, r.lon], 16);
    }
}

function highlightPipelineRow(idx) {
    document.querySelectorAll('#pipelineTable tr.highlighted').forEach(tr => tr.classList.remove('highlighted'));
    const rows = document.querySelectorAll('#pipelineTableBody tr');
    if (rows[idx]) {
        rows[idx].classList.add('highlighted');
        rows[idx].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
}

function clearPipelineSearch() {
    pipelineResults = [];
    pipelineSearchCenter = null;
    if (pipelineMarkerLayer) pipelineMarkerLayer.clearLayers();
    if (pipelineMapInstance && pipelineMapInstance._centerMarker) {
        pipelineMapInstance.removeLayer(pipelineMapInstance._centerMarker);
        pipelineMapInstance._centerMarker = null;
    }
    document.getElementById('pipelineResultsArea').style.display = 'none';
    document.getElementById('pipelineExportBtn').style.display = 'none';
    document.getElementById('pipelineProgress').classList.remove('active');
    document.getElementById('pipelineMapStatus').textContent = 'Enter an address or click the map to set a search center';
    document.getElementById('pipelineAddress').value = '';
    document.getElementById('pipelineMinVal').value = '';
    if (pipelineMapInstance) pipelineMapInstance.setView([34.05, -118.25], 12);
}

function exportPipelineCSV() {
    if (!pipelineResults.length) return;
    const headers = ['Address', 'Permit #', 'Type', 'Stage', 'Valuation', 'Date', 'Zone', 'Description', 'Lat', 'Lon'];
    const rows = pipelineResults.map(r => [
        r.address, r.permit_nbr, r.permit_type_label,
        PIPELINE_STAGE_LABELS[r.stage] || r.stage,
        r.valuation, r.date ? r.date.substring(0, 10) : '',
        r.zone, (r.description || '').replace(/"/g, '""'),
        r.lat, r.lon,
    ]);
    let csv = headers.join(',') + '\n';
    rows.forEach(row => {
        csv += row.map(v => `"${v}"`).join(',') + '\n';
    });
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `pipeline_permits_${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
    URL.revokeObjectURL(url);
}

/* --- Pipeline Selection, Saved List & Deep Analysis --- */

function togglePipelineSelectAll() {
    var allCB = document.getElementById('pipelineSelectAll');
    var checks = document.querySelectorAll('.pipeline-select');
    checks.forEach(function(cb) { cb.checked = allCB.checked; });
    updatePipelineSelectUI();
}

function updatePipelineSelectUI() {
    var checks = document.querySelectorAll('.pipeline-select:checked');
    var saveBtn = document.getElementById('pipelineSaveBtn');
    var deepBtn = document.getElementById('pipelineDeepBtn');
    if (saveBtn) saveBtn.style.display = checks.length > 0 ? 'inline-block' : 'none';
    if (deepBtn) deepBtn.style.display = checks.length > 0 ? 'inline-block' : 'none';
}

function getPipelineSaved() {
    try { return JSON.parse(localStorage.getItem('pipeline_saved_list')) || []; }
    catch(e) { return []; }
}
function setPipelineSaved(list) {
    localStorage.setItem('pipeline_saved_list', JSON.stringify(list));
}

function savePipelineSelected() {
    var checks = document.querySelectorAll('.pipeline-select:checked');
    if (checks.length === 0) return;
    var saved = getPipelineSaved();
    var existingPermits = new Set(saved.map(function(s) { return s.permit_nbr; }));
    var added = 0;
    checks.forEach(function(cb) {
        var idx = parseInt(cb.getAttribute('data-idx'));
        var r = pipelineResults[idx];
        if (r && !existingPermits.has(r.permit_nbr)) {
            saved.push({
                address: r.address || '',
                permit_nbr: r.permit_nbr || '',
                permit_type: r.permit_type_label || '',
                stage: r.stage || '',
                stageLabel: PIPELINE_STAGE_LABELS[r.stage] || r.stage || '',
                valuation: r.valuation || 0,
                date: r.date ? r.date.substring(0, 10) : '',
                zone: r.zone || '',
                description: r.description || '',
                lat: r.lat,
                lon: r.lon,
                // Build synthetic property data for deep analysis
                apn: '',
                lotSizeSqFt: estimateLotFromPermit(r),
                useType: r.permit_type_label || 'Commercial',
                yearBuilt: 0,
                landVal: 0,
                impVal: r.valuation || 0,
                impRatio: 0,
                allowances: estimateAllowancesFromZone(r.zone),
            });
            added++;
        }
        cb.checked = false;
    });
    setPipelineSaved(saved);
    updatePipelineSelectUI();
    renderPipelineSavedList();
    if (added > 0) alert(added + ' site(s) added to saved pipeline list.');
}

function estimateLotFromPermit(r) {
    // Rough estimate based on valuation (higher valuation = larger project)
    if (r.valuation >= 10000000) return 25000;
    if (r.valuation >= 5000000) return 15000;
    if (r.valuation >= 1000000) return 10000;
    if (r.valuation >= 500000) return 7500;
    return 5000;
}

function estimateAllowancesFromZone(zone) {
    // Default TOD-style allowances for pipeline sites near transit
    return { height: 55, density: 70, far: 3.0, parking: '0.5/unit' };
}

function renderPipelineSavedList() {
    var saved = getPipelineSaved();
    var panel = document.getElementById('pipelineSavedPanel');
    var body = document.getElementById('pipelineSavedBody');
    var countEl = document.getElementById('pipelineSavedCount');
    if (!panel || !body) return;

    if (saved.length === 0) {
        panel.style.display = 'none';
        return;
    }
    panel.style.display = 'block';
    countEl.textContent = saved.length + ' site' + (saved.length === 1 ? '' : 's');

    body.innerHTML = saved.map(function(r, i) {
        var valStr = r.valuation ? '$' + r.valuation.toLocaleString() : 'â€”';
        return '<tr>' +
            '<td>' + (r.address || 'â€”') + '</td>' +
            '<td style="font-family:monospace;font-size:0.78rem;">' + (r.permit_nbr || 'â€”') + '</td>' +
            '<td>' + (r.permit_type || 'â€”') + '</td>' +
            '<td>' + (r.stageLabel || 'â€”') + '</td>' +
            '<td>' + valStr + '</td>' +
            '<td style="max-width:150px;font-size:0.72rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + (r.description || 'â€”') + '</td>' +
            '<td><button type="button" class="saved-btn-remove" onclick="removePipelineSaved(' + i + ')">Remove</button></td>' +
            '</tr>';
    }).join('');
}

function removePipelineSaved(idx) {
    var saved = getPipelineSaved();
    saved.splice(idx, 1);
    setPipelineSaved(saved);
    renderPipelineSavedList();
}

function clearPipelineSaved() {
    if (!confirm('Remove all saved pipeline sites?')) return;
    setPipelineSaved([]);
    renderPipelineSavedList();
}

function exportPipelineSavedCSV() {
    var saved = getPipelineSaved();
    if (saved.length === 0) return;
    var headers = ['Address', 'Permit #', 'Type', 'Stage', 'Valuation', 'Date', 'Zone', 'Description', 'Lat', 'Lon'];
    var csv = headers.join(',') + '\n';
    saved.forEach(function(r) {
        csv += [r.address, r.permit_nbr, r.permit_type, r.stageLabel, r.valuation, r.date, r.zone, '"' + (r.description || '').replace(/"/g, '""') + '"', r.lat, r.lon].join(',') + '\n';
    });
    var blob = new Blob([csv], { type: 'text/csv' });
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'pipeline_saved_' + new Date().toISOString().slice(0, 10) + '.csv';
    a.click();
    URL.revokeObjectURL(url);
}

function deepAnalyzePipeline() {
    // Convert selected pipeline results to saved format and open deep analysis
    var checks = document.querySelectorAll('.pipeline-select:checked');
    if (checks.length === 0) { alert('Select at least one permit site.'); return; }
    var sites = [];
    checks.forEach(function(cb) {
        var idx = parseInt(cb.getAttribute('data-idx'));
        var r = pipelineResults[idx];
        if (r) {
            sites.push({
                address: r.address || 'Permit ' + r.permit_nbr,
                apn: r.permit_nbr || '',
                lotSizeSqFt: estimateLotFromPermit(r),
                useType: r.permit_type_label || 'Commercial',
                yearBuilt: 0,
                landVal: 0,
                impVal: r.valuation || 0,
                impRatio: 0,
                lat: r.lat,
                lon: r.lon,
                zone: 'inner',
                allowances: estimateAllowancesFromZone(r.zone),
            });
        }
    });
    // Temporarily set these as the saved list and open deep analysis
    var origSaved = localStorage.getItem('sb79_saved_list');
    localStorage.setItem('sb79_saved_list', JSON.stringify(sites));
    openDeepAnalysis();
    // Restore original saved list
    if (origSaved) localStorage.setItem('sb79_saved_list', origSaved);
    else localStorage.removeItem('sb79_saved_list');
}

function deepAnalyzePipelineSaved() {
    var saved = getPipelineSaved();
    if (saved.length === 0) { alert('No saved pipeline sites.'); return; }
    // Convert to compatible format for deep analysis
    var sites = saved.map(function(r) {
        return {
            address: r.address || 'Permit ' + r.permit_nbr,
            apn: r.permit_nbr || '',
            lotSizeSqFt: r.lotSizeSqFt || 10000,
            useType: r.useType || 'Commercial',
            yearBuilt: r.yearBuilt || 0,
            landVal: r.landVal || 0,
            impVal: r.impVal || r.valuation || 0,
            impRatio: r.impRatio || 0,
            lat: r.lat,
            lon: r.lon,
            zone: 'inner',
            allowances: r.allowances || estimateAllowancesFromZone(r.zone),
        };
    });
    var origSaved = localStorage.getItem('sb79_saved_list');
    localStorage.setItem('sb79_saved_list', JSON.stringify(sites));
    openDeepAnalysis();
    if (origSaved) localStorage.setItem('sb79_saved_list', origSaved);
    else localStorage.removeItem('sb79_saved_list');
}

/* --- Finder Tab Overlay Integration --- */

function injectPipelineOverlayButton() {
    const container = document.getElementById('finderMapContainer');
    if (!container || container.querySelector('.pipeline-overlay-btn')) return;
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'pipeline-overlay-btn';
    btn.textContent = 'Show Permits Nearby';
    btn.onclick = togglePipelineOverlay;
    container.style.position = 'relative';
    container.appendChild(btn);
}

async function togglePipelineOverlay() {
    const btn = document.querySelector('.pipeline-overlay-btn');
    if (!btn) return;

    if (pipelineOverlayActive) {
        // Remove overlay
        if (pipelineOverlayLayer && finderMapInstance) {
            finderMapInstance.removeLayer(pipelineOverlayLayer);
            pipelineOverlayLayer = null;
        }
        pipelineOverlayActive = false;
        btn.classList.remove('active');
        btn.textContent = 'Show Permits Nearby';
        return;
    }

    // Find selected station
    const stationSelect = document.getElementById('finderStation2');
    if (!stationSelect || stationSelect.selectedIndex < 0) {
        alert('Please select a transit station first.');
        return;
    }
    const idx = parseInt(stationSelect.value);
    const station = METRO_STATIONS[idx];
    if (!station) { alert('No station selected.'); return; }

    btn.textContent = 'Loading...';
    btn.disabled = true;

    try {
        const permits = await fetchAllPipelinePermits(station.lat, station.lon, 0.5, null);
        pipelineOverlayLayer = L.layerGroup();
        const cap = 300;
        permits.slice(0, cap).forEach(r => {
            if (!r.lat || !r.lon) return;
            const color = PIPELINE_COLORS[r.stage] || '#718096';
            const m = L.circleMarker([r.lat, r.lon], {
                radius: 4, fillColor: color, fillOpacity: 0.7,
                color: '#fff', weight: 1,
            });
            const stageLabel = PIPELINE_STAGE_LABELS[r.stage] || r.stage;
            m.bindPopup(`<strong>${r.address || 'Permit'}</strong><br>${r.permit_nbr}<br>${stageLabel}`, { maxWidth: 200 });
            m.addTo(pipelineOverlayLayer);
        });
        pipelineOverlayLayer.addTo(finderMapInstance);
        pipelineOverlayActive = true;
        btn.classList.add('active');
        btn.textContent = `Hide Permits (${Math.min(permits.length, cap)})`;
    } catch (e) {
        alert('Failed to load permits: ' + e.message);
        btn.textContent = 'Show Permits Nearby';
    } finally {
        btn.disabled = false;
    }
}

function initFinderMap() {
    const mapEl = document.getElementById('finderMap');
    if (!mapEl) return;

    if (finderMapInstance) { finderMapInstance.remove(); finderMapInstance = null; }

    finderMapInstance = L.map('finderMap').setView([34.05, -118.25], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
        maxZoom: 18,
    }).addTo(finderMapInstance);

    // Add all station markers
    const seenCoords = new Set();
    METRO_STATIONS.forEach((s, idx) => {
        const key = `${s.lat.toFixed(4)},${s.lon.toFixed(4)},${s.line}`;
        if (seenCoords.has(key)) return;
        seenCoords.add(key);

        const color = LINE_COLORS[s.line] || '#718096';
        const icon = L.divIcon({
            html: `<div style="background:${color};width:10px;height:10px;border-radius:50%;border:2px solid #fff;box-shadow:0 1px 3px rgba(0,0,0,0.3);"></div>`,
            iconSize: [10, 10], iconAnchor: [5, 5], className: '',
        });
        const tierData = SB79_TIERS[s.tier];
        const lineName = LINE_LABELS[s.line] || s.line;
        const popupHtml = `<div class="station-popup">
            <div class="popup-title">${s.name}</div>
            <div class="popup-line">${lineName} &mdash; ${s.serviceType} &mdash; ${tierData.label}</div>
            <div class="popup-allowances">
                <span><strong>SB 79 Allowances:</strong></span>
                <span>Height: ${tierData.height} ft | Density: ${tierData.density} du/ac</span>
                <span>FAR: ${tierData.far} | Parking: 0 (inner), 0.5/unit (outer)</span>
            </div>
        </div>`;
        const marker = L.marker([s.lat, s.lon], { icon })
            .bindPopup(popupHtml)
            .on('click', () => {
                selectFinderStation2(idx);
                drawFinderStationRadii(s);
            });
        marker.addTo(finderMapInstance);
    });

    // Native DOM click handler for zone identification (bypasses all Leaflet layers)
    attachZoneClickHandler(finderMapInstance);

    // Render legend
    renderFinderMapLegend();

    // Populate station dropdown
    populateFinderStations2();

    finderMapInitialized = true;
    setTimeout(() => { if (finderMapInstance) finderMapInstance.invalidateSize(); }, 200);

    // Inject pipeline overlay button
    injectPipelineOverlayButton();
}

function drawFinderStationRadii(station) {
    // Remove old radii if any
    if (finderMapInstance._finderRadii) {
        finderMapInstance._finderRadii.forEach(c => finderMapInstance.removeLayer(c));
    }
    var tierColor = station.tier === 1 ? '#805ad5' : '#3182ce';
    var circles = [];

    // ALL circles are purely visual â€” zone clicks handled by native DOM listener
    // 1/2 mile = ~805m (outer)
    circles.push(L.circle([station.lat, station.lon], {
        radius: 805, color: tierColor, weight: 2.5, opacity: 0.8,
        fillColor: tierColor, fillOpacity: 0.08,
        interactive: false, dashArray: '12,8',
    }).addTo(finderMapInstance));

    // 1/4 mile = ~402m (inner)
    circles.push(L.circle([station.lat, station.lon], {
        radius: 402, color: tierColor, weight: 2.5, opacity: 0.8,
        fillColor: tierColor, fillOpacity: 0.12,
        interactive: false, dashArray: '8,6',
    }).addTo(finderMapInstance));

    // 200ft = ~61m (adjacent)
    circles.push(L.circle([station.lat, station.lon], {
        radius: 61, color: tierColor, weight: 2.5, opacity: 0.9,
        fillColor: tierColor, fillOpacity: 0.20,
        interactive: false, dashArray: '4,4',
    }).addTo(finderMapInstance));

    finderMapInstance._finderRadii = circles;
    finderMapInstance.setView([station.lat, station.lon], 14);
}

function renderFinderMapLegend() {
    const el = document.getElementById('finderMapLegend');
    if (!el) return;
    el.innerHTML = `
        <div class="legend-item"><span class="legend-dot" style="background:#e53e3e;"></span> Red/B Line</div>
        <div class="legend-item"><span class="legend-dot" style="background:#805ad5;"></span> Purple/D Line</div>
        <div class="legend-item"><span class="legend-dot" style="background:#3182ce;"></span> Blue/A Line</div>
        <div class="legend-item"><span class="legend-dot" style="background:#d69e2e;"></span> Expo/E Line</div>
        <div class="legend-item"><span class="legend-dot" style="background:#b7791f;"></span> Gold/L Line</div>
        <div class="legend-item"><span class="legend-dot" style="background:#38a169;"></span> Green/C Line</div>
        <div class="legend-item"><span class="legend-dot" style="background:#00bcd4;"></span> K Line</div>
        <div class="legend-item"><span class="legend-dot" style="background:#ed64a6;"></span> Regional Connector</div>
        <div class="legend-item"><span class="legend-dot" style="background:#e53e3e;border:2px solid #999;width:8px;height:8px;"></span> Metrolink</div>
        <div class="legend-item"><span class="legend-line" style="background:#805ad5;"></span> Tier 1 â€” Heavy Rail (Red/B, Purple/D)</div>
        <div class="legend-item"><span class="legend-line" style="background:#3182ce;"></span> Tier 2 â€” Light Rail / Commuter Rail</div>
    `;
}

function populateFinderStations2() {
    const sel = document.getElementById('finderStation2');
    if (!sel) return;
    sel.innerHTML = '';
    const grouped = {};
    METRO_STATIONS.forEach((s, idx) => {
        const lineKey = s.line;
        if (!grouped[lineKey]) grouped[lineKey] = [];
        grouped[lineKey].push({ ...s, idx });
    });
    const lineOrder = ['red', 'purple', 'blue_a', 'expo_e', 'gold_l', 'green_c', 'k_line', 'connector', 'metrolink'];
    for (const lineKey of lineOrder) {
        if (!grouped[lineKey]) continue;
        const grp = document.createElement('optgroup');
        grp.label = LINE_LABELS[lineKey] || lineKey;
        for (const s of grouped[lineKey]) {
            const opt = document.createElement('option');
            opt.value = s.idx;
            opt.textContent = s.name;
            grp.appendChild(opt);
        }
        sel.appendChild(grp);
    }
}

function selectFinderStation2(idx) {
    const sel = document.getElementById('finderStation2');
    if (sel && sel.querySelector(`option[value="${idx}"]`)) {
        sel.value = idx;
    }
}

// Wire station dropdown change to zoom map
document.addEventListener('change', (e) => {
    if (e.target.id === 'finderStation2' && finderMapInstance) {
        const idx = parseInt(e.target.value);
        const station = METRO_STATIONS[idx];
        if (station) {
            drawFinderStationRadii(station);
        }
    }
});

async function runStandaloneSearch() {
    const sel = document.getElementById('finderStation2');
    const stationIdx = parseInt(sel.value);
    const station = METRO_STATIONS[stationIdx];
    if (!station) return;

    const radiusChecks = document.querySelectorAll('.finderRadius2:checked');
    const selectedRadii = Array.from(radiusChecks).map(c => parseInt(c.value));
    if (selectedRadii.length === 0) { alert('Please select at least one search radius.'); return; }
    const radiusFt = Math.max(...selectedRadii);
    const useChecks = document.querySelectorAll('.finderUseType2:checked');
    const useTypes = Array.from(useChecks).map(c => c.value);
    const minLot = parseInt(document.getElementById('finderMinLot2').value) || 0;
    const maxLot = parseInt(document.getElementById('finderMaxLot2').value) || 999999;

    // Map selected radii to zone keys for filtering
    const selectedZones = [];
    if (selectedRadii.includes(200)) selectedZones.push('adjacent');
    if (selectedRadii.includes(1320)) selectedZones.push('inner');
    if (selectedRadii.includes(2640)) selectedZones.push('outer');

    const filters = { useTypes, minLot, maxLot, maxRatio: null, yearBefore: null, selectedZones };

    finderSelectedSet.clear();

    const progressEl = document.getElementById('finderProgress2');
    const fillEl = document.getElementById('finderProgressFill2');
    const textEl = document.getElementById('finderProgressText2');
    const btn = document.getElementById('finderSearchBtn2');
    const resultsArea = document.getElementById('finderResultsArea2');

    progressEl.classList.add('active');
    fillEl.style.width = '0%';
    textEl.textContent = 'Querying parcels near ' + station.name + '...';
    btn.disabled = true;
    resultsArea.innerHTML = '';

    // Draw station radii on map
    drawFinderStationRadii(station);

    try {
        const features = await queryParcelsNearStation(
            station.lat, station.lon, radiusFt,
            (loaded, est) => {
                const pct = Math.min(90, Math.round((loaded / Math.max(est, 1)) * 90));
                fillEl.style.width = pct + '%';
                textEl.textContent = `Loading... ${loaded} parcels fetched`;
            }
        );

        fillEl.style.width = '95%';
        textEl.textContent = `Filtering ${features.length} parcels...`;

        finderResults2 = filterAndScoreResults(features, station, filters);

        finderSortCol2 = 'impRatio';
        finderSortAsc2 = true;
        finderResults2.sort((a, b) => a.impRatio - b.impRatio);

        fillEl.style.width = '100%';
        textEl.textContent = `Found ${finderResults2.length} opportunities from ${features.length} parcels`;

        renderFinderResults2(station);
        addFinderParcelsToMap2(station);

    } catch (e) {
        console.error('Standalone opportunity search failed:', e);
        resultsArea.innerHTML = `<div class="finder-error">
            <strong>Search failed:</strong> ${e.message || 'Unknown error'}
            ${e.message && e.message.includes('Failed to fetch') ? '<br>This may be a CORS restriction. Try opening the page directly or using a local server.' : ''}
        </div>`;
    }

    btn.disabled = false;
    setTimeout(() => progressEl.classList.remove('active'), 2000);
}

function renderFinderResults2(station) {
    const area = document.getElementById('finderResultsArea2');
    if (finderResults2.length === 0) {
        area.innerHTML = '<div class="finder-no-results">No parcels matched your filters. Try expanding the search radius or adjusting filters.</div>';
        return;
    }

    const zoneBadge = (z) => `<span class="zone-badge ${z}">${z.charAt(0).toUpperCase() + z.slice(1)}</span>`;
    const ratioClass = (r) => r < 0.5 ? 'imp-ratio-hot' : r < 1.0 ? 'imp-ratio-warm' : 'imp-ratio-cool';
    const fmt = (v) => v ? '$' + v.toLocaleString() : '-';
    const propLinks = (addr, apn) => {
        const enc = encodeURIComponent(addr);
        const apnClean = (apn || '').replace(/[^0-9]/g, '');
        return `<span class="prop-links" onclick="event.stopPropagation()"><a href="https://www.zillow.com/homes/${enc}_rb/" target="_blank" title="Zillow">Z</a> | <a href="https://www.redfin.com/search?q=${enc}" target="_blank" title="Redfin">R</a> | <a href="https://portal.assessor.lacounty.gov/parceldetail/${apnClean}" target="_blank" title="LA County Assessor">LA</a></span>`;
    };

    let html = `<div id="finderSelectionBar" class="selection-bar" style="display:none;">
        <span id="finderSelCount">0 selected</span>
        <button type="button" class="finder-btn-export" onclick="addSelectionToSaved()" style="margin:0 0.5rem;">Add to Saved List</button>
        <button type="button" class="finder-btn-export" onclick="clearFinderSelection()" style="margin:0;">Clear Selection</button>
    </div>`;
    html += `<div class="finder-summary">${finderResults2.length} opportunities near <strong>${station.name}</strong> sorted by development potential</div>`;
    html += `<div class="finder-table-wrapper"><table class="finder-table" id="finderTable2">
        <thead><tr>
            <th style="cursor:default;" onclick="event.stopPropagation();toggleSelectAll()"><input type="checkbox" id="finderSelectAll" onclick="event.stopPropagation();toggleSelectAll()"></th>
            <th onclick="sortFinderTable2('address')">Address</th>
            <th onclick="sortFinderTable2('apn')">APN</th>
            <th onclick="sortFinderTable2('lotSizeSqFt')">Lot Size</th>
            <th onclick="sortFinderTable2('useType')">Use</th>
            <th onclick="sortFinderTable2('yearBuilt')">Year Built</th>
            <th onclick="sortFinderTable2('landVal')">Land Value</th>
            <th onclick="sortFinderTable2('impVal')">Imp Value</th>
            <th onclick="sortFinderTable2('impRatio')" class="${finderSortCol2 === 'impRatio' ? (finderSortAsc2 ? 'sort-asc' : 'sort-desc') : ''}">Imp/Land</th>
            <th onclick="sortFinderTable2('zone')">SB 79 Zone</th>
            <th>Allowances</th>
            <th style="cursor:default;">Links</th>
        </tr></thead><tbody>`;

    finderResults2.forEach((r, i) => {
        const allow = r.allowances;
        const allowStr = allow ? `${allow.height}ft / ${allow.density}du / ${allow.far}FAR` : '-';
        const checked = finderSelectedSet.has(i) ? 'checked' : '';
        html += `<tr onclick="highlightFinderParcel2(${i})" id="finderRow2_${i}">
            <td onclick="event.stopPropagation()"><input type="checkbox" class="finder-row-check" data-idx="${i}" ${checked} onchange="onFinderCheckChange()"></td>
            <td>${r.address}</td>
            <td>${r.apn}</td>
            <td>${r.lotSizeSqFt > 0 ? r.lotSizeSqFt.toLocaleString() + ' sf' : '-'}</td>
            <td>${r.useType}</td>
            <td>${r.yearBuilt > 0 ? r.yearBuilt : '-'}</td>
            <td>${fmt(r.landVal)}</td>
            <td>${fmt(r.impVal)}</td>
            <td class="${ratioClass(r.impRatio)}">${r.impRatio < 100 ? r.impRatio.toFixed(2) : 'N/A'}</td>
            <td>${zoneBadge(r.zone)}</td>
            <td style="font-size:0.75rem;">${allowStr}</td>
            <td>${propLinks(r.address, r.apn)}</td>
        </tr>`;
    });

    html += '</tbody></table></div>';
    html += `<button type="button" class="finder-btn-export" onclick="exportFinderCSV2()">Export CSV (${finderResults2.length} rows)</button>`;
    area.innerHTML = html;
    updateSelectionBar();
}

function sortFinderTable2(col) {
    if (finderSortCol2 === col) {
        finderSortAsc2 = !finderSortAsc2;
    } else {
        finderSortCol2 = col;
        finderSortAsc2 = true;
    }

    finderResults2.sort((a, b) => {
        let va = a[col], vb = b[col];
        if (typeof va === 'string') {
            va = va.toLowerCase(); vb = (vb || '').toLowerCase();
            return finderSortAsc2 ? va.localeCompare(vb) : vb.localeCompare(va);
        }
        va = va || 0; vb = vb || 0;
        return finderSortAsc2 ? va - vb : vb - va;
    });

    const sel = document.getElementById('finderStation2');
    const station = METRO_STATIONS[parseInt(sel.value)];
    renderFinderResults2(station);

    const headers = document.querySelectorAll('#finderTable2 th');
    const colMap = [null, 'address', 'apn', 'lotSizeSqFt', 'useType', 'yearBuilt', 'landVal', 'impVal', 'impRatio', 'zone', null, null];
    headers.forEach((th, i) => {
        if (colMap[i] && colMap[i] === col) {
            th.classList.add(finderSortAsc2 ? 'sort-asc' : 'sort-desc');
        }
    });
}

function addFinderParcelsToMap2(station) {
    if (!finderMapInstance) return;
    if (finderParcelLayer2) {
        finderMapInstance.removeLayer(finderParcelLayer2);
    }
    finderParcelLayer2 = L.layerGroup().addTo(finderMapInstance);

    finderResults2.forEach((r, i) => {
        if (!r.lat || !r.lon) return;
        let color = '#38a169';
        if (r.impRatio < 0.5) color = '#e53e3e';
        else if (r.impRatio < 1.0) color = '#dd6b20';

        const marker = L.circleMarker([r.lat, r.lon], {
            radius: 5, fillColor: color, color: '#fff',
            weight: 1, opacity: 0.9, fillOpacity: 0.8,
        });

        const allow = r.allowances;
        const allowStr = allow ? `Height: ${allow.height}ft | Density: ${allow.density}du/ac | FAR: ${allow.far}` : '';
        const encAddr = encodeURIComponent(r.address);
        const apnClean = (r.apn || '').replace(/[^0-9]/g, '');
        marker.bindPopup(`<div style="font-size:0.82rem;">
            <strong>${r.address}</strong><br>
            APN: ${r.apn}<br>
            Use: ${r.useType} | Lot: ${r.lotSizeSqFt > 0 ? r.lotSizeSqFt.toLocaleString() + ' sf' : '-'}<br>
            Imp/Land Ratio: <strong>${r.impRatio < 100 ? r.impRatio.toFixed(2) : 'N/A'}</strong><br>
            Land: $${(r.landVal || 0).toLocaleString()} | Imp: $${(r.impVal || 0).toLocaleString()}<br>
            <em>SB 79 Zone: ${r.zone} ${allowStr ? '| ' + allowStr : ''}</em><br>
            <span style="font-size:0.78rem;"><a href="https://www.zillow.com/homes/${encAddr}_rb/" target="_blank">Zillow</a> | <a href="https://www.redfin.com/search?q=${encAddr}" target="_blank">Redfin</a> | <a href="https://portal.assessor.lacounty.gov/parceldetail/${apnClean}" target="_blank">LA Assessor</a></span>
        </div>`);

        marker.on('click', () => {
            document.querySelectorAll('#finderTable2 tr.highlighted').forEach(tr => tr.classList.remove('highlighted'));
            const row = document.getElementById('finderRow2_' + i);
            if (row) {
                row.classList.add('highlighted');
                row.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        });

        marker.addTo(finderParcelLayer2);
    });

    // Add opportunity legend to finder map
    const legend = document.getElementById('finderMapLegend');
    if (legend && finderResults2.length > 0) {
        const oldLeg = document.getElementById('finderOppLegendItems');
        if (oldLeg) oldLeg.remove();
        const finderLegend = document.createElement('div');
        finderLegend.className = 'legend-item';
        finderLegend.id = 'finderOppLegendItems';
        finderLegend.innerHTML = `
            <div style="margin-bottom:0.4rem;font-weight:600;font-size:0.8rem;color:var(--primary);">Opportunity Classification (Improvement-to-Land Value Ratio)</div>
            <div style="display:flex;flex-wrap:wrap;gap:0.75rem;align-items:flex-start;">
                <div style="flex:1;min-width:140px;background:#fff5f5;border:1px solid #feb2b2;border-radius:6px;padding:0.4rem 0.6rem;">
                    <span class="legend-dot" style="background:#e53e3e;"></span> <strong style="color:#e53e3e;">Hot Opportunity</strong> <span style="font-size:0.75rem;color:#718096;">(Ratio &lt; 0.5)</span>
                    <div style="font-size:0.72rem;color:#4a5568;margin-top:0.2rem;">Improvements worth less than half the land value â€” significantly underbuilt. High redevelopment viability; land value far exceeds structure value, signaling strong upside potential.</div>
                </div>
                <div style="flex:1;min-width:140px;background:#fffaf0;border:1px solid #fbd38d;border-radius:6px;padding:0.4rem 0.6rem;">
                    <span class="legend-dot" style="background:#dd6b20;"></span> <strong style="color:#dd6b20;">Warm Opportunity</strong> <span style="font-size:0.75rem;color:#718096;">(Ratio 0.5â€“1.0)</span>
                    <div style="font-size:0.72rem;color:#4a5568;margin-top:0.2rem;">Improvements worth less than the land â€” moderately underbuilt. Viable for redevelopment or value-add repositioning, especially with density bonuses or zoning changes.</div>
                </div>
                <div style="flex:1;min-width:140px;background:#f0fff4;border:1px solid #9ae6b4;border-radius:6px;padding:0.4rem 0.6rem;">
                    <span class="legend-dot" style="background:#38a169;"></span> <strong style="color:#38a169;">Built-Out</strong> <span style="font-size:0.75rem;color:#718096;">(Ratio &ge; 1.0)</span>
                    <div style="font-size:0.72rem;color:#4a5568;margin-top:0.2rem;">Improvements meet or exceed land value â€” fully developed to current potential. Lower redevelopment viability unless significant upzoning or legislation creates new capacity.</div>
                </div>
            </div>
        `;
        legend.appendChild(finderLegend);
    }
}

function highlightFinderParcel2(idx) {
    const r = finderResults2[idx];
    if (!r || !finderMapInstance) return;

    document.querySelectorAll('#finderTable2 tr.highlighted').forEach(tr => tr.classList.remove('highlighted'));
    const row = document.getElementById('finderRow2_' + idx);
    if (row) row.classList.add('highlighted');

    finderMapInstance.setView([r.lat, r.lon], 17);

    if (finderParcelLayer2) {
        let i = 0;
        finderParcelLayer2.eachLayer(layer => {
            if (i === idx && layer.openPopup) {
                layer.openPopup();
            }
            i++;
        });
    }
}

function exportFinderCSV2() {
    if (finderResults2.length === 0) return;
    const headers = ['Address', 'APN', 'Lot Size (sf)', 'Use Type', 'Year Built', 'Land Value', 'Imp Value', 'Imp/Land Ratio', 'SB79 Zone', 'Max Height (ft)', 'Max Density (du/ac)', 'Max FAR', 'Parking Req', 'Zillow URL', 'Assessor URL', 'Latitude', 'Longitude'];
    const rows = finderResults2.map(r => {
        const a = r.allowances || {};
        const enc = encodeURIComponent(r.address || '');
        const apnClean = (r.apn || '').replace(/[^0-9]/g, '');
        return [
            `"${(r.address || '').replace(/"/g, '""')}"`,
            r.apn, r.lotSizeSqFt, r.useType, r.yearBuilt || '',
            r.landVal, r.impVal, r.impRatio < 100 ? r.impRatio.toFixed(3) : '',
            r.zone, a.height || '', a.density || '', a.far || '', a.parking ?? '',
            `https://www.zillow.com/homes/${enc}_rb/`,
            `https://portal.assessor.lacounty.gov/parceldetail/${apnClean}`,
            r.lat, r.lon,
        ].join(',');
    });
    const csv = [headers.join(','), ...rows].join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `sb79-opportunities-${new Date().toISOString().slice(0, 10)}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// === Selection & Saved List ===

function onFinderCheckChange() {
    finderSelectedSet.clear();
    document.querySelectorAll('.finder-row-check:checked').forEach(cb => {
        finderSelectedSet.add(parseInt(cb.dataset.idx));
    });
    const allCb = document.getElementById('finderSelectAll');
    if (allCb) {
        const total = document.querySelectorAll('.finder-row-check').length;
        allCb.checked = finderSelectedSet.size === total && total > 0;
    }
    updateSelectionBar();
}

function toggleSelectAll() {
    const allCb = document.getElementById('finderSelectAll');
    const checks = document.querySelectorAll('.finder-row-check');
    const shouldCheck = allCb ? allCb.checked : false;
    finderSelectedSet.clear();
    checks.forEach(cb => {
        cb.checked = shouldCheck;
        if (shouldCheck) finderSelectedSet.add(parseInt(cb.dataset.idx));
    });
    updateSelectionBar();
}

function updateSelectionBar() {
    const bar = document.getElementById('finderSelectionBar');
    if (!bar) return;
    const count = finderSelectedSet.size;
    if (count > 0) {
        bar.style.display = 'flex';
        document.getElementById('finderSelCount').textContent = count + ' selected';
    } else {
        bar.style.display = 'none';
    }
}

function clearFinderSelection() {
    finderSelectedSet.clear();
    document.querySelectorAll('.finder-row-check').forEach(cb => cb.checked = false);
    const allCb = document.getElementById('finderSelectAll');
    if (allCb) allCb.checked = false;
    updateSelectionBar();
}

function addSelectionToSaved() {
    if (finderSelectedSet.size === 0) return;
    const saved = getSavedList();
    const existingApns = new Set(saved.map(s => s.apn));
    let added = 0;
    finderSelectedSet.forEach(idx => {
        const r = finderResults2[idx];
        if (r && !existingApns.has(r.apn)) {
            saved.push({
                address: r.address, apn: r.apn, lotSizeSqFt: r.lotSizeSqFt,
                useType: r.useType, yearBuilt: r.yearBuilt, landVal: r.landVal,
                impVal: r.impVal, impRatio: r.impRatio, zone: r.zone,
                allowances: r.allowances, lat: r.lat, lon: r.lon, tier: r.tier,
            });
            added++;
        }
    });
    setSavedList(saved);
    clearFinderSelection();
    renderSavedList();
    if (added > 0) {
        const panel = document.getElementById('savedListPanel');
        if (panel) panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}

function getSavedList() {
    try { return JSON.parse(localStorage.getItem('sb79_saved_list')) || []; }
    catch { return []; }
}

function setSavedList(list) {
    localStorage.setItem('sb79_saved_list', JSON.stringify(list));
}

function renderSavedList() {
    const saved = getSavedList();
    const panel = document.getElementById('savedListPanel');
    const body = document.getElementById('savedListBody');
    const countEl = document.getElementById('savedListCount');
    if (!panel || !body) return;

    if (saved.length === 0) {
        panel.style.display = 'none';
        return;
    }
    panel.style.display = 'block';
    countEl.textContent = saved.length + ' propert' + (saved.length === 1 ? 'y' : 'ies');

    body.innerHTML = saved.map((r, i) => {
        const enc = encodeURIComponent(r.address || '');
        const apnClean = (r.apn || '').replace(/[^0-9]/g, '');
        const links = `<span class="prop-links"><a href="https://www.zillow.com/homes/${enc}_rb/" target="_blank" title="Zillow">Z</a> | <a href="https://www.redfin.com/search?q=${enc}" target="_blank" title="Redfin">R</a> | <a href="https://portal.assessor.lacounty.gov/parceldetail/${apnClean}" target="_blank" title="LA County Assessor">LA</a></span>`;
        return `<tr>
            <td><input type="checkbox" class="saved-select" data-idx="${i}"></td>
            <td>${r.address}</td>
            <td>${r.apn}</td>
            <td>${r.lotSizeSqFt > 0 ? r.lotSizeSqFt.toLocaleString() + ' sf' : '-'}</td>
            <td>${r.zone || '-'}</td>
            <td>${links}</td>
            <td><button type="button" class="saved-btn-remove" onclick="removeSavedItem(${i})">Remove</button></td>
        </tr>`;
    }).join('');
}

function removeSavedItem(idx) {
    const saved = getSavedList();
    saved.splice(idx, 1);
    setSavedList(saved);
    renderSavedList();
}

function clearSavedList() {
    if (!confirm('Remove all saved properties?')) return;
    setSavedList([]);
    renderSavedList();
}

function toggleSavedSelectAll() {
    var allCB = document.getElementById('savedSelectAll');
    document.querySelectorAll('.saved-select').forEach(function(cb) { cb.checked = allCB.checked; });
}

function combineContiguousParcels() {
    var checks = document.querySelectorAll('.saved-select:checked');
    if (checks.length < 2 || checks.length > 4) {
        alert('Select 2-4 contiguous parcels to combine.');
        return;
    }
    var saved = getSavedList();
    var selected = [];
    checks.forEach(function(cb) {
        var idx = parseInt(cb.getAttribute('data-idx'));
        if (saved[idx]) selected.push(saved[idx]);
    });

    // Create combined "super parcel"
    var combinedLotSize = selected.reduce(function(s, p) { return s + (p.lotSizeSqFt || 0); }, 0);
    var combinedLandVal = selected.reduce(function(s, p) { return s + (p.landVal || 0); }, 0);
    var combinedImpVal = selected.reduce(function(s, p) { return s + (p.impVal || 0); }, 0);
    var avgLat = selected.reduce(function(s, p) { return s + (p.lat || 0); }, 0) / selected.length;
    var avgLon = selected.reduce(function(s, p) { return s + (p.lon || 0); }, 0) / selected.length;
    var addresses = selected.map(function(p) { return p.address || p.apn; });

    // Use the best allowances from any of the parcels
    var bestFar = 0, bestHeight = 0, bestDensity = 0;
    selected.forEach(function(p) {
        var a = p.allowances || {};
        if ((a.far || 0) > bestFar) bestFar = a.far;
        if ((a.height || 0) > bestHeight) bestHeight = a.height;
        if ((a.density || 0) > bestDensity) bestDensity = a.density;
    });

    var combinedParcel = {
        address: 'COMBINED: ' + addresses.join(' + '),
        apn: selected.map(function(p) { return p.apn; }).join('+'),
        lotSizeSqFt: combinedLotSize,
        useType: selected[0].useType || 'Commercial',
        yearBuilt: 0,
        landVal: combinedLandVal,
        impVal: combinedImpVal,
        impRatio: combinedLandVal > 0 ? combinedImpVal / combinedLandVal : 0,
        lat: avgLat,
        lon: avgLon,
        zone: selected[0].zone || 'inner',
        allowances: { far: bestFar || 3.0, height: bestHeight || 55, density: bestDensity || 70, parking: '0.5/unit' },
        isCombined: true,
        componentParcels: selected,
    };

    // Add combined parcel to saved list and open deep analysis
    var newSaved = [combinedParcel].concat(saved);
    var origSaved = localStorage.getItem('sb79_saved_list');
    localStorage.setItem('sb79_saved_list', JSON.stringify(newSaved));
    openDeepAnalysis();
    // Restore original
    if (origSaved) localStorage.setItem('sb79_saved_list', origSaved);
    else localStorage.removeItem('sb79_saved_list');
}

function exportSavedCSV() {
    const saved = getSavedList();
    if (saved.length === 0) return;
    const headers = ['Address', 'APN', 'Lot Size (sf)', 'Use Type', 'Year Built', 'Land Value', 'Imp Value', 'Imp/Land Ratio', 'SB79 Zone', 'Max Height (ft)', 'Max Density (du/ac)', 'Max FAR', 'Zillow URL', 'Assessor URL', 'Latitude', 'Longitude'];
    const rows = saved.map(r => {
        const a = r.allowances || {};
        const enc = encodeURIComponent(r.address || '');
        const apnClean = (r.apn || '').replace(/[^0-9]/g, '');
        return [
            `"${(r.address || '').replace(/"/g, '""')}"`,
            r.apn, r.lotSizeSqFt, r.useType, r.yearBuilt || '',
            r.landVal, r.impVal, r.impRatio < 100 ? r.impRatio.toFixed(3) : '',
            r.zone, a.height || '', a.density || '', a.far || '',
            `https://www.zillow.com/homes/${enc}_rb/`,
            `https://portal.assessor.lacounty.gov/parceldetail/${apnClean}`,
            r.lat, r.lon,
        ].join(',');
    });
    const csv = [headers.join(','), ...rows].join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `sb79-saved-list-${new Date().toISOString().slice(0, 10)}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// Load saved list on page init
document.addEventListener('DOMContentLoaded', () => { renderSavedList(); });


// ============================================================
//  DEEP DEVELOPABILITY ANALYSIS â€” SKILLS 23-32
// ============================================================

// --- SKILL 23 DATA: Entitlement Pathway ---

const LA_ENTITLEMENT_FEES = {
    zone_change:       { fee: 16578, timeline: 12, hearing: 'City Planning Commission + City Council' },
    cup:               { fee: 14549, timeline: 8,  hearing: 'Zoning Administrator or Area Planning Commission' },
    variance:          { fee: 12083, timeline: 6,  hearing: 'Zoning Administrator' },
    site_plan_review:  { fee: 10604, timeline: 4,  hearing: 'Director of Planning' },
    tract_map:         { fee: 19832, timeline: 6,  hearing: 'Advisory Agency' },
    parcel_map:        { fee: 9247,  timeline: 4,  hearing: 'Advisory Agency' },
    coastal_permit:    { fee: 13230, timeline: 8,  hearing: 'Area Planning Commission' },
    specific_plan:     { fee: 8930,  timeline: 4,  hearing: 'Director of Planning' },
    env_review_ce:     { fee: 0,     timeline: 0,  hearing: 'Staff' },
    env_review_mnd:    { fee: 7500,  timeline: 4,  hearing: 'Staff' },
    env_review_eir:    { fee: 85000, timeline: 14, hearing: 'Lead Agency' },
    building_permit:   { fee: 0,     timeline: 2,  hearing: 'None (over-the-counter)' },
};

const CEQA_THRESHOLDS = {
    categorical_exemption: { maxUnits: 32, maxSF: 100000, conditions: 'No significant environmental impact; urban infill; no hazards' },
    mnd: { maxUnits: 200, maxSF: 500000, conditions: 'Mitigable impacts; standard conditions of approval' },
    eir: { minUnits: 200, minSF: 500000, conditions: 'Significant unmitigable impacts; large-scale projects; sensitive sites' },
};

const SPECIFIC_PLAN_AREAS = [
    'Vermont/Western SNAP', 'Hollywood Community Plan', 'Cornfield Arroyo Seco',
    'Warner Center 2035', 'Downtown LA (DTLA 2040)', 'West Adams-Baldwin Hills-Leimert',
    'Boyle Heights Community Plan', 'Exposition/University Park',
];

// Approvals needed by zone score (0 = not permitted, 0.5 = conditional, 1.0 = by-right)
function getRequiredApprovals(zoneScore, useId, inp, effects) {
    const approvals = [];
    const isMinisterial = effects && effects.legalOverride;

    if (zoneScore === 0 && !isMinisterial) {
        approvals.push({ id: 'zone_change', name: 'Zone Change / General Plan Amendment', required: true });
    }
    if (zoneScore === 0.5 && !isMinisterial) {
        approvals.push({ id: 'cup', name: 'Conditional Use Permit (CUP)', required: true });
    }
    if (!isMinisterial && ['multifamily_mid', 'multifamily_high', 'mixeduse', 'hotel'].includes(useId) && inp.parcelSize > 15000) {
        approvals.push({ id: 'site_plan_review', name: 'Site Plan Review', required: true });
    }
    if (inp.constCoastal) {
        approvals.push({ id: 'coastal_permit', name: 'Coastal Development Permit', required: true });
    }
    if (['multifamily_mid', 'multifamily_high'].includes(useId) && inp.parcelSize > 20000 && !isMinisterial) {
        approvals.push({ id: 'tract_map', name: 'Tentative Tract Map', required: zoneScore < 1.0 });
    }
    approvals.push({ id: 'building_permit', name: 'Building Permit', required: true });
    return approvals;
}

function getCEQAPathway(useId, inp, effects) {
    const params = BUILDING_PARAMS[useId];
    const baseFAR = FAR_TYPICAL[useId] || 1.0;
    let far = baseFAR;
    if (effects) {
        far = baseFAR * (1 + effects.densityBonus);
        if (effects.minFAR > 0) far = Math.max(far, effects.minFAR);
    }
    const gsf = Math.round(inp.parcelSize * far);
    const nsf = Math.round(gsf * (params ? params.eff : 0.82));
    const units = params && params.unitSF ? Math.max(1, Math.floor(nsf / params.unitSF)) : 0;
    const isMinisterial = effects && effects.legalOverride;

    if (isMinisterial) {
        return { type: 'exempt', name: 'CEQA Exempt (Ministerial)', cost: 0, months: 0, detail: 'Ministerial approvals under state housing legislation are exempt from CEQA review.' };
    }
    if (units <= CEQA_THRESHOLDS.categorical_exemption.maxUnits && gsf <= CEQA_THRESHOLDS.categorical_exemption.maxSF && !inp.constHistoric && !inp.constFault) {
        return { type: 'ce', name: 'Categorical Exemption (CE)', cost: 0, months: 1, detail: `Project of ${units > 0 ? units + ' units' : gsf.toLocaleString() + ' SF'} qualifies for Class 32 Urban Infill CE.` };
    }
    if (units <= CEQA_THRESHOLDS.mnd.maxUnits && gsf <= CEQA_THRESHOLDS.mnd.maxSF) {
        return { type: 'mnd', name: 'Mitigated Negative Declaration (MND)', cost: 35000, months: 4, detail: 'Project requires environmental analysis with conditions of approval for identified impacts.' };
    }
    return { type: 'eir', name: 'Environmental Impact Report (EIR)', cost: 150000, months: 14, detail: 'Large-scale project requires full environmental review under CEQA.' };
}

function analyzeEntitlementPath(useId, inp, effects) {
    const zoneRow = ZONING_MATRIX[inp.zoning];
    const zoneScore = zoneRow ? (zoneRow[useId] || 0) : 0;
    const isMinisterial = effects && effects.legalOverride;
    const approvals = getRequiredApprovals(zoneScore, useId, inp, effects);
    const ceqa = getCEQAPathway(useId, inp, effects);

    // Calculate total entitlement cost & timeline
    let totalCost = 0;
    let totalMonths = 0;
    const steps = [];

    // Legal/consulting costs
    const legalCost = isMinisterial ? 5000 : (zoneScore < 1.0 ? 45000 : 15000);
    const consultingCost = ceqa.type === 'eir' ? 50000 : (ceqa.type === 'mnd' ? 20000 : 5000);

    for (const a of approvals) {
        const fee = LA_ENTITLEMENT_FEES[a.id] || { fee: 0, timeline: 0, hearing: 'N/A' };
        steps.push({
            name: a.name,
            cost: fee.fee,
            months: fee.timeline,
            hearing: fee.hearing,
            color: a.id === 'building_permit' ? '#38a169' : (a.id === 'zone_change' ? '#c53030' : '#805ad5'),
        });
        totalCost += fee.fee;
        totalMonths += fee.timeline;
    }

    // CEQA step
    if (ceqa.months > 0) {
        steps.splice(steps.length - 1, 0, {
            name: ceqa.name,
            cost: ceqa.cost,
            months: ceqa.months,
            hearing: 'Environmental Review',
            color: ceqa.type === 'eir' ? '#c53030' : '#ecc94b',
        });
        totalCost += ceqa.cost;
        totalMonths += ceqa.months;
    }

    totalCost += legalCost + consultingCost;

    return {
        pathway: isMinisterial ? 'Ministerial (By-Right)' : (zoneScore >= 1.0 ? 'Administrative' : 'Discretionary'),
        isMinisterial,
        steps,
        ceqa,
        totalCost,
        totalMonths: Math.max(totalMonths, 2), // minimum 2 months for building permit
        legalCost,
        consultingCost,
        approvals,
        legislationBenefits: effects && effects.legalOverride ? 'State housing legislation enables ministerial processing, bypassing CEQA and discretionary review.' : null,
    };
}

// --- SKILL 24 DATA: Sensitivity Analysis ---

var sensScenarioDefaults = {
    bearCostPct: 15, bearRentPct: -15, bearCapBps: 50,
    bullCostPct: -10, bullRentPct: 15, bullCapBps: -25
};
var sensScenario = {
    bearCostPct: 15, bearRentPct: -15, bearCapBps: 50,
    bullCostPct: -10, bullRentPct: 15, bullCapBps: -25
};

function runSensitivityAnalysis(useId, inp, assumptions, effects, scenarioParams) {
    const base = computeFromAssumptions(useId, inp, assumptions, effects);
    const tl = TIMELINE_MONTHS[useId] || { entitlement: 6, design: 4, permits: 3, construction: 18, leaseup: 6 };
    const totalMo = tl.entitlement + tl.design + tl.permits + tl.construction + tl.leaseup;
    const baseIRR = approxIRR(base.devMargin, totalMo);

    // Define sensitivity variables â€” cost/rent/cap ranges adapt to Bear/Bull slider values
    var sp = scenarioParams || sensScenario;
    var costSwing = Math.max(Math.abs(sp.bearCostPct), Math.abs(sp.bullCostPct)) / 100 || 0.15;
    var rentSwing = Math.max(Math.abs(sp.bearRentPct), Math.abs(sp.bullRentPct)) / 100 || 0.20;
    var capSwing = Math.max(Math.abs(sp.bearCapBps), Math.abs(sp.bullCapBps)) / 100 || 0.75;
    const variables = [
        { key: 'buildCostPSF', label: 'Construction Cost', low: -costSwing, high: costSwing, unit: '$/SF' },
        { key: 'revenuePSF', label: 'Market Rents', low: -rentSwing, high: rentSwing, unit: '$/SF/yr' },
        { key: 'capRatePct', label: 'Cap Rate', lowAbs: -capSwing, highAbs: capSwing, unit: '%' },
        { key: 'landValuePSF', label: 'Land Cost', low: -0.20, high: 0.20, unit: '$/SF' },
        { key: 'parkingSpaces', label: 'Parking Spaces', low: -0.30, high: 0.30, unit: 'spaces' },
    ];

    // Tornado analysis â€” one variable at a time
    const tornado = [];
    for (const v of variables) {
        const lowAdj = { ...assumptions };
        const highAdj = { ...assumptions };
        if (v.lowAbs !== undefined) {
            lowAdj[v.key] = assumptions[v.key] + v.lowAbs;
            highAdj[v.key] = assumptions[v.key] + v.highAbs;
        } else {
            lowAdj[v.key] = Math.round(assumptions[v.key] * (1 + v.low));
            highAdj[v.key] = Math.round(assumptions[v.key] * (1 + v.high));
        }
        const lowResult = computeFromAssumptions(useId, inp, lowAdj, effects);
        const highResult = computeFromAssumptions(useId, inp, highAdj, effects);
        // For cost variables, "low" means cheaper (higher margin), so swap
        const isCostVar = ['buildCostPSF', 'landValuePSF', 'parkingSpaces'].includes(v.key);
        tornado.push({
            label: v.label,
            lowMargin: (isCostVar ? highResult : lowResult).devMargin,
            highMargin: (isCostVar ? lowResult : highResult).devMargin,
            baseMargin: base.devMargin,
        });
    }
    tornado.sort((a, b) => (b.highMargin - b.lowMargin) - (a.highMargin - a.lowMargin));

    // Bear / Base / Bull scenarios (use custom scenario params if provided)
    var sp = scenarioParams || sensScenario;
    const bearAssumptions = {
        ...assumptions,
        buildCostPSF: Math.round(assumptions.buildCostPSF * (1 + sp.bearCostPct / 100)),
        revenuePSF: Math.round(assumptions.revenuePSF * (1 + sp.bearRentPct / 100)),
        capRatePct: parseFloat((assumptions.capRatePct + sp.bearCapBps / 100).toFixed(2)),
    };
    const bullAssumptions = {
        ...assumptions,
        buildCostPSF: Math.round(assumptions.buildCostPSF * (1 + sp.bullCostPct / 100)),
        revenuePSF: Math.round(assumptions.revenuePSF * (1 + sp.bullRentPct / 100)),
        capRatePct: parseFloat((assumptions.capRatePct + sp.bullCapBps / 100).toFixed(2)),
    };

    const bear = computeFromAssumptions(useId, inp, bearAssumptions, effects);
    const bull = computeFromAssumptions(useId, inp, bullAssumptions, effects);
    const bearIRR = approxIRR(bear.devMargin, totalMo);
    const bullIRR = approxIRR(bull.devMargin, totalMo);

    // Breakeven analysis
    // How much can costs rise before devMargin goes to 0?
    function findBreakeven(field, direction) {
        let pct = 0;
        const step = direction > 0 ? 0.01 : -0.01;
        for (let i = 0; i < 100; i++) {
            pct += step;
            const adj = { ...assumptions };
            adj[field] = Math.round(assumptions[field] * (1 + pct));
            const result = computeFromAssumptions(useId, inp, adj, effects);
            if (result.devMargin <= 0) return Math.abs(pct);
        }
        return 1.0; // more than 100% cushion
    }
    const costBreakeven = findBreakeven('buildCostPSF', 1);
    const rentBreakeven = findBreakeven('revenuePSF', -1);
    const landBreakeven = findBreakeven('landValuePSF', 1);

    // Heat map: dev margin across rent x cost matrix
    const rentSteps = [-0.15, -0.10, -0.05, 0, 0.05, 0.10, 0.15];
    const costSteps = [-0.15, -0.10, -0.05, 0, 0.05, 0.10, 0.15];
    const heatmap = [];
    for (const cs of costSteps) {
        const row = [];
        for (const rs of rentSteps) {
            const adj = { ...assumptions };
            adj.buildCostPSF = Math.round(assumptions.buildCostPSF * (1 + cs));
            adj.revenuePSF = Math.round(assumptions.revenuePSF * (1 + rs));
            const r = computeFromAssumptions(useId, inp, adj, effects);
            row.push(r.devMargin);
        }
        heatmap.push(row);
    }

    return {
        base, bear, bull,
        baseIRR, bearIRR, bullIRR,
        tornado,
        costBreakeven, rentBreakeven, landBreakeven,
        heatmap, rentSteps, costSteps,
        totalMo,
    };
}

// --- SKILL 27 DATA: Affordable Housing Compliance ---

const LA_AMI_LIMITS_2025 = {
    // 2025 LA County AMI for family of 4: ~$91,100 (HUD)
    ami: 91100,
    veryLow:  { pct: 0.50, ami_1br: 1139, ami_2br: 1367, ami_studio: 1025, label: 'Very Low Income (50% AMI)' },
    low:      { pct: 0.80, ami_1br: 1823, ami_2br: 2187, ami_studio: 1640, label: 'Low Income (80% AMI)' },
    moderate: { pct: 1.20, ami_1br: 2735, ami_2br: 3281, ami_studio: 2460, label: 'Moderate Income (120% AMI)' },
};

const INCLUSIONARY_REQS = {
    // LA Measure JJJ / TOC program set-asides
    base: { vli: 0.08, low: 0.11, moderate: 0.20 },
    // Density bonus thresholds (AB 2345)
    ab2345: {
        vli_5:  { setAside: 0.05, bonus: 0.20, label: '5% VLI â†’ 20% bonus' },
        vli_11: { setAside: 0.11, bonus: 0.35, label: '11% VLI â†’ 35% bonus' },
        vli_15: { setAside: 0.15, bonus: 0.50, label: '15% VLI â†’ 50% bonus' },
        low_10: { setAside: 0.10, bonus: 0.20, label: '10% Low â†’ 20% bonus' },
        low_20: { setAside: 0.20, bonus: 0.35, label: '20% Low â†’ 35% bonus' },
        low_24: { setAside: 0.24, bonus: 0.50, label: '24% Low â†’ 50% bonus' },
        mod_15: { setAside: 0.15, bonus: 0.20, label: '15% Moderate â†’ 20% bonus (condo)' },
        mod_40: { setAside: 0.40, bonus: 0.50, label: '40% Moderate â†’ 50% bonus (condo)' },
    },
};

const IN_LIEU_FEES = {
    // LA in-lieu fee per unit (approx.)
    perUnit: 136000,
    threshold: 10, // projects with 10+ units
};

const LIHTC_PARAMS = {
    pct4: { creditRate: 0.04, equityFactor: 0.85, name: '4% LIHTC (As-of-Right)', minAffordable: 0.20 },
    pct9: { creditRate: 0.09, equityFactor: 0.90, name: '9% LIHTC (Competitive)', minAffordable: 1.0 },
};

// Welfare Exemption â€” California RTC Section 214(g)
// Nonprofit GP structure allows proportional property tax exemption for units at â‰¤80% AMI
const WELFARE_EXEMPTION = {
    maxAMIForExemption: 0.80,         // 80% AMI ceiling for qualifying units
    overIncomeCeiling: 1.40,          // 140% AMI â€” above this, unit loses exemption (AB 1193)
    defaultTaxRate: 0.0125,           // 1.25% blended LA County effective rate
    baseLevyRate: 0.0100,             // 1.00% Prop 13 base
    filingDeadline: 'February 15',
    filingForm: 'BOE-267-L',
    compliancePeriod: 55,             // years (CA LIHTC requirement)
    nonprofitGPFee: 15000,            // typical annual asset management fee to nonprofit GP
    sources: {
        boe_welfare: { label: 'BOE Welfare Exemption (Low-Income Housing)', url: 'https://boe.ca.gov/proptaxes/welfarelowinc.htm' },
        ctcac_limits: { label: 'CTCAC Rent & Income Limits', url: 'https://www.treasurer.ca.gov/ctcac/compliance/limits.asp' },
        hcd_income: { label: 'HCD State Income Limits 2025', url: 'https://www.hcd.ca.gov/funding/income-limits' },
        lahd_schedules: { label: 'LAHD Rent/Income Schedules (Sch. 6 & 9)', url: 'https://housing.lacity.gov/partners/land-use-rent-income-schedules' },
        la_tra: { label: 'LA County Tax Rate Area Lookup', url: 'https://auditor.lacounty.gov/tax-rate-area-lookup/' },
    },
};

function calculateAffordableCompliance(useId, inp, effects, computed) {
    if (!computed || !computed.units) return null;
    const totalUnits = computed.units;
    const params = BUILDING_PARAMS[useId];
    if (!params || !params.unitSF) return null;

    const rentMult = NEIGHBORHOOD_RENT_MULT[inp.neighborhood] || 1.0;
    const marketRent1BR = Math.round((REVENUE_PSF[useId] || 52) * params.unitSF / 12 * rentMult);
    const marketRentStudio = Math.round(marketRent1BR * 0.78);
    const marketRent2BR = Math.round(marketRent1BR * 1.22);

    // Income tiers with max rents
    const tiers = [
        {
            key: 'veryLow', label: LA_AMI_LIMITS_2025.veryLow.label,
            maxRent1BR: LA_AMI_LIMITS_2025.veryLow.ami_1br,
            maxRentStudio: LA_AMI_LIMITS_2025.veryLow.ami_studio,
            maxRent2BR: LA_AMI_LIMITS_2025.veryLow.ami_2br,
            setAside: INCLUSIONARY_REQS.base.vli,
        },
        {
            key: 'low', label: LA_AMI_LIMITS_2025.low.label,
            maxRent1BR: LA_AMI_LIMITS_2025.low.ami_1br,
            maxRentStudio: LA_AMI_LIMITS_2025.low.ami_studio,
            maxRent2BR: LA_AMI_LIMITS_2025.low.ami_2br,
            setAside: INCLUSIONARY_REQS.base.low,
        },
        {
            key: 'moderate', label: LA_AMI_LIMITS_2025.moderate.label,
            maxRent1BR: LA_AMI_LIMITS_2025.moderate.ami_1br,
            maxRentStudio: LA_AMI_LIMITS_2025.moderate.ami_studio,
            maxRent2BR: LA_AMI_LIMITS_2025.moderate.ami_2br,
            setAside: INCLUSIONARY_REQS.base.moderate,
        },
    ];

    // Revenue differential per unit for each tier
    const tierAnalysis = tiers.map(t => {
        const affordableUnits = Math.ceil(totalUnits * t.setAside);
        const monthlyLoss = (marketRent1BR - t.maxRent1BR) * affordableUnits;
        const annualLoss = monthlyLoss * 12;
        return {
            ...t,
            affordableUnits,
            marketRent: marketRent1BR,
            monthlyLoss,
            annualLoss,
            revReduction: totalUnits > 0 ? annualLoss / (marketRent1BR * 12 * totalUnits) : 0,
        };
    });

    // Density bonus optimization â€” which set-aside + bonus maximizes value?
    const bonusStrategies = [];
    for (const [key, strat] of Object.entries(INCLUSIONARY_REQS.ab2345)) {
        const isVLI = key.startsWith('vli');
        const isLow = key.startsWith('low');
        const tier = isVLI ? tiers[0] : (isLow ? tiers[1] : tiers[2]);
        const affordUnits = Math.ceil(totalUnits * strat.setAside);
        const bonusUnits = Math.round(totalUnits * strat.bonus);
        const totalWithBonus = totalUnits + bonusUnits;
        const monthlyRevLoss = (marketRent1BR - tier.maxRent1BR) * affordUnits;
        const monthlyRevGain = marketRent1BR * bonusUnits;
        const netMonthlyGain = monthlyRevGain - monthlyRevLoss;
        bonusStrategies.push({
            key, label: strat.label,
            setAside: strat.setAside,
            bonus: strat.bonus,
            affordUnits,
            bonusUnits,
            totalWithBonus,
            monthlyRevLoss,
            monthlyRevGain,
            netMonthlyGain,
            netAnnualGain: netMonthlyGain * 12,
        });
    }
    bonusStrategies.sort((a, b) => b.netAnnualGain - a.netAnnualGain);

    // In-lieu fee comparison
    const inLieuTotal = totalUnits >= IN_LIEU_FEES.threshold ? Math.ceil(totalUnits * INCLUSIONARY_REQS.base.low) * IN_LIEU_FEES.perUnit : 0;
    const buildLowUnits = Math.ceil(totalUnits * INCLUSIONARY_REQS.base.low);
    const buildAnnualLoss = (marketRent1BR - LA_AMI_LIMITS_2025.low.ami_1br) * buildLowUnits * 12;
    const buildNPVLoss = buildAnnualLoss * 15; // rough 15-year NPV

    // LIHTC feasibility
    const totalDevCost = computed.totalDev;
    const eligible4pct = totalUnits >= 10 && totalDevCost > 0;
    const credit4pct = eligible4pct ? Math.round(totalDevCost * 0.60 * LIHTC_PARAMS.pct4.creditRate * 10 * LIHTC_PARAMS.pct4.equityFactor) : 0;

    // Welfare Exemption calculation â€” Nonprofit GP structure
    // Qualifying units: all units restricted at â‰¤80% AMI
    // Using low-income set-aside as baseline qualifying units
    const welfareQualifyingUnits = buildLowUnits; // units at â‰¤80% AMI from inclusionary requirement
    const assessedValue = totalDevCost; // conservative: use total dev cost as assessed value
    const taxRate = WELFARE_EXEMPTION.defaultTaxRate;
    const exemptionPct = totalUnits > 0 ? welfareQualifyingUnits / totalUnits : 0;
    const grossAnnualTax = assessedValue * taxRate;
    const annualTaxSavings = grossAnnualTax * exemptionPct;
    const netAnnualTax = grossAnnualTax - annualTaxSavings;
    const npvTaxSavings15yr = annualTaxSavings * 15; // simplified 15-year NPV
    // Net benefit = tax savings minus nonprofit GP fee
    const nonprofitGPCost = WELFARE_EXEMPTION.nonprofitGPFee;
    const netAnnualBenefit = annualTaxSavings - nonprofitGPCost;

    // Scenario analysis: what if developer maximizes affordable units for max exemption?
    const welfareScenarios = [
        { label: 'Base Inclusionary (11% Low)', qualUnits: buildLowUnits, pct: INCLUSIONARY_REQS.base.low },
        { label: '15% VLI (Density Bonus)', qualUnits: Math.ceil(totalUnits * 0.15), pct: 0.15 },
        { label: '20% Low (Density Bonus)', qualUnits: Math.ceil(totalUnits * 0.20), pct: 0.20 },
        { label: '50% at 80% AMI', qualUnits: Math.ceil(totalUnits * 0.50), pct: 0.50 },
        { label: '80% at 80% AMI', qualUnits: Math.ceil(totalUnits * 0.80), pct: 0.80 },
        { label: '100% Affordable', qualUnits: totalUnits, pct: 1.00 },
    ].map(s => {
        const exemPct = s.qualUnits / totalUnits;
        const savings = grossAnnualTax * exemPct;
        const lostRent = (marketRent1BR - LA_AMI_LIMITS_2025.low.ami_1br) * s.qualUnits * 12;
        const netBenefit = savings - nonprofitGPCost - lostRent;
        return { ...s, exemPct, annualSavings: savings, lostRent, netBenefit };
    });

    return {
        totalUnits,
        marketRent1BR, marketRentStudio, marketRent2BR,
        tierAnalysis,
        bonusStrategies,
        bestStrategy: bonusStrategies[0],
        inLieu: { total: inLieuTotal, perUnit: IN_LIEU_FEES.perUnit, threshold: IN_LIEU_FEES.threshold },
        buildVsBuy: { inLieuTotal, buildNPVLoss, recommendation: inLieuTotal < buildNPVLoss ? 'Pay in-lieu fee' : 'Build affordable units' },
        lihtc: { eligible4pct, credit4pct },
        welfareExemption: {
            qualifyingUnits: welfareQualifyingUnits,
            assessedValue,
            taxRate,
            exemptionPct,
            grossAnnualTax,
            annualTaxSavings,
            netAnnualTax,
            npvTaxSavings15yr,
            nonprofitGPCost,
            netAnnualBenefit,
            scenarios: welfareScenarios,
        },
    };
}


// ============================================================
//  DEEP ANALYSIS â€” UI FUNCTIONS
// ============================================================

let deepAnalysisState = null;
let deepAnalysisSelectedProps = []; // boolean array: which saved props are selected for Exec tab

function openDeepAnalysis() {
    const saved = getSavedList();
    if (saved.length === 0) {
        alert('Save at least one property from the Opportunity Finder to run a Deep Analysis.');
        return;
    }

    // Take first saved property for analysis
    const prop = saved[0];

    // Build a synthetic inp from saved property data
    const inp = buildInpFromSaved(prop);
    const bestUse = determineBestUse(inp);
    const legislation = getApplicableLegislation(bestUse, inp);
    const effects = stackLegislationEffects(legislation);
    const assumptions = getDefaultAssumptions(bestUse, inp, effects);
    const computed = computeFromAssumptions(bestUse, inp, assumptions, effects);

    deepAnalysisState = { prop, inp, bestUse, legislation, effects, assumptions, computed, saved, selectedPropertyIndex: 0 };

    // Initialize all properties as selected for Exec tab
    deepAnalysisSelectedProps = saved.map(function() { return true; });

    // Set title
    document.getElementById('deepModalTitle').textContent = `Deep Analysis: ${prop.address || prop.apn}`;

    // Build all tab panels
    renderDeepTabPanels();

    // Show modal
    document.getElementById('deepAnalysisModal').style.display = 'block';
    document.body.style.overflow = 'hidden';
    switchDeepTab(0);
}

function buildInpFromSaved(prop) {
    // Detect neighborhood from lat/lon
    let neighborhood = 'dtla';
    if (prop.lat && prop.lon) {
        let minDist = Infinity;
        for (const [key, c] of Object.entries(NEIGHBORHOOD_CENTROIDS)) {
            const d = Math.sqrt(Math.pow(prop.lat - c.lat, 2) + Math.pow(prop.lon - c.lon, 2));
            if (d < minDist) { minDist = d; neighborhood = key; }
        }
    }

    // Detect zoning from saved property zone / allowances
    let zoning = 'C2'; // default for SB79 opportunity properties
    if (prop.allowances && prop.allowances.far >= 4.0) zoning = 'TOD';
    else if (prop.zone === 'adjacent' || prop.zone === 'inner') zoning = 'TOD';

    // Detect transit proximity from SB79 zone
    let transit = 'moderate';
    if (prop.zone === 'adjacent') transit = 'adjacent';
    else if (prop.zone === 'inner') transit = 'near';
    else if (prop.zone === 'outer') transit = 'near';

    return {
        parcelSize: prop.lotSizeSqFt || 10000,
        frontage: Math.round(Math.sqrt(prop.lotSizeSqFt || 10000) * 0.8),
        zoning,
        neighborhood,
        siteCondition: prop.useType === 'Vacant' ? 'vacant' : 'demolition',
        topography: 'flat',
        cornerLot: false,
        transit,
        arterial: 'major',
        utilities: 'full',
        constFlood: false,
        constHillside: false,
        constHistoric: false,
        constFault: false,
        constCoastal: false,
        constParking: false,
    };
}

function determineBestUse(inp) {
    // Run quick scoring to find best use
    let bestId = 'multifamily_mid';
    let bestScore = 0;
    for (const use of LAND_USES) {
        const legislation = getApplicableLegislation(use.id, inp);
        const effects = stackLegislationEffects(legislation);
        const legal = scoreLegal(use.id, inp, effects);
        const physical = scorePhysical(use.id, inp);
        const financial = scoreFinancial(use.id, inp, effects);
        const productive = scoreProductive(use.id, inp, effects);
        const composite = (legal * 25 + physical * 25 + financial * 30 + productive * 20) / 100;
        if (composite > bestScore && legal > 0) {
            bestScore = composite;
            bestId = use.id;
        }
    }
    return bestId;
}

function renderDeepTabPanels(skipTab0) {
    const st = deepAnalysisState;
    if (!st) return;

    if (skipTab0) {
        // Persist any in-progress assumption edits before re-rendering
        snapshotDeepAssumptions();
        // Re-render only tabs 1+, preserving tab 0 (comparison dashboard)
        const container = document.getElementById('deepTabPanels');
        const panels = container.querySelectorAll('.deep-tab-panel');
        for (let i = panels.length - 1; i >= 1; i--) {
            panels[i].remove();
        }
        let html = '';
        // Due Diligence
        html += renderMarketCompsTab(st);
        html += renderEnvironmentalTab(st);
        html += renderEarthworkTab(st);
        html += renderInfrastructureTab(st);
        html += renderCommunityRiskTab(st);
        // Entitlements
        html += renderEntitlementTab(st);
        html += renderRHNATab(st);
        html += renderAffordableTab(st);
        html += renderDevAgreementTab(st);
        // Design
        html += renderGenerativeDesignTab(st);
        html += renderEnhancedSitePlanTab(st);
        html += renderUnitMixTab(st);
        html += renderParkingTab(st);
        html += renderConstructionTab(st);
        // Financial
        html += renderSensitivityTab(st);
        html += renderKPIDashboard(st);
        // Export (last)
        [renderPublicFinanceTab, renderTaxIncentivesTab, renderIncentiveMatrixTab, renderP3StructuringTab,
         renderInvestorModuleTab,
         renderDevTimelineTab, renderCashFlowModelTab, renderFiscalImpactTab, renderAssetStrategyTab,
         renderExportTab
        ].forEach(function(fn) {
            try { html += fn(st); } catch(e) {
                console.error('Error in tab render:', e);
                html += '<div class="deep-tab-panel"><div class="analysis-section"><p style="color:#c53030;">Error: ' + e.message + '</p></div></div>';
            }
        });
        container.insertAdjacentHTML('beforeend', html);
        return;
    }

    let html = '';

    // Tab 0: Executive Summary (with property selector if 2+ properties)
    if (st.saved && st.saved.length >= 2) {
        html += '<div class="deep-tab-panel active">';
        html += renderExecPropertySelector(st.saved);
        html += '<div id="execSummaryContent">';
        var selectedSaved = st.saved.filter(function(_, i) { return deepAnalysisSelectedProps[i]; });
        if (selectedSaved.length === 0) {
            html += '<div class="analysis-section" style="text-align:center;padding:40px;color:#718096;"><p>Select at least one property above to view the Executive Summary.</p></div>';
        } else if (selectedSaved.length === 1) {
            // Build a single-property st for the selected property
            var sp = selectedSaved[0];
            var spInp = buildInpFromSaved(sp);
            var spBestUse = determineBestUse(spInp);
            var spLeg = getApplicableLegislation(spBestUse, spInp);
            var spEff = stackLegislationEffects(spLeg);
            var spAss = getDefaultAssumptions(spBestUse, spInp, spEff);
            var spComp = computeFromAssumptions(spBestUse, spInp, spAss, spEff);
            var singleSt = { prop: sp, inp: spInp, bestUse: spBestUse, legislation: spLeg, effects: spEff, assumptions: spAss, computed: spComp };
            // renderExecSummaryTab wraps in deep-tab-panel, so we extract its inner content
            var execHtml = renderExecSummaryTab(singleSt);
            // Strip the outer deep-tab-panel wrapper since we already have one
            execHtml = execHtml.replace(/^<div class="deep-tab-panel[^"]*">/, '').replace(/<\/div>\s*$/, '');
            html += execHtml;
        } else {
            // Render comparison dashboard for selected subset
            var dashHtml = renderComparisonDashboard(selectedSaved);
            dashHtml = dashHtml.replace(/^<div class="deep-tab-panel[^"]*">/, '').replace(/<\/div>\s*$/, '');
            html += dashHtml;
        }
        html += '</div>'; // close execSummaryContent
        html += '</div>'; // close deep-tab-panel
    } else {
        html += renderExecSummaryTab(st);
    }

    // --- Due Diligence ---
    // Tab 1: Market Comps
    html += renderMarketCompsTab(st);
    // Tab 2: Environmental Constraints & Stormwater
    html += renderEnvironmentalTab(st);
    // Tab 3: Cut & Fill / Earthwork Analysis
    html += renderEarthworkTab(st);
    // Tab 4: Infrastructure & Utility Assessment
    html += renderInfrastructureTab(st);
    // Tab 5: Community & Political Risk
    html += renderCommunityRiskTab(st);

    // --- Entitlements ---
    // Tab 6: Entitlement Pathway
    html += renderEntitlementTab(st);
    // Tab 7: RHNA Compliance
    html += renderRHNATab(st);
    // Tab 8: Affordable Compliance
    html += renderAffordableTab(st);
    // Tab 9: Dev Agreement
    html += renderDevAgreementTab(st);

    // --- Design ---
    // Tab 10: Generative Design Engine
    html += renderGenerativeDesignTab(st);
    // Tab 11: Enhanced Site Plan & 3D Massing
    html += renderEnhancedSitePlanTab(st);
    // Tab 12: Unit Mix Optimizer
    html += renderUnitMixTab(st);
    // Tab 13: Parking Design & Layout Analyzer
    html += renderParkingTab(st);
    // Tab 14: Construction Type & Code Compliance
    html += renderConstructionTab(st);

    // --- Financial ---
    // Tab 15: Pro Forma & Scenarios
    html += renderSensitivityTab(st);
    // Tab 16: KPI Dashboard
    html += renderKPIDashboard(st);

    // Remaining tabs wrapped in try-catch
    var newTabRenderers = [
        // Financial (cont.)
        { name: 'Public Finance', fn: renderPublicFinanceTab },
        { name: 'Tax & Incentives', fn: renderTaxIncentivesTab },
        { name: 'Incentive Matrix', fn: renderIncentiveMatrixTab },
        { name: 'P3 Structuring', fn: renderP3StructuringTab },
        { name: 'Investor Module', fn: renderInvestorModuleTab },
        // Stabilized Asset
        { name: 'Dev Timeline', fn: renderDevTimelineTab },
        { name: '10-Yr Cash Flow', fn: renderCashFlowModelTab },
        { name: 'Fiscal Impact', fn: renderFiscalImpactTab },
        { name: 'Asset Strategy', fn: renderAssetStrategyTab },
        // Export
        { name: 'Export & Reports', fn: renderExportTab },
    ];
    newTabRenderers.forEach(function(t) {
        try {
            html += t.fn(st);
        } catch(e) {
            console.error('Error rendering ' + t.name + ':', e);
            html += '<div class="deep-tab-panel"><div class="analysis-section"><h3>' + t.name + '</h3><p style="color:#c53030;">Error rendering tab: ' + e.message + '</p></div></div>';
        }
    });

    document.getElementById('deepTabPanels').innerHTML = html;
}

function switchDeepTab(idx) {
    const panels = document.querySelectorAll('#deepTabPanels .deep-tab-panel');
    const btns = document.querySelectorAll('#deepTabs .deep-tab-btn');
    panels.forEach((p, i) => p.classList.toggle('active', i === idx));
    btns.forEach((b, i) => {
        if (!b.classList.contains('coming-soon')) {
            b.classList.toggle('active', i === idx);
        }
    });
}

function selectDeepProperty(index) {
    const st = deepAnalysisState;
    if (!st || !st.analyses || !st.analyses[index]) return;

    const a = st.analyses[index];
    const hasUnits = !!BUILDING_PARAMS[a.bestUse].unitSF;
    const legislation = getApplicableLegislation(a.bestUse, a.inp);
    const effects = stackLegislationEffects(legislation);
    const assumptions = getDefaultAssumptions(a.bestUse, a.inp, effects);
    const computed = computeFromAssumptions(a.bestUse, a.inp, assumptions, effects);

    // Update deepAnalysisState with selected property data (keep saved and analyses intact)
    st.prop = a.prop;
    st.inp = a.inp;
    st.bestUse = a.bestUse;
    st.legislation = legislation;
    st.effects = effects;
    st.assumptions = assumptions;
    st.computed = computed;
    st.selectedPropertyIndex = index;

    // Update modal title
    document.getElementById('deepModalTitle').textContent =
        'Deep Analysis: ' + (a.prop.address || a.prop.apn || 'Property ' + (index + 1));

    // Update selected card styling in comparison dashboard
    var cards = document.querySelectorAll('.deep-prop-card');
    cards.forEach(function(card) {
        var idx = parseInt(card.getAttribute('data-propidx'));
        if (idx === index) {
            card.style.border = '2px solid var(--primary)';
            card.style.background = 'rgba(49,130,206,0.06)';
            card.style.boxShadow = '0 0 0 3px rgba(49,130,206,0.15)';
            card.style.cursor = '';
        } else {
            card.style.border = '';
            card.style.background = '';
            card.style.boxShadow = '';
            card.style.cursor = 'pointer';
        }
        // Update RANKED/SELECTED text
        var rankDiv = card.querySelector('div:first-child');
        if (rankDiv && rankDiv.style.fontSize === '0.72rem') {
            var rankNum = idx + 1;
            var rc = ['#b8860b', '#6a6a6a', '#8b4513', '#4a5568'][Math.min(idx, 3)];
            rankDiv.innerHTML = '#' + rankNum + ' RANKED' + (idx === index ? ' &bull; SELECTED' : '');
        }
    });

    // Re-render tabs 1â€“16 only (preserve comparison dashboard at tab 0)
    renderDeepTabPanels(true);

    // Re-apply the current active tab visibility
    var activeBtn = document.querySelector('#deepTabs .deep-tab-btn.active');
    if (activeBtn) {
        var activeIdx = Array.from(document.querySelectorAll('#deepTabs .deep-tab-btn')).indexOf(activeBtn);
        if (activeIdx >= 0) switchDeepTab(activeIdx);
    }
}

function closeDeepAnalysis() {
    document.getElementById('deepAnalysisModal').style.display = 'none';
    document.body.style.overflow = '';
}

function printDeepAnalysis() {
    window.print();
}


// ============================================================
//  DEEP ANALYSIS â€” RENDER FUNCTIONS
// ============================================================

function renderExecSummaryTab(st) {
    const { prop, inp, bestUse, computed, effects, legislation } = st;
    const use = LAND_USES.find(u => u.id === bestUse);
    const tl = TIMELINE_MONTHS[bestUse] || { entitlement: 6, design: 4, permits: 3, construction: 18, leaseup: 6 };
    const totalMo = tl.entitlement + tl.design + tl.permits + tl.construction + tl.leaseup;
    const irr = approxIRR(computed.devMargin, totalMo);
    const ease = computeEaseOfExecution(bestUse, inp, effects, scoreLegal(bestUse, inp, effects) * 100);
    const risk = computeRiskLevel(bestUse, inp, scoreLegal(bestUse, inp, effects), scorePhysical(bestUse, inp));
    const entitlement = analyzeEntitlementPath(bestUse, inp, effects);
    const neighborhoodName = Object.keys(NEIGHBORHOOD_CENTROIDS).find(k => k === inp.neighborhood) || inp.neighborhood;

    const marginClass = computed.devMargin >= 0.20 ? 'positive' : computed.devMargin >= 0.08 ? 'caution' : 'negative';
    const irrClass = irr >= 0.10 ? 'positive' : irr >= 0.06 ? 'caution' : 'negative';

    let html = `<div class="deep-tab-panel active">`;
    html += `<div class="analysis-section"><h3>Property Overview</h3>
        <div class="exec-summary-grid">
            <div class="exec-summary-card">
                <h4>Property</h4>
                <div style="font-size:0.88rem;"><strong>${prop.address || 'N/A'}</strong></div>
                <div class="exec-metric-sub">APN: ${prop.apn || 'N/A'} | ${(prop.lotSizeSqFt || 0).toLocaleString()} SF | ${neighborhoodName}</div>
                <div class="exec-metric-sub" style="margin-top:0.5rem;">SB 79 Zone: <strong>${(prop.zone || 'N/A').charAt(0).toUpperCase() + (prop.zone || '').slice(1)}</strong> | Tier ${prop.tier || 'N/A'}</div>
            </div>
            <div class="exec-summary-card">
                <h4>Recommended Use</h4>
                <div class="exec-metric-lg">${use ? use.icon : ''} ${use ? use.name : bestUse}</div>
                <div class="exec-metric-sub">${RATIONALE[bestUse] || ''}</div>
            </div>
        </div></div>`;

    html += `<div class="analysis-section"><h3>Key Financial Metrics</h3>
        <div class="exec-summary-grid">
            <div class="exec-summary-card">
                <h4>Total Development Cost</h4>
                <div class="exec-metric-lg">${formatCompactDollars(computed.totalDev)}</div>
                <div class="exec-metric-sub">Land: ${formatCompactDollars(computed.landCost)} | Hard: ${formatCompactDollars(computed.totalHard)} | Soft: ${formatCompactDollars(computed.totalSoft)}</div>
            </div>
            <div class="exec-summary-card">
                <h4>Stabilized Value</h4>
                <div class="exec-metric-lg">${formatCompactDollars(computed.stabilizedValue)}</div>
                <div class="exec-metric-sub">NOI: ${formatCompactDollars(computed.noi)} | Cap Rate: ${(computed.capRate * 100).toFixed(1)}%</div>
            </div>
            <div class="exec-summary-card">
                <h4>Development Margin</h4>
                <div class="exec-metric-lg ${marginClass}">${(computed.devMargin * 100).toFixed(1)}%</div>
                <div class="exec-metric-sub">Profit: ${formatCompactDollars(computed.stabilizedValue - computed.totalDev)}</div>
            </div>
            <div class="exec-summary-card">
                <h4>Estimated IRR</h4>
                <div class="exec-metric-lg ${irrClass}">${(irr * 100).toFixed(1)}%</div>
                <div class="exec-metric-sub">Timeline: ${totalMo} months | YOC: ${(computed.yieldOnCost * 100).toFixed(1)}%</div>
            </div>
        </div></div>`;

    html += `<div class="analysis-section"><h3>Development Program</h3>
        ${renderProgramDisplay(computed)}</div>`;

    html += `<div class="analysis-section"><h3>Quick Assessment</h3>
        <div class="exec-summary-grid">
            <div class="exec-summary-card">
                <h4>Ease of Execution</h4>
                <div class="exec-metric-lg" style="color:${ease >= 60 ? '#276749' : ease >= 35 ? '#b7791f' : '#c53030'}">${ease}/100</div>
                <div class="ease-bar-bg" style="height:8px;margin-top:0.5rem;"><div class="ease-bar-fill" style="width:${ease}%;background:${ease >= 60 ? '#276749' : ease >= 35 ? '#b7791f' : '#c53030'}"></div></div>
            </div>
            <div class="exec-summary-card">
                <h4>Risk Level</h4>
                <span class="risk-badge" style="color:${risk.color};background:${risk.bg};font-size:1rem;padding:0.4rem 1rem;">
                    <span class="risk-dot" style="background:${risk.color}"></span> ${risk.level}
                </span>
            </div>
            <div class="exec-summary-card">
                <h4>Entitlement Pathway</h4>
                <span class="entitle-type-badge ${entitlement.isMinisterial ? 'entitle-ministerial' : 'entitle-discretionary'}">${entitlement.pathway}</span>
                <div class="exec-metric-sub">${entitlement.totalMonths} months | ${formatCompactDollars(entitlement.totalCost)} est. cost</div>
            </div>
            <div class="exec-summary-card">
                <h4>Applicable Legislation</h4>
                <div style="font-size:0.82rem;">${legislation.length > 0 ? legislation.map(b => `<span style="display:inline-block;background:#f0fff4;color:#276749;padding:0.15rem 0.5rem;border-radius:4px;margin:0.15rem;font-size:0.75rem;font-weight:600;">${b.name}</span>`).join('') : '<span style="color:var(--text-light);">None applicable</span>'}</div>
            </div>
        </div></div>`;

    // Recommendation
    const recText = computed.devMargin >= 0.20
        ? `This property shows <strong>strong development potential</strong> with a ${(computed.devMargin * 100).toFixed(0)}% development margin. The ${use ? use.name.toLowerCase() : 'recommended'} use type maximizes value given the site's zoning, location, and SB 79 eligibility. Recommend proceeding to due diligence.`
        : computed.devMargin >= 0.08
        ? `This property shows <strong>moderate development potential</strong> with a ${(computed.devMargin * 100).toFixed(0)}% margin. The project is feasible but sensitive to cost overruns and rent assumptions. Further market validation recommended.`
        : `This property shows <strong>marginal development potential</strong> at current assumptions. Consider alternative use types, value engineering, or waiting for more favorable market conditions.`;

    html += `<div class="exec-recommendation">
        <h4>Recommendation</h4>
        <p style="font-size:0.88rem;">${recText}</p>
    </div>`;

    html += `</div>`;
    return html;
}

function renderEntitlementTab(st) {
    const { bestUse, inp, effects } = st;
    const entitlement = analyzeEntitlementPath(bestUse, inp, effects);

    let html = `<div class="deep-tab-panel">`;
    html += `<div class="analysis-section"><h3>Entitlement Pathway Analysis</h3>`;

    // Pathway type badge
    html += `<div style="margin-bottom:1rem;">
        <span class="entitle-type-badge ${entitlement.isMinisterial ? 'entitle-ministerial' : 'entitle-discretionary'}">${entitlement.pathway}</span>
        <span class="entitle-type-badge ceqa-badge">${entitlement.ceqa.name}</span>
    </div>`;

    if (entitlement.legislationBenefits) {
        html += `<div style="background:#f0fff4;border:1px solid #9ae6b4;border-radius:8px;padding:0.75rem 1rem;margin-bottom:1rem;font-size:0.85rem;color:#276749;">
            <strong>Legislation Benefit:</strong> ${entitlement.legislationBenefits}
        </div>`;
    }

    // Flowchart
    html += `<h4 style="font-size:0.88rem;color:var(--primary);margin-bottom:0.75rem;">Approval Sequence</h4>`;
    html += `<div class="entitle-flow">`;
    entitlement.steps.forEach((step, i) => {
        if (i > 0) html += `<span class="entitle-arrow">&rarr;</span>`;
        html += `<div class="entitle-step" style="background:${step.color};color:white;">
            ${step.name}
            <span class="step-duration">${step.months} mo</span>
            <span class="step-cost">${step.cost > 0 ? fmt(step.cost) : 'Incl.'}</span>
        </div>`;
    });
    html += `</div>`;

    // Hearing details
    html += `<h4 style="font-size:0.88rem;color:var(--primary);margin:1.5rem 0 0.75rem;">Hearing & Review Details</h4>`;
    html += `<table class="entitle-cost-table"><thead><tr>
        <th>Approval</th><th>Hearing Body</th><th>Est. Timeline</th><th>Application Fee</th>
    </tr></thead><tbody>`;
    for (const step of entitlement.steps) {
        html += `<tr>
            <td>${step.name}</td>
            <td>${step.hearing}</td>
            <td>${step.months} months</td>
            <td>${step.cost > 0 ? fmt(step.cost) : 'â€”'}</td>
        </tr>`;
    }
    html += `</tbody></table>`;

    // Cost breakdown
    html += `<h4 style="font-size:0.88rem;color:var(--primary);margin:1.5rem 0 0.75rem;">Total Entitlement Cost Estimate</h4>`;
    html += `<table class="entitle-cost-table"><tbody>`;
    const appFees = entitlement.steps.reduce((sum, s) => sum + s.cost, 0);
    html += `<tr><td>Application Fees</td><td>${fmt(appFees)}</td></tr>`;
    html += `<tr><td>CEQA Compliance (${entitlement.ceqa.name})</td><td>${entitlement.ceqa.cost > 0 ? fmt(entitlement.ceqa.cost) : 'Exempt'}</td></tr>`;
    html += `<tr><td>Legal Counsel</td><td>${fmt(entitlement.legalCost)}</td></tr>`;
    html += `<tr><td>Planning/Entitlement Consulting</td><td>${fmt(entitlement.consultingCost)}</td></tr>`;
    html += `<tr class="total-row"><td><strong>Total Entitlement Budget</strong></td><td><strong>${fmt(entitlement.totalCost)}</strong></td></tr>`;
    html += `</tbody></table>`;

    // CEQA detail
    html += `<div style="background:#fffff0;border:1px solid #ecc94b;border-radius:8px;padding:0.75rem 1rem;margin-top:1rem;font-size:0.85rem;">
        <strong>CEQA Pathway: ${entitlement.ceqa.name}</strong><br>
        ${entitlement.ceqa.detail}
    </div>`;

    // Timeline summary
    html += `<div style="margin-top:1.5rem;">
        <div class="exec-summary-grid">
            <div class="exec-summary-card">
                <h4>Total Entitlement Timeline</h4>
                <div class="exec-metric-lg">${entitlement.totalMonths} months</div>
                <div class="exec-metric-sub">${entitlement.isMinisterial ? 'Streamlined ministerial processing' : 'Includes public hearings and environmental review'}</div>
            </div>
            <div class="exec-summary-card">
                <h4>Total Entitlement Cost</h4>
                <div class="exec-metric-lg">${formatCompactDollars(entitlement.totalCost)}</div>
                <div class="exec-metric-sub">${(entitlement.totalCost / st.computed.totalDev * 100).toFixed(1)}% of total development cost</div>
            </div>
        </div>
    </div>`;

    html += `</div></div>`;
    return html;
}

function buildSensitivityContent(st) {
    const { bestUse, inp, assumptions, effects, computed } = st;
    const sens = runSensitivityAnalysis(bestUse, inp, assumptions, effects, sensScenario);

    var html = '';

    // Pro Forma Summary (reuse existing budget)
    html += `<div class="analysis-section"><h3>Base Case Pro Forma</h3>`;
    html += renderBudgetTable(computed, inp);
    html += `</div>`;

    // Scenario Table
    var bearDesc = (sensScenario.bearCostPct >= 0 ? '+' : '') + sensScenario.bearCostPct + '% costs, ' + (sensScenario.bearRentPct >= 0 ? '+' : '') + sensScenario.bearRentPct + '% rents, ' + (sensScenario.bearCapBps >= 0 ? '+' : '') + sensScenario.bearCapBps + 'bps cap';
    var bullDesc = (sensScenario.bullCostPct >= 0 ? '+' : '') + sensScenario.bullCostPct + '% costs, ' + (sensScenario.bullRentPct >= 0 ? '+' : '') + sensScenario.bullRentPct + '% rents, ' + (sensScenario.bullCapBps >= 0 ? '+' : '') + sensScenario.bullCapBps + 'bps cap';
    html += `<div class="analysis-section"><h3>Bear / Base / Bull Scenarios</h3>`;
    html += `<table class="scenario-table"><thead><tr>
        <th>Metric</th>
        <th class="scenario-bear">Bear Case</th>
        <th class="scenario-base">Base Case</th>
        <th class="scenario-bull">Bull Case</th>
    </tr></thead><tbody>`;

    const rows = [
        ['Total Dev Cost', fmt(sens.bear.totalDev), fmt(sens.base.totalDev), fmt(sens.bull.totalDev)],
        ['Stabilized Value', fmt(sens.bear.stabilizedValue), fmt(sens.base.stabilizedValue), fmt(sens.bull.stabilizedValue)],
        ['NOI', fmt(sens.bear.noi), fmt(sens.base.noi), fmt(sens.bull.noi)],
        ['Dev Margin', `${(sens.bear.devMargin * 100).toFixed(1)}%`, `${(sens.base.devMargin * 100).toFixed(1)}%`, `${(sens.bull.devMargin * 100).toFixed(1)}%`],
        ['Est. IRR', `${(sens.bearIRR * 100).toFixed(1)}%`, `${(sens.baseIRR * 100).toFixed(1)}%`, `${(sens.bullIRR * 100).toFixed(1)}%`],
        ['Yield on Cost', `${(sens.bear.yieldOnCost * 100).toFixed(1)}%`, `${(sens.base.yieldOnCost * 100).toFixed(1)}%`, `${(sens.bull.yieldOnCost * 100).toFixed(1)}%`],
        ['Profit', fmt(sens.bear.stabilizedValue - sens.bear.totalDev), fmt(sens.base.stabilizedValue - sens.base.totalDev), fmt(sens.bull.stabilizedValue - sens.bull.totalDev)],
    ];
    for (const r of rows) {
        html += `<tr><td>${r[0]}</td><td class="scenario-bear">${r[1]}</td><td class="scenario-base">${r[2]}</td><td class="scenario-bull">${r[3]}</td></tr>`;
    }
    html += `</tbody></table>`;
    html += `<div style="font-size:0.75rem;color:var(--text-light);margin-top:0.5rem;">Bear: ${bearDesc} | Bull: ${bullDesc}</div>`;
    html += `</div>`;

    // Tornado Diagram
    html += `<div class="analysis-section"><h3>Sensitivity Tornado â€” Impact on Development Margin</h3>`;
    html += `<div class="tornado-container">`;
    const maxSwing = Math.max(...sens.tornado.map(t => Math.max(Math.abs(t.highMargin - t.baseMargin), Math.abs(t.lowMargin - t.baseMargin))));
    const barScale = maxSwing > 0 ? 45 / maxSwing : 1; // max 45% of width

    for (const t of sens.tornado) {
        const negWidth = Math.abs(t.lowMargin - t.baseMargin) * barScale;
        const posWidth = Math.abs(t.highMargin - t.baseMargin) * barScale;
        html += `<div class="tornado-bar-row">
            <span class="tornado-label">${t.label}</span>
            <div class="tornado-bar-area">
                <div class="tornado-center-line"></div>
                <div class="tornado-bar-neg" style="width:${negWidth}%"></div>
                <div class="tornado-bar-pos" style="width:${posWidth}%"></div>
            </div>
            <span style="width:80px;text-align:left;font-size:0.72rem;padding-left:0.5rem;flex-shrink:0;">${(t.lowMargin * 100).toFixed(1)}% â€” ${(t.highMargin * 100).toFixed(1)}%</span>
        </div>`;
    }
    html += `</div>`;
    html += `<div style="font-size:0.75rem;color:var(--text-light);text-align:center;">Red = downside | Green = upside | Center line = base case (${(sens.base.devMargin * 100).toFixed(1)}%)</div>`;
    html += `</div>`;

    // Breakeven Analysis
    html += `<div class="breakeven-card"><h4>Breakeven Analysis</h4>
        <div class="breakeven-grid">
            <div class="breakeven-item">
                <div class="breakeven-value">${(sens.costBreakeven * 100).toFixed(0)}%</div>
                <div class="breakeven-label">Construction costs can rise before project goes negative</div>
            </div>
            <div class="breakeven-item">
                <div class="breakeven-value">${(sens.rentBreakeven * 100).toFixed(0)}%</div>
                <div class="breakeven-label">Rents can fall before project goes negative</div>
            </div>
            <div class="breakeven-item">
                <div class="breakeven-value">${(sens.landBreakeven * 100).toFixed(0)}%</div>
                <div class="breakeven-label">Land cost can rise before project goes negative</div>
            </div>
        </div>
    </div>`;

    // Heat Map
    html += `<div class="analysis-section" style="margin-top:1.5rem;"><h3>Development Margin Heat Map â€” Rent vs. Cost Sensitivity</h3>`;
    html += `<div class="heatmap-wrapper"><table class="heatmap-table">`;
    html += `<thead><tr><th class="row-header">Cost \\ Rent</th>`;
    for (const rs of sens.rentSteps) {
        html += `<th>${rs >= 0 ? '+' : ''}${(rs * 100).toFixed(0)}%</th>`;
    }
    html += `</tr></thead><tbody>`;
    for (let ci = 0; ci < sens.costSteps.length; ci++) {
        html += `<tr><td class="row-header">${sens.costSteps[ci] >= 0 ? '+' : ''}${(sens.costSteps[ci] * 100).toFixed(0)}%</td>`;
        for (let ri = 0; ri < sens.rentSteps.length; ri++) {
            const margin = sens.heatmap[ci][ri];
            const pct = (margin * 100).toFixed(0);
            let bg;
            if (margin >= 0.20) bg = '#276749';
            else if (margin >= 0.10) bg = '#38a169';
            else if (margin >= 0.05) bg = '#68d391';
            else if (margin >= 0) bg = '#fefcbf';
            else if (margin >= -0.10) bg = '#fc8181';
            else bg = '#c53030';
            const textColor = (margin >= 0.10 || margin < -0.05) ? 'white' : '#2d3748';
            const isCurrent = sens.costSteps[ci] === 0 && sens.rentSteps[ri] === 0;
            html += `<td style="background:${bg};color:${textColor};${isCurrent ? 'border:2px solid var(--primary);font-weight:800;' : ''}">${pct}%</td>`;
        }
        html += `</tr>`;
    }
    html += `</tbody></table></div>`;
    html += `<div style="font-size:0.75rem;color:var(--text-light);margin-top:0.5rem;">Cell values show development margin. Green = profitable, Yellow = marginal, Red = negative. Outlined cell = base case.</div>`;
    html += `</div>`;

    return html;
}

function sensSliderHtml(id, label, min, max, step, val, unit) {
    return '<div class="dt-slider-group">' +
        '<div class="dt-slider-label"><span>' + label + '</span><span class="dt-val" id="' + id + '-val">' + (val >= 0 ? '+' : '') + val + unit + '</span></div>' +
        '<div class="dt-slider-row">' +
        '<input type="range" id="' + id + '-slider" min="' + min + '" max="' + max + '" step="' + step + '" value="' + val + '" oninput="document.getElementById(\'' + id + '\').value=this.value;recalcSensitivity()">' +
        '<input type="number" id="' + id + '" min="' + min + '" max="' + max + '" step="' + step + '" value="' + val + '" style="width:70px;" oninput="document.getElementById(\'' + id + '-slider\').value=this.value;recalcSensitivity()">' +
        '</div></div>';
}

function recalcSensitivity() {
    // Immediate: sync slider values and display labels
    var fields = ['bearCostPct', 'bearRentPct', 'bearCapBps', 'bullCostPct', 'bullRentPct', 'bullCapBps'];
    var units = ['%', '%', 'bps', '%', '%', 'bps'];
    for (var i = 0; i < fields.length; i++) {
        var el = document.getElementById('sens-' + fields[i]);
        var slider = document.getElementById('sens-' + fields[i] + '-slider');
        if (el) {
            var parsed = parseFloat(el.value);
            sensScenario[fields[i]] = isNaN(parsed) ? sensScenarioDefaults[fields[i]] : parsed;
            if (slider && document.activeElement === el) slider.value = el.value;
            if (slider && document.activeElement === slider) el.value = slider.value;
        }
        var valSpan = document.getElementById('sens-' + fields[i] + '-val');
        if (valSpan && el) {
            var v = parseFloat(el.value);
            valSpan.textContent = (v >= 0 ? '+' : '') + v + units[i];
        }
    }
    // Debounced: heavy recomputation
    _debouncedCall('sensitivity', function() {
        var container = document.getElementById('sensitivityContent');
        if (container && deepAnalysisState) {
            container.innerHTML = buildSensitivityContent(deepAnalysisState);
        }
    }, 180);
}

function resetSensitivity() {
    sensScenario = {
        bearCostPct: sensScenarioDefaults.bearCostPct,
        bearRentPct: sensScenarioDefaults.bearRentPct,
        bearCapBps: sensScenarioDefaults.bearCapBps,
        bullCostPct: sensScenarioDefaults.bullCostPct,
        bullRentPct: sensScenarioDefaults.bullRentPct,
        bullCapBps: sensScenarioDefaults.bullCapBps
    };
    var fields = ['bearCostPct', 'bearRentPct', 'bearCapBps', 'bullCostPct', 'bullRentPct', 'bullCapBps'];
    for (var i = 0; i < fields.length; i++) {
        var el = document.getElementById('sens-' + fields[i]);
        var slider = document.getElementById('sens-' + fields[i] + '-slider');
        if (el) el.value = sensScenarioDefaults[fields[i]];
        if (slider) slider.value = sensScenarioDefaults[fields[i]];
    }
    recalcSensitivity();
}

function renderSensitivityTab(st) {
    const { bestUse, inp, assumptions, effects, computed } = st;

    const hasUnits = !!BUILDING_PARAMS[bestUse].unitSF;

    let html = `<div class="deep-tab-panel">`;

    // Editable Assumptions Panel
    html += `<div class="analysis-section">`;
    html += renderDeepAssumptions(assumptions, hasUnits, bestUse, computed);
    html += `</div>`;

    // Scenario Sliders
    html += `<div class="dt-controls"><div class="dt-controls-title">Bear / Bull Scenario Assumptions <button class="dt-reset-btn" onclick="resetSensitivity()">Reset Defaults</button></div>`;
    html += `<div class="sens-scenario-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:0.25rem 2rem;">`;
    html += `<div><div style="font-size:0.78rem;font-weight:700;color:#c53030;margin-bottom:0.5rem;">Bear Case</div>`;
    html += sensSliderHtml('sens-bearCostPct', 'Cost Increase', 0, 30, 1, sensScenario.bearCostPct, '%');
    html += sensSliderHtml('sens-bearRentPct', 'Rent Change', -30, 0, 1, sensScenario.bearRentPct, '%');
    html += sensSliderHtml('sens-bearCapBps', 'Cap Rate Shift', 0, 100, 5, sensScenario.bearCapBps, 'bps');
    html += `</div>`;
    html += `<div><div style="font-size:0.78rem;font-weight:700;color:#276749;margin-bottom:0.5rem;">Bull Case</div>`;
    html += sensSliderHtml('sens-bullCostPct', 'Cost Change', -30, 0, 1, sensScenario.bullCostPct, '%');
    html += sensSliderHtml('sens-bullRentPct', 'Rent Increase', 0, 30, 1, sensScenario.bullRentPct, '%');
    html += sensSliderHtml('sens-bullCapBps', 'Cap Rate Shift', -100, 0, 5, sensScenario.bullCapBps, 'bps');
    html += `</div></div></div>`;

    // Dynamic content area
    html += `<div id="sensitivityContent">${buildSensitivityContent(st)}</div>`;

    html += `</div>`;
    return html;
}

function renderAffordableTab(st) {
    const { bestUse, inp, effects, computed } = st;
    const compliance = calculateAffordableCompliance(bestUse, inp, effects, computed);

    let html = `<div class="deep-tab-panel">`;

    if (!compliance) {
        html += `<div class="coming-soon-panel"><div class="icon">N/A</div>
            <h3>Not Applicable</h3>
            <p>Affordable housing compliance analysis is only available for residential/mixed-use projects with unit counts.</p>
        </div></div>`;
        return html;
    }

    html += `<div class="analysis-section"><h3>Affordable Housing Compliance Analysis</h3>`;

    // Market vs Affordable Rents
    html += `<h4 style="font-size:0.88rem;color:var(--primary);margin-bottom:0.75rem;">Market vs. Restricted Rents (Monthly)</h4>`;
    html += `<table class="afford-comparison-table"><thead><tr>
        <th>Unit Type</th><th>Market Rent</th><th>VLI (50% AMI)</th><th>Low (80% AMI)</th><th>Moderate (120% AMI)</th>
    </tr></thead><tbody>`;
    html += `<tr><td>Studio</td><td>${fmt(compliance.marketRentStudio)}</td><td>${fmt(LA_AMI_LIMITS_2025.veryLow.ami_studio)}</td><td>${fmt(LA_AMI_LIMITS_2025.low.ami_studio)}</td><td>${fmt(LA_AMI_LIMITS_2025.moderate.ami_studio)}</td></tr>`;
    html += `<tr><td>1-Bedroom</td><td>${fmt(compliance.marketRent1BR)}</td><td>${fmt(LA_AMI_LIMITS_2025.veryLow.ami_1br)}</td><td>${fmt(LA_AMI_LIMITS_2025.low.ami_1br)}</td><td>${fmt(LA_AMI_LIMITS_2025.moderate.ami_1br)}</td></tr>`;
    html += `<tr><td>2-Bedroom</td><td>${fmt(compliance.marketRent2BR)}</td><td>${fmt(LA_AMI_LIMITS_2025.veryLow.ami_2br)}</td><td>${fmt(LA_AMI_LIMITS_2025.low.ami_2br)}</td><td>${fmt(LA_AMI_LIMITS_2025.moderate.ami_2br)}</td></tr>`;
    html += `</tbody></table>`;
    html += `<div style="font-size:0.72rem;color:#718096;margin-top:0.4rem;">
        AMI rents based on 2025 LA County AMI ($${LA_AMI_LIMITS_2025.ami.toLocaleString()}, 4-person HH) per HUD guidelines.
        Sources: <a href="${WELFARE_EXEMPTION.sources.ctcac_limits.url}" target="_blank" style="color:#3182ce;">CTCAC Rent Limits</a> |
        <a href="${WELFARE_EXEMPTION.sources.hcd_income.url}" target="_blank" style="color:#3182ce;">HCD Income Limits</a> |
        <a href="${WELFARE_EXEMPTION.sources.lahd_schedules.url}" target="_blank" style="color:#3182ce;">LAHD Schedule 6 & 9</a>
    </div>`;

    // Inclusionary Requirements
    html += `<h4 style="font-size:0.88rem;color:var(--primary);margin:1.5rem 0 0.75rem;">Mandatory Inclusionary Set-Asides (${compliance.totalUnits} total units)</h4>`;
    html += `<div class="afford-tier-grid">`;
    for (const tier of compliance.tierAnalysis) {
        html += `<div class="afford-tier-card">
            <h5>${tier.label}</h5>
            <div style="font-size:0.82rem;">
                <div><strong>${tier.affordableUnits} units</strong> (${(tier.setAside * 100).toFixed(0)}% set-aside)</div>
                <div>Max rent: ${fmt(tier.maxRent1BR)}/mo</div>
                <div style="color:#c53030;">Revenue loss: ${fmt(tier.annualLoss)}/yr</div>
                <div style="color:var(--text-light);">(${(tier.revReduction * 100).toFixed(1)}% of total revenue)</div>
            </div>
        </div>`;
    }
    html += `</div>`;

    // Density Bonus Optimization
    if (compliance.bonusStrategies.length > 0) {
        html += `<h4 style="font-size:0.88rem;color:var(--primary);margin:1.5rem 0 0.75rem;">Density Bonus Optimization (AB 2345)</h4>`;
        html += `<p style="font-size:0.82rem;color:var(--text-light);margin-bottom:0.75rem;">Each strategy shows the net revenue impact of providing affordable units in exchange for additional market-rate units.</p>`;
        html += `<table class="afford-comparison-table"><thead><tr>
            <th>Strategy</th><th>Afford. Units</th><th>Bonus Units</th><th>Total</th><th>Net Annual Revenue</th>
        </tr></thead><tbody>`;
        const topStrategies = compliance.bonusStrategies.slice(0, 5);
        for (const s of topStrategies) {
            const color = s.netAnnualGain > 0 ? '#276749' : '#c53030';
            html += `<tr>
                <td>${s.label}</td>
                <td>${s.affordUnits}</td>
                <td>+${s.bonusUnits}</td>
                <td><strong>${s.totalWithBonus}</strong></td>
                <td style="color:${color};font-weight:600;">${s.netAnnualGain > 0 ? '+' : ''}${fmt(s.netAnnualGain)}</td>
            </tr>`;
        }
        html += `</tbody></table>`;

        // Best strategy highlight
        const best = compliance.bestStrategy;
        if (best) {
            const bonusPct = Math.round(best.bonus * 100);
            html += `<div class="afford-strategy-card">
                <h4>Recommended Strategy: ${best.label}</h4>
                <p style="font-size:0.85rem;">Provide <strong>${best.affordUnits} affordable units</strong> (${(best.setAside * 100).toFixed(0)}% set-aside) to earn a <strong>${bonusPct}% density bonus</strong> (+${best.bonusUnits} market-rate units).</p>
                <p style="font-size:0.85rem;">Net annual revenue impact: <strong style="color:${best.netAnnualGain >= 0 ? '#276749' : '#c53030'}">${best.netAnnualGain >= 0 ? '+' : ''}${fmt(best.netAnnualGain)}/year</strong></p>
                <div class="density-bonus-bar">
                    <div class="density-bonus-fill" style="width:${Math.min(bonusPct, 100)}%"></div>
                    <span class="density-bonus-label">${bonusPct}% bonus</span>
                </div>
            </div>`;
        }
    }

    // In-Lieu Fee vs Build
    if (compliance.inLieu.total > 0) {
        html += `<h4 style="font-size:0.88rem;color:var(--primary);margin:1.5rem 0 0.75rem;">In-Lieu Fee vs. Build Comparison</h4>`;
        html += `<div class="exec-summary-grid">
            <div class="exec-summary-card">
                <h4>Pay In-Lieu Fee</h4>
                <div class="exec-metric-lg">${formatCompactDollars(compliance.buildVsBuy.inLieuTotal)}</div>
                <div class="exec-metric-sub">${fmt(compliance.inLieu.perUnit)} per required unit</div>
            </div>
            <div class="exec-summary-card">
                <h4>Build Affordable Units</h4>
                <div class="exec-metric-lg">${formatCompactDollars(compliance.buildVsBuy.buildNPVLoss)}</div>
                <div class="exec-metric-sub">15-year NPV of lost rent revenue</div>
            </div>
        </div>`;
        html += `<div style="background:#f8fafc;border:1px solid var(--border);border-radius:8px;padding:0.75rem 1rem;margin-top:0.75rem;font-size:0.85rem;">
            <strong>Recommendation:</strong> ${compliance.buildVsBuy.recommendation}
            ${compliance.buildVsBuy.inLieuTotal < compliance.buildVsBuy.buildNPVLoss
                ? ' â€” the in-lieu fee is less costly than the long-term rent reduction from building the affordable units.'
                : ' â€” building the affordable units costs less over the project lifecycle than paying the in-lieu fee, and enables density bonus benefits.'}
        </div>`;
    }

    // LIHTC
    if (compliance.lihtc.eligible4pct) {
        html += `<h4 style="font-size:0.88rem;color:var(--primary);margin:1.5rem 0 0.75rem;">Tax Credit Feasibility</h4>`;
        html += `<div class="exec-summary-card" style="max-width:400px;">
            <h4>4% LIHTC (As-of-Right)</h4>
            <div class="exec-metric-lg">${formatCompactDollars(compliance.lihtc.credit4pct)}</div>
            <div class="exec-metric-sub">Estimated tax credit equity (10-year)</div>
        </div>`;
    }

    // Welfare Exemption â€” Nonprofit GP Strategy
    const we = compliance.welfareExemption;
    if (we) {
        html += `<h4 style="font-size:0.88rem;color:var(--primary);margin:1.5rem 0 0.75rem;">
            Welfare Exemption â€” Nonprofit GP Strategy
            <span style="font-size:0.7rem;color:#718096;font-weight:400;margin-left:0.5rem;">(RTC &sect;214(g))</span>
        </h4>`;
        html += `<p style="font-size:0.82rem;color:var(--text-light);margin-bottom:0.75rem;">
            By incorporating a 501(c)(3) nonprofit as the managing general partner, the project qualifies for a proportional property tax exemption
            on units restricted at &le;80% AMI. The exemption is filed annually (Form ${WELFARE_EXEMPTION.filingForm}, due ${WELFARE_EXEMPTION.filingDeadline}).
        </p>`;

        // Key metrics
        html += `<div class="exec-summary-grid">
            <div class="exec-summary-card">
                <h4>Qualifying Units</h4>
                <div class="exec-metric-lg">${we.qualifyingUnits} of ${we.qualifyingUnits > 0 ? compliance.totalUnits : 0}</div>
                <div class="exec-metric-sub">${(we.exemptionPct * 100).toFixed(1)}% of units at &le;80% AMI</div>
            </div>
            <div class="exec-summary-card">
                <h4>Gross Annual Tax</h4>
                <div class="exec-metric-lg">${fmt(Math.round(we.grossAnnualTax))}</div>
                <div class="exec-metric-sub">${(we.taxRate * 100).toFixed(2)}% effective rate on ${formatCompactDollars(we.assessedValue)} AV</div>
            </div>
            <div class="exec-summary-card">
                <h4>Annual Tax Savings</h4>
                <div class="exec-metric-lg" style="color:#276749;">${fmt(Math.round(we.annualTaxSavings))}</div>
                <div class="exec-metric-sub">${(we.exemptionPct * 100).toFixed(1)}% exemption applied</div>
            </div>
            <div class="exec-summary-card">
                <h4>Net Annual Benefit</h4>
                <div class="exec-metric-lg" style="color:${we.netAnnualBenefit >= 0 ? '#276749' : '#c53030'};">${we.netAnnualBenefit >= 0 ? '+' : ''}${fmt(Math.round(we.netAnnualBenefit))}</div>
                <div class="exec-metric-sub">After nonprofit GP fee (${fmt(we.nonprofitGPCost)}/yr)</div>
            </div>
        </div>`;

        // Scenario comparison table
        html += `<h4 style="font-size:0.85rem;color:var(--text);margin:1.25rem 0 0.5rem;">Welfare Exemption Scenario Analysis</h4>`;
        html += `<p style="font-size:0.78rem;color:var(--text-light);margin-bottom:0.5rem;">
            Compare tax savings vs. lost rent revenue at different affordable unit percentages. Net benefit = tax savings &minus; nonprofit GP fee &minus; lost rent vs. market.
        </p>`;
        html += `<table class="afford-comparison-table"><thead><tr>
            <th>Scenario</th><th>Afford. Units</th><th>Exemption</th><th>Annual Tax Savings</th><th>Annual Lost Rent</th><th>Net Benefit</th>
        </tr></thead><tbody>`;
        for (const s of we.scenarios) {
            const color = s.netBenefit >= 0 ? '#276749' : '#c53030';
            html += `<tr>
                <td>${s.label}</td>
                <td>${s.qualUnits}</td>
                <td>${(s.exemPct * 100).toFixed(0)}%</td>
                <td style="color:#276749;">${fmt(Math.round(s.annualSavings))}</td>
                <td style="color:#c53030;">${fmt(Math.round(s.lostRent))}</td>
                <td style="color:${color};font-weight:600;">${s.netBenefit >= 0 ? '+' : ''}${fmt(Math.round(s.netBenefit))}</td>
            </tr>`;
        }
        html += `</tbody></table>`;

        // Nonprofit GP structure explainer
        html += `<div style="background:#f0fff4;border:1px solid #c6f6d5;border-radius:8px;padding:0.75rem 1rem;margin-top:1rem;">
            <h5 style="font-size:0.82rem;color:#276749;margin-bottom:0.4rem;">Nonprofit GP Structure</h5>
            <div style="font-size:0.78rem;color:var(--text);line-height:1.6;">
                <strong>Entity:</strong> 501(c)(3) nonprofit serves as managing GP (~0.01% interest) with LIHTC investor as LP (~99.99%).<br>
                <strong>Requirement:</strong> Nonprofit must have genuine management authority (BOE Rule 140.1). Annual filing of Form BOE-267-L required.<br>
                <strong>Compliance:</strong> Units must be restricted by recorded regulatory agreement. Tenants income-certified annually. Over-income ceiling: 140% AMI (AB 1193).<br>
                <strong>Duration:</strong> Exemption available for full ${WELFARE_EXEMPTION.compliancePeriod}-year compliance period.
            </div>
        </div>`;

        // Source links
        html += `<div style="font-size:0.72rem;color:#718096;margin-top:0.75rem;">
            <strong>Sources & verification:</strong> `;
        const srcLinks = Object.values(WELFARE_EXEMPTION.sources).map(s =>
            `<a href="${s.url}" target="_blank" style="color:#3182ce;">${s.label}</a>`
        ).join(' | ');
        html += srcLinks + `</div>`;
    }

    html += `</div></div>`;
    return html;
}

// ============================================================
//  SKILL 25: MARKET COMPS & INTELLIGENCE
// ============================================================

const MARKET_RENTS_2025 = {
    // Monthly asking rents by neighborhood and unit type (2025 LA market)
    dtla:         { studio: 1950, br1: 2550, br2: 3400, br3: 4200, retail_psf: 42, office_psf: 48 },
    hollywood:    { studio: 2100, br1: 2800, br2: 3650, br3: 4500, retail_psf: 48, office_psf: 52 },
    koreatown:    { studio: 1650, br1: 2150, br2: 2850, br3: 3500, retail_psf: 36, office_psf: 38 },
    westside:     { studio: 2400, br1: 3100, br2: 4100, br3: 5200, retail_psf: 54, office_psf: 58 },
    santamonica:  { studio: 2600, br1: 3400, br2: 4500, br3: 5800, retail_psf: 62, office_psf: 65 },
    beverly:      { studio: 2700, br1: 3500, br2: 4600, br3: 5900, retail_psf: 58, office_psf: 72 },
    midcity:      { studio: 1850, br1: 2400, br2: 3200, br3: 4000, retail_psf: 38, office_psf: 42 },
    southla:      { studio: 1300, br1: 1700, br2: 2200, br3: 2750, retail_psf: 24, office_psf: 28 },
    valleyeast:   { studio: 1500, br1: 1950, br2: 2600, br3: 3200, retail_psf: 30, office_psf: 34 },
    valleywest:   { studio: 1600, br1: 2100, br2: 2800, br3: 3400, retail_psf: 32, office_psf: 36 },
    silverlake:   { studio: 2000, br1: 2600, br2: 3500, br3: 4300, retail_psf: 44, office_psf: 46 },
    highland:     { studio: 1700, br1: 2200, br2: 2900, br3: 3600, retail_psf: 34, office_psf: 38 },
    venice:       { studio: 2400, br1: 3100, br2: 4100, br3: 5100, retail_psf: 56, office_psf: 54 },
    culver:       { studio: 2200, br1: 2850, br2: 3800, br3: 4700, retail_psf: 48, office_psf: 52 },
    exposition:   { studio: 1650, br1: 2150, br2: 2850, br3: 3500, retail_psf: 34, office_psf: 38 },
    southbay:     { studio: 1600, br1: 2050, br2: 2700, br3: 3350, retail_psf: 32, office_psf: 36 },
    harbor:       { studio: 1300, br1: 1650, br2: 2200, br3: 2700, retail_psf: 22, office_psf: 26 },
    boyleheights: { studio: 1350, br1: 1750, br2: 2300, br3: 2850, retail_psf: 26, office_psf: 28 },
};

const VACANCY_RATES = {
    dtla:         { residential: 0.072, retail: 0.085, office: 0.185, trend: 'improving' },
    hollywood:    { residential: 0.055, retail: 0.062, office: 0.145, trend: 'stable' },
    koreatown:    { residential: 0.048, retail: 0.070, office: 0.160, trend: 'stable' },
    westside:     { residential: 0.042, retail: 0.055, office: 0.125, trend: 'stable' },
    santamonica:  { residential: 0.038, retail: 0.058, office: 0.135, trend: 'stable' },
    beverly:      { residential: 0.035, retail: 0.048, office: 0.110, trend: 'stable' },
    midcity:      { residential: 0.052, retail: 0.068, office: 0.155, trend: 'improving' },
    southla:      { residential: 0.058, retail: 0.095, office: 0.200, trend: 'improving' },
    valleyeast:   { residential: 0.050, retail: 0.075, office: 0.165, trend: 'stable' },
    valleywest:   { residential: 0.045, retail: 0.070, office: 0.155, trend: 'stable' },
    silverlake:   { residential: 0.040, retail: 0.055, office: 0.130, trend: 'stable' },
    highland:     { residential: 0.048, retail: 0.072, office: 0.160, trend: 'improving' },
    venice:       { residential: 0.042, retail: 0.060, office: 0.140, trend: 'stable' },
    culver:       { residential: 0.038, retail: 0.052, office: 0.120, trend: 'improving' },
    exposition:   { residential: 0.055, retail: 0.078, office: 0.170, trend: 'improving' },
    southbay:     { residential: 0.048, retail: 0.072, office: 0.160, trend: 'stable' },
    harbor:       { residential: 0.062, retail: 0.092, office: 0.195, trend: 'declining' },
    boyleheights: { residential: 0.055, retail: 0.088, office: 0.190, trend: 'improving' },
};

const ABSORPTION_DATA = {
    // Annual absorption rate â€” % of new units absorbed per year by submarket
    dtla:         { residential: 0.82, retail: 0.70, office: 0.55, newSupplyUnits: 2800 },
    hollywood:    { residential: 0.88, retail: 0.78, office: 0.62, newSupplyUnits: 1500 },
    koreatown:    { residential: 0.90, retail: 0.75, office: 0.58, newSupplyUnits: 2200 },
    westside:     { residential: 0.92, retail: 0.82, office: 0.68, newSupplyUnits: 800 },
    santamonica:  { residential: 0.94, retail: 0.85, office: 0.70, newSupplyUnits: 400 },
    beverly:      { residential: 0.95, retail: 0.88, office: 0.72, newSupplyUnits: 300 },
    midcity:      { residential: 0.88, retail: 0.72, office: 0.58, newSupplyUnits: 1200 },
    southla:      { residential: 0.85, retail: 0.65, office: 0.48, newSupplyUnits: 600 },
    valleyeast:   { residential: 0.87, retail: 0.70, office: 0.55, newSupplyUnits: 900 },
    valleywest:   { residential: 0.88, retail: 0.72, office: 0.58, newSupplyUnits: 700 },
    silverlake:   { residential: 0.92, retail: 0.80, office: 0.65, newSupplyUnits: 500 },
    highland:     { residential: 0.88, retail: 0.72, office: 0.58, newSupplyUnits: 600 },
    venice:       { residential: 0.93, retail: 0.82, office: 0.68, newSupplyUnits: 350 },
    culver:       { residential: 0.92, retail: 0.80, office: 0.70, newSupplyUnits: 600 },
    exposition:   { residential: 0.87, retail: 0.70, office: 0.55, newSupplyUnits: 800 },
    southbay:     { residential: 0.86, retail: 0.70, office: 0.55, newSupplyUnits: 500 },
    harbor:       { residential: 0.80, retail: 0.60, office: 0.45, newSupplyUnits: 400 },
    boyleheights: { residential: 0.85, retail: 0.65, office: 0.50, newSupplyUnits: 350 },
};

// Comparable land sales $/SF by neighborhood (recent transactions 2024-2025)
const COMP_LAND_SALES = {
    dtla:         { low: 200, median: 275, high: 400, sampleSize: 18, trend: '+8% YoY' },
    hollywood:    { low: 180, median: 260, high: 380, sampleSize: 14, trend: '+5% YoY' },
    koreatown:    { low: 140, median: 210, high: 320, sampleSize: 22, trend: '+12% YoY' },
    westside:     { low: 280, median: 370, high: 520, sampleSize: 8, trend: '+3% YoY' },
    santamonica:  { low: 320, median: 420, high: 600, sampleSize: 5, trend: '+2% YoY' },
    beverly:      { low: 350, median: 470, high: 650, sampleSize: 6, trend: '+4% YoY' },
    midcity:      { low: 130, median: 185, high: 280, sampleSize: 16, trend: '+10% YoY' },
    southla:      { low: 55, median: 90, high: 140, sampleSize: 24, trend: '+15% YoY' },
    valleyeast:   { low: 70, median: 115, high: 180, sampleSize: 20, trend: '+8% YoY' },
    valleywest:   { low: 85, median: 135, high: 200, sampleSize: 15, trend: '+6% YoY' },
    silverlake:   { low: 165, median: 230, high: 340, sampleSize: 10, trend: '+7% YoY' },
    highland:     { low: 100, median: 155, high: 240, sampleSize: 12, trend: '+9% YoY' },
    venice:       { low: 280, median: 365, high: 500, sampleSize: 7, trend: '+3% YoY' },
    culver:       { low: 200, median: 275, high: 380, sampleSize: 9, trend: '+6% YoY' },
    exposition:   { low: 110, median: 165, high: 250, sampleSize: 14, trend: '+11% YoY' },
    southbay:     { low: 80, median: 125, high: 190, sampleSize: 18, trend: '+5% YoY' },
    harbor:       { low: 50, median: 82, high: 130, sampleSize: 16, trend: '+4% YoY' },
    boyleheights: { low: 70, median: 115, high: 175, sampleSize: 15, trend: '+14% YoY' },
};

function analyzeMarketComps(useId, inp, computed) {
    const nh = inp.neighborhood;
    const rents = MARKET_RENTS_2025[nh] || MARKET_RENTS_2025.dtla;
    const vacancy = VACANCY_RATES[nh] || VACANCY_RATES.dtla;
    const absorption = ABSORPTION_DATA[nh] || ABSORPTION_DATA.dtla;
    const landComps = COMP_LAND_SALES[nh] || COMP_LAND_SALES.dtla;
    const params = BUILDING_PARAMS[useId];

    // Determine vacancy type based on use
    const isResidential = ['sfr','duplex','multifamily_low','multifamily_mid','multifamily_high','mixeduse','senior','adu'].includes(useId);
    const isRetail = ['retail'].includes(useId);
    const vacancyRate = isResidential ? vacancy.residential : (isRetail ? vacancy.retail : vacancy.office);
    const absorptionRate = isResidential ? absorption.residential : (isRetail ? absorption.retail : absorption.office);

    // Calculate residual land value
    // Residual = Stabilized Value - Development Cost (excluding land)
    const devCostExLand = computed.totalDev - computed.landCost;
    const residualLandValue = computed.stabilizedValue - devCostExLand;
    const residualPSF = inp.parcelSize > 0 ? residualLandValue / inp.parcelSize : 0;

    // Market support score: compares our revenue assumptions to market rents
    const modeledMonthly = params && params.unitSF ? Math.round(computed.revenuePSF * params.unitSF / 12) : 0;
    const marketMonthly = rents.br1;
    const rentAlignment = modeledMonthly > 0 && marketMonthly > 0 ? Math.min(marketMonthly / modeledMonthly, 1.5) : 1.0;

    // Market demand score
    const demandRow = NEIGHBORHOOD_DEMAND[nh];
    const demand = demandRow ? (demandRow[useId] || 0.7) : 0.7;
    const marketSupport = Math.min(100, Math.round(
        (demand * 35) + (absorptionRate * 30) + ((1 - vacancyRate) * 20) + (rentAlignment > 0.9 ? 15 : rentAlignment * 15)
    ));

    // Absorption velocity (months to lease up)
    const units = computed.units || 0;
    const monthsToAbsorb = units > 0 && absorptionRate > 0
        ? Math.ceil(units / (absorption.newSupplyUnits * absorptionRate / 12))
        : 0;

    return {
        rents, vacancy, vacancyRate, absorption, absorptionRate, landComps,
        residualLandValue, residualPSF,
        modeledMonthly, marketMonthly, rentAlignment,
        marketSupport,
        monthsToAbsorb, vacancyTrend: vacancy.trend, demand,
    };
}

function renderMarketCompsTab(st) {
    const { bestUse, inp, computed } = st;
    const market = analyzeMarketComps(bestUse, inp, computed);
    const nh = inp.neighborhood;
    const nhLabel = nh.charAt(0).toUpperCase() + nh.slice(1);

    let html = `<div class="deep-tab-panel">`;

    // Market Support Score
    const supportColor = market.marketSupport >= 70 ? '#276749' : market.marketSupport >= 45 ? '#b7791f' : '#c53030';
    const supportBg = market.marketSupport >= 70 ? '#38a169' : market.marketSupport >= 45 ? '#ecc94b' : '#fc8181';
    html += `<div class="analysis-section"><h3>Market Support Score â€” ${nhLabel}</h3>
        <div class="market-support-meter">
            <div class="market-support-bar">
                <div class="market-support-fill" style="width:${market.marketSupport}%;background:${supportBg};"></div>
            </div>
            <div class="market-support-score" style="color:${supportColor}">${market.marketSupport}/100</div>
        </div>
        <div style="font-size:0.82rem;color:var(--text-light);">
            Demand: ${(market.demand * 100).toFixed(0)}% | Absorption: ${(market.absorptionRate * 100).toFixed(0)}% | Vacancy: ${(market.vacancyRate * 100).toFixed(1)}% (${market.vacancyTrend})
        </div>
    </div>`;

    // Current Market Rents â€” Editable
    html += `<div class="analysis-section"><h3>Current Asking Rents â€” ${nhLabel}
        <span style="font-size:0.7rem;color:#718096;font-weight:400;margin-left:0.5rem;">(click values to edit)</span>
    </h3>`;
    html += `<h4 style="font-size:0.85rem;color:var(--text-light);margin-bottom:0.75rem;">Residential (Monthly)</h4>`;
    html += `<div class="market-rent-grid">
        <div class="market-rent-card">
            <div class="rent-value">$<input type="number" class="market-comp-input" id="mc-studio" value="${market.rents.studio}" step="25" style="width:70px;font-size:inherit;font-weight:inherit;border:1px dashed #cbd5e0;border-radius:4px;text-align:center;padding:2px 4px;"></div>
            <div class="rent-label">Studio</div>
            <div class="rent-sub">~400-500 SF</div>
        </div>
        <div class="market-rent-card">
            <div class="rent-value">$<input type="number" class="market-comp-input" id="mc-1br" value="${market.rents.br1}" step="25" style="width:70px;font-size:inherit;font-weight:inherit;border:1px dashed #cbd5e0;border-radius:4px;text-align:center;padding:2px 4px;"></div>
            <div class="rent-label">1-Bedroom</div>
            <div class="rent-sub">~650-800 SF</div>
        </div>
        <div class="market-rent-card">
            <div class="rent-value">$<input type="number" class="market-comp-input" id="mc-2br" value="${market.rents.br2}" step="25" style="width:70px;font-size:inherit;font-weight:inherit;border:1px dashed #cbd5e0;border-radius:4px;text-align:center;padding:2px 4px;"></div>
            <div class="rent-label">2-Bedroom</div>
            <div class="rent-sub">~950-1,100 SF</div>
        </div>
        <div class="market-rent-card">
            <div class="rent-value">$<input type="number" class="market-comp-input" id="mc-3br" value="${market.rents.br3}" step="25" style="width:70px;font-size:inherit;font-weight:inherit;border:1px dashed #cbd5e0;border-radius:4px;text-align:center;padding:2px 4px;"></div>
            <div class="rent-label">3-Bedroom</div>
            <div class="rent-sub">~1,200-1,400 SF</div>
        </div>
    </div>`;
    html += `<div class="market-rent-grid" style="grid-template-columns: 1fr 1fr;">
        <div class="market-rent-card">
            <div class="rent-value">$<input type="number" class="market-comp-input" id="mc-retail" value="${market.rents.retail_psf}" step="1" style="width:55px;font-size:inherit;font-weight:inherit;border:1px dashed #cbd5e0;border-radius:4px;text-align:center;padding:2px 4px;">/SF/yr</div>
            <div class="rent-label">Retail NNN</div>
        </div>
        <div class="market-rent-card">
            <div class="rent-value">$<input type="number" class="market-comp-input" id="mc-office" value="${market.rents.office_psf}" step="1" style="width:55px;font-size:inherit;font-weight:inherit;border:1px dashed #cbd5e0;border-radius:4px;text-align:center;padding:2px 4px;">/SF/yr</div>
            <div class="rent-label">Office Full Service</div>
        </div>
    </div>`;
    html += `<div style="font-size:0.72rem;color:#718096;margin-top:0.4rem;">
        Default rents sourced from CoStar, Apartments.com, and Zillow Rental Index for ${nhLabel} submarket (2024-2025 avg).
        Edit any value above to override with your own market data.
    </div>`;

    // Model vs Market comparison
    if (market.modeledMonthly > 0) {
        const alignPct = (market.rentAlignment * 100).toFixed(0);
        const alignColor = market.rentAlignment >= 0.95 ? '#276749' : market.rentAlignment >= 0.80 ? '#b7791f' : '#c53030';
        html += `<div style="background:#f8fafc;border:1px solid var(--border);border-radius:8px;padding:0.75rem 1rem;margin-top:0.75rem;font-size:0.85rem;">
            <strong>Pro Forma Rent vs. Market:</strong> Model assumes <strong>${fmt(market.modeledMonthly)}/mo</strong> per unit, market asking is <strong>${fmt(market.marketMonthly)}/mo</strong>.
            <span style="color:${alignColor};font-weight:700;">${market.rentAlignment >= 0.95 ? ' Rents are market-supported.' : market.rentAlignment >= 0.80 ? ' Pro forma rents are slightly above market â€” achievable for new construction.' : ' Pro forma rents significantly exceed market â€” validate with local broker.'}</span>
        </div>`;
    }
    html += `</div>`;

    // Vacancy & Absorption
    html += `<div class="analysis-section"><h3>Vacancy Rates & Absorption</h3>`;
    html += `<div class="exec-summary-grid">`;
    const vTypes = [
        { label: 'Residential', rate: market.vacancy.residential, color: '#3182ce' },
        { label: 'Retail', rate: market.vacancy.retail, color: '#dd6b20' },
        { label: 'Office', rate: market.vacancy.office, color: '#805ad5' },
    ];
    for (const v of vTypes) {
        const barColor = v.rate < 0.06 ? '#38a169' : v.rate < 0.10 ? '#ecc94b' : '#fc8181';
        html += `<div class="exec-summary-card">
            <h4>${v.label} Vacancy</h4>
            <div class="vacancy-bar">
                <div class="vacancy-fill" style="width:${Math.min(v.rate * 100 * 3, 100)}%;background:${barColor};"></div>
                <span class="vacancy-label" style="color:${v.rate < 0.08 ? '#276749' : '#c53030'}">${(v.rate * 100).toFixed(1)}%</span>
            </div>
            <div class="exec-metric-sub">${v.rate < 0.05 ? 'Very tight â€” favors developers' : v.rate < 0.08 ? 'Healthy market' : v.rate < 0.12 ? 'Moderate vacancy' : 'Elevated vacancy â€” caution'}</div>
        </div>`;
    }
    html += `</div>`;

    if (market.monthsToAbsorb > 0) {
        html += `<div style="background:#f8fafc;border:1px solid var(--border);border-radius:8px;padding:0.75rem 1rem;margin-top:0.75rem;font-size:0.85rem;">
            <strong>Absorption Estimate:</strong> ${computed.units || 0} units projected to lease up in approximately <strong>${market.monthsToAbsorb} months</strong> based on submarket absorption velocity of ${market.absorption.newSupplyUnits.toLocaleString()} units/year.
        </div>`;
    }
    html += `</div>`;

    // Comparable Land Sales
    html += `<div class="analysis-section"><h3>Comparable Land Sales â€” ${nhLabel}</h3>`;
    const lc = market.landComps;
    html += `<table class="market-comp-table"><thead><tr>
        <th>Metric</th><th>Low</th><th>Median</th><th>High</th><th>Your Assumption</th>
    </tr></thead><tbody>
        <tr>
            <td>Land Value $/SF</td>
            <td>$${lc.low}</td>
            <td><strong>$${lc.median}</strong></td>
            <td>$${lc.high}</td>
            <td style="color:var(--primary);font-weight:700;">$${computed.landValuePSF}</td>
        </tr>
        <tr>
            <td>Total Land Value</td>
            <td>${fmt(lc.low * inp.parcelSize)}</td>
            <td><strong>${fmt(lc.median * inp.parcelSize)}</strong></td>
            <td>${fmt(lc.high * inp.parcelSize)}</td>
            <td style="color:var(--primary);font-weight:700;">${fmt(computed.landCost)}</td>
        </tr>
    </tbody></table>`;
    html += `<div style="font-size:0.78rem;color:var(--text-light);">Based on ${lc.sampleSize} comparable transactions in ${nhLabel} (2024-2025). Trend: ${lc.trend}.</div>`;

    // Warn if assumption is outside comp range
    if (computed.landValuePSF < lc.low * 0.85 || computed.landValuePSF > lc.high * 1.15) {
        html += `<div style="background:#fff5f5;border:1px solid #fc8181;border-radius:8px;padding:0.75rem 1rem;margin-top:0.75rem;font-size:0.85rem;color:#c53030;">
            <strong>Warning:</strong> Your land value assumption ($${computed.landValuePSF}/SF) is outside the comparable sales range ($${lc.low}-$${lc.high}/SF). Consider adjusting.
        </div>`;
    }
    html += `</div>`;

    // Residual Land Value
    html += `<div class="residual-land-card">
        <h4>Residual Land Value Analysis</h4>
        <div class="exec-summary-grid">
            <div class="exec-summary-card" style="background:white;">
                <h4>Residual Land Value</h4>
                <div class="exec-metric-lg">${formatCompactDollars(market.residualLandValue)}</div>
                <div class="exec-metric-sub">${fmt(Math.round(market.residualPSF))}/SF of land</div>
            </div>
            <div class="exec-summary-card" style="background:white;">
                <h4>Implied Land Budget</h4>
                <div class="exec-metric-lg">${fmt(Math.round(market.residualPSF))}/SF</div>
                <div class="exec-metric-sub">${market.residualPSF > computed.landValuePSF ? '<span style="color:#276749">Above your assumption â€” positive signal</span>' : '<span style="color:#c53030">Below your assumption â€” development economics are tight</span>'}</div>
            </div>
        </div>
        <p style="font-size:0.82rem;margin-top:0.75rem;color:var(--text-light);">Residual land value = Stabilized value minus all development costs (excluding land). If the residual exceeds the asking land price, the project is feasible. If not, you're "overpaying" for the land relative to achievable development returns.</p>
    </div>`;

    // Custom Comparable Properties
    html += `<div class="analysis-section"><h3>Your Market Comps</h3>`;
    html += `<p style="font-size:0.82rem;color:var(--text-light);margin-bottom:0.75rem;">Add your own comparable properties to validate rent assumptions. These override the default market data.</p>`;
    html += `<div id="customCompsContainer">`;

    // Render existing custom comps (stored on deepAnalysisState)
    var customComps = (deepAnalysisState && deepAnalysisState.customComps) || [];
    for (var ci = 0; ci < customComps.length; ci++) {
        var cc = customComps[ci];
        html += renderCustomCompRow(ci, cc);
    }
    html += `</div>`;
    html += `<button type="button" onclick="addCustomComp()" style="margin-top:0.5rem;padding:0.4rem 1rem;font-size:0.8rem;background:var(--primary);color:white;border:none;border-radius:6px;cursor:pointer;">+ Add Comp</button>`;
    html += `<div style="font-size:0.72rem;color:#718096;margin-top:0.75rem;">
        <strong>Data sources for default rents:</strong>
        <a href="https://www.apartments.com" target="_blank" style="color:#3182ce;">Apartments.com</a> |
        <a href="https://www.zillow.com/rental-manager/market-trends/" target="_blank" style="color:#3182ce;">Zillow Rental Index</a> |
        <a href="https://www.costar.com" target="_blank" style="color:#3182ce;">CoStar</a> |
        <a href="https://www.loopnet.com" target="_blank" style="color:#3182ce;">LoopNet</a>
    </div>`;
    html += `</div>`;

    html += `</div>`;
    return html;
}


// ============================================================
//  SKILL 28: TAX IMPLICATIONS & INCENTIVES
// ============================================================

// Custom Comp helper functions
function renderCustomCompRow(idx, comp) {
    comp = comp || { name: '', type: 'Studio', rent: '', sf: '', source: '', url: '' };
    return '<div class="custom-comp-row" style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr 2fr 30px;gap:0.4rem;align-items:center;margin-bottom:0.35rem;font-size:0.78rem;">' +
        '<input type="text" placeholder="Property name" value="' + (comp.name || '') + '" class="cc-field" data-cc="' + idx + '" data-key="name" style="padding:4px 6px;border:1px solid #cbd5e0;border-radius:4px;font-size:0.78rem;">' +
        '<select class="cc-field" data-cc="' + idx + '" data-key="type" style="padding:4px 2px;border:1px solid #cbd5e0;border-radius:4px;font-size:0.78rem;">' +
            '<option' + (comp.type === 'Studio' ? ' selected' : '') + '>Studio</option>' +
            '<option' + (comp.type === '1BR' ? ' selected' : '') + '>1BR</option>' +
            '<option' + (comp.type === '2BR' ? ' selected' : '') + '>2BR</option>' +
            '<option' + (comp.type === '3BR' ? ' selected' : '') + '>3BR</option>' +
            '<option' + (comp.type === 'Retail' ? ' selected' : '') + '>Retail</option>' +
            '<option' + (comp.type === 'Office' ? ' selected' : '') + '>Office</option>' +
        '</select>' +
        '<input type="number" placeholder="Rent/mo" value="' + (comp.rent || '') + '" class="cc-field" data-cc="' + idx + '" data-key="rent" step="25" style="padding:4px 6px;border:1px solid #cbd5e0;border-radius:4px;font-size:0.78rem;">' +
        '<input type="number" placeholder="SF" value="' + (comp.sf || '') + '" class="cc-field" data-cc="' + idx + '" data-key="sf" style="padding:4px 6px;border:1px solid #cbd5e0;border-radius:4px;font-size:0.78rem;">' +
        '<input type="text" placeholder="Source (e.g. Zillow, broker)" value="' + (comp.source || '') + '" class="cc-field" data-cc="' + idx + '" data-key="source" style="padding:4px 6px;border:1px solid #cbd5e0;border-radius:4px;font-size:0.78rem;">' +
        '<span onclick="removeCustomComp(' + idx + ')" style="cursor:pointer;color:#c53030;font-size:1.1rem;text-align:center;" title="Remove">&times;</span>' +
    '</div>';
}

function addCustomComp() {
    if (!deepAnalysisState) return;
    if (!deepAnalysisState.customComps) deepAnalysisState.customComps = [];
    // Save current field values before adding
    saveCustomCompFields();
    deepAnalysisState.customComps.push({ name: '', type: 'Studio', rent: '', sf: '', source: '' });
    var container = document.getElementById('customCompsContainer');
    if (container) {
        container.insertAdjacentHTML('beforeend', renderCustomCompRow(deepAnalysisState.customComps.length - 1));
    }
}

function removeCustomComp(idx) {
    if (!deepAnalysisState || !deepAnalysisState.customComps) return;
    saveCustomCompFields();
    deepAnalysisState.customComps.splice(idx, 1);
    // Re-render the comps container
    var container = document.getElementById('customCompsContainer');
    if (container) {
        var html = '';
        for (var i = 0; i < deepAnalysisState.customComps.length; i++) {
            html += renderCustomCompRow(i, deepAnalysisState.customComps[i]);
        }
        container.innerHTML = html;
    }
}

function saveCustomCompFields() {
    if (!deepAnalysisState || !deepAnalysisState.customComps) return;
    var fields = document.querySelectorAll('.cc-field');
    fields.forEach(function(f) {
        var idx = parseInt(f.getAttribute('data-cc'));
        var key = f.getAttribute('data-key');
        if (deepAnalysisState.customComps[idx]) {
            deepAnalysisState.customComps[idx][key] = f.value;
        }
    });
}

const OPPORTUNITY_ZONES_LA = {
    // Census tracts in LA County designated as Opportunity Zones
    // Neighborhoods where OZ tracts are concentrated
    dtla: true, southla: true, boyleheights: true, exposition: true,
    harbor: true, valleyeast: false, valleywest: false, hollywood: false,
    koreatown: true, westside: false, santamonica: false, beverly: false,
    midcity: true, silverlake: false, highland: true, venice: false,
    culver: false, southbay: false,
};

const MELLO_ROOS_DISTRICTS = {
    // Known CFD areas â€” annual assessment per unit/SF
    dtla: { active: true, annualPerUnit: 850, annualPerSF: 0.45 },
    hollywood: { active: false },
    koreatown: { active: false },
    westside: { active: false },
    santamonica: { active: false },
    beverly: { active: false },
    midcity: { active: false },
    southla: { active: false },
    valleyeast: { active: true, annualPerUnit: 650, annualPerSF: 0.35 },
    valleywest: { active: true, annualPerUnit: 700, annualPerSF: 0.38 },
    silverlake: { active: false },
    highland: { active: false },
    venice: { active: false },
    culver: { active: false },
    exposition: { active: false },
    southbay: { active: true, annualPerUnit: 550, annualPerSF: 0.30 },
    harbor: { active: false },
    boyleheights: { active: false },
};

const TRANSFER_TAX_RATES = {
    // LA City documentary transfer tax
    base: 0.00056, // $5.60 per $1,000 â€” LA County
    city: 0.00450, // $4.50 per $1,000 â€” LA City
    ula_tier1: { threshold: 5000000, rate: 0.04 },    // Measure ULA 4% on $5M-$10M
    ula_tier2: { threshold: 10000000, rate: 0.055 },   // Measure ULA 5.5% on >$10M
};

const SCHOOL_IMPACT_FEES = {
    residential: 4.79, // per SF of new residential construction (LAUSD 2025)
    commercial: 0.78,  // per SF of new commercial construction
};

const CONSTRUCTION_TAX = {
    rate: 0.02, // 2% of construction valuation for developments >$500K
    threshold: 500000,
};

function analyzeTaxImplications(useId, inp, computed) {
    const nh = inp.neighborhood;
    const params = BUILDING_PARAMS[useId];
    const isResidential = ['sfr','duplex','multifamily_low','multifamily_mid','multifamily_high','mixeduse','senior','adu'].includes(useId);

    // 1. Prop 13 Property Tax Projection
    const currentAssessedValue = computed.landCost * 0.6; // assume current assessment is ~60% of market
    const currentTax = currentAssessedValue * 0.012; // ~1.2% effective rate in LA
    const postDevAssessment = computed.stabilizedValue * 0.85; // new assessment at ~85% of value
    const postDevTax = postDevAssessment * 0.012;
    const taxIncrease = postDevTax - currentTax;

    // 10-year projection with 2% annual Prop 13 increase
    const taxProjection = [];
    for (let yr = 1; yr <= 10; yr++) {
        const yearTax = postDevTax * Math.pow(1.02, yr - 1);
        const yearNOI = computed.noi * Math.pow(1.03, yr - 1); // 3% annual rent growth
        const afterTaxNOI = yearNOI - yearTax;
        taxProjection.push({ year: yr, tax: yearTax, noi: yearNOI, afterTaxNOI });
    }

    // 2. Measure ULA Transfer Tax
    const salePrice = computed.stabilizedValue;
    let ulaTax = 0;
    let ulaRate = 0;
    if (salePrice > TRANSFER_TAX_RATES.ula_tier2.threshold) {
        ulaTax = salePrice * TRANSFER_TAX_RATES.ula_tier2.rate;
        ulaRate = TRANSFER_TAX_RATES.ula_tier2.rate;
    } else if (salePrice > TRANSFER_TAX_RATES.ula_tier1.threshold) {
        ulaTax = salePrice * TRANSFER_TAX_RATES.ula_tier1.rate;
        ulaRate = TRANSFER_TAX_RATES.ula_tier1.rate;
    }
    const baseTranferTax = salePrice * (TRANSFER_TAX_RATES.base + TRANSFER_TAX_RATES.city);
    const totalTransferTax = ulaTax + baseTranferTax;

    // 3. Opportunity Zone
    const isOZ = OPPORTUNITY_ZONES_LA[nh] || false;
    // OZ benefit: 10-year hold eliminates capital gains on appreciation
    const ozBenefit = isOZ ? Math.round((computed.stabilizedValue - computed.totalDev) * 0.20) : 0; // ~20% effective tax on gains

    // 4. Mello-Roos
    const melloRoos = MELLO_ROOS_DISTRICTS[nh] || { active: false };
    const annualMelloRoos = melloRoos.active
        ? (computed.units ? computed.units * melloRoos.annualPerUnit : computed.gsf * melloRoos.annualPerSF)
        : 0;

    // 5. School Impact Fees
    const schoolFee = computed.gsf * (isResidential ? SCHOOL_IMPACT_FEES.residential : SCHOOL_IMPACT_FEES.commercial);

    // 6. Construction Tax
    const constructionTax = computed.totalHard > CONSTRUCTION_TAX.threshold
        ? computed.totalHard * CONSTRUCTION_TAX.rate : 0;

    // 7. Cost Segregation (accelerated depreciation)
    const depreciableBase = computed.totalHard + computed.totalSoft;
    const straightLineDepr = depreciableBase / (isResidential ? 27.5 : 39); // MACRS
    const costSegBenefit = depreciableBase * 0.25; // ~25% can be reclassified to 5/7/15 year
    const yearOneDepr = costSegBenefit * 0.20 + (depreciableBase - costSegBenefit) / (isResidential ? 27.5 : 39);
    const yearOneTaxSavings = yearOneDepr * 0.37; // top marginal rate

    // 8. After-tax IRR
    const tl = TIMELINE_MONTHS[useId] || { entitlement: 6, design: 4, permits: 3, construction: 18, leaseup: 6 };
    const totalMo = tl.entitlement + tl.design + tl.permits + tl.construction + tl.leaseup;
    const preIRR = approxIRR(computed.devMargin, totalMo);
    const effectiveTaxRate = 0.25; // blended federal+state for CRE
    const afterTaxMargin = computed.devMargin * (1 - effectiveTaxRate) + (isOZ ? 0.03 : 0) + (yearOneTaxSavings / computed.totalDev);
    const afterTaxIRR = approxIRR(afterTaxMargin, totalMo);

    return {
        currentTax, postDevTax, taxIncrease, taxProjection,
        ulaTax, ulaRate, baseTranferTax, totalTransferTax, salePrice,
        isOZ, ozBenefit,
        melloRoos, annualMelloRoos,
        schoolFee, constructionTax,
        depreciableBase, straightLineDepr, costSegBenefit, yearOneDepr, yearOneTaxSavings,
        preIRR, afterTaxIRR, effectiveTaxRate,
    };
}

function renderTaxIncentivesTab(st) {
    const { bestUse, inp, computed } = st;
    const tax = analyzeTaxImplications(bestUse, inp, computed);
    const nh = inp.neighborhood;

    let html = `<div class="deep-tab-panel">`;

    // Prop 13 Reassessment
    html += `<div class="analysis-section"><h3>Property Tax â€” Prop 13 Reassessment</h3>
        <div class="exec-summary-grid">
            <div class="exec-summary-card">
                <h4>Current Est. Property Tax</h4>
                <div class="exec-metric-lg">${formatCompactDollars(tax.currentTax)}<span style="font-size:0.6em;color:var(--text-light)">/yr</span></div>
            </div>
            <div class="exec-summary-card">
                <h4>Post-Development Tax</h4>
                <div class="exec-metric-lg" style="color:#c53030;">${formatCompactDollars(tax.postDevTax)}<span style="font-size:0.6em;color:var(--text-light)">/yr</span></div>
                <div class="exec-metric-sub">+${formatCompactDollars(tax.taxIncrease)}/yr increase</div>
            </div>
        </div>`;

    html += `<h4 style="font-size:0.85rem;color:var(--primary);margin:1rem 0 0.5rem;">10-Year Property Tax & NOI Projection</h4>`;
    html += `<table class="tax-timeline-table"><thead><tr>
        <th>Year</th>`;
    for (let y = 1; y <= 10; y++) html += `<th>${y}</th>`;
    html += `</tr></thead><tbody><tr><td>Property Tax</td>`;
    for (const p of tax.taxProjection) html += `<td>${formatCompactDollars(p.tax)}</td>`;
    html += `</tr><tr><td>Gross NOI</td>`;
    for (const p of tax.taxProjection) html += `<td>${formatCompactDollars(p.noi)}</td>`;
    html += `</tr><tr style="font-weight:700;color:var(--primary);"><td>After-Tax NOI</td>`;
    for (const p of tax.taxProjection) html += `<td>${formatCompactDollars(p.afterTaxNOI)}</td>`;
    html += `</tr></tbody></table></div>`;

    // Transfer Tax & Measure ULA
    html += `<div class="analysis-section"><h3>Transfer Tax & Measure ULA</h3>
        <div class="exec-summary-grid">
            <div class="exec-summary-card">
                <h4>Base Transfer Tax</h4>
                <div class="exec-metric-lg">${formatCompactDollars(tax.baseTranferTax)}</div>
                <div class="exec-metric-sub">County + City documentary transfer tax</div>
            </div>
            <div class="exec-summary-card">
                <h4>Measure ULA (Mansion Tax)</h4>
                <div class="exec-metric-lg" style="color:${tax.ulaTax > 0 ? '#c53030' : '#276749'}">${tax.ulaTax > 0 ? formatCompactDollars(tax.ulaTax) : 'Not Applicable'}</div>
                <div class="exec-metric-sub">${tax.ulaTax > 0 ? `${(tax.ulaRate * 100).toFixed(1)}% on sales > $${(tax.ulaRate === 0.055 ? '10M' : '5M')}` : 'Sale price under $5M threshold'}</div>
            </div>
        </div>`;
    if (tax.ulaTax > 0) {
        html += `<div style="background:#fff5f5;border:1px solid #fc8181;border-radius:8px;padding:0.75rem 1rem;margin-top:0.75rem;font-size:0.85rem;">
            <strong>ULA Impact:</strong> Measure ULA adds <strong>${formatCompactDollars(tax.ulaTax)}</strong> to disposition costs (${(tax.ulaTax / tax.salePrice * 100).toFixed(1)}% of sale price). This significantly impacts exit economics. Consider structuring as a long-term hold or ground lease to mitigate.
        </div>`;
    }
    html += `</div>`;

    // Tax Incentives Grid
    html += `<div class="analysis-section"><h3>Available Tax Incentives</h3>`;

    // Opportunity Zone
    html += `<div class="tax-incentive-card">
        <h5>Opportunity Zone (OZ)</h5>
        <span class="${tax.isOZ ? 'eligible' : 'ineligible'}">${tax.isOZ ? 'ELIGIBLE' : 'NOT IN OZ TRACT'}</span>
        ${tax.isOZ ? `<p style="font-size:0.82rem;margin-top:0.4rem;">10-year hold eliminates capital gains tax on post-investment appreciation. Estimated tax savings: <strong>${formatCompactDollars(tax.ozBenefit)}</strong> (assuming ${(0.20 * 100).toFixed(0)}% effective cap gains rate).</p>` : `<p style="font-size:0.82rem;margin-top:0.4rem;color:var(--text-light);">${nh} is not within a designated Opportunity Zone census tract.</p>`}
    </div>`;

    // Mello-Roos
    html += `<div class="tax-incentive-card">
        <h5>Mello-Roos / CFD Assessment</h5>
        <span class="${tax.melloRoos.active ? 'maybe' : 'eligible'}">${tax.melloRoos.active ? 'ACTIVE CFD â€” ADDS TO COSTS' : 'NO ACTIVE CFD'}</span>
        ${tax.melloRoos.active ? `<p style="font-size:0.82rem;margin-top:0.4rem;">Annual CFD assessment: <strong>${formatCompactDollars(tax.annualMelloRoos)}/yr</strong>. This reduces effective NOI and should be factored into operating expenses.</p>` : `<p style="font-size:0.82rem;margin-top:0.4rem;color:var(--text-light);">No active Community Facilities District assessments detected in this area.</p>`}
    </div>`;

    // Historic Tax Credits
    html += `<div class="tax-incentive-card">
        <h5>Historic Tax Credits (Federal 20%)</h5>
        <span class="${inp.constHistoric ? 'maybe' : 'ineligible'}">${inp.constHistoric ? 'POTENTIALLY ELIGIBLE' : 'NOT IN HISTORIC OVERLAY'}</span>
        <p style="font-size:0.82rem;margin-top:0.4rem;">${inp.constHistoric ? 'Property is in a historic overlay zone. Rehabilitation projects may qualify for 20% federal historic tax credit on qualifying expenditures.' : 'Site is not in a designated historic district. Federal historic tax credits are not available.'}</p>
    </div>`;

    html += `</div>`;

    // Development Fees
    html += `<div class="analysis-section"><h3>Development Impact Fees</h3>
        <table class="market-comp-table"><thead><tr>
            <th>Fee Category</th><th>Rate</th><th>Amount</th>
        </tr></thead><tbody>
            <tr><td>School Impact Fee (LAUSD)</td><td>$${SCHOOL_IMPACT_FEES[['sfr','duplex','multifamily_low','multifamily_mid','multifamily_high','mixeduse','senior','adu'].includes(bestUse) ? 'residential' : 'commercial']}/SF</td><td>${fmt(tax.schoolFee)}</td></tr>
            <tr><td>Construction Tax</td><td>2% of hard costs</td><td>${tax.constructionTax > 0 ? fmt(tax.constructionTax) : 'Exempt'}</td></tr>
            ${tax.annualMelloRoos > 0 ? `<tr><td>Mello-Roos CFD (annual)</td><td>Per unit/SF</td><td>${fmt(tax.annualMelloRoos)}/yr</td></tr>` : ''}
        </tbody></table>
    </div>`;

    // Cost Segregation
    html += `<div class="analysis-section"><h3>Cost Segregation & Depreciation</h3>
        <div class="exec-summary-grid">
            <div class="exec-summary-card">
                <h4>Straight-Line Depreciation</h4>
                <div class="exec-metric-lg">${formatCompactDollars(tax.straightLineDepr)}<span style="font-size:0.6em;color:var(--text-light)">/yr</span></div>
                <div class="exec-metric-sub">${['sfr','duplex','multifamily_low','multifamily_mid','multifamily_high','mixeduse','senior','adu'].includes(bestUse) ? '27.5-year' : '39-year'} MACRS</div>
            </div>
            <div class="exec-summary-card">
                <h4>Year 1 with Cost Seg</h4>
                <div class="exec-metric-lg" style="color:#276749;">${formatCompactDollars(tax.yearOneDepr)}</div>
                <div class="exec-metric-sub">Tax savings: ${formatCompactDollars(tax.yearOneTaxSavings)} at 37% marginal rate</div>
            </div>
        </div>
        <div style="font-size:0.82rem;color:var(--text-light);margin-top:0.5rem;">
            Cost segregation study reclassifies ~25% of depreciable basis (${formatCompactDollars(tax.costSegBenefit)}) to shorter 5/7/15-year recovery periods, accelerating tax deductions.
        </div>
    </div>`;

    // After-Tax IRR Summary
    html += `<div class="tax-summary-banner">
        <h4>After-Tax Returns Summary</h4>
        <div class="exec-summary-grid">
            <div class="exec-summary-card" style="background:white;">
                <h4>Pre-Tax IRR</h4>
                <div class="exec-metric-lg">${(tax.preIRR * 100).toFixed(1)}%</div>
            </div>
            <div class="exec-summary-card" style="background:white;">
                <h4>After-Tax IRR</h4>
                <div class="exec-metric-lg" style="color:#276749;">${(tax.afterTaxIRR * 100).toFixed(1)}%</div>
                <div class="exec-metric-sub">Incorporating depreciation${tax.isOZ ? ', OZ benefits' : ''}, and ${(tax.effectiveTaxRate * 100).toFixed(0)}% blended rate</div>
            </div>
        </div>
    </div>`;

    html += `</div>`;
    return html;
}


// ============================================================
//  SKILL 30: UNIT MIX OPTIMIZER
// ============================================================

const UNIT_MIX_PROFILES = {
    // Default optimal mix by neighborhood character
    dtla:         { studio: 0.30, br1: 0.40, br2: 0.25, br3: 0.05 },
    hollywood:    { studio: 0.25, br1: 0.40, br2: 0.28, br3: 0.07 },
    koreatown:    { studio: 0.22, br1: 0.38, br2: 0.30, br3: 0.10 },
    westside:     { studio: 0.15, br1: 0.35, br2: 0.35, br3: 0.15 },
    santamonica:  { studio: 0.18, br1: 0.37, br2: 0.32, br3: 0.13 },
    beverly:      { studio: 0.12, br1: 0.30, br2: 0.38, br3: 0.20 },
    midcity:      { studio: 0.20, br1: 0.38, br2: 0.30, br3: 0.12 },
    southla:      { studio: 0.10, br1: 0.28, br2: 0.38, br3: 0.24 },
    valleyeast:   { studio: 0.10, br1: 0.30, br2: 0.35, br3: 0.25 },
    valleywest:   { studio: 0.12, br1: 0.30, br2: 0.35, br3: 0.23 },
    silverlake:   { studio: 0.22, br1: 0.40, br2: 0.28, br3: 0.10 },
    highland:     { studio: 0.15, br1: 0.35, br2: 0.32, br3: 0.18 },
    venice:       { studio: 0.18, br1: 0.38, br2: 0.32, br3: 0.12 },
    culver:       { studio: 0.18, br1: 0.38, br2: 0.30, br3: 0.14 },
    exposition:   { studio: 0.20, br1: 0.35, br2: 0.30, br3: 0.15 },
    southbay:     { studio: 0.10, br1: 0.28, br2: 0.38, br3: 0.24 },
    harbor:       { studio: 0.08, br1: 0.25, br2: 0.40, br3: 0.27 },
    boyleheights: { studio: 0.10, br1: 0.30, br2: 0.35, br3: 0.25 },
};

// Average SF per unit type
const UNIT_SIZES = {
    studio: 475,
    br1: 720,
    br2: 1050,
    br3: 1350,
};

// Skill 37: Extended unit types (custom unit builder)
const EXTENDED_UNIT_TYPES = {
    micro:     { label: 'Micro Unit',   sf: 300,  rentMult: 0.72, absorb: 1.3, desc: '300 SF efficiency unit, popular in transit-rich urban areas' },
    loft:      { label: 'Loft',         sf: 900,  rentMult: 1.15, absorb: 0.9, desc: '900 SF open-plan loft, premium finish, creative professional market' },
    penthouse: { label: 'Penthouse',    sf: 1500, rentMult: 2.20, absorb: 0.5, desc: '1,500 SF top-floor premium unit with private outdoor space' },
    townhouse: { label: 'Townhome',     sf: 1400, rentMult: 1.45, absorb: 0.7, desc: '1,400 SF 2-story attached unit, direct entry, private garage' },
};

const AMENITY_SPACE_RATIOS = {
    pool_deck:  { label: 'Pool Deck',       sfPerUnit: 8,   costPSF: 120, revenueImpact: 0.03 },
    gym:        { label: 'Fitness Center',   sfPerUnit: 6,   costPSF: 85,  revenueImpact: 0.02 },
    coworking:  { label: 'Co-Working Lounge',sfPerUnit: 5,   costPSF: 65,  revenueImpact: 0.02 },
    rooftop:    { label: 'Rooftop Terrace',  sfPerUnit: 10,  costPSF: 95,  revenueImpact: 0.03 },
    lobby:      { label: 'Grand Lobby',      sfPerUnit: 4,   costPSF: 110, revenueImpact: 0.01 },
    mailroom:   { label: 'Package Room',     sfPerUnit: 2,   costPSF: 45,  revenueImpact: 0.005 },
};

const COMMON_AREA_FACTOR = 0.18; // 18% of GSF is corridors, stairs, elevators, mechanical
const BALCONY_SF = { studio: 0, br1: 50, br2: 75, br3: 100, micro: 0, loft: 60, penthouse: 200, townhouse: 120 };

// Absorption speed multiplier by unit type and neighborhood character
const ABSORPTION_BY_TYPE = {
    urban:    { studio: 1.2, br1: 1.0, br2: 0.8, br3: 0.6 }, // DTLA, Hollywood, Koreatown
    suburban: { studio: 0.7, br1: 0.9, br2: 1.1, br3: 1.2 }, // Valley, South Bay, Harbor
    mixed:    { studio: 0.9, br1: 1.0, br2: 1.0, br3: 0.9 }, // Mid-City, Westside, Culver
};

const URBAN_NEIGHBORHOODS = ['dtla', 'hollywood', 'koreatown', 'silverlake', 'boyleheights'];
const SUBURBAN_NEIGHBORHOODS = ['valleyeast', 'valleywest', 'southbay', 'harbor', 'southla'];

function calculateUnitMix(useId, inp, computed, mixOverride) {
    const params = BUILDING_PARAMS[useId];
    if (!params || !params.unitSF || !computed.units) return null;

    const nh = inp.neighborhood;
    const profile = mixOverride || UNIT_MIX_PROFILES[nh] || UNIT_MIX_PROFILES.dtla;
    const rents = MARKET_RENTS_2025[nh] || MARKET_RENTS_2025.dtla;
    const totalUnits = computed.units;

    const neighborhoodType = URBAN_NEIGHBORHOODS.includes(nh) ? 'urban' : (SUBURBAN_NEIGHBORHOODS.includes(nh) ? 'suburban' : 'mixed');
    const absorptionProfile = ABSORPTION_BY_TYPE[neighborhoodType];

    // Calculate unit counts
    const studioCount = Math.round(totalUnits * profile.studio);
    const br1Count = Math.round(totalUnits * profile.br1);
    const br2Count = Math.round(totalUnits * profile.br2);
    const br3Count = totalUnits - studioCount - br1Count - br2Count; // remainder to avoid rounding errors

    const units = [
        {
            type: 'Studio', key: 'studio', count: studioCount, sf: UNIT_SIZES.studio,
            rent: rents.studio, pctMix: profile.studio,
            psfRent: Math.round(rents.studio * 12 / UNIT_SIZES.studio * 10) / 10,
            absorptionMult: absorptionProfile.studio,
        },
        {
            type: '1-Bedroom', key: 'br1', count: br1Count, sf: UNIT_SIZES.br1,
            rent: rents.br1, pctMix: profile.br1,
            psfRent: Math.round(rents.br1 * 12 / UNIT_SIZES.br1 * 10) / 10,
            absorptionMult: absorptionProfile.br1,
        },
        {
            type: '2-Bedroom', key: 'br2', count: br2Count, sf: UNIT_SIZES.br2,
            rent: rents.br2, pctMix: profile.br2,
            psfRent: Math.round(rents.br2 * 12 / UNIT_SIZES.br2 * 10) / 10,
            absorptionMult: absorptionProfile.br2,
        },
        {
            type: '3-Bedroom', key: 'br3', count: Math.max(0, br3Count), sf: UNIT_SIZES.br3,
            rent: rents.br3, pctMix: profile.br3,
            psfRent: Math.round(rents.br3 * 12 / UNIT_SIZES.br3 * 10) / 10,
            absorptionMult: absorptionProfile.br3,
        },
    ];

    // Revenue calculations
    const totalMonthlyRev = units.reduce((sum, u) => sum + u.count * u.rent, 0);
    const totalAnnualRev = totalMonthlyRev * 12;
    const totalSF = units.reduce((sum, u) => sum + u.count * u.sf, 0);
    const weightedAvgRent = totalUnits > 0 ? totalMonthlyRev / totalUnits : 0;
    const weightedAvgPSF = totalSF > 0 ? totalAnnualRev / totalSF : 0;

    // Absorption velocity by unit type
    const absorption = ABSORPTION_DATA[nh] || ABSORPTION_DATA.dtla;
    const baseMonthlyAbsorption = absorption.newSupplyUnits * absorption.residential / 12;
    const stabilizationMonths = [];
    for (const u of units) {
        if (u.count === 0) { stabilizationMonths.push(0); continue; }
        const monthlyAbsorb = Math.max(1, Math.round(baseMonthlyAbsorption * u.absorptionMult * 0.15));
        stabilizationMonths.push(Math.ceil(u.count / monthlyAbsorb));
    }
    const maxStabilization = Math.max(...stabilizationMonths);

    // Rent roll â€” month by month stabilization
    const rentRollMonths = [];
    for (let m = 1; m <= Math.max(maxStabilization, 6); m++) {
        let monthRev = 0;
        let occupiedUnits = 0;
        for (let i = 0; i < units.length; i++) {
            const u = units[i];
            const stabMo = stabilizationMonths[i] || 1;
            const occupied = stabMo > 0 ? Math.min(u.count, Math.round(u.count * m / stabMo)) : u.count;
            monthRev += occupied * u.rent;
            occupiedUnits += occupied;
        }
        const occupancy = totalUnits > 0 ? occupiedUnits / totalUnits : 0;
        rentRollMonths.push({ month: m, revenue: monthRev, occupancy });
    }

    return {
        units, totalUnits, totalMonthlyRev, totalAnnualRev, totalSF,
        weightedAvgRent, weightedAvgPSF,
        stabilizationMonths, maxStabilization,
        rentRollMonths, neighborhoodType,
    };
}

function renderUnitMixTab(st) {
    const { bestUse, inp, computed } = st;
    const mix = calculateUnitMix(bestUse, inp, computed);

    let html = `<div class="deep-tab-panel">`;

    if (!mix) {
        html += `<div class="coming-soon-panel"><div class="icon">N/A</div>
            <h3>Not Applicable</h3>
            <p>Unit mix analysis is only available for residential projects with unit counts.</p>
        </div></div>`;
        return html;
    }

    const nh = inp.neighborhood;
    const nhLabel = nh.charAt(0).toUpperCase() + nh.slice(1);

    // Recommended Mix â€” Editable
    html += `<div class="analysis-section"><h3>Recommended Unit Mix â€” ${nhLabel} (${mix.neighborhoodType})
        <span style="font-size:0.7rem;color:#718096;font-weight:400;margin-left:0.5rem;">Edit unit counts to see impact on revenue</span>
    </h3>`;
    html += `<div class="unit-mix-grid">`;
    const maxPct = Math.max(...mix.units.map(u => u.pctMix));
    for (const u of mix.units) {
        const highlighted = u.pctMix === maxPct ? 'highlighted' : '';
        html += `<div class="unit-mix-card ${highlighted}">
            <div class="unit-pct">${(u.pctMix * 100).toFixed(0)}%</div>
            <div class="unit-type">${u.type}</div>
            <div class="unit-count">
                <input type="number" class="umix-count" id="umix-${u.key}" value="${u.count}" min="0" step="1"
                    style="width:50px;text-align:center;border:1px dashed #cbd5e0;border-radius:4px;padding:2px 4px;font-size:0.82rem;font-weight:600;"
                    oninput="recalcUnitMix()"> units | ~${u.sf} SF
            </div>
            <div class="unit-rent">${fmt(u.rent)}/mo</div>
            <div class="unit-psf">$${u.psfRent}/SF/yr</div>
        </div>`;
    }
    html += `</div></div>`;

    // Revenue per SF comparison
    html += `<div class="analysis-section"><h3>Revenue per SF by Unit Type</h3>`;
    html += `<div style="margin:1rem 0;">`;
    const maxPSF = Math.max(...mix.units.map(u => u.psfRent));
    for (const u of mix.units) {
        const barWidth = maxPSF > 0 ? (u.psfRent / maxPSF * 100) : 0;
        const barColor = u.key === 'studio' ? '#805ad5' : u.key === 'br1' ? '#3182ce' : u.key === 'br2' ? '#38a169' : '#dd6b20';
        html += `<div style="display:flex;align-items:center;margin-bottom:0.5rem;">
            <span style="width:90px;text-align:right;padding-right:0.75rem;font-size:0.82rem;font-weight:600;">${u.type}</span>
            <div style="flex:1;height:20px;background:#edf2f7;border-radius:4px;overflow:hidden;">
                <div style="height:100%;width:${barWidth}%;background:${barColor};border-radius:4px;"></div>
            </div>
            <span style="width:80px;text-align:left;padding-left:0.5rem;font-size:0.82rem;font-weight:700;">$${u.psfRent}/SF</span>
        </div>`;
    }
    html += `</div>`;
    html += `<div style="font-size:0.78rem;color:var(--text-light);">Studios generate the highest revenue per square foot but may absorb slower in suburban/family neighborhoods. Optimize the mix for your target market.</div>`;
    html += `</div>`;

    // Rent Roll
    html += `<div class="analysis-section"><h3>Projected Rent Roll</h3>`;
    html += `<table class="rent-roll-table"><thead><tr>
        <th>Unit Type</th><th>Count</th><th>Avg SF</th><th>Monthly Rent</th><th>Annual Rev</th><th>% of Total</th>
    </tr></thead><tbody>`;
    for (const u of mix.units) {
        if (u.count === 0) continue;
        const annRev = u.count * u.rent * 12;
        const pctTotal = mix.totalAnnualRev > 0 ? annRev / mix.totalAnnualRev : 0;
        html += `<tr>
            <td>${u.type}</td>
            <td>${u.count}</td>
            <td>${u.sf.toLocaleString()}</td>
            <td>${fmt(u.rent)}</td>
            <td>${fmt(annRev)}</td>
            <td>${(pctTotal * 100).toFixed(1)}%</td>
        </tr>`;
    }
    html += `<tr class="total-row">
        <td>Total / Weighted Avg</td>
        <td>${mix.totalUnits}</td>
        <td>${mix.totalSF > 0 ? Math.round(mix.totalSF / mix.totalUnits).toLocaleString() : 'â€”'}</td>
        <td>${fmt(Math.round(mix.weightedAvgRent))}</td>
        <td>${fmt(mix.totalAnnualRev)}</td>
        <td>100%</td>
    </tr>`;
    html += `</tbody></table></div>`;

    // Absorption / Stabilization
    html += `<div class="analysis-section"><h3>Absorption & Stabilization Timeline</h3>`;

    // Stabilization by unit type
    html += `<div class="exec-summary-grid" style="grid-template-columns:repeat(4,1fr);">`;
    for (let i = 0; i < mix.units.length; i++) {
        const u = mix.units[i];
        const mo = mix.stabilizationMonths[i];
        if (u.count === 0) continue;
        html += `<div class="exec-summary-card">
            <h4>${u.type}</h4>
            <div class="exec-metric-lg">${mo} mo</div>
            <div class="exec-metric-sub">${u.count} units to absorb</div>
        </div>`;
    }
    html += `</div>`;

    // Absorption chart
    html += `<h4 style="font-size:0.85rem;color:var(--primary);margin:1rem 0 0.5rem;">Monthly Revenue Ramp-Up</h4>`;
    html += `<div class="absorption-chart">`;
    const maxRev = mix.rentRollMonths.length > 0 ? Math.max(...mix.rentRollMonths.map(m => m.revenue)) : 1;
    for (const m of mix.rentRollMonths) {
        const pctH = maxRev > 0 ? (m.revenue / maxRev * 100) : 0;
        const color = m.occupancy >= 0.95 ? '#38a169' : m.occupancy >= 0.70 ? '#ecc94b' : '#3182ce';
        html += `<div class="absorption-bar" style="height:${pctH}%;background:${color};">
            <span class="bar-value">${(m.occupancy * 100).toFixed(0)}%</span>
            <span class="bar-label">M${m.month}</span>
        </div>`;
    }
    html += `</div>`;
    html += `<div style="font-size:0.75rem;color:var(--text-light);text-align:center;margin-top:1.25rem;">Bars show occupancy %. Blue = ramp-up, Yellow = approaching stabilization, Green = stabilized (95%+)</div>`;

    html += `<div style="background:#f0fff4;border:1px solid #9ae6b4;border-radius:8px;padding:0.75rem 1rem;margin-top:1rem;font-size:0.85rem;">
        <strong>Stabilization:</strong> Project reaches 95%+ occupancy in approximately <strong>${mix.maxStabilization} months</strong> after initial lease-up begins.
        Monthly revenue at stabilization: <strong>${fmt(mix.totalMonthlyRev)}/month</strong> | Annual: <strong>${fmt(mix.totalAnnualRev)}/year</strong>.
    </div>`;
    html += `</div>`;

    // Revenue Optimization Summary
    html += `<div class="analysis-section"><h3>Revenue Optimization Summary</h3>
        <div class="exec-summary-grid">
            <div class="exec-summary-card">
                <h4>Weighted Avg Rent</h4>
                <div class="exec-metric-lg">${fmt(Math.round(mix.weightedAvgRent))}<span style="font-size:0.6em;color:var(--text-light)">/mo</span></div>
                <div class="exec-metric-sub">${mix.totalUnits} units</div>
            </div>
            <div class="exec-summary-card">
                <h4>Weighted Avg $/SF/yr</h4>
                <div class="exec-metric-lg">$${mix.weightedAvgPSF.toFixed(1)}</div>
                <div class="exec-metric-sub">${mix.totalSF.toLocaleString()} total SF</div>
            </div>
            <div class="exec-summary-card">
                <h4>Annual Gross Revenue</h4>
                <div class="exec-metric-lg">${formatCompactDollars(mix.totalAnnualRev)}</div>
            </div>
            <div class="exec-summary-card">
                <h4>Time to Stabilize</h4>
                <div class="exec-metric-lg">${mix.maxStabilization} mo</div>
            </div>
        </div>
    </div>`;

    // Skill 37: Extended Unit Types & Amenity Space
    const rents = MARKET_RENTS_2025[nh] || MARKET_RENTS_2025.dtla;
    const baseRent = rents.br1; // use 1BR as baseline

    html += `<div class="analysis-section"><h3>Custom Unit Type Analysis</h3>
        <p style="font-size:0.82rem;color:var(--text-light);margin-bottom:1rem;">Beyond the standard mix, these specialty unit types can enhance revenue or absorption in specific submarkets.</p>
        <table class="code-matrix"><thead><tr>
            <th>Unit Type</th><th>Avg SF</th><th>Est. Rent/mo</th><th>$/SF/yr</th><th>Absorption</th><th>Best Fit</th>
        </tr></thead><tbody>`;

    for (const [key, ext] of Object.entries(EXTENDED_UNIT_TYPES)) {
        const estRent = Math.round(baseRent * ext.rentMult);
        const psfRent = Math.round(estRent * 12 / ext.sf * 10) / 10;
        const absLabel = ext.absorb >= 1.0 ? 'Fast' : ext.absorb >= 0.7 ? 'Moderate' : 'Slow';
        const absColor = ext.absorb >= 1.0 ? '#276749' : ext.absorb >= 0.7 ? '#b7791f' : '#c53030';
        const balcony = BALCONY_SF[key] || 0;
        html += `<tr>
            <td><strong>${ext.label}</strong></td>
            <td>${ext.sf.toLocaleString()} SF${balcony > 0 ? ` + ${balcony} balcony` : ''}</td>
            <td>${fmt(estRent)}</td>
            <td>$${psfRent}</td>
            <td style="color:${absColor};font-weight:600;">${absLabel}</td>
            <td style="font-size:0.78rem;">${ext.desc}</td>
        </tr>`;
    }
    html += `</tbody></table></div>`;

    // Amenity Space Allocation
    const totalUnits = mix.totalUnits;
    html += `<div class="analysis-section"><h3>Amenity Space Allocation</h3>
        <p style="font-size:0.82rem;color:var(--text-light);margin-bottom:1rem;">Recommended amenity program for ${totalUnits}-unit project. Amenities increase achievable rents and reduce vacancy.</p>
        <table class="code-matrix"><thead><tr>
            <th>Amenity</th><th>Alloc. SF</th><th>Build Cost</th><th>Revenue Impact</th>
        </tr></thead><tbody>`;

    let totalAmenitySF = 0;
    let totalAmenityCost = 0;
    let totalRevImpact = 0;
    for (const [key, am] of Object.entries(AMENITY_SPACE_RATIOS)) {
        const sf = Math.round(totalUnits * am.sfPerUnit);
        const cost = Math.round(sf * am.costPSF);
        const revImpact = am.revenueImpact;
        totalAmenitySF += sf;
        totalAmenityCost += cost;
        totalRevImpact += revImpact;
        html += `<tr>
            <td>${am.label}</td>
            <td>${sf.toLocaleString()} SF</td>
            <td>${formatCompactDollars(cost)}</td>
            <td style="color:#276749;">+${(revImpact * 100).toFixed(1)}% rent premium</td>
        </tr>`;
    }
    html += `<tr style="font-weight:700;background:#f7fafc;">
        <td>Total Amenity Program</td>
        <td>${totalAmenitySF.toLocaleString()} SF</td>
        <td>${formatCompactDollars(totalAmenityCost)}</td>
        <td style="color:#276749;">+${(totalRevImpact * 100).toFixed(1)}% combined premium</td>
    </tr>`;
    html += `</tbody></table>`;

    // Common area & circulation
    const circulationSF = Math.round(computed.gsf * COMMON_AREA_FACTOR);
    html += `<div style="background:#f8fafc;border:1px solid var(--border);border-radius:8px;padding:0.75rem 1rem;margin-top:0.75rem;font-size:0.85rem;">
        <strong>Space Allocation:</strong> Of ${computed.gsf.toLocaleString()} GSF, approximately <strong>${circulationSF.toLocaleString()} SF</strong> (${(COMMON_AREA_FACTOR * 100).toFixed(0)}%) is common area/circulation,
        <strong>${totalAmenitySF.toLocaleString()} SF</strong> is amenity space, and <strong>${mix.totalSF.toLocaleString()} SF</strong> is net leasable residential area.
    </div>`;
    html += `</div>`;

    html += `</div>`;
    return html;
}


function recalcUnitMix() {
    if (!deepAnalysisState) return;
    _debouncedCall('unitMix', _recalcUnitMixImpl, 150);
}
function _recalcUnitMixImpl() {
    if (!deepAnalysisState) return;
    var st = deepAnalysisState;
    // Read edited unit counts
    var studioEl = document.getElementById('umix-studio');
    var br1El = document.getElementById('umix-br1');
    var br2El = document.getElementById('umix-br2');
    var br3El = document.getElementById('umix-br3');
    if (!studioEl) return;

    var s = parseInt(studioEl.value) || 0;
    var b1 = parseInt(br1El.value) || 0;
    var b2 = parseInt(br2El.value) || 0;
    var b3 = parseInt(br3El.value) || 0;
    var total = s + b1 + b2 + b3;
    if (total <= 0) return;

    // Create a mix override with proportions based on edited counts
    var mixOverride = {
        studio: s / total,
        br1: b1 / total,
        br2: b2 / total,
        br3: b3 / total,
    };

    // Override total units in computed
    var modComputed = Object.assign({}, st.computed, { units: total });

    // Recalculate unit mix with override
    var mix = calculateUnitMix(st.bestUse, st.inp, modComputed, mixOverride);
    if (!mix) return;

    // Update the rent roll table
    var rollTable = document.querySelector('.rent-roll-table tbody');
    if (rollTable) {
        var rhtml = '';
        for (var i = 0; i < mix.units.length; i++) {
            var u = mix.units[i];
            if (u.count === 0) continue;
            var annRev = u.count * u.rent * 12;
            var pctTotal = mix.totalAnnualRev > 0 ? annRev / mix.totalAnnualRev : 0;
            rhtml += '<tr><td>' + u.type + '</td><td>' + u.count + '</td><td>' + u.sf.toLocaleString() + '</td><td>$' + u.rent.toLocaleString() + '</td><td>$' + annRev.toLocaleString() + '</td><td>' + (pctTotal * 100).toFixed(1) + '%</td></tr>';
        }
        rhtml += '<tr class="total-row"><td>Total / Weighted Avg</td><td>' + mix.totalUnits + '</td><td>' + (mix.totalSF > 0 ? Math.round(mix.totalSF / mix.totalUnits).toLocaleString() : 'â€”') + '</td><td>$' + Math.round(mix.weightedAvgRent).toLocaleString() + '</td><td>$' + mix.totalAnnualRev.toLocaleString() + '</td><td>100%</td></tr>';
        rollTable.innerHTML = rhtml;
    }

    // Update revenue summary cards
    var summCards = document.querySelectorAll('.deep-tab-panel .exec-summary-card .exec-metric-lg');
    // These are in the Revenue Optimization Summary section â€” tricky to target precisely.
    // Instead, store the custom mix for when user navigates away and back
    if (!st.customUnitMix) st.customUnitMix = {};
    st.customUnitMix = mixOverride;
    st.customUnitMixTotal = total;
}

// ============================================================
//  SKILL 26: Construction Type & Code Compliance
// ============================================================

const IBC_CONSTRUCTION_TYPES = {
    // key: "stories_occupancy" => { type, description }
    // Simplified matrix for LA common scenarios
    '1_R': { type: 'V-B', desc: 'Wood-frame, unprotected' },
    '2_R': { type: 'V-A', desc: 'Wood-frame, 1-hr protected' },
    '3_R': { type: 'V-A', desc: 'Wood-frame, 1-hr protected' },
    '4_R': { type: 'III-A', desc: 'Heavy timber/wood over concrete podium' },
    '5_R': { type: 'III-A', desc: '5-over-1 podium (wood over Type I)' },
    '6_R': { type: 'I-A', desc: 'Concrete or steel frame' },
    '7_R': { type: 'I-A', desc: 'Concrete or steel frame' },
    '10_R': { type: 'I-A', desc: 'Concrete or steel frame' },
    '18_R': { type: 'I-A', desc: 'Concrete or steel high-rise' },
    '1_B': { type: 'V-B', desc: 'Wood-frame, unprotected' },
    '2_B': { type: 'V-A', desc: 'Wood-frame, 1-hr protected' },
    '3_B': { type: 'III-A', desc: 'Wood-frame or light steel' },
    '4_B': { type: 'III-A', desc: 'Heavy timber or podium' },
    '5_B': { type: 'II-B', desc: 'Non-combustible, unprotected' },
    '6_B': { type: 'II-A', desc: 'Non-combustible, 1-hr protected' },
    '7_B': { type: 'I-B', desc: 'Steel or concrete frame' },
    '10_B': { type: 'I-A', desc: 'Steel or concrete high-rise' },
    '1_M': { type: 'V-B', desc: 'Wood-frame, unprotected' },
    '2_M': { type: 'V-A', desc: 'Wood-frame, 1-hr protected' },
    '3_M': { type: 'III-A', desc: 'Non-combustible or podium' },
    '1_S': { type: 'II-B', desc: 'Non-combustible, unprotected' },
    '2_S': { type: 'II-B', desc: 'Non-combustible, unprotected' },
    '4_S': { type: 'II-A', desc: 'Non-combustible, protected' },
    '1_F': { type: 'II-B', desc: 'Non-combustible, unprotected' },
    '1_I': { type: 'I-B', desc: 'Steel or concrete frame' },
    '4_I': { type: 'I-A', desc: 'Concrete or steel frame' },
    '5_I': { type: 'I-A', desc: 'Concrete or steel high-rise' },
    '10_I': { type: 'I-A', desc: 'Concrete or steel high-rise' },
    '1_A': { type: 'I-A', desc: 'Assembly â€” non-combustible' },
};

const OCCUPANCY_GROUPS = {
    sfr: 'R-3',
    duplex: 'R-3',
    multifamily_low: 'R-2',
    multifamily_mid: 'R-2',
    multifamily_high: 'R-2',
    mixeduse: 'R-2/M',
    retail: 'M',
    office: 'B',
    medical: 'B/I-2',
    hotel: 'R-1',
    industrial: 'F-1',
    selfstorage: 'S-1',
    senior: 'R-2/I-1',
    parking: 'S-2',
    creative: 'B',
    adu: 'R-3',
};

const TITLE24_COSTS = {
    sfr: 4.50,
    duplex: 4.50,
    multifamily_low: 5.25,
    multifamily_mid: 5.75,
    multifamily_high: 6.50,
    mixeduse: 6.00,
    retail: 3.80,
    office: 4.50,
    medical: 5.50,
    hotel: 6.25,
    industrial: 2.50,
    selfstorage: 1.80,
    senior: 5.75,
    parking: 0.50,
    creative: 3.50,
    adu: 4.00,
};

const CALGREEN_REQS = {
    tier1: {
        label: 'CALGreen Mandatory',
        costPSF: 2.50,
        requirements: ['20% water reduction', '50% C&D waste diversion', 'Low-VOC materials', 'EV-ready parking'],
    },
    tier2: {
        label: 'CALGreen Tier 1 (Voluntary)',
        costPSF: 5.00,
        requirements: ['25% water reduction', '65% C&D waste diversion', '15% recycled content', '10% more efficient than T24'],
        threshold: 50000,
    },
    tier3: {
        label: 'CALGreen Tier 2 (Voluntary)',
        costPSF: 8.50,
        requirements: ['30% water reduction', '80% C&D waste diversion', '20% recycled content', '20% more efficient than T24', 'On-site renewable energy'],
        threshold: 100000,
    },
};

const CONSTRUCTION_TYPE_COSTS_PSF = {
    'V-B': { low: 140, high: 220, label: 'Type V-B (Wood-frame, unprotected)',
        maxStories: '2-3', duration: '12-16 mo', insuranceClass: 'Frame',
        structuralNotes: 'Platform framing, no fire protection required',
        ibcRef: 'IBC Table 601, 602', sprinklerBonus: '+1 story with NFPA 13',
        typicalUse: 'Garden-style apartments, townhomes' },
    'V-A': { low: 170, high: 270, label: 'Type V-A (Wood-frame, 1-hr rated)',
        maxStories: '3-4', duration: '14-18 mo', insuranceClass: 'Frame â€” Protected',
        structuralNotes: '1-hr rated assemblies on structural members, fire-retardant treated wood optional',
        ibcRef: 'IBC Table 601, 602; CBC 2301', sprinklerBonus: '+1 story with NFPA 13R',
        typicalUse: 'Low-rise apartments, senior living' },
    'III-A': { low: 220, high: 350, label: 'Type III-A (Podium/heavy timber)',
        maxStories: '5 (podium to 7)', duration: '18-24 mo', insuranceClass: 'Joisted Masonry â€” Protected',
        structuralNotes: 'Wood-frame over Type I concrete podium; 1-hr rated interior, non-combustible exterior walls',
        ibcRef: 'IBC Table 601, 504.4; LAMC 91.510', sprinklerBonus: '+2 stories with NFPA 13',
        typicalUse: 'Mid-rise podium apartments, mixed-use' },
    'III-B': { low: 200, high: 320, label: 'Type III-B (Non-combustible exterior)',
        maxStories: '3-4', duration: '16-20 mo', insuranceClass: 'Joisted Masonry',
        structuralNotes: 'Non-combustible exterior walls, wood interior framing, no fire rating on interior',
        ibcRef: 'IBC Table 601, 602', sprinklerBonus: '+1 story with NFPA 13',
        typicalUse: 'Low-rise commercial, light industrial' },
    'II-B': { low: 180, high: 300, label: 'Type II-B (Non-combustible, unprotected)',
        maxStories: '3-5', duration: '16-20 mo', insuranceClass: 'Non-combustible',
        structuralNotes: 'Light-gauge steel or non-combustible framing, no fireproofing required',
        ibcRef: 'IBC Table 601, 602', sprinklerBonus: '+1 story with NFPA 13',
        typicalUse: 'Warehouses, retail, offices' },
    'II-A': { low: 220, high: 360, label: 'Type II-A (Non-combustible, 1-hr rated)',
        maxStories: '5-6', duration: '18-24 mo', insuranceClass: 'Non-combustible â€” Protected',
        structuralNotes: 'Non-combustible with 1-hr rated assemblies; steel frame with spray fireproofing or intumescent paint',
        ibcRef: 'IBC Table 601, 602; ASTM E119', sprinklerBonus: '+1 story with NFPA 13',
        typicalUse: 'Mid-rise apartments, offices, hotels' },
    'I-B': { low: 320, high: 500, label: 'Type I-B (Steel/concrete, 2-hr rated)',
        maxStories: '12+', duration: '24-36 mo', insuranceClass: 'Fire-resistive',
        structuralNotes: 'Structural steel frame with 2-hr fireproofing or reinforced concrete; moment frames for seismic',
        ibcRef: 'IBC Table 601, Section 403; AISC 360', sprinklerBonus: 'Unlimited height with NFPA 13',
        typicalUse: 'High-rise residential, Class A office, hotels' },
    'I-A': { low: 400, high: 650, label: 'Type I-A (Steel/concrete, 3-hr rated)',
        maxStories: 'Unlimited', duration: '30-48 mo', insuranceClass: 'Fire-resistive â€” Superior',
        structuralNotes: 'Reinforced concrete or steel moment frame with 3-hr fireproofing; highest structural redundancy',
        ibcRef: 'IBC Table 601, Section 403; ACI 318', sprinklerBonus: 'Unlimited height with NFPA 13',
        typicalUse: 'Supertall towers, hospitals, essential facilities' },
};

const FIRE_RATING_BY_TYPE = {
    'V-B': 0, 'V-A': 1, 'III-B': 0, 'III-A': 1, 'II-B': 0, 'II-A': 1, 'I-B': 2, 'I-A': 3,
};

const STRUCTURAL_SYSTEMS = {
    'V-B': 'Wood-frame (platform framing)',
    'V-A': 'Wood-frame with 1-hr rated assemblies',
    'III-A': 'Podium â€” wood-frame over Type I concrete podium',
    'III-B': 'Non-combustible exterior walls, wood interior',
    'II-B': 'Light-gauge steel or non-combustible framing',
    'II-A': 'Non-combustible with 1-hr rated assemblies',
    'I-B': 'Structural steel frame with 2-hr fireproofing',
    'I-A': 'Reinforced concrete or steel moment frame (3-hr)',
};

// ============================================================
//  CSI MASTERFORMAT DIVISION COST BREAKDOWN
// ============================================================

/**
 * CSI MasterFormat 2020 Divisions mapped to typical % of hard construction cost.
 * Percentages are base allocations for a mid-rise multifamily (Type III-A, 5-story).
 * Adjusted dynamically for construction type, stories, and use type.
 */
const CSI_DIVISIONS = [
    { div: '01', name: 'General Requirements', basePct: 0.08, desc: 'General conditions, insurance, permits, temp facilities, project management, supervision' },
    { div: '02', name: 'Existing Conditions', basePct: 0.02, desc: 'Demolition, hazmat abatement, site remediation, utility relocation' },
    { div: '03', name: 'Concrete', basePct: 0.10, desc: 'Foundations, slabs, podium deck, columns, retaining walls, reinforcement' },
    { div: '04', name: 'Masonry', basePct: 0.02, desc: 'CMU walls, brick veneer, stone, mortar, reinforced masonry' },
    { div: '05', name: 'Metals', basePct: 0.08, desc: 'Structural steel, metal deck, misc. metals, railings, stairs, lintels' },
    { div: '06', name: 'Wood, Plastics & Composites', basePct: 0.10, desc: 'Framing lumber, engineered wood, sheathing, blocking, millwork, cabinets' },
    { div: '07', name: 'Thermal & Moisture Protection', basePct: 0.06, desc: 'Insulation, waterproofing, roofing, sealants, vapor barriers, fireproofing' },
    { div: '08', name: 'Openings', basePct: 0.06, desc: 'Windows, doors, storefronts, curtain wall, hardware, glazing, frames' },
    { div: '09', name: 'Finishes', basePct: 0.12, desc: 'Drywall, paint, flooring, tile, ceilings, wall coverings, specialties' },
    { div: '10', name: 'Specialties', basePct: 0.02, desc: 'Signage, fire extinguishers, toilet accessories, lockers, postal units' },
    { div: '11', name: 'Equipment', basePct: 0.02, desc: 'Appliances, fitness equipment, laundry equipment, commercial kitchen' },
    { div: '12', name: 'Furnishings', basePct: 0.01, desc: 'Window treatments, common area furniture, countertops, casework' },
    { div: '13', name: 'Special Construction', basePct: 0.01, desc: 'Swimming pools, green roofs, modular units, clean rooms' },
    { div: '14', name: 'Conveying Equipment', basePct: 0.03, desc: 'Elevators, escalators, dumbwaiters' },
    { div: '21', name: 'Fire Suppression', basePct: 0.03, desc: 'Sprinkler systems (NFPA 13/13R), standpipes, fire pump' },
    { div: '22', name: 'Plumbing', basePct: 0.06, desc: 'Domestic water, sanitary waste, gas piping, fixtures, water heaters' },
    { div: '23', name: 'HVAC', basePct: 0.08, desc: 'Heating, ventilation, air conditioning, ductwork, controls, split systems' },
    { div: '26', name: 'Electrical', basePct: 0.08, desc: 'Power distribution, panels, wiring, lighting, generators, solar PV' },
    { div: '27', name: 'Communications', basePct: 0.01, desc: 'Low-voltage, data/telecom, AV, intercom, access control' },
    { div: '28', name: 'Electronic Safety & Security', basePct: 0.01, desc: 'Fire alarm, security cameras, access control, emergency systems' },
];

/**
 * Compute CSI division cost breakdown for a specific project.
 * Adjusts base percentages based on construction type, stories, and use type.
 */
function computeCSIBreakdown(useId, computed, constructionType, stories) {
    var totalConstruction = computed.construction || 0;
    var gsf = computed.gsf || 1;
    var divisions = [];

    for (var i = 0; i < CSI_DIVISIONS.length; i++) {
        var d = CSI_DIVISIONS[i];
        var pct = d.basePct;

        // --- Adjust by CONSTRUCTION TYPE ---
        if (constructionType === 'I-A' || constructionType === 'I-B') {
            // Steel/concrete high-rise: more concrete, steel, fireproofing; less wood
            if (d.div === '03') pct = 0.18;    // heavy concrete
            if (d.div === '05') pct = 0.14;    // more structural steel
            if (d.div === '06') pct = 0.02;    // minimal wood
            if (d.div === '07') pct = 0.07;    // more fireproofing
            if (d.div === '14') pct = 0.05;    // more/faster elevators
            if (d.div === '01') pct = 0.10;    // higher GCs for high-rise
        } else if (constructionType === 'II-A' || constructionType === 'II-B') {
            // Non-combustible mid-rise
            if (d.div === '03') pct = 0.14;
            if (d.div === '05') pct = 0.12;
            if (d.div === '06') pct = 0.04;
        } else if (constructionType === 'III-A') {
            // Podium: concrete base + wood upper
            if (d.div === '03') pct = 0.12;
            if (d.div === '06') pct = 0.11;
        } else if (constructionType === 'V-A' || constructionType === 'V-B') {
            // Wood frame: heavy wood, minimal concrete/steel
            if (d.div === '03') pct = 0.06;
            if (d.div === '05') pct = 0.04;
            if (d.div === '06') pct = 0.16;
        }

        // --- Adjust by STORIES ---
        if (stories >= 8) {
            if (d.div === '14') pct = Math.max(pct, 0.05);  // multiple elevators
            if (d.div === '21') pct = Math.max(pct, 0.04);  // fire pump + standpipe
            if (d.div === '23') pct = Math.max(pct, 0.09);  // central plant HVAC
        }
        if (stories <= 3 && d.div === '14') pct = 0;  // no elevators

        // --- Adjust by USE TYPE ---
        if (useId === 'hotel') {
            if (d.div === '09') pct = 0.14;  // higher finish quality
            if (d.div === '11') pct = 0.04;  // FF&E heavy
            if (d.div === '12') pct = 0.03;  // more furnishings
        }
        if (useId === 'office') {
            if (d.div === '23') pct = 0.10;  // more HVAC
            if (d.div === '26') pct = 0.10;  // more electrical/data
            if (d.div === '09') pct = 0.10;
        }
        if (useId === 'retail' || useId === 'mixeduse') {
            if (d.div === '08') pct = 0.08;  // more storefronts/glazing
        }
        if (useId === 'industrial' || useId === 'warehouse') {
            if (d.div === '09') pct = 0.04;  // minimal finishes
            if (d.div === '03') pct = 0.15;  // heavy slab
            if (d.div === '05') pct = 0.18;  // steel structure
            if (d.div === '06') pct = 0.01;
        }
        if (useId === 'senior') {
            if (d.div === '14') pct = Math.max(pct, 0.04);  // more elevators
            if (d.div === '11') pct = 0.03;  // nurse call, medical
        }

        var cost = Math.round(totalConstruction * pct);
        divisions.push({
            div: d.div,
            name: d.name,
            desc: d.desc,
            pct: pct,
            cost: cost,
            costPSF: cost / gsf,
        });
    }

    // Normalize: ensure allocations sum to 100% of construction cost
    var allocatedTotal = divisions.reduce(function(s, d) { return s + d.cost; }, 0);
    if (allocatedTotal > 0 && Math.abs(allocatedTotal - totalConstruction) > 100) {
        var scale = totalConstruction / allocatedTotal;
        for (var j = 0; j < divisions.length; j++) {
            divisions[j].cost = Math.round(divisions[j].cost * scale);
            divisions[j].pct = divisions[j].pct * scale;
            divisions[j].costPSF = divisions[j].cost / gsf;
        }
    }

    return divisions;
}

/**
 * Render CSI MasterFormat breakdown as an HTML table.
 * @param {Array} divisions - from computeCSIBreakdown
 * @param {number} totalConstruction - total construction cost for % calc
 * @param {number} gsf - gross SF
 * @param {string} constructionType - e.g. 'III-A'
 */
function renderCSIBreakdownTable(divisions, totalConstruction, gsf, constructionType) {
    var fmt = function(v) { return '$' + Math.round(v).toLocaleString(); };
    var html = '';
    html += '<table style="width:100%;font-size:0.75rem;border-collapse:collapse;margin-top:0.5rem;">';
    html += '<thead><tr style="background:#edf2f7;font-weight:600;">';
    html += '<th style="padding:5px 8px;text-align:left;">Div</th>';
    html += '<th style="padding:5px 8px;text-align:left;">Trade / Division</th>';
    html += '<th style="padding:5px 8px;text-align:right;">% of Total</th>';
    html += '<th style="padding:5px 8px;text-align:right;">$/GSF</th>';
    html += '<th style="padding:5px 8px;text-align:right;">Cost</th>';
    html += '<th style="padding:5px 8px;text-align:left;">Scope Description</th>';
    html += '</tr></thead><tbody>';

    var grandTotal = 0;
    for (var i = 0; i < divisions.length; i++) {
        var d = divisions[i];
        if (d.cost <= 0) continue;
        grandTotal += d.cost;
        var bgColor = i % 2 === 0 ? '#fff' : '#f7fafc';
        // Color-code the percentage bar
        var barWidth = Math.min(100, Math.round(d.pct * 100 / 0.20 * 100));
        var barColor = d.pct >= 0.12 ? '#e53e3e' : d.pct >= 0.08 ? '#dd6b20' : d.pct >= 0.05 ? '#ecc94b' : '#48bb78';
        html += '<tr style="background:' + bgColor + ';">';
        html += '<td style="padding:4px 8px;font-weight:600;color:#4a5568;">' + d.div + '</td>';
        html += '<td style="padding:4px 8px;font-weight:500;">' + d.name + '</td>';
        html += '<td style="padding:4px 8px;text-align:right;"><div style="display:flex;align-items:center;justify-content:flex-end;gap:4px;"><div style="width:40px;height:6px;background:#edf2f7;border-radius:3px;overflow:hidden;"><div style="width:' + barWidth + '%;height:100%;background:' + barColor + ';border-radius:3px;"></div></div><span>' + (d.pct * 100).toFixed(1) + '%</span></div></td>';
        html += '<td style="padding:4px 8px;text-align:right;">$' + d.costPSF.toFixed(0) + '</td>';
        html += '<td style="padding:4px 8px;text-align:right;font-weight:500;">' + fmt(d.cost) + '</td>';
        html += '<td style="padding:4px 8px;font-size:0.68rem;color:#718096;">' + d.desc + '</td>';
        html += '</tr>';
    }
    // Total row
    html += '<tr style="font-weight:700;border-top:2px solid #cbd5e0;background:#edf2f7;">';
    html += '<td style="padding:5px 8px;" colspan="2">Total Construction (' + constructionType + ')</td>';
    html += '<td style="padding:5px 8px;text-align:right;">100%</td>';
    html += '<td style="padding:5px 8px;text-align:right;">$' + Math.round(grandTotal / gsf) + '</td>';
    html += '<td style="padding:5px 8px;text-align:right;">' + fmt(grandTotal) + '</td>';
    html += '<td style="padding:5px 8px;font-size:0.68rem;color:#718096;">CSI MasterFormat 2020 Divisions</td>';
    html += '</tr>';
    html += '</tbody></table>';
    return html;
}

function analyzeConstructionType(useId, inp, computed) {
    const params = BUILDING_PARAMS[useId];
    const stories = computed.stories || params.stories;
    const gsf = computed.gsf || 0;
    const occGroup = OCCUPANCY_GROUPS[useId] || 'B';
    const occLetter = occGroup.charAt(0);

    // Find closest match in IBC matrix
    const storyKeys = [stories, Math.min(stories, 18), Math.min(stories, 10), Math.min(stories, 7), Math.min(stories, 5), Math.min(stories, 4), Math.min(stories, 3), Math.min(stories, 2), 1];
    let ibcMatch = null;
    for (const sk of storyKeys) {
        const key = sk + '_' + occLetter;
        if (IBC_CONSTRUCTION_TYPES[key]) {
            ibcMatch = IBC_CONSTRUCTION_TYPES[key];
            break;
        }
    }
    if (!ibcMatch) {
        ibcMatch = stories >= 6 ? { type: 'I-A', desc: 'Concrete or steel frame' } : { type: 'V-A', desc: 'Wood-frame, 1-hr protected' };
    }

    const constructionType = ibcMatch.type;
    const structuralSystem = STRUCTURAL_SYSTEMS[constructionType] || 'Standard framing';
    const costRange = CONSTRUCTION_TYPE_COSTS_PSF[constructionType] || { low: 200, high: 400 };
    const costPSF = Math.round((costRange.low + costRange.high) / 2);
    const fireRating = FIRE_RATING_BY_TYPE[constructionType] || 0;
    const sprinklerRequired = stories >= 4 || gsf > 5000 || ['R-1', 'R-2', 'I-1', 'I-2'].some(g => occGroup.includes(g));

    // Stairwells and elevators (per IBC egress)
    const occupantLoad = gsf / (['R-2', 'R-3', 'R-1'].some(g => occGroup.includes(g)) ? 200 : occGroup.includes('B') ? 150 : 100);
    const stairwellCount = Math.max(2, Math.ceil(occupantLoad / 250));
    const elevatorCount = stories <= 3 ? 0 : stories <= 7 ? Math.max(1, Math.ceil(computed.units ? computed.units / 80 : gsf / 25000)) : Math.max(2, Math.ceil(computed.units ? computed.units / 60 : gsf / 20000));

    // ADA compliance
    const isResidential = ['sfr', 'duplex', 'multifamily_low', 'multifamily_mid', 'multifamily_high', 'mixeduse', 'senior', 'adu'].includes(useId);
    // ADA/FHA/CBC accessibility requirements:
    // - FHA: all units on elevator-served floors must be "adaptable" (reinforced walls, accessible route, etc.)
    //   But "adaptable" != "fully accessible" â€” it's a design standard, not a wheelchair requirement
    // - CBC Chapter 11A: minimum 5% of units fully accessible (wheelchair), min 2% communication accessible (hearing/vision)
    // - If no elevator: only ground-floor units need adaptable features (~20-25% of units)
    var totalUnits = computed.units || 0;
    var fullyAccessiblePct = 5; // CBC Chapter 11A minimum
    var communicationAccessiblePct = 2; // CBC hearing/vision
    var adaptablePct = 0;
    if (isResidential && totalUnits >= 4) {
        if (stories >= 4 || elevatorCount > 0) {
            adaptablePct = 100;  // FHA: all units on elevator-served floors must be adaptable (design standard)
        } else {
            adaptablePct = Math.min(100, Math.round(100 / stories)); // ground floor only (~25-50%)
        }
    }
    var fullyAccessibleUnits = Math.max(1, Math.ceil(totalUnits * fullyAccessiblePct / 100));
    var commAccessibleUnits = Math.max(1, Math.ceil(totalUnits * communicationAccessiblePct / 100));
    const totalParking = computed.parkingSpaces || 0;
    const accessibleParking = totalParking <= 25 ? Math.min(totalParking, 1) : totalParking <= 50 ? 2 : totalParking <= 75 ? 3 : totalParking <= 100 ? 4 : Math.min(Math.ceil(totalParking * 0.04), 20);
    const pathOfTravelCost = Math.round(gsf * 1.25);

    // Title 24 energy
    const title24Cost = TITLE24_COSTS[useId] || 4.00;
    const title24Total = Math.round(gsf * title24Cost);

    // CalGreen tier
    let calgreenTier = 'tier1';
    if (gsf >= 100000) calgreenTier = 'tier3';
    else if (gsf >= 50000) calgreenTier = 'tier2';
    const calgreenData = CALGREEN_REQS[calgreenTier];
    const calgreenCost = Math.round(gsf * calgreenData.costPSF);

    // Seismic (all of LA is SDC D minimum, near-fault areas SDC E)
    const seismicCategory = inp.constFault ? 'E' : 'D';
    const seismicBasePremium = seismicCategory === 'E' ? 0.12 : 0.06;
    const seismicStoryMultiplier = stories >= 10 ? 1.5 : stories >= 6 ? 1.2 : 1.0;
    const seismicPremium = Math.round(seismicBasePremium * seismicStoryMultiplier * 100) / 100;
    const seismicCost = Math.round(computed.totalHard * seismicPremium);

    const adaTotal = pathOfTravelCost + (accessibleParking * 2500);
    const totalCodeComplianceCost = title24Total + calgreenCost + seismicCost + adaTotal;

    return {
        constructionType,
        constructionTypeLabel: CONSTRUCTION_TYPE_COSTS_PSF[constructionType] ? CONSTRUCTION_TYPE_COSTS_PSF[constructionType].label : constructionType,
        constructionTypeDesc: ibcMatch.desc,
        occupancyGroup: occGroup,
        structuralSystem,
        costPSF,
        costRange,
        fireRating,
        sprinklerRequired,
        stairwellCount,
        elevatorCount,
        adaCompliance: { adaptablePct, fullyAccessiblePct, fullyAccessibleUnits, commAccessibleUnits, accessibleParking, pathOfTravelCost, total: adaTotal },
        title24Cost,
        title24Total,
        calgreenTier,
        calgreenLabel: calgreenData.label,
        calgreenRequirements: calgreenData.requirements,
        calgreenCost,
        seismicCategory,
        seismicPremium,
        seismicCost,
        totalCodeComplianceCost,
        stories,
        gsf,
    };
}

// Construction tab cost multiplier
var constructionCostMult = 1.0;
var constructionTypeOverride = null; // null = auto-detect from IBC

function recalcConstruction() {
    // Immediate: sync slider display
    var el = document.getElementById('cc-costMult');
    if (el) constructionCostMult = parseFloat(el.value) / 100;
    var slider = document.getElementById('cc-costMult-slider');
    var num = document.getElementById('cc-costMult');
    if (slider && num && document.activeElement === slider) num.value = slider.value;
    if (slider && num && document.activeElement === num) slider.value = num.value;
    var valSpan = document.getElementById('cc-costMult-val');
    if (valSpan && num) valSpan.textContent = parseFloat(num.value).toFixed(0) + '%';
    // Debounced: heavy content rebuild
    _debouncedCall('construction', function() {
        var container = document.getElementById('constructionContent');
        if (container && deepAnalysisState) {
            container.innerHTML = buildConstructionContent(deepAnalysisState);
        }
    }, 150);
}

function resetConstruction() {
    constructionCostMult = 1.0;
    constructionTypeOverride = null;
    var slider = document.getElementById('cc-costMult-slider');
    var num = document.getElementById('cc-costMult');
    if (slider) slider.value = 100;
    if (num) num.value = 100;
    var sel = document.getElementById('cc-typeOverride');
    if (sel) sel.value = 'auto';
    recalcConstruction();
}

function onConstructionTypeChange() {
    var sel = document.getElementById('cc-typeOverride');
    constructionTypeOverride = (sel && sel.value !== 'auto') ? sel.value : null;
    recalcConstruction();
}

function toggleConstructionRow(rowEl) {
    var detailId = rowEl.getAttribute('data-detail-id');
    var detailRow = document.getElementById(detailId);
    if (!detailRow) return;
    var isVisible = detailRow.style.display !== 'none';
    // Hide all detail rows first
    document.querySelectorAll('.ct-detail-row').forEach(function(r) { r.style.display = 'none'; });
    document.querySelectorAll('.ct-clickable-row').forEach(function(r) { r.classList.remove('ct-row-expanded'); });
    if (!isVisible) {
        detailRow.style.display = 'table-row';
        rowEl.classList.add('ct-row-expanded');
    }
}

function buildConstructionContent(st) {
    const { bestUse, inp, computed } = st;
    const ccAuto = analyzeConstructionType(bestUse, inp, computed);
    // If user overrides construction type, recompute cost data for that type
    var activeType = constructionTypeOverride || ccAuto.constructionType;
    var activeCostData = CONSTRUCTION_TYPE_COSTS_PSF[activeType] || CONSTRUCTION_TYPE_COSTS_PSF[ccAuto.constructionType];
    var activeCostPSF = Math.round((activeCostData.low + activeCostData.high) / 2);
    var activeFireRating = FIRE_RATING_BY_TYPE[activeType] || 0;
    var activeStructural = STRUCTURAL_SYSTEMS[activeType] || ccAuto.structuralSystem;
    var isOverridden = constructionTypeOverride && constructionTypeOverride !== ccAuto.constructionType;
    // Use the auto-computed cc for non-cost fields (occupancy, stories, gsf, code compliance, etc.)
    var cc = ccAuto;
    var m = constructionCostMult;

    var html = '';
    // Construction Type Overview
    var overrideNote = isOverridden ? '<div style="font-size:0.72rem;color:#b7791f;margin-top:0.25rem;">What-if override â€” auto-detected: ' + cc.constructionType + '</div>' : '';
    html += `<div class="analysis-section"><h3>IBC Construction Type Classification</h3>
        <div class="exec-summary-grid">
            <div class="exec-summary-card">
                <h4>Construction Type</h4>
                <div class="exec-metric-lg">${activeType}</div>
                <div class="exec-metric-sub">${activeCostData.label.replace('Type ' + activeType + ' ', '')}${overrideNote}</div>
            </div>
            <div class="exec-summary-card">
                <h4>Occupancy Group</h4>
                <div class="exec-metric-lg">${cc.occupancyGroup}</div>
                <div class="exec-metric-sub">${cc.stories}-story, ${cc.gsf.toLocaleString()} GSF</div>
            </div>
            <div class="exec-summary-card">
                <h4>Cost Range (per SF)</h4>
                <div class="exec-metric-lg">${fmt(Math.round(activeCostPSF * m))}<span style="font-size:0.6em;color:var(--text-light)">/SF</span></div>
                <div class="exec-metric-sub">${fmt(Math.round(activeCostData.low * m))} â€“ ${fmt(Math.round(activeCostData.high * m))} range</div>
            </div>
            <div class="exec-summary-card">
                <h4>Total Code Compliance</h4>
                <div class="exec-metric-lg">${formatCompactDollars(Math.round(cc.totalCodeComplianceCost * m))}</div>
                <div class="exec-metric-sub">$${Math.round(cc.totalCodeComplianceCost * m / (cc.gsf || 1)).toLocaleString()}/SF adder</div>
            </div>
        </div>
    </div>`;

    html += `<div class="analysis-section"><h3>Structural System</h3>
        <div style="background:#f8fafc;border:1px solid var(--border);border-radius:8px;padding:1rem 1.25rem;margin-bottom:1rem;">
            <div style="font-size:1rem;font-weight:700;color:var(--primary);margin-bottom:0.35rem;">${activeStructural}</div>
            <div style="font-size:0.85rem;color:var(--text-light);">
                Based on ${cc.stories} stories, ${cc.occupancyGroup} occupancy, and IBC ${activeType} classification.
                ${cc.stories >= 5 ? 'Podium or steel/concrete framing required above 4 stories of wood-frame construction per IBC limits.' : ''}
                ${cc.stories >= 8 ? 'High-rise provisions apply (IBC Section 403): standby power, additional stairwell, fire command center.' : ''}
            </div>
        </div>`;

    html += `<h4 style="font-size:0.88rem;color:var(--primary);margin-bottom:0.75rem;">Construction Type Cost Comparison <span style="font-size:0.72rem;color:var(--text-light);font-weight:400;margin-left:0.5rem;">Click row for details</span></h4>`;
    html += `<div style="overflow-x:auto;"><table class="afford-comparison-table" style="border-collapse:collapse;"><thead><tr>
        <th>Type</th><th>Description</th><th>Cost/SF Range</th><th>Max Stories*</th><th>Fire Rating</th><th>Duration</th><th>Typical Use</th>
    </tr></thead><tbody>`;
    const typeRowKeys = ['V-B', 'V-A', 'III-A', 'II-A', 'I-B', 'I-A'];
    for (var ti = 0; ti < typeRowKeys.length; ti++) {
        var tKey = typeRowKeys[ti];
        var data = CONSTRUCTION_TYPE_COSTS_PSF[tKey];
        var isActive = tKey === activeType;
        var rating = FIRE_RATING_BY_TYPE[tKey] || 0;
        var detailId = 'ct-detail-' + ti;
        html += `<tr class="ct-clickable-row" data-detail-id="${detailId}" onclick="toggleConstructionRow(this)" style="cursor:pointer;${isActive ? 'background:#f0fff4;font-weight:600;' : ''}">
            <td>${tKey}${isActive ? ' &#10004;' : ''}</td>
            <td style="font-size:0.82rem;">${data.label.replace('Type ' + tKey + ' ', '')}</td>
            <td>${fmt(Math.round(data.low * m))} â€“ ${fmt(Math.round(data.high * m))}</td>
            <td>${data.maxStories}</td><td>${rating}-hr</td>
            <td style="font-size:0.82rem;">${data.duration}</td>
            <td style="font-size:0.82rem;">${data.typicalUse}</td>
        </tr>`;
        html += `<tr id="${detailId}" class="ct-detail-row" style="display:none;">
            <td colspan="7" style="padding:0.75rem 1rem;background:#f7fafc;border-left:3px solid var(--primary);">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem 1.5rem;font-size:0.82rem;">
                    <div><strong>Structural Notes:</strong> ${data.structuralNotes}</div>
                    <div><strong>IBC Reference:</strong> ${data.ibcRef}</div>
                    <div><strong>Insurance Class:</strong> ${data.insuranceClass}</div>
                    <div><strong>Sprinkler Bonus:</strong> ${data.sprinklerBonus}</div>
                </div>
            </td>
        </tr>`;
    }
    html += `</tbody></table></div>`;
    html += `<div style="font-size:0.75rem;color:var(--text-light);margin-top:0.35rem;">*Max stories with sprinklers and allowable area increases per IBC Table 504.4.</div>`;
    html += `</div>`;

    html += `<div class="analysis-section"><h3>Fire & Life Safety</h3>
        <div class="exec-summary-grid">
            <div class="exec-summary-card"><h4>Fire Rating</h4><div class="exec-metric-lg">${activeFireRating}-hr</div><div class="exec-metric-sub">Structural fire resistance</div></div>
            <div class="exec-summary-card"><h4>Sprinklers</h4><div class="exec-metric-lg" style="color:${cc.sprinklerRequired ? '#c53030' : '#276749'}">${cc.sprinklerRequired ? 'Required' : 'Not Required'}</div><div class="exec-metric-sub">${cc.sprinklerRequired ? 'NFPA 13 / 13R throughout' : 'Per local LAFD amendment'}</div></div>
            <div class="exec-summary-card"><h4>Stairwells</h4><div class="exec-metric-lg">${cc.stairwellCount}</div><div class="exec-metric-sub">Required exit stairways</div></div>
            <div class="exec-summary-card"><h4>Elevators</h4><div class="exec-metric-lg">${cc.elevatorCount}</div><div class="exec-metric-sub">${cc.elevatorCount > 0 ? 'Passenger + fire service' : 'Not required (low-rise)'}</div></div>
        </div>
    </div>`;

    html += `<div class="analysis-section"><h3>ADA / Accessibility Compliance</h3>
        <div class="exec-summary-grid">
            <div class="exec-summary-card"><h4>Adaptable Units (FHA)</h4><div class="exec-metric-lg">${cc.adaCompliance.adaptablePct}%</div><div class="exec-metric-sub">${cc.adaCompliance.adaptablePct === 100 ? 'All units on elevator-served floors' : cc.adaCompliance.adaptablePct > 0 ? 'Ground-floor units only' : 'N/A'}</div></div>
            <div class="exec-summary-card"><h4>Fully Accessible (CBC)</h4><div class="exec-metric-lg">${cc.adaCompliance.fullyAccessiblePct}% (${cc.adaCompliance.fullyAccessibleUnits} units)</div><div class="exec-metric-sub">CBC Ch. 11A: wheelchair-accessible units</div></div>
            <div class="exec-summary-card"><h4>Communication Accessible</h4><div class="exec-metric-lg">2% (${cc.adaCompliance.commAccessibleUnits} units)</div><div class="exec-metric-sub">CBC: hearing/vision accessible</div></div>
            <div class="exec-summary-card"><h4>Accessible Parking</h4><div class="exec-metric-lg">${cc.adaCompliance.accessibleParking}</div><div class="exec-metric-sub">of ${computed.parkingSpaces || 0} total spaces</div></div>
        </div>
    </div>`;

    html += `<div class="analysis-section"><h3>Energy & Sustainability</h3>
        <div class="exec-summary-grid">
            <div class="exec-summary-card"><h4>Title 24 Energy Cost</h4><div class="exec-metric-lg">${formatCompactDollars(Math.round(cc.title24Total * m))}</div><div class="exec-metric-sub">$${(cc.title24Cost * m).toFixed(2)}/SF</div></div>
            <div class="exec-summary-card"><h4>CALGreen Tier</h4><div class="exec-metric-lg" style="font-size:1rem;">${cc.calgreenLabel}</div><div class="exec-metric-sub">${formatCompactDollars(Math.round(cc.calgreenCost * m))} compliance cost</div></div>
        </div>
    </div>`;

    const seismicColor = cc.seismicCategory === 'E' ? '#c53030' : '#b7791f';
    html += `<div class="analysis-section"><h3>Seismic Design</h3>
        <div class="exec-summary-grid">
            <div class="exec-summary-card"><h4>Seismic Design Category</h4><div class="exec-metric-lg" style="color:${seismicColor}">SDC ${cc.seismicCategory}</div><div class="exec-metric-sub">${cc.seismicCategory === 'E' ? 'Near-fault zone' : 'Standard LA seismic zone'}</div></div>
            <div class="exec-summary-card"><h4>Seismic Cost Premium</h4><div class="exec-metric-lg">${(cc.seismicPremium * 100).toFixed(0)}%</div><div class="exec-metric-sub">${formatCompactDollars(Math.round(cc.seismicCost * m))} added to hard costs</div></div>
        </div>
    </div>`;

    html += `<div class="analysis-section"><h3>Code Compliance Cost Summary</h3>
        <table class="afford-comparison-table"><thead><tr>
            <th>Category</th><th>Cost/SF</th><th>Total</th><th>Notes</th>
        </tr></thead><tbody>
            <tr><td>Title 24 Energy</td><td>$${(cc.title24Cost * m).toFixed(2)}</td><td>${formatCompactDollars(Math.round(cc.title24Total * m))}</td><td>All-electric, solar PV, battery</td></tr>
            <tr><td>CALGreen</td><td>$${(cc.calgreenCost * m / (cc.gsf || 1)).toFixed(2)}</td><td>${formatCompactDollars(Math.round(cc.calgreenCost * m))}</td><td>${cc.calgreenLabel}</td></tr>
            <tr><td>Seismic Premium</td><td>â€”</td><td>${formatCompactDollars(Math.round(cc.seismicCost * m))}</td><td>${(cc.seismicPremium * 100).toFixed(0)}% of hard costs (SDC ${cc.seismicCategory})</td></tr>
            <tr><td>ADA / Accessibility</td><td>â€”</td><td>${formatCompactDollars(Math.round(cc.adaCompliance.total * m))}</td><td>${cc.adaCompliance.accessibleParking} accessible spaces</td></tr>
            <tr style="font-weight:700;border-top:2px solid var(--border);">
                <td>Total Code Compliance</td><td>$${Math.round(cc.totalCodeComplianceCost * m / (cc.gsf || 1)).toLocaleString()}</td><td>${formatCompactDollars(Math.round(cc.totalCodeComplianceCost * m))}</td><td>${(cc.totalCodeComplianceCost * m / (computed.totalDev || 1) * 100).toFixed(1)}% of total dev cost</td>
            </tr>
        </tbody></table>
    </div>`;

    const csiDivisions = computeCSIBreakdown(bestUse, computed, activeType, cc.stories);
    html += `<div class="analysis-section"><h3>Hard Cost Breakdown by Trade â€” CSI MasterFormat</h3>`;
    html += `<p style="font-size:0.78rem;color:var(--text-light);margin-bottom:0.75rem;">Construction cost allocated across CSI MasterFormat 2020 divisions for <strong>${activeType}</strong> construction.</p>`;
    html += renderCSIBreakdownTable(csiDivisions, computed.construction, computed.gsf, activeType);
    html += `</div>`;
    return html;
}

function renderConstructionTab(st) {
    var ccAuto = analyzeConstructionType(st.bestUse, st.inp, st.computed);
    var currentType = constructionTypeOverride || ccAuto.constructionType;
    var typeOptions = ['V-B', 'V-A', 'III-A', 'II-A', 'I-B', 'I-A'];
    var typeSelectHtml = '<select id="cc-typeOverride" onchange="onConstructionTypeChange()" style="padding:4px 8px;border:1px solid #cbd5e0;border-radius:4px;font-size:0.82rem;min-width:160px;">';
    typeSelectHtml += '<option value="auto"' + (!constructionTypeOverride ? ' selected' : '') + '>Auto (' + ccAuto.constructionType + ')</option>';
    for (var i = 0; i < typeOptions.length; i++) {
        var t = typeOptions[i];
        typeSelectHtml += '<option value="' + t + '"' + (constructionTypeOverride === t ? ' selected' : '') + '>' + t + ' â€” ' + CONSTRUCTION_TYPE_COSTS_PSF[t].label.replace('Type ' + t + ' ', '') + '</option>';
    }
    typeSelectHtml += '</select>';

    let html = `<div class="deep-tab-panel">`;

    html += `<div class="dt-controls"><div class="dt-controls-title">Construction Type & Cost Controls <button class="dt-reset-btn" onclick="resetConstruction()">Reset Defaults</button></div>`;
    html += `<div class="dt-controls-grid">`;
    html += `<div class="dt-slider-group">`;
    html += `<div class="dt-slider-label"><span>What-if Construction Type</span></div>`;
    html += `<div style="margin-top:0.25rem;">${typeSelectHtml}</div>`;
    html += `</div>`;
    html += `<div class="dt-slider-group">`;
    html += `<div class="dt-slider-label"><span>Cost Multiplier (market conditions)</span><span class="dt-val" id="cc-costMult-val">100%</span></div>`;
    html += `<div class="dt-slider-row">`;
    html += `<input type="range" id="cc-costMult-slider" min="70" max="140" step="5" value="${Math.round(constructionCostMult * 100)}" oninput="document.getElementById('cc-costMult').value=this.value;recalcConstruction()">`;
    html += `<input type="number" id="cc-costMult" min="70" max="140" step="5" value="${Math.round(constructionCostMult * 100)}" oninput="document.getElementById('cc-costMult-slider').value=this.value;recalcConstruction()">`;
    html += `</div></div></div></div>`;

    html += `<div id="constructionContent">${buildConstructionContent(st)}</div>`;
    html += `</div>`;
    return html;
}


// ============================================================
//  SKILL 29: Community & Political Risk
// ============================================================

const LA_COUNCIL_DISTRICTS = {
    dtla:         { district: 14, name: 'CD 14 â€” Kevin de LeÃ³n',       rep: 'Kevin de LeÃ³n' },
    hollywood:    { district: 13, name: 'CD 13 â€” Hugo Soto-MartÃ­nez',  rep: 'Hugo Soto-MartÃ­nez' },
    koreatown:    { district: 10, name: 'CD 10 â€” Heather Hutt',        rep: 'Heather Hutt' },
    westside:     { district: 11, name: 'CD 11 â€” Traci Park',          rep: 'Traci Park' },
    santamonica:  { district: 11, name: 'CD 11 â€” Traci Park',          rep: 'Traci Park' },
    beverly:      { district: 5,  name: 'CD 5 â€” Katy Young Yaroslavsky', rep: 'Katy Young Yaroslavsky' },
    midcity:      { district: 10, name: 'CD 10 â€” Heather Hutt',        rep: 'Heather Hutt' },
    southla:      { district: 9,  name: 'CD 9 â€” Curren Price',         rep: 'Curren Price' },
    valleyeast:   { district: 6,  name: 'CD 6 â€” Imelda Padilla',       rep: 'Imelda Padilla' },
    valleywest:   { district: 3,  name: 'CD 3 â€” Bob Blumenfield',      rep: 'Bob Blumenfield' },
    silverlake:   { district: 13, name: 'CD 13 â€” Hugo Soto-MartÃ­nez',  rep: 'Hugo Soto-MartÃ­nez' },
    highland:     { district: 1,  name: 'CD 1 â€” Eunisses Hernandez',   rep: 'Eunisses Hernandez' },
    venice:       { district: 11, name: 'CD 11 â€” Traci Park',          rep: 'Traci Park' },
    culver:       { district: 11, name: 'CD 11 â€” Traci Park',          rep: 'Traci Park' },
    exposition:   { district: 8,  name: 'CD 8 â€” Marqueece Harris-Dawson', rep: 'Marqueece Harris-Dawson' },
    southbay:     { district: 15, name: 'CD 15 â€” Tim McOsker',         rep: 'Tim McOsker' },
    harbor:       { district: 15, name: 'CD 15 â€” Tim McOsker',         rep: 'Tim McOsker' },
    boyleheights: { district: 14, name: 'CD 14 â€” Kevin de LeÃ³n',       rep: 'Kevin de LeÃ³n' },
};

const NEIGHBORHOOD_COUNCILS = {
    dtla:         'Downtown Los Angeles NC',
    hollywood:    'Hollywood United NC',
    koreatown:    'Wilshire Center-Koreatown NC',
    westside:     'West Los Angeles NC',
    santamonica:  'N/A (Santa Monica is an independent city)',
    beverly:      'N/A (Beverly Hills is an independent city)',
    midcity:      'Mid City West Community Council',
    southla:      'South Los Angeles NC / Empowerment Congress',
    valleyeast:   'North Hollywood NC / Panorama City NC',
    valleywest:   'Encino NC / Woodland Hills-Warner Center NC',
    silverlake:   'Silver Lake NC',
    highland:     'Highland Park NC / Historic Highland Park NC',
    venice:       'Venice NC',
    culver:       'N/A (Culver City is an independent city)',
    exposition:   'Empowerment Congress North Area NC',
    southbay:     'Harbor Gateway NC',
    harbor:       'Wilmington NC / San Pedro NC',
    boyleheights: 'Boyle Heights NC',
};

const COMMUNITY_PLANS = {
    dtla:         'Central City Community Plan (DTLA 2040)',
    hollywood:    'Hollywood Community Plan',
    koreatown:    'Wilshire Community Plan',
    westside:     'West Los Angeles Community Plan',
    santamonica:  'N/A (Santa Monica General Plan)',
    beverly:      'N/A (Beverly Hills General Plan)',
    midcity:      'Wilshire Community Plan',
    southla:      'South Los Angeles Community Plan',
    valleyeast:   'North Hollywood-Valley Village Community Plan',
    valleywest:   'Encino-Tarzana Community Plan',
    silverlake:   'Silver Lake-Echo Park-Elysian Valley Community Plan',
    highland:     'Northeast Los Angeles Community Plan',
    venice:       'Venice Community Plan (Coastal Zone)',
    culver:       'N/A (Culver City General Plan)',
    exposition:   'South Los Angeles Community Plan',
    southbay:     'Harbor Gateway Community Plan',
    harbor:       'Wilmington-Harbor City Community Plan / San Pedro Community Plan',
    boyleheights: 'Boyle Heights Community Plan',
};

const OPPOSITION_PROFILES = {
    dtla:         { nimbyLevel: 25, activistLevel: 45, litigationHistory: 'moderate', rsoPrevalence: 0.35 },
    hollywood:    { nimbyLevel: 60, activistLevel: 70, litigationHistory: 'high',     rsoPrevalence: 0.55 },
    koreatown:    { nimbyLevel: 40, activistLevel: 55, litigationHistory: 'moderate', rsoPrevalence: 0.60 },
    westside:     { nimbyLevel: 70, activistLevel: 50, litigationHistory: 'high',     rsoPrevalence: 0.40 },
    santamonica:  { nimbyLevel: 75, activistLevel: 60, litigationHistory: 'high',     rsoPrevalence: 0.50 },
    beverly:      { nimbyLevel: 85, activistLevel: 40, litigationHistory: 'high',     rsoPrevalence: 0.25 },
    midcity:      { nimbyLevel: 55, activistLevel: 50, litigationHistory: 'moderate', rsoPrevalence: 0.50 },
    southla:      { nimbyLevel: 30, activistLevel: 60, litigationHistory: 'low',      rsoPrevalence: 0.45 },
    valleyeast:   { nimbyLevel: 35, activistLevel: 35, litigationHistory: 'low',      rsoPrevalence: 0.30 },
    valleywest:   { nimbyLevel: 55, activistLevel: 30, litigationHistory: 'moderate', rsoPrevalence: 0.25 },
    silverlake:   { nimbyLevel: 65, activistLevel: 65, litigationHistory: 'moderate', rsoPrevalence: 0.50 },
    highland:     { nimbyLevel: 50, activistLevel: 55, litigationHistory: 'moderate', rsoPrevalence: 0.35 },
    venice:       { nimbyLevel: 80, activistLevel: 75, litigationHistory: 'high',     rsoPrevalence: 0.45 },
    culver:       { nimbyLevel: 50, activistLevel: 35, litigationHistory: 'moderate', rsoPrevalence: 0.20 },
    exposition:   { nimbyLevel: 30, activistLevel: 50, litigationHistory: 'low',      rsoPrevalence: 0.40 },
    southbay:     { nimbyLevel: 40, activistLevel: 25, litigationHistory: 'low',      rsoPrevalence: 0.15 },
    harbor:       { nimbyLevel: 35, activistLevel: 30, litigationHistory: 'low',      rsoPrevalence: 0.20 },
    boyleheights: { nimbyLevel: 45, activistLevel: 70, litigationHistory: 'moderate', rsoPrevalence: 0.55 },
};

function analyzeCommunityRisk(useId, inp, computed) {
    const nh = inp.neighborhood;
    const params = BUILDING_PARAMS[useId];
    const stories = computed.stories || params.stories;
    const units = computed.units || 0;
    const gsf = computed.gsf || 0;

    const district = LA_COUNCIL_DISTRICTS[nh] || { district: 0, name: 'Unknown', rep: 'Unknown' };
    const neighborhoodCouncil = NEIGHBORHOOD_COUNCILS[nh] || 'Unknown';
    const communityPlan = COMMUNITY_PLANS[nh] || 'Unknown';
    const profile = OPPOSITION_PROFILES[nh] || { nimbyLevel: 40, activistLevel: 40, litigationHistory: 'moderate', rsoPrevalence: 0.30 };

    // Opposition risk scoring
    let oppositionScore = profile.nimbyLevel * 0.4;

    // Scale factor: bigger projects draw more opposition
    if (stories >= 10) oppositionScore += 20;
    else if (stories >= 6) oppositionScore += 12;
    else if (stories >= 4) oppositionScore += 5;

    if (units >= 100) oppositionScore += 15;
    else if (units >= 50) oppositionScore += 8;
    else if (units >= 20) oppositionScore += 3;

    // Sensitive uses
    if (['hotel', 'industrial', 'selfstorage'].includes(useId)) oppositionScore += 10;
    if (useId === 'parking') oppositionScore += 5;

    // Mitigants
    const isResidential = ['sfr', 'duplex', 'multifamily_low', 'multifamily_mid', 'multifamily_high', 'mixeduse', 'senior', 'adu'].includes(useId);
    if (isResidential && units <= 10) oppositionScore -= 10;
    if (useId === 'adu') oppositionScore -= 20;
    if (useId === 'senior') oppositionScore -= 5;

    oppositionScore = Math.max(0, Math.min(100, Math.round(oppositionScore)));

    // CEQA litigation risk
    let ceqaLitigationRisk = 'low';
    if (profile.litigationHistory === 'high' && (stories >= 6 || units >= 50 || gsf >= 50000)) {
        ceqaLitigationRisk = 'high';
    } else if (profile.litigationHistory === 'moderate' && (stories >= 4 || units >= 20)) {
        ceqaLitigationRisk = 'moderate';
    } else if (profile.litigationHistory === 'high') {
        ceqaLitigationRisk = 'moderate';
    }
    // By-right projects have much lower CEQA risk
    if (useId === 'adu' || (units <= 10 && stories <= 3)) {
        ceqaLitigationRisk = 'low';
    }

    // RSO risk
    const rsoRisk = isResidential && profile.rsoPrevalence >= 0.40 && units >= 4;

    // Engagement strategy
    let engagementStrategy = '';
    if (oppositionScore >= 70) {
        engagementStrategy = 'High opposition expected. Recommend early outreach to Neighborhood Council (NC) at least 6 months before filing. Host community meetings, hire a community engagement consultant, and consider design modifications (step-backs, setbacks, open space) to address concerns. Engage Council District office staff early for informal guidance.';
    } else if (oppositionScore >= 45) {
        engagementStrategy = 'Moderate opposition possible. Recommend attending at least 2 NC meetings before filing, presenting project design, and addressing parking/traffic concerns proactively. Provide a community benefits package (local hiring, streetscape improvements) to build goodwill with the Council office.';
    } else if (oppositionScore >= 25) {
        engagementStrategy = 'Low-moderate opposition risk. Standard NC notification and one community meeting should suffice. Focus on demonstrating project compatibility with neighborhood character and Community Plan consistency. Council office likely supportive if project conforms to zoning.';
    } else {
        engagementStrategy = 'Minimal opposition expected. Standard noticing requirements and NC board presentation should be sufficient. By-right projects may not require NC engagement but courtesy notification is recommended.';
    }

    // Risk factors
    const riskFactors = [];
    if (profile.nimbyLevel >= 60) riskFactors.push({ factor: 'High NIMBY Activity', severity: 'high', detail: 'Neighborhood has strong history of organized opposition to new development, particularly density increases.' });
    if (profile.activistLevel >= 60) riskFactors.push({ factor: 'Active Advocacy Groups', severity: 'high', detail: 'Multiple tenant/housing advocacy organizations monitor development activity in this area. Expect scrutiny on affordability, displacement, and labor standards.' });
    if (stories >= 8) riskFactors.push({ factor: 'Height Sensitivity', severity: 'moderate', detail: `${stories}-story building may face opposition on grounds of view impacts, shadow effects, and neighborhood character incompatibility.` });
    if (profile.litigationHistory === 'high') riskFactors.push({ factor: 'CEQA Litigation History', severity: 'high', detail: 'Area has elevated history of CEQA lawsuits. Budget $150K-$500K and 12-18 months for potential litigation defense.' });
    if (rsoRisk) riskFactors.push({ factor: 'RSO/Rent Control Scrutiny', severity: 'moderate', detail: `${(profile.rsoPrevalence * 100).toFixed(0)}% of area rental units are RSO-regulated. Demolition of RSO units triggers Ellis Act provisions, relocation assistance, and one-for-one replacement requirements.` });
    if (inp.constHistoric) riskFactors.push({ factor: 'Historic Preservation Concerns', severity: 'moderate', detail: 'Historic overlay zone. HPOZ board review required. Expect design restrictions and potential appeals from preservation groups.' });
    if (units >= 50 && !isResidential) riskFactors.push({ factor: 'Large Commercial Scale', severity: 'moderate', detail: 'Large non-residential projects face traffic/parking opposition. Prepare a robust traffic impact study.' });
    if (['industrial', 'selfstorage'].includes(useId)) riskFactors.push({ factor: 'Use Type Opposition', severity: 'moderate', detail: 'Industrial and storage uses face neighborhood opposition regarding aesthetics, truck traffic, and perceived "low value" land use.' });

    return {
        councilDistrict: district.district,
        councilDistrictName: district.name,
        councilRep: district.rep,
        neighborhoodCouncil,
        communityPlan,
        oppositionRisk: oppositionScore,
        ceqaLitigationRisk,
        rsoRisk,
        rsoPrevalence: profile.rsoPrevalence,
        engagementStrategy,
        riskFactors,
        nimbyLevel: profile.nimbyLevel,
        activistLevel: profile.activistLevel,
        litigationHistory: profile.litigationHistory,
    };
}

function renderCommunityRiskTab(st) {
    const { bestUse, inp, computed } = st;
    const cr = analyzeCommunityRisk(bestUse, inp, computed);
    const nh = inp.neighborhood;
    const nhLabel = nh.charAt(0).toUpperCase() + nh.slice(1);

    let html = `<div class="deep-tab-panel">`;

    // District & Council Info
    html += `<div class="analysis-section"><h3>Political Geography â€” ${nhLabel}</h3>
        <div class="exec-summary-grid">
            <div class="exec-summary-card">
                <h4>City Council District</h4>
                <div class="exec-metric-lg" style="font-size:1.1rem;">${cr.councilDistrictName}</div>
                <div class="exec-metric-sub">Representative: ${cr.councilRep}</div>
            </div>
            <div class="exec-summary-card">
                <h4>Neighborhood Council</h4>
                <div class="exec-metric-lg" style="font-size:0.95rem;">${cr.neighborhoodCouncil}</div>
                <div class="exec-metric-sub">Advisory body â€” land use committee review</div>
            </div>
            <div class="exec-summary-card">
                <h4>Community Plan</h4>
                <div class="exec-metric-lg" style="font-size:0.9rem;">${cr.communityPlan}</div>
                <div class="exec-metric-sub">LA City Planning area plan</div>
            </div>
        </div>
    </div>`;

    // Opposition Risk Meter
    const oppColor = cr.oppositionRisk >= 70 ? '#c53030' : cr.oppositionRisk >= 45 ? '#b7791f' : cr.oppositionRisk >= 25 ? '#2b6cb0' : '#276749';
    const oppBg = cr.oppositionRisk >= 70 ? '#fc8181' : cr.oppositionRisk >= 45 ? '#ecc94b' : cr.oppositionRisk >= 25 ? '#90cdf4' : '#9ae6b4';
    const oppLabel = cr.oppositionRisk >= 70 ? 'High' : cr.oppositionRisk >= 45 ? 'Moderate' : cr.oppositionRisk >= 25 ? 'Low-Moderate' : 'Low';
    html += `<div class="analysis-section"><h3>Community Opposition Risk</h3>
        <div class="market-support-meter">
            <div class="market-support-bar">
                <div class="market-support-fill" style="width:${cr.oppositionRisk}%;background:${oppBg};"></div>
            </div>
            <div class="market-support-score" style="color:${oppColor}">${cr.oppositionRisk}/100 â€” ${oppLabel}</div>
        </div>
        <div style="font-size:0.82rem;color:var(--text-light);margin-top:0.5rem;">
            NIMBY index: ${cr.nimbyLevel}/100 | Advocacy activity: ${cr.activistLevel}/100 | Litigation history: ${cr.litigationHistory}
        </div>
    </div>`;

    // CEQA & RSO
    const ceqaColor = cr.ceqaLitigationRisk === 'high' ? '#c53030' : cr.ceqaLitigationRisk === 'moderate' ? '#b7791f' : '#276749';
    const ceqaBg = cr.ceqaLitigationRisk === 'high' ? '#fff5f5' : cr.ceqaLitigationRisk === 'moderate' ? '#fffff0' : '#f0fff4';
    html += `<div class="analysis-section"><h3>CEQA & Regulatory Risk</h3>
        <div class="exec-summary-grid">
            <div class="exec-summary-card">
                <h4>CEQA Litigation Risk</h4>
                <div class="exec-metric-lg" style="color:${ceqaColor};text-transform:uppercase;">${cr.ceqaLitigationRisk}</div>
                <div class="exec-metric-sub">
                    ${cr.ceqaLitigationRisk === 'high' ? 'Budget $150K-$500K for litigation defense; 12-18 month delay risk' : cr.ceqaLitigationRisk === 'moderate' ? 'Possible challenge; budget $75K-$150K contingency' : 'Minimal risk; standard CEQA review expected'}
                </div>
            </div>
            <div class="exec-summary-card">
                <h4>RSO / Rent Control Exposure</h4>
                <div class="exec-metric-lg" style="color:${cr.rsoRisk ? '#c53030' : '#276749'}">${cr.rsoRisk ? 'At Risk' : 'Low Risk'}</div>
                <div class="exec-metric-sub">${(cr.rsoPrevalence * 100).toFixed(0)}% of area units under RSO.
                    ${cr.rsoRisk ? ' Demolition of existing RSO units triggers Ellis Act relocation ($8K-$22K/tenant) and replacement requirements.' : ''}
                </div>
            </div>
        </div>
        <div style="background:${ceqaBg};border:1px solid var(--border);border-radius:8px;padding:0.75rem 1rem;margin-top:0.75rem;font-size:0.85rem;">
            <strong>CEQA Pathway:</strong>
            ${cr.ceqaLitigationRisk === 'low' ? 'Project likely qualifies for Categorical Exemption (Class 3 or 32) or Statutory Exemption under SB 35/SB 79 streamlining. Minimal environmental review.' : cr.ceqaLitigationRisk === 'moderate' ? 'Mitigated Negative Declaration (MND) likely required. Key areas of review: traffic, noise during construction, shade/shadow, aesthetics. MND is vulnerable to challenge if significant impacts are disputed.' : 'Environmental Impact Report (EIR) may be required or demanded via appeal. Prepare for challenge on traffic, air quality, GHG, cultural resources, and cumulative impacts. Consider a focused EIR to limit scope and timeline.'}
        </div>
    </div>`;

    // Risk Factors
    if (cr.riskFactors.length > 0) {
        html += `<div class="analysis-section"><h3>Risk Factor Assessment</h3>`;
        for (const rf of cr.riskFactors) {
            const rfColor = rf.severity === 'high' ? '#c53030' : rf.severity === 'moderate' ? '#b7791f' : '#2b6cb0';
            const rfBg = rf.severity === 'high' ? '#fff5f5' : rf.severity === 'moderate' ? '#fffff0' : '#ebf8ff';
            html += `<div style="background:${rfBg};border-left:4px solid ${rfColor};border-radius:0 8px 8px 0;padding:0.75rem 1rem;margin-bottom:0.75rem;">
                <div style="font-weight:700;color:${rfColor};font-size:0.88rem;margin-bottom:0.25rem;">${rf.factor} <span style="font-size:0.75rem;text-transform:uppercase;">(${rf.severity})</span></div>
                <div style="font-size:0.82rem;color:var(--text);">${rf.detail}</div>
            </div>`;
        }
        html += `</div>`;
    }

    // Engagement Strategy
    html += `<div class="analysis-section"><h3>Recommended Engagement Strategy</h3>
        <div style="background:#f8fafc;border:1px solid var(--border);border-radius:8px;padding:1rem 1.25rem;">
            <div style="font-size:0.88rem;color:var(--text);line-height:1.65;">${cr.engagementStrategy}</div>
        </div>
        <div style="margin-top:1rem;">
            <h4 style="font-size:0.85rem;color:var(--primary);margin-bottom:0.5rem;">Engagement Checklist</h4>
            <ul style="font-size:0.85rem;color:var(--text);margin-left:1.25rem;">
                <li style="margin-bottom:0.25rem;">Contact ${cr.councilDistrictName.split(' â€” ')[1] || cr.councilRep}'s planning deputy for informal pre-application meeting</li>
                <li style="margin-bottom:0.25rem;">Present at ${cr.neighborhoodCouncil} Land Use Committee (typically meets monthly)</li>
                <li style="margin-bottom:0.25rem;">Notify adjacent property owners within 500 ft per LAMC 12.27</li>
                ${cr.oppositionRisk >= 45 ? '<li style="margin-bottom:0.25rem;">Host at least one community meeting before filing entitlement applications</li>' : ''}
                ${cr.oppositionRisk >= 70 ? '<li style="margin-bottom:0.25rem;">Retain community engagement consultant and prepare community benefits proposal</li>' : ''}
                ${cr.rsoRisk ? '<li style="margin-bottom:0.25rem;">Conduct RSO tenant survey and prepare Ellis Act compliance / relocation assistance plan</li>' : ''}
                ${cr.ceqaLitigationRisk !== 'low' ? '<li style="margin-bottom:0.25rem;">Engage CEQA counsel early; prepare for potential appeal or litigation</li>' : ''}
                <li style="margin-bottom:0.25rem;">Review ${cr.communityPlan} for consistency and document compliance in planning application</li>
            </ul>
        </div>
    </div>`;

    html += `</div>`;
    return html;
}


// ============================================================
//  SKILL 31: Infrastructure & Utility Assessment
// ============================================================

const POWER_CAPACITY = {
    dtla:         { status: 'constrained', upgradeProb: 0.70, baseUpgradeCost: 150000, transformerMonths: 8  },
    hollywood:    { status: 'constrained', upgradeProb: 0.60, baseUpgradeCost: 120000, transformerMonths: 6  },
    koreatown:    { status: 'constrained', upgradeProb: 0.55, baseUpgradeCost: 110000, transformerMonths: 6  },
    westside:     { status: 'adequate',    upgradeProb: 0.30, baseUpgradeCost: 80000,  transformerMonths: 4  },
    santamonica:  { status: 'adequate',    upgradeProb: 0.25, baseUpgradeCost: 75000,  transformerMonths: 4  },
    beverly:      { status: 'adequate',    upgradeProb: 0.20, baseUpgradeCost: 70000,  transformerMonths: 3  },
    midcity:      { status: 'adequate',    upgradeProb: 0.35, baseUpgradeCost: 90000,  transformerMonths: 5  },
    southla:      { status: 'constrained', upgradeProb: 0.50, baseUpgradeCost: 100000, transformerMonths: 7  },
    valleyeast:   { status: 'adequate',    upgradeProb: 0.30, baseUpgradeCost: 85000,  transformerMonths: 5  },
    valleywest:   { status: 'ample',       upgradeProb: 0.15, baseUpgradeCost: 60000,  transformerMonths: 3  },
    silverlake:   { status: 'adequate',    upgradeProb: 0.35, baseUpgradeCost: 85000,  transformerMonths: 5  },
    highland:     { status: 'adequate',    upgradeProb: 0.30, baseUpgradeCost: 80000,  transformerMonths: 5  },
    venice:       { status: 'adequate',    upgradeProb: 0.35, baseUpgradeCost: 90000,  transformerMonths: 5  },
    culver:       { status: 'adequate',    upgradeProb: 0.25, baseUpgradeCost: 75000,  transformerMonths: 4  },
    exposition:   { status: 'constrained', upgradeProb: 0.45, baseUpgradeCost: 95000,  transformerMonths: 6  },
    southbay:     { status: 'ample',       upgradeProb: 0.15, baseUpgradeCost: 55000,  transformerMonths: 3  },
    harbor:       { status: 'ample',       upgradeProb: 0.10, baseUpgradeCost: 50000,  transformerMonths: 3  },
    boyleheights: { status: 'constrained', upgradeProb: 0.50, baseUpgradeCost: 100000, transformerMonths: 6  },
};

const SEWER_THRESHOLDS = {
    // S-permit trigger: sewer generation exceeding threshold requires LASAN S-permit
    residential:  { gpd_per_unit: 200, s_permit_threshold: 10000 },   // gpd = gallons per day
    commercial:   { gpd_per_1000sf: 150, s_permit_threshold: 10000 },
    hotel:        { gpd_per_room: 175, s_permit_threshold: 10000 },
    industrial:   { gpd_per_1000sf: 100, s_permit_threshold: 10000 },
    medical:      { gpd_per_1000sf: 250, s_permit_threshold: 10000 },
};

const LID_REQUIREMENTS = {
    // LA LID Ordinance: treat/retain 3/4" storm from impervious area
    designStorm: 0.75,        // inches
    retentionFactor: 0.042,   // cu ft per SF of impervious area (3/4" storm)
    bmpCostPerCuFt: 35,       // cost per cubic foot of retention volume
    bmpTypes: {
        'Bioretention/Rain Garden':       { costPSF: 25, applicability: 'All sites with open area' },
        'Permeable Pavement':             { costPSF: 18, applicability: 'Parking areas and driveways' },
        'Underground Infiltration':       { costPSF: 45, applicability: 'Constrained sites, under parking' },
        'Green Roof':                     { costPSF: 30, applicability: 'Low-slope roofs, reduces cooling load' },
        'Dry Well/Infiltration Trench':   { costPSF: 20, applicability: 'Sites with adequate percolation rate' },
    },
};

const EV_CHARGING_REQS = {
    // CalGreen 2025 + LA local code (more stringent)
    residential: {
        evReady: 0.10,         // 10% EV-capable (full circuit)
        evCapable: 0.25,       // 25% with conduit + panel capacity
        evConduit: 1.00,       // 100% with raceway/conduit (new LA amendment)
        level2CostPerSpace: 2500,
        dcfcCostPerUnit: 45000,
    },
    commercial: {
        evReady: 0.06,
        evCapable: 0.20,
        evConduit: 0.40,
        level2CostPerSpace: 3000,
        dcfcCostPerUnit: 55000,
    },
};

const FIRE_FLOW_REQS = {
    // LAFD fire flow requirements (GPM = gallons per minute)
    sfr:              { gpm: 1000, duration: 1, hydrants: 1 },
    duplex:           { gpm: 1500, duration: 1, hydrants: 1 },
    multifamily_low:  { gpm: 2000, duration: 2, hydrants: 2 },
    multifamily_mid:  { gpm: 3000, duration: 2, hydrants: 2 },
    multifamily_high: { gpm: 4000, duration: 4, hydrants: 3 },
    mixeduse:         { gpm: 3000, duration: 2, hydrants: 2 },
    retail:           { gpm: 2000, duration: 2, hydrants: 1 },
    office:           { gpm: 2500, duration: 2, hydrants: 2 },
    medical:          { gpm: 3000, duration: 3, hydrants: 2 },
    hotel:            { gpm: 3500, duration: 3, hydrants: 2 },
    industrial:       { gpm: 3000, duration: 3, hydrants: 2 },
    selfstorage:      { gpm: 2000, duration: 2, hydrants: 1 },
    senior:           { gpm: 2500, duration: 2, hydrants: 2 },
    parking:          { gpm: 1500, duration: 1, hydrants: 1 },
    creative:         { gpm: 2000, duration: 2, hydrants: 1 },
    adu:              { gpm: 1000, duration: 1, hydrants: 1 },
};

const WATER_DEMAND = {
    residential:  { gpd_per_unit: 120 },    // gallons per day
    commercial:   { gpd_per_1000sf: 100 },
    hotel:        { gpd_per_room: 150 },
    industrial:   { gpd_per_1000sf: 75 },
    medical:      { gpd_per_1000sf: 200 },
};

function analyzeInfrastructure(useId, inp, computed) {
    const nh = inp.neighborhood;
    const params = BUILDING_PARAMS[useId];
    const gsf = computed.gsf || 0;
    const nsf = computed.nsf || 0;
    const stories = computed.stories || params.stories;
    const units = computed.units || 0;
    const parkingSpaces = computed.parkingSpaces || 0;

    const isResidential = ['sfr', 'duplex', 'multifamily_low', 'multifamily_mid', 'multifamily_high', 'mixeduse', 'senior', 'adu'].includes(useId);
    const isHotel = useId === 'hotel';
    const isMedical = useId === 'medical';
    const isIndustrial = useId === 'industrial';

    // --- POWER ---
    const powerData = POWER_CAPACITY[nh] || POWER_CAPACITY.dtla;
    const loadFactor = stories >= 10 ? 2.0 : stories >= 6 ? 1.5 : 1.0;
    const bigProject = gsf >= 50000 || units >= 50;
    const upgradeNeeded = bigProject && powerData.status === 'constrained' ? true : (bigProject && powerData.status === 'adequate' ? Math.random() < powerData.upgradeProb : false);
    const upgradeCostPower = upgradeNeeded ? Math.round(powerData.baseUpgradeCost * loadFactor) : 0;
    const transformerTimeline = upgradeNeeded ? powerData.transformerMonths : 0;

    // --- SEWER ---
    let sewerGPD = 0;
    if (isHotel) {
        sewerGPD = units * SEWER_THRESHOLDS.hotel.gpd_per_room;
    } else if (isMedical) {
        sewerGPD = (gsf / 1000) * SEWER_THRESHOLDS.medical.gpd_per_1000sf;
    } else if (isIndustrial) {
        sewerGPD = (gsf / 1000) * SEWER_THRESHOLDS.industrial.gpd_per_1000sf;
    } else if (isResidential) {
        sewerGPD = Math.max(units, 1) * SEWER_THRESHOLDS.residential.gpd_per_unit;
    } else {
        sewerGPD = (gsf / 1000) * SEWER_THRESHOLDS.commercial.gpd_per_1000sf;
    }
    const sPermitRequired = sewerGPD >= SEWER_THRESHOLDS.residential.s_permit_threshold;
    const sewerUpgradeCost = sPermitRequired ? Math.round(15000 + sewerGPD * 2.5) : 0;

    // --- WATER ---
    let waterGPD = 0;
    if (isHotel) {
        waterGPD = units * WATER_DEMAND.hotel.gpd_per_room;
    } else if (isMedical) {
        waterGPD = (gsf / 1000) * WATER_DEMAND.medical.gpd_per_1000sf;
    } else if (isIndustrial) {
        waterGPD = (gsf / 1000) * WATER_DEMAND.industrial.gpd_per_1000sf;
    } else if (isResidential) {
        waterGPD = Math.max(units, 1) * WATER_DEMAND.residential.gpd_per_unit;
    } else {
        waterGPD = (gsf / 1000) * WATER_DEMAND.commercial.gpd_per_1000sf;
    }
    const willServeRequired = waterGPD >= 5000 || units >= 50;

    // --- STORMWATER / LID ---
    const buildingFootprint = Math.min(Math.round(inp.parcelSize * 0.70), Math.round(gsf / Math.max(stories, 1)));
    const impervArea = Math.round(inp.parcelSize * 0.85); // assume 85% impervious after development
    const retentionVolume = Math.round(impervArea * LID_REQUIREMENTS.retentionFactor);
    const treatmentArea = impervArea;
    const bmpCost = Math.round(retentionVolume * LID_REQUIREMENTS.bmpCostPerCuFt);
    // Recommend LID type
    let lidType = 'Bioretention/Rain Garden';
    if (inp.parcelSize < 5000) lidType = 'Underground Infiltration';
    else if (parkingSpaces >= 20) lidType = 'Permeable Pavement';
    else if (stories >= 4) lidType = 'Green Roof';

    // --- FIRE FLOW ---
    const fireReqs = FIRE_FLOW_REQS[useId] || FIRE_FLOW_REQS.multifamily_low;
    const requiredGPM = fireReqs.gpm;
    const hydrantCount = fireReqs.hydrants;
    // Fire flow upgrade if constrained area or high-rise
    const fireUpgradeCost = (stories >= 8 || (powerData.status === 'constrained' && requiredGPM >= 3000)) ? Math.round(requiredGPM * 25) : 0;

    // --- EV CHARGING ---
    const evReqs = isResidential ? EV_CHARGING_REQS.residential : EV_CHARGING_REQS.commercial;
    const requiredEVSpaces = Math.max(1, Math.ceil(parkingSpaces * evReqs.evReady));
    const conduitSpaces = Math.ceil(parkingSpaces * evReqs.evConduit);
    const level2Count = requiredEVSpaces;
    const dcfcCount = parkingSpaces >= 100 ? 1 : 0;
    const evCost = Math.round(level2Count * evReqs.level2CostPerSpace + dcfcCount * evReqs.dcfcCostPerUnit + (conduitSpaces - level2Count) * 500);

    // --- TOTALS ---
    const totalInfraCost = upgradeCostPower + sewerUpgradeCost + bmpCost + fireUpgradeCost + evCost;
    const maxTimeline = Math.max(transformerTimeline, sPermitRequired ? 4 : 0, willServeRequired ? 3 : 0, fireUpgradeCost > 0 ? 4 : 0);

    return {
        power: {
            capacity: powerData.status,
            upgradeNeeded,
            upgradeCost: upgradeCostPower,
            transformerTimeline,
        },
        sewer: {
            sPermitRequired,
            upgradeCost: sewerUpgradeCost,
            dailyFlow: Math.round(sewerGPD),
            capacity: sPermitRequired ? 'Over threshold â€” S-permit required' : 'Within threshold',
        },
        water: {
            willServeRequired,
            dailyDemand: Math.round(waterGPD),
        },
        stormwater: {
            treatmentArea,
            bmpCost,
            retentionVolume,
            lidType,
            impervArea,
        },
        fireFlow: {
            requiredGPM,
            duration: fireReqs.duration,
            hydrantCount,
            upgradeCost: fireUpgradeCost,
        },
        evCharging: {
            totalSpaces: parkingSpaces,
            requiredEVSpaces,
            conduitSpaces,
            level2Count,
            dcfcCount,
            cost: evCost,
        },
        totalInfraCost,
        timeline: maxTimeline,
    };
}

var infraCostMult = 1.0;

function recalcInfrastructure() {
    var el = document.getElementById('infra-costMult');
    if (el) infraCostMult = parseFloat(el.value) / 100;
    var slider = document.getElementById('infra-costMult-slider');
    var num = document.getElementById('infra-costMult');
    if (slider && num && document.activeElement === slider) num.value = slider.value;
    if (slider && num && document.activeElement === num) slider.value = num.value;
    var valSpan = document.getElementById('infra-costMult-val');
    if (valSpan && num) valSpan.textContent = parseFloat(num.value).toFixed(0) + '%';
    _debouncedCall('infrastructure', function() {
        var container = document.getElementById('infrastructureContent');
        if (container && deepAnalysisState) container.innerHTML = buildInfrastructureContent();
    }, 150);
}

function resetInfrastructure() {
    infraCostMult = 1.0;
    var slider = document.getElementById('infra-costMult-slider');
    var num = document.getElementById('infra-costMult');
    if (slider) slider.value = 100;
    if (num) num.value = 100;
    recalcInfrastructure();
}

function buildInfrastructureContent() {
    var st = deepAnalysisState;
    if (!st) return '';
    var bestUse = st.bestUse, inp = st.inp, computed = st.computed;
    var infra = analyzeInfrastructure(bestUse, inp, computed);
    var nh = inp.neighborhood;
    var nhLabel = nh.charAt(0).toUpperCase() + nh.slice(1);
    var m = infraCostMult;

    var html = '';

    // Overview Cards
    var totalCostAdj = infra.totalInfraCost * m;
    html += '<div class="analysis-section"><h3>Infrastructure & Utility Assessment â€” ' + nhLabel + '</h3>' +
        '<div class="exec-summary-grid">' +
            '<div class="exec-summary-card">' +
                '<h4>Total Infrastructure Cost</h4>' +
                '<div class="exec-metric-lg">' + formatCompactDollars(totalCostAdj) + '</div>' +
                '<div class="exec-metric-sub">' + (totalCostAdj / (computed.totalDev || 1) * 100).toFixed(1) + '% of total dev cost</div>' +
            '</div>' +
            '<div class="exec-summary-card">' +
                '<h4>Utility Upgrade Timeline</h4>' +
                '<div class="exec-metric-lg">' + infra.timeline + '<span style="font-size:0.6em;color:var(--text-light)"> months</span></div>' +
                '<div class="exec-metric-sub">' + (infra.timeline > 0 ? 'Critical path item â€” start early' : 'No significant utility delays expected') + '</div>' +
            '</div>' +
        '</div>' +
    '</div>';

    // Power
    var powerColor = infra.power.capacity === 'constrained' ? '#c53030' : infra.power.capacity === 'adequate' ? '#b7791f' : '#276749';
    var powerBg = infra.power.capacity === 'constrained' ? '#fff5f5' : infra.power.capacity === 'adequate' ? '#fffff0' : '#f0fff4';
    var powerUpgCost = infra.power.upgradeNeeded ? formatCompactDollars(infra.power.upgradeCost * m) : 'Not Required';
    html += '<div class="analysis-section"><h3>Electrical Power (LADWP)</h3>' +
        '<div class="exec-summary-grid">' +
            '<div class="exec-summary-card">' +
                '<h4>Grid Capacity</h4>' +
                '<div class="exec-metric-lg" style="color:' + powerColor + ';text-transform:uppercase;">' + infra.power.capacity + '</div>' +
                '<div class="exec-metric-sub">LADWP distribution grid status</div>' +
            '</div>' +
            '<div class="exec-summary-card">' +
                '<h4>Transformer Upgrade</h4>' +
                '<div class="exec-metric-lg">' + powerUpgCost + '</div>' +
                '<div class="exec-metric-sub">' + (infra.power.upgradeNeeded ? infra.power.transformerTimeline + ' months lead time' : 'Existing service adequate') + '</div>' +
            '</div>' +
        '</div>' +
        '<div style="background:' + powerBg + ';border:1px solid var(--border);border-radius:8px;padding:0.75rem 1rem;margin-top:0.75rem;font-size:0.85rem;">' +
            (infra.power.capacity === 'constrained' ? '<strong>Note:</strong> This area has constrained electrical distribution. LADWP may require developer-funded transformer upgrade and/or service lateral extension. Submit LADWP Will-Serve application early â€” typical lead time is ' + infra.power.transformerTimeline + '+ months for new transformer installation.' : infra.power.capacity === 'adequate' ? '<strong>Note:</strong> Grid capacity is generally adequate but large projects may require panel upgrade or dedicated transformer. Confirm with LADWP load letter.' : '<strong>Note:</strong> Ample grid capacity in this area. Standard utility connection process expected.') +
        '</div>' +
    '</div>';

    // Sewer
    var sewerUpgCost = infra.sewer.sPermitRequired ? formatCompactDollars(infra.sewer.upgradeCost * m) : '';
    html += '<div class="analysis-section"><h3>Sewer (LASAN)</h3>' +
        '<div class="exec-summary-grid">' +
            '<div class="exec-summary-card">' +
                '<h4>Daily Sewer Flow</h4>' +
                '<div class="exec-metric-lg">' + infra.sewer.dailyFlow.toLocaleString() + '<span style="font-size:0.6em;color:var(--text-light)"> GPD</span></div>' +
                '<div class="exec-metric-sub">' + infra.sewer.capacity + '</div>' +
            '</div>' +
            '<div class="exec-summary-card">' +
                '<h4>S-Permit</h4>' +
                '<div class="exec-metric-lg" style="color:' + (infra.sewer.sPermitRequired ? '#c53030' : '#276749') + '">' + (infra.sewer.sPermitRequired ? 'Required' : 'Not Required') + '</div>' +
                '<div class="exec-metric-sub">' + (infra.sewer.sPermitRequired ? sewerUpgCost + ' est. upgrade cost' : 'Under 10,000 GPD threshold') + '</div>' +
            '</div>' +
        '</div>' +
        (infra.sewer.sPermitRequired ? '<div style="background:#fff5f5;border:1px solid #feb2b2;border-radius:8px;padding:0.75rem 1rem;margin-top:0.75rem;font-size:0.85rem;"><strong>S-Permit Required:</strong> Sewer generation exceeds 10,000 GPD threshold. LASAN S-permit process takes 3-6 months. Developer may be required to fund sewer main extension or upsizing. Sewer Capacity Availability Request (SCAR) required before plan check.</div>' : '') +
    '</div>';

    // Water
    html += '<div class="analysis-section"><h3>Water Service (LADWP)</h3>' +
        '<div class="exec-summary-grid">' +
            '<div class="exec-summary-card">' +
                '<h4>Daily Water Demand</h4>' +
                '<div class="exec-metric-lg">' + infra.water.dailyDemand.toLocaleString() + '<span style="font-size:0.6em;color:var(--text-light)"> GPD</span></div>' +
            '</div>' +
            '<div class="exec-summary-card">' +
                '<h4>Will-Serve Letter</h4>' +
                '<div class="exec-metric-lg" style="color:' + (infra.water.willServeRequired ? '#b7791f' : '#276749') + '">' + (infra.water.willServeRequired ? 'Required' : 'Standard') + '</div>' +
                '<div class="exec-metric-sub">' + (infra.water.willServeRequired ? 'Large project â€” LADWP Will-Serve letter needed' : 'Standard connection application') + '</div>' +
            '</div>' +
        '</div>' +
    '</div>';

    // Stormwater / LID
    html += '<div class="analysis-section"><h3>Stormwater & Low Impact Development (LID)</h3>' +
        '<div class="exec-summary-grid">' +
            '<div class="exec-summary-card">' +
                '<h4>Impervious Area</h4>' +
                '<div class="exec-metric-lg">' + infra.stormwater.impervArea.toLocaleString() + '<span style="font-size:0.6em;color:var(--text-light)"> SF</span></div>' +
                '<div class="exec-metric-sub">85% of parcel (post-development)</div>' +
            '</div>' +
            '<div class="exec-summary-card">' +
                '<h4>Retention Volume</h4>' +
                '<div class="exec-metric-lg">' + infra.stormwater.retentionVolume.toLocaleString() + '<span style="font-size:0.6em;color:var(--text-light)"> CF</span></div>' +
                '<div class="exec-metric-sub">3/4" design storm capture</div>' +
            '</div>' +
            '<div class="exec-summary-card">' +
                '<h4>Recommended BMP</h4>' +
                '<div class="exec-metric-lg" style="font-size:0.95rem;">' + infra.stormwater.lidType + '</div>' +
                '<div class="exec-metric-sub">' + (LID_REQUIREMENTS.bmpTypes[infra.stormwater.lidType] ? LID_REQUIREMENTS.bmpTypes[infra.stormwater.lidType].applicability : '') + '</div>' +
            '</div>' +
            '<div class="exec-summary-card">' +
                '<h4>LID/BMP Cost</h4>' +
                '<div class="exec-metric-lg">' + formatCompactDollars(infra.stormwater.bmpCost * m) + '</div>' +
                '<div class="exec-metric-sub">$' + LID_REQUIREMENTS.bmpCostPerCuFt + '/CF retention</div>' +
            '</div>' +
        '</div>';
    html += '<h4 style="font-size:0.85rem;color:var(--primary);margin:1rem 0 0.5rem;">BMP Options</h4>';
    html += '<table class="afford-comparison-table"><thead><tr>' +
        '<th>BMP Type</th><th>Cost/SF</th><th>Applicability</th>' +
    '</tr></thead><tbody>';
    var bmpEntries = Object.entries(LID_REQUIREMENTS.bmpTypes);
    for (var bi = 0; bi < bmpEntries.length; bi++) {
        var bmpName = bmpEntries[bi][0], bmpData = bmpEntries[bi][1];
        var isSelected = bmpName === infra.stormwater.lidType;
        html += '<tr style="' + (isSelected ? 'background:#f0fff4;font-weight:600;' : '') + '">' +
            '<td>' + bmpName + (isSelected ? ' &#10004;' : '') + '</td>' +
            '<td>$' + bmpData.costPSF + '/SF</td>' +
            '<td style="font-size:0.82rem;">' + bmpData.applicability + '</td>' +
        '</tr>';
    }
    html += '</tbody></table>';
    html += '<div style="font-size:0.82rem;color:var(--text-light);margin-top:0.5rem;">' +
        'LA LID Ordinance (Ord. 181,899) requires on-site retention/treatment of the 3/4-inch, 24-hour design storm from all impervious surfaces. Projects disturbing &ge;500 SF of impervious area must comply.' +
    '</div>';
    html += '</div>';

    // Fire Flow
    html += '<div class="analysis-section"><h3>Fire Flow (LAFD)</h3>' +
        '<div class="exec-summary-grid">' +
            '<div class="exec-summary-card">' +
                '<h4>Required Fire Flow</h4>' +
                '<div class="exec-metric-lg">' + infra.fireFlow.requiredGPM.toLocaleString() + '<span style="font-size:0.6em;color:var(--text-light)"> GPM</span></div>' +
                '<div class="exec-metric-sub">' + infra.fireFlow.duration + '-hour duration</div>' +
            '</div>' +
            '<div class="exec-summary-card">' +
                '<h4>Fire Hydrants</h4>' +
                '<div class="exec-metric-lg">' + infra.fireFlow.hydrantCount + '</div>' +
                '<div class="exec-metric-sub">Within 400 ft of building</div>' +
            '</div>' +
            '<div class="exec-summary-card">' +
                '<h4>Upgrade Cost</h4>' +
                '<div class="exec-metric-lg">' + (infra.fireFlow.upgradeCost > 0 ? formatCompactDollars(infra.fireFlow.upgradeCost * m) : 'None') + '</div>' +
                '<div class="exec-metric-sub">' + (infra.fireFlow.upgradeCost > 0 ? 'Water main or hydrant upgrade' : 'Existing infrastructure adequate') + '</div>' +
            '</div>' +
        '</div>' +
    '</div>';

    // EV Charging
    html += '<div class="analysis-section"><h3>EV Charging (CalGreen + LA Local Code)</h3>' +
        '<div class="exec-summary-grid">' +
            '<div class="exec-summary-card">' +
                '<h4>Total Parking</h4>' +
                '<div class="exec-metric-lg">' + infra.evCharging.totalSpaces + '</div>' +
                '<div class="exec-metric-sub">project spaces</div>' +
            '</div>' +
            '<div class="exec-summary-card">' +
                '<h4>EV-Ready (Full Circuit)</h4>' +
                '<div class="exec-metric-lg">' + infra.evCharging.requiredEVSpaces + '</div>' +
                '<div class="exec-metric-sub">Level 2 chargers installed</div>' +
            '</div>' +
            '<div class="exec-summary-card">' +
                '<h4>EV Conduit (Raceway)</h4>' +
                '<div class="exec-metric-lg">' + infra.evCharging.conduitSpaces + '</div>' +
                '<div class="exec-metric-sub">Spaces with conduit for future EVSE</div>' +
            '</div>' +
            '<div class="exec-summary-card">' +
                '<h4>EV Infrastructure Cost</h4>' +
                '<div class="exec-metric-lg">' + formatCompactDollars(infra.evCharging.cost * m) + '</div>' +
                '<div class="exec-metric-sub">' + infra.evCharging.level2Count + ' L2 + ' + infra.evCharging.dcfcCount + ' DCFC</div>' +
            '</div>' +
        '</div>' +
        '<div style="background:#ebf8ff;border:1px solid #90cdf4;border-radius:8px;padding:0.75rem 1rem;margin-top:0.75rem;font-size:0.85rem;">' +
            '<strong>LA Local Amendment (2025):</strong> City of LA requires 100% of residential parking spaces to have EV charging raceway/conduit (exceeds state CalGreen minimum). 10% must have full EV-capable circuits. Commercial projects: 40% conduit, 6% full circuit. Budget for panel capacity and transformer sizing accordingly.' +
        '</div>' +
    '</div>';

    // Cost Summary
    var pCost = infra.power.upgradeNeeded ? formatCompactDollars(infra.power.upgradeCost * m) : '$0';
    var sCost = infra.sewer.sPermitRequired ? formatCompactDollars(infra.sewer.upgradeCost * m) : '$0';
    var swCost = formatCompactDollars(infra.stormwater.bmpCost * m);
    var ffCost = infra.fireFlow.upgradeCost > 0 ? formatCompactDollars(infra.fireFlow.upgradeCost * m) : '$0';
    var evCost = formatCompactDollars(infra.evCharging.cost * m);

    html += '<div class="analysis-section"><h3>Infrastructure Cost Summary</h3>' +
        '<table class="afford-comparison-table"><thead><tr>' +
            '<th>Category</th><th>Cost</th><th>Timeline</th><th>Notes</th>' +
        '</tr></thead><tbody>' +
            '<tr>' +
                '<td>Electrical (LADWP)</td>' +
                '<td>' + pCost + '</td>' +
                '<td>' + (infra.power.transformerTimeline > 0 ? infra.power.transformerTimeline + ' months' : 'â€”') + '</td>' +
                '<td style="font-size:0.82rem;">' + (infra.power.upgradeNeeded ? 'Transformer upgrade required' : 'Standard service connection') + '</td>' +
            '</tr>' +
            '<tr>' +
                '<td>Sewer (LASAN)</td>' +
                '<td>' + sCost + '</td>' +
                '<td>' + (infra.sewer.sPermitRequired ? '4-6 months' : 'â€”') + '</td>' +
                '<td style="font-size:0.82rem;">' + (infra.sewer.sPermitRequired ? 'S-permit + possible main upgrade' : 'Standard connection') + '</td>' +
            '</tr>' +
            '<tr>' +
                '<td>Stormwater / LID</td>' +
                '<td>' + swCost + '</td>' +
                '<td>â€”</td>' +
                '<td style="font-size:0.82rem;">' + infra.stormwater.lidType + '</td>' +
            '</tr>' +
            '<tr>' +
                '<td>Fire Flow (LAFD)</td>' +
                '<td>' + ffCost + '</td>' +
                '<td>' + (infra.fireFlow.upgradeCost > 0 ? '3-4 months' : 'â€”') + '</td>' +
                '<td style="font-size:0.82rem;">' + infra.fireFlow.requiredGPM.toLocaleString() + ' GPM required</td>' +
            '</tr>' +
            '<tr>' +
                '<td>EV Charging</td>' +
                '<td>' + evCost + '</td>' +
                '<td>â€”</td>' +
                '<td style="font-size:0.82rem;">' + infra.evCharging.level2Count + ' L2 + ' + infra.evCharging.dcfcCount + ' DCFC + ' + infra.evCharging.conduitSpaces + ' conduit</td>' +
            '</tr>' +
            '<tr style="font-weight:700;border-top:2px solid var(--border);">' +
                '<td>Total Infrastructure</td>' +
                '<td>' + formatCompactDollars(totalCostAdj) + '</td>' +
                '<td>' + (infra.timeline > 0 ? infra.timeline + ' months max' : 'Concurrent') + '</td>' +
                '<td style="font-size:0.82rem;">' + (totalCostAdj / (computed.totalDev || 1) * 100).toFixed(1) + '% of total dev cost</td>' +
            '</tr>' +
        '</tbody></table>' +
    '</div>';

    return html;
}

function renderInfrastructureTab(st) {
    var html = '<div class="deep-tab-panel">';
    html += '<div class="dt-controls"><div class="dt-controls-title">Adjust Cost Estimates <button class="dt-reset-btn" onclick="resetInfrastructure()">Reset Defaults</button></div>';
    html += '<div class="dt-controls-grid"><div class="dt-slider-group">';
    html += '<div class="dt-slider-label"><span>Infrastructure Cost Multiplier</span><span class="dt-val" id="infra-costMult-val">100%</span></div>';
    html += '<div class="dt-slider-row">';
    html += '<input type="range" id="infra-costMult-slider" min="50" max="200" step="10" value="100" oninput="document.getElementById(\'infra-costMult\').value=this.value;recalcInfrastructure()">';
    html += '<input type="number" id="infra-costMult" min="50" max="200" step="10" value="100" oninput="document.getElementById(\'infra-costMult-slider\').value=this.value;recalcInfrastructure()">';
    html += '</div></div></div></div>';
    html += '<div id="infrastructureContent">' + buildInfrastructureContent() + '</div>';
    html += '</div>';
    return html;
}


function renderComingSoonTab(title, description, phase) {
    return `<div class="deep-tab-panel">
        <div class="coming-soon-panel">
            <div class="icon">ðŸ”’</div>
            <h3>${title}</h3>
            <p style="font-size:0.88rem;max-width:500px;margin:0 auto;">${description}</p>
            <p style="margin-top:1rem;font-size:0.78rem;color:#a0aec0;">Coming in ${phase}</p>
        </div>
    </div>`;
}


// ============================================================
//  SKILL 34: Cut & Fill / Earthwork Analysis
// ============================================================

const EARTHWORK_COSTS_DEFAULT = {
    cut:           8.50,   // $/CY on-site cut
    fill:          6.00,   // $/CY on-site fill (reuse from cut)
    import:       28.00,   // $/CY imported fill (haul + material)
    export:       24.00,   // $/CY export off-site (haul + dump fees)
    retainingWall: 85.00,  // $/SF of wall face (concrete/masonry)
    shoring:       45.00,  // $/SF temporary shoring
    grading:        3.50,  // $/SY rough grading
    compaction:     2.80,  // $/CY compaction
    erosionControl: 1.25,  // $/SF SWPPP erosion control during grading
};
var EARTHWORK_COSTS = Object.assign({}, EARTHWORK_COSTS_DEFAULT);

function recalcEarthwork() {
    var fields = {cut:'ew-cut',fill:'ew-fill','import':'ew-import','export':'ew-export',retainingWall:'ew-retWall',shoring:'ew-shoring',grading:'ew-grading',compaction:'ew-compact',erosionControl:'ew-erosion'};
    Object.keys(fields).forEach(function(k) {
        var el = document.getElementById(fields[k]);
        if (el) EARTHWORK_COSTS[k] = parseFloat(el.value) || EARTHWORK_COSTS_DEFAULT[k];
    });
    _debouncedCall('earthwork', function() {
        var st = deepAnalysisState;
        if (!st) return;
        var container = document.getElementById('earthworkContent');
        if (!container) return;
        var ew = analyzeEarthwork(st.bestUse, st.inp, st.computed);
        container.innerHTML = buildEarthworkContent(ew, st.inp);
    }, 150);
}
function resetEarthwork() {
    EARTHWORK_COSTS = Object.assign({}, EARTHWORK_COSTS_DEFAULT);
    var fields = {cut:'ew-cut',fill:'ew-fill','import':'ew-import','export':'ew-export',retainingWall:'ew-retWall',shoring:'ew-shoring',grading:'ew-grading',compaction:'ew-compact',erosionControl:'ew-erosion'};
    Object.keys(fields).forEach(function(k) {
        var el = document.getElementById(fields[k]);
        if (el) el.value = EARTHWORK_COSTS_DEFAULT[k];
    });
    recalcEarthwork();
}

function analyzeEarthwork(useId, inp, computed) {
    var parcelSF = inp.parcelSize || 10000;
    var parcelSY = parcelSF / 9;
    var topo = inp.topography || 'flat';

    // Grade differential assumptions by topography
    var gradeDiff = { flat: 1, moderate: 6, steep: 14, hillside: 28 };
    var diff = gradeDiff[topo] || 1;

    // Approximate cut/fill volumes (CY = cubic yards)
    // Volume ~ parcelSF * gradeDiff / 27 (convert CF to CY)
    var avgDepth = diff; // feet of grade change across site
    var cutVolume = Math.round(parcelSF * avgDepth * 0.5 / 27);
    var fillVolume = Math.round(parcelSF * avgDepth * 0.35 / 27);

    // For building pad: additional excavation for foundation
    var stories = computed.stories || 1;
    var hasSubterranean = stories >= 7 || useId === 'parking';
    var subLevels = hasSubterranean ? (stories >= 18 ? 3 : stories >= 7 ? 2 : 1) : 0;
    var padExcavation = hasSubterranean ? Math.round(computed.gsf * subLevels * 0.6 / 27) : 0;
    cutVolume += padExcavation;

    var netBalance = cutVolume - fillVolume;
    var importVolume = netBalance < 0 ? Math.abs(netBalance) : 0;
    var exportVolume = netBalance > 0 ? netBalance : 0;

    // Retaining wall analysis
    var retainingWall = { needed: false, length: 0, height: 0, area: 0, cost: 0 };
    if (topo === 'steep' || topo === 'hillside') {
        retainingWall.needed = true;
        var frontage = inp.frontage || Math.sqrt(parcelSF);
        retainingWall.length = Math.round(frontage * (topo === 'hillside' ? 2.5 : 1.5));
        retainingWall.height = topo === 'hillside' ? 16 : 8;
        retainingWall.area = retainingWall.length * retainingWall.height;
        retainingWall.cost = Math.round(retainingWall.area * EARTHWORK_COSTS.retainingWall);
    }

    // Shoring for subterranean
    var shoringCost = 0;
    if (hasSubterranean) {
        var perimeterLF = 2 * (Math.sqrt(computed.gsf / stories) + Math.sqrt(computed.gsf / stories));
        var shoringDepth = subLevels * 12;
        shoringCost = Math.round(perimeterLF * shoringDepth * EARTHWORK_COSTS.shoring);
    }

    // Cost breakdown
    var cutCost = Math.round(cutVolume * EARTHWORK_COSTS.cut);
    var fillCost = Math.round(fillVolume * EARTHWORK_COSTS.fill);
    var importCost = Math.round(importVolume * EARTHWORK_COSTS.import);
    var exportCost = Math.round(exportVolume * EARTHWORK_COSTS.export);
    var gradingCost = Math.round(parcelSY * EARTHWORK_COSTS.grading);
    var compactionCost = Math.round((fillVolume + importVolume) * EARTHWORK_COSTS.compaction);
    var erosionCost = Math.round(parcelSF * EARTHWORK_COSTS.erosionControl);

    var totalEarthworkCost = cutCost + fillCost + importCost + exportCost +
        gradingCost + compactionCost + erosionCost + retainingWall.cost + shoringCost;

    return {
        topography: topo,
        gradeDifferential: diff,
        cutVolume: cutVolume,
        fillVolume: fillVolume,
        netBalance: netBalance,
        importVolume: importVolume,
        exportVolume: exportVolume,
        padExcavation: padExcavation,
        subLevels: subLevels,
        retainingWall: retainingWall,
        shoringCost: shoringCost,
        costs: {
            cut: cutCost,
            fill: fillCost,
            import: importCost,
            export: exportCost,
            grading: gradingCost,
            compaction: compactionCost,
            erosion: erosionCost,
            retaining: retainingWall.cost,
            shoring: shoringCost,
        },
        totalCost: totalEarthworkCost,
    };
}

function generateEarthworkSVG(earthwork, inp) {
    var w = 480, h = 220;
    var topo = earthwork.topography;
    var diff = earthwork.gradeDifferential;

    var svg = '<svg viewBox="0 0 ' + w + ' ' + h + '" xmlns="http://www.w3.org/2000/svg" style="background:#fafbfc;">';

    // Ground profile - existing grade
    var groundY1 = 140;
    var groundY2 = 140 - Math.min(diff * 3, 80);
    svg += '<polygon points="40,' + h + ' 40,' + groundY1 + ' ' + (w - 40) + ',' + groundY2 + ' ' + (w - 40) + ',' + h + '" fill="#d4a574" opacity="0.4" stroke="#8B6914" stroke-width="1"/>';

    // Proposed grade (flat pad)
    var padY = Math.round((groundY1 + groundY2) / 2);
    svg += '<line x1="40" y1="' + padY + '" x2="' + (w - 40) + '" y2="' + padY + '" stroke="#2b6cb0" stroke-width="2" stroke-dasharray="6,3"/>';

    // Cut zone (above pad line on high side)
    if (groundY2 < padY) {
        var midX = Math.round(40 + (w - 80) * ((padY - groundY2) / (groundY1 - groundY2)));
        svg += '<polygon points="' + midX + ',' + padY + ' ' + (w - 40) + ',' + groundY2 + ' ' + (w - 40) + ',' + padY + '" fill="#fc8181" opacity="0.5"/>';
        svg += '<text x="' + Math.round((midX + w - 40) / 2) + '" y="' + (padY - 8) + '" text-anchor="middle" font-size="10" fill="#c53030" font-weight="600">CUT</text>';
    }

    // Fill zone (below pad line on low side)
    if (groundY1 > padY) {
        var midX2 = Math.round(40 + (w - 80) * ((padY - groundY2) / (groundY1 - groundY2)));
        svg += '<polygon points="40,' + groundY1 + ' 40,' + padY + ' ' + midX2 + ',' + padY + '" fill="#68d391" opacity="0.5"/>';
        svg += '<text x="' + Math.round((40 + midX2) / 2) + '" y="' + (padY + 16) + '" text-anchor="middle" font-size="10" fill="#276749" font-weight="600">FILL</text>';
    }

    // Labels
    svg += '<text x="20" y="' + (groundY1 + 4) + '" font-size="8" fill="#666" text-anchor="end">EL +0\'</text>';
    svg += '<text x="' + (w - 18) + '" y="' + (groundY2 + 4) + '" font-size="8" fill="#666">EL +' + diff + '\'</text>';
    svg += '<text x="' + (w / 2) + '" y="' + (padY - 14) + '" text-anchor="middle" font-size="9" fill="#2b6cb0" font-weight="600">PROPOSED PAD GRADE</text>';

    // Retaining wall
    if (earthwork.retainingWall.needed) {
        svg += '<rect x="' + (w - 48) + '" y="' + groundY2 + '" width="6" height="' + (padY - groundY2 + 20) + '" fill="#805ad5" opacity="0.8"/>';
        svg += '<text x="' + (w - 45) + '" y="' + (groundY2 - 6) + '" font-size="7" fill="#805ad5" font-weight="600">RETAINING WALL</text>';
    }

    // Subterranean levels
    if (earthwork.subLevels > 0) {
        var subTop = padY + 2;
        var subH = earthwork.subLevels * 18;
        svg += '<rect x="120" y="' + subTop + '" width="240" height="' + subH + '" fill="#2b6cb0" opacity="0.2" stroke="#2b6cb0" stroke-width="1" stroke-dasharray="4,2"/>';
        svg += '<text x="240" y="' + (subTop + subH / 2 + 4) + '" text-anchor="middle" font-size="9" fill="#2b6cb0" font-weight="600">' + earthwork.subLevels + ' SUBTERRANEAN LEVEL' + (earthwork.subLevels > 1 ? 'S' : '') + '</text>';
    }

    // Scale and title
    svg += '<text x="' + (w / 2) + '" y="16" text-anchor="middle" font-size="11" fill="#1a365d" font-weight="700">CROSS-SECTION: CUT & FILL DIAGRAM</text>';
    svg += '<line x1="40" y1="' + (h - 10) + '" x2="140" y2="' + (h - 10) + '" stroke="#999" stroke-width="1"/>';
    svg += '<text x="90" y="' + (h - 2) + '" text-anchor="middle" font-size="7" fill="#999">~100 ft</text>';

    svg += '</svg>';
    return svg;
}

function buildEarthworkContent(ew, inp) {
    var html = '';
    html += '<div style="margin-bottom:1.5rem;">' + generateEarthworkSVG(ew, inp) + '</div>';
    html += '<div class="exec-summary-grid">';
    html += '<div class="exec-summary-card"><h4>Cut Volume</h4><div class="exec-metric-lg" style="color:#c53030;">' + ew.cutVolume.toLocaleString() + ' CY</div><div class="exec-metric-sub">Includes ' + ew.padExcavation.toLocaleString() + ' CY pad excavation</div></div>';
    html += '<div class="exec-summary-card"><h4>Fill Volume</h4><div class="exec-metric-lg" style="color:#276749;">' + ew.fillVolume.toLocaleString() + ' CY</div><div class="exec-metric-sub">On-site reuse from cut material</div></div>';
    if (ew.exportVolume > 0) html += '<div class="exec-summary-card"><h4>Export Off-Site</h4><div class="exec-metric-lg" style="color:#dd6b20;">' + ew.exportVolume.toLocaleString() + ' CY</div><div class="exec-metric-sub">~' + Math.ceil(ew.exportVolume / 14) + ' truck loads (14 CY ea.)</div></div>';
    if (ew.importVolume > 0) html += '<div class="exec-summary-card"><h4>Import Fill</h4><div class="exec-metric-lg" style="color:#2b6cb0;">' + ew.importVolume.toLocaleString() + ' CY</div><div class="exec-metric-sub">~' + Math.ceil(ew.importVolume / 14) + ' truck loads (14 CY ea.)</div></div>';
    html += '<div class="exec-summary-card"><h4>Total Earthwork Cost</h4><div class="exec-metric-lg">' + formatCompactDollars(ew.totalCost) + '</div><div class="exec-metric-sub">Grade differential: ' + ew.gradeDifferential + ' ft (' + ew.topography + ')</div></div>';
    if (ew.subLevels > 0) html += '<div class="exec-summary-card"><h4>Subterranean Levels</h4><div class="exec-metric-lg">' + ew.subLevels + '</div><div class="exec-metric-sub">Shoring cost: ' + formatCompactDollars(ew.shoringCost) + '</div></div>';
    html += '</div>';
    html += '<table class="budget-table" style="margin-top:1.5rem;"><tr class="section-header"><td colspan="3">Earthwork Cost Breakdown</td></tr>';
    html += '<tr><th style="text-align:left;">Item</th><th>Quantity</th><th>Cost</th></tr>';
    html += '<tr><td>Rough Grading</td><td class="dim">' + Math.round(inp.parcelSize / 9).toLocaleString() + ' SY</td><td>' + fmt(ew.costs.grading) + '</td></tr>';
    html += '<tr><td>Cut (On-Site)</td><td class="dim">' + ew.cutVolume.toLocaleString() + ' CY</td><td>' + fmt(ew.costs.cut) + '</td></tr>';
    html += '<tr><td>Fill (On-Site Reuse)</td><td class="dim">' + ew.fillVolume.toLocaleString() + ' CY</td><td>' + fmt(ew.costs.fill) + '</td></tr>';
    if (ew.importVolume > 0) html += '<tr><td>Import Fill (Haul + Material)</td><td class="dim">' + ew.importVolume.toLocaleString() + ' CY</td><td>' + fmt(ew.costs.import) + '</td></tr>';
    if (ew.exportVolume > 0) html += '<tr><td>Export Off-Site (Haul + Dump)</td><td class="dim">' + ew.exportVolume.toLocaleString() + ' CY</td><td>' + fmt(ew.costs.export) + '</td></tr>';
    html += '<tr><td>Compaction</td><td class="dim">' + (ew.fillVolume + ew.importVolume).toLocaleString() + ' CY</td><td>' + fmt(ew.costs.compaction) + '</td></tr>';
    html += '<tr><td>Erosion Control / SWPPP</td><td class="dim">' + inp.parcelSize.toLocaleString() + ' SF</td><td>' + fmt(ew.costs.erosion) + '</td></tr>';
    if (ew.retainingWall.needed) html += '<tr><td>Retaining Wall</td><td class="dim">' + ew.retainingWall.area.toLocaleString() + ' SF face</td><td>' + fmt(ew.costs.retaining) + '</td></tr>';
    if (ew.shoringCost > 0) html += '<tr><td>Temporary Shoring</td><td class="dim">' + ew.subLevels + ' sub levels</td><td>' + fmt(ew.costs.shoring) + '</td></tr>';
    html += '<tr class="grand-total"><td colspan="2">Total Earthwork</td><td>' + fmt(ew.totalCost) + '</td></tr>';
    html += '</table>';
    if (ew.retainingWall.needed) {
        html += '<div class="risk-card" style="margin-top:1.25rem;"><strong>Retaining Wall Required</strong>';
        html += '<p>Site topography (' + ew.topography + ') requires a retaining wall: ' + ew.retainingWall.length + ' LF long x ' + ew.retainingWall.height + ' ft high (' + ew.retainingWall.area.toLocaleString() + ' SF of wall face). Reinforced concrete or masonry block construction recommended. Geotechnical report required for design.</p></div>';
    }
    return html;
}

function renderEarthworkTab(st) {
    var ew = analyzeEarthwork(st.bestUse, st.inp, st.computed);
    var ec = EARTHWORK_COSTS;
    var html = '<div class="deep-tab-panel">';
    html += '<div class="analysis-section"><h3>Cut & Fill / Earthwork Analysis</h3>';

    // Dynamic controls
    html += '<div class="dt-controls">';
    html += '<div class="dt-controls-title"><span>Unit Costs (editable)</span><button class="dt-reset-btn" onclick="resetEarthwork()">Reset Defaults</button></div>';
    html += '<div class="dt-controls-grid">';
    var costs = [
        {id:'ew-cut',label:'Cut $/CY',val:ec.cut,min:1,max:30,step:0.5},
        {id:'ew-fill',label:'Fill $/CY',val:ec.fill,min:1,max:20,step:0.5},
        {id:'ew-import',label:'Import $/CY',val:ec['import'],min:5,max:60,step:1},
        {id:'ew-export',label:'Export $/CY',val:ec['export'],min:5,max:50,step:1},
        {id:'ew-retWall',label:'Ret. Wall $/SF',val:ec.retainingWall,min:20,max:200,step:5},
        {id:'ew-shoring',label:'Shoring $/SF',val:ec.shoring,min:10,max:100,step:5},
        {id:'ew-grading',label:'Grading $/SY',val:ec.grading,min:1,max:10,step:0.25},
        {id:'ew-compact',label:'Compact $/CY',val:ec.compaction,min:1,max:10,step:0.25},
        {id:'ew-erosion',label:'Erosion $/SF',val:ec.erosionControl,min:0.25,max:5,step:0.25},
    ];
    costs.forEach(function(c) {
        html += '<div class="dt-slider-group">';
        html += '<div class="dt-slider-label"><span>' + c.label + '</span><span class="dt-val">$' + c.val.toFixed(2) + '</span></div>';
        html += '<div class="dt-slider-row">';
        html += '<input type="number" id="' + c.id + '" value="' + c.val + '" min="' + c.min + '" max="' + c.max + '" step="' + c.step + '" oninput="recalcEarthwork()">';
        html += '</div></div>';
    });
    html += '</div></div>';

    html += '<div id="earthworkContent">';
    html += buildEarthworkContent(ew, st.inp);
    html += '</div>';

    html += '</div></div>';
    return html;
}


// ============================================================
//  SKILL 35: Environmental Constraints & Stormwater
// ============================================================

var FLOOD_ZONE_COSTS = {
    none:  { label: 'Zone X (Minimal)',   insurance: 0,     foundation: 0,     floodproofing: 0 },
    low:   { label: 'Zone X500 (Moderate)', insurance: 800,  foundation: 3.50,  floodproofing: 2.00 },
    high:  { label: 'Zone AE (High Risk)', insurance: 4200,  foundation: 8.00,  floodproofing: 12.00 },
    coastal: { label: 'Zone VE (Coastal)', insurance: 7500,  foundation: 18.00, floodproofing: 22.00 },
};

var SOIL_CLASSIFICATIONS = {
    alluvial:   { label: 'Alluvial (Sandy/Gravel)',   bearing: 3000, settlement: 'low',  expansive: false, liquefaction: 'low',  foundationMult: 1.0 },
    clay:       { label: 'Expansive Clay',            bearing: 1500, settlement: 'high', expansive: true,  liquefaction: 'low',  foundationMult: 1.35 },
    fill:       { label: 'Uncontrolled Fill',         bearing: 1000, settlement: 'high', expansive: false, liquefaction: 'moderate', foundationMult: 1.50 },
    bedrock:    { label: 'Bedrock / Weathered Rock',  bearing: 8000, settlement: 'none', expansive: false, liquefaction: 'none', foundationMult: 1.15 },
    sand:       { label: 'Loose Sand (Saturated)',    bearing: 2000, settlement: 'moderate', expansive: false, liquefaction: 'high', foundationMult: 1.40 },
};

var STORMWATER_REQS = {
    lidPercent:          0.05,   // 5% of site must be LID
    bioswalePerImpSF:    0.04,   // 4% of impervious area as bioswale
    detentionCFperSF:    0.15,   // 0.15 CF detention per SF impervious
    maxImperviousPct:    0.85,   // 85% max impervious in commercial zones
    bioswalePerSF:       28,     // $/SF bioswale construction
    detentionPerCF:      18,     // $/CF underground detention
    permPavingPerSF:     14,     // $/SF permeable paving
    dryWellEach:         8500,   // $ per dry well
    greenRoofPerSF:      32,     // $/SF green roof system
};

function analyzeEnvironmental(useId, inp, computed) {
    var parcelSF = inp.parcelSize || 10000;
    var gsf = computed.gsf || 10000;
    var stories = computed.stories || 1;

    // Flood zone classification
    var floodKey = 'none';
    if (inp.constCoastal) floodKey = 'coastal';
    else if (inp.constFlood) floodKey = 'high';
    else if (inp.topography === 'flat' && (inp.neighborhood === 'harbor' || inp.neighborhood === 'southla')) floodKey = 'low';
    var floodData = FLOOD_ZONE_COSTS[floodKey];
    var floodInsurance = floodData.insurance;
    var floodFoundation = Math.round(parcelSF * floodData.foundation);
    var floodproofingCost = floodKey === 'high' || floodKey === 'coastal' ? Math.round(gsf * floodData.floodproofing * 0.15) : 0;

    // Soil type heuristic
    var soilKey = 'alluvial';
    if (inp.constCoastal) soilKey = 'sand';
    else if (inp.constHillside || inp.topography === 'hillside') soilKey = 'bedrock';
    else if (inp.topography === 'steep') soilKey = 'clay';
    else if (inp.neighborhood === 'harbor' || inp.neighborhood === 'southla') soilKey = 'fill';
    var soilData = SOIL_CLASSIFICATIONS[soilKey];
    var foundationCostMult = soilData.foundationMult;

    // Liquefaction
    var liquefactionRisk = soilData.liquefaction;
    var liquefactionCost = 0;
    if (liquefactionRisk === 'high') liquefactionCost = Math.round(parcelSF * 6.50);
    else if (liquefactionRisk === 'moderate') liquefactionCost = Math.round(parcelSF * 3.00);

    // Landslide risk
    var landslideRisk = 'low';
    if (inp.constHillside || inp.topography === 'hillside') landslideRisk = 'high';
    else if (inp.topography === 'steep') landslideRisk = 'moderate';
    var landslideCost = landslideRisk === 'high' ? Math.round(parcelSF * 8.00) : landslideRisk === 'moderate' ? Math.round(parcelSF * 3.00) : 0;

    // Fault proximity
    var faultRisk = inp.constFault ? 'high' : 'low';
    var faultCost = inp.constFault ? Math.round(gsf * 4.50) : 0;

    // Impervious coverage
    var buildingCoverage = Math.min(0.70, (computed.gsf / stories) / parcelSF);
    var parkingSF = (computed.parkingSpaces || 0) * 350;
    var surfaceParkingPct = stories <= 4 ? Math.min(parkingSF / parcelSF, 0.30) : 0;
    var drivewayPct = 0.05;
    var imperviousPct = Math.min(0.95, buildingCoverage + surfaceParkingPct + drivewayPct);
    var perviousPct = 1 - imperviousPct;
    var imperviousSF = Math.round(parcelSF * imperviousPct);

    // Stormwater LID requirements (LA County MS4 Permit)
    var lidArea = Math.round(parcelSF * STORMWATER_REQS.lidPercent);
    var bioswaleArea = Math.round(imperviousSF * STORMWATER_REQS.bioswalePerImpSF);
    var detentionVolume = Math.round(imperviousSF * STORMWATER_REQS.detentionCFperSF);
    var bioswaleCost = Math.round(bioswaleArea * STORMWATER_REQS.bioswalePerSF);
    var detentionCost = Math.round(detentionVolume * STORMWATER_REQS.detentionPerCF);
    var permPavingArea = Math.round(Math.min(surfaceParkingPct * parcelSF * 0.3, 2000));
    var permPavingCost = Math.round(permPavingArea * STORMWATER_REQS.permPavingPerSF);
    var dryWells = Math.max(1, Math.ceil(imperviousSF / 5000));
    var dryWellCost = dryWells * STORMWATER_REQS.dryWellEach;
    var totalStormwaterCost = bioswaleCost + detentionCost + permPavingCost + dryWellCost;

    // Remediation estimate (brownfield heuristic)
    var remediationRisk = 'low';
    var remediationCost = 0;
    if (useId === 'industrial' || inp.siteCondition === 'demolition') {
        if (inp.neighborhood === 'boyleheights' || inp.neighborhood === 'harbor' || inp.neighborhood === 'southla') {
            remediationRisk = 'moderate';
            remediationCost = Math.round(parcelSF * 12);
        }
    }
    if (inp.neighborhood === 'harbor') {
        remediationRisk = 'high';
        remediationCost = Math.round(parcelSF * 25);
    }

    var totalEnvironmentalCost = floodFoundation + floodproofingCost + liquefactionCost +
        landslideCost + faultCost + totalStormwaterCost + remediationCost;

    return {
        floodZone: floodKey,
        floodData: floodData,
        floodInsurance: floodInsurance,
        floodFoundation: floodFoundation,
        floodproofingCost: floodproofingCost,
        soilType: soilKey,
        soilData: soilData,
        foundationCostMult: foundationCostMult,
        liquefactionRisk: liquefactionRisk,
        liquefactionCost: liquefactionCost,
        landslideRisk: landslideRisk,
        landslideCost: landslideCost,
        faultRisk: faultRisk,
        faultCost: faultCost,
        imperviousPct: imperviousPct,
        perviousPct: perviousPct,
        buildingCoverage: buildingCoverage,
        surfaceParkingPct: surfaceParkingPct,
        stormwater: {
            lidArea: lidArea,
            bioswaleArea: bioswaleArea,
            detentionVolume: detentionVolume,
            bioswaleCost: bioswaleCost,
            detentionCost: detentionCost,
            permPavingArea: permPavingArea,
            permPavingCost: permPavingCost,
            dryWells: dryWells,
            dryWellCost: dryWellCost,
            totalCost: totalStormwaterCost,
        },
        remediationRisk: remediationRisk,
        remediationCost: remediationCost,
        totalCost: totalEnvironmentalCost,
    };
}

// Environmental tab cost multiplier
var envCostMult = 1.0;

function recalcEnvironmental() {
    var el = document.getElementById('env-costMult');
    if (el) envCostMult = parseFloat(el.value) / 100;
    var slider = document.getElementById('env-costMult-slider');
    var num = document.getElementById('env-costMult');
    if (slider && num && document.activeElement === slider) num.value = slider.value;
    if (slider && num && document.activeElement === num) slider.value = num.value;
    var valSpan = document.getElementById('env-costMult-val');
    if (valSpan && num) valSpan.textContent = parseFloat(num.value).toFixed(0) + '%';
    _debouncedCall('environmental', function() {
        var container = document.getElementById('environmentalContent');
        if (container && deepAnalysisState) container.innerHTML = buildEnvironmentalContent();
    }, 150);
}

function resetEnvironmental() {
    envCostMult = 1.0;
    var slider = document.getElementById('env-costMult-slider');
    var num = document.getElementById('env-costMult');
    if (slider) slider.value = 100;
    if (num) num.value = 100;
    recalcEnvironmental();
}

function buildEnvironmentalContent() {
    var st = deepAnalysisState;
    if (!st) return '';
    var inp = st.inp;
    var env = analyzeEnvironmental(st.bestUse, inp, st.computed);
    var m = envCostMult;

    function riskColor(level) {
        if (level === 'high') return '#c53030';
        if (level === 'moderate') return '#dd6b20';
        return '#38a169';
    }
    function riskBg(level) {
        if (level === 'high') return '#fff5f5';
        if (level === 'moderate') return '#fffff0';
        return '#f0fff4';
    }

    var html = '';
    html += '<div class="analysis-section"><h3>Environmental Constraints Summary</h3>';
    var risks = [
        { label: 'Flood Zone', level: env.floodZone === 'none' ? 'low' : (env.floodZone === 'low' ? 'moderate' : 'high'), detail: env.floodData.label + ' | Insurance: ' + fmt(env.floodInsurance) + '/yr' },
        { label: 'Soil / Foundation', level: env.soilData.expansive || env.soilData.settlement === 'high' ? 'moderate' : 'low', detail: env.soilData.label + ' | Bearing: ' + env.soilData.bearing.toLocaleString() + ' psf' },
        { label: 'Liquefaction', level: env.liquefactionRisk, detail: 'Risk: ' + env.liquefactionRisk + ' | Mitigation: ' + formatCompactDollars(Math.round(env.liquefactionCost * m)) },
        { label: 'Landslide', level: env.landslideRisk, detail: 'Risk: ' + env.landslideRisk + ' | Mitigation: ' + formatCompactDollars(Math.round(env.landslideCost * m)) },
        { label: 'Fault Proximity', level: env.faultRisk, detail: (inp.constFault ? 'Within Alquist-Priolo zone' : 'Outside mapped fault zone') + ' | Cost: ' + formatCompactDollars(Math.round(env.faultCost * m)) },
        { label: 'Remediation', level: env.remediationRisk, detail: 'Contamination risk: ' + env.remediationRisk + ' | Est: ' + formatCompactDollars(Math.round(env.remediationCost * m)) },
    ];
    html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:0.75rem;">';
    for (var i = 0; i < risks.length; i++) {
        var r = risks[i];
        html += '<div style="background:' + riskBg(r.level) + ';border-left:4px solid ' + riskColor(r.level) + ';border-radius:0 8px 8px 0;padding:0.85rem 1rem;">';
        html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.25rem;"><strong style="font-size:0.88rem;color:' + riskColor(r.level) + ';">' + r.label + '</strong>';
        html += '<span class="risk-badge" style="color:' + riskColor(r.level) + ';background:rgba(255,255,255,0.7);font-size:0.72rem;"><span class="risk-dot" style="background:' + riskColor(r.level) + '"></span> ' + r.level.toUpperCase() + '</span></div>';
        html += '<p style="font-size:0.8rem;color:var(--text-light);margin:0;">' + r.detail + '</p></div>';
    }
    html += '</div></div>';

    var impPct = Math.round(env.imperviousPct * 100);
    var bldgPct = Math.round(env.buildingCoverage * 100);
    var parkPct = Math.round(env.surfaceParkingPct * 100);
    var openPct = Math.round(env.perviousPct * 100);
    var overLimit = env.imperviousPct > STORMWATER_REQS.maxImperviousPct;

    html += '<div class="analysis-section"><h3>Impervious Coverage Analysis</h3>';
    html += '<div style="display:flex;height:32px;border-radius:8px;overflow:hidden;margin-bottom:0.75rem;">';
    html += '<div style="width:' + bldgPct + '%;background:#2b6cb0;display:flex;align-items:center;justify-content:center;color:white;font-size:0.7rem;font-weight:600;">Bldg ' + bldgPct + '%</div>';
    html += '<div style="width:' + parkPct + '%;background:#718096;display:flex;align-items:center;justify-content:center;color:white;font-size:0.7rem;font-weight:600;">' + (parkPct > 5 ? 'Pkg ' + parkPct + '%' : '') + '</div>';
    html += '<div style="width:5%;background:#a0aec0;display:flex;align-items:center;justify-content:center;color:white;font-size:0.65rem;">5%</div>';
    html += '<div style="width:' + openPct + '%;background:#48bb78;display:flex;align-items:center;justify-content:center;color:white;font-size:0.7rem;font-weight:600;">Open ' + openPct + '%</div>';
    html += '</div>';
    html += '<p style="font-size:0.82rem;color:var(--text-light);">Total impervious: <strong style="color:' + (overLimit ? '#c53030' : '#276749') + ';">' + impPct + '%</strong> (code limit: ' + Math.round(STORMWATER_REQS.maxImperviousPct * 100) + '%) ' + (overLimit ? '<span style="color:#c53030;font-weight:700;">EXCEEDS LIMIT</span>' : '<span style="color:#276749;">COMPLIANT</span>') + '</p>';
    html += '</div>';

    html += '<div class="analysis-section"><h3>Stormwater / LID Compliance</h3>';
    html += '<table class="budget-table"><tr class="section-header"><td colspan="3">Stormwater Infrastructure</td></tr>';
    html += '<tr><th style="text-align:left;">Component</th><th>Size</th><th>Cost</th></tr>';
    html += '<tr><td>Bioswale / Rain Garden</td><td class="dim">' + env.stormwater.bioswaleArea.toLocaleString() + ' SF</td><td>' + fmt(Math.round(env.stormwater.bioswaleCost * m)) + '</td></tr>';
    html += '<tr><td>Underground Detention</td><td class="dim">' + env.stormwater.detentionVolume.toLocaleString() + ' CF</td><td>' + fmt(Math.round(env.stormwater.detentionCost * m)) + '</td></tr>';
    html += '<tr><td>Permeable Paving</td><td class="dim">' + env.stormwater.permPavingArea.toLocaleString() + ' SF</td><td>' + fmt(Math.round(env.stormwater.permPavingCost * m)) + '</td></tr>';
    html += '<tr><td>Dry Wells</td><td class="dim">' + env.stormwater.dryWells + ' units</td><td>' + fmt(Math.round(env.stormwater.dryWellCost * m)) + '</td></tr>';
    html += '<tr class="subtotal"><td colspan="2">Total Stormwater</td><td>' + fmt(Math.round(env.stormwater.totalCost * m)) + '</td></tr>';
    html += '</table></div>';

    html += '<div class="analysis-section"><h3>Total Environmental Cost Impact</h3>';
    html += '<div class="exec-summary-grid">';
    html += '<div class="exec-summary-card"><h4>Total Environmental Costs</h4><div class="exec-metric-lg">' + formatCompactDollars(Math.round(env.totalCost * m)) + '</div><div class="exec-metric-sub">' + (env.totalCost * m / st.computed.totalDev * 100).toFixed(1) + '% of total development cost</div></div>';
    html += '<div class="exec-summary-card"><h4>Annual Flood Insurance</h4><div class="exec-metric-lg">' + fmt(env.floodInsurance) + '</div><div class="exec-metric-sub">' + env.floodData.label + '</div></div>';
    html += '</div></div>';
    return html;
}

function renderEnvironmentalTab(st) {
    var html = '<div class="deep-tab-panel">';
    html += '<div class="dt-controls"><div class="dt-controls-title">Adjust Cost Estimates <button class="dt-reset-btn" onclick="resetEnvironmental()">Reset Defaults</button></div>';
    html += '<div class="dt-controls-grid"><div class="dt-slider-group">';
    html += '<div class="dt-slider-label"><span>Environmental Cost Multiplier</span><span class="dt-val" id="env-costMult-val">100%</span></div>';
    html += '<div class="dt-slider-row">';
    html += '<input type="range" id="env-costMult-slider" min="50" max="200" step="10" value="100" oninput="document.getElementById(\'env-costMult\').value=this.value;recalcEnvironmental()">';
    html += '<input type="number" id="env-costMult" min="50" max="200" step="10" value="100" oninput="document.getElementById(\'env-costMult-slider\').value=this.value;recalcEnvironmental()">';
    html += '</div></div></div></div>';
    html += '<div id="environmentalContent">' + buildEnvironmentalContent() + '</div>';
    html += '</div>';
    return html;
}


// ============================================================
//  SKILL 36: Parking Design & Layout Analyzer
// ============================================================

var PARKING_DESIGN_PARAMS = {
    standard: { width: 8.5, length: 18, label: 'Standard (8.5x18)', pctOfTotal: 0.70 },
    compact:  { width: 7.5, length: 15, label: 'Compact (7.5x15)',  pctOfTotal: 0.15 },
    ada:      { width: 12,  length: 18, label: 'ADA (12x18)',       pctOfTotal: null },
    ev:       { width: 8.5, length: 18, label: 'EV-Ready (8.5x18)', pctOfTotal: 0.10 },
    surface:     { costPerSpace: 8500,  sfPerSpace: 350, efficiency: 0.55, label: 'Surface Parking' },
    podium:      { costPerSpace: 42000, sfPerSpace: 380, efficiency: 0.72, label: 'Podium / Above-Grade' },
    subterranean:{ costPerSpace: 72000, sfPerSpace: 400, efficiency: 0.80, label: 'Subterranean Garage' },
    mechanical:  { costPerSpace: 35000, sfPerSpace: 120, efficiency: 0.90, label: 'Mechanical / Stackers' },
    aisleWidth: 24,
    monthlyRates: {
        dtla: 250, hollywood: 200, koreatown: 175, westside: 225, santamonica: 275,
        beverly: 300, midcity: 175, southla: 100, valleyeast: 125, valleywest: 135,
        silverlake: 175, highland: 125, venice: 225, culver: 200, exposition: 150,
        southbay: 125, harbor: 100, boyleheights: 100,
    },
};

function analyzeParkingDesign(useId, inp, computed) {
    var totalSpaces = computed.parkingSpaces || 0;
    if (totalSpaces === 0) totalSpaces = 1;

    // Space type breakdown
    var adaSpaces = Math.max(1, Math.ceil(totalSpaces / 25));
    var remaining = totalSpaces - adaSpaces;
    var evSpaces = Math.max(1, Math.ceil(remaining * 0.10));
    var compactSpaces = Math.ceil(remaining * 0.15);
    var standardSpaces = remaining - evSpaces - compactSpaces;

    var spacesByType = {
        standard: standardSpaces,
        compact: compactSpaces,
        ada: adaSpaces,
        ev: evSpaces,
    };

    // Strategy analysis
    var parcelSF = inp.parcelSize || 10000;
    var stories = computed.stories || 1;

    var strategies = [];

    // Surface
    var surfaceSF = totalSpaces * PARKING_DESIGN_PARAMS.surface.sfPerSpace;
    var surfacePct = surfaceSF / parcelSF;
    strategies.push({
        name: 'Surface Parking',
        type: 'surface',
        spaces: totalSpaces,
        cost: totalSpaces * PARKING_DESIGN_PARAMS.surface.costPerSpace,
        sfPerSpace: PARKING_DESIGN_PARAMS.surface.sfPerSpace,
        totalSF: surfaceSF,
        sitePct: surfacePct,
        pros: ['Lowest cost per space', 'Fastest to build', 'Easy maintenance'],
        cons: ['Largest land use', surfacePct > 0.4 ? 'Exceeds 40% site coverage' : 'Reduces buildable area', 'No revenue premium'],
        viable: surfacePct <= 0.60 && stories <= 4,
    });

    // Podium
    var podiumLevels = Math.ceil(totalSpaces / Math.floor(parcelSF * 0.65 / PARKING_DESIGN_PARAMS.podium.sfPerSpace));
    strategies.push({
        name: 'Podium / Above-Grade',
        type: 'podium',
        spaces: totalSpaces,
        cost: totalSpaces * PARKING_DESIGN_PARAMS.podium.costPerSpace,
        sfPerSpace: PARKING_DESIGN_PARAMS.podium.sfPerSpace,
        totalSF: totalSpaces * PARKING_DESIGN_PARAMS.podium.sfPerSpace,
        levels: podiumLevels,
        pros: ['Efficient land use', 'Integrates with building', 'Common for mid-rise'],
        cons: ['Higher cost than surface', 'Adds building height', 'Structural complexity'],
        viable: stories >= 3,
    });

    // Subterranean
    var subLevels = Math.ceil(totalSpaces / Math.floor(parcelSF * 0.70 / PARKING_DESIGN_PARAMS.subterranean.sfPerSpace));
    strategies.push({
        name: 'Subterranean Garage',
        type: 'subterranean',
        spaces: totalSpaces,
        cost: totalSpaces * PARKING_DESIGN_PARAMS.subterranean.costPerSpace,
        sfPerSpace: PARKING_DESIGN_PARAMS.subterranean.sfPerSpace,
        totalSF: totalSpaces * PARKING_DESIGN_PARAMS.subterranean.sfPerSpace,
        levels: subLevels,
        pros: ['Zero surface impact', 'Maximizes buildable area', 'Premium feel'],
        cons: ['Highest cost', 'Excavation/shoring required', 'Longer construction'],
        viable: stories >= 4 || useId === 'hotel' || useId === 'medical',
    });

    // Mechanical
    strategies.push({
        name: 'Mechanical / Stackers',
        type: 'mechanical',
        spaces: totalSpaces,
        cost: totalSpaces * PARKING_DESIGN_PARAMS.mechanical.costPerSpace,
        sfPerSpace: PARKING_DESIGN_PARAMS.mechanical.sfPerSpace,
        totalSF: totalSpaces * PARKING_DESIGN_PARAMS.mechanical.sfPerSpace,
        pros: ['Smallest footprint', 'Good for tight sites', 'Innovative'],
        cons: ['Maintenance intensive', 'Slower retrieval', 'Tenant resistance', 'Mechanical failure risk'],
        viable: parcelSF < 8000 || totalSpaces > 100,
    });

    // Revenue analysis
    var monthlyRate = (PARKING_DESIGN_PARAMS.monthlyRates[inp.neighborhood] || 150);
    var revenuePerSpace = monthlyRate;
    var revenueSpaces = Math.round(totalSpaces * 0.15);
    var annualParkingRevenue = revenueSpaces * monthlyRate * 12;

    // Best strategy recommendation
    var bestStrategy = 'surface';
    if (stories >= 7) bestStrategy = 'subterranean';
    else if (stories >= 3) bestStrategy = 'podium';
    else if (parcelSF < 6000) bestStrategy = 'mechanical';

    return {
        totalSpaces: totalSpaces,
        spacesByType: spacesByType,
        strategies: strategies,
        revenuePerSpace: revenuePerSpace,
        revenueSpaces: revenueSpaces,
        annualParkingRevenue: annualParkingRevenue,
        bestStrategy: bestStrategy,
    };
}

function generateParkingLayoutSVG(strategy, totalSpaces) {
    var w = 400, h = 200;
    var svg = '<svg viewBox="0 0 ' + w + ' ' + h + '" xmlns="http://www.w3.org/2000/svg" style="background:#fafbfc;">';

    var type = strategy.type;
    var color = type === 'surface' ? '#718096' : type === 'podium' ? '#2b6cb0' : type === 'subterranean' ? '#805ad5' : '#dd6b20';

    svg += '<text x="' + (w / 2) + '" y="16" text-anchor="middle" font-size="10" fill="#1a365d" font-weight="700">' + strategy.name.toUpperCase() + '</text>';

    if (type === 'surface') {
        // Surface lot layout
        svg += '<rect x="20" y="28" width="360" height="150" fill="#e2e8f0" stroke="#a0aec0" stroke-width="1" rx="4"/>';
        // Drive aisle
        svg += '<rect x="20" y="90" width="360" height="28" fill="#cbd5e0"/>';
        svg += '<line x1="20" y1="104" x2="380" y2="104" stroke="#fff" stroke-width="1.5" stroke-dasharray="8,6"/>';
        // Stalls top
        var stallW = 16;
        var cols = Math.min(Math.floor(340 / stallW), totalSpaces / 2);
        for (var i = 0; i < cols; i++) {
            svg += '<rect x="' + (30 + i * stallW) + '" y="32" width="' + (stallW - 2) + '" height="54" fill="' + color + '" opacity="0.3" stroke="white" stroke-width="0.5" rx="1"/>';
        }
        // Stalls bottom
        for (var j = 0; j < cols; j++) {
            svg += '<rect x="' + (30 + j * stallW) + '" y="122" width="' + (stallW - 2) + '" height="50" fill="' + color + '" opacity="0.3" stroke="white" stroke-width="0.5" rx="1"/>';
        }
        svg += '<text x="200" y="108" text-anchor="middle" font-size="8" fill="#4a5568" font-weight="600">DRIVE AISLE (24\')</text>';
    } else if (type === 'podium') {
        // Podium cross section
        var levels = strategy.levels || 1;
        var levelH = Math.min(40, 120 / levels);
        for (var k = 0; k < levels; k++) {
            var y = 30 + k * levelH;
            svg += '<rect x="60" y="' + y + '" width="280" height="' + (levelH - 2) + '" fill="' + color + '" opacity="' + (0.2 + k * 0.1) + '" stroke="' + color + '" stroke-width="1" rx="2"/>';
            svg += '<text x="200" y="' + (y + levelH / 2 + 3) + '" text-anchor="middle" font-size="8" fill="' + color + '" font-weight="600">P' + (k + 1) + ' (' + Math.ceil(totalSpaces / levels) + ' spaces)</text>';
        }
        // Building above
        var buildY = 30 + levels * levelH;
        svg += '<rect x="60" y="' + buildY + '" width="280" height="' + (h - buildY - 20) + '" fill="#38a169" opacity="0.2" stroke="#38a169" stroke-width="1" rx="2"/>';
        svg += '<text x="200" y="' + (buildY + (h - buildY - 20) / 2 + 3) + '" text-anchor="middle" font-size="9" fill="#276749" font-weight="600">BUILDING ABOVE</text>';
    } else if (type === 'subterranean') {
        // Subterranean cross section
        var sLevels = strategy.levels || 1;
        svg += '<rect x="40" y="28" width="320" height="30" fill="#48bb78" opacity="0.2" stroke="#48bb78" stroke-width="1" rx="2"/>';
        svg += '<text x="200" y="47" text-anchor="middle" font-size="9" fill="#276749" font-weight="600">GROUND LEVEL</text>';
        svg += '<line x1="40" y1="60" x2="360" y2="60" stroke="#8B4513" stroke-width="3"/>';
        var sLevelH = Math.min(45, 120 / sLevels);
        for (var m = 0; m < sLevels; m++) {
            var sy = 64 + m * sLevelH;
            svg += '<rect x="50" y="' + sy + '" width="300" height="' + (sLevelH - 3) + '" fill="' + color + '" opacity="' + (0.3 + m * 0.1) + '" stroke="' + color + '" stroke-width="1" rx="2"/>';
            svg += '<text x="200" y="' + (sy + sLevelH / 2 + 2) + '" text-anchor="middle" font-size="8" fill="white" font-weight="600">B' + (m + 1) + ' (' + Math.ceil(totalSpaces / sLevels) + ' spaces)</text>';
        }
    } else {
        // Mechanical stackers
        svg += '<rect x="60" y="28" width="280" height="150" fill="#f7fafc" stroke="#e2e8f0" stroke-width="1" rx="4"/>';
        var stackCols = Math.min(8, Math.ceil(totalSpaces / 3));
        var cw = 240 / stackCols;
        for (var n = 0; n < stackCols; n++) {
            for (var row = 0; row < 3; row++) {
                svg += '<rect x="' + (80 + n * cw) + '" y="' + (40 + row * 42) + '" width="' + (cw - 4) + '" height="36" fill="' + color + '" opacity="' + (0.2 + row * 0.15) + '" stroke="' + color + '" stroke-width="0.5" rx="2"/>';
            }
            svg += '<line x1="' + (80 + n * cw + cw / 2) + '" y1="35" x2="' + (80 + n * cw + cw / 2) + '" y2="170" stroke="#a0aec0" stroke-width="0.5" stroke-dasharray="2,2"/>';
        }
        svg += '<text x="200" y="185" text-anchor="middle" font-size="8" fill="#4a5568" font-weight="600">MECHANICAL STACKER BAYS</text>';
    }

    svg += '</svg>';
    return svg;
}

// Parking dynamic controls
var PARKING_COST_DEFAULTS = {
    surfaceCost: 8500, podiumCost: 42000, subCost: 72000, mechCost: 35000,
    leasablePct: 15, compactPct: 15
};
var parkingOverrides = null;

function getParkingParams() {
    var d = PARKING_COST_DEFAULTS, o = parkingOverrides || {};
    var r = {};
    Object.keys(d).forEach(function(k) { r[k] = o[k] != null ? o[k] : d[k]; });
    return r;
}

function buildPkSlider(id, label, val, min, max, step, suffix) {
    suffix = suffix || '';
    var dec = step < 1 ? 1 : 0;
    var isCurrency = suffix === '$';
    var h = '<div class="dt-slider-group">';
    h += '<div class="dt-slider-label"><span>' + label + '</span><span class="dt-val" id="pk-' + id + '-val">' + (isCurrency ? '$' + val.toLocaleString() : val.toFixed(dec) + suffix) + '</span></div>';
    h += '<div class="dt-slider-row">';
    h += '<input type="range" id="pk-' + id + '-slider" min="' + min + '" max="' + max + '" step="' + step + '" value="' + val + '" oninput="document.getElementById(\'pk-' + id + '\').value=this.value;recalcParking()">';
    h += '<input type="number" id="pk-' + id + '" min="' + min + '" max="' + max + '" step="' + step + '" value="' + val + '" oninput="document.getElementById(\'pk-' + id + '-slider\').value=this.value;recalcParking()">';
    h += '</div></div>';
    return h;
}

function recalcParking() {
    if (!parkingOverrides) parkingOverrides = {};
    Object.keys(PARKING_COST_DEFAULTS).forEach(function(f) {
        var el = document.getElementById('pk-' + f);
        if (el) parkingOverrides[f] = parseFloat(el.value);
    });
    Object.keys(PARKING_COST_DEFAULTS).forEach(function(f) {
        var slider = document.getElementById('pk-' + f + '-slider');
        var num = document.getElementById('pk-' + f);
        if (slider && num && document.activeElement === slider) num.value = slider.value;
        if (slider && num && document.activeElement === num) slider.value = num.value;
        var valSpan = document.getElementById('pk-' + f + '-val');
        if (valSpan && num) {
            var v = parseFloat(num.value);
            var isCost = ['surfaceCost','podiumCost','subCost','mechCost'].indexOf(f) >= 0;
            valSpan.textContent = isCost ? '$' + Math.round(v).toLocaleString() : v.toFixed(0) + '%';
        }
    });
    _debouncedCall('parking', function() {
        var container = document.getElementById('parkingContent');
        if (container) container.innerHTML = buildParkingContent();
    }, 150);
}

function resetParking() {
    parkingOverrides = null;
    Object.keys(PARKING_COST_DEFAULTS).forEach(function(f) {
        var slider = document.getElementById('pk-' + f + '-slider');
        var num = document.getElementById('pk-' + f);
        if (slider) slider.value = PARKING_COST_DEFAULTS[f];
        if (num) num.value = PARKING_COST_DEFAULTS[f];
    });
    recalcParking();
}

function buildParkingContent() {
    var st = deepAnalysisState;
    if (!st) return '';
    var pp = getParkingParams();

    // Override cost per space temporarily
    var origSurface = PARKING_DESIGN_PARAMS.surface.costPerSpace;
    var origPodium = PARKING_DESIGN_PARAMS.podium.costPerSpace;
    var origSub = PARKING_DESIGN_PARAMS.subterranean.costPerSpace;
    var origMech = PARKING_DESIGN_PARAMS.mechanical.costPerSpace;
    PARKING_DESIGN_PARAMS.surface.costPerSpace = pp.surfaceCost;
    PARKING_DESIGN_PARAMS.podium.costPerSpace = pp.podiumCost;
    PARKING_DESIGN_PARAMS.subterranean.costPerSpace = pp.subCost;
    PARKING_DESIGN_PARAMS.mechanical.costPerSpace = pp.mechCost;

    var pkg = analyzeParkingDesign(st.bestUse, st.inp, st.computed);
    pkg.revenueSpaces = Math.round(pkg.totalSpaces * (pp.leasablePct / 100));
    pkg.annualParkingRevenue = pkg.revenueSpaces * pkg.revenuePerSpace * 12;

    // Restore
    PARKING_DESIGN_PARAMS.surface.costPerSpace = origSurface;
    PARKING_DESIGN_PARAMS.podium.costPerSpace = origPodium;
    PARKING_DESIGN_PARAMS.subterranean.costPerSpace = origSub;
    PARKING_DESIGN_PARAMS.mechanical.costPerSpace = origMech;

    var html = '';
    html += '<div class="exec-summary-grid">';
    html += '<div class="exec-summary-card"><h4>Total Spaces Required</h4><div class="exec-metric-lg">' + pkg.totalSpaces + '</div><div class="exec-metric-sub">Standard: ' + pkg.spacesByType.standard + ' | Compact: ' + pkg.spacesByType.compact + ' | ADA: ' + pkg.spacesByType.ada + ' | EV: ' + pkg.spacesByType.ev + '</div></div>';
    html += '<div class="exec-summary-card"><h4>Recommended Strategy</h4><div class="exec-metric-lg" style="font-size:1.2rem;">' + pkg.strategies.find(function(s) { return s.type === pkg.bestStrategy; }).name + '</div><div class="exec-metric-sub">Best fit for ' + st.computed.stories + '-story ' + (LAND_USES.find(function(u) { return u.id === st.bestUse; }) || {}).name + '</div></div>';
    html += '</div>';

    html += '<h4 style="color:var(--primary);margin:1.25rem 0 0.75rem;">Strategy Comparison</h4>';
    html += '<div style="overflow-x:auto;"><table class="budget-table">';
    html += '<tr><th style="text-align:left;">Strategy</th><th>Cost/Space</th><th>Total Cost</th><th>SF/Space</th><th>Total SF</th><th>Viable?</th></tr>';
    for (var i = 0; i < pkg.strategies.length; i++) {
        var s = pkg.strategies[i];
        var isBest = s.type === pkg.bestStrategy;
        html += '<tr style="' + (isBest ? 'background:#f0fff4;font-weight:600;' : '') + '">';
        html += '<td>' + s.name + (isBest ? ' <span style="color:#276749;font-size:0.72rem;">RECOMMENDED</span>' : '') + '</td>';
        html += '<td>' + fmt(s.cost / s.spaces) + '</td>';
        html += '<td>' + formatCompactDollars(s.cost) + '</td>';
        html += '<td>' + s.sfPerSpace + '</td>';
        html += '<td>' + s.totalSF.toLocaleString() + '</td>';
        html += '<td>' + (s.viable ? '<span class="pass">Yes</span>' : '<span class="fail">No</span>') + '</td>';
        html += '</tr>';
    }
    html += '</table></div>';

    html += '<h4 style="color:var(--primary);margin:1.5rem 0 0.75rem;">Layout Diagrams</h4>';
    html += '<div class="rendering-container">';
    for (var j = 0; j < pkg.strategies.length; j++) {
        html += '<div>' + generateParkingLayoutSVG(pkg.strategies[j], pkg.totalSpaces) + '</div>';
    }
    html += '</div>';

    html += '<h4 style="color:var(--primary);margin:1.5rem 0 0.75rem;">Pros & Cons</h4>';
    html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:0.75rem;">';
    for (var k = 0; k < pkg.strategies.length; k++) {
        var st2 = pkg.strategies[k];
        var isBest2 = st2.type === pkg.bestStrategy;
        html += '<div class="exec-summary-card" style="' + (isBest2 ? 'border:2px solid #38a169;' : '') + '">';
        html += '<h4>' + st2.name + '</h4>';
        html += '<div style="font-size:0.78rem;"><strong style="color:#276749;">Pros:</strong><ul style="margin:0.25rem 0 0.5rem 1rem;">';
        for (var p = 0; p < st2.pros.length; p++) { html += '<li>' + st2.pros[p] + '</li>'; }
        html += '</ul><strong style="color:#c53030;">Cons:</strong><ul style="margin:0.25rem 0 0 1rem;">';
        for (var cc = 0; cc < st2.cons.length; cc++) { html += '<li>' + st2.cons[cc] + '</li>'; }
        html += '</ul></div></div>';
    }
    html += '</div>';

    html += '</div><div class="analysis-section"><h3>Parking Revenue Analysis</h3>';
    html += '<div class="exec-summary-grid">';
    html += '<div class="exec-summary-card"><h4>Monthly Rate (Market)</h4><div class="exec-metric-lg">' + fmt(pkg.revenuePerSpace) + '<span style="font-size:0.7rem;font-weight:400;color:var(--text-light);">/space/mo</span></div><div class="exec-metric-sub">Neighborhood: ' + st.inp.neighborhood + '</div></div>';
    html += '<div class="exec-summary-card"><h4>Leasable Spaces</h4><div class="exec-metric-lg">' + pkg.revenueSpaces + '</div><div class="exec-metric-sub">' + Math.round(pkg.revenueSpaces / pkg.totalSpaces * 100) + '% of total available for lease</div></div>';
    html += '<div class="exec-summary-card"><h4>Annual Parking Revenue</h4><div class="exec-metric-lg">' + formatCompactDollars(pkg.annualParkingRevenue) + '</div><div class="exec-metric-sub">' + fmt(pkg.annualParkingRevenue / 12) + '/month</div></div>';
    html += '<div class="exec-summary-card"><h4>Revenue vs Cost</h4><div class="exec-metric-lg">' + (pkg.annualParkingRevenue / (pkg.strategies.find(function(ss) { return ss.type === pkg.bestStrategy; }).cost || 1) * 100).toFixed(1) + '%</div><div class="exec-metric-sub">Annual yield on parking investment</div></div>';
    html += '</div></div>';
    return html;
}

function renderParkingTab(st) {
    var pp = getParkingParams();
    var html = '<div class="deep-tab-panel">';
    html += '<div class="analysis-section"><h3>Parking Design & Layout Analysis</h3>';

    html += '<div class="dt-controls"><div class="dt-controls-title">Adjust Parking Costs <button class="dt-reset-btn" onclick="resetParking()">Reset Defaults</button></div>';
    html += '<div class="dt-controls-grid">';
    html += buildPkSlider('surfaceCost', 'Surface Cost/Space', pp.surfaceCost, 3000, 15000, 500, '$');
    html += buildPkSlider('podiumCost', 'Podium Cost/Space', pp.podiumCost, 25000, 65000, 1000, '$');
    html += buildPkSlider('subCost', 'Subterranean Cost/Space', pp.subCost, 45000, 100000, 1000, '$');
    html += buildPkSlider('mechCost', 'Mechanical Cost/Space', pp.mechCost, 20000, 55000, 1000, '$');
    html += buildPkSlider('leasablePct', 'Leasable Spaces %', pp.leasablePct, 5, 40, 5, '%');
    html += buildPkSlider('compactPct', 'Compact Spaces %', pp.compactPct, 0, 30, 5, '%');
    html += '</div></div>';

    html += '<div id="parkingContent">' + buildParkingContent() + '</div>';
    html += '</div></div>';
    return html;
}


// ============================================================
//  SKILL 33: Enhanced Site Plan & 3D Massing
// ============================================================

function generateEnhancedSitePlanSVG(useId, inp, budget) {
    var w = 440, h = 380;
    var params = budget.params;
    var color = USE_COLORS[useId] || '#3182ce';

    var lotW = inp.frontage || Math.sqrt(inp.parcelSize * 2);
    var lotD = inp.parcelSize / lotW;
    var maxDim = Math.max(lotW, lotD);
    var scale = 220 / maxDim;
    var lw = lotW * scale, ld = lotD * scale;
    var ox = (w - lw) / 2, oy = 30;

    var setFront = budget.setbacks ? budget.setbacks.front : params.setF;
    var setSide = budget.setbacks ? budget.setbacks.side : params.setS;
    var setRear = budget.setbacks ? budget.setbacks.rear : params.setS;
    var sf = setFront * scale, ss = setSide * scale, sr = setRear * scale;
    var bw = Math.max(30, lw - 2 * ss);
    var bd = Math.max(30, ld - sf - sr);
    var bx = ox + ss, by = oy + sr;

    var svg = '<svg viewBox="0 0 ' + w + ' ' + h + '" xmlns="http://www.w3.org/2000/svg" style="background:#fafbfc;">';
    svg += '<defs>';
    svg += '<pattern id="ht2" width="6" height="6" patternUnits="userSpaceOnUse"><path d="M0,6 L6,0" stroke="#ccc" stroke-width="0.5"/></pattern>';
    svg += '<pattern id="grass" width="4" height="4" patternUnits="userSpaceOnUse"><circle cx="2" cy="2" r="1" fill="#48bb78" opacity="0.3"/></pattern>';
    svg += '</defs>';

    // Lot boundary
    svg += '<rect x="' + ox + '" y="' + oy + '" width="' + lw + '" height="' + ld + '" fill="#e8f5e9" stroke="#66bb6a" stroke-width="1.5" rx="2"/>';

    // Setback lines (dashed red)
    svg += '<rect x="' + (ox + ss) + '" y="' + (oy + sr) + '" width="' + (lw - 2 * ss) + '" height="' + (ld - sf - sr) + '" fill="none" stroke="#e53e3e" stroke-width="1" stroke-dasharray="4,3" rx="1"/>';
    // Setback hatching (front)
    if (sf > 3) {
        svg += '<rect x="' + ox + '" y="' + (oy + ld - sf) + '" width="' + lw + '" height="' + sf + '" fill="url(#ht2)" opacity="0.4"/>';
        svg += '<text x="' + (ox + lw / 2) + '" y="' + (oy + ld - sf / 2 + 3) + '" text-anchor="middle" font-size="7" fill="#e53e3e" font-weight="600">FRONT SETBACK ' + setFront + '\'</text>';
    }
    // Setback hatching (rear)
    if (sr > 3) {
        svg += '<rect x="' + ox + '" y="' + oy + '" width="' + lw + '" height="' + sr + '" fill="url(#ht2)" opacity="0.3"/>';
        svg += '<text x="' + (ox + lw / 2) + '" y="' + (oy + sr / 2 + 3) + '" text-anchor="middle" font-size="7" fill="#e53e3e" font-weight="600">REAR ' + setRear + '\'</text>';
    }

    // Landscaping strips (green)
    var lsW = Math.max(4, ss * 0.6);
    svg += '<rect x="' + ox + '" y="' + oy + '" width="' + lsW + '" height="' + ld + '" fill="url(#grass)" stroke="#48bb78" stroke-width="0.5"/>';
    svg += '<rect x="' + (ox + lw - lsW) + '" y="' + oy + '" width="' + lsW + '" height="' + ld + '" fill="url(#grass)" stroke="#48bb78" stroke-width="0.5"/>';

    // Building footprint
    svg += '<rect x="' + bx + '" y="' + by + '" width="' + bw + '" height="' + (bd * 0.65) + '" fill="' + color + '" opacity="0.8" stroke="' + color + '" stroke-width="2" rx="2"/>';
    svg += '<text x="' + (bx + bw / 2) + '" y="' + (by + bd * 0.325 - 5) + '" text-anchor="middle" font-size="10" fill="white" font-weight="700">BUILDING</text>';
    svg += '<text x="' + (bx + bw / 2) + '" y="' + (by + bd * 0.325 + 8) + '" text-anchor="middle" font-size="8" fill="rgba(255,255,255,0.85)">' + budget.buildingFootprint.toLocaleString() + ' SF | ' + budget.stories + ' Stories</text>';

    // Parking zone
    var pkgY = by + bd * 0.65 + 6;
    var pkgH = Math.max(20, bd * 0.28);
    svg += '<rect x="' + bx + '" y="' + pkgY + '" width="' + bw + '" height="' + pkgH + '" fill="#cbd5e0" stroke="#a0aec0" stroke-width="1" rx="2"/>';

    // Individual stalls
    var stallW = Math.max(5, bw / Math.min(20, budget.parkingSpaces));
    var stallCount = Math.min(20, Math.floor(bw / stallW));
    for (var i = 0; i < stallCount; i++) {
        svg += '<rect x="' + (bx + 1 + i * stallW) + '" y="' + (pkgY + 1) + '" width="' + (stallW - 1.5) + '" height="' + (pkgH / 2 - 1) + '" fill="none" stroke="#fff" stroke-width="0.5" rx="0.5"/>';
    }
    // Drive aisle
    svg += '<line x1="' + bx + '" y1="' + (pkgY + pkgH / 2 + 1) + '" x2="' + (bx + bw) + '" y2="' + (pkgY + pkgH / 2 + 1) + '" stroke="white" stroke-width="0.8" stroke-dasharray="4,3"/>';
    svg += '<text x="' + (bx + bw / 2) + '" y="' + (pkgY + pkgH - 4) + '" text-anchor="middle" font-size="6" fill="#4a5568" font-weight="600">PARKING (' + budget.parkingSpaces + ' SPACES)</text>';

    // Dimensions
    svg += '<text x="' + (ox + lw / 2) + '" y="' + (oy - 8) + '" text-anchor="middle" font-size="9" fill="#666">' + Math.round(lotW) + '\' frontage</text>';
    svg += '<text x="' + (ox + lw + 16) + '" y="' + (oy + ld / 2) + '" text-anchor="middle" font-size="9" fill="#666" transform="rotate(90,' + (ox + lw + 16) + ',' + (oy + ld / 2) + ')">' + Math.round(lotD) + '\' depth</text>';

    // Building dimensions
    var realBW = Math.round(lotW - 2 * params.setS);
    var realBD = Math.round((lotD - params.setF - params.setS) * 0.65);
    svg += '<line x1="' + bx + '" y1="' + (by - 4) + '" x2="' + (bx + bw) + '" y2="' + (by - 4) + '" stroke="#2b6cb0" stroke-width="0.5"/>';
    svg += '<text x="' + (bx + bw / 2) + '" y="' + (by - 7) + '" text-anchor="middle" font-size="7" fill="#2b6cb0">' + realBW + '\'</text>';

    // Street
    svg += '<rect x="' + (ox - 15) + '" y="' + (oy + ld + 10) + '" width="' + (lw + 30) + '" height="24" fill="#e2e8f0" rx="3"/>';
    svg += '<text x="' + (ox + lw / 2) + '" y="' + (oy + ld + 26) + '" text-anchor="middle" font-size="9" fill="#718096" font-weight="600">STREET</text>';

    // North arrow
    svg += '<text x="' + (w - 24) + '" y="' + (oy + 14) + '" text-anchor="middle" font-size="14" fill="#999">&#8593;</text>';
    svg += '<text x="' + (w - 24) + '" y="' + (oy + 26) + '" text-anchor="middle" font-size="8" fill="#999" font-weight="600">N</text>';

    // Coverage stats
    var coverage = (budget.buildingFootprint / inp.parcelSize * 100).toFixed(0);
    var statsY = oy + ld + 48;
    svg += '<text x="' + (w / 2) + '" y="' + statsY + '" text-anchor="middle" font-size="8" fill="#718096">Coverage: ' + coverage + '% | FAR: ' + budget.far.toFixed(2) + ' | GSF: ' + budget.gsf.toLocaleString() + '</text>';

    svg += '<text x="' + (w / 2) + '" y="' + (h - 4) + '" text-anchor="middle" font-size="10" fill="#999" font-weight="600">ENHANCED SITE PLAN</text>';
    svg += '</svg>';
    return svg;
}

function generateIsometricSVG(useId, inp, budget) {
    var w = 440, h = 340;
    var color = USE_COLORS[useId] || '#3182ce';
    var stories = budget.stories || 1;
    var svg = '<svg viewBox="0 0 ' + w + ' ' + h + '" xmlns="http://www.w3.org/2000/svg" style="background:#fafbfc;">';

    // Isometric transform constants
    var cx = w / 2, baseY = h - 60;
    var bldgW = 140, bldgD = 90;
    var floorH = Math.min(14, 160 / stories);
    var totalH = stories * floorH;

    // Ground plane
    svg += '<polygon points="' + (cx - bldgW) + ',' + baseY + ' ' + cx + ',' + (baseY + bldgD / 2) + ' ' + (cx + bldgW) + ',' + baseY + ' ' + cx + ',' + (baseY - bldgD / 2) + '" fill="#c6f6d5" stroke="#48bb78" stroke-width="1" opacity="0.5"/>';

    // Building mass - front face
    svg += '<polygon points="' + (cx - bldgW * 0.7) + ',' + (baseY - 10) + ' ' + (cx - bldgW * 0.7) + ',' + (baseY - 10 - totalH) + ' ' + (cx + bldgW * 0.3) + ',' + (baseY - bldgD * 0.4 - totalH) + ' ' + (cx + bldgW * 0.3) + ',' + (baseY - bldgD * 0.4) + '" fill="' + color + '" opacity="0.7" stroke="' + color + '" stroke-width="1.5"/>';

    // Building mass - side face
    svg += '<polygon points="' + (cx + bldgW * 0.3) + ',' + (baseY - bldgD * 0.4) + ' ' + (cx + bldgW * 0.3) + ',' + (baseY - bldgD * 0.4 - totalH) + ' ' + (cx + bldgW * 0.7) + ',' + (baseY - bldgD * 0.15 - totalH) + ' ' + (cx + bldgW * 0.7) + ',' + (baseY - bldgD * 0.15) + '" fill="' + color + '" opacity="0.5" stroke="' + color + '" stroke-width="1"/>';

    // Building mass - top face
    svg += '<polygon points="' + (cx - bldgW * 0.7) + ',' + (baseY - 10 - totalH) + ' ' + (cx + bldgW * 0.3) + ',' + (baseY - bldgD * 0.4 - totalH) + ' ' + (cx + bldgW * 0.7) + ',' + (baseY - bldgD * 0.15 - totalH) + ' ' + (cx - bldgW * 0.3) + ',' + (baseY + bldgD * 0.15 - totalH) + '" fill="' + color + '" opacity="0.35" stroke="' + color + '" stroke-width="1"/>';

    // Floor plate lines on front face
    for (var f = 1; f < stories; f++) {
        var fy = baseY - 10 - f * floorH;
        var fy2 = baseY - bldgD * 0.4 - f * floorH;
        svg += '<line x1="' + (cx - bldgW * 0.7) + '" y1="' + fy + '" x2="' + (cx + bldgW * 0.3) + '" y2="' + fy2 + '" stroke="rgba(255,255,255,0.3)" stroke-width="0.5"/>';
    }

    // Floor plate lines on side face
    for (var f2 = 1; f2 < stories; f2++) {
        var sfy = baseY - bldgD * 0.4 - f2 * floorH;
        var sfy2 = baseY - bldgD * 0.15 - f2 * floorH;
        svg += '<line x1="' + (cx + bldgW * 0.3) + '" y1="' + sfy + '" x2="' + (cx + bldgW * 0.7) + '" y2="' + sfy2 + '" stroke="rgba(255,255,255,0.2)" stroke-width="0.5"/>';
    }

    // Windows on front face (simplified)
    var winRows = Math.min(stories, 8);
    for (var wr = 0; wr < winRows; wr++) {
        var wy = baseY - 10 - wr * floorH - floorH * 0.65;
        var wy2 = baseY - bldgD * 0.4 - wr * floorH - floorH * 0.65;
        for (var wc = 0; wc < 5; wc++) {
            var t = (wc + 0.5) / 5;
            var wx = (cx - bldgW * 0.7) * (1 - t) + (cx + bldgW * 0.3) * t;
            var wwy = wy * (1 - t) + wy2 * t;
            svg += '<rect x="' + (wx - 3) + '" y="' + wwy + '" width="6" height="' + (floorH * 0.4) + '" fill="rgba(255,255,255,0.25)" rx="0.5"/>';
        }
    }

    // Height label
    svg += '<line x1="' + (cx - bldgW * 0.7 - 8) + '" y1="' + (baseY - 10) + '" x2="' + (cx - bldgW * 0.7 - 8) + '" y2="' + (baseY - 10 - totalH) + '" stroke="#666" stroke-width="0.5"/>';
    svg += '<text x="' + (cx - bldgW * 0.7 - 12) + '" y="' + (baseY - 10 - totalH / 2) + '" text-anchor="end" font-size="8" fill="#666" transform="rotate(-90,' + (cx - bldgW * 0.7 - 12) + ',' + (baseY - 10 - totalH / 2) + ')">' + budget.buildingHeight + ' ft (' + stories + ' floors)</text>';

    // Title
    svg += '<text x="' + (w / 2) + '" y="16" text-anchor="middle" font-size="11" fill="#1a365d" font-weight="700">ISOMETRIC MASSING VIEW</text>';
    svg += '<text x="' + (w / 2) + '" y="' + (h - 6) + '" text-anchor="middle" font-size="8" fill="#999">' + budget.gsf.toLocaleString() + ' GSF | ' + (budget.units ? budget.units + ' units' : budget.nsf.toLocaleString() + ' NSF') + '</text>';

    svg += '</svg>';
    return svg;
}

function generateFloorPlateSVG(useId, inp, budget) {
    var w = 440, h = 320;
    var color = USE_COLORS[useId] || '#3182ce';
    var svg = '<svg viewBox="0 0 ' + w + ' ' + h + '" xmlns="http://www.w3.org/2000/svg" style="background:#fafbfc;">';

    var fpW = 360, fpH = 240;
    var ox = (w - fpW) / 2, oy = 35;

    // Floor plate outline
    svg += '<rect x="' + ox + '" y="' + oy + '" width="' + fpW + '" height="' + fpH + '" fill="#f0f4f8" stroke="' + color + '" stroke-width="2" rx="3"/>';

    // Core (elevator + stairs)
    var coreW = fpW * 0.12, coreH = fpH * 0.35;
    var coreX = ox + fpW / 2 - coreW / 2, coreY = oy + fpH / 2 - coreH / 2;
    svg += '<rect x="' + coreX + '" y="' + coreY + '" width="' + coreW + '" height="' + coreH + '" fill="#4a5568" opacity="0.6" stroke="#2d3748" stroke-width="1.5" rx="2"/>';
    svg += '<text x="' + (coreX + coreW / 2) + '" y="' + (coreY + coreH / 2 - 4) + '" text-anchor="middle" font-size="7" fill="white" font-weight="600">ELEV</text>';
    svg += '<text x="' + (coreX + coreW / 2) + '" y="' + (coreY + coreH / 2 + 6) + '" text-anchor="middle" font-size="6" fill="white">STAIR</text>';

    // Corridor
    var corrH = 8;
    svg += '<rect x="' + (ox + 8) + '" y="' + (oy + fpH / 2 - corrH / 2) + '" width="' + (fpW - 16) + '" height="' + corrH + '" fill="#e2e8f0" stroke="#a0aec0" stroke-width="0.5"/>';
    svg += '<text x="' + (ox + fpW / 2) + '" y="' + (oy + fpH / 2 + 2.5) + '" text-anchor="middle" font-size="5" fill="#718096" font-weight="600">CORRIDOR</text>';

    // Units (top row and bottom row)
    var units = budget.units || 8;
    var unitsPerSide = Math.min(Math.ceil(units / 2), 8);
    var unitW = (fpW - 20) / unitsPerSide;
    var unitH = (fpH / 2 - corrH / 2 - 12);

    // Top row
    for (var i = 0; i < unitsPerSide; i++) {
        var ux = ox + 10 + i * unitW;
        svg += '<rect x="' + ux + '" y="' + (oy + 6) + '" width="' + (unitW - 3) + '" height="' + unitH + '" fill="' + color + '" opacity="0.15" stroke="' + color + '" stroke-width="0.8" rx="2"/>';
        var unitLabel = (i < unitsPerSide - 1) ? 'Unit' : (useId === 'senior' ? 'Suite' : 'Unit');
        svg += '<text x="' + (ux + (unitW - 3) / 2) + '" y="' + (oy + 6 + unitH / 2 + 3) + '" text-anchor="middle" font-size="7" fill="' + color + '" font-weight="500">' + unitLabel + '</text>';
    }

    // Bottom row
    var bottomUnits = Math.min(units - unitsPerSide, unitsPerSide);
    for (var j = 0; j < bottomUnits; j++) {
        var bx = ox + 10 + j * unitW;
        var bUnitY = oy + fpH / 2 + corrH / 2 + 4;
        svg += '<rect x="' + bx + '" y="' + bUnitY + '" width="' + (unitW - 3) + '" height="' + unitH + '" fill="' + color + '" opacity="0.15" stroke="' + color + '" stroke-width="0.8" rx="2"/>';
        svg += '<text x="' + (bx + (unitW - 3) / 2) + '" y="' + (bUnitY + unitH / 2 + 3) + '" text-anchor="middle" font-size="7" fill="' + color + '" font-weight="500">Unit</text>';
    }

    // Title
    svg += '<text x="' + (w / 2) + '" y="18" text-anchor="middle" font-size="11" fill="#1a365d" font-weight="700">TYPICAL FLOOR PLATE</text>';
    svg += '<text x="' + (w / 2) + '" y="' + (h - 6) + '" text-anchor="middle" font-size="8" fill="#999">' + units + ' units/floor | ' + (budget.params.unitSF || 850) + ' SF avg unit</text>';

    svg += '</svg>';
    return svg;
}

function generateEnhancedElevationSVG(useId, inp, budget) {
    var w = 440, h = 300;
    var color = USE_COLORS[useId] || '#3182ce';
    var stories = budget.stories || 1;
    var svg = '<svg viewBox="0 0 ' + w + ' ' + h + '" xmlns="http://www.w3.org/2000/svg" style="background:#fafbfc;">';

    var bldgW = 260, groundY = h - 50;
    var floorH = Math.min(22, (groundY - 40) / stories);
    var totalH = stories * floorH;
    var bx = (w - bldgW) / 2;
    var topY = groundY - totalH;

    // Ground line
    svg += '<line x1="20" y1="' + groundY + '" x2="' + (w - 20) + '" y2="' + groundY + '" stroke="#8B6914" stroke-width="2"/>';

    // Building elevation
    svg += '<rect x="' + bx + '" y="' + topY + '" width="' + bldgW + '" height="' + totalH + '" fill="' + color + '" opacity="0.65" stroke="' + color + '" stroke-width="2" rx="2"/>';

    // Floor lines and windows
    for (var f = 0; f < stories; f++) {
        var fy = groundY - (f + 1) * floorH;
        if (f > 0) {
            svg += '<line x1="' + bx + '" y1="' + (fy + floorH) + '" x2="' + (bx + bldgW) + '" y2="' + (fy + floorH) + '" stroke="rgba(255,255,255,0.3)" stroke-width="0.5"/>';
        }
        // Windows
        if (floorH > 8) {
            var winCount = Math.min(10, Math.floor(bldgW / 28));
            for (var ww = 0; ww < winCount; ww++) {
                var wx = bx + 12 + ww * ((bldgW - 24) / winCount);
                svg += '<rect x="' + wx + '" y="' + (fy + floorH * 0.2) + '" width="' + (bldgW / winCount * 0.6) + '" height="' + (floorH * 0.55) + '" fill="rgba(255,255,255,0.2)" rx="1"/>';
            }
        }
        // Floor number
        if (f === 0 || f === stories - 1 || f === Math.floor(stories / 2)) {
            svg += '<text x="' + (bx - 6) + '" y="' + (fy + floorH * 0.6) + '" text-anchor="end" font-size="7" fill="#666">L' + (f + 1) + '</text>';
        }
    }

    // Ground floor differentiation
    svg += '<rect x="' + bx + '" y="' + (groundY - floorH) + '" width="' + bldgW + '" height="' + floorH + '" fill="rgba(255,255,255,0.15)" stroke="rgba(255,255,255,0.3)" stroke-width="0.5"/>';

    // Entrance
    svg += '<rect x="' + (bx + bldgW / 2 - 12) + '" y="' + (groundY - floorH * 0.8) + '" width="24" height="' + (floorH * 0.8) + '" fill="rgba(255,255,255,0.3)" rx="2"/>';

    // Height dimension
    svg += '<line x1="' + (bx + bldgW + 12) + '" y1="' + groundY + '" x2="' + (bx + bldgW + 12) + '" y2="' + topY + '" stroke="#666" stroke-width="0.5"/>';
    svg += '<text x="' + (bx + bldgW + 16) + '" y="' + ((groundY + topY) / 2 + 3) + '" font-size="8" fill="#666">' + budget.buildingHeight + ' ft</text>';

    // Street
    svg += '<rect x="20" y="' + groundY + '" width="' + (w - 40) + '" height="18" fill="#e2e8f0" rx="2"/>';
    svg += '<text x="' + (w / 2) + '" y="' + (groundY + 13) + '" text-anchor="middle" font-size="8" fill="#718096" font-weight="600">GRADE</text>';

    svg += '<text x="' + (w / 2) + '" y="16" text-anchor="middle" font-size="11" fill="#1a365d" font-weight="700">FRONT ELEVATION</text>';
    svg += '<text x="' + (w / 2) + '" y="' + (h - 4) + '" text-anchor="middle" font-size="8" fill="#999">' + stories + ' stories | ' + budget.buildingHeight + ' ft | ' + budget.gsf.toLocaleString() + ' GSF</text>';

    svg += '</svg>';
    return svg;
}

// --- Design Configurator helper functions ---

var dcDebounceTimer = null;

function buildDcSlider(id, label, val, min, max, step, suffix) {
    suffix = suffix || '';
    var dec = step < 1 ? (step < 0.1 ? 2 : 1) : 0;
    var isCurrency = suffix === '$';
    var dispVal = isCurrency ? '$' + Number(val).toLocaleString() : Number(val).toFixed(dec) + suffix;
    var h = '<div class="dt-slider-group">';
    h += '<div class="dt-slider-label"><span>' + label + '</span><span class="dt-val" id="dc-' + id + '-val">' + dispVal + '</span></div>';
    h += '<div class="dt-slider-row">';
    h += '<input type="range" id="dc-' + id + '-slider" min="' + min + '" max="' + max + '" step="' + step + '" value="' + val + '" oninput="syncDcSlider(\'' + id + '\',\'' + suffix + '\')">';
    h += '<input type="number" id="dc-' + id + '" min="' + min + '" max="' + max + '" step="' + step + '" value="' + val + '" oninput="syncDcSliderFromNum(\'' + id + '\',\'' + suffix + '\')">';
    h += '</div></div>';
    return h;
}

function syncDcSlider(id, suffix) {
    var slider = document.getElementById('dc-' + id + '-slider');
    var num = document.getElementById('dc-' + id);
    var valEl = document.getElementById('dc-' + id + '-val');
    if (slider && num) num.value = slider.value;
    if (valEl) {
        var v = parseFloat(slider.value);
        var dec = parseFloat(slider.step) < 1 ? (parseFloat(slider.step) < 0.1 ? 2 : 1) : 0;
        valEl.textContent = suffix === '$' ? '$' + v.toLocaleString() : v.toFixed(dec) + suffix;
    }
    recalcDesignConfigurator();
}

function syncDcSliderFromNum(id, suffix) {
    var slider = document.getElementById('dc-' + id + '-slider');
    var num = document.getElementById('dc-' + id);
    var valEl = document.getElementById('dc-' + id + '-val');
    if (slider && num) slider.value = num.value;
    if (valEl) {
        var v = parseFloat(num.value);
        var dec = parseFloat(num.step) < 1 ? (parseFloat(num.step) < 0.1 ? 2 : 1) : 0;
        valEl.textContent = suffix === '$' ? '$' + v.toLocaleString() : v.toFixed(dec) + suffix;
    }
    recalcDesignConfigurator();
}

function recalcDesignConfigurator() {
    var st = deepAnalysisState;
    if (!st || !st.bestUse || !st.inp) return;

    // Read dc- inputs into assumptions
    var a = st.assumptions;
    var el;
    el = document.getElementById('dc-far'); if (el) a.far = parseFloat(el.value) || a.far;
    el = document.getElementById('dc-coveragePct'); if (el) a.coveragePct = parseFloat(el.value) || 70;
    el = document.getElementById('dc-efficiencyPct'); if (el) a.efficiencyPct = parseFloat(el.value) || 80;
    el = document.getElementById('dc-setbackFront'); if (el) a.setbackFront = parseFloat(el.value) || 0;
    el = document.getElementById('dc-setbackSide'); if (el) a.setbackSide = parseFloat(el.value) || 0;
    el = document.getElementById('dc-setbackRear'); if (el) a.setbackRear = parseFloat(el.value) || 0;
    el = document.getElementById('dc-amenityPct'); if (el) a.amenityPct = parseFloat(el.value) || 0;
    el = document.getElementById('dc-parkingSpaces'); if (el) a.parkingSpaces = parseInt(el.value) || 0;

    // Parking type
    el = document.getElementById('dc-parkingType');
    if (el) {
        a.parkingType = el.value;
        var ptCost = { surface: 8000, podium: 40000, subterranean: 65000, mechanical: 35000 };
        a.parkingCostPerSpace = ptCost[el.value] || 8000;
    }

    // Unit mix (residential only)
    var studioEl = document.getElementById('dc-unitMixStudio');
    var br1El = document.getElementById('dc-unitMixBr1');
    var br2El = document.getElementById('dc-unitMixBr2');
    if (studioEl && br1El && br2El) {
        var sPct = parseFloat(studioEl.value) || 0;
        var b1Pct = parseFloat(br1El.value) || 0;
        var b2Pct = parseFloat(br2El.value) || 0;
        // Cap total at 100
        if (sPct + b1Pct + b2Pct > 100) {
            b2Pct = Math.max(0, 100 - sPct - b1Pct);
            br2El.value = b2Pct;
            var br2Slider = document.getElementById('dc-unitMixBr2-slider');
            if (br2Slider) br2Slider.value = b2Pct;
        }
        var b3Pct = Math.max(0, 100 - sPct - b1Pct - b2Pct);
        var b3Display = document.getElementById('dc-unitMixBr3-display');
        if (b3Display) b3Display.textContent = b3Pct + '%';
        a.unitMixStudio = sPct;
        a.unitMixBr1 = b1Pct;
        a.unitMixBr2 = b2Pct;
        // Store custom unit mix on st for Tab 12 sync
        st.customUnitMix = { studio: sPct / 100, br1: b1Pct / 100, br2: b2Pct / 100, br3: b3Pct / 100 };
    }

    // Recompute immediately for SVGs & KPIs
    st.computed = computeFromAssumptions(st.bestUse, st.inp, a, st.effects);
    updateConfiguratorVisuals(st);

    // Debounce full financial re-render
    clearTimeout(dcDebounceTimer);
    dcDebounceTimer = setTimeout(function() {
        renderDeepTabPanels(true);
        // Re-activate tab 11 (Site Plan & 3D) after re-render
        var btns = document.querySelectorAll('#deepTabs .deep-tab-btn');
        for (var i = 0; i < btns.length; i++) {
            if (btns[i].classList.contains('active')) {
                switchDeepTab(i);
                break;
            }
        }
    }, 300);
}

function updateConfiguratorVisuals(st) {
    var useId = st.bestUse;
    var inp = st.inp;
    var computed = st.computed;

    // Update SVGs
    var svgContainer = document.getElementById('dc-svg-container');
    if (svgContainer) {
        var svgHtml = '<div>' + generateEnhancedSitePlanSVG(useId, inp, computed) + '</div>';
        svgHtml += '<div>' + generateEnhancedElevationSVG(useId, inp, computed) + '</div>';
        svgHtml += '<div>' + generateIsometricSVG(useId, inp, computed) + '</div>';
        svgHtml += '<div>' + generateFloorPlateSVG(useId, inp, computed) + '</div>';
        svgContainer.innerHTML = svgHtml;
    }

    // Update KPIs
    updateConfiguratorKPIs(computed);

    // Update coverage stats
    var statsEl = document.getElementById('dc-coverage-stats');
    if (statsEl) {
        var buildingCoverage = (computed.buildingFootprint / inp.parcelSize * 100).toFixed(1);
        var parkingSF = (computed.parkingSpaces || 0) * 350;
        var parkingPctVal = (computed.stories <= 4 ? Math.min(parkingSF / inp.parcelSize * 100, 30) : 0).toFixed(1);
        var imperviousPctVal = (parseFloat(buildingCoverage) + parseFloat(parkingPctVal) + 5).toFixed(1);
        var perviousPctVal = Math.max(0, 100 - parseFloat(imperviousPctVal)).toFixed(1);
        var openSpacePctVal = Math.max(0, 100 - parseFloat(buildingCoverage) - parseFloat(parkingPctVal) - 5).toFixed(1);
        var stats = [
            { label: 'Building Coverage', value: buildingCoverage + '%', color: '#2b6cb0' },
            { label: 'Parking Area', value: parkingPctVal + '%', color: '#718096' },
            { label: 'Impervious Total', value: imperviousPctVal + '%', color: '#dd6b20' },
            { label: 'Pervious / Open', value: perviousPctVal + '%', color: '#48bb78' },
            { label: 'Open Space', value: openSpacePctVal + '%', color: '#38a169' },
        ];
        var sh = '';
        for (var i = 0; i < stats.length; i++) {
            var s = stats[i];
            sh += '<div style="text-align:center;background:#f8fafc;border-radius:8px;padding:0.75rem;border:1px solid var(--border);">';
            sh += '<div style="font-size:1.4rem;font-weight:700;color:' + s.color + ';">' + s.value + '</div>';
            sh += '<div style="font-size:0.72rem;color:var(--text-light);">' + s.label + '</div></div>';
        }
        statsEl.innerHTML = sh;
    }
}

function updateConfiguratorKPIs(computed) {
    var kpis = [
        { id: 'dc-kpi-gsf', value: computed.gsf.toLocaleString(), label: 'Gross SF' },
        { id: 'dc-kpi-stories', value: computed.stories + ' / ' + computed.buildingHeight + ' ft', label: 'Stories / Height' },
        { id: 'dc-kpi-units', value: computed.units ? computed.units.toLocaleString() : computed.nsf.toLocaleString(), label: computed.units ? 'Units' : 'Net SF' },
        { id: 'dc-kpi-margin', value: (computed.devMargin * 100).toFixed(1) + '%', label: 'Dev Margin' },
    ];
    for (var i = 0; i < kpis.length; i++) {
        var el = document.getElementById(kpis[i].id);
        if (el) {
            el.querySelector('.cfg-kpi-value').textContent = kpis[i].value;
            if (kpis[i].id === 'dc-kpi-margin') {
                el.querySelector('.cfg-kpi-value').style.color = computed.devMargin >= 0.15 ? '#276749' : computed.devMargin >= 0.05 ? '#b7791f' : '#c53030';
            }
        }
    }
}

function resetDesignConfigurator() {
    var st = deepAnalysisState;
    if (!st || !st.bestUse || !st.inp) return;
    var defaults = getDefaultAssumptions(st.bestUse, st.inp, st.effects);
    // Merge design configurator defaults back
    st.assumptions.coveragePct = defaults.coveragePct;
    st.assumptions.efficiencyPct = defaults.efficiencyPct;
    st.assumptions.setbackFront = defaults.setbackFront;
    st.assumptions.setbackSide = defaults.setbackSide;
    st.assumptions.setbackRear = defaults.setbackRear;
    st.assumptions.amenityPct = defaults.amenityPct;
    st.assumptions.parkingType = defaults.parkingType;
    st.assumptions.parkingCostPerSpace = defaults.parkingCostPerSpace;
    st.assumptions.far = defaults.far;
    st.assumptions.parkingSpaces = defaults.parkingSpaces;
    st.assumptions.unitMixStudio = defaults.unitMixStudio;
    st.assumptions.unitMixBr1 = defaults.unitMixBr1;
    st.assumptions.unitMixBr2 = defaults.unitMixBr2;
    delete st.customUnitMix;

    st.computed = computeFromAssumptions(st.bestUse, st.inp, st.assumptions, st.effects);
    renderDeepTabPanels(true);
    // Re-activate Site Plan tab
    var btns = document.querySelectorAll('#deepTabs .deep-tab-btn');
    for (var i = 0; i < btns.length; i++) {
        if (btns[i].classList.contains('active')) {
            switchDeepTab(i);
            break;
        }
    }
}

function renderEnhancedSitePlanTab(st) {
    var useId = st.bestUse;
    var inp = st.inp;
    var computed = st.computed;
    var a = st.assumptions;
    var params = BUILDING_PARAMS[useId];
    var isResidential = ['sfr','duplex','multifamily_low','multifamily_mid','multifamily_high','mixeduse','senior','adu'].includes(useId);
    var hasUnits = !!params.unitSF;

    var html = '<div class="deep-tab-panel">';
    html += '<div class="analysis-section"><h3>Interactive Design Configurator <button class="dt-reset-btn" onclick="resetDesignConfigurator()">Reset Defaults</button></h3>';

    // KPI strip
    html += '<div class="cfg-kpi-strip">';
    html += '<div class="cfg-kpi" id="dc-kpi-gsf"><div class="cfg-kpi-value">' + computed.gsf.toLocaleString() + '</div><div class="cfg-kpi-label">Gross SF</div></div>';
    html += '<div class="cfg-kpi" id="dc-kpi-stories"><div class="cfg-kpi-value">' + computed.stories + ' / ' + computed.buildingHeight + ' ft</div><div class="cfg-kpi-label">Stories / Height</div></div>';
    html += '<div class="cfg-kpi" id="dc-kpi-units"><div class="cfg-kpi-value">' + (computed.units ? computed.units.toLocaleString() : computed.nsf.toLocaleString()) + '</div><div class="cfg-kpi-label">' + (computed.units ? 'Units' : 'Net SF') + '</div></div>';
    var marginColor = computed.devMargin >= 0.15 ? '#276749' : computed.devMargin >= 0.05 ? '#b7791f' : '#c53030';
    html += '<div class="cfg-kpi" id="dc-kpi-margin"><div class="cfg-kpi-value" style="color:' + marginColor + ';">' + (computed.devMargin * 100).toFixed(1) + '%</div><div class="cfg-kpi-label">Dev Margin</div></div>';
    html += '</div>';

    // Split layout: sliders left, SVGs right
    html += '<div class="configurator-layout">';

    // --- Left panel: Configurator sliders ---
    html += '<div class="configurator-panel">';

    // Building Massing
    html += '<div class="cfg-section-title">Building Massing</div>';
    html += buildDcSlider('far', 'FAR', a.far, 0.1, 15, 0.1, 'x');
    html += buildDcSlider('coveragePct', 'Coverage %', a.coveragePct || 70, 20, 95, 1, '%');
    html += buildDcSlider('efficiencyPct', 'Efficiency %', a.efficiencyPct || Math.round(params.eff * 100), 50, 98, 1, '%');

    // Setbacks
    html += '<div class="cfg-section-title">Setbacks</div>';
    html += buildDcSlider('setbackFront', 'Front', a.setbackFront != null ? a.setbackFront : params.setF, 0, 50, 1, ' ft');
    html += buildDcSlider('setbackSide', 'Side', a.setbackSide != null ? a.setbackSide : params.setS, 0, 30, 1, ' ft');
    html += buildDcSlider('setbackRear', 'Rear', a.setbackRear != null ? a.setbackRear : params.setS, 0, 50, 1, ' ft');

    // Amenity
    html += '<div class="cfg-section-title">Amenity</div>';
    html += buildDcSlider('amenityPct', '% of GSF', a.amenityPct || 0, 0, 20, 1, '%');

    // Parking
    html += '<div class="cfg-section-title">Parking</div>';
    html += '<div class="dt-slider-group"><div class="dt-slider-label"><span>Parking Type</span></div>';
    html += '<select id="dc-parkingType" style="width:100%;padding:4px 6px;border:1px solid #cbd5e0;border-radius:4px;font-size:0.73rem;margin-bottom:4px;" onchange="recalcDesignConfigurator()">';
    var ptypes = [
        { val: 'surface', label: 'Surface ($8K/space)' },
        { val: 'podium', label: 'Podium ($40K/space)' },
        { val: 'subterranean', label: 'Subterranean ($65K/space)' },
        { val: 'mechanical', label: 'Mechanical ($35K/space)' },
    ];
    for (var pt = 0; pt < ptypes.length; pt++) {
        html += '<option value="' + ptypes[pt].val + '"' + ((a.parkingType || 'surface') === ptypes[pt].val ? ' selected' : '') + '>' + ptypes[pt].label + '</option>';
    }
    html += '</select></div>';
    html += buildDcSlider('parkingSpaces', 'Spaces', a.parkingSpaces, 0, Math.max(500, a.parkingSpaces * 2), 1, '');

    // Unit Mix (residential only)
    if (isResidential && hasUnits) {
        html += '<div class="cfg-section-title">Unit Mix</div>';
        html += buildDcSlider('unitMixStudio', 'Studio %', a.unitMixStudio || 0, 0, 60, 1, '%');
        html += buildDcSlider('unitMixBr1', '1-BR %', a.unitMixBr1 || 0, 0, 70, 1, '%');
        html += buildDcSlider('unitMixBr2', '2-BR %', a.unitMixBr2 || 0, 0, 70, 1, '%');
        var br3Pct = Math.max(0, 100 - (a.unitMixStudio || 0) - (a.unitMixBr1 || 0) - (a.unitMixBr2 || 0));
        html += '<div class="cfg-auto-display"><span>3-BR %</span><span class="cfg-auto-val" id="dc-unitMixBr3-display">' + br3Pct + '%</span></div>';
    }

    html += '</div>'; // end configurator-panel

    // --- Right panel: SVGs + coverage stats ---
    html += '<div>';
    html += '<div class="rendering-container" id="dc-svg-container">';
    html += '<div>' + generateEnhancedSitePlanSVG(useId, inp, computed) + '</div>';
    html += '<div>' + generateEnhancedElevationSVG(useId, inp, computed) + '</div>';
    html += '<div>' + generateIsometricSVG(useId, inp, computed) + '</div>';
    html += '<div>' + generateFloorPlateSVG(useId, inp, computed) + '</div>';
    html += '</div>';

    // Site coverage stats
    html += '<h4 style="color:var(--primary);margin:1.5rem 0 0.75rem;">Site Coverage Statistics</h4>';
    var buildingCoverage = (computed.buildingFootprint / inp.parcelSize * 100).toFixed(1);
    var parkingSF = (computed.parkingSpaces || 0) * 350;
    var parkingPct = (computed.stories <= 4 ? Math.min(parkingSF / inp.parcelSize * 100, 30) : 0).toFixed(1);
    var imperviousPct = (parseFloat(buildingCoverage) + parseFloat(parkingPct) + 5).toFixed(1);
    var perviousPct = Math.max(0, 100 - parseFloat(imperviousPct)).toFixed(1);
    var openSpacePct = Math.max(0, 100 - parseFloat(buildingCoverage) - parseFloat(parkingPct) - 5).toFixed(1);

    html += '<div id="dc-coverage-stats" style="display:grid;grid-template-columns:repeat(5,1fr);gap:0.75rem;">';
    var stats = [
        { label: 'Building Coverage', value: buildingCoverage + '%', color: '#2b6cb0' },
        { label: 'Parking Area', value: parkingPct + '%', color: '#718096' },
        { label: 'Impervious Total', value: imperviousPct + '%', color: '#dd6b20' },
        { label: 'Pervious / Open', value: perviousPct + '%', color: '#48bb78' },
        { label: 'Open Space', value: openSpacePct + '%', color: '#38a169' },
    ];
    for (var i = 0; i < stats.length; i++) {
        var s = stats[i];
        html += '<div style="text-align:center;background:#f8fafc;border-radius:8px;padding:0.75rem;border:1px solid var(--border);">';
        html += '<div style="font-size:1.4rem;font-weight:700;color:' + s.color + ';">' + s.value + '</div>';
        html += '<div style="font-size:0.72rem;color:var(--text-light);">' + s.label + '</div></div>';
    }
    html += '</div>';

    html += '</div>'; // end right panel
    html += '</div>'; // end configurator-layout

    html += '</div></div>';
    return html;
}


// ============================================================
//  SKILL 32: Multi-Property Comparison Dashboard
// ============================================================

function renderComparisonDashboard(saved) {
    if (!saved || saved.length < 2) return '';

    // Analyze each property
    var analyses = [];
    for (var i = 0; i < saved.length; i++) {
        var prop = saved[i];
        var propInp = buildInpFromSaved(prop);
        var propBestUse = determineBestUse(propInp);
        var propLeg = getApplicableLegislation(propBestUse, propInp);
        var propEffects = stackLegislationEffects(propLeg);
        var propAssumptions = getDefaultAssumptions(propBestUse, propInp, propEffects);
        var propComputed = computeFromAssumptions(propBestUse, propInp, propAssumptions, propEffects);
        var tl = TIMELINE_MONTHS[propBestUse] || { entitlement: 6, design: 4, permits: 3, construction: 18, leaseup: 6 };
        var totalMo = tl.entitlement + tl.design + tl.permits + tl.construction + tl.leaseup;
        var irr = approxIRR(propComputed.devMargin, totalMo);
        var legalScore = scoreLegal(propBestUse, propInp, propEffects);
        var physScore = scorePhysical(propBestUse, propInp);
        var finScore = scoreFinancial(propBestUse, propInp, propEffects);
        var prodScore = scoreProductive(propBestUse, propInp, propEffects);
        var ease = computeEaseOfExecution(propBestUse, propInp, propEffects, legalScore * 100);
        var risk = computeRiskLevel(propBestUse, propInp, legalScore, physScore);
        var useName = (LAND_USES.find(function(u) { return u.id === propBestUse; }) || {}).name || propBestUse;

        // Market score (heuristic based on neighborhood rent multiplier and transit)
        var marketScore = (NEIGHBORHOOD_RENT_MULT[propInp.neighborhood] || 1.0) * 0.7;
        if (propInp.transit === 'adjacent') marketScore += 0.3;
        else if (propInp.transit === 'near') marketScore += 0.2;
        marketScore = Math.min(1, marketScore);

        // Entitlement score
        var entitleScore = (100 - totalMo) / 100;
        entitleScore = Math.max(0, Math.min(1, entitleScore + 0.3));

        analyses.push({
            prop: prop,
            inp: propInp,
            bestUse: propBestUse,
            useName: useName,
            computed: propComputed,
            totalMo: totalMo,
            irr: irr,
            scores: {
                legal: legalScore,
                physical: physScore,
                financial: finScore,
                risk: 1 - (risk.level === 'High' ? 0.8 : risk.level === 'Medium-High' ? 0.6 : risk.level === 'Medium' ? 0.4 : 0.2),
                market: marketScore,
                entitlement: entitleScore,
            },
            ease: ease,
            risk: risk,
        });
    }

    // Rank by composite score
    analyses.sort(function(a, b) {
        var scoreA = a.computed.devMargin * 0.4 + a.irr * 0.3 + a.scores.legal * 0.15 + a.scores.physical * 0.15;
        var scoreB = b.computed.devMargin * 0.4 + b.irr * 0.3 + b.scores.legal * 0.15 + b.scores.physical * 0.15;
        return scoreB - scoreA;
    });

    // Store analyses on deepAnalysisState for selectDeepProperty
    if (deepAnalysisState) {
        deepAnalysisState.analyses = analyses;
    }

    var selectedIdx = deepAnalysisState && deepAnalysisState.selectedPropertyIndex != null ? deepAnalysisState.selectedPropertyIndex : 0;

    var html = '<div class="deep-tab-panel active">';
    html += '<div class="analysis-section"><h3>Multi-Property Comparison Dashboard (' + analyses.length + ' Properties)</h3>';

    // Summary cards side by side
    html += '<div style="display:grid;grid-template-columns:repeat(' + Math.min(analyses.length, 4) + ',1fr);gap:1rem;margin-bottom:1.5rem;">';
    for (var j = 0; j < analyses.length; j++) {
        var a = analyses[j];
        var rankColors = ['#b8860b', '#6a6a6a', '#8b4513', '#4a5568'];
        var rc = rankColors[Math.min(j, 3)];
        var isSelected = (j === selectedIdx);
        var selStyle = isSelected ? 'border:2px solid var(--primary);background:rgba(49,130,206,0.06);box-shadow:0 0 0 3px rgba(49,130,206,0.15);' : 'cursor:pointer;';
        html += '<div class="exec-summary-card deep-prop-card" data-propidx="' + j + '" onclick="selectDeepProperty(' + j + ')" style="border-top:4px solid ' + rc + ';' + selStyle + '">';
        html += '<div style="font-size:0.72rem;font-weight:700;color:' + rc + ';margin-bottom:0.3rem;">#' + (j + 1) + ' RANKED' + (isSelected ? ' &bull; SELECTED' : '') + '</div>';
        html += '<div style="font-size:0.88rem;font-weight:700;color:var(--primary);margin-bottom:0.25rem;">' + (a.prop.address || a.prop.apn || 'Property ' + (j + 1)) + '</div>';
        html += '<div class="exec-metric-sub">' + a.useName + '</div>';
        html += '<div style="margin-top:0.5rem;">';
        html += '<div style="font-size:1.3rem;font-weight:700;color:' + (a.computed.devMargin >= 0.15 ? '#276749' : a.computed.devMargin >= 0.05 ? '#b7791f' : '#c53030') + ';">' + (a.computed.devMargin * 100).toFixed(1) + '% <span style="font-size:0.7rem;font-weight:400;color:var(--text-light);">margin</span></div>';
        html += '<div style="font-size:0.82rem;color:var(--text-light);">IRR: ' + (a.irr * 100).toFixed(1) + '% | ' + a.totalMo + ' mo</div>';
        html += '<div style="font-size:0.82rem;color:var(--text-light);">Cost: ' + formatCompactDollars(a.computed.totalDev) + ' | Value: ' + formatCompactDollars(a.computed.stabilizedValue) + '</div>';
        html += '</div></div>';
    }
    html += '</div>';

    // Comparison matrix table
    html += '<h4 style="color:var(--primary);margin-bottom:0.75rem;">Comparison Matrix</h4>';
    html += '<div style="overflow-x:auto;"><table class="budget-table">';
    html += '<tr><th style="text-align:left;">Metric</th>';
    for (var k = 0; k < analyses.length; k++) {
        html += '<th style="text-align:center;min-width:120px;">' + (analyses[k].prop.address || 'Prop ' + (k + 1)).substring(0, 25) + '</th>';
    }
    html += '</tr>';

    var metrics = [
        { label: 'Best Use', fn: function(a) { return a.useName; } },
        { label: 'Lot Size', fn: function(a) { return (a.inp.parcelSize || 0).toLocaleString() + ' SF'; } },
        { label: 'GSF', fn: function(a) { return a.computed.gsf.toLocaleString(); } },
        { label: 'Units', fn: function(a) { return a.computed.units || 'N/A'; } },
        { label: 'Stories', fn: function(a) { return a.computed.stories; } },
        { label: 'Total Dev Cost', fn: function(a) { return formatCompactDollars(a.computed.totalDev); } },
        { label: 'Stabilized Value', fn: function(a) { return formatCompactDollars(a.computed.stabilizedValue); } },
        { label: 'NOI', fn: function(a) { return formatCompactDollars(a.computed.noi); } },
        { label: 'Dev Margin', fn: function(a) { return (a.computed.devMargin * 100).toFixed(1) + '%'; }, highlight: true },
        { label: 'IRR', fn: function(a) { return (a.irr * 100).toFixed(1) + '%'; }, highlight: true },
        { label: 'Yield on Cost', fn: function(a) { return (a.computed.yieldOnCost * 100).toFixed(1) + '%'; } },
        { label: 'Cap Rate', fn: function(a) { return (a.computed.capRate * 100).toFixed(1) + '%'; } },
        { label: 'Build Cost/SF', fn: function(a) { return fmt(a.computed.buildCostPSF); } },
        { label: 'Timeline', fn: function(a) { return a.totalMo + ' months'; } },
        { label: 'Ease of Execution', fn: function(a) { return a.ease + '/100'; } },
        { label: 'Risk Level', fn: function(a) { return a.risk.level; } },
        { label: 'Parking Spaces', fn: function(a) { return a.computed.parkingSpaces; } },
    ];

    for (var m = 0; m < metrics.length; m++) {
        var met = metrics[m];
        html += '<tr' + (met.highlight ? ' style="background:#f0fff4;font-weight:600;"' : '') + '><td style="font-weight:600;">' + met.label + '</td>';
        for (var n = 0; n < analyses.length; n++) {
            html += '<td style="text-align:center;">' + met.fn(analyses[n]) + '</td>';
        }
        html += '</tr>';
    }

    // Portfolio totals
    var totalCost = 0, totalValue = 0, totalNOI = 0, totalUnits = 0;
    for (var q = 0; q < analyses.length; q++) {
        totalCost += analyses[q].computed.totalDev;
        totalValue += analyses[q].computed.stabilizedValue;
        totalNOI += analyses[q].computed.noi;
        totalUnits += (analyses[q].computed.units || 0);
    }
    html += '<tr class="grand-total"><td>PORTFOLIO TOTAL</td>';
    html += '<td style="text-align:center;" colspan="' + analyses.length + '">';
    html += 'Cost: ' + formatCompactDollars(totalCost) + ' | Value: ' + formatCompactDollars(totalValue) + ' | NOI: ' + formatCompactDollars(totalNOI) + ' | Units: ' + totalUnits;
    html += '</td></tr>';
    html += '</table></div>';

    // Horizontal Grouped Bar Chart â€” HBU Criteria Comparison
    html += '</div><div class="analysis-section"><h3>HBU Criteria Comparison</h3>';
    html += '<p style="font-size:0.78rem;color:var(--text-light);margin-bottom:1rem;">Each criterion scored 0-100. Bars show relative strength across properties.</p>';

    var axes = ['Legal', 'Physical', 'Financial', 'Risk', 'Market', 'Entitlement'];
    var axisKeys = ['legal', 'physical', 'financial', 'risk', 'market', 'entitlement'];

    // Legend
    html += '<div style="display:flex;flex-wrap:wrap;gap:1rem;margin-bottom:1rem;">';
    for (var lg = 0; lg < analyses.length; lg++) {
        var lgColor = USE_COLORS[analyses[lg].bestUse] || '#3182ce';
        var lgAddr = (analyses[lg].prop.address || 'Property ' + (lg + 1)).substring(0, 25);
        html += '<div style="display:flex;align-items:center;gap:0.35rem;font-size:0.75rem;">';
        html += '<span style="width:12px;height:12px;border-radius:2px;background:' + lgColor + ';display:inline-block;"></span>';
        html += '<span>' + lgAddr + '</span></div>';
    }
    html += '</div>';

    // Bar chart rows
    for (var ax = 0; ax < axes.length; ax++) {
        html += '<div style="margin-bottom:0.75rem;">';
        html += '<div style="font-size:0.78rem;font-weight:600;color:var(--text);margin-bottom:0.3rem;">' + axes[ax] + '</div>';
        for (var bp = 0; bp < analyses.length; bp++) {
            var barVal = Math.round((analyses[bp].scores[axisKeys[ax]] || 0) * 100);
            var barColor = USE_COLORS[analyses[bp].bestUse] || '#3182ce';
            var barAddr = (analyses[bp].prop.address || 'Prop ' + (bp + 1)).substring(0, 20);
            html += '<div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:2px;">';
            html += '<span style="font-size:0.68rem;color:#718096;width:120px;text-align:right;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + barAddr + '</span>';
            html += '<div style="flex:1;background:#edf2f7;border-radius:4px;height:18px;overflow:hidden;">';
            html += '<div style="width:' + barVal + '%;height:100%;background:' + barColor + ';border-radius:4px;transition:width 0.3s;"></div>';
            html += '</div>';
            html += '<span style="font-size:0.72rem;font-weight:600;color:' + barColor + ';width:32px;">' + barVal + '</span>';
            html += '</div>';
        }
        html += '</div>';
    }

    // Composite Score Breakdown (Weighted Scorecard)
    html += '<h4 style="font-size:0.85rem;color:var(--text);margin:1.25rem 0 0.5rem;">Composite Score Breakdown</h4>';
    html += '<p style="font-size:0.72rem;color:var(--text-light);margin-bottom:0.75rem;">Weighted: Financial 40% | IRR 30% | Legal 15% | Physical 15%</p>';
    for (var cs = 0; cs < analyses.length; cs++) {
        var csAn = analyses[cs];
        var csColor = USE_COLORS[csAn.bestUse] || '#3182ce';
        var csAddr = (csAn.prop.address || 'Property ' + (cs + 1)).substring(0, 30);
        var compScore = Math.round((csAn.computed.devMargin * 0.4 + csAn.irr * 0.3 + csAn.scores.legal * 0.15 + csAn.scores.physical * 0.15) * 100);
        // Stacked breakdown bar
        var wFin = Math.round(csAn.computed.devMargin * 40);
        var wIRR = Math.round(csAn.irr * 30);
        var wLegal = Math.round(csAn.scores.legal * 15);
        var wPhys = Math.round(csAn.scores.physical * 15);
        html += '<div style="margin-bottom:0.6rem;">';
        html += '<div style="display:flex;justify-content:space-between;font-size:0.78rem;margin-bottom:0.2rem;">';
        html += '<span style="font-weight:600;color:' + csColor + ';">#' + (cs + 1) + ' ' + csAddr + '</span>';
        html += '<span style="font-weight:700;color:' + csColor + ';">' + compScore + ' pts</span>';
        html += '</div>';
        html += '<div style="display:flex;height:20px;border-radius:4px;overflow:hidden;background:#edf2f7;">';
        html += '<div style="width:' + wFin + '%;background:' + csColor + ';opacity:1;" title="Financial: ' + wFin + '"></div>';
        html += '<div style="width:' + wIRR + '%;background:' + csColor + ';opacity:0.75;" title="IRR: ' + wIRR + '"></div>';
        html += '<div style="width:' + wLegal + '%;background:' + csColor + ';opacity:0.5;" title="Legal: ' + wLegal + '"></div>';
        html += '<div style="width:' + wPhys + '%;background:' + csColor + ';opacity:0.35;" title="Physical: ' + wPhys + '"></div>';
        html += '</div>';
        html += '<div style="display:flex;gap:0.75rem;font-size:0.65rem;color:#718096;margin-top:0.15rem;">';
        html += '<span>Financial: ' + wFin + '</span><span>IRR: ' + wIRR + '</span><span>Legal: ' + wLegal + '</span><span>Physical: ' + wPhys + '</span>';
        html += '</div></div>';
    }
    html += '';

    // Portfolio Investment Thesis
    html += '</div><div class="analysis-section"><h3>Portfolio Investment Thesis</h3>';
    html += '<p style="font-size:0.78rem;color:#718096;margin-bottom:1rem;">Combined analysis of all ' + analyses.length + ' properties as a single portfolio. Evaluate aggregate returns, diversification benefits, and combined development strategy.</p>';

    // Portfolio summary metrics
    var portfolioEquity = Math.round(totalCost * 0.35);
    var portfolioCF = totalNOI - Math.round((totalCost - portfolioEquity) * 0.065);
    var portfolioCOC = portfolioEquity > 0 ? portfolioCF / portfolioEquity : 0;
    var portfolioYOC = totalCost > 0 ? totalNOI / totalCost : 0;
    var weightedMargin = analyses.reduce(function(s, a) { return s + a.computed.devMargin * a.computed.totalDev; }, 0) / Math.max(totalCost, 1);
    var weightedIRR = analyses.reduce(function(s, a) { return s + a.irr * a.computed.totalDev; }, 0) / Math.max(totalCost, 1);
    var avgTimeline = Math.round(analyses.reduce(function(s, a) { return s + a.totalMo; }, 0) / analyses.length);
    var totalGSF = analyses.reduce(function(s, a) { return s + a.computed.gsf; }, 0);

    html += '<div class="exec-summary-grid">';
    html += '<div class="exec-summary-card"><h4>Total Portfolio Cost</h4><div class="exec-metric-lg">' + formatCompactDollars(totalCost) + '</div><div class="exec-metric-sub">' + analyses.length + ' properties | ' + totalGSF.toLocaleString() + ' total GSF</div></div>';
    html += '<div class="exec-summary-card"><h4>Portfolio Value</h4><div class="exec-metric-lg" style="color:#276749;">' + formatCompactDollars(totalValue) + '</div><div class="exec-metric-sub">Profit: ' + formatCompactDollars(totalValue - totalCost) + '</div></div>';
    html += '<div class="exec-summary-card"><h4>Wtd Avg Margin</h4><div class="exec-metric-lg" style="color:' + (weightedMargin >= 0.15 ? '#276749' : '#b7791f') + ';">' + (weightedMargin * 100).toFixed(1) + '%</div><div class="exec-metric-sub">Wtd IRR: ' + (weightedIRR * 100).toFixed(1) + '%</div></div>';
    html += '<div class="exec-summary-card"><h4>Portfolio Cash Flow</h4><div class="exec-metric-lg">' + formatCompactDollars(portfolioCF) + '/yr</div><div class="exec-metric-sub">' + (portfolioCOC * 100).toFixed(1) + '% cash-on-cash | ' + totalUnits + ' total units</div></div>';
    html += '</div>';

    // Capital structure
    html += '<h4 style="font-size:0.85rem;margin:1.25rem 0 0.5rem;">Portfolio Capital Structure</h4>';
    var portfolioDebt = totalCost - portfolioEquity;
    html += '<div style="display:flex;gap:1rem;margin-bottom:1rem;font-size:0.78rem;flex-wrap:wrap;">';
    html += '<div style="background:#ebf8ff;border-radius:6px;padding:0.5rem 1rem;"><strong>Equity Required:</strong> ' + formatCompactDollars(portfolioEquity) + ' (35%)</div>';
    html += '<div style="background:#fefcbf;border-radius:6px;padding:0.5rem 1rem;"><strong>Total Debt:</strong> ' + formatCompactDollars(portfolioDebt) + ' (65%)</div>';
    html += '<div style="background:#f0fff4;border-radius:6px;padding:0.5rem 1rem;"><strong>Portfolio NOI:</strong> ' + formatCompactDollars(totalNOI) + '/yr</div>';
    html += '<div style="background:#fed7d7;border-radius:6px;padding:0.5rem 1rem;"><strong>Debt Service:</strong> ' + formatCompactDollars(Math.round(portfolioDebt * 0.065)) + '/yr</div>';
    html += '</div>';

    // Diversification analysis
    html += '<h4 style="font-size:0.85rem;margin:1.25rem 0 0.5rem;">Diversification Analysis</h4>';
    var useTypes = {};
    analyses.forEach(function(a) {
        if (!useTypes[a.useName]) useTypes[a.useName] = { count: 0, cost: 0, value: 0, noi: 0 };
        useTypes[a.useName].count++;
        useTypes[a.useName].cost += a.computed.totalDev;
        useTypes[a.useName].value += a.computed.stabilizedValue;
        useTypes[a.useName].noi += a.computed.noi;
    });
    html += '<div style="overflow-x:auto;"><table class="budget-table" style="font-size:0.75rem;">';
    html += '<tr><th>Use Type</th><th style="text-align:center;">Properties</th><th style="text-align:right;">Cost</th><th style="text-align:right;">Value</th><th style="text-align:right;">NOI</th><th style="text-align:right;">% of Portfolio</th></tr>';
    Object.keys(useTypes).forEach(function(name) {
        var ut = useTypes[name];
        var pct = totalCost > 0 ? (ut.cost / totalCost * 100).toFixed(0) : 0;
        html += '<tr><td style="font-weight:600;">' + name + '</td><td style="text-align:center;">' + ut.count + '</td>';
        html += '<td style="text-align:right;">' + formatCompactDollars(ut.cost) + '</td>';
        html += '<td style="text-align:right;">' + formatCompactDollars(ut.value) + '</td>';
        html += '<td style="text-align:right;">' + formatCompactDollars(ut.noi) + '</td>';
        html += '<td style="text-align:right;">' + pct + '%</td></tr>';
    });
    html += '</table></div>';

    // Execution strategy
    html += '<h4 style="font-size:0.85rem;margin:1.25rem 0 0.5rem;">Phased Execution Strategy</h4>';
    var sortedByIRR = analyses.slice().sort(function(a, b) { return b.irr - a.irr; });
    html += '<div style="font-size:0.78rem;color:var(--text);line-height:1.6;">';
    html += '<p><strong>Recommended execution order</strong> (highest IRR first to recycle equity):</p>';
    html += '<ol style="margin:0.5rem 0;padding-left:1.5rem;">';
    var cumMo = 0;
    sortedByIRR.forEach(function(a, i) {
        cumMo += a.totalMo;
        html += '<li><strong>' + (a.prop.address || 'Property ' + (i + 1)).substring(0, 30) + '</strong> â€” ' + a.useName + ' (' + a.totalMo + ' mo, ' + (a.irr * 100).toFixed(1) + '% IRR, ' + formatCompactDollars(a.computed.totalDev) + ' cost)</li>';
    });
    html += '</ol>';
    html += '<p style="margin-top:0.5rem;">Sequential execution: ~' + cumMo + ' months. Staggered (overlapping): ~' + Math.round(cumMo * 0.65) + ' months with equity recycling from earlier completions.</p>';
    html += '</div>';

    // Quick recommendation
    html += '</div><div class="analysis-section">';
    html += '<div class="exec-recommendation"><h4>Quick Recommendation</h4>';
    var best = analyses[0];
    var second = analyses.length > 1 ? analyses[1] : null;
    html += '<p style="font-size:0.88rem;color:var(--text);line-height:1.65;">';
    html += '<strong>' + (best.prop.address || 'Property #1') + '</strong> ranks highest with a ' + (best.computed.devMargin * 100).toFixed(1) + '% development margin and ' + (best.irr * 100).toFixed(1) + '% estimated IRR as a <strong>' + best.useName + '</strong> project. ';
    html += 'Total development cost of ' + formatCompactDollars(best.computed.totalDev) + ' yields a stabilized value of ' + formatCompactDollars(best.computed.stabilizedValue) + ' over a ' + best.totalMo + '-month timeline. ';
    if (second) {
        html += 'The second-ranked property at <strong>' + (second.prop.address || 'Property #2') + '</strong> shows a ' + (second.computed.devMargin * 100).toFixed(1) + '% margin as ' + second.useName + '. ';
        if (best.computed.devMargin - second.computed.devMargin < 0.03) {
            html += 'The two properties are closely comparable; consider risk profile and execution complexity as tiebreakers. ';
        }
    }
    html += 'Portfolio total development cost across all ' + analyses.length + ' properties: ' + formatCompactDollars(totalCost) + ' with combined stabilized value of ' + formatCompactDollars(totalValue) + '.';
    html += '</p></div>';

    html += '</div></div>';
    return html;
}


// ============================================================
//  Executive Summary Property Selector
// ============================================================

function renderExecPropertySelector(saved) {
    var allChecked = deepAnalysisSelectedProps.every(function(v) { return v; });
    var noneChecked = deepAnalysisSelectedProps.every(function(v) { return !v; });
    var html = '<div style="background:#f7fafc;border:1px solid #e2e8f0;border-radius:8px;padding:12px 16px;margin-bottom:16px;">';
    html += '<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:8px;">';
    html += '<span style="font-weight:600;font-size:0.85rem;color:#2d3748;">Properties in Summary:</span>';
    html += '<div style="display:flex;gap:6px;">';
    html += '<button onclick="execSelectAll(true)" style="padding:3px 10px;font-size:0.75rem;border-radius:4px;border:1px solid #cbd5e0;background:' + (allChecked ? '#3182ce' : '#fff') + ';color:' + (allChecked ? '#fff' : '#4a5568') + ';cursor:pointer;">All</button>';
    html += '<button onclick="execSelectAll(false)" style="padding:3px 10px;font-size:0.75rem;border-radius:4px;border:1px solid #cbd5e0;background:' + (noneChecked ? '#e53e3e' : '#fff') + ';color:' + (noneChecked ? '#fff' : '#4a5568') + ';cursor:pointer;">Clear</button>';
    html += '</div></div>';
    html += '<div style="display:flex;flex-wrap:wrap;gap:8px;">';
    for (var i = 0; i < saved.length; i++) {
        var p = saved[i];
        var label = p.address || p.apn || ('Property ' + (i + 1));
        var checked = deepAnalysisSelectedProps[i] ? 'checked' : '';
        html += '<label style="display:flex;align-items:center;gap:5px;padding:4px 10px;border-radius:6px;border:1px solid ' + (deepAnalysisSelectedProps[i] ? '#3182ce' : '#e2e8f0') + ';background:' + (deepAnalysisSelectedProps[i] ? 'rgba(49,130,206,0.08)' : '#fff') + ';cursor:pointer;font-size:0.8rem;color:#2d3748;transition:all 0.15s;">';
        html += '<input type="checkbox" ' + checked + ' onchange="toggleExecProp(' + i + ')" style="accent-color:#3182ce;cursor:pointer;">';
        html += '<span>' + label + '</span>';
        html += '</label>';
    }
    html += '</div></div>';
    return html;
}

function execSelectAll(selectAll) {
    deepAnalysisSelectedProps = deepAnalysisSelectedProps.map(function() { return selectAll; });
    updateExecSelection();
}

function toggleExecProp(idx) {
    deepAnalysisSelectedProps[idx] = !deepAnalysisSelectedProps[idx];
    updateExecSelection();
}

function updateExecSelection() {
    var st = deepAnalysisState;
    if (!st || !st.saved || st.saved.length < 2) return;

    var selectedSaved = st.saved.filter(function(_, i) { return deepAnalysisSelectedProps[i]; });

    // Re-render the entire tab 0 panel (selector + content)
    var panel = document.querySelector('#deepTabPanels .deep-tab-panel:first-child');
    if (!panel) return;

    var html = renderExecPropertySelector(st.saved);
    html += '<div id="execSummaryContent">';

    if (selectedSaved.length === 0) {
        html += '<div class="analysis-section" style="text-align:center;padding:40px;color:#718096;"><p>Select at least one property above to view the Executive Summary.</p></div>';
    } else if (selectedSaved.length === 1) {
        var sp = selectedSaved[0];
        var spInp = buildInpFromSaved(sp);
        var spBestUse = determineBestUse(spInp);
        var spLeg = getApplicableLegislation(spBestUse, spInp);
        var spEff = stackLegislationEffects(spLeg);
        var spAss = getDefaultAssumptions(spBestUse, spInp, spEff);
        var spComp = computeFromAssumptions(spBestUse, spInp, spAss, spEff);
        var singleSt = { prop: sp, inp: spInp, bestUse: spBestUse, legislation: spLeg, effects: spEff, assumptions: spAss, computed: spComp };
        var execHtml = renderExecSummaryTab(singleSt);
        execHtml = execHtml.replace(/^<div class="deep-tab-panel[^"]*">/, '').replace(/<\/div>\s*$/, '');
        html += execHtml;
    } else {
        var dashHtml = renderComparisonDashboard(selectedSaved);
        dashHtml = dashHtml.replace(/^<div class="deep-tab-panel[^"]*">/, '').replace(/<\/div>\s*$/, '');
        html += dashHtml;
    }

    html += '</div>';
    panel.innerHTML = html;
}


// ============================================================
//  SKILL 38: GENERATIVE DESIGN ENGINE
// ============================================================

function generateDesignScenarios(inp, effects) {
    const scenarios = [];
    const zoneRow = ZONING_MATRIX[inp.zoning];
    const parkingStrategies = ['surface', 'podium', 'subterranean'];
    const affordablePcts = [0, 0.10, 0.15, 0.20];

    // Filter to viable use types
    const viableUses = LAND_USES.filter(u => {
        const score = zoneRow ? (zoneRow[u.id] || 0) : 0;
        return score > 0 || (effects && effects.legalOverride);
    });

    for (const use of viableUses) {
        const legislation = getApplicableLegislation(use.id, inp);
        const eff = stackLegislationEffects(legislation);
        const computed = generateBudget(use.id, inp, eff);
        if (!computed || computed.totalDev <= 0) continue;

        const tl = TIMELINE_MONTHS[use.id] || { entitlement: 6, design: 4, permits: 3, construction: 18, leaseup: 6 };
        const totalMo = tl.entitlement + tl.design + tl.permits + tl.construction + tl.leaseup;
        const irr = approxIRR(computed.devMargin, totalMo);
        const legalScore = scoreLegal(use.id, inp, eff);
        const physScore = scorePhysical(use.id, inp);
        const ease = computeEaseOfExecution(use.id, inp, eff, legalScore * 100);
        const risk = computeRiskLevel(use.id, inp, legalScore, physScore);

        // Base scenario
        scenarios.push({
            id: scenarios.length,
            useId: use.id,
            useName: use.name,
            useIcon: use.icon,
            parking: computed.parkingSpaces > 20 ? 'podium' : 'surface',
            affordablePct: eff.affordableReq || 0,
            units: computed.units,
            gsf: computed.gsf,
            stories: computed.stories,
            totalCost: computed.totalDev,
            stabilizedValue: computed.stabilizedValue,
            devMargin: computed.devMargin,
            irr: irr,
            noi: computed.noi,
            yoc: computed.yieldOnCost,
            timeline: totalMo,
            riskLevel: risk.level,
            riskColor: risk.color,
            ease: ease,
            costPerUnit: computed.units ? Math.round(computed.totalDev / computed.units) : null,
            costPerSF: Math.round(computed.totalDev / Math.max(computed.gsf, 1)),
        });

        // Variant with higher affordable %
        if (computed.units && computed.units > 5) {
            const affPct = Math.min(0.20, (eff.affordableReq || 0) + 0.10);
            const affUnits = Math.floor(computed.units * affPct);
            const mktUnits = computed.units - affUnits;
            const affRevReduction = affUnits * (computed.revenuePSF * (BUILDING_PARAMS[use.id].unitSF || 800) * 0.45);
            const adjNOI = computed.noi - affRevReduction;
            const adjValue = adjNOI > 0 ? Math.round(adjNOI / computed.capRate) : 0;
            const adjMargin = adjValue > 0 ? (adjValue - computed.totalDev) / computed.totalDev : -1;
            if (adjMargin > -0.5) {
                scenarios.push({
                    id: scenarios.length,
                    useId: use.id,
                    useName: use.name + ' (High Aff.)',
                    useIcon: use.icon,
                    parking: 'podium',
                    affordablePct: affPct,
                    units: computed.units,
                    gsf: computed.gsf,
                    stories: computed.stories,
                    totalCost: computed.totalDev,
                    stabilizedValue: adjValue,
                    devMargin: adjMargin,
                    irr: approxIRR(adjMargin, totalMo),
                    noi: adjNOI,
                    yoc: adjNOI / computed.totalDev,
                    timeline: totalMo,
                    riskLevel: risk.level,
                    riskColor: risk.color,
                    ease: Math.min(100, ease + 10),
                    costPerUnit: computed.units ? Math.round(computed.totalDev / computed.units) : null,
                    costPerSF: Math.round(computed.totalDev / Math.max(computed.gsf, 1)),
                });
            }
        }
    }

    // Sort by dev margin descending by default
    scenarios.sort((a, b) => b.devMargin - a.devMargin);
    return scenarios;
}

let currentGenGoal = 'margin';

function sortScenarios(scenarios, goal) {
    const sorted = [...scenarios];
    switch (goal) {
        case 'irr': sorted.sort((a, b) => b.irr - a.irr); break;
        case 'units': sorted.sort((a, b) => (b.units || 0) - (a.units || 0)); break;
        case 'risk': sorted.sort((a, b) => a.ease - b.ease).reverse(); break;
        case 'margin': sorted.sort((a, b) => b.devMargin - a.devMargin); break;
        case 'speed': sorted.sort((a, b) => a.timeline - b.timeline); break;
        default: sorted.sort((a, b) => b.devMargin - a.devMargin);
    }
    return sorted;
}

function renderGenerativeDesignTab(st) {
    const { inp, effects } = st;
    const scenarios = generateDesignScenarios(inp, effects);

    let html = `<div class="deep-tab-panel">`;
    html += `<div class="analysis-section"><h3>Generative Design Engine</h3>
        <p style="font-size:0.85rem;color:var(--text-light);margin-bottom:1rem;">Auto-generated ${scenarios.length} development scenarios based on zoning, site constraints, and market conditions. Select an optimization goal to re-rank.</p>
        <div style="display:flex;align-items:center;gap:1rem;flex-wrap:wrap;margin-bottom:0.75rem;">
            <div class="opt-goal-btns" id="genGoalBtns" style="margin-bottom:0;">
                <button class="opt-goal-btn active" onclick="reRankScenarios('margin')">Max Margin</button>
                <button class="opt-goal-btn" onclick="reRankScenarios('irr')">Max IRR</button>
                <button class="opt-goal-btn" onclick="reRankScenarios('units')">Max Units</button>
                <button class="opt-goal-btn" onclick="reRankScenarios('risk')">Min Risk</button>
                <button class="opt-goal-btn" onclick="reRankScenarios('speed')">Fastest</button>
            </div>
            <div style="display:flex;align-items:center;gap:0.4rem;font-size:0.75rem;color:var(--text-light);margin-left:auto;">
                <label>Min Return:</label>
                <input type="number" id="genMinIRR" style="width:55px;padding:3px 6px;border:1px solid #cbd5e0;border-radius:4px;font-size:0.75rem;" value="0" step="1" min="0" max="50" oninput="filterScenariosByReturn()"> % IRR
                <label style="margin-left:0.5rem;">Min Margin:</label>
                <input type="number" id="genMinMargin" style="width:55px;padding:3px 6px;border:1px solid #cbd5e0;border-radius:4px;font-size:0.75rem;" value="0" step="1" min="-50" max="100" oninput="filterScenariosByReturn()"> %
            </div>
        </div>
        <div class="scenario-grid" id="scenarioGrid">`;

    const top = scenarios.slice(0, 8);
    top.forEach((sc, i) => {
        const isWinner = i === 0;
        html += `<div class="scenario-card ${isWinner ? 'winner' : ''}">
            <div class="scenario-rank">${isWinner ? 'TOP PICK' : '#' + (i + 1)}</div>
            <div style="font-size:1.1rem;margin-bottom:0.25rem;">${sc.useIcon} <strong>${sc.useName}</strong></div>
            <div style="font-size:0.78rem;color:var(--text-light);">${sc.stories} stories | ${(sc.gsf || 0).toLocaleString()} GSF${sc.units ? ' | ' + sc.units + ' units' : ''}</div>
            ${sc.affordablePct > 0 ? `<div style="font-size:0.72rem;color:#805ad5;margin-top:0.25rem;">${(sc.affordablePct * 100).toFixed(0)}% affordable set-aside</div>` : ''}
            <div class="scenario-metrics">
                <div class="scenario-metric">
                    <div class="val" style="color:${sc.devMargin >= 0.15 ? '#276749' : sc.devMargin >= 0.05 ? '#b7791f' : '#c53030'}">${(sc.devMargin * 100).toFixed(1)}%</div>
                    <div class="lbl">Dev Margin</div>
                </div>
                <div class="scenario-metric">
                    <div class="val" style="color:${sc.irr >= 0.10 ? '#276749' : sc.irr >= 0.06 ? '#b7791f' : '#c53030'}">${(sc.irr * 100).toFixed(1)}%</div>
                    <div class="lbl">Est. IRR</div>
                </div>
                <div class="scenario-metric">
                    <div class="val">${formatCompactDollars(sc.totalCost)}</div>
                    <div class="lbl">Total Cost</div>
                </div>
                <div class="scenario-metric">
                    <div class="val">${sc.timeline} mo</div>
                    <div class="lbl">Timeline</div>
                </div>
            </div>
            <div style="margin-top:0.75rem;text-align:center;">
                <span class="risk-badge" style="color:${sc.riskColor};font-size:0.75rem;">${sc.riskLevel} Risk</span>
                <span style="font-size:0.72rem;color:var(--text-light);margin-left:0.5rem;">Ease: ${sc.ease}/100</span>
            </div>
            <button onclick="expandScenarioDetail(${sc.id})" style="margin-top:0.6rem;width:100%;padding:6px;background:#4299e1;color:#fff;border:none;border-radius:4px;font-size:0.72rem;cursor:pointer;font-weight:600;">View Full Details</button>
        </div>`;
    });

    html += `</div></div>`;
    // Expanded detail panel placeholder
    html += `<div id="scenarioDetailPanel" style="display:none;"></div>`;

    // Trade-off summary
    if (scenarios.length >= 3) {
        const byIRR = [...scenarios].sort((a, b) => b.irr - a.irr)[0];
        const byUnits = [...scenarios].sort((a, b) => (b.units || 0) - (a.units || 0))[0];
        const bySpeed = [...scenarios].sort((a, b) => a.timeline - b.timeline)[0];
        const byMargin = scenarios[0];

        html += `<div class="analysis-section"><h3>Trade-Off Analysis</h3>
            <div style="font-size:0.85rem;line-height:1.7;color:var(--text);">
                <strong>Highest Margin:</strong> ${byMargin.useIcon} ${byMargin.useName} at ${(byMargin.devMargin * 100).toFixed(1)}% margin (${formatCompactDollars(byMargin.totalCost)} total cost, ${byMargin.timeline} months).<br>
                <strong>Highest IRR:</strong> ${byIRR.useIcon} ${byIRR.useName} at ${(byIRR.irr * 100).toFixed(1)}% IRR â€” ${byIRR.irr > byMargin.irr ? 'better time-adjusted returns despite ' + (byIRR.devMargin < byMargin.devMargin ? 'lower margin' : 'similar margin') : 'same as top margin pick'}.<br>
                <strong>Most Units:</strong> ${byUnits.useIcon} ${byUnits.useName} with ${byUnits.units || 0} units â€” ${byUnits.devMargin < byMargin.devMargin ? 'trades margin for density' : 'maintains strong margins'}.<br>
                <strong>Fastest Execution:</strong> ${bySpeed.useIcon} ${bySpeed.useName} at ${bySpeed.timeline} months â€” ideal for developers prioritizing speed to market.
            </div>
        </div>`;
    }

    html += `</div>`;
    return html;
}

function reRankScenarios(goal) {
    currentGenGoal = goal;
    // Re-render just the scenario content
    const st = deepAnalysisState;
    if (!st) return;
    const scenarios = generateDesignScenarios(st.inp, st.effects);
    const sorted = sortScenarios(scenarios, goal);

    // Update button states
    document.querySelectorAll('.opt-goal-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');

    // Re-render scenario cards
    const grid = document.getElementById('scenarioGrid');
    if (!grid) return;
    let cardHtml = '';
    sorted.slice(0, 8).forEach((sc, i) => {
        const isWinner = i === 0;
        cardHtml += `<div class="scenario-card ${isWinner ? 'winner' : ''}">
            <div class="scenario-rank">${isWinner ? 'TOP PICK' : '#' + (i + 1)}</div>
            <div style="font-size:1.1rem;margin-bottom:0.25rem;">${sc.useIcon} <strong>${sc.useName}</strong></div>
            <div style="font-size:0.78rem;color:var(--text-light);">${sc.stories} stories | ${(sc.gsf || 0).toLocaleString()} GSF${sc.units ? ' | ' + sc.units + ' units' : ''}</div>
            ${sc.affordablePct > 0 ? `<div style="font-size:0.72rem;color:#805ad5;margin-top:0.25rem;">${(sc.affordablePct * 100).toFixed(0)}% affordable set-aside</div>` : ''}
            <div class="scenario-metrics">
                <div class="scenario-metric"><div class="val" style="color:${sc.devMargin >= 0.15 ? '#276749' : sc.devMargin >= 0.05 ? '#b7791f' : '#c53030'}">${(sc.devMargin * 100).toFixed(1)}%</div><div class="lbl">Dev Margin</div></div>
                <div class="scenario-metric"><div class="val" style="color:${sc.irr >= 0.10 ? '#276749' : sc.irr >= 0.06 ? '#b7791f' : '#c53030'}">${(sc.irr * 100).toFixed(1)}%</div><div class="lbl">Est. IRR</div></div>
                <div class="scenario-metric"><div class="val">${formatCompactDollars(sc.totalCost)}</div><div class="lbl">Total Cost</div></div>
                <div class="scenario-metric"><div class="val">${sc.timeline} mo</div><div class="lbl">Timeline</div></div>
            </div>
            <div style="margin-top:0.75rem;text-align:center;">
                <span class="risk-badge" style="color:${sc.riskColor};font-size:0.75rem;">${sc.riskLevel} Risk</span>
                <span style="font-size:0.72rem;color:var(--text-light);margin-left:0.5rem;">Ease: ${sc.ease}/100</span>
            </div>
            <button onclick="expandScenarioDetail(${sc.id})" style="margin-top:0.6rem;width:100%;padding:6px;background:#4299e1;color:#fff;border:none;border-radius:4px;font-size:0.72rem;cursor:pointer;font-weight:600;">View Full Details</button>
        </div>`;
    });
    grid.innerHTML = cardHtml;
}


// ============================================================
//  SCENARIO DETAIL EXPANSION + RETURN FILTER
// ============================================================

function expandScenarioDetail(scenarioId) {
    var st = deepAnalysisState;
    if (!st) return;
    var scenarios = generateDesignScenarios(st.inp, st.effects);
    var sc = scenarios.find(function(s) { return s.id === scenarioId; });
    if (!sc) return;

    var panel = document.getElementById('scenarioDetailPanel');
    if (!panel) return;

    var fmt = function(v) { return '$' + Math.round(v).toLocaleString(); };
    var fmtM = function(v) { return v >= 1e6 ? '$' + (v / 1e6).toFixed(1) + 'M' : fmt(v); };
    var params = BUILDING_PARAMS[sc.useId] || {};
    var hasUnits = !!params.unitSF;

    // Compute full pro forma for this scenario
    var legislation = getApplicableLegislation(sc.useId, st.inp);
    var eff = stackLegislationEffects(legislation);
    var assumptions = getDefaultAssumptions(sc.useId, st.inp, eff);
    var computed = computeFromAssumptions(sc.useId, st.inp, assumptions, eff);
    var tl = TIMELINE_MONTHS[sc.useId] || { entitlement: 6, design: 4, permits: 3, construction: 18, leaseup: 6 };
    var totalMo = tl.entitlement + tl.design + tl.permits + tl.construction + tl.leaseup;

    var html = '<div class="analysis-section" style="margin-top:1rem;border:2px solid #4299e1;border-radius:10px;padding:1.25rem;">';
    html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">';
    html += '<h3 style="margin:0;">' + sc.useIcon + ' ' + sc.useName + ' â€” Full Detail</h3>';
    html += '<button onclick="document.getElementById(\'scenarioDetailPanel\').style.display=\'none\'" style="background:#e53e3e;color:#fff;border:none;border-radius:4px;padding:4px 12px;cursor:pointer;font-size:0.75rem;">Close</button>';
    html += '</div>';

    // Building program
    html += '<h4 style="font-size:0.85rem;margin:1rem 0 0.5rem;">Building Program</h4>';
    html += '<div class="exec-summary-grid">';
    html += '<div class="exec-summary-card"><h4>Gross SF</h4><div class="exec-metric-lg">' + computed.gsf.toLocaleString() + '</div><div class="exec-metric-sub">' + computed.stories + ' stories / ' + computed.buildingHeight + ' ft</div></div>';
    if (hasUnits) {
        html += '<div class="exec-summary-card"><h4>Units</h4><div class="exec-metric-lg">' + computed.units + '</div><div class="exec-metric-sub">' + params.unitSF + ' SF avg unit</div></div>';
    } else {
        html += '<div class="exec-summary-card"><h4>Net Leasable</h4><div class="exec-metric-lg">' + computed.nsf.toLocaleString() + '</div><div class="exec-metric-sub">' + (params.eff * 100).toFixed(0) + '% efficiency</div></div>';
    }
    html += '<div class="exec-summary-card"><h4>Parking</h4><div class="exec-metric-lg">' + computed.parkingSpaces + '</div><div class="exec-metric-sub">spaces</div></div>';
    html += '<div class="exec-summary-card"><h4>FAR</h4><div class="exec-metric-lg">' + computed.far.toFixed(2) + '</div><div class="exec-metric-sub">Floor Area Ratio</div></div>';
    html += '</div>';

    // Pro Forma summary
    html += '<h4 style="font-size:0.85rem;margin:1rem 0 0.5rem;">Development Pro Forma</h4>';
    html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">';

    // Cost side
    html += '<div style="background:#fff5f5;border-radius:8px;padding:0.75rem;">';
    html += '<h5 style="font-size:0.8rem;margin:0 0 0.5rem;color:#c53030;">Costs</h5>';
    html += '<table style="width:100%;font-size:0.72rem;border-collapse:collapse;">';
    html += '<tr><td>Land Acquisition</td><td style="text-align:right;font-weight:600;">' + fmt(computed.landCost) + '</td></tr>';
    html += '<tr><td>Site Work</td><td style="text-align:right;">' + fmt(computed.siteWork) + '</td></tr>';
    if (computed.demolition > 0) html += '<tr><td>Demolition</td><td style="text-align:right;">' + fmt(computed.demolition) + '</td></tr>';
    html += '<tr><td>Construction (' + fmt(computed.buildCostPSF) + '/SF)</td><td style="text-align:right;">' + fmt(computed.construction) + '</td></tr>';
    html += '<tr><td>Parking</td><td style="text-align:right;">' + fmt(computed.parkingCost) + '</td></tr>';
    html += '<tr><td>Landscaping</td><td style="text-align:right;">' + fmt(computed.landscaping) + '</td></tr>';
    html += '<tr><td>Hard Contingency (7%)</td><td style="text-align:right;">' + fmt(computed.hardContingency) + '</td></tr>';
    html += '<tr style="border-top:2px solid #c53030;font-weight:700;"><td>Total Hard Costs</td><td style="text-align:right;">' + fmt(computed.totalHard) + '</td></tr>';
    html += '<tr><td colspan="2" style="height:6px;"></td></tr>';
    html += '<tr><td>Architecture & Engineering</td><td style="text-align:right;">' + fmt(computed.archEng) + '</td></tr>';
    html += '<tr><td>Permits & Fees</td><td style="text-align:right;">' + fmt(computed.permits) + '</td></tr>';
    html += '<tr><td>Legal</td><td style="text-align:right;">' + fmt(computed.legal) + '</td></tr>';
    html += '<tr><td>Financing</td><td style="text-align:right;">' + fmt(computed.financing) + '</td></tr>';
    html += '<tr><td>Marketing</td><td style="text-align:right;">' + fmt(computed.marketing) + '</td></tr>';
    html += '<tr><td>Developer Fee</td><td style="text-align:right;">' + fmt(computed.devFee) + '</td></tr>';
    html += '<tr style="border-top:2px solid #c53030;font-weight:700;"><td>Total Soft Costs</td><td style="text-align:right;">' + fmt(computed.totalSoft) + '</td></tr>';
    html += '<tr style="border-top:3px double #c53030;font-weight:700;font-size:0.82rem;"><td>TOTAL DEVELOPMENT COST</td><td style="text-align:right;">' + fmtM(computed.totalDev) + '</td></tr>';
    html += '</table></div>';

    // Revenue side
    html += '<div style="background:#f0fff4;border-radius:8px;padding:0.75rem;">';
    html += '<h5 style="font-size:0.8rem;margin:0 0 0.5rem;color:#276749;">Revenue & Returns</h5>';
    html += '<table style="width:100%;font-size:0.72rem;border-collapse:collapse;">';
    html += '<tr><td>Gross Revenue</td><td style="text-align:right;font-weight:600;">' + fmt(computed.grossRevenue) + '/yr</td></tr>';
    html += '<tr><td>Operating Expenses (' + (assumptions.opexPct || 35) + '%)</td><td style="text-align:right;color:#c53030;">(' + fmt(computed.opex) + ')</td></tr>';
    html += '<tr style="border-top:2px solid #276749;font-weight:700;"><td>Net Operating Income</td><td style="text-align:right;">' + fmt(computed.noi) + '/yr</td></tr>';
    html += '<tr><td colspan="2" style="height:8px;"></td></tr>';
    html += '<tr><td>Cap Rate</td><td style="text-align:right;">' + (computed.capRate * 100).toFixed(2) + '%</td></tr>';
    html += '<tr style="font-weight:700;font-size:0.82rem;"><td>Stabilized Value</td><td style="text-align:right;color:#276749;">' + fmtM(computed.stabilizedValue) + '</td></tr>';
    html += '<tr><td colspan="2" style="height:8px;"></td></tr>';
    html += '<tr><td>Development Margin</td><td style="text-align:right;color:' + (computed.devMargin >= 0.15 ? '#276749' : computed.devMargin >= 0.05 ? '#b7791f' : '#c53030') + ';font-weight:700;">' + (computed.devMargin * 100).toFixed(1) + '%</td></tr>';
    html += '<tr><td>Yield on Cost</td><td style="text-align:right;">' + (computed.yieldOnCost * 100).toFixed(2) + '%</td></tr>';
    html += '<tr><td>Estimated IRR</td><td style="text-align:right;color:' + (sc.irr >= 0.10 ? '#276749' : '#b7791f') + ';font-weight:700;">' + (sc.irr * 100).toFixed(1) + '%</td></tr>';
    html += '<tr><td>Timeline</td><td style="text-align:right;">' + totalMo + ' months</td></tr>';
    if (hasUnits) {
        html += '<tr><td>Cost per Unit</td><td style="text-align:right;">' + fmt(Math.round(computed.totalDev / Math.max(computed.units, 1))) + '</td></tr>';
    }
    html += '<tr><td>Cost per SF</td><td style="text-align:right;">' + fmt(Math.round(computed.totalDev / Math.max(computed.gsf, 1))) + '</td></tr>';
    html += '</table></div>';
    html += '</div>';

    // Applicable legislation
    html += '<h4 style="font-size:0.85rem;margin:1rem 0 0.5rem;">Applicable Legislation</h4>';
    html += '<div style="display:flex;flex-wrap:wrap;gap:0.5rem;">';
    legislation.forEach(function(leg) {
        html += '<span style="background:#ebf8ff;border:1px solid #90cdf4;border-radius:4px;padding:3px 8px;font-size:0.72rem;color:#2b6cb0;">' + leg.name + '</span>';
    });
    if (legislation.length === 0) html += '<span style="font-size:0.72rem;color:#a0aec0;">No special legislation applies</span>';
    html += '</div>';

    // Timeline
    html += '<h4 style="font-size:0.85rem;margin:1rem 0 0.5rem;">Development Timeline</h4>';
    var phases = [
        { name: 'Entitlement', months: tl.entitlement, color: '#e53e3e' },
        { name: 'Design', months: tl.design, color: '#dd6b20' },
        { name: 'Permits', months: tl.permits, color: '#d69e2e' },
        { name: 'Construction', months: tl.construction, color: '#38a169' },
        { name: 'Lease-Up', months: tl.leaseup, color: '#3182ce' },
    ];
    html += '<div style="display:flex;height:32px;border-radius:6px;overflow:hidden;margin-bottom:0.5rem;">';
    phases.forEach(function(p) {
        var pct = p.months / totalMo * 100;
        html += '<div style="width:' + pct + '%;background:' + p.color + ';display:flex;align-items:center;justify-content:center;color:#fff;font-size:0.65rem;font-weight:600;min-width:30px;" title="' + p.name + ': ' + p.months + ' months">' + (pct > 12 ? p.name + ' ' + p.months + 'mo' : p.months) + '</div>';
    });
    html += '</div>';
    html += '<div style="font-size:0.7rem;color:#718096;">Total: ' + totalMo + ' months (' + (totalMo / 12).toFixed(1) + ' years)</div>';

    html += '</div>';
    panel.innerHTML = html;
    panel.style.display = 'block';
    panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function filterScenariosByReturn() {
    var minIRR = parseFloat(document.getElementById('genMinIRR').value) / 100 || 0;
    var minMargin = parseFloat(document.getElementById('genMinMargin').value) / 100 || -999;
    var cards = document.querySelectorAll('#scenarioGrid .scenario-card');
    var st = deepAnalysisState;
    if (!st) return;
    var scenarios = generateDesignScenarios(st.inp, st.effects);
    var sorted = sortScenarios(scenarios, currentGenGoal);

    cards.forEach(function(card, i) {
        if (i < sorted.length) {
            var sc = sorted[i];
            var show = sc.irr >= minIRR && sc.devMargin >= minMargin;
            card.style.display = show ? '' : 'none';
            card.style.opacity = show ? '1' : '0.3';
        }
    });
}

// ============================================================
//  10-YEAR STABILIZED CASH FLOW MODEL
// ============================================================

function renderCashFlowModelTab(st) {
    var c = st.computed, a = st.assumptions;
    var fmt = function(v) { return '$' + Math.round(v).toLocaleString(); };
    var fmtM = function(v) { return v >= 1e6 ? '$' + (v / 1e6).toFixed(1) + 'M' : fmt(v); };
    var html = '<div class="deep-tab-panel">';
    html += '<div class="analysis-section"><h3>10-Year Stabilized Cash Flow Model</h3>';
    html += '<p style="font-size:0.78rem;color:#718096;margin-bottom:1rem;">Year-by-year operating cash flow projection from stabilization through year 10. Editable growth assumptions allow scenario modeling for hold period analysis.</p>';

    // Editable assumptions
    html += '<div style="background:#f7fafc;border:1px solid #e2e8f0;border-radius:8px;padding:1rem;margin-bottom:1.25rem;">';
    html += '<h4 style="font-size:0.82rem;margin:0 0 0.75rem;">Cash Flow Assumptions (editable)</h4>';
    html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:0.75rem;">';
    html += '<div><label style="font-size:0.7rem;color:#718096;display:block;">Revenue Growth</label><input type="number" id="cf-revGrowth" value="3.0" step="0.5" min="0" max="10" style="width:100%;padding:4px 8px;border:1px solid #cbd5e0;border-radius:4px;font-size:0.78rem;" oninput="recalcCashFlow()"> <span style="font-size:0.65rem;color:#a0aec0;">% / year</span></div>';
    html += '<div><label style="font-size:0.7rem;color:#718096;display:block;">Expense Growth</label><input type="number" id="cf-expGrowth" value="2.5" step="0.5" min="0" max="10" style="width:100%;padding:4px 8px;border:1px solid #cbd5e0;border-radius:4px;font-size:0.78rem;" oninput="recalcCashFlow()"> <span style="font-size:0.65rem;color:#a0aec0;">% / year</span></div>';
    html += '<div><label style="font-size:0.7rem;color:#718096;display:block;">Vacancy Rate</label><input type="number" id="cf-vacancy" value="5.0" step="0.5" min="0" max="25" style="width:100%;padding:4px 8px;border:1px solid #cbd5e0;border-radius:4px;font-size:0.78rem;" oninput="recalcCashFlow()"> <span style="font-size:0.65rem;color:#a0aec0;">%</span></div>';
    html += '<div><label style="font-size:0.7rem;color:#718096;display:block;">Cap Ex Reserve</label><input type="number" id="cf-capex" value="3.0" step="0.5" min="0" max="15" style="width:100%;padding:4px 8px;border:1px solid #cbd5e0;border-radius:4px;font-size:0.78rem;" oninput="recalcCashFlow()"> <span style="font-size:0.65rem;color:#a0aec0;">% of revenue</span></div>';
    html += '<div><label style="font-size:0.7rem;color:#718096;display:block;">Debt Rate</label><input type="number" id="cf-debtRate" value="6.5" step="0.25" min="3" max="12" style="width:100%;padding:4px 8px;border:1px solid #cbd5e0;border-radius:4px;font-size:0.78rem;" oninput="recalcCashFlow()"> <span style="font-size:0.65rem;color:#a0aec0;">%</span></div>';
    html += '<div><label style="font-size:0.7rem;color:#718096;display:block;">LTV</label><input type="number" id="cf-ltv" value="75" step="5" min="0" max="85" style="width:100%;padding:4px 8px;border:1px solid #cbd5e0;border-radius:4px;font-size:0.78rem;" oninput="recalcCashFlow()"> <span style="font-size:0.65rem;color:#a0aec0;">%</span></div>';
    html += '<div><label style="font-size:0.7rem;color:#718096;display:block;">Target DSCR</label><input type="number" id="cf-targetDSCR" value="1.20" step="0.05" min="1.0" max="2.0" style="width:100%;padding:4px 8px;border:1px solid #cbd5e0;border-radius:4px;font-size:0.78rem;" oninput="recalcCashFlow()"> <span style="font-size:0.65rem;color:#a0aec0;">x</span></div>';
    html += '<div><label style="font-size:0.7rem;color:#718096;display:block;">Exit Cap Rate</label><input type="number" id="cf-exitCap" value="' + ((c.capRate || 0.05) * 100 + 0.25).toFixed(2) + '" step="0.25" min="2" max="12" style="width:100%;padding:4px 8px;border:1px solid #cbd5e0;border-radius:4px;font-size:0.78rem;" oninput="recalcCashFlow()"> <span style="font-size:0.65rem;color:#a0aec0;">%</span></div>';
    html += '<div><label style="font-size:0.7rem;color:#718096;display:block;">Mgmt Fee</label><input type="number" id="cf-mgmt" value="4.0" step="0.5" min="0" max="10" style="width:100%;padding:4px 8px;border:1px solid #cbd5e0;border-radius:4px;font-size:0.78rem;" oninput="recalcCashFlow()"> <span style="font-size:0.65rem;color:#a0aec0;">% of EGI</span></div>';
    html += '</div></div>';

    // Build cash flow table
    html += '<div id="cfTableContainer">';
    html += buildCashFlowTable(c);
    html += '</div>';

    html += '</div></div>';
    return html;
}

function buildCashFlowTable(c) {
    var fmt = function(v) { return '$' + Math.round(v).toLocaleString(); };
    var fmtM = function(v) { return v >= 1e6 ? '$' + (v / 1e6).toFixed(1) + 'M' : fmt(v); };

    var revGrowth = parseFloat((document.getElementById('cf-revGrowth') || {}).value) / 100 || 0.03;
    var expGrowth = parseFloat((document.getElementById('cf-expGrowth') || {}).value) / 100 || 0.025;
    var vacancyRate = parseFloat((document.getElementById('cf-vacancy') || {}).value) / 100 || 0.05;
    var capexRate = parseFloat((document.getElementById('cf-capex') || {}).value) / 100 || 0.03;
    var debtRate = parseFloat((document.getElementById('cf-debtRate') || {}).value) / 100 || 0.065;
    var ltv = parseFloat((document.getElementById('cf-ltv') || {}).value) / 100 || 0.65;
    var exitCap = parseFloat((document.getElementById('cf-exitCap') || {}).value) / 100 || ((c.capRate || 0.05) + 0.0025);
    var mgmtRate = parseFloat((document.getElementById('cf-mgmt') || {}).value) / 100 || 0.04;

    var targetDSCR = parseFloat((document.getElementById('cf-targetDSCR') || {}).value) || 1.20;

    var totalDev = c.totalDev;
    var loanAmount = Math.round(totalDev * ltv);
    var annualDS = Math.round(loanAmount * debtRate);
    var baseRevenue = c.grossRevenue;
    var baseOpex = c.opex;

    // DSCR constraint: if Year 1 NOI / DS < target, reduce loan to meet target DSCR
    var y1RevEst = Math.round(baseRevenue * (1 + revGrowth));
    var y1VacEst = Math.round(y1RevEst * vacancyRate);
    var y1EgiEst = y1RevEst - y1VacEst;
    var y1OpexEst = Math.round(baseOpex * (1 + expGrowth));
    var y1MgmtEst = Math.round(y1EgiEst * mgmtRate);
    var y1CapexEst = Math.round(y1RevEst * capexRate);
    var y1NoiEst = y1EgiEst - y1OpexEst - y1MgmtEst - y1CapexEst;
    var maxDSFromDSCR = targetDSCR > 0 ? Math.round(y1NoiEst / targetDSCR) : annualDS;
    var maxLoanFromDSCR = debtRate > 0 ? Math.round(maxDSFromDSCR / debtRate) : loanAmount;
    if (loanAmount > maxLoanFromDSCR && maxLoanFromDSCR > 0) {
        loanAmount = maxLoanFromDSCR;
        annualDS = Math.round(loanAmount * debtRate);
    }
    var equity = totalDev - loanAmount;

    var years = [];
    var cumCF = 0;

    for (var yr = 1; yr <= 10; yr++) {
        var gpRevenue = Math.round(baseRevenue * Math.pow(1 + revGrowth, yr));
        var vacancy = Math.round(gpRevenue * vacancyRate);
        var egi = gpRevenue - vacancy;
        var mgmtFee = Math.round(egi * mgmtRate);
        var opex = Math.round(baseOpex * Math.pow(1 + expGrowth, yr));
        var capex = Math.round(gpRevenue * capexRate);
        var totalExpenses = opex + mgmtFee + capex;
        var noi = egi - totalExpenses;
        var cashFlowBDS = noi;
        var cashFlowADS = noi - annualDS;
        cumCF += cashFlowADS;
        var dscr = annualDS > 0 ? noi / annualDS : 999;
        var cocReturn = equity > 0 ? cashFlowADS / equity : 0;
        var exitValue = Math.round(noi / exitCap);
        var netSale = Math.round(exitValue * 0.975 - loanAmount);
        var totalReturn = cumCF + netSale;
        var eqMult = equity > 0 ? totalReturn / equity : 0;
        var annIRR = equity > 0 ? Math.pow(Math.max(totalReturn, 0) / equity, 1 / yr) - 1 : 0;

        years.push({
            year: yr, gpRevenue: gpRevenue, vacancy: vacancy, egi: egi, mgmtFee: mgmtFee,
            opex: opex, capex: capex, totalExpenses: totalExpenses, noi: noi,
            debtService: annualDS, cashFlowBDS: cashFlowBDS, cashFlowADS: cashFlowADS,
            cumCF: cumCF, dscr: dscr, cocReturn: cocReturn,
            exitValue: exitValue, netSale: netSale, totalReturn: totalReturn,
            eqMult: eqMult, irr: annIRR,
        });
    }

    // Summary cards
    var y1 = years[0], y5 = years[4], y10 = years[9];
    var html = '<div class="exec-summary-grid" style="margin-bottom:1rem;">';
    var y1DscrColor = y1.dscr >= 1.20 ? '#276749' : y1.dscr >= 1.0 ? '#b7791f' : '#c53030';
    var y1DscrLabel = y1.dscr >= 1.20 ? '' : y1.dscr >= 1.0 ? ' (Tight)' : ' (No Coverage)';
    html += '<div class="exec-summary-card"><h4>Year 1 NOI</h4><div class="exec-metric-lg">' + fmtM(y1.noi) + '</div><div class="exec-metric-sub">DSCR: <strong style="color:' + y1DscrColor + ';">' + y1.dscr.toFixed(2) + 'x' + y1DscrLabel + '</strong></div></div>';
    html += '<div class="exec-summary-card"><h4>Year 1 Cash-on-Cash</h4><div class="exec-metric-lg" style="color:' + (y1.cocReturn > 0.08 ? '#276749' : '#b7791f') + ';">' + (y1.cocReturn * 100).toFixed(1) + '%</div><div class="exec-metric-sub">' + fmtM(y1.cashFlowADS) + ' after debt</div></div>';
    html += '<div class="exec-summary-card"><h4>Year 5 Exit</h4><div class="exec-metric-lg">' + y5.eqMult.toFixed(2) + 'x</div><div class="exec-metric-sub">' + (y5.irr * 100).toFixed(1) + '% IRR | ' + fmtM(y5.exitValue) + ' value</div></div>';
    html += '<div class="exec-summary-card"><h4>Year 10 Exit</h4><div class="exec-metric-lg">' + y10.eqMult.toFixed(2) + 'x</div><div class="exec-metric-sub">' + (y10.irr * 100).toFixed(1) + '% IRR | ' + fmtM(y10.exitValue) + ' value</div></div>';
    html += '</div>';

    // Capital structure
    var effectiveLTV = totalDev > 0 ? loanAmount / totalDev : 0;
    var dscrConstrained = loanAmount < Math.round(totalDev * ltv);
    html += '<div style="display:flex;gap:1rem;margin-bottom:1rem;font-size:0.75rem;flex-wrap:wrap;">';
    html += '<div style="background:#ebf8ff;border-radius:6px;padding:0.5rem 1rem;"><strong>Equity:</strong> ' + fmtM(equity) + ' (' + Math.round((1 - effectiveLTV) * 100) + '%)</div>';
    html += '<div style="background:#fefcbf;border-radius:6px;padding:0.5rem 1rem;"><strong>Debt:</strong> ' + fmtM(loanAmount) + ' (' + Math.round(effectiveLTV * 100) + '% LTV @ ' + (debtRate * 100).toFixed(1) + '%)' + (dscrConstrained ? ' <span style="color:#b7791f;font-size:0.68rem;">DSCR-constrained</span>' : '') + '</div>';
    html += '<div style="background:#fed7d7;border-radius:6px;padding:0.5rem 1rem;"><strong>Annual Debt Service:</strong> ' + fmtM(annualDS) + '</div>';
    html += '<div style="background:#f0fff4;border-radius:6px;padding:0.5rem 1rem;"><strong>Target DSCR:</strong> ' + targetDSCR.toFixed(2) + 'x</div>';
    html += '</div>';

    // Full cash flow table
    html += '<h4 style="font-size:0.85rem;margin:1rem 0 0.5rem;">Annual Cash Flow Schedule</h4>';
    html += '<div style="overflow-x:auto;"><table style="width:100%;border-collapse:collapse;font-size:0.68rem;white-space:nowrap;">';
    html += '<thead><tr style="background:#edf2f7;">';
    html += '<th style="padding:5px 6px;text-align:center;">Year</th>';
    html += '<th style="padding:5px 6px;text-align:right;">Gross Revenue</th>';
    html += '<th style="padding:5px 6px;text-align:right;">Vacancy</th>';
    html += '<th style="padding:5px 6px;text-align:right;">EGI</th>';
    html += '<th style="padding:5px 6px;text-align:right;">OpEx</th>';
    html += '<th style="padding:5px 6px;text-align:right;">Mgmt</th>';
    html += '<th style="padding:5px 6px;text-align:right;">CapEx Rsv</th>';
    html += '<th style="padding:5px 6px;text-align:right;font-weight:700;">NOI</th>';
    html += '<th style="padding:5px 6px;text-align:right;">Debt Svc</th>';
    html += '<th style="padding:5px 6px;text-align:right;font-weight:700;">Cash Flow</th>';
    html += '<th style="padding:5px 6px;text-align:right;">DSCR</th>';
    html += '<th style="padding:5px 6px;text-align:right;">CoC</th>';
    html += '</tr></thead><tbody>';

    years.forEach(function(y) {
        var bg = y.year % 2 === 0 ? '#f7fafc' : '#fff';
        var dscrColor = y.dscr >= 1.20 ? '#276749' : y.dscr >= 1.0 ? '#b7791f' : '#c53030';
        var dscrBg = y.dscr >= 1.20 ? '' : y.dscr >= 1.0 ? 'background:#fffff0;' : 'background:#fff5f5;';
        html += '<tr style="background:' + bg + ';border-bottom:1px solid #e2e8f0;">';
        html += '<td style="padding:5px 6px;text-align:center;font-weight:600;">' + y.year + '</td>';
        html += '<td style="padding:5px 6px;text-align:right;">' + fmt(y.gpRevenue) + '</td>';
        html += '<td style="padding:5px 6px;text-align:right;color:#c53030;">(' + fmt(y.vacancy) + ')</td>';
        html += '<td style="padding:5px 6px;text-align:right;">' + fmt(y.egi) + '</td>';
        html += '<td style="padding:5px 6px;text-align:right;">(' + fmt(y.opex) + ')</td>';
        html += '<td style="padding:5px 6px;text-align:right;">(' + fmt(y.mgmtFee) + ')</td>';
        html += '<td style="padding:5px 6px;text-align:right;">(' + fmt(y.capex) + ')</td>';
        html += '<td style="padding:5px 6px;text-align:right;font-weight:700;">' + fmt(y.noi) + '</td>';
        html += '<td style="padding:5px 6px;text-align:right;">(' + fmt(y.debtService) + ')</td>';
        html += '<td style="padding:5px 6px;text-align:right;font-weight:700;color:' + (y.cashFlowADS > 0 ? '#276749' : '#c53030') + ';">' + fmt(y.cashFlowADS) + '</td>';
        html += '<td style="padding:5px 6px;text-align:right;color:' + dscrColor + ';font-weight:700;' + dscrBg + '">' + y.dscr.toFixed(2) + 'x</td>';
        html += '<td style="padding:5px 6px;text-align:right;">' + (y.cocReturn * 100).toFixed(1) + '%</td>';
        html += '</tr>';
    });
    html += '</tbody></table></div>';

    // Exit analysis table
    html += '<h4 style="font-size:0.85rem;margin:1.25rem 0 0.5rem;">Exit Scenario Analysis</h4>';
    html += '<div style="overflow-x:auto;"><table style="width:100%;border-collapse:collapse;font-size:0.72rem;">';
    html += '<thead><tr style="background:#edf2f7;"><th style="padding:6px;text-align:center;">Exit Year</th><th style="padding:6px;text-align:right;">Terminal NOI</th><th style="padding:6px;text-align:right;">Exit Value</th><th style="padding:6px;text-align:right;">Cum. Cash Flow</th><th style="padding:6px;text-align:right;">Net Sale Proceeds</th><th style="padding:6px;text-align:right;">Total Return</th><th style="padding:6px;text-align:right;">Equity Multiple</th><th style="padding:6px;text-align:right;">IRR</th></tr></thead><tbody>';

    var bestIRR = years.reduce(function(b, y) { return y.irr > b.irr ? y : b; }, years[0]);
    years.forEach(function(y) {
        var isBest = y.year === bestIRR.year;
        var bg = isBest ? '#f0fff4' : '';
        html += '<tr style="background:' + bg + ';border-bottom:1px solid #e2e8f0;' + (isBest ? 'font-weight:600;' : '') + '">';
        html += '<td style="padding:6px;text-align:center;">' + y.year + (isBest ? ' â˜…' : '') + '</td>';
        html += '<td style="padding:6px;text-align:right;">' + fmtM(y.noi) + '</td>';
        html += '<td style="padding:6px;text-align:right;">' + fmtM(y.exitValue) + '</td>';
        html += '<td style="padding:6px;text-align:right;">' + fmtM(y.cumCF) + '</td>';
        html += '<td style="padding:6px;text-align:right;">' + fmtM(y.netSale) + '</td>';
        html += '<td style="padding:6px;text-align:right;">' + fmtM(y.totalReturn) + '</td>';
        html += '<td style="padding:6px;text-align:right;">' + y.eqMult.toFixed(2) + 'x</td>';
        html += '<td style="padding:6px;text-align:right;color:' + (y.irr > 0.12 ? '#276749' : y.irr > 0.08 ? '#d69e2e' : '#c53030') + ';">' + (y.irr * 100).toFixed(1) + '%</td>';
        html += '</tr>';
    });
    html += '</tbody></table></div>';
    html += '<div style="font-size:0.68rem;color:#718096;margin-top:0.3rem;">â˜… = Optimal exit year by IRR. Exit cap: ' + (exitCap * 100).toFixed(2) + '%. Disposition cost: 2.5%.</div>';

    // NOI growth chart (text-based bar)
    html += '<h4 style="font-size:0.85rem;margin:1.25rem 0 0.5rem;">NOI Growth Trajectory</h4>';
    var maxNOI = years[9].noi;
    html += '<div style="display:flex;flex-direction:column;gap:3px;">';
    years.forEach(function(y) {
        var pct = maxNOI > 0 ? y.noi / maxNOI * 100 : 0;
        html += '<div style="display:flex;align-items:center;gap:0.5rem;">';
        html += '<div style="width:30px;font-size:0.7rem;text-align:right;color:#718096;">Yr ' + y.year + '</div>';
        html += '<div style="flex:1;background:#edf2f7;border-radius:3px;height:18px;overflow:hidden;"><div style="width:' + pct + '%;background:linear-gradient(90deg,#48bb78,#38a169);height:100%;border-radius:3px;display:flex;align-items:center;padding-left:6px;"><span style="font-size:0.65rem;color:#fff;font-weight:600;">' + fmtM(y.noi) + '</span></div></div>';
        html += '</div>';
    });
    html += '</div>';

    html += '<div style="font-size:0.72rem;color:#718096;margin-top:1.25rem;">Source: Proprietary cash flow model | Assumptions: ' + (revGrowth * 100).toFixed(1) + '% revenue growth, ' + (expGrowth * 100).toFixed(1) + '% expense growth, ' + (vacancyRate * 100).toFixed(0) + '% vacancy, ' + (mgmtRate * 100).toFixed(0) + '% mgmt fee, ' + (capexRate * 100).toFixed(0) + '% CapEx reserve</div>';
    return html;
}

function recalcCashFlow() {
    _debouncedCall('cashFlow', function() {
        var st = deepAnalysisState;
        if (!st) return;
        var container = document.getElementById('cfTableContainer');
        if (!container) return;
        container.innerHTML = buildCashFlowTable(st.computed);
    }, 180);
}

// ============================================================
//  SKILL 39: CUSTOM KPI DASHBOARD
// ============================================================

function renderKPIDashboard(st) {
    const { bestUse, inp, computed, effects } = st;
    const tl = TIMELINE_MONTHS[bestUse] || { entitlement: 6, design: 4, permits: 3, construction: 18, leaseup: 6 };
    const totalMo = tl.entitlement + tl.design + tl.permits + tl.construction + tl.leaseup;
    const irr = approxIRR(computed.devMargin, totalMo);
    const legalScore = scoreLegal(bestUse, inp, effects);
    const physScore = scorePhysical(bestUse, inp);
    const ease = computeEaseOfExecution(bestUse, inp, effects, legalScore * 100);
    const risk = computeRiskLevel(bestUse, inp, legalScore, physScore);

    // --- Properly sized loan based on standard lending parameters ---
    // Read from editable inputs if they exist (after first render), otherwise use defaults
    var kpiLTV = parseFloat((document.getElementById('kpi-ltv') || {}).value) / 100 || 0.75;
    var kpiRate = parseFloat((document.getElementById('kpi-rate') || {}).value) / 100 || 0.065;
    var kpiAmort = parseInt((document.getElementById('kpi-amort') || {}).value) || 30;
    var kpiMinDSCR = parseFloat((document.getElementById('kpi-minDscr') || {}).value) || 1.20;

    // Loan sizing: lesser of LTV constraint and DSCR constraint
    var ltvLoan = Math.round(computed.stabilizedValue * kpiLTV);
    // DSCR-constrained loan: solve for max loan where NOI / annual DS >= minDSCR
    // Monthly payment = P * [r(1+r)^n] / [(1+r)^n - 1] where r = monthly rate, n = months
    var monthlyRate = kpiRate / 12;
    var numPayments = kpiAmort * 12;
    var annuityFactor = monthlyRate > 0 ? (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / (Math.pow(1 + monthlyRate, numPayments) - 1) : 1 / numPayments;
    var maxAnnualDS = computed.noi / kpiMinDSCR;
    var maxMonthlyDS = maxAnnualDS / 12;
    var dscrLoan = monthlyRate > 0 ? Math.round(maxMonthlyDS / annuityFactor) : Math.round(maxAnnualDS * kpiAmort);

    // Binding constraint: take the lesser loan
    var loanAmount = Math.min(ltvLoan, dscrLoan);
    var bindingConstraint = loanAmount === dscrLoan ? 'DSCR' : 'LTV';
    var actualLTV = computed.stabilizedValue > 0 ? loanAmount / computed.stabilizedValue : 0;
    var annualDS = Math.round(loanAmount * annuityFactor * 12);
    var dscr = annualDS > 0 ? computed.noi / annualDS : 99;
    var equityRequired = computed.totalDev - loanAmount;
    var loanToDevCost = computed.totalDev > 0 ? loanAmount / computed.totalDev : 0;
    var debtYield = loanAmount > 0 ? computed.noi / loanAmount : 0;

    const kpis = [
        { id: 'margin', label: 'Dev Margin', value: (computed.devMargin * 100).toFixed(1) + '%', raw: computed.devMargin, green: 0.15, yellow: 0.08, views: ['developer', 'equity'] },
        { id: 'irr', label: 'Est. IRR', value: (irr * 100).toFixed(1) + '%', raw: irr, green: 0.10, yellow: 0.06, views: ['developer', 'equity'] },
        { id: 'yoc', label: 'Yield on Cost', value: (computed.yieldOnCost * 100).toFixed(1) + '%', raw: computed.yieldOnCost, green: 0.06, yellow: 0.045, views: ['developer', 'lender'] },
        { id: 'noi', label: 'Annual NOI', value: formatCompactDollars(computed.noi), raw: computed.noi, green: 500000, yellow: 200000, views: ['lender'] },
        { id: 'totalcost', label: 'Total Dev Cost', value: formatCompactDollars(computed.totalDev), raw: -computed.totalDev, green: -5000000, yellow: -20000000, views: ['developer'] },
        { id: 'costunit', label: 'Cost / Unit', value: computed.units ? '$' + Math.round(computed.totalDev / computed.units).toLocaleString() : 'N/A', raw: computed.units ? -(computed.totalDev / computed.units) : 0, green: -350000, yellow: -500000, views: ['developer', 'lender'] },
        { id: 'costsf', label: 'Cost / SF', value: '$' + Math.round(computed.totalDev / Math.max(computed.gsf, 1)).toLocaleString(), raw: -(computed.totalDev / Math.max(computed.gsf, 1)), green: -400, yellow: -600, views: ['developer'] },
        { id: 'revsf', label: 'Revenue / SF / yr', value: '$' + computed.revenuePSF.toFixed(1), raw: computed.revenuePSF, green: 40, yellow: 25, views: ['equity'] },
        { id: 'far', label: 'Floor Area Ratio', value: computed.far.toFixed(2), raw: computed.far, green: 2.0, yellow: 1.0, views: [] },
        { id: 'units', label: 'Total Units', value: computed.units ? computed.units.toLocaleString() : 'N/A', raw: computed.units || 0, green: 50, yellow: 10, views: ['developer'] },
        { id: 'timeline', label: 'Timeline', value: totalMo + ' months', raw: -totalMo, green: -24, yellow: -36, views: ['equity'] },
        { id: 'ease', label: 'Ease Score', value: ease + '/100', raw: ease, green: 60, yellow: 35, views: [] },
        { id: 'dscr', label: 'DSCR', value: dscr.toFixed(2) + 'x', raw: dscr, green: 1.25, yellow: 1.10, views: ['lender'] },
        { id: 'ltv', label: 'LTV Ratio', value: (actualLTV * 100).toFixed(0) + '%', raw: -actualLTV, green: -0.65, yellow: -0.75, views: ['lender'] },
        { id: 'debtyield', label: 'Debt Yield', value: (debtYield * 100).toFixed(1) + '%', raw: debtYield, green: 0.08, yellow: 0.06, views: ['lender'] },
    ];

    let html = `<div class="deep-tab-panel">`;

    // --- Editable Loan Sizing Assumptions ---
    html += `<div class="analysis-section">
        <h3>Loan Sizing Assumptions (editable)</h3>
        <p style="font-size:0.78rem;color:var(--text-light);margin-bottom:0.75rem;">Permanent loan sized to the <strong>lesser</strong> of the LTV constraint and DSCR constraint. Adjust parameters to see how lending metrics change.</p>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:0.75rem;margin-bottom:1rem;">
            <div>
                <label style="font-size:0.7rem;color:#718096;display:block;">Max LTV</label>
                <input type="number" id="kpi-ltv" value="${Math.round(kpiLTV * 100)}" step="5" min="40" max="85" style="width:100%;padding:4px 8px;border:1px solid #cbd5e0;border-radius:4px;font-size:0.78rem;" oninput="recalcKPIDashboard()">
                <span style="font-size:0.65rem;color:#a0aec0;">%</span>
            </div>
            <div>
                <label style="font-size:0.7rem;color:#718096;display:block;">Interest Rate</label>
                <input type="number" id="kpi-rate" value="${(kpiRate * 100).toFixed(1)}" step="0.25" min="2" max="15" style="width:100%;padding:4px 8px;border:1px solid #cbd5e0;border-radius:4px;font-size:0.78rem;" oninput="recalcKPIDashboard()">
                <span style="font-size:0.65rem;color:#a0aec0;">%</span>
            </div>
            <div>
                <label style="font-size:0.7rem;color:#718096;display:block;">Amortization</label>
                <input type="number" id="kpi-amort" value="${kpiAmort}" step="5" min="10" max="40" style="width:100%;padding:4px 8px;border:1px solid #cbd5e0;border-radius:4px;font-size:0.78rem;" oninput="recalcKPIDashboard()">
                <span style="font-size:0.65rem;color:#a0aec0;">years</span>
            </div>
            <div>
                <label style="font-size:0.7rem;color:#718096;display:block;">Min DSCR</label>
                <input type="number" id="kpi-minDscr" value="${kpiMinDSCR.toFixed(2)}" step="0.05" min="1.0" max="2.0" style="width:100%;padding:4px 8px;border:1px solid #cbd5e0;border-radius:4px;font-size:0.78rem;" oninput="recalcKPIDashboard()">
                <span style="font-size:0.65rem;color:#a0aec0;">x</span>
            </div>
        </div>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:0.75rem;">
            <div style="background:#f0fff4;border:1px solid #c6f6d5;border-radius:8px;padding:0.6rem 0.8rem;">
                <div style="font-size:0.68rem;color:#718096;">Loan Amount</div>
                <div style="font-size:1.1rem;font-weight:700;color:#276749;">${formatCompactDollars(loanAmount)}</div>
                <div style="font-size:0.65rem;color:#38a169;">Constrained by ${bindingConstraint}</div>
            </div>
            <div style="background:#ebf8ff;border:1px solid #bee3f8;border-radius:8px;padding:0.6rem 0.8rem;">
                <div style="font-size:0.68rem;color:#718096;">Annual Debt Service</div>
                <div style="font-size:1.1rem;font-weight:700;color:#2b6cb0;">${formatCompactDollars(annualDS)}</div>
                <div style="font-size:0.65rem;color:#4299e1;">${formatCompactDollars(Math.round(annualDS / 12))}/mo</div>
            </div>
            <div style="background:#fefcbf;border:1px solid #f6e05e;border-radius:8px;padding:0.6rem 0.8rem;">
                <div style="font-size:0.68rem;color:#718096;">Equity Required</div>
                <div style="font-size:1.1rem;font-weight:700;color:#b7791f;">${formatCompactDollars(equityRequired)}</div>
                <div style="font-size:0.65rem;color:#d69e2e;">${Math.round((1 - loanToDevCost) * 100)}% of total dev cost</div>
            </div>
            <div style="background:#f7fafc;border:1px solid #e2e8f0;border-radius:8px;padding:0.6rem 0.8rem;">
                <div style="font-size:0.68rem;color:#718096;">Actual LTV / DSCR</div>
                <div style="font-size:1.1rem;font-weight:700;color:#4a5568;">${(actualLTV * 100).toFixed(0)}% / ${dscr.toFixed(2)}x</div>
                <div style="font-size:0.65rem;color:#718096;">Debt Yield: ${(debtYield * 100).toFixed(1)}%</div>
            </div>
        </div>
    </div>`;

    html += `<div class="analysis-section"><h3>Key Performance Indicators</h3>
        <p style="font-size:0.85rem;color:var(--text-light);margin-bottom:1rem;">Select a view preset to highlight relevant KPIs, or review all metrics at a glance.</p>
        <div class="preset-btns">
            <button class="preset-btn active" onclick="filterKPIs('all')">All KPIs</button>
            <button class="preset-btn" onclick="filterKPIs('developer')">Developer View</button>
            <button class="preset-btn" onclick="filterKPIs('lender')">Lender View</button>
            <button class="preset-btn" onclick="filterKPIs('equity')">Equity View</button>
        </div>
        <div class="kpi-grid" id="kpiGrid">`;

    for (const kpi of kpis) {
        const colorClass = kpi.raw >= kpi.green ? 'green' : kpi.raw >= kpi.yellow ? 'yellow' : 'red';
        html += `<div class="kpi-card ${colorClass}" data-views="${kpi.views.join(',')}">
            <div class="kpi-val">${kpi.value}</div>
            <div class="kpi-label">${kpi.label}</div>
        </div>`;
    }

    html += `</div></div>`;

    // Summary narrative
    const positives = kpis.filter(k => k.raw >= k.green);
    const cautions = kpis.filter(k => k.raw >= k.yellow && k.raw < k.green);
    const concerns = kpis.filter(k => k.raw < k.yellow);

    html += `<div class="analysis-section"><h3>KPI Summary</h3>
        <div style="font-size:0.85rem;line-height:1.7;">`;

    if (positives.length > 0) {
        html += `<div style="margin-bottom:0.75rem;"><strong style="color:#276749;">Strengths (${positives.length}):</strong> ${positives.map(k => k.label).join(', ')} â€” all in healthy range.</div>`;
    }
    if (cautions.length > 0) {
        html += `<div style="margin-bottom:0.75rem;"><strong style="color:#b7791f;">Caution (${cautions.length}):</strong> ${cautions.map(k => k.label).join(', ')} â€” acceptable but monitor closely.</div>`;
    }
    if (concerns.length > 0) {
        html += `<div style="margin-bottom:0.75rem;"><strong style="color:#c53030;">Concerns (${concerns.length}):</strong> ${concerns.map(k => k.label).join(', ')} â€” below target thresholds.</div>`;
    }

    // Overall assessment
    const overallScore = Math.round((positives.length / kpis.length) * 100);
    html += `<div style="background:#f8fafc;border:1px solid var(--border);border-radius:8px;padding:1rem;margin-top:0.75rem;">
        <strong>Overall Health:</strong> <span style="color:${overallScore >= 60 ? '#276749' : overallScore >= 35 ? '#b7791f' : '#c53030'};font-weight:700;">${overallScore}% of KPIs in green</span> â€”
        ${overallScore >= 70 ? 'Strong feasibility profile. Project metrics support proceeding with confidence.' :
          overallScore >= 45 ? 'Moderate feasibility. Key metrics are acceptable but some areas need attention before committing capital.' :
          'Weak feasibility profile. Multiple metrics below target â€” consider alternative development programs or sites.'}
    </div>`;

    html += `</div></div>`;
    html += `</div>`;
    return html;
}

function recalcKPIDashboard() {
    var st = deepAnalysisState;
    if (!st || !st.computed) return;
    // Find the KPI panel by its unique content rather than hardcoded index
    var kpiPanel = document.querySelector('#kpiGrid')?.closest('.deep-tab-panel');
    if (kpiPanel) {
        var tempDiv = document.createElement('div');
        tempDiv.innerHTML = renderKPIDashboard(st);
        var newContent = tempDiv.querySelector('.deep-tab-panel');
        if (newContent) kpiPanel.innerHTML = newContent.innerHTML;
    }
}

function filterKPIs(view) {
    document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
    document.querySelectorAll('.kpi-card').forEach(card => {
        const views = card.dataset.views || '';
        if (view === 'all') {
            card.classList.remove('highlight');
            card.style.opacity = '1';
        } else if (views.includes(view)) {
            card.classList.add('highlight');
            card.style.opacity = '1';
        } else {
            card.classList.remove('highlight');
            card.style.opacity = '0.4';
        }
    });
}


// ============================================================
//  SKILL 40: ENHANCED EXPORT & REPORTING
// ============================================================

function renderExportTab(st) {
    const { prop, bestUse, computed } = st;
    const use = LAND_USES.find(u => u.id === bestUse);

    let html = `<div class="deep-tab-panel">`;
    html += `<div class="analysis-section"><h3>Export & Reporting</h3>
        <p style="font-size:0.85rem;color:var(--text-light);margin-bottom:1.25rem;">Generate professional reports and data exports for this feasibility analysis.</p>
        <div class="export-grid">
            <div class="export-card" onclick="generateFullPDFReport()">
                <div class="export-icon">ðŸ“„</div>
                <h4>Full PDF Report</h4>
                <p>Multi-page report with cover page, all analysis tabs, and executive summary.</p>
            </div>
            <div class="export-card" onclick="printDeepAnalysis()">
                <div class="export-icon">ðŸ–¨ï¸</div>
                <h4>Print All Tabs</h4>
                <p>Print-optimized layout showing all analysis panels in sequence.</p>
            </div>
            <div class="export-card" onclick="exportCSVData()">
                <div class="export-icon">ðŸ“Š</div>
                <h4>CSV Data Export</h4>
                <p>Download all financial metrics, unit mix, and timeline data as CSV.</p>
            </div>
            <div class="export-card" onclick="exportExecutiveSummary()">
                <div class="export-icon">ðŸ“‹</div>
                <h4>Executive One-Pager</h4>
                <p>Condensed summary with key metrics, suitable for investment committees.</p>
            </div>
        </div>
    </div>`;

    // Report preview
    html += `<div class="analysis-section"><h3>Report Preview</h3>
        <div style="background:#f8fafc;border:1px solid var(--border);border-radius:8px;padding:1.25rem;font-size:0.85rem;">
            <div style="text-align:center;margin-bottom:1.5rem;">
                <div style="font-size:0.72rem;color:var(--text-light);text-transform:uppercase;letter-spacing:2px;">CLS CRE Brokerage</div>
                <div style="font-size:1.3rem;font-weight:700;color:var(--primary);margin:0.5rem 0;">Feasibility Analysis Report</div>
                <div style="font-size:0.92rem;font-weight:600;">${prop.address || 'Property Address'}</div>
                <div style="font-size:0.82rem;color:var(--text-light);">APN: ${prop.apn || 'N/A'} | ${(prop.lotSizeSqFt || 0).toLocaleString()} SF Parcel</div>
                <div style="font-size:0.78rem;color:var(--text-light);margin-top:0.5rem;">Prepared: ${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</div>
            </div>
            <hr style="border:none;border-top:1px solid var(--border);margin:1rem 0;">
            <div style="font-weight:600;color:var(--primary);margin-bottom:0.5rem;">Table of Contents</div>
            <ol style="padding-left:1.25rem;line-height:2;">
                <li>Executive Summary & Recommended Use</li>
                <li>Entitlement Pathway Analysis</li>
                <li>Pro Forma & Sensitivity Scenarios</li>
                <li>Market Comparable Analysis</li>
                <li>Construction Type & Code Compliance</li>
                <li>Affordable Housing Compliance</li>
                <li>Tax & Incentive Analysis</li>
                <li>Community & Political Risk</li>
                <li>Unit Mix Optimization</li>
                <li>Infrastructure & Utilities</li>
                <li>Site Plan & 3D Massing</li>
                <li>Earthwork Analysis</li>
                <li>Environmental Constraints</li>
                <li>Parking Design</li>
                <li>Generative Design Scenarios</li>
                <li>KPI Dashboard</li>
            </ol>
            <hr style="border:none;border-top:1px solid var(--border);margin:1rem 0;">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
                <div><strong>Recommended Use:</strong> ${use ? use.icon + ' ' + use.name : bestUse}</div>
                <div><strong>Dev Margin:</strong> ${(computed.devMargin * 100).toFixed(1)}%</div>
                <div><strong>Total Cost:</strong> ${formatCompactDollars(computed.totalDev)}</div>
                <div><strong>Stabilized Value:</strong> ${formatCompactDollars(computed.stabilizedValue)}</div>
            </div>
        </div>
    </div>`;

    html += `</div>`;
    return html;
}

function generateFullPDFReport() {
    // Show all tabs for printing
    const panels = document.querySelectorAll('#deepTabPanels .deep-tab-panel');
    panels.forEach(p => {
        p.style.display = 'block';
        p.style.pageBreakBefore = 'always';
    });
    if (panels[0]) panels[0].style.pageBreakBefore = 'avoid';
    window.print();
    // Restore tab visibility
    setTimeout(() => {
        const btns = document.querySelectorAll('#deepTabs .deep-tab-btn');
        let activeIdx = 0;
        btns.forEach((b, i) => { if (b.classList.contains('active')) activeIdx = i; });
        panels.forEach((p, i) => p.style.display = i === activeIdx ? 'block' : 'none');
        panels.forEach(p => p.style.pageBreakBefore = '');
    }, 1000);
}

function exportCSVData() {
    const st = deepAnalysisState;
    if (!st) return;
    const { prop, bestUse, computed, inp } = st;
    const use = LAND_USES.find(u => u.id === bestUse);
    const tl = TIMELINE_MONTHS[bestUse] || { entitlement: 6, design: 4, permits: 3, construction: 18, leaseup: 6 };
    const totalMo = tl.entitlement + tl.design + tl.permits + tl.construction + tl.leaseup;
    const irr = approxIRR(computed.devMargin, totalMo);

    const rows = [
        ['Property Address', prop.address || 'N/A'],
        ['APN', prop.apn || 'N/A'],
        ['Parcel Size (SF)', inp.parcelSize],
        ['Zoning', inp.zoning],
        ['Neighborhood', inp.neighborhood],
        ['Recommended Use', use ? use.name : bestUse],
        [''],
        ['DEVELOPMENT PROGRAM'],
        ['Gross SF', computed.gsf],
        ['Net Leasable SF', computed.nsf],
        ['Stories', computed.stories],
        ['Building Height (ft)', computed.buildingHeight],
        ['Units', computed.units || 'N/A'],
        ['Parking Spaces', computed.parkingSpaces],
        ['FAR', computed.far.toFixed(2)],
        [''],
        ['FINANCIAL METRICS'],
        ['Land Cost', computed.landCost],
        ['Total Hard Costs', computed.totalHard],
        ['Total Soft Costs', computed.totalSoft],
        ['Total Development Cost', computed.totalDev],
        ['Gross Revenue (annual)', computed.grossRevenue],
        ['Operating Expenses', computed.opex],
        ['Net Operating Income', computed.noi],
        ['Cap Rate', (computed.capRate * 100).toFixed(1) + '%'],
        ['Stabilized Value', computed.stabilizedValue],
        ['Development Margin', (computed.devMargin * 100).toFixed(1) + '%'],
        ['Yield on Cost', (computed.yieldOnCost * 100).toFixed(1) + '%'],
        ['Estimated IRR', (irr * 100).toFixed(1) + '%'],
        ['Build Cost/SF', computed.buildCostPSF],
        ['Revenue/SF/yr', computed.revenuePSF.toFixed(1)],
        ['Cost per Unit', computed.units ? Math.round(computed.totalDev / computed.units) : 'N/A'],
        [''],
        ['TIMELINE (months)'],
        ['Entitlement', tl.entitlement],
        ['Design', tl.design],
        ['Permits', tl.permits],
        ['Construction', tl.construction],
        ['Lease-Up', tl.leaseup],
        ['Total', totalMo],
    ];

    const csv = rows.map(r => r.map(c => '"' + String(c).replace(/"/g, '""') + '"').join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `HBU_Analysis_${(prop.address || 'property').replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function exportExecutiveSummary() {
    // Print just the first tab (executive summary)
    const panels = document.querySelectorAll('#deepTabPanels .deep-tab-panel');
    panels.forEach((p, i) => p.style.display = i === 0 ? 'block' : 'none');
    window.print();
    // Restore
    setTimeout(() => {
        const btns = document.querySelectorAll('#deepTabs .deep-tab-btn');
        let activeIdx = 0;
        btns.forEach((b, i) => { if (b.classList.contains('active')) activeIdx = i; });
        panels.forEach((p, i) => p.style.display = i === activeIdx ? 'block' : 'none');
    }, 1000);
}


// ============================================================
//  PUBLIC FINANCE TAB (EIFD / CRIA / CRD)
// ============================================================

const EIFD_PARAMS = {
    propertyTaxRate: 0.01,       // 1% Prop 13 base levy
    cityShare: 0.16,             // ~16% of 1% goes to city general fund
    countyShare: 0.26,           // ~26% to county
    schoolShare: 0.45,           // ~45% to schools (NOT capturable by EIFD)
    specialDistShare: 0.13,      // ~13% to special districts
    eifCaptureRate: 0.75,        // typical EIFD captures ~75% of participating entities' increment
    criaAffordableMin: 0.25,     // CRIAs must allocate 25% to affordable housing
    bondCoverage: 1.25,          // debt service coverage ratio for bond sizing
    bondTerm: 30,                // years
    bondRate: 0.045,             // ~4.5% tax-exempt rate
    formationCost: 250000,       // typical EIFD formation cost
    annualAdmin: 50000,          // annual administration
    sources: {
        sb628: { label: 'SB 628 â€” EIFD Enabling Statute', url: 'https://leginfo.legislature.ca.gov/faces/billNavClient.xhtml?bill_id=201320140SB628' },
        sb852: { label: 'SB 852 â€” Climate Resilience Districts', url: 'https://leginfo.legislature.ca.gov/faces/billNavClient.xhtml?bill_id=202120220SB852' },
        ab2: { label: 'AB 2 â€” Community Revitalization (CRIA)', url: 'https://leginfo.legislature.ca.gov/faces/billNavClient.xhtml?bill_id=201520160AB2' },
        scag: { label: 'SCAG EIFD/CRIA Screening Tool', url: 'https://scag.ca.gov/post/eifd-cria-screening-tool' },
    },
};

// ============================================================
//  TAB 25: DEVELOPMENT TIMELINE â€” FULL PROCESS WITH EDITABLE PHASES
// ============================================================

function getDefaultDevTimeline(st) {
    var c = st.computed || {};
    var inp = st.inp || {};
    var bestUse = st.bestUse || 'multifamily_mid';
    var legislation = st.legislation || [];
    var hasLegalOverride = legislation.some(function(b) { return b.legalOverride; });
    var isAffordable = ['senior'].includes(bestUse);
    var nearTransit = inp.transit === 'adjacent' || inp.transit === 'near';

    // Total GBA for construction duration scaling
    var gba = c.gba || 50000;
    var stories = c.stories || 4;
    var units = c.totalUnits || 50;

    // Phase durations (months) â€” realistic LA County estimates
    var phases = [
        { id: 'predevelopment', name: 'Pre-Development / Due Diligence', months: 3, color: '#718096',
          description: 'Site acquisition, title/survey, Phase I ESA, geotech, feasibility study, architect/engineer selection.',
          milestones: ['LOI / PSA executed', 'Phase I ESA complete', 'Geotech report', 'Architect engaged', 'Feasibility study'] },
        { id: 'entitlement', name: 'Entitlement & Land Use Approvals', months: hasLegalOverride ? 4 : 12, color: '#805ad5',
          description: hasLegalOverride
            ? 'By-right/ministerial approval pathway under applicable legislation. Reduced timeline due to legislative override of discretionary review.'
            : 'Discretionary approvals: zone change, CUP, site plan review, CEQA compliance. Community hearings and council approvals.',
          milestones: hasLegalOverride
            ? ['File ministerial application', 'Staff review complete', 'Approvals issued']
            : ['CEQA determination', 'Planning application filed', 'Community hearing(s)', 'Planning Commission hearing', 'City Council approval', 'Entitlements recorded'] },
        { id: 'design', name: 'Design Development & CDs', months: stories > 7 ? 8 : 6, color: '#3182ce',
          description: 'Schematic design, design development, construction documents, structural/MEP engineering, landscape design.',
          milestones: ['Schematic design (SD) complete', 'Design development (DD) complete', 'Construction documents (CDs) 50%', 'CDs 100% complete', 'Value engineering review'] },
        { id: 'financing', name: 'Financing & Closing', months: isAffordable ? 6 : 3, color: '#d69e2e',
          description: isAffordable
            ? 'LIHTC application, tax credit allocation, construction loan underwriting, equity syndication, closing.'
            : 'Construction loan application, appraisal, underwriting, equity raise, loan closing.',
          milestones: isAffordable
            ? ['LIHTC application submitted', 'Tax credit reservation', 'Construction lender selected', 'Equity syndication', 'Financial closing']
            : ['Construction lender selected', 'Appraisal complete', 'Loan commitment', 'Equity committed', 'Financial closing'] },
        { id: 'permits', name: 'Building Permits & Plan Check', months: stories > 7 ? 6 : 4, color: '#38a169',
          description: 'Plan check submittal, corrections, fire/life safety review, LADBS grading/building/mechanical/electrical/plumbing permits.',
          milestones: ['Plan check submitted', 'First corrections received', 'Corrections resubmitted', 'All permits issued', 'Contractor mobilization'] },
        { id: 'sitework', name: 'Site Work & Foundations', months: stories > 7 ? 4 : 3, color: '#ed8936',
          description: 'Demolition (if applicable), grading, shoring/export, utilities rough-in, foundation pour, waterproofing.',
          milestones: ['Demolition complete', 'Grading & shoring', 'Foundation pour', 'Waterproofing', 'Utility connections roughed'] },
        { id: 'vertical', name: 'Vertical Construction', months: Math.max(8, Math.round(stories * 2.5)), color: '#dd6b20',
          description: 'Structural framing (wood/steel/concrete), exterior envelope, MEP rough-in, elevators, fire suppression.',
          milestones: ['Podium/garage complete', 'Framing 50%', 'Framing 100% / topped out', 'Roof complete', 'MEP rough-in complete', 'Exterior envelope sealed'] },
        { id: 'finishes', name: 'Interior Finishes & MEP Trim', months: Math.max(4, Math.round(stories * 1.2)), color: '#e53e3e',
          description: 'Drywall, paint, flooring, cabinetry, fixtures, MEP trim, elevator finish, common area buildout.',
          milestones: ['Drywall complete', 'Paint & flooring', 'Cabinets & counters installed', 'Fixtures & appliances', 'Common areas complete'] },
        { id: 'landscaping', name: 'Landscaping & Hardscape', months: 2, color: '#48bb78',
          description: 'Landscape installation, hardscape, amenity areas, pool/spa (if applicable), irrigation.',
          milestones: ['Hardscape complete', 'Planting & irrigation', 'Amenities operational'] },
        { id: 'inspections', name: 'Final Inspections & TCO', months: 2, color: '#667eea',
          description: 'Fire Dept. sign-off, LADBS final inspections, utility connections energized, Temporary Certificate of Occupancy.',
          milestones: ['Fire Dept. inspection', 'LADBS final inspection', 'Utilities energized', 'TCO issued'] },
        { id: 'leaseup', name: 'Lease-Up / Absorption', months: nearTransit ? Math.max(4, Math.round(units / 15)) : Math.max(6, Math.round(units / 10)), color: '#f56565',
          description: 'Marketing launch (typically 3-6 months pre-completion), unit showings, lease execution, move-ins. Stabilization at 93%+ occupancy.',
          milestones: ['Marketing/pre-leasing launch', 'First move-ins', '50% leased', '75% leased', 'Stabilization (93%+ occupied)'] },
        { id: 'stabilization', name: 'Stabilization & Perm Financing', months: 3, color: '#9f7aea',
          description: 'Achieve stabilized NOI, construction loan payoff, permanent financing conversion or takeout.',
          milestones: ['Stabilized NOI achieved', 'Perm loan application', 'Perm loan closing / construction loan payoff'] },
    ];
    return phases;
}

function renderDevTimelineTab(st) {
    var phases = getDefaultDevTimeline(st);
    var totalMonths = phases.reduce(function(s, p) { return s + p.months; }, 0);

    var html = '<div class="deep-tab-panel">';
    html += '<div class="analysis-section"><h3>Development Timeline â€” Start to Stabilization</h3>';
    html += '<p style="font-size:0.78rem;color:#718096;margin-bottom:1rem;">Comprehensive phase-by-phase timeline covering the entire development process. Auto-generated based on project characteristics â€” edit any phase duration to override with your own estimate.</p>';

    // Summary bar
    html += '<div style="background:#f7fafc;border:1px solid #e2e8f0;border-radius:8px;padding:1rem;margin-bottom:1.25rem;">';
    html += '<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:0.5rem;">';
    html += '<div><span style="font-size:1.4rem;font-weight:700;color:var(--primary);" id="dtTotalMonths">' + totalMonths + '</span><span style="font-size:0.8rem;color:#718096;"> months total</span>';
    html += '&nbsp;&nbsp;<span style="font-size:1rem;font-weight:600;color:#4a5568;" id="dtTotalYears">(' + (totalMonths / 12).toFixed(1) + ' years)</span></div>';
    html += '<button type="button" onclick="resetDevTimeline()" style="padding:4px 12px;font-size:0.72rem;border:1px solid #cbd5e0;border-radius:4px;background:#fff;cursor:pointer;">Reset to Defaults</button>';
    html += '</div>';

    // Gantt-style bar
    html += '<div style="margin-top:0.75rem;display:flex;height:32px;border-radius:6px;overflow:hidden;" id="dtGanttBar">';
    for (var i = 0; i < phases.length; i++) {
        var p = phases[i];
        var pct = (p.months / totalMonths * 100).toFixed(1);
        html += '<div style="flex:' + p.months + ';background:' + p.color + ';display:flex;align-items:center;justify-content:center;font-size:0.55rem;color:#fff;font-weight:600;white-space:nowrap;overflow:hidden;min-width:0;" title="' + p.name + ': ' + p.months + ' months">';
        html += p.months >= 3 ? p.months + 'mo' : '';
        html += '</div>';
    }
    html += '</div>';

    // Legend
    html += '<div style="margin-top:0.4rem;display:flex;flex-wrap:wrap;gap:0.4rem;">';
    for (var i = 0; i < phases.length; i++) {
        html += '<span style="font-size:0.6rem;color:#4a5568;"><span style="display:inline-block;width:8px;height:8px;border-radius:2px;background:' + phases[i].color + ';margin-right:2px;"></span>' + phases[i].name.split(' /')[0].split(' &')[0] + '</span>';
    }
    html += '</div></div>';

    // Phase detail cards with editable durations
    html += '<div id="dtPhaseCards">';
    var cumulativeStart = 0;
    for (var i = 0; i < phases.length; i++) {
        var p = phases[i];
        var startMonth = cumulativeStart;
        var endMonth = cumulativeStart + p.months;
        cumulativeStart = endMonth;

        html += '<div style="border:1px solid #e2e8f0;border-left:4px solid ' + p.color + ';border-radius:6px;padding:0.75rem 1rem;margin-bottom:0.75rem;">';
        html += '<div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:0.5rem;">';
        html += '<div style="flex:1;min-width:200px;">';
        html += '<div style="font-weight:700;font-size:0.85rem;color:#2d3748;"><span style="display:inline-block;width:22px;height:22px;border-radius:50%;background:' + p.color + ';color:#fff;text-align:center;line-height:22px;font-size:0.65rem;margin-right:6px;">' + (i + 1) + '</span>' + p.name + '</div>';
        html += '<div style="font-size:0.72rem;color:#718096;margin:0.3rem 0;">' + p.description + '</div>';
        html += '</div>';
        html += '<div style="text-align:right;min-width:160px;">';
        html += '<div style="font-size:0.68rem;color:#a0aec0;">Month ' + startMonth + 'â€“' + endMonth + '</div>';
        html += '<div style="display:flex;align-items:center;gap:6px;justify-content:flex-end;margin-top:4px;">';
        html += '<label style="font-size:0.7rem;color:#718096;">Duration:</label>';
        html += '<input type="number" id="dt-' + p.id + '" value="' + p.months + '" min="0" max="60" step="1" style="width:55px;padding:3px 6px;border:1px solid #cbd5e0;border-radius:4px;font-size:0.8rem;font-weight:600;text-align:center;" oninput="recalcDevTimeline()">';
        html += '<span style="font-size:0.7rem;color:#718096;">months</span>';
        html += '</div></div></div>';

        // Milestones
        if (p.milestones && p.milestones.length > 0) {
            html += '<div style="margin-top:0.4rem;padding-top:0.4rem;border-top:1px solid #edf2f7;">';
            html += '<div style="font-size:0.68rem;font-weight:600;color:#4a5568;margin-bottom:3px;">Key Milestones:</div>';
            html += '<div style="display:flex;flex-wrap:wrap;gap:4px;">';
            for (var m = 0; m < p.milestones.length; m++) {
                html += '<span style="font-size:0.65rem;padding:2px 8px;background:#edf2f7;border-radius:10px;color:#4a5568;">' + p.milestones[m] + '</span>';
            }
            html += '</div></div>';
        }
        html += '</div>';
    }
    html += '</div>';

    // Critical path note
    html += '<div style="background:#fffaf0;border:1px solid #fbd38d;border-radius:8px;padding:0.75rem 1rem;margin-top:0.5rem;">';
    html += '<div style="font-weight:600;font-size:0.8rem;color:#c05621;margin-bottom:0.3rem;">Critical Path Considerations</div>';
    html += '<ul style="font-size:0.72rem;color:#744210;margin:0;padding-left:1.2rem;">';
    html += '<li><strong>Entitlements</strong> are the highest-risk phase â€” community opposition and CEQA can add 6-18+ months.</li>';
    html += '<li><strong>Design & Permits</strong> can overlap by 2-3 months (phased plan check / early grading permits).</li>';
    html += '<li><strong>Pre-leasing</strong> typically starts 3-6 months before construction completion.</li>';
    html += '<li><strong>Weather delays</strong> in LA are minimal but fire season smoke/heat days can slow exterior work.</li>';
    html += '<li><strong>LADBS plan check</strong> currently running 8-16 weeks for initial review; budget for 2-3 correction cycles.</li>';
    html += '</ul></div>';

    html += '</div></div>';
    return html;
}

function recalcDevTimeline() {
    var phaseIds = ['predevelopment', 'entitlement', 'design', 'financing', 'permits', 'sitework', 'vertical', 'finishes', 'landscaping', 'inspections', 'leaseup', 'stabilization'];
    var total = 0;
    for (var i = 0; i < phaseIds.length; i++) {
        var el = document.getElementById('dt-' + phaseIds[i]);
        if (el) total += parseInt(el.value) || 0;
    }
    var totalEl = document.getElementById('dtTotalMonths');
    var yearsEl = document.getElementById('dtTotalYears');
    if (totalEl) totalEl.textContent = total;
    if (yearsEl) yearsEl.textContent = '(' + (total / 12).toFixed(1) + ' years)';

    // Update Gantt bar
    var bar = document.getElementById('dtGanttBar');
    if (bar) {
        var colors = ['#718096','#805ad5','#3182ce','#d69e2e','#38a169','#ed8936','#dd6b20','#e53e3e','#48bb78','#667eea','#f56565','#9f7aea'];
        var segments = '';
        for (var i = 0; i < phaseIds.length; i++) {
            var el = document.getElementById('dt-' + phaseIds[i]);
            var mo = el ? (parseInt(el.value) || 0) : 0;
            if (mo > 0) {
                segments += '<div style="flex:' + mo + ';background:' + colors[i] + ';display:flex;align-items:center;justify-content:center;font-size:0.55rem;color:#fff;font-weight:600;white-space:nowrap;overflow:hidden;min-width:0;" title="' + mo + ' months">';
                segments += mo >= 3 ? mo + 'mo' : '';
                segments += '</div>';
            }
        }
        bar.innerHTML = segments;
    }
}

function resetDevTimeline() {
    var st = deepAnalysisState;
    if (!st) return;
    var phases = getDefaultDevTimeline(st);
    for (var i = 0; i < phases.length; i++) {
        var el = document.getElementById('dt-' + phases[i].id);
        if (el) el.value = phases[i].months;
    }
    recalcDevTimeline();
}

// Public Finance dynamic controls
var PUBLIC_FINANCE_DEFAULTS = {
    cityShare: 16, countyShare: 26, schoolShare: 45, specialDistShare: 13,
    captureRate: 75, avGrowth: 2.0, bondRate: 4.5, bondTerm: 30, bondCoverage: 1.25
};
var publicFinanceOverrides = null;

function getPublicFinanceParams() {
    var d = PUBLIC_FINANCE_DEFAULTS, o = publicFinanceOverrides || {};
    return {
        cityShare:       (o.cityShare       != null ? o.cityShare       : d.cityShare) / 100,
        countyShare:     (o.countyShare     != null ? o.countyShare     : d.countyShare) / 100,
        schoolShare:     (o.schoolShare     != null ? o.schoolShare     : d.schoolShare) / 100,
        specialDistShare:(o.specialDistShare!= null ? o.specialDistShare: d.specialDistShare) / 100,
        captureRate:     (o.captureRate     != null ? o.captureRate     : d.captureRate) / 100,
        avGrowth:        (o.avGrowth        != null ? o.avGrowth        : d.avGrowth) / 100,
        bondRate:        (o.bondRate        != null ? o.bondRate        : d.bondRate) / 100,
        bondTerm:         o.bondTerm        != null ? o.bondTerm        : d.bondTerm,
        bondCoverage:    (o.bondCoverage    != null ? o.bondCoverage    : d.bondCoverage),
    };
}

function buildPFSlider(id, label, val, min, max, step, suffix) {
    suffix = suffix || '%';
    var dec = step < 1 ? (step < 0.1 ? 2 : 1) : 0;
    var h = '<div class="dt-slider-group">';
    h += '<div class="dt-slider-label"><span>' + label + '</span><span class="dt-val" id="pf-' + id + '-val">' + val.toFixed(dec) + suffix + '</span></div>';
    h += '<div class="dt-slider-row">';
    h += '<input type="range" id="pf-' + id + '-slider" min="' + min + '" max="' + max + '" step="' + step + '" value="' + val + '" oninput="document.getElementById(\'pf-' + id + '\').value=this.value;recalcPublicFinance()">';
    h += '<input type="number" id="pf-' + id + '" min="' + min + '" max="' + max + '" step="' + step + '" value="' + val + '" oninput="document.getElementById(\'pf-' + id + '-slider\').value=this.value;recalcPublicFinance()">';
    h += '</div></div>';
    return h;
}

function recalcPublicFinance() {
    if (!publicFinanceOverrides) publicFinanceOverrides = {};
    var fields = ['cityShare','countyShare','schoolShare','specialDistShare','captureRate','avGrowth','bondRate','bondTerm','bondCoverage'];
    fields.forEach(function(f) {
        var el = document.getElementById('pf-' + f);
        if (el) publicFinanceOverrides[f] = parseFloat(el.value);
    });
    fields.forEach(function(f) {
        var slider = document.getElementById('pf-' + f + '-slider');
        var num = document.getElementById('pf-' + f);
        if (slider && num && document.activeElement === slider) num.value = slider.value;
        if (slider && num && document.activeElement === num) slider.value = num.value;
        var valSpan = document.getElementById('pf-' + f + '-val');
        if (valSpan && num) {
            var dec = (f === 'bondCoverage') ? 2 : (f === 'bondTerm' ? 0 : 1);
            var suffix = (f === 'bondTerm') ? ' yr' : (f === 'bondCoverage' ? 'x' : '%');
            valSpan.textContent = parseFloat(num.value).toFixed(dec) + suffix;
        }
    });
    _debouncedCall('publicFinance', function() {
        var container = document.getElementById('publicFinanceContent');
        if (container) container.innerHTML = buildPublicFinanceContent();
    }, 150);
}

function resetPublicFinance() {
    publicFinanceOverrides = null;
    var d = PUBLIC_FINANCE_DEFAULTS;
    Object.keys(d).forEach(function(f) {
        var slider = document.getElementById('pf-' + f + '-slider');
        var num = document.getElementById('pf-' + f);
        if (slider) slider.value = d[f];
        if (num) num.value = d[f];
    });
    recalcPublicFinance();
}

function buildPublicFinanceContent() {
    var st = deepAnalysisState;
    if (!st) return '';
    var computed = st.computed, inp = st.inp, prop = st.prop;
    var pf = getPublicFinanceParams();
    var assessedValue = computed.totalDev;
    var baseYearAV = (prop.landVal || 0) + (prop.impVal || 0);
    var newAV = assessedValue;
    var increment = Math.max(0, newAV - baseYearAV);
    var annualTaxIncrement = increment * 0.01; // Prop 13 base levy always 1%

    var cityIncrement = annualTaxIncrement * pf.cityShare;
    var countyIncrement = annualTaxIncrement * pf.countyShare;
    var specialIncrement = annualTaxIncrement * pf.specialDistShare;
    var capturableIncrement = (cityIncrement + countyIncrement + specialIncrement) * pf.captureRate;
    var schoolIncrement = annualTaxIncrement * pf.schoolShare;

    var projections = [];
    var cumulative = 0;
    for (var yr = 1; yr <= 30; yr++) {
        var yrAV = increment * Math.pow(1 + pf.avGrowth, yr);
        var yrTax = yrAV * 0.01;
        var yrCapture = (yrTax * (pf.cityShare + pf.countyShare + pf.specialDistShare)) * pf.captureRate;
        cumulative += yrCapture;
        if (yr === 1 || yr === 5 || yr === 10 || yr === 15 || yr === 20 || yr === 30) {
            projections.push({ year: yr, annualCapture: Math.round(yrCapture), cumulative: Math.round(cumulative) });
        }
    }

    var avgAnnualCapture = cumulative / 30;
    var bondCapacity = Math.round(avgAnnualCapture / pf.bondCoverage / (pf.bondRate + (1 / pf.bondTerm)));

    var html = '';
    html += '<div class="exec-summary-grid">';
    html += '<div class="exec-summary-card"><h4>Assessed Value Increment</h4><div class="exec-metric-lg">' + formatCompactDollars(increment) + '</div><div class="exec-metric-sub">New AV: ' + formatCompactDollars(newAV) + ' â€” Base: ' + formatCompactDollars(baseYearAV) + '</div></div>';
    html += '<div class="exec-summary-card"><h4>Annual Tax Increment (Yr 1)</h4><div class="exec-metric-lg">' + fmt(Math.round(annualTaxIncrement)) + '</div><div class="exec-metric-sub">1.0% base levy on ' + formatCompactDollars(increment) + ' increment</div></div>';
    html += '<div class="exec-summary-card"><h4>Capturable by EIFD (Yr 1)</h4><div class="exec-metric-lg" style="color:#276749;">' + fmt(Math.round(capturableIncrement)) + '</div><div class="exec-metric-sub">' + (pf.captureRate * 100).toFixed(0) + '% of city + county + special dist shares</div></div>';
    html += '<div class="exec-summary-card"><h4>Est. Bond Capacity</h4><div class="exec-metric-lg" style="color:var(--primary);">' + formatCompactDollars(bondCapacity) + '</div><div class="exec-metric-sub">' + pf.bondTerm + '-yr term at ' + (pf.bondRate * 100).toFixed(1) + '%, ' + pf.bondCoverage.toFixed(2) + 'x DSCR</div></div>';
    html += '</div>';

    html += '<h4 style="font-size:0.85rem;color:var(--text);margin:1.25rem 0 0.5rem;">Tax Increment Allocation (Year 1)</h4>';
    html += '<table class="afford-comparison-table"><thead><tr><th>Entity</th><th>Share</th><th>Annual Amount</th><th>EIFD Eligible?</th></tr></thead><tbody>';
    html += '<tr><td>City General Fund</td><td>' + (pf.cityShare * 100).toFixed(0) + '%</td><td>' + fmt(Math.round(cityIncrement)) + '</td><td style="color:#276749;">Yes</td></tr>';
    html += '<tr><td>County</td><td>' + (pf.countyShare * 100).toFixed(0) + '%</td><td>' + fmt(Math.round(countyIncrement)) + '</td><td style="color:#276749;">Yes (with consent)</td></tr>';
    html += '<tr><td>Schools (ERAF)</td><td>' + (pf.schoolShare * 100).toFixed(0) + '%</td><td>' + fmt(Math.round(schoolIncrement)) + '</td><td style="color:#c53030;">No â€” protected</td></tr>';
    html += '<tr><td>Special Districts</td><td>' + (pf.specialDistShare * 100).toFixed(0) + '%</td><td>' + fmt(Math.round(specialIncrement)) + '</td><td style="color:#276749;">Yes (with consent)</td></tr>';
    html += '<tr class="total-row"><td>Total Capturable</td><td></td><td>' + fmt(Math.round(capturableIncrement)) + '</td><td></td></tr>';
    html += '</tbody></table>';

    html += '<h4 style="font-size:0.85rem;color:var(--text);margin:1.25rem 0 0.5rem;">30-Year Tax Increment Projection (' + (pf.avGrowth * 100).toFixed(1) + '% annual AV growth)</h4>';
    html += '<table class="afford-comparison-table"><thead><tr><th>Year</th><th>Annual Capture</th><th>Cumulative</th></tr></thead><tbody>';
    for (var p = 0; p < projections.length; p++) {
        html += '<tr><td>Year ' + projections[p].year + '</td><td>' + fmt(projections[p].annualCapture) + '</td><td>' + formatCompactDollars(projections[p].cumulative) + '</td></tr>';
    }
    html += '</tbody></table>';

    html += '<h4 style="font-size:0.85rem;color:var(--text);margin:1.25rem 0 0.5rem;">District Type Comparison</h4>';
    html += '<table class="afford-comparison-table"><thead><tr><th>Feature</th><th>EIFD (SB 628)</th><th>CRIA (AB 2)</th><th>CRD (SB 852)</th></tr></thead><tbody>';
    html += '<tr><td>Formation</td><td>City/County resolution</td><td>City/County resolution</td><td>City/County/Special Dist</td></tr>';
    html += '<tr><td>Voter Approval</td><td>55% for bonds</td><td>No (protest hearing)</td><td>No (protest hearing)</td></tr>';
    html += '<tr><td>Affordable Housing</td><td>No minimum</td><td style="font-weight:600;color:#276749;">25% minimum</td><td>No minimum</td></tr>';
    html += '<tr><td>Duration</td><td>Up to 45 years</td><td>Up to 45 years</td><td>Up to 45 years</td></tr>';
    html += '<tr><td>School Tax</td><td>Cannot capture</td><td>Cannot capture</td><td>Cannot capture</td></tr>';
    html += '<tr><td>Best For</td><td>Infrastructure, transit</td><td>Blight/affordable housing</td><td>Climate resilience projects</td></tr>';
    html += '</tbody></table>';

    html += '<div style="background:#f0fff4;border:1px solid #c6f6d5;border-radius:8px;padding:0.75rem 1rem;margin-top:1rem;">';
    html += '<h5 style="font-size:0.82rem;color:#276749;margin-bottom:0.4rem;">Formation Cost vs. Benefit</h5>';
    html += '<div style="font-size:0.78rem;color:var(--text);line-height:1.6;">';
    html += '<strong>Formation cost:</strong> ~' + formatCompactDollars(EIFD_PARAMS.formationCost) + ' (legal, economic analysis, public hearings) | ';
    html += '<strong>Annual admin:</strong> ~' + fmt(EIFD_PARAMS.annualAdmin) + '/yr<br>';
    html += '<strong>Payback:</strong> ' + (capturableIncrement > EIFD_PARAMS.annualAdmin ? 'Year 1 net positive (' + fmt(Math.round(capturableIncrement - EIFD_PARAMS.annualAdmin)) + '/yr after admin)' : 'Formation may not be cost-effective for this project size') + '<br>';
    html += '<strong>30-year total capture:</strong> ' + formatCompactDollars(Math.round(cumulative));
    html += '</div></div>';

    html += '<div style="font-size:0.72rem;color:#718096;margin-top:0.75rem;"><strong>Sources:</strong> ';
    var srcLinks = Object.values(EIFD_PARAMS.sources).map(function(s) { return '<a href="' + s.url + '" target="_blank" style="color:#3182ce;">' + s.label + '</a>'; }).join(' | ');
    html += srcLinks + '</div>';
    return html;
}

function renderPublicFinanceTab(st) {
    var d = PUBLIC_FINANCE_DEFAULTS;
    var p = publicFinanceOverrides || {};
    var gv = function(f) { return p[f] != null ? p[f] : d[f]; };

    var html = '<div class="deep-tab-panel">';
    html += '<div class="analysis-section"><h3>Public Finance â€” Tax Increment Districts</h3>';
    html += '<p style="font-size:0.82rem;color:var(--text-light);margin-bottom:1rem;">Analysis of Enhanced Infrastructure Financing Districts (EIFDs), Community Revitalization & Investment Authorities (CRIAs), and Climate Resilience Districts (CRDs) for this development.</p>';

    // Controls
    html += '<div class="dt-controls"><div class="dt-controls-title">Adjust Assumptions <button class="dt-reset-btn" onclick="resetPublicFinance()">Reset Defaults</button></div>';
    html += '<div class="dt-controls-grid">';
    html += buildPFSlider('cityShare', 'City Share', gv('cityShare'), 5, 30, 1);
    html += buildPFSlider('countyShare', 'County Share', gv('countyShare'), 10, 40, 1);
    html += buildPFSlider('schoolShare', 'School Share', gv('schoolShare'), 30, 55, 1);
    html += buildPFSlider('specialDistShare', 'Special Dist Share', gv('specialDistShare'), 5, 25, 1);
    html += buildPFSlider('captureRate', 'EIFD Capture Rate', gv('captureRate'), 50, 100, 5);
    html += buildPFSlider('avGrowth', 'AV Growth Rate', gv('avGrowth'), 0.5, 5.0, 0.5);
    html += buildPFSlider('bondRate', 'Bond Interest Rate', gv('bondRate'), 3.0, 7.0, 0.25);
    html += buildPFSlider('bondTerm', 'Bond Term', gv('bondTerm'), 15, 45, 5, ' yr');
    html += buildPFSlider('bondCoverage', 'Bond DSCR', gv('bondCoverage'), 1.0, 1.5, 0.05, 'x');
    html += '</div></div>';

    html += '<div id="publicFinanceContent">' + buildPublicFinanceContent() + '</div>';
    html += '</div></div>';
    return html;
}

// ============================================================
//  FISCAL IMPACT ANALYSIS TAB
// ============================================================

var FISCAL_IMPACT_RATES = {
    // LA City fiscal parameters
    propertyTaxCityShare: 0.16,      // city gets ~16% of 1% levy
    salesTaxLocal: 0.01,             // 1% local sales tax (city share)
    utilityTaxRate: 0.09,            // 9% on electric/gas/telecom
    avgUtilityPerUnit: 2400,         // avg annual utility cost per residential unit
    avgUtilityPerSF: 3.20,          // avg annual utility cost per commercial SF
    businessLicenseFee: 0.00153,     // $1.53 per $1,000 gross receipts (LA City rate)
    transitOccupancyTax: 0.14,       // 14% hotel TOT (if applicable)
    parkFee: 1500,                   // Quimby/park fee per unit
    schoolFee: 4.79,                 // school impact fee per SF (residential)
    trafficFee: 3200,                // transportation impact fee per unit
    // Service costs per capita
    policePerCapita: 680,
    firePerCapita: 420,
    publicWorksPerCapita: 290,
    parksPerCapita: 180,
    adminPerCapita: 150,
    personsPerUnit: 2.3,             // avg household size
    personsPerCommSF: 0.004,         // 1 person per 250 SF commercial
};

// Fiscal Impact dynamic controls
var FISCAL_IMPACT_DEFAULTS = {
    cityTaxShare: 16, utilityTaxRate: 9, personsPerUnit: 2.3,
    parkFee: 1500, schoolFee: 4.79, trafficFee: 3200,
    policePerCapita: 680, firePerCapita: 420, publicWorksPerCapita: 290,
    parksPerCapita: 180, adminPerCapita: 150
};
var fiscalImpactOverrides = null;

function getFiscalParams() {
    var d = FISCAL_IMPACT_DEFAULTS, o = fiscalImpactOverrides || {};
    var r = {};
    Object.keys(d).forEach(function(k) { r[k] = o[k] != null ? o[k] : d[k]; });
    return r;
}

function buildFISlider(id, label, val, min, max, step, suffix) {
    suffix = suffix || '';
    var dec = step < 1 ? (step < 0.01 ? 2 : 1) : 0;
    var h = '<div class="dt-slider-group">';
    h += '<div class="dt-slider-label"><span>' + label + '</span><span class="dt-val" id="fi-' + id + '-val">' + (suffix === '$' ? '$' + val.toFixed(dec) : val.toFixed(dec) + suffix) + '</span></div>';
    h += '<div class="dt-slider-row">';
    h += '<input type="range" id="fi-' + id + '-slider" min="' + min + '" max="' + max + '" step="' + step + '" value="' + val + '" oninput="document.getElementById(\'fi-' + id + '\').value=this.value;recalcFiscalImpact()">';
    h += '<input type="number" id="fi-' + id + '" min="' + min + '" max="' + max + '" step="' + step + '" value="' + val + '" oninput="document.getElementById(\'fi-' + id + '-slider\').value=this.value;recalcFiscalImpact()">';
    h += '</div></div>';
    return h;
}

function recalcFiscalImpact() {
    if (!fiscalImpactOverrides) fiscalImpactOverrides = {};
    var fields = Object.keys(FISCAL_IMPACT_DEFAULTS);
    fields.forEach(function(f) {
        var el = document.getElementById('fi-' + f);
        if (el) fiscalImpactOverrides[f] = parseFloat(el.value);
    });
    fields.forEach(function(f) {
        var slider = document.getElementById('fi-' + f + '-slider');
        var num = document.getElementById('fi-' + f);
        if (slider && num && document.activeElement === slider) num.value = slider.value;
        if (slider && num && document.activeElement === num) slider.value = num.value;
        var valSpan = document.getElementById('fi-' + f + '-val');
        if (valSpan && num) {
            var v = parseFloat(num.value);
            var isCurrency = ['parkFee','trafficFee','policePerCapita','firePerCapita','publicWorksPerCapita','parksPerCapita','adminPerCapita'].indexOf(f) >= 0;
            var dec = (f === 'schoolFee' || f === 'personsPerUnit') ? 1 : 0;
            valSpan.textContent = isCurrency ? '$' + v.toFixed(dec) : v.toFixed(dec) + (f === 'personsPerUnit' ? '' : '%');
        }
    });
    _debouncedCall('fiscalImpact', function() {
        var container = document.getElementById('fiscalImpactContent');
        if (container) container.innerHTML = buildFiscalImpactContent();
    }, 150);
}

function resetFiscalImpact() {
    fiscalImpactOverrides = null;
    var d = FISCAL_IMPACT_DEFAULTS;
    Object.keys(d).forEach(function(f) {
        var slider = document.getElementById('fi-' + f + '-slider');
        var num = document.getElementById('fi-' + f);
        if (slider) slider.value = d[f];
        if (num) num.value = d[f];
    });
    recalcFiscalImpact();
}

function buildFiscalImpactContent() {
    var st = deepAnalysisState;
    if (!st) return '';
    var computed = st.computed, bestUse = st.bestUse;
    var fp = getFiscalParams();
    var isResidential = ['sfr','duplex','multifamily_low','multifamily_mid','multifamily_high','mixeduse','senior','adu'].includes(bestUse);
    var units = computed.units || 0;
    var gsf = computed.gsf || 0;

    var assessedValue = computed.totalDev;
    var annualPropTax = assessedValue * 0.01 * (fp.cityTaxShare / 100);
    var retailSF = bestUse === 'retail' ? gsf : (bestUse === 'mixeduse' ? Math.round(gsf * 0.15) : 0);
    var estRetailSalesPerSF = 350;
    var annualSalesTax = retailSF * estRetailSalesPerSF * 0.01;
    var annualUtilityTax = isResidential
        ? units * 2400 * (fp.utilityTaxRate / 100)
        : gsf * 3.20 * (fp.utilityTaxRate / 100);
    var annualBizLicense = !isResidential ? computed.grossRevenue * 0.00153 : 0;

    var parkFees = units * fp.parkFee;
    var schoolFees = gsf * fp.schoolFee;
    var trafficFees = units * fp.trafficFee;
    var totalOneTimeFees = parkFees + schoolFees + trafficFees;
    var totalAnnualRevenue = annualPropTax + annualSalesTax + annualUtilityTax + annualBizLicense;

    var newPopulation = isResidential ? units * fp.personsPerUnit : Math.round(gsf * 0.004);
    var policeCost = newPopulation * fp.policePerCapita;
    var fireCost = newPopulation * fp.firePerCapita;
    var publicWorksCost = newPopulation * fp.publicWorksPerCapita;
    var parksCost = newPopulation * fp.parksPerCapita;
    var adminCost = newPopulation * fp.adminPerCapita;
    var totalAnnualCost = policeCost + fireCost + publicWorksCost + parksCost + adminCost;
    var netFiscalImpact = totalAnnualRevenue - totalAnnualCost;
    var isPositive = netFiscalImpact >= 0;

    var html = '';
    html += '<div class="exec-summary-grid">';
    html += '<div class="exec-summary-card"><h4>Annual Revenue to City</h4><div class="exec-metric-lg" style="color:#276749;">' + fmt(Math.round(totalAnnualRevenue)) + '</div><div class="exec-metric-sub">Property tax + utility tax + sales tax + fees</div></div>';
    html += '<div class="exec-summary-card"><h4>Annual Service Cost</h4><div class="exec-metric-lg" style="color:#c53030;">' + fmt(Math.round(totalAnnualCost)) + '</div><div class="exec-metric-sub">Police, fire, public works, parks, admin for ' + Math.round(newPopulation) + ' new residents</div></div>';
    html += '<div class="exec-summary-card"><h4>Net Fiscal Impact</h4><div class="exec-metric-lg" style="color:' + (isPositive ? '#276749' : '#c53030') + ';">' + (isPositive ? '+' : '') + fmt(Math.round(netFiscalImpact)) + '/yr</div><div class="exec-metric-sub">' + (isPositive ? 'Net positive â€” project generates surplus revenue for city' : 'Net negative â€” project costs city more than it generates') + '</div></div>';
    html += '<div class="exec-summary-card"><h4>One-Time Impact Fees</h4><div class="exec-metric-lg">' + formatCompactDollars(totalOneTimeFees) + '</div><div class="exec-metric-sub">Park: ' + fmt(parkFees) + ' | School: ' + fmt(Math.round(schoolFees)) + ' | Traffic: ' + fmt(trafficFees) + '</div></div>';
    html += '</div>';

    html += '<h4 style="font-size:0.85rem;color:var(--text);margin:1.25rem 0 0.5rem;">Recurring Annual Revenue to City</h4>';
    html += '<table class="afford-comparison-table"><thead><tr><th>Source</th><th>Rate/Basis</th><th>Annual Revenue</th></tr></thead><tbody>';
    html += '<tr><td>Property Tax (City Share)</td><td>' + fp.cityTaxShare + '% of 1% levy on ' + formatCompactDollars(assessedValue) + '</td><td>' + fmt(Math.round(annualPropTax)) + '</td></tr>';
    if (annualSalesTax > 0) html += '<tr><td>Sales Tax (Local)</td><td>1% on est. ' + formatCompactDollars(retailSF * estRetailSalesPerSF) + ' retail sales</td><td>' + fmt(Math.round(annualSalesTax)) + '</td></tr>';
    html += '<tr><td>Utility Users Tax</td><td>' + fp.utilityTaxRate + '% on ' + (isResidential ? units + ' units' : gsf.toLocaleString() + ' SF') + '</td><td>' + fmt(Math.round(annualUtilityTax)) + '</td></tr>';
    if (annualBizLicense > 0) html += '<tr><td>Business License Fee</td><td>$1.53 per $1,000 gross receipts</td><td>' + fmt(Math.round(annualBizLicense)) + '</td></tr>';
    html += '<tr class="total-row"><td>Total Annual Revenue</td><td></td><td>' + fmt(Math.round(totalAnnualRevenue)) + '</td></tr>';
    html += '</tbody></table>';

    html += '<h4 style="font-size:0.85rem;color:var(--text);margin:1.25rem 0 0.5rem;">Annual Municipal Service Costs (' + Math.round(newPopulation) + ' new residents/workers)</h4>';
    html += '<table class="afford-comparison-table"><thead><tr><th>Department</th><th>Cost/Capita</th><th>Annual Cost</th></tr></thead><tbody>';
    html += '<tr><td>Police</td><td>' + fmt(fp.policePerCapita) + '</td><td>' + fmt(Math.round(policeCost)) + '</td></tr>';
    html += '<tr><td>Fire & EMS</td><td>' + fmt(fp.firePerCapita) + '</td><td>' + fmt(Math.round(fireCost)) + '</td></tr>';
    html += '<tr><td>Public Works</td><td>' + fmt(fp.publicWorksPerCapita) + '</td><td>' + fmt(Math.round(publicWorksCost)) + '</td></tr>';
    html += '<tr><td>Parks & Recreation</td><td>' + fmt(fp.parksPerCapita) + '</td><td>' + fmt(Math.round(parksCost)) + '</td></tr>';
    html += '<tr><td>General Admin</td><td>' + fmt(fp.adminPerCapita) + '</td><td>' + fmt(Math.round(adminCost)) + '</td></tr>';
    html += '<tr class="total-row"><td>Total Annual Cost</td><td></td><td>' + fmt(Math.round(totalAnnualCost)) + '</td></tr>';
    html += '</tbody></table>';

    html += '<div style="font-size:0.72rem;color:#718096;margin-top:0.75rem;">Service cost estimates based on LA City budget per-capita allocations. Property tax shares based on typical LA County Tax Rate Area distributions. Actual rates vary by specific TRA â€” verify at <a href="https://auditor.lacounty.gov/tax-rate-area-lookup/" target="_blank" style="color:#3182ce;">LA County Auditor</a>.</div>';
    return html;
}

function renderFiscalImpactTab(st) {
    var fp = getFiscalParams();
    var html = '<div class="deep-tab-panel">';
    html += '<div class="analysis-section"><h3>Fiscal Impact Analysis</h3>';
    html += '<p style="font-size:0.82rem;color:var(--text-light);margin-bottom:1rem;">Estimated annual impact on city general fund: recurring tax revenue generated vs. municipal service costs incurred by this development.</p>';

    html += '<div class="dt-controls"><div class="dt-controls-title">Adjust Assumptions <button class="dt-reset-btn" onclick="resetFiscalImpact()">Reset Defaults</button></div>';
    html += '<div class="dt-controls-grid">';
    html += buildFISlider('cityTaxShare', 'City Property Tax Share', fp.cityTaxShare, 8, 25, 1, '%');
    html += buildFISlider('utilityTaxRate', 'Utility Users Tax Rate', fp.utilityTaxRate, 5, 12, 1, '%');
    html += buildFISlider('personsPerUnit', 'Persons Per Unit', fp.personsPerUnit, 1.5, 4.0, 0.1, '');
    html += buildFISlider('parkFee', 'Park Fee (per unit)', fp.parkFee, 500, 5000, 100, '$');
    html += buildFISlider('schoolFee', 'School Fee (per SF)', fp.schoolFee, 2.0, 8.0, 0.5, '$');
    html += buildFISlider('trafficFee', 'Traffic Fee (per unit)', fp.trafficFee, 1000, 8000, 200, '$');
    html += buildFISlider('policePerCapita', 'Police Cost/Capita', fp.policePerCapita, 300, 1200, 20, '$');
    html += buildFISlider('firePerCapita', 'Fire/EMS Cost/Capita', fp.firePerCapita, 200, 800, 20, '$');
    html += buildFISlider('publicWorksPerCapita', 'Public Works/Capita', fp.publicWorksPerCapita, 100, 600, 20, '$');
    html += buildFISlider('parksPerCapita', 'Parks Cost/Capita', fp.parksPerCapita, 50, 400, 10, '$');
    html += buildFISlider('adminPerCapita', 'Admin Cost/Capita', fp.adminPerCapita, 50, 400, 10, '$');
    html += '</div></div>';

    html += '<div id="fiscalImpactContent">' + buildFiscalImpactContent() + '</div>';
    html += '</div></div>';
    return html;
}

// ============================================================
//  RHNA COMPLIANCE TAB
// ============================================================

var RHNA_CYCLE_6 = {
    // 6th Cycle RHNA Allocations for select LA County cities (2021-2029)
    // Source: SCAG Final RHNA Allocation Plan (March 2021)
    losangeles:    { vli: 115365, low: 57516, moderate: 72246, aboveMod: 211131, total: 456258, built: 48000, label: 'City of Los Angeles' },
    santamonica:   { vli: 2738, low: 1672, moderate: 1765, aboveMod: 2793, total: 8968, built: 1200, label: 'City of Santa Monica' },
    culvercity:    { vli: 918, low: 560, moderate: 527, aboveMod: 1288, total: 3341, built: 400, label: 'City of Culver City' },
    beverlyhills:  { vli: 1008, low: 615, moderate: 649, aboveMod: 1586, total: 3104, built: 200, label: 'City of Beverly Hills' },
    inglewood:     { vli: 1704, low: 1040, moderate: 1195, aboveMod: 2197, total: 7073, built: 300, label: 'City of Inglewood' },
    pasadena:      { vli: 2560, low: 1563, moderate: 1800, aboveMod: 3360, total: 9429, built: 1100, label: 'City of Pasadena' },
    glendale:      { vli: 3492, low: 2131, moderate: 2422, aboveMod: 4939, total: 12984, built: 900, label: 'City of Glendale' },
    burbank:       { vli: 2536, low: 1548, moderate: 1586, aboveMod: 3341, total: 8775, built: 700, label: 'City of Burbank' },
    longbeach:     { vli: 7948, low: 4854, moderate: 5372, aboveMod: 8450, total: 26502, built: 2500, label: 'City of Long Beach' },
    torrance:      { vli: 1936, low: 1182, moderate: 1198, aboveMod: 2832, total: 4968, built: 300, label: 'City of Torrance' },
    pomona:        { vli: 1088, low: 664, moderate: 777, aboveMod: 2207, total: 5562, built: 200, label: 'City of Pomona' },
    // Catch-all for unincorporated / unknown
    default:       { vli: 5000, low: 3000, moderate: 3500, aboveMod: 8000, total: 19500, built: 2000, label: 'LA County (est.)' },
};

function getCityFromNeighborhood(nh) {
    var cityMap = {
        dtla: 'losangeles', hollywood: 'losangeles', koreatown: 'losangeles',
        midcity: 'losangeles', silverlake: 'losangeles', boyleheights: 'losangeles',
        highland: 'losangeles', venice: 'losangeles', exposition: 'losangeles',
        santamonica: 'santamonica', culver: 'culvercity', beverly: 'beverlyhills',
        westside: 'losangeles', southla: 'losangeles', harbor: 'losangeles',
        valleyeast: 'losangeles', valleywest: 'losangeles', southbay: 'torrance',
    };
    return cityMap[nh] || 'losangeles';
}

function renderRHNATab(st) {
    var computed = st.computed, inp = st.inp, bestUse = st.bestUse;
    var isResidential = ['sfr','duplex','multifamily_low','multifamily_mid','multifamily_high','mixeduse','senior','adu'].includes(bestUse);
    var units = computed.units || 0;

    var html = '<div class="deep-tab-panel">';

    if (!isResidential || units === 0) {
        html += '<div class="coming-soon-panel"><div class="icon">N/A</div><h3>Not Applicable</h3><p>RHNA compliance analysis is only available for residential projects with unit counts.</p></div></div>';
        return html;
    }

    var cityKey = getCityFromNeighborhood(inp.neighborhood);
    var rhna = RHNA_CYCLE_6[cityKey] || RHNA_CYCLE_6.default;
    var remaining = {
        vli: Math.max(0, rhna.vli - Math.round(rhna.built * 0.12)),
        low: Math.max(0, rhna.low - Math.round(rhna.built * 0.10)),
        moderate: Math.max(0, rhna.moderate - Math.round(rhna.built * 0.15)),
        aboveMod: Math.max(0, rhna.aboveMod - Math.round(rhna.built * 0.63)),
    };
    remaining.total = remaining.vli + remaining.low + remaining.moderate + remaining.aboveMod;

    // Estimate unit distribution for this project
    var affordReq = INCLUSIONARY_REQS.base;
    var vliUnits = Math.ceil(units * affordReq.vli);
    var lowUnits = Math.ceil(units * affordReq.low) - vliUnits;
    var modUnits = Math.ceil(units * affordReq.moderate) - vliUnits - lowUnits;
    var aboveModUnits = units - vliUnits - lowUnits - modUnits;

    var contributionPct = remaining.total > 0 ? (units / remaining.total * 100) : 0;

    html += '<div class="analysis-section"><h3>RHNA Compliance â€” ' + rhna.label + '</h3>';
    html += '<p style="font-size:0.82rem;color:var(--text-light);margin-bottom:1rem;">California\'s 6th Cycle Regional Housing Needs Allocation (2021-2029) requires cities to plan for housing at all income levels. This project contributes ' + units + ' units toward ' + rhna.label + '\'s allocation.</p>';

    // Headline
    html += '<div class="exec-summary-grid">';
    html += '<div class="exec-summary-card"><h4>City RHNA Allocation</h4><div class="exec-metric-lg">' + rhna.total.toLocaleString() + '</div><div class="exec-metric-sub">Total units required (6th Cycle)</div></div>';
    html += '<div class="exec-summary-card"><h4>Est. Remaining Need</h4><div class="exec-metric-lg" style="color:#c53030;">' + remaining.total.toLocaleString() + '</div><div class="exec-metric-sub">~' + rhna.built.toLocaleString() + ' permitted to date</div></div>';
    html += '<div class="exec-summary-card"><h4>This Project Contributes</h4><div class="exec-metric-lg" style="color:#276749;">' + units + ' units</div><div class="exec-metric-sub">' + contributionPct.toFixed(2) + '% of remaining need</div></div>';
    html += '<div class="exec-summary-card"><h4>Deadline</h4><div class="exec-metric-lg">Oct 2029</div><div class="exec-metric-sub">6th Cycle end date</div></div>';
    html += '</div>';

    // Breakdown by income category
    html += '<h4 style="font-size:0.85rem;color:var(--text);margin:1.25rem 0 0.5rem;">Contribution by Income Category</h4>';
    html += '<table class="afford-comparison-table"><thead><tr><th>Income Level</th><th>City Need</th><th>Remaining</th><th>This Project</th><th>% of Remaining</th></tr></thead><tbody>';
    var categories = [
        { label: 'Very Low Income (â‰¤50% AMI)', need: rhna.vli, rem: remaining.vli, proj: vliUnits },
        { label: 'Low Income (50-80% AMI)', need: rhna.low, rem: remaining.low, proj: lowUnits },
        { label: 'Moderate (80-120% AMI)', need: rhna.moderate, rem: remaining.moderate, proj: modUnits },
        { label: 'Above Moderate (>120% AMI)', need: rhna.aboveMod, rem: remaining.aboveMod, proj: aboveModUnits },
    ];
    for (var c = 0; c < categories.length; c++) {
        var cat = categories[c];
        var pct = cat.rem > 0 ? (cat.proj / cat.rem * 100).toFixed(2) : '0.00';
        html += '<tr><td>' + cat.label + '</td><td>' + cat.need.toLocaleString() + '</td><td>' + cat.rem.toLocaleString() + '</td><td style="font-weight:600;color:#276749;">' + cat.proj + '</td><td>' + pct + '%</td></tr>';
    }
    html += '<tr class="total-row"><td>Total</td><td>' + rhna.total.toLocaleString() + '</td><td>' + remaining.total.toLocaleString() + '</td><td style="font-weight:700;">' + units + '</td><td>' + contributionPct.toFixed(2) + '%</td></tr>';
    html += '</tbody></table>';

    // Progress visualization
    html += '<h4 style="font-size:0.85rem;color:var(--text);margin:1.25rem 0 0.5rem;">City RHNA Progress</h4>';
    var builtPct = Math.min(100, Math.round(rhna.built / rhna.total * 100));
    var projPct = Math.min(100 - builtPct, Math.round(units / rhna.total * 100));
    html += '<div style="background:#edf2f7;border-radius:8px;height:32px;overflow:hidden;position:relative;">';
    html += '<div style="position:absolute;left:0;top:0;height:100%;width:' + builtPct + '%;background:#38a169;"></div>';
    html += '<div style="position:absolute;left:' + builtPct + '%;top:0;height:100%;width:' + Math.max(1, projPct) + '%;background:#3182ce;"></div>';
    html += '<div style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);font-size:0.75rem;font-weight:600;color:white;text-shadow:0 1px 2px rgba(0,0,0,0.5);">' + builtPct + '% built + ' + projPct + '% this project</div>';
    html += '</div>';
    html += '<div style="display:flex;gap:1rem;margin-top:0.4rem;font-size:0.72rem;color:#718096;">';
    html += '<span style="display:flex;align-items:center;gap:0.25rem;"><span style="width:10px;height:10px;background:#38a169;border-radius:2px;"></span> Permitted</span>';
    html += '<span style="display:flex;align-items:center;gap:0.25rem;"><span style="width:10px;height:10px;background:#3182ce;border-radius:2px;"></span> This Project</span>';
    html += '<span style="display:flex;align-items:center;gap:0.25rem;"><span style="width:10px;height:10px;background:#edf2f7;border:1px solid #cbd5e0;border-radius:2px;"></span> Remaining</span>';
    html += '</div>';

    // Policy context
    html += '<div style="background:#f0fff4;border:1px solid #c6f6d5;border-radius:8px;padding:0.75rem 1rem;margin-top:1rem;">';
    html += '<h5 style="font-size:0.82rem;color:#276749;margin-bottom:0.4rem;">Why RHNA Matters for Your Project</h5>';
    html += '<div style="font-size:0.78rem;color:var(--text);line-height:1.6;">';
    html += 'Cities that fail to meet RHNA targets face <strong>Builder\'s Remedy</strong> provisions, loss of permitting authority, and mandatory housing overlay zones. ';
    html += 'Projects that help cities meet RHNA goals often receive <strong>expedited entitlements</strong> and political support. ';
    html += 'SB 35 streamlining is available in jurisdictions behind on RHNA â€” check <a href="https://www.hcd.ca.gov/planning-and-community-development/housing-open-data-tools/housing-element-implementation-and-apr-dashboard" target="_blank" style="color:#3182ce;">HCD\'s dashboard</a> for current status.';
    html += '</div></div>';

    html += '<div style="font-size:0.72rem;color:#718096;margin-top:0.75rem;">Source: <a href="https://scag.ca.gov/rhna" target="_blank" style="color:#3182ce;">SCAG 6th Cycle RHNA Allocation Plan</a> | <a href="https://www.hcd.ca.gov/planning-and-community-development/regional-housing-needs-allocation" target="_blank" style="color:#3182ce;">HCD RHNA Overview</a></div>';

    html += '</div></div>';
    return html;
}

// ===================================================================
//  TAB 20: PUBLIC-PRIVATE PARTNERSHIP (P3) STRUCTURING
// ===================================================================
var P3_DEFAULTS = {
    debtRate: 6.5, glEquity: 30, jvEquity: 25, jvDebt: 65, fsEquity: 30, fsDebt: 65,
    mdEquity: 20, mdPublic: 15, mdDebt: 60, publicReturnRate: 4.0
};
var p3Overrides = null;

function getP3Params() {
    var d = P3_DEFAULTS, o = p3Overrides || {};
    var r = {};
    Object.keys(d).forEach(function(k) { r[k] = o[k] != null ? o[k] : d[k]; });
    return r;
}

function buildP3Slider(id, label, val, min, max, step) {
    var dec = step < 1 ? 1 : 0;
    var h = '<div class="dt-slider-group">';
    h += '<div class="dt-slider-label"><span>' + label + '</span><span class="dt-val" id="p3-' + id + '-val">' + val.toFixed(dec) + '%</span></div>';
    h += '<div class="dt-slider-row">';
    h += '<input type="range" id="p3-' + id + '-slider" min="' + min + '" max="' + max + '" step="' + step + '" value="' + val + '" oninput="document.getElementById(\'p3-' + id + '\').value=this.value;recalcP3()">';
    h += '<input type="number" id="p3-' + id + '" min="' + min + '" max="' + max + '" step="' + step + '" value="' + val + '" oninput="document.getElementById(\'p3-' + id + '-slider\').value=this.value;recalcP3()">';
    h += '</div></div>';
    return h;
}

function recalcP3() {
    if (!p3Overrides) p3Overrides = {};
    Object.keys(P3_DEFAULTS).forEach(function(f) {
        var el = document.getElementById('p3-' + f);
        if (el) p3Overrides[f] = parseFloat(el.value);
    });
    Object.keys(P3_DEFAULTS).forEach(function(f) {
        var slider = document.getElementById('p3-' + f + '-slider');
        var num = document.getElementById('p3-' + f);
        if (slider && num && document.activeElement === slider) num.value = slider.value;
        if (slider && num && document.activeElement === num) slider.value = num.value;
        var valSpan = document.getElementById('p3-' + f + '-val');
        if (valSpan && num) valSpan.textContent = parseFloat(num.value).toFixed(P3_DEFAULTS[f] % 1 ? 1 : 0) + '%';
    });
    _debouncedCall('p3', function() {
        var container = document.getElementById('p3Content');
        if (container) container.innerHTML = buildP3Content();
    }, 150);
}

function resetP3() {
    p3Overrides = null;
    Object.keys(P3_DEFAULTS).forEach(function(f) {
        var slider = document.getElementById('p3-' + f + '-slider');
        var num = document.getElementById('p3-' + f);
        if (slider) slider.value = P3_DEFAULTS[f];
        if (num) num.value = P3_DEFAULTS[f];
    });
    recalcP3();
}

function buildP3Content() {
    var st = deepAnalysisState;
    if (!st) return '';
    var c = st.computed;
    var fmt = function(v) { return '$' + Math.round(v).toLocaleString(); };
    var fmtM = function(v) { return v >= 1e6 ? '$' + (v / 1e6).toFixed(1) + 'M' : fmt(v); };
    var pp = getP3Params();

    var totalDev = c.totalDev;
    var noi = c.noi;
    var stabilized = c.stabilizedValue;
    var landCost = c.landCost;
    var landPct = totalDev > 0 ? landCost / totalDev : 0;

    var structures = [
        {
            name: 'Ground Lease (Public Land)',
            desc: 'Public agency retains land ownership; developer leases for 55-99 years. Eliminates land acquisition cost.',
            devEquity: Math.round(totalDev * (pp.glEquity / 100) - landCost),
            publicContrib: landCost,
            debtAmount: Math.round((totalDev - landCost) * (1 - pp.glEquity / 100)),
            devReturn: 0, publicReturn: 0,
            riskLevel: 'Medium', riskColor: '#d69e2e',
            timeline: '18-36 months (negotiation) + construction',
            pros: ['No land acquisition cost', 'Lower equity requirement', 'Long-term control', 'Public agency retains asset'],
            cons: ['Lease reversion risk', 'Lender restrictions on leasehold', 'Rent escalation exposure', 'Complex subordination terms'],
        },
        {
            name: 'Joint Venture (Public/Private)',
            desc: 'Public entity contributes land or incentives; private developer contributes capital and expertise. Profit sharing.',
            devEquity: Math.round(totalDev * (pp.jvEquity / 100)),
            publicContrib: Math.round(landCost + totalDev * 0.05),
            debtAmount: Math.round(totalDev * (pp.jvDebt / 100)),
            devReturn: 0, publicReturn: 0,
            riskLevel: 'Medium-High', riskColor: '#e53e3e',
            timeline: '12-24 months (structuring) + construction',
            pros: ['Shared risk', 'Public incentive alignment', 'Community benefit integration', 'Flexible structures'],
            cons: ['Complex governance', 'Slower decision-making', 'Political risk', 'Profit sharing reduces returns'],
        },
        {
            name: 'Fee Simple Disposition',
            desc: 'Public agency sells land to developer at market or below-market price with development conditions.',
            devEquity: Math.round(totalDev * (pp.fsEquity / 100)),
            publicContrib: Math.round(landCost * 0.20),
            debtAmount: Math.round(totalDev * (pp.fsDebt / 100)),
            devReturn: 0, publicReturn: 0,
            riskLevel: 'Low-Medium', riskColor: '#38a169',
            timeline: '6-18 months (RFP/selection) + construction',
            pros: ['Full ownership', 'Simpler financing', 'Clear exit strategy', 'No ongoing public involvement'],
            cons: ['Higher capital requirement', 'Surplus land requirements', 'Community opposition risk', 'DA conditions'],
        },
        {
            name: 'Master Developer Agreement',
            desc: 'Developer controls phased development of larger site with public infrastructure obligations and community benefits.',
            devEquity: Math.round(totalDev * (pp.mdEquity / 100)),
            publicContrib: Math.round(totalDev * (pp.mdPublic / 100)),
            debtAmount: Math.round(totalDev * (pp.mdDebt / 100)),
            devReturn: 0, publicReturn: 0,
            riskLevel: 'High', riskColor: '#e53e3e',
            timeline: '24-48 months (entitlements) + phased construction',
            pros: ['Large-scale control', 'Phased risk', 'Value creation across phases', 'Infrastructure cost sharing'],
            cons: ['Long timeline', 'High upfront costs', 'Entitlement risk', 'Market cycle exposure'],
        }
    ];

    structures.forEach(function(s) {
        var debtService = Math.round(s.debtAmount * (pp.debtRate / 100));
        var devNOI = noi - debtService;
        s.devReturn = s.devEquity > 0 ? devNOI / s.devEquity : 0;
        s.publicReturn = s.publicContrib > 0 ? (s.publicContrib * (pp.publicReturnRate / 100) + noi * 0.10) / s.publicContrib : 0;
        s.devIRR = s.devEquity > 0 ? (stabilized - s.debtAmount - s.publicContrib) / s.devEquity / 5 : 0;
        s.equityMultiple = s.devEquity > 0 ? (stabilized - s.debtAmount) / s.devEquity : 0;
    });

    var html = '';
    html += '<div class="exec-summary-grid">';
    html += '<div class="exec-summary-card"><h4>Project Value</h4><div class="exec-metric-lg">' + fmtM(stabilized) + '</div><div class="exec-metric-sub">Stabilized value at ' + (c.capRate * 100).toFixed(1) + '% cap</div></div>';
    html += '<div class="exec-summary-card"><h4>Total Dev Cost</h4><div class="exec-metric-lg">' + fmtM(totalDev) + '</div><div class="exec-metric-sub">Land + Hard + Soft costs</div></div>';
    html += '<div class="exec-summary-card"><h4>Land Component</h4><div class="exec-metric-lg">' + (landPct * 100).toFixed(0) + '%</div><div class="exec-metric-sub">' + fmtM(landCost) + ' land cost</div></div>';
    html += '<div class="exec-summary-card"><h4>Annual NOI</h4><div class="exec-metric-lg">' + fmtM(noi) + '</div><div class="exec-metric-sub">' + (c.yieldOnCost * 100).toFixed(1) + '% yield on cost</div></div>';
    html += '</div>';

    html += '<h4 style="font-size:0.88rem;color:var(--text);margin:1.5rem 0 0.75rem;">Deal Structure Comparison</h4>';
    html += '<div style="overflow-x:auto;"><table style="width:100%;border-collapse:collapse;font-size:0.75rem;">';
    html += '<thead><tr style="background:#edf2f7;"><th style="padding:8px;text-align:left;">Structure</th><th style="padding:8px;text-align:right;">Dev Equity</th><th style="padding:8px;text-align:right;">Public Contrib</th><th style="padding:8px;text-align:right;">Debt</th><th style="padding:8px;text-align:right;">Cash-on-Cash</th><th style="padding:8px;text-align:right;">Equity Multiple</th><th style="padding:8px;text-align:center;">Risk</th></tr></thead><tbody>';
    structures.forEach(function(s) {
        html += '<tr style="border-bottom:1px solid #e2e8f0;">';
        html += '<td style="padding:8px;font-weight:600;">' + s.name + '</td>';
        html += '<td style="padding:8px;text-align:right;">' + fmtM(s.devEquity) + '</td>';
        html += '<td style="padding:8px;text-align:right;">' + fmtM(s.publicContrib) + '</td>';
        html += '<td style="padding:8px;text-align:right;">' + fmtM(s.debtAmount) + '</td>';
        html += '<td style="padding:8px;text-align:right;color:' + (s.devReturn > 0.10 ? '#276749' : '#c53030') + ';">' + (s.devReturn * 100).toFixed(1) + '%</td>';
        html += '<td style="padding:8px;text-align:right;">' + s.equityMultiple.toFixed(2) + 'x</td>';
        html += '<td style="padding:8px;text-align:center;"><span style="color:' + s.riskColor + ';font-weight:600;">' + s.riskLevel + '</span></td>';
        html += '</tr>';
    });
    html += '</tbody></table></div>';

    html += '<h4 style="font-size:0.88rem;color:var(--text);margin:1.5rem 0 0.75rem;">Structure Details</h4>';
    html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">';
    structures.forEach(function(s) {
        html += '<div style="background:#f7fafc;border:1px solid #e2e8f0;border-radius:8px;padding:1rem;">';
        html += '<h5 style="font-size:0.82rem;margin:0 0 0.5rem;color:#2d3748;">' + s.name + '</h5>';
        html += '<p style="font-size:0.72rem;color:#718096;margin-bottom:0.75rem;">' + s.desc + '</p>';
        html += '<div style="font-size:0.72rem;margin-bottom:0.5rem;"><strong>Timeline:</strong> ' + s.timeline + '</div>';
        html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;font-size:0.72rem;">';
        html += '<div><strong style="color:#276749;">Advantages</strong><ul style="margin:0.25rem 0 0;padding-left:1rem;">';
        s.pros.forEach(function(p) { html += '<li>' + p + '</li>'; });
        html += '</ul></div>';
        html += '<div><strong style="color:#c53030;">Challenges</strong><ul style="margin:0.25rem 0 0;padding-left:1rem;">';
        s.cons.forEach(function(p) { html += '<li>' + p + '</li>'; });
        html += '</ul></div></div></div>';
    });
    html += '</div>';

    html += '<h4 style="font-size:0.88rem;color:var(--text);margin:1.5rem 0 0.75rem;">Capital Stack by Structure</h4>';
    html += '<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:0.75rem;">';
    structures.forEach(function(s) {
        var total = s.devEquity + s.publicContrib + s.debtAmount;
        var debtPct = total > 0 ? s.debtAmount / total * 100 : 0;
        var pubPct = total > 0 ? s.publicContrib / total * 100 : 0;
        var eqPct = total > 0 ? s.devEquity / total * 100 : 0;
        html += '<div style="text-align:center;">';
        html += '<div style="font-size:0.72rem;font-weight:600;margin-bottom:0.5rem;">' + s.name.split('(')[0].trim() + '</div>';
        html += '<div style="height:150px;display:flex;flex-direction:column;border:1px solid #e2e8f0;border-radius:4px;overflow:hidden;">';
        html += '<div style="height:' + debtPct + '%;background:#63b3ed;display:flex;align-items:center;justify-content:center;font-size:0.65rem;color:#fff;font-weight:600;">' + (debtPct > 10 ? debtPct.toFixed(0) + '% Debt' : '') + '</div>';
        html += '<div style="height:' + pubPct + '%;background:#68d391;display:flex;align-items:center;justify-content:center;font-size:0.65rem;color:#fff;font-weight:600;">' + (pubPct > 10 ? pubPct.toFixed(0) + '% Public' : '') + '</div>';
        html += '<div style="height:' + eqPct + '%;background:#805ad5;display:flex;align-items:center;justify-content:center;font-size:0.65rem;color:#fff;font-weight:600;">' + (eqPct > 10 ? eqPct.toFixed(0) + '% Equity' : '') + '</div>';
        html += '</div></div>';
    });
    html += '</div>';

    html += '<div style="font-size:0.72rem;color:#718096;margin-top:1.25rem;">Source: <a href="https://www.kosmont.com/services/public-private-partnerships" target="_blank" style="color:#3182ce;">Kosmont P3 Advisory</a> | <a href="https://www.cacities.org/Resources-Documents/Member-Engagement/Professional-Departments/City-Attorneys/Library/2018/Spring-2018/5-2018-Spring-Public-Private-Partnerships.aspx" target="_blank" style="color:#3182ce;">CA League of Cities P3 Guide</a> | <a href="https://www.hcd.ca.gov/grants-and-funding" target="_blank" style="color:#3182ce;">HCD Funding Programs</a></div>';
    return html;
}

function renderP3StructuringTab(st) {
    var pp = getP3Params();
    var html = '<div class="deep-tab-panel">';
    html += '<div class="analysis-section"><h3>Public/Private Partnership Structuring</h3>';
    html += '<p style="font-size:0.78rem;color:#718096;margin-bottom:1rem;">Evaluate deal structures for public-private transactions. Compare ground lease, joint venture, fee simple disposition, and master developer frameworks to identify optimal risk-adjusted returns.</p>';

    html += '<div class="dt-controls"><div class="dt-controls-title">Adjust Capital Structure <button class="dt-reset-btn" onclick="resetP3()">Reset Defaults</button></div>';
    html += '<div class="dt-controls-grid">';
    html += buildP3Slider('debtRate', 'Debt Interest Rate', pp.debtRate, 4.0, 9.0, 0.25);
    html += buildP3Slider('publicReturnRate', 'Public Return Rate', pp.publicReturnRate, 2.0, 8.0, 0.5);
    html += buildP3Slider('glEquity', 'Ground Lease: Dev Equity', pp.glEquity, 15, 45, 5);
    html += buildP3Slider('jvEquity', 'JV: Dev Equity', pp.jvEquity, 10, 40, 5);
    html += buildP3Slider('jvDebt', 'JV: Senior Debt', pp.jvDebt, 50, 80, 5);
    html += buildP3Slider('fsEquity', 'Fee Simple: Dev Equity', pp.fsEquity, 15, 45, 5);
    html += buildP3Slider('fsDebt', 'Fee Simple: Senior Debt', pp.fsDebt, 50, 80, 5);
    html += buildP3Slider('mdEquity', 'Master Dev: Dev Equity', pp.mdEquity, 10, 35, 5);
    html += buildP3Slider('mdPublic', 'Master Dev: Public Contrib', pp.mdPublic, 5, 30, 5);
    html += buildP3Slider('mdDebt', 'Master Dev: Senior Debt', pp.mdDebt, 45, 75, 5);
    html += '</div></div>';

    html += '<div id="p3Content">' + buildP3Content() + '</div>';
    html += '</div></div>';
    return html;
}

// ===================================================================
//  TAB 21: INCENTIVE COMPARISON MATRIX
// ===================================================================
// Incentive Matrix state â€” tracks which programs are selected/applied
var incentiveMatrixSelections = null; // null = auto (all eligible selected)

function getIncentiveDefinitions(st) {
    var c = st.computed, a = st.assumptions;
    var totalDev = c.totalDev, noi = c.noi;
    var units = c.units || 0, isResidential = !!c.units;
    var affordableUnits = units > 0 ? Math.round(units * 0.15) : 0;
    var totalHard = c.totalHard;
    return [
        { id: 'toc', name: 'Transit-Oriented Communities (TOC)', category: 'Zoning', eligible: isResidential, description: 'Density bonus, reduced parking, height increases near transit per LAMC 12.22 A.31', financialImpact: Math.round(totalDev * 0.08), impactType: 'Cost Reduction', requirements: 'Within 1/2 mile of major transit, 8-25% affordable units', timeline: '6-12 months', source: 'https://planning.lacity.gov/plans-policies/transit-oriented-communities-affordable-housing', complexity: 'Medium' },
        { id: 'densityBonus', name: 'Density Bonus (Gov Code Â§65915)', category: 'Zoning', eligible: isResidential, description: 'Up to 50% density bonus + incentives/concessions for affordable housing', financialImpact: Math.round(noi * 0.35 / (c.capRate || 0.05)), impactType: 'Value Creation', requirements: '5-15% affordable units depending on income level', timeline: '3-6 months', source: 'https://www.hcd.ca.gov/policy-and-research/housing-policy-development/density-bonus', complexity: 'Low' },
        { id: 'lihtc', name: 'LIHTC (4% / 9%)', category: 'Tax Credit', eligible: isResidential && affordableUnits >= 5, description: '4% credits (as-of-right with bonds) or competitive 9% credits', financialImpact: Math.round(totalHard * affordableUnits / Math.max(units, 1) * 0.30 * 10), impactType: 'Equity Subsidy', requirements: '20% at 50% AMI or 40% at 60% AMI for 30+ years', timeline: '12-24 months (4%) / 18-36 months (9%)', source: 'https://www.treasurer.ca.gov/ctcac/tax.asp', complexity: 'High' },
        { id: 'welfare', name: 'Welfare Exemption (RTC Â§214)', category: 'Tax Exemption', eligible: isResidential && affordableUnits > 0, description: 'Property tax exemption proportional to units â‰¤80% AMI with nonprofit GP', financialImpact: Math.round(c.stabilizedValue * 0.0125 * (affordableUnits / Math.max(units, 1))), impactType: 'Annual Savings', requirements: 'Nonprofit general partner, units at â‰¤80% AMI, BOE-267-L filing', timeline: 'Annual (file by Feb 15)', source: 'https://www.boe.ca.gov/proptaxes/welfarevets.htm', complexity: 'Medium' },
        { id: 'eifd', name: 'EIFD Tax Increment', category: 'Public Finance', eligible: true, description: 'Enhanced Infrastructure Financing District captures property tax increment for 45 years', financialImpact: Math.round((c.stabilizedValue - c.landCost) * 0.01 * 0.75 * 30), impactType: '30-Yr Revenue', requirements: 'Public infrastructure nexus, participating taxing entities, voter approval if bonds', timeline: '18-36 months (formation)', source: 'https://leginfo.legislature.ca.gov/faces/billNavClient.xhtml?bill_id=201320140SB628', complexity: 'High' },
        { id: 'oz', name: 'Opportunity Zone (IRC Â§1400Z)', category: 'Tax Deferral', eligible: true, description: 'Capital gains tax deferral and potential exclusion for investments in designated census tracts', financialImpact: Math.round((c.stabilizedValue - totalDev) * 0.20), impactType: 'Tax Savings', requirements: 'Investment in designated OZ census tract, hold 10+ years', timeline: '10-year hold required', source: 'https://www.irs.gov/credits-deductions/businesses/opportunity-zones', complexity: 'Medium' },
        { id: 'nmtc', name: 'New Markets Tax Credit', category: 'Tax Credit', eligible: !isResidential, description: '39% tax credit over 7 years for investments in low-income communities', financialImpact: Math.round(totalDev * 0.25 * 0.39), impactType: 'Tax Credit', requirements: 'Located in qualifying census tract, CDFI allocation', timeline: '6-18 months', source: 'https://www.cdfifund.gov/programs-training/programs/new-markets-tax-credit', complexity: 'High' },
        { id: 'htc', name: 'Historic Tax Credit (HTC)', category: 'Tax Credit', eligible: (st.inp && st.inp.yearBuilt && st.inp.yearBuilt < 1977), description: '20% federal credit for certified rehabilitation of historic structures', financialImpact: Math.round(totalHard * 0.20), impactType: 'Tax Credit', requirements: 'National Register listing, certified rehabilitation, NPS Parts 1-3', timeline: '12-24 months', source: 'https://www.nps.gov/subjects/taxincentives/index.htm', complexity: 'High' },
        { id: 'sb35', name: 'SB 35 Streamlining', category: 'Entitlement', eligible: isResidential, description: 'Ministerial approval (no CEQA) for qualifying projects', financialImpact: Math.round(totalDev * 0.03), impactType: 'Time/Cost Savings', requirements: '10-50% affordable, prevailing wage, objective standards', timeline: '60-90 day approval', source: 'https://www.hcd.ca.gov/planning-and-community-development/housing-open-data-tools/sb-35-determination-summary', complexity: 'Medium' },
        { id: 'mills', name: 'Mills Act (Historic)', category: 'Tax Reduction', eligible: (st.inp && st.inp.yearBuilt && st.inp.yearBuilt < 1977), description: 'Property tax reduction to capitalized income value for designated historic properties', financialImpact: Math.round(c.stabilizedValue * 0.005), impactType: 'Annual Savings', requirements: 'Local historic designation, 10-year maintenance contract', timeline: '3-6 months', source: 'https://ohp.parks.ca.gov/?page_id=21412', complexity: 'Low' },
    ];
}

function toggleIncentive(id) {
    if (!incentiveMatrixSelections) {
        // Initialize from current eligible defaults
        var st = deepAnalysisState;
        if (!st) return;
        var incs = getIncentiveDefinitions(st);
        incentiveMatrixSelections = {};
        incs.forEach(function(inc) { incentiveMatrixSelections[inc.id] = inc.eligible; });
    }
    incentiveMatrixSelections[id] = !incentiveMatrixSelections[id];
    recalcIncentiveMatrix();
}

function selectAllIncentives(mode) {
    var st = deepAnalysisState;
    if (!st) return;
    var incs = getIncentiveDefinitions(st);
    if (!incentiveMatrixSelections) incentiveMatrixSelections = {};
    incs.forEach(function(inc) {
        if (mode === 'all') incentiveMatrixSelections[inc.id] = true;
        else if (mode === 'eligible') incentiveMatrixSelections[inc.id] = inc.eligible;
        else incentiveMatrixSelections[inc.id] = false;
    });
    recalcIncentiveMatrix();
}

function recalcIncentiveMatrix() {
    var container = document.getElementById('incentiveMatrixContent');
    if (!container) return;
    container.innerHTML = buildIncentiveMatrixContent();
}

function isIncentiveSelected(inc) {
    if (!incentiveMatrixSelections) return inc.eligible;
    return !!incentiveMatrixSelections[inc.id];
}

function buildIncentiveMatrixContent() {
    var st = deepAnalysisState;
    if (!st) return '';
    var c = st.computed;
    var fmt = function(v) { return '$' + Math.round(v).toLocaleString(); };
    var fmtM = function(v) { return v >= 1e6 ? '$' + (v / 1e6).toFixed(1) + 'M' : fmt(v); };
    var totalDev = c.totalDev;

    var incentives = getIncentiveDefinitions(st);
    var selected = incentives.filter(function(i) { return isIncentiveSelected(i); });
    var eligible = incentives.filter(function(i) { return i.eligible; });
    var selectedImpact = selected.reduce(function(sum, i) { return sum + i.financialImpact; }, 0);

    var html = '';

    // Summary cards
    html += '<div class="exec-summary-grid">';
    html += '<div class="exec-summary-card"><h4>Applied Programs</h4><div class="exec-metric-lg" style="color:#2b6cb0;">' + selected.length + ' of ' + incentives.length + '</div><div class="exec-metric-sub">' + eligible.length + ' eligible, ' + selected.length + ' selected</div></div>';
    html += '<div class="exec-summary-card"><h4>Selected Impact</h4><div class="exec-metric-lg" style="color:#276749;">' + fmtM(selectedImpact) + '</div><div class="exec-metric-sub">From applied incentives only</div></div>';
    html += '<div class="exec-summary-card"><h4>Impact as % of Dev Cost</h4><div class="exec-metric-lg">' + (totalDev > 0 ? (selectedImpact / totalDev * 100).toFixed(1) : '0') + '%</div><div class="exec-metric-sub">Selected incentives / total cost</div></div>';
    html += '<div class="exec-summary-card"><h4>Top Selected</h4><div class="exec-metric-lg" style="font-size:1rem;">' + (selected.length > 0 ? selected.sort(function(a, b) { return b.financialImpact - a.financialImpact; })[0].name.split('(')[0].trim() : 'None') + '</div><div class="exec-metric-sub">' + (selected.length > 0 ? fmtM(selected[0].financialImpact) + ' est. impact' : 'Select programs below') + '</div></div>';
    html += '</div>';

    // Quick select buttons
    html += '<div style="display:flex;gap:6px;margin-bottom:1rem;">';
    html += '<button onclick="selectAllIncentives(\'eligible\')" style="padding:4px 12px;font-size:0.72rem;border:1px solid #cbd5e0;border-radius:4px;background:#fff;cursor:pointer;">Eligible Only</button>';
    html += '<button onclick="selectAllIncentives(\'all\')" style="padding:4px 12px;font-size:0.72rem;border:1px solid #cbd5e0;border-radius:4px;background:#fff;cursor:pointer;">Select All</button>';
    html += '<button onclick="selectAllIncentives(\'none\')" style="padding:4px 12px;font-size:0.72rem;border:1px solid #cbd5e0;border-radius:4px;background:#fff;cursor:pointer;">Clear All</button>';
    html += '</div>';

    // Full comparison matrix with checkboxes
    html += '<div style="overflow-x:auto;"><table style="width:100%;border-collapse:collapse;font-size:0.72rem;">';
    html += '<thead><tr style="background:#edf2f7;">';
    html += '<th style="padding:6px 8px;text-align:center;width:36px;">Apply</th>';
    html += '<th style="padding:6px 8px;text-align:left;">Program</th>';
    html += '<th style="padding:6px 8px;text-align:center;">Category</th>';
    html += '<th style="padding:6px 8px;text-align:center;">Eligible?</th>';
    html += '<th style="padding:6px 8px;text-align:right;">Est. Impact</th>';
    html += '<th style="padding:6px 8px;text-align:center;">Type</th>';
    html += '<th style="padding:6px 8px;text-align:center;">Complexity</th>';
    html += '<th style="padding:6px 8px;text-align:left;">Key Requirements</th>';
    html += '<th style="padding:6px 8px;text-align:center;">Timeline</th>';
    html += '</tr></thead><tbody>';

    // Re-fetch without sort to preserve order
    var incList = getIncentiveDefinitions(st);
    incList.forEach(function(inc) {
        var sel = isIncentiveSelected(inc);
        var bg = sel ? '#f0fff4' : (inc.eligible ? '#fffff0' : '#f7fafc');
        var complexColor = inc.complexity === 'Low' ? '#38a169' : inc.complexity === 'Medium' ? '#d69e2e' : '#e53e3e';
        html += '<tr style="background:' + bg + ';border-bottom:1px solid #e2e8f0;' + (sel ? '' : 'opacity:0.7;') + '">';
        html += '<td style="padding:6px 8px;text-align:center;"><input type="checkbox" ' + (sel ? 'checked' : '') + ' onchange="toggleIncentive(\'' + inc.id + '\')" style="accent-color:#38a169;cursor:pointer;width:16px;height:16px;"></td>';
        html += '<td style="padding:6px 8px;font-weight:600;"><a href="' + inc.source + '" target="_blank" style="color:#3182ce;text-decoration:none;">' + inc.name + '</a></td>';
        html += '<td style="padding:6px 8px;text-align:center;"><span style="background:#edf2f7;padding:2px 6px;border-radius:4px;font-size:0.68rem;">' + inc.category + '</span></td>';
        html += '<td style="padding:6px 8px;text-align:center;">' + (inc.eligible ? '<span style="color:#38a169;font-weight:700;">âœ“ Yes</span>' : '<span style="color:#a0aec0;">âœ— No</span>') + '</td>';
        html += '<td style="padding:6px 8px;text-align:right;font-weight:600;color:' + (sel ? '#276749' : '#a0aec0') + ';">' + fmtM(inc.financialImpact) + '</td>';
        html += '<td style="padding:6px 8px;text-align:center;font-size:0.68rem;">' + inc.impactType + '</td>';
        html += '<td style="padding:6px 8px;text-align:center;color:' + complexColor + ';font-weight:600;">' + inc.complexity + '</td>';
        html += '<td style="padding:6px 8px;font-size:0.68rem;">' + inc.requirements + '</td>';
        html += '<td style="padding:6px 8px;text-align:center;font-size:0.68rem;">' + inc.timeline + '</td>';
        html += '</tr>';
    });
    html += '</tbody></table></div>';

    // Stacking analysis
    html += '<h4 style="font-size:0.88rem;color:var(--text);margin:1.5rem 0 0.75rem;">Incentive Stacking Analysis</h4>';
    html += '<p style="font-size:0.75rem;color:#718096;margin-bottom:0.75rem;">Many incentives can be combined ("stacked") to maximize total financial benefit. Common stacking combinations for LA transit-oriented projects:</p>';
    var stacks = [
        { name: 'Affordable TOD Stack', combo: 'TOC + Density Bonus + SB 35 + Welfare Exemption', suited: 'Multifamily affordable near transit', impact: 'Highest density + tax savings + fast entitlement' },
        { name: 'LIHTC Full Stack', combo: '4% LIHTC + Tax-Exempt Bonds + Welfare Exemption + EIFD', suited: '100% affordable projects', impact: 'Maximum subsidy + ongoing tax relief' },
        { name: 'Mixed-Use Stack', combo: 'TOC + Density Bonus + Opportunity Zone + NMTC', suited: 'Mixed-use in low-income areas', impact: 'Tax deferral + credits + density' },
        { name: 'Adaptive Reuse Stack', combo: 'Historic Tax Credit + Mills Act + Opportunity Zone', suited: 'Pre-1977 buildings in OZ tracts', impact: '20% rehab credit + reduced taxes + gains exclusion' },
    ];
    html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;">';
    stacks.forEach(function(s) {
        html += '<div style="background:#f7fafc;border:1px solid #e2e8f0;border-radius:8px;padding:0.75rem;">';
        html += '<h5 style="font-size:0.78rem;margin:0 0 0.3rem;color:#2d3748;">' + s.name + '</h5>';
        html += '<div style="font-size:0.7rem;color:#4a5568;margin-bottom:0.3rem;"><strong>Programs:</strong> ' + s.combo + '</div>';
        html += '<div style="font-size:0.7rem;color:#4a5568;margin-bottom:0.3rem;"><strong>Best for:</strong> ' + s.suited + '</div>';
        html += '<div style="font-size:0.7rem;color:#276749;"><strong>Impact:</strong> ' + s.impact + '</div>';
        html += '</div>';
    });
    html += '</div>';

    html += '<div style="font-size:0.72rem;color:#718096;margin-top:1.25rem;">Sources: <a href="https://www.treasurer.ca.gov/ctcac/" target="_blank" style="color:#3182ce;">CTCAC</a> | <a href="https://www.hcd.ca.gov/grants-and-funding" target="_blank" style="color:#3182ce;">HCD Funding</a> | <a href="https://www.irs.gov/credits-deductions/businesses/opportunity-zones" target="_blank" style="color:#3182ce;">IRS Opportunity Zones</a> | <a href="https://www.cdfifund.gov/programs-training/programs/new-markets-tax-credit" target="_blank" style="color:#3182ce;">CDFI NMTC</a></div>';
    return html;
}

function renderIncentiveMatrixTab(st) {
    var html = '<div class="deep-tab-panel">';
    html += '<div class="analysis-section"><h3>Development Incentive Matrix</h3>';
    html += '<p style="font-size:0.78rem;color:#718096;margin-bottom:1rem;">Select which incentive programs to apply to your analysis. Check/uncheck programs to see their combined financial impact. Only eligible programs are pre-selected by default.</p>';
    html += '<div id="incentiveMatrixContent">';
    html += buildIncentiveMatrixContent();
    html += '</div>';
    html += '</div></div>';
    return html;
}

// ===================================================================
//  TAB 22: DEVELOPMENT AGREEMENT TERM SHEET
// ===================================================================
// Dev Agreement dynamic controls
var DA_DEFAULTS = {
    vestingYears: 15, affordablePct: 15, communityBenefitPct: 2.0,
    impactFeePct: 3.5, parkDedicationPct: 5, annualReviewPct: 0.05,
    commenceMonths: 24
};
var daOverrides = null;

function getDAParams() {
    var d = DA_DEFAULTS, o = daOverrides || {};
    var r = {};
    Object.keys(d).forEach(function(k) { r[k] = o[k] != null ? o[k] : d[k]; });
    return r;
}

function buildDASlider(id, label, val, min, max, step, suffix) {
    suffix = suffix || '%';
    var dec = step < 1 ? (step < 0.01 ? 2 : 1) : 0;
    var h = '<div class="dt-slider-group">';
    h += '<div class="dt-slider-label"><span>' + label + '</span><span class="dt-val" id="da2-' + id + '-val">' + val.toFixed(dec) + suffix + '</span></div>';
    h += '<div class="dt-slider-row">';
    h += '<input type="range" id="da2-' + id + '-slider" min="' + min + '" max="' + max + '" step="' + step + '" value="' + val + '" oninput="document.getElementById(\'da2-' + id + '\').value=this.value;recalcDevAgreement()">';
    h += '<input type="number" id="da2-' + id + '" min="' + min + '" max="' + max + '" step="' + step + '" value="' + val + '" oninput="document.getElementById(\'da2-' + id + '-slider\').value=this.value;recalcDevAgreement()">';
    h += '</div></div>';
    return h;
}

function recalcDevAgreement() {
    if (!daOverrides) daOverrides = {};
    Object.keys(DA_DEFAULTS).forEach(function(f) {
        var el = document.getElementById('da2-' + f);
        if (el) daOverrides[f] = parseFloat(el.value);
    });
    Object.keys(DA_DEFAULTS).forEach(function(f) {
        var slider = document.getElementById('da2-' + f + '-slider');
        var num = document.getElementById('da2-' + f);
        if (slider && num && document.activeElement === slider) num.value = slider.value;
        if (slider && num && document.activeElement === num) slider.value = num.value;
        var valSpan = document.getElementById('da2-' + f + '-val');
        if (valSpan && num) {
            var v = parseFloat(num.value);
            var isYr = (f === 'vestingYears' || f === 'commenceMonths');
            var suffix = isYr ? (f === 'vestingYears' ? ' yr' : ' mo') : '%';
            var dec = DA_DEFAULTS[f] % 1 ? (DA_DEFAULTS[f] < 0.1 ? 2 : 1) : 0;
            valSpan.textContent = v.toFixed(dec) + suffix;
        }
    });
    _debouncedCall('devAgreement', function() {
        var container = document.getElementById('devAgreementContent');
        if (container) container.innerHTML = buildDevAgreementContent();
    }, 150);
}

function resetDevAgreement() {
    daOverrides = null;
    Object.keys(DA_DEFAULTS).forEach(function(f) {
        var slider = document.getElementById('da2-' + f + '-slider');
        var num = document.getElementById('da2-' + f);
        if (slider) slider.value = DA_DEFAULTS[f];
        if (num) num.value = DA_DEFAULTS[f];
    });
    recalcDevAgreement();
}

function buildDevAgreementContent() {
    var st = deepAnalysisState;
    if (!st) return '';
    var c = st.computed;
    var fmt = function(v) { return '$' + Math.round(v).toLocaleString(); };
    var fmtM = function(v) { return v >= 1e6 ? '$' + (v / 1e6).toFixed(1) + 'M' : fmt(v); };
    var dp = getDAParams();

    var totalDev = c.totalDev;
    var units = c.units || 0;
    var isResidential = !!c.units;
    var affordUnits = Math.round(units * (dp.affordablePct / 100));
    var parkDedication = Math.round((st.inp ? st.inp.parcelSize : 10000) * (dp.parkDedicationPct / 100));
    var impactFees = Math.round(totalDev * (dp.impactFeePct / 100));
    var communityBenefitBudget = Math.round(totalDev * (dp.communityBenefitPct / 100));

    var html = '';

    // Key terms
    var terms = [
        { term: 'Vesting Period', value: dp.vestingYears + ' years', desc: 'Term during which project is vested against changes in law. Standard range: 10-20 years. Longer terms for phased projects.' },
        { term: 'Permitted Uses', value: st.bestUse ? (LAND_USES.find(function(u) { return u.id === st.bestUse; }) || {}).name || 'Mixed-Use' : 'Mixed-Use', desc: 'All uses permitted under the DA, including primary and ancillary uses as defined in project approvals.' },
        { term: 'Maximum Density', value: units > 0 ? units + ' units' : c.nsf.toLocaleString() + ' NSF', desc: 'Maximum development intensity vested by the DA. May include phase-specific caps.' },
        { term: 'Maximum Height', value: c.buildingHeight + ' ft / ' + c.stories + ' stories', desc: 'Building height as approved in project entitlements. Height may vary by phase or building.' },
        { term: 'FAR', value: c.far.toFixed(2), desc: 'Floor Area Ratio as entitled. DA vests this FAR against future downzoning.' },
        { term: 'Parking Requirement', value: c.parkingSpaces + ' spaces', desc: 'Parking count as negotiated. May include in-lieu fee options or shared parking arrangements.' },
        { term: 'Affordable Housing', value: affordUnits + ' units (' + (units > 0 ? Math.round(affordUnits / units * 100) : 0) + '%)', desc: 'Affordable units or in-lieu fee per inclusionary housing ordinance. Income targeting as specified.' },
        { term: 'Impact Fees', value: fmt(impactFees), desc: 'Total development impact fees (park, school, traffic, art, linkage). May be frozen at DA execution date.' },
        { term: 'Community Benefits', value: fmt(communityBenefitBudget), desc: 'Developer-funded community benefits package: local hire, public improvements, community space, etc.' },
        { term: 'Annual Review Fee', value: fmt(Math.round(totalDev * (dp.annualReviewPct / 100))), desc: 'Annual fee to city for DA compliance monitoring and review.' },
        { term: 'Construction Commencement', value: dp.commenceMonths + ' months from DA effective date', desc: 'Deadline to commence substantial construction. Extensions available for force majeure.' },
        { term: 'Phasing', value: c.gsf > 200000 ? '2-3 phases over 5-7 years' : 'Single phase', desc: 'Construction phasing plan with milestones and deadlines per phase.' },
    ];

    html += '<div class="exec-summary-grid">';
    html += '<div class="exec-summary-card"><h4>Project Value</h4><div class="exec-metric-lg">' + fmtM(c.stabilizedValue) + '</div><div class="exec-metric-sub">Vested at stabilization</div></div>';
    html += '<div class="exec-summary-card"><h4>Community Benefits</h4><div class="exec-metric-lg">' + fmtM(communityBenefitBudget) + '</div><div class="exec-metric-sub">~' + dp.communityBenefitPct.toFixed(1) + '% of total dev cost</div></div>';
    html += '<div class="exec-summary-card"><h4>Impact Fees</h4><div class="exec-metric-lg">' + fmtM(impactFees) + '</div><div class="exec-metric-sub">Frozen at DA execution</div></div>';
    html += '<div class="exec-summary-card"><h4>Vesting Period</h4><div class="exec-metric-lg">' + dp.vestingYears + ' Years</div><div class="exec-metric-sub">Protection against law changes</div></div>';
    html += '</div>';

    html += '<h4 style="font-size:0.88rem;color:var(--text);margin:1.5rem 0 0.75rem;">DA Term Sheet</h4>';
    html += '<div style="overflow-x:auto;"><table style="width:100%;border-collapse:collapse;font-size:0.75rem;">';
    html += '<thead><tr style="background:#edf2f7;"><th style="padding:8px;text-align:left;width:25%;">Term</th><th style="padding:8px;text-align:left;width:20%;">Value</th><th style="padding:8px;text-align:left;">Description</th></tr></thead><tbody>';
    terms.forEach(function(t) {
        html += '<tr style="border-bottom:1px solid #e2e8f0;">';
        html += '<td style="padding:8px;font-weight:600;">' + t.term + '</td>';
        html += '<td style="padding:8px;color:#2d3748;">' + t.value + '</td>';
        html += '<td style="padding:8px;color:#718096;font-size:0.72rem;">' + t.desc + '</td>';
        html += '</tr>';
    });
    html += '</tbody></table></div>';

    var benefits = [
        { item: 'Local Hire Program', pct: 30, value: Math.round(communityBenefitBudget * 0.30), desc: '30% local hire requirement for construction and permanent jobs' },
        { item: 'Public Open Space / Park', pct: 20, value: Math.round(communityBenefitBudget * 0.20), desc: parkDedication.toLocaleString() + ' SF park dedication or in-lieu fee' },
        { item: 'Community Meeting Space', pct: 15, value: Math.round(communityBenefitBudget * 0.15), desc: 'Dedicated community room available for public use' },
        { item: 'Street/Sidewalk Improvements', pct: 20, value: Math.round(communityBenefitBudget * 0.20), desc: 'Frontage improvements, street trees, bike lanes, lighting' },
        { item: 'Public Art', pct: 10, value: Math.round(communityBenefitBudget * 0.10), desc: 'Per Cultural Affairs Dept. requirement (1% of building permit valuation)' },
        { item: 'Sustainability Measures', pct: 5, value: Math.round(communityBenefitBudget * 0.05), desc: 'EV charging, solar, green building certifications beyond code minimum' },
    ];

    html += '<h4 style="font-size:0.88rem;color:var(--text);margin:1.5rem 0 0.75rem;">Community Benefits Package</h4>';
    html += '<div style="overflow-x:auto;"><table style="width:100%;border-collapse:collapse;font-size:0.75rem;">';
    html += '<thead><tr style="background:#f0fff4;"><th style="padding:6px 8px;text-align:left;">Benefit</th><th style="padding:6px 8px;text-align:right;">Est. Value</th><th style="padding:6px 8px;text-align:center;">% of Package</th><th style="padding:6px 8px;text-align:left;">Description</th></tr></thead><tbody>';
    benefits.forEach(function(b) {
        html += '<tr style="border-bottom:1px solid #e2e8f0;">';
        html += '<td style="padding:6px 8px;font-weight:600;">' + b.item + '</td>';
        html += '<td style="padding:6px 8px;text-align:right;">' + fmt(b.value) + '</td>';
        html += '<td style="padding:6px 8px;text-align:center;">' + b.pct + '%</td>';
        html += '<td style="padding:6px 8px;color:#718096;font-size:0.72rem;">' + b.desc + '</td>';
        html += '</tr>';
    });
    html += '</tbody></table></div>';

    var steps = [
        { step: 1, name: 'Pre-Application Conference', duration: '1-2 months', desc: 'Meet with Planning Dept to discuss DA scope, community benefits, and key terms' },
        { step: 2, name: 'DA Application Filing', duration: '1 month', desc: 'File formal DA application with term sheet, community benefits plan, and environmental review' },
        { step: 3, name: 'Environmental Review (CEQA)', duration: '6-18 months', desc: 'EIR or Mitigated Negative Declaration as applicable. SB 35 may exempt CEQA.' },
        { step: 4, name: 'Negotiation Period', duration: '3-6 months', desc: 'Negotiate terms with City Attorney, Planning, and Council District office' },
        { step: 5, name: 'Planning Commission Hearing', duration: '1-2 months', desc: 'Public hearing and recommendation to City Council' },
        { step: 6, name: 'City Council Approval', duration: '1-3 months', desc: 'Final legislative action. DA becomes effective 30 days after publication.' },
        { step: 7, name: 'DA Recordation', duration: '1 month', desc: 'Record DA against property. Vesting rights commence upon recordation.' },
    ];

    html += '<h4 style="font-size:0.88rem;color:var(--text);margin:1.5rem 0 0.75rem;">DA Approval Process</h4>';
    html += '<div style="display:flex;flex-direction:column;gap:0.5rem;">';
    steps.forEach(function(s) {
        html += '<div style="display:flex;align-items:center;gap:0.75rem;padding:0.5rem;background:#f7fafc;border-radius:6px;">';
        html += '<div style="min-width:28px;height:28px;background:#4299e1;color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.75rem;font-weight:700;">' + s.step + '</div>';
        html += '<div style="flex:1;"><div style="font-size:0.78rem;font-weight:600;color:#2d3748;">' + s.name + '</div><div style="font-size:0.7rem;color:#718096;">' + s.desc + '</div></div>';
        html += '<div style="font-size:0.72rem;color:#4a5568;font-weight:600;white-space:nowrap;">' + s.duration + '</div>';
        html += '</div>';
    });
    html += '</div>';

    html += '<div style="font-size:0.72rem;color:#718096;margin-top:1.25rem;">Source: <a href="https://planning.lacity.gov/development-services/development-agreements" target="_blank" style="color:#3182ce;">LA City Planning â€” Development Agreements</a> | <a href="https://leginfo.legislature.ca.gov/faces/codes_displaySection.xhtml?sectionNum=65864.&lawCode=GOV" target="_blank" style="color:#3182ce;">Gov. Code Â§65864-65869.5</a> | <a href="https://www.kosmont.com/services/development-agreements" target="_blank" style="color:#3182ce;">Kosmont DA Advisory</a></div>';
    return html;
}

function renderDevAgreementTab(st) {
    var dp = getDAParams();
    var html = '<div class="deep-tab-panel">';
    html += '<div class="analysis-section"><h3>Development Agreement Key Terms</h3>';
    html += '<p style="font-size:0.78rem;color:#718096;margin-bottom:1rem;">Framework for negotiating a Development Agreement (DA) with the local jurisdiction. DAs vest development rights and provide certainty on fees, standards, and community benefits in exchange for public commitments.</p>';

    html += '<div class="dt-controls"><div class="dt-controls-title">Adjust DA Terms <button class="dt-reset-btn" onclick="resetDevAgreement()">Reset Defaults</button></div>';
    html += '<div class="dt-controls-grid">';
    html += buildDASlider('vestingYears', 'Vesting Period', dp.vestingYears, 5, 25, 1, ' yr');
    html += buildDASlider('affordablePct', 'Affordable Housing %', dp.affordablePct, 0, 40, 1);
    html += buildDASlider('communityBenefitPct', 'Community Benefits % of Dev Cost', dp.communityBenefitPct, 0.5, 5.0, 0.5);
    html += buildDASlider('impactFeePct', 'Impact Fees % of Dev Cost', dp.impactFeePct, 1.0, 7.0, 0.5);
    html += buildDASlider('parkDedicationPct', 'Park Dedication % of Site', dp.parkDedicationPct, 2, 15, 1);
    html += buildDASlider('annualReviewPct', 'Annual Review Fee %', dp.annualReviewPct, 0.01, 0.10, 0.01);
    html += buildDASlider('commenceMonths', 'Construction Start Deadline', dp.commenceMonths, 12, 48, 6, ' mo');
    html += '</div></div>';

    html += '<div id="devAgreementContent">' + buildDevAgreementContent() + '</div>';
    html += '</div></div>';
    return html;
}

// ===================================================================
//  TAB 23: ASSET STRATEGY (HOLD / SELL / REFI)
// ===================================================================
// Asset Strategy defaults â€” used for initial render and reset
var ASSET_STRATEGY_DEFAULTS = {
    equityPct: 35, debtRate: 6.5, noiGrowth: 3.0,
    capRateCompress: 0.15, dispositionCost: 2.5, refiLTV: 75, taxRate: 25
};
var assetStrategyOverrides = null; // null = use defaults

function getAssetStrategyParams() {
    var d = ASSET_STRATEGY_DEFAULTS;
    var o = assetStrategyOverrides || {};
    return {
        equityPct:       o.equityPct       != null ? o.equityPct       : d.equityPct,
        debtRate:        o.debtRate        != null ? o.debtRate        : d.debtRate,
        noiGrowth:       o.noiGrowth       != null ? o.noiGrowth       : d.noiGrowth,
        capRateCompress: o.capRateCompress != null ? o.capRateCompress : d.capRateCompress,
        dispositionCost: o.dispositionCost != null ? o.dispositionCost : d.dispositionCost,
        refiLTV:         o.refiLTV         != null ? o.refiLTV         : d.refiLTV,
        taxRate:         o.taxRate         != null ? o.taxRate         : d.taxRate,
    };
}

function recalcAssetStrategy() {
    if (!assetStrategyOverrides) assetStrategyOverrides = {};
    // Read all slider/input values
    var fields = ['equityPct','debtRate','noiGrowth','capRateCompress','dispositionCost','refiLTV','taxRate'];
    fields.forEach(function(f) {
        var el = document.getElementById('as-' + f);
        if (el) assetStrategyOverrides[f] = parseFloat(el.value);
    });
    // Sync sliders â†” number inputs
    fields.forEach(function(f) {
        var slider = document.getElementById('as-' + f + '-slider');
        var num = document.getElementById('as-' + f);
        if (slider && num && document.activeElement === slider) num.value = slider.value;
        if (slider && num && document.activeElement === num) slider.value = num.value;
        // Update display value
        var valSpan = document.getElementById('as-' + f + '-val');
        if (valSpan && num) valSpan.textContent = parseFloat(num.value).toFixed(f === 'capRateCompress' ? 2 : 1) + '%';
    });
    // Re-render content only (debounced)
    _debouncedCall('assetStrategy', function() {
        var container = document.getElementById('assetStrategyContent');
        if (container) container.innerHTML = buildAssetStrategyContent();
    }, 150);
}

function resetAssetStrategy() {
    assetStrategyOverrides = null;
    recalcAssetStrategy();
    // Re-sync slider positions to defaults
    var p = getAssetStrategyParams();
    Object.keys(p).forEach(function(f) {
        var slider = document.getElementById('as-' + f + '-slider');
        var num = document.getElementById('as-' + f);
        if (slider) slider.value = p[f];
        if (num) num.value = p[f];
        var valSpan = document.getElementById('as-' + f + '-val');
        if (valSpan) valSpan.textContent = p[f].toFixed(f === 'capRateCompress' ? 2 : 1) + '%';
    });
}

function buildAssetStrategySlider(id, label, val, min, max, step) {
    var dec = (id === 'capRateCompress') ? 2 : 1;
    var h = '<div class="dt-slider-group">';
    h += '<div class="dt-slider-label"><span>' + label + '</span><span class="dt-val" id="as-' + id + '-val">' + val.toFixed(dec) + '%</span></div>';
    h += '<div class="dt-slider-row">';
    h += '<input type="range" id="as-' + id + '-slider" min="' + min + '" max="' + max + '" step="' + step + '" value="' + val + '" oninput="document.getElementById(\'as-' + id + '\').value=this.value;recalcAssetStrategy()">';
    h += '<input type="number" id="as-' + id + '" min="' + min + '" max="' + max + '" step="' + step + '" value="' + val + '" oninput="document.getElementById(\'as-' + id + '-slider\').value=this.value;recalcAssetStrategy()">';
    h += '</div></div>';
    return h;
}

function buildAssetStrategyContent() {
    var st = deepAnalysisState;
    if (!st) return '';
    var c = st.computed, a = st.assumptions;
    var fmt = function(v) { return '$' + Math.round(v).toLocaleString(); };
    var fmtM = function(v) { return v >= 1e6 ? '$' + (v / 1e6).toFixed(1) + 'M' : fmt(v); };
    var p = getAssetStrategyParams();

    var totalDev = c.totalDev;
    var noi = c.noi;
    var capRate = c.capRate || 0.05;
    var equity = Math.round(totalDev * (p.equityPct / 100));
    var debt = totalDev - equity;
    var debtRate = p.debtRate / 100;
    var debtService = Math.round(debt * debtRate);
    var noiGrowth = p.noiGrowth / 100;
    var capRateCompression = p.capRateCompress / 100;
    var dispositionCost = p.dispositionCost / 100;
    var refiLTV = p.refiLTV / 100;
    var taxRate = p.taxRate / 100;

    var years = [];
    var cumCashFlow = 0;
    for (var yr = 1; yr <= 10; yr++) {
        var projNOI = Math.round(noi * Math.pow(1 + noiGrowth, yr));
        var exitCap = Math.max(capRate - capRateCompression * yr, 0.035);
        var exitValue = Math.round(projNOI / exitCap);
        var netSaleProceeds = Math.round(exitValue * (1 - dispositionCost) - debt);
        var annualCF = projNOI - debtService;
        cumCashFlow += annualCF;
        var totalReturn = netSaleProceeds + cumCashFlow;
        var equityMultiple = equity > 0 ? totalReturn / equity : 0;
        var annualizedIRR = equity > 0 ? Math.pow(Math.max(totalReturn / equity, 0), 1 / yr) - 1 : 0;
        var refiValue = Math.round(exitValue * refiLTV);
        var refiProceeds = refiValue - debt;
        years.push({
            year: yr, noi: projNOI, cashFlow: annualCF, cumCashFlow: cumCashFlow,
            exitCap: exitCap, exitValue: exitValue, netSaleProceeds: netSaleProceeds,
            totalReturn: totalReturn, equityMultiple: equityMultiple, irr: annualizedIRR,
            refiValue: refiValue, refiProceeds: refiProceeds,
            cashOnCash: equity > 0 ? annualCF / equity : 0,
        });
    }

    var bestIRRYear = years.reduce(function(best, y) { return y.irr > best.irr ? y : best; }, years[0]);
    var bestMultYear = years[years.length - 1];

    var html = '';
    // Summary cards
    html += '<div class="exec-summary-grid">';
    html += '<div class="exec-summary-card"><h4>Initial Equity</h4><div class="exec-metric-lg">' + fmtM(equity) + '</div><div class="exec-metric-sub">' + Math.round(equity / totalDev * 100) + '% of total dev cost</div></div>';
    html += '<div class="exec-summary-card"><h4>Optimal Exit (IRR)</h4><div class="exec-metric-lg">Year ' + bestIRRYear.year + '</div><div class="exec-metric-sub">' + (bestIRRYear.irr * 100).toFixed(1) + '% annualized IRR</div></div>';
    html += '<div class="exec-summary-card"><h4>10-Yr Equity Multiple</h4><div class="exec-metric-lg">' + bestMultYear.equityMultiple.toFixed(2) + 'x</div><div class="exec-metric-sub">' + fmtM(bestMultYear.totalReturn) + ' total return</div></div>';
    html += '<div class="exec-summary-card"><h4>Year 1 Cash-on-Cash</h4><div class="exec-metric-lg">' + (years[0].cashOnCash * 100).toFixed(1) + '%</div><div class="exec-metric-sub">' + fmtM(years[0].cashFlow) + ' annual cash flow</div></div>';
    html += '</div>';

    // Hold analysis table
    html += '<h4 style="font-size:0.88rem;color:var(--text);margin:1.5rem 0 0.75rem;">10-Year Hold Analysis</h4>';
    html += '<div style="overflow-x:auto;"><table style="width:100%;border-collapse:collapse;font-size:0.72rem;">';
    html += '<thead><tr style="background:#edf2f7;">';
    html += '<th style="padding:6px;text-align:center;">Year</th><th style="padding:6px;text-align:right;">NOI</th>';
    html += '<th style="padding:6px;text-align:right;">Cash Flow</th><th style="padding:6px;text-align:right;">Cash-on-Cash</th>';
    html += '<th style="padding:6px;text-align:right;">Exit Cap</th><th style="padding:6px;text-align:right;">Exit Value</th>';
    html += '<th style="padding:6px;text-align:right;">Net Proceeds</th><th style="padding:6px;text-align:right;">Equity Multiple</th>';
    html += '<th style="padding:6px;text-align:right;">IRR</th>';
    html += '</tr></thead><tbody>';
    years.forEach(function(y) {
        var isBest = y.year === bestIRRYear.year;
        var bg = isBest ? '#f0fff4' : (y.year % 2 === 0 ? '#f7fafc' : '#fff');
        html += '<tr style="background:' + bg + ';border-bottom:1px solid #e2e8f0;' + (isBest ? 'font-weight:600;' : '') + '">';
        html += '<td style="padding:6px;text-align:center;">' + y.year + (isBest ? ' â˜…' : '') + '</td>';
        html += '<td style="padding:6px;text-align:right;">' + fmtM(y.noi) + '</td>';
        html += '<td style="padding:6px;text-align:right;">' + fmtM(y.cashFlow) + '</td>';
        html += '<td style="padding:6px;text-align:right;">' + (y.cashOnCash * 100).toFixed(1) + '%</td>';
        html += '<td style="padding:6px;text-align:right;">' + (y.exitCap * 100).toFixed(2) + '%</td>';
        html += '<td style="padding:6px;text-align:right;">' + fmtM(y.exitValue) + '</td>';
        html += '<td style="padding:6px;text-align:right;color:' + (y.netSaleProceeds > 0 ? '#276749' : '#c53030') + ';">' + fmtM(y.netSaleProceeds) + '</td>';
        html += '<td style="padding:6px;text-align:right;">' + y.equityMultiple.toFixed(2) + 'x</td>';
        html += '<td style="padding:6px;text-align:right;color:' + (y.irr > 0.12 ? '#276749' : y.irr > 0.08 ? '#d69e2e' : '#c53030') + ';">' + (y.irr * 100).toFixed(1) + '%</td>';
        html += '</tr>';
    });
    html += '</tbody></table></div>';

    // Strategy comparison at Year 5
    html += '<h4 style="font-size:0.88rem;color:var(--text);margin:1.5rem 0 0.75rem;">Strategy Comparison at Year 5</h4>';
    var y5 = years[4];
    var strategies = [
        {
            name: 'Hold & Operate',
            desc: 'Continue operations, collect cash flow, build equity through NOI growth and debt paydown.',
            metric1Label: 'Cumulative Cash Flow', metric1Value: fmtM(y5.cumCashFlow),
            metric2Label: 'Avg Cash-on-Cash',
            metric2Value: (years.slice(0, 5).reduce(function(s, y) { return s + y.cashOnCash; }, 0) / 5 * 100).toFixed(1) + '%',
            recommendation: noi > debtService * 1.25 ? 'Recommended â€” Strong DSCR' : 'Caution â€” Tight DSCR',
            recColor: noi > debtService * 1.25 ? '#276749' : '#d69e2e',
        },
        {
            name: 'Sell / Dispose',
            desc: 'Sell asset at market cap rate. Realize gains, return equity to investors, 1031 exchange option.',
            metric1Label: 'Net Sale Proceeds', metric1Value: fmtM(y5.netSaleProceeds),
            metric2Label: 'Total Return (incl CF)', metric2Value: y5.equityMultiple.toFixed(2) + 'x equity',
            recommendation: y5.irr > 0.15 ? 'Attractive exit â€” Strong IRR' : 'Consider holding for value growth',
            recColor: y5.irr > 0.15 ? '#276749' : '#d69e2e',
        },
        {
            name: 'Refinance & Hold',
            desc: 'Cash-out refinance at higher stabilized value. Return equity while retaining ownership.',
            metric1Label: 'Refi Proceeds', metric1Value: fmtM(y5.refiProceeds),
            metric2Label: 'Equity Returned',
            metric2Value: (equity > 0 ? (y5.refiProceeds / equity * 100).toFixed(0) : '0') + '% of equity',
            recommendation: y5.refiProceeds > equity ? 'Full equity return possible' : 'Partial equity return â€” hold for appreciation',
            recColor: y5.refiProceeds > equity ? '#276749' : '#d69e2e',
        },
    ];

    html += '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem;">';
    strategies.forEach(function(s) {
        html += '<div style="background:#f7fafc;border:1px solid #e2e8f0;border-radius:8px;padding:1rem;">';
        html += '<h5 style="font-size:0.82rem;margin:0 0 0.5rem;color:#2d3748;">' + s.name + '</h5>';
        html += '<p style="font-size:0.7rem;color:#718096;margin-bottom:0.75rem;">' + s.desc + '</p>';
        html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;margin-bottom:0.5rem;">';
        html += '<div><div style="font-size:0.65rem;color:#a0aec0;">' + s.metric1Label + '</div><div style="font-size:1rem;font-weight:700;color:#2d3748;">' + s.metric1Value + '</div></div>';
        html += '<div><div style="font-size:0.65rem;color:#a0aec0;">' + s.metric2Label + '</div><div style="font-size:1rem;font-weight:700;color:#2d3748;">' + s.metric2Value + '</div></div>';
        html += '</div>';
        html += '<div style="font-size:0.72rem;color:' + s.recColor + ';font-weight:600;border-top:1px solid #e2e8f0;padding-top:0.5rem;">' + s.recommendation + '</div>';
        html += '</div>';
    });
    html += '</div>';

    // 1031 Exchange
    html += '<h4 style="font-size:0.88rem;color:var(--text);margin:1.5rem 0 0.75rem;">1031 Exchange Considerations</h4>';
    html += '<div style="background:#fffff0;border:1px solid #ecc94b;border-radius:8px;padding:1rem;font-size:0.75rem;">';
    html += '<div style="font-weight:600;margin-bottom:0.5rem;color:#744210;">Tax-Deferred Exchange (IRC Â§1031)</div>';
    html += '<ul style="margin:0;padding-left:1.25rem;color:#744210;">';
    html += '<li><strong>45-Day Identification:</strong> Must identify replacement property within 45 days of closing</li>';
    html += '<li><strong>180-Day Closing:</strong> Must close on replacement property within 180 days</li>';
    html += '<li><strong>Like-Kind:</strong> Real property for real property (held for investment or business use)</li>';
    html += '<li><strong>Qualified Intermediary:</strong> Required to hold proceeds â€” cannot take constructive receipt</li>';
    html += '<li><strong>Estimated Tax Deferred:</strong> <strong style="color:#276749;">' + fmtM(Math.round(y5.netSaleProceeds * taxRate)) + '</strong> (at ' + (taxRate * 100).toFixed(0) + '% effective rate)</li>';
    html += '</ul></div>';

    html += '<div style="font-size:0.72rem;color:#718096;margin-top:1.25rem;">Source: <a href="https://www.irs.gov/newsroom/like-kind-exchanges-real-estate-tax-tips" target="_blank" style="color:#3182ce;">IRS Â§1031 Guide</a> | <a href="https://www.ftb.ca.gov/forms/misc/1100.html" target="_blank" style="color:#3182ce;">CA FTB 1031 Reporting</a> | <a href="https://www.kosmont.com/services/asset-management" target="_blank" style="color:#3182ce;">Kosmont Asset Management</a></div>';
    return html;
}

function renderAssetStrategyTab(st) {
    var p = getAssetStrategyParams();
    var html = '<div class="deep-tab-panel">';
    html += '<div class="analysis-section"><h3>Asset Management Strategy</h3>';
    html += '<p style="font-size:0.78rem;color:#718096;margin-bottom:1rem;">Post-stabilization strategy analysis comparing hold, sell, and refinance scenarios. Adjust assumptions below to model different exit strategies.</p>';

    // Slider control panel
    html += '<div class="dt-controls">';
    html += '<div class="dt-controls-title"><span>Assumptions</span><button class="dt-reset-btn" onclick="resetAssetStrategy()">Reset Defaults</button></div>';
    html += '<div class="dt-controls-grid">';
    html += buildAssetStrategySlider('equityPct',       'Equity %',              p.equityPct,       10, 100, 1);
    html += buildAssetStrategySlider('debtRate',        'Debt Rate',             p.debtRate,        3,  12,  0.1);
    html += buildAssetStrategySlider('noiGrowth',       'NOI Growth / Yr',       p.noiGrowth,       0,  8,   0.25);
    html += buildAssetStrategySlider('capRateCompress', 'Cap Rate Compress / Yr', p.capRateCompress, 0,  0.5, 0.01);
    html += buildAssetStrategySlider('dispositionCost', 'Disposition Cost',       p.dispositionCost, 0,  5,   0.25);
    html += buildAssetStrategySlider('refiLTV',         'Refi LTV',              p.refiLTV,         50, 85,  1);
    html += buildAssetStrategySlider('taxRate',         'Effective Tax Rate',     p.taxRate,         10, 45,  1);
    html += '</div></div>';

    // Dynamic content area
    html += '<div id="assetStrategyContent">';
    html += buildAssetStrategyContent();
    html += '</div>';

    html += '</div></div>';
    return html;
}

// Close modals on Escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        if (document.getElementById('deepAnalysisModal').style.display === 'block') {
            closeDeepAnalysis();
            return;
        }
        const legModal = document.getElementById('legDetailModal');
        if (legModal && legModal.style.display !== 'none') {
            closeLegislationDetail();
            return;
        }
        if (document.getElementById('analysisModal').style.display === 'block') {
            closeAnalysis();
        }
    }
});

// ============================================================
//  TAB 26: INVESTOR MODULE â€” GP/LP Capital Stack & Waterfall
// ============================================================

function calcIRR(cashFlows, guess) {
    // Newton-Raphson IRR calculation
    // cashFlows[0] = negative (equity invested), cashFlows[1..n] = distributions
    if (!cashFlows || cashFlows.length < 2) return 0;
    var rate = guess || 0.10;
    for (var iter = 0; iter < 200; iter++) {
        var npv = 0, dnpv = 0;
        for (var i = 0; i < cashFlows.length; i++) {
            var denom = Math.pow(1 + rate, i);
            if (denom === 0) break;
            npv += cashFlows[i] / denom;
            dnpv -= i * cashFlows[i] / Math.pow(1 + rate, i + 1);
        }
        if (Math.abs(dnpv) < 1e-12) break;
        var newRate = rate - npv / dnpv;
        if (Math.abs(newRate - rate) < 1e-8) return newRate;
        rate = newRate;
        if (rate < -0.99) rate = -0.5;
        if (rate > 10) rate = 2;
    }
    return rate;
}

function getInvestorCashFlowData(c) {
    // Investor Module NOI growth override takes priority, then CF tab, then default
    var invNoiGrowthEl = document.getElementById('inv-noiGrowth');
    var revGrowth = invNoiGrowthEl && invNoiGrowthEl.value ? (parseFloat(invNoiGrowthEl.value) / 100 || 0.03) : (parseFloat((document.getElementById('cf-revGrowth') || {}).value) / 100 || 0.03);
    var expGrowth = parseFloat((document.getElementById('cf-expGrowth') || {}).value) / 100 || 0.025;
    var vacancyRate = parseFloat((document.getElementById('cf-vacancy') || {}).value) / 100 || 0.05;
    var capexRate = parseFloat((document.getElementById('cf-capex') || {}).value) / 100 || 0.03;
    var mgmtRate = parseFloat((document.getElementById('cf-mgmt') || {}).value) / 100 || 0.04;

    var baseRevenue = c.grossRevenue;
    var baseOpex = c.opex;
    var years = [];
    for (var yr = 1; yr <= 10; yr++) {
        var gpRevenue = Math.round(baseRevenue * Math.pow(1 + revGrowth, yr));
        var vacancy = Math.round(gpRevenue * vacancyRate);
        var egi = gpRevenue - vacancy;
        var mgmtFee = Math.round(egi * mgmtRate);
        var opex = Math.round(baseOpex * Math.pow(1 + expGrowth, yr));
        var capex = Math.round(gpRevenue * capexRate);
        var totalExpenses = opex + mgmtFee + capex;
        var noi = egi - totalExpenses;
        years.push({ year: yr, noi: noi, egi: egi });
    }
    return years;
}

function syncGPLP(source) {
    var gpEl = document.getElementById('inv-gpPct');
    var lpEl = document.getElementById('inv-lpPct');
    if (!gpEl || !lpEl) return;
    if (source === 'gp') {
        var gp = parseFloat(gpEl.value) || 0;
        lpEl.value = Math.max(1, Math.min(99, 100 - gp));
    } else {
        var lp = parseFloat(lpEl.value) || 0;
        gpEl.value = Math.max(1, Math.min(99, 100 - lp));
    }
}

function buildCapitalStack(c) {
    var totalDev = c.totalDev;
    var seniorLTV = parseFloat((document.getElementById('inv-seniorLTV') || {}).value) / 100 || 0.65;
    var seniorRate = parseFloat((document.getElementById('inv-seniorRate') || {}).value) / 100 || 0.065;
    var seniorAmort = parseInt((document.getElementById('inv-seniorAmort') || {}).value) || 30;
    var seniorIO = parseInt((document.getElementById('inv-seniorIO') || {}).value) || 0;

    var hasMezz = document.getElementById('inv-mezzToggle') && document.getElementById('inv-mezzToggle').checked;
    var mezzAmt = hasMezz ? (parseFloat((document.getElementById('inv-mezzAmt') || {}).value) || 0) : 0;
    var mezzRate = hasMezz ? (parseFloat((document.getElementById('inv-mezzRate') || {}).value) / 100 || 0.12) : 0;

    var seniorLoan = Math.round(totalDev * seniorLTV);
    var totalEquity = totalDev - seniorLoan - mezzAmt;
    if (totalEquity < 0) totalEquity = 0;

    var gpPct = parseFloat((document.getElementById('inv-gpPct') || {}).value) / 100 || 0.10;
    var gpEquity = Math.round(totalEquity * gpPct);
    var lpEquity = totalEquity - gpEquity;

    // Amortizing debt service calculation
    var monthlyRate = seniorRate / 12;
    var nPayments = seniorAmort * 12;
    var monthlyPayment = monthlyRate > 0 ? seniorLoan * (monthlyRate * Math.pow(1 + monthlyRate, nPayments)) / (Math.pow(1 + monthlyRate, nPayments) - 1) : seniorLoan / nPayments;
    var annualDS = Math.round(monthlyPayment * 12);
    var ioDS = Math.round(seniorLoan * seniorRate);

    return {
        totalDev: totalDev,
        seniorLoan: seniorLoan,
        seniorLTV: seniorLTV,
        seniorRate: seniorRate,
        seniorAmort: seniorAmort,
        seniorIO: seniorIO,
        annualDS: annualDS,
        ioDS: ioDS,
        mezzAmt: mezzAmt,
        mezzRate: mezzRate,
        hasMezz: hasMezz,
        totalEquity: totalEquity,
        gpPct: gpPct,
        gpEquity: gpEquity,
        lpEquity: lpEquity,
    };
}

function getDefaultWaterfallTiers() {
    return [
        { name: 'Return of Capital', hurdle: 0, lpPct: 100, gpPct: 0, isROC: true },
        { name: 'Preferred Return', hurdle: 8, lpPct: 100, gpPct: 0 },
        { name: 'First Promote', hurdle: 12, lpPct: 80, gpPct: 20 },
        { name: 'Second Promote', hurdle: 18, lpPct: 60, gpPct: 40 },
        { name: 'Above Hurdle', hurdle: 99, lpPct: 50, gpPct: 50 },
    ];
}

var investorWaterfallTiers = null;

function getWaterfallTiers() {
    if (!investorWaterfallTiers) investorWaterfallTiers = getDefaultWaterfallTiers();
    // Read from DOM if inputs exist
    for (var i = 0; i < investorWaterfallTiers.length; i++) {
        var hEl = document.getElementById('wf-hurdle-' + i);
        var lpEl = document.getElementById('wf-lp-' + i);
        var gpEl = document.getElementById('wf-gp-' + i);
        if (hEl) investorWaterfallTiers[i].hurdle = parseFloat(hEl.value) || 0;
        if (lpEl) investorWaterfallTiers[i].lpPct = parseFloat(lpEl.value) || 0;
        if (gpEl) investorWaterfallTiers[i].gpPct = parseFloat(gpEl.value) || 0;
    }
    return investorWaterfallTiers;
}

function computeWaterfall(years, cap, tiers, exitYear) {
    // Distribute annual operating CF and exit proceeds through waterfall
    var lpEquity = cap.lpEquity;
    var lpCapitalAccount = lpEquity; // outstanding unreturned capital
    var lpCumDist = 0, gpCumDist = 0;
    var result = [];

    for (var yr = 1; yr <= 10; yr++) {
        var yrData = years[yr - 1];
        var ds = yr <= cap.seniorIO ? cap.ioDS : cap.annualDS;
        var mezzDS = cap.hasMezz ? Math.round(cap.mezzAmt * cap.mezzRate) : 0;
        var cfAfterDS = yrData.noi - ds - mezzDS;
        var isExit = (yr === exitYear);
        var exitCap = parseFloat((document.getElementById('inv-exitCap') || {}).value) / 100 || 0.05;
        var exitValue = isExit ? Math.round(yrData.noi / exitCap) : 0;
        var dispCost = isExit ? Math.round(exitValue * 0.025) : 0;
        // Remaining loan balance (simplified: IO periods don't reduce principal, amortizing does slightly)
        var loanBal = cap.seniorLoan; // simplified for IO-heavy short holds
        var netSaleProceeds = isExit ? (exitValue - dispCost - loanBal - cap.mezzAmt) : 0;

        var distributable = cfAfterDS + (isExit ? netSaleProceeds : 0);
        if (distributable < 0) distributable = 0;

        var lpDist = 0, gpDist = 0;
        var remaining = distributable;

        for (var t = 0; t < tiers.length && remaining > 0; t++) {
            var tier = tiers[t];
            var lpShare = tier.lpPct / 100;
            var gpShare = tier.gpPct / 100;

            if (tier.isROC) {
                // Return of capital: distribute until LP capital account = 0
                var rocNeeded = lpCapitalAccount;
                if (rocNeeded <= 0) continue;
                var rocDist = Math.min(remaining, rocNeeded);
                lpDist += rocDist;
                remaining -= rocDist;
                continue;
            }

            // Check if current IRR hurdle is already met
            // Build hypothetical LP cash flows to test
            var testLPFlows = [-lpEquity];
            for (var py = 0; py < yr - 1; py++) {
                testLPFlows.push(result[py] ? result[py].lpDist : 0);
            }
            testLPFlows.push(lpCumDist + lpDist + remaining * lpShare);
            var testIRR = calcIRR(testLPFlows) * 100;

            if (testIRR <= tier.hurdle || t === tiers.length - 1) {
                // Still in this tier â€” distribute at this tier's split
                var lpAmt = Math.round(remaining * lpShare);
                var gpAmt = remaining - lpAmt;
                lpDist += lpAmt;
                gpDist += gpAmt;
                remaining = 0;
            } else {
                // Hurdle exceeded, move to next tier
                continue;
            }
        }

        lpCapitalAccount = Math.max(0, lpCapitalAccount - lpDist);
        lpCumDist += lpDist;
        gpCumDist += gpDist;

        result.push({
            year: yr,
            noi: yrData.noi,
            debtService: ds + mezzDS,
            cfAfterDS: cfAfterDS,
            exitProceeds: isExit ? netSaleProceeds : 0,
            totalDistributable: cfAfterDS + (isExit ? netSaleProceeds : 0),
            lpDist: lpDist,
            gpDist: gpDist,
            lpCumDist: lpCumDist,
            gpCumDist: gpCumDist,
            isExit: isExit,
        });

        if (isExit) break;
    }

    // Compute LP and GP IRR
    var lpFlows = [-lpEquity];
    var gpFlows = [-cap.gpEquity];
    var dealFlows = [-(cap.totalEquity)];
    for (var i = 0; i < result.length; i++) {
        lpFlows.push(result[i].lpDist);
        gpFlows.push(result[i].gpDist);
        dealFlows.push(result[i].lpDist + result[i].gpDist);
    }

    return {
        years: result,
        lpIRR: calcIRR(lpFlows),
        gpIRR: cap.gpEquity > 0 ? calcIRR(gpFlows) : 0,
        dealIRR: calcIRR(dealFlows),
        lpMultiple: lpEquity > 0 ? lpCumDist / lpEquity : 0,
        gpMultiple: cap.gpEquity > 0 ? gpCumDist / cap.gpEquity : 0,
        dealMultiple: cap.totalEquity > 0 ? (lpCumDist + gpCumDist) / cap.totalEquity : 0,
        lpTotalDist: lpCumDist,
        gpTotalDist: gpCumDist,
        gpPromote: gpCumDist - (cap.totalEquity > 0 ? (lpCumDist + gpCumDist) * cap.gpPct : 0),
    };
}

function renderInvestorModuleTab(st) {
    var c = st.computed, a = st.assumptions;
    var fmt = function(v) { return '$' + Math.round(v).toLocaleString(); };
    var fmtM = function(v) { return v >= 1e6 ? '$' + (v / 1e6).toFixed(2) + 'M' : fmt(v); };
    var pct = function(v) { return (v * 100).toFixed(1) + '%'; };

    var html = '<div class="deep-tab-panel">';
    html += '<div class="analysis-section">';
    html += '<h3>Investor Module â€” GP/LP Capital Stack & Waterfall</h3>';
    html += '<p style="font-size:0.78rem;color:#718096;margin-bottom:1rem;">Model GP/LP equity structures, preferred returns, and promote waterfalls. Produce investor-ready return summaries for capital raising.</p>';

    // â”€â”€ SECTION 1: Capital Stack Editor â”€â”€
    html += '<div style="background:#f7fafc;border:1px solid #e2e8f0;border-radius:8px;padding:1rem;margin-bottom:1.25rem;">';
    html += '<h4 style="font-size:0.85rem;margin:0 0 0.75rem;color:#2d3748;">Capital Stack</h4>';
    html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:0.75rem;margin-bottom:1rem;">';

    html += '<div><label style="font-size:0.7rem;color:#718096;display:block;">Senior Debt LTV</label><input type="number" id="inv-seniorLTV" value="65" step="5" min="0" max="85" style="width:100%;padding:4px 8px;border:1px solid #cbd5e0;border-radius:4px;font-size:0.78rem;" oninput="recalcInvestorModule()"> <span style="font-size:0.65rem;color:#a0aec0;">%</span></div>';
    html += '<div><label style="font-size:0.7rem;color:#718096;display:block;">Senior Rate</label><input type="number" id="inv-seniorRate" value="6.5" step="0.25" min="3" max="12" style="width:100%;padding:4px 8px;border:1px solid #cbd5e0;border-radius:4px;font-size:0.78rem;" oninput="recalcInvestorModule()"> <span style="font-size:0.65rem;color:#a0aec0;">%</span></div>';
    html += '<div><label style="font-size:0.7rem;color:#718096;display:block;">Amortization</label><input type="number" id="inv-seniorAmort" value="30" step="5" min="10" max="40" style="width:100%;padding:4px 8px;border:1px solid #cbd5e0;border-radius:4px;font-size:0.78rem;" oninput="recalcInvestorModule()"> <span style="font-size:0.65rem;color:#a0aec0;">years</span></div>';
    html += '<div><label style="font-size:0.7rem;color:#718096;display:block;">IO Period</label><input type="number" id="inv-seniorIO" value="2" step="1" min="0" max="10" style="width:100%;padding:4px 8px;border:1px solid #cbd5e0;border-radius:4px;font-size:0.78rem;" oninput="recalcInvestorModule()"> <span style="font-size:0.65rem;color:#a0aec0;">years</span></div>';

    html += '<div><label style="font-size:0.7rem;color:#38a169;display:block;font-weight:600;">GP Equity %</label><input type="number" id="inv-gpPct" value="10" step="1" min="1" max="99" style="width:100%;padding:4px 8px;border:1.5px solid #38a169;border-radius:4px;font-size:0.78rem;background:#f0fff4;" oninput="syncGPLP(\'gp\');recalcInvestorModule()"> <span style="font-size:0.65rem;color:#38a169;">% of equity</span></div>';
    html += '<div><label style="font-size:0.7rem;color:#2b6cb0;display:block;font-weight:600;">LP Equity %</label><input type="number" id="inv-lpPct" value="90" step="1" min="1" max="99" style="width:100%;padding:4px 8px;border:1.5px solid #3182ce;border-radius:4px;font-size:0.78rem;background:#ebf8ff;" oninput="syncGPLP(\'lp\');recalcInvestorModule()"> <span style="font-size:0.65rem;color:#2b6cb0;">% of equity</span></div>';
    html += '<div><label style="font-size:0.7rem;color:#718096;display:block;">Exit Cap Rate</label><input type="number" id="inv-exitCap" value="' + ((c.capRate || 0.05) * 100 + 0.25).toFixed(2) + '" step="0.25" min="2" max="12" style="width:100%;padding:4px 8px;border:1px solid #cbd5e0;border-radius:4px;font-size:0.78rem;" oninput="recalcInvestorModule()"> <span style="font-size:0.65rem;color:#a0aec0;">%</span></div>';
    html += '<div><label style="font-size:0.7rem;color:#718096;display:block;">NOI Growth / Yr</label><input type="number" id="inv-noiGrowth" value="3.0" step="0.25" min="0" max="10" style="width:100%;padding:4px 8px;border:1px solid #cbd5e0;border-radius:4px;font-size:0.78rem;" oninput="recalcInvestorModule()"> <span style="font-size:0.65rem;color:#a0aec0;">%</span></div>';
    html += '<div><label style="font-size:0.7rem;color:#718096;display:block;">Exit Year</label><select id="inv-exitYear" style="width:100%;padding:4px 8px;border:1px solid #cbd5e0;border-radius:4px;font-size:0.78rem;" onchange="recalcInvestorModule()"><option value="3">Year 3</option><option value="5" selected>Year 5</option><option value="7">Year 7</option><option value="10">Year 10</option></select></div>';

    // Mezz toggle
    html += '<div style="display:flex;align-items:center;gap:0.5rem;padding-top:0.8rem;"><label style="font-size:0.7rem;color:#718096;">Mezz/Pref Equity</label><input type="checkbox" id="inv-mezzToggle" onchange="recalcInvestorModule();document.getElementById(\'inv-mezzInputs\').style.display=this.checked?\'flex\':\'none\';"></div>';
    html += '</div>';

    // Mezz inputs (hidden by default)
    html += '<div id="inv-mezzInputs" style="display:none;gap:0.75rem;margin-bottom:0.75rem;">';
    html += '<div><label style="font-size:0.7rem;color:#718096;display:block;">Mezz Amount</label><input type="number" id="inv-mezzAmt" value="0" step="100000" min="0" style="width:140px;padding:4px 8px;border:1px solid #cbd5e0;border-radius:4px;font-size:0.78rem;" oninput="recalcInvestorModule()"></div>';
    html += '<div><label style="font-size:0.7rem;color:#718096;display:block;">Mezz Rate</label><input type="number" id="inv-mezzRate" value="12" step="0.5" min="5" max="25" style="width:100px;padding:4px 8px;border:1px solid #cbd5e0;border-radius:4px;font-size:0.78rem;" oninput="recalcInvestorModule()"> <span style="font-size:0.65rem;color:#a0aec0;">%</span></div>';
    html += '</div>';

    // Capital stack visual bar (rendered dynamically)
    html += '<div id="inv-capStackBar"></div>';
    html += '</div>';

    // â”€â”€ SECTION 2: Waterfall Structure â”€â”€
    html += '<div style="background:#fffff0;border:1px solid #e2e8f0;border-radius:8px;padding:1rem;margin-bottom:1.25rem;">';
    html += '<h4 style="font-size:0.85rem;margin:0 0 0.75rem;color:#2d3748;">Waterfall Structure <span style="font-size:0.7rem;color:#718096;font-weight:400;">(editable tiers)</span></h4>';
    html += '<div id="inv-waterfallEditor"></div>';
    html += '<div style="margin-top:0.5rem;"><button onclick="addWaterfallTier()" style="font-size:0.7rem;padding:3px 10px;border:1px solid #cbd5e0;border-radius:4px;background:#fff;cursor:pointer;margin-right:0.5rem;">+ Add Tier</button><button onclick="resetWaterfallTiers()" style="font-size:0.7rem;padding:3px 10px;border:1px solid #cbd5e0;border-radius:4px;background:#fff;cursor:pointer;">Reset to Default</button></div>';
    html += '</div>';

    // â”€â”€ SECTION 3: Year-by-Year GP/LP Cash Flow (dynamic) â”€â”€
    html += '<div id="inv-waterfallTable" style="margin-bottom:1.25rem;"></div>';

    // â”€â”€ SECTION 4: Return Summary Cards (dynamic) â”€â”€
    html += '<div id="inv-returnSummary" style="margin-bottom:1.25rem;"></div>';

    // â”€â”€ SECTION 5: Debt Scenario Comparison (dynamic) â”€â”€
    html += '<div id="inv-debtScenarios" style="margin-bottom:1.25rem;"></div>';

    // â”€â”€ SECTION 6: Generate Investor Summary Button â”€â”€
    html += '<div style="text-align:center;margin:1.5rem 0;"><button onclick="generateInvestorSummary()" style="padding:10px 28px;background:linear-gradient(135deg,#2b6cb0,#3182ce);color:#fff;border:none;border-radius:6px;font-size:0.85rem;font-weight:600;cursor:pointer;box-shadow:0 2px 8px rgba(49,130,206,0.3);">Generate Investor Summary</button></div>';

    html += '</div></div>';

    // Schedule initial render after DOM insert
    setTimeout(function() { recalcInvestorModule(); }, 50);

    return html;
}

function recalcInvestorModule() {
    _debouncedCall('investor', _recalcInvestorModuleImpl, 200);
}
function _recalcInvestorModuleImpl() {
    var st = deepAnalysisState;
    if (!st) return;
    var c = st.computed;
    var fmt = function(v) { return '$' + Math.round(v).toLocaleString(); };
    var fmtM = function(v) { return v >= 1e6 ? '$' + (v / 1e6).toFixed(2) + 'M' : fmt(v); };
    var pct = function(v) { return isFinite(v) ? (v * 100).toFixed(1) + '%' : 'N/A'; };

    var cap = buildCapitalStack(c);
    var tiers = getWaterfallTiers();
    var exitYear = parseInt((document.getElementById('inv-exitYear') || {}).value) || 5;
    var years = getInvestorCashFlowData(c);
    var wf = computeWaterfall(years, cap, tiers, exitYear);

    // â”€â”€ Capital Stack Bar â”€â”€
    var barEl = document.getElementById('inv-capStackBar');
    if (barEl) {
        var total = cap.totalDev || 1;
        var debtPct = (cap.seniorLoan / total * 100).toFixed(1);
        var mezzPct = (cap.mezzAmt / total * 100).toFixed(1);
        var gpPct = (cap.gpEquity / total * 100).toFixed(1);
        var lpPct = (cap.lpEquity / total * 100).toFixed(1);

        var bh = '';
        bh += '<div style="display:flex;height:32px;border-radius:6px;overflow:hidden;margin-bottom:0.5rem;font-size:0.65rem;font-weight:600;color:#fff;">';
        if (cap.seniorLoan > 0) bh += '<div style="width:' + debtPct + '%;background:#e53e3e;display:flex;align-items:center;justify-content:center;min-width:40px;" title="Senior Debt: ' + fmtM(cap.seniorLoan) + '">Debt ' + debtPct + '%</div>';
        if (cap.mezzAmt > 0) bh += '<div style="width:' + mezzPct + '%;background:#ed8936;display:flex;align-items:center;justify-content:center;min-width:40px;" title="Mezz: ' + fmtM(cap.mezzAmt) + '">Mezz ' + mezzPct + '%</div>';
        if (cap.gpEquity > 0) bh += '<div style="width:' + gpPct + '%;background:#38a169;display:flex;align-items:center;justify-content:center;min-width:40px;" title="GP Equity: ' + fmtM(cap.gpEquity) + '">GP ' + gpPct + '%</div>';
        if (cap.lpEquity > 0) bh += '<div style="width:' + lpPct + '%;background:#3182ce;display:flex;align-items:center;justify-content:center;min-width:40px;" title="LP Equity: ' + fmtM(cap.lpEquity) + '">LP ' + lpPct + '%</div>';
        bh += '</div>';

        bh += '<div style="display:flex;gap:1rem;flex-wrap:wrap;font-size:0.72rem;">';
        bh += '<div><span style="display:inline-block;width:10px;height:10px;background:#e53e3e;border-radius:2px;margin-right:4px;"></span>Senior Debt: <strong>' + fmtM(cap.seniorLoan) + '</strong> (' + debtPct + '%) @ ' + (cap.seniorRate * 100).toFixed(1) + '% | DS: ' + fmtM(cap.annualDS) + '/yr</div>';
        if (cap.hasMezz && cap.mezzAmt > 0) bh += '<div><span style="display:inline-block;width:10px;height:10px;background:#ed8936;border-radius:2px;margin-right:4px;"></span>Mezz/Pref: <strong>' + fmtM(cap.mezzAmt) + '</strong> (' + mezzPct + '%) @ ' + (cap.mezzRate * 100).toFixed(1) + '%</div>';
        bh += '<div><span style="display:inline-block;width:10px;height:10px;background:#38a169;border-radius:2px;margin-right:4px;"></span>GP Equity: <strong>' + fmtM(cap.gpEquity) + '</strong> (' + gpPct + '% of total)</div>';
        bh += '<div><span style="display:inline-block;width:10px;height:10px;background:#3182ce;border-radius:2px;margin-right:4px;"></span>LP Equity: <strong>' + fmtM(cap.lpEquity) + '</strong> (' + lpPct + '% of total)</div>';
        bh += '</div>';
        barEl.innerHTML = bh;
    }

    // â”€â”€ Waterfall Editor â”€â”€
    var wfEdEl = document.getElementById('inv-waterfallEditor');
    if (wfEdEl) {
        var wh = '<table style="width:100%;border-collapse:collapse;font-size:0.72rem;">';
        wh += '<thead><tr style="background:#fefcbf;"><th style="padding:5px 8px;text-align:left;">Tier</th><th style="padding:5px 8px;text-align:left;">Description</th><th style="padding:5px 8px;text-align:center;">IRR Hurdle (%)</th><th style="padding:5px 8px;text-align:center;">LP %</th><th style="padding:5px 8px;text-align:center;">GP %</th><th style="padding:5px 8px;text-align:center;"></th></tr></thead><tbody>';
        for (var i = 0; i < tiers.length; i++) {
            var t = tiers[i];
            wh += '<tr style="border-bottom:1px solid #e2e8f0;">';
            wh += '<td style="padding:5px 8px;font-weight:600;">' + (i + 1) + '</td>';
            wh += '<td style="padding:5px 8px;">' + t.name + '</td>';
            if (t.isROC) {
                wh += '<td style="padding:5px 8px;text-align:center;color:#718096;">1.0x Capital</td>';
            } else {
                wh += '<td style="padding:5px 8px;text-align:center;"><input type="number" id="wf-hurdle-' + i + '" value="' + t.hurdle + '" step="1" min="0" max="99" style="width:55px;padding:2px 6px;border:1px solid #cbd5e0;border-radius:3px;text-align:center;font-size:0.72rem;" oninput="recalcInvestorModule()">%</td>';
            }
            wh += '<td style="padding:5px 8px;text-align:center;"><input type="number" id="wf-lp-' + i + '" value="' + t.lpPct + '" step="5" min="0" max="100" style="width:55px;padding:2px 6px;border:1px solid #cbd5e0;border-radius:3px;text-align:center;font-size:0.72rem;" oninput="recalcInvestorModule()">%</td>';
            wh += '<td style="padding:5px 8px;text-align:center;"><input type="number" id="wf-gp-' + i + '" value="' + t.gpPct + '" step="5" min="0" max="100" style="width:55px;padding:2px 6px;border:1px solid #cbd5e0;border-radius:3px;text-align:center;font-size:0.72rem;" oninput="recalcInvestorModule()">%</td>';
            wh += '<td style="padding:5px 8px;text-align:center;">' + (tiers.length > 2 ? '<button onclick="removeWaterfallTier(' + i + ')" style="font-size:0.65rem;color:#c53030;border:none;background:none;cursor:pointer;" title="Remove tier">&#x2715;</button>' : '') + '</td>';
            wh += '</tr>';
        }
        wh += '</tbody></table>';
        wfEdEl.innerHTML = wh;
    }

    // â”€â”€ Year-by-Year Waterfall Table â”€â”€
    var wtEl = document.getElementById('inv-waterfallTable');
    if (wtEl) {
        var th = '<h4 style="font-size:0.85rem;margin:0 0 0.5rem;color:#2d3748;">Year-by-Year GP/LP Cash Flow Distribution</h4>';
        th += '<div style="overflow-x:auto;"><table style="width:100%;border-collapse:collapse;font-size:0.70rem;white-space:nowrap;">';
        th += '<thead><tr style="background:#edf2f7;">';
        th += '<th style="padding:5px 8px;text-align:center;">Year</th>';
        th += '<th style="padding:5px 8px;text-align:right;">NOI</th>';
        th += '<th style="padding:5px 8px;text-align:right;">Debt Service</th>';
        th += '<th style="padding:5px 8px;text-align:right;">CF After DS</th>';
        th += '<th style="padding:5px 8px;text-align:right;">Exit Proceeds</th>';
        th += '<th style="padding:5px 8px;text-align:right;font-weight:700;">Total Dist.</th>';
        th += '<th style="padding:5px 8px;text-align:right;color:#3182ce;">LP Dist.</th>';
        th += '<th style="padding:5px 8px;text-align:right;color:#38a169;">GP Dist.</th>';
        th += '<th style="padding:5px 8px;text-align:right;color:#3182ce;">LP Cumul.</th>';
        th += '<th style="padding:5px 8px;text-align:right;color:#38a169;">GP Cumul.</th>';
        th += '</tr></thead><tbody>';

        // Year 0 row (equity investment)
        th += '<tr style="background:#fff8f0;border-bottom:1px solid #e2e8f0;font-weight:600;">';
        th += '<td style="padding:5px 8px;text-align:center;">0</td>';
        th += '<td colspan="4" style="padding:5px 8px;text-align:right;color:#718096;">Equity Invested</td>';
        th += '<td style="padding:5px 8px;text-align:right;">(' + fmtM(cap.totalEquity) + ')</td>';
        th += '<td style="padding:5px 8px;text-align:right;color:#3182ce;">(' + fmtM(cap.lpEquity) + ')</td>';
        th += '<td style="padding:5px 8px;text-align:right;color:#38a169;">(' + fmtM(cap.gpEquity) + ')</td>';
        th += '<td style="padding:5px 8px;text-align:right;">â€”</td>';
        th += '<td style="padding:5px 8px;text-align:right;">â€”</td>';
        th += '</tr>';

        for (var i = 0; i < wf.years.length; i++) {
            var y = wf.years[i];
            var bg = y.isExit ? '#f0fff4' : (y.year % 2 === 0 ? '#f7fafc' : '#fff');
            th += '<tr style="background:' + bg + ';border-bottom:1px solid #e2e8f0;' + (y.isExit ? 'font-weight:600;' : '') + '">';
            th += '<td style="padding:5px 8px;text-align:center;">' + y.year + (y.isExit ? ' (Exit)' : '') + '</td>';
            th += '<td style="padding:5px 8px;text-align:right;">' + fmt(y.noi) + '</td>';
            th += '<td style="padding:5px 8px;text-align:right;">(' + fmt(y.debtService) + ')</td>';
            th += '<td style="padding:5px 8px;text-align:right;">' + fmt(y.cfAfterDS) + '</td>';
            th += '<td style="padding:5px 8px;text-align:right;">' + (y.exitProceeds > 0 ? fmtM(y.exitProceeds) : 'â€”') + '</td>';
            th += '<td style="padding:5px 8px;text-align:right;font-weight:700;">' + fmtM(y.lpDist + y.gpDist) + '</td>';
            th += '<td style="padding:5px 8px;text-align:right;color:#3182ce;">' + fmtM(y.lpDist) + '</td>';
            th += '<td style="padding:5px 8px;text-align:right;color:#38a169;">' + fmtM(y.gpDist) + '</td>';
            th += '<td style="padding:5px 8px;text-align:right;color:#3182ce;">' + fmtM(y.lpCumDist) + '</td>';
            th += '<td style="padding:5px 8px;text-align:right;color:#38a169;">' + fmtM(y.gpCumDist) + '</td>';
            th += '</tr>';
        }
        th += '</tbody></table></div>';
        wtEl.innerHTML = th;
    }

    // â”€â”€ Return Summary Cards â”€â”€
    var rsEl = document.getElementById('inv-returnSummary');
    if (rsEl) {
        var y1cfads = wf.years.length > 0 ? wf.years[0].cfAfterDS : 0;
        var y1coc = cap.totalEquity > 0 ? y1cfads / cap.totalEquity : 0;

        var rh = '<h4 style="font-size:0.85rem;margin:0 0 0.75rem;color:#2d3748;">Return Summary</h4>';
        rh += '<div class="exec-summary-grid" style="grid-template-columns:repeat(3,1fr);">';

        // LP Card
        rh += '<div style="background:#ebf8ff;border:1px solid #bee3f8;border-radius:8px;padding:1rem;">';
        rh += '<h4 style="font-size:0.8rem;color:#2b6cb0;margin:0 0 0.5rem;">LP Returns</h4>';
        rh += '<div style="font-size:1.3rem;font-weight:700;color:#2b6cb0;">' + pct(wf.lpIRR) + ' IRR</div>';
        rh += '<div style="font-size:0.75rem;color:#4a5568;margin-top:0.3rem;">' + wf.lpMultiple.toFixed(2) + 'x Equity Multiple</div>';
        rh += '<div style="font-size:0.75rem;color:#4a5568;">Year 1 CoC: ' + pct(y1coc) + '</div>';
        rh += '<div style="font-size:0.75rem;color:#4a5568;">Total Distributions: ' + fmtM(wf.lpTotalDist) + '</div>';
        rh += '<div style="font-size:0.68rem;color:#718096;margin-top:0.3rem;">On ' + fmtM(cap.lpEquity) + ' invested</div>';
        rh += '</div>';

        // GP Card
        rh += '<div style="background:#f0fff4;border:1px solid #c6f6d5;border-radius:8px;padding:1rem;">';
        rh += '<h4 style="font-size:0.8rem;color:#276749;margin:0 0 0.5rem;">GP Returns</h4>';
        rh += '<div style="font-size:1.3rem;font-weight:700;color:#276749;">' + pct(wf.gpIRR) + ' IRR</div>';
        rh += '<div style="font-size:0.75rem;color:#4a5568;margin-top:0.3rem;">' + wf.gpMultiple.toFixed(2) + 'x Equity Multiple</div>';
        rh += '<div style="font-size:0.75rem;color:#4a5568;">Promote Earned: ' + fmtM(Math.max(0, wf.gpPromote)) + '</div>';
        rh += '<div style="font-size:0.75rem;color:#4a5568;">Total Distributions: ' + fmtM(wf.gpTotalDist) + '</div>';
        rh += '<div style="font-size:0.68rem;color:#718096;margin-top:0.3rem;">On ' + fmtM(cap.gpEquity) + ' invested</div>';
        rh += '</div>';

        // Deal-Level Card
        rh += '<div style="background:#faf5ff;border:1px solid #e9d8fd;border-radius:8px;padding:1rem;">';
        rh += '<h4 style="font-size:0.8rem;color:#553c9a;margin:0 0 0.5rem;">Deal-Level</h4>';
        rh += '<div style="font-size:1.3rem;font-weight:700;color:#553c9a;">' + pct(wf.dealIRR) + ' IRR</div>';
        rh += '<div style="font-size:0.75rem;color:#4a5568;margin-top:0.3rem;">' + wf.dealMultiple.toFixed(2) + 'x Equity Multiple</div>';
        rh += '<div style="font-size:0.75rem;color:#4a5568;">Total Profit: ' + fmtM(wf.lpTotalDist + wf.gpTotalDist - cap.totalEquity) + '</div>';
        rh += '<div style="font-size:0.75rem;color:#4a5568;">Total Equity: ' + fmtM(cap.totalEquity) + '</div>';
        rh += '<div style="font-size:0.68rem;color:#718096;margin-top:0.3rem;">Exit Year ' + exitYear + ' | Cap ' + ((parseFloat((document.getElementById('inv-exitCap') || {}).value) || 5)).toFixed(1) + '%</div>';
        rh += '</div>';

        rh += '</div>';
        rsEl.innerHTML = rh;
    }

    // â”€â”€ Debt Scenario Comparison â”€â”€
    var dsEl = document.getElementById('inv-debtScenarios');
    if (dsEl) {
        var scenarios = [
            { label: 'Conservative', ltv: 0.60, rate: 0.060, color: '#38a169' },
            { label: 'Base', ltv: 0.70, rate: 0.065, color: '#3182ce' },
            { label: 'Aggressive', ltv: 0.75, rate: 0.075, color: '#e53e3e' },
        ];

        var dh = '<h4 style="font-size:0.85rem;margin:0 0 0.75rem;color:#2d3748;">Debt Scenario Comparison</h4>';
        dh += '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;">';

        for (var s = 0; s < scenarios.length; s++) {
            var sc = scenarios[s];
            var scLoan = Math.round(c.totalDev * sc.ltv);
            var scEquity = c.totalDev - scLoan;
            var scGP = Math.round(scEquity * cap.gpPct);
            var scLP = scEquity - scGP;
            var scMR = sc.rate / 12;
            var scNP = 30 * 12;
            var scMP = scMR > 0 ? scLoan * (scMR * Math.pow(1 + scMR, scNP)) / (Math.pow(1 + scMR, scNP) - 1) : scLoan / scNP;
            var scDS = Math.round(scMP * 12);
            var scCap = { seniorLoan: scLoan, seniorRate: sc.rate, seniorLTV: sc.ltv, seniorAmort: 30, seniorIO: cap.seniorIO, annualDS: scDS, ioDS: Math.round(scLoan * sc.rate), mezzAmt: 0, mezzRate: 0, hasMezz: false, totalEquity: scEquity, gpPct: cap.gpPct, gpEquity: scGP, lpEquity: scLP, totalDev: c.totalDev };
            var scWF = computeWaterfall(years, scCap, tiers, exitYear);
            var scDSCR = years[0] && scDS > 0 ? years[0].noi / scDS : 999;

            dh += '<div style="background:#fff;border:2px solid ' + sc.color + ';border-radius:8px;padding:1rem;">';
            dh += '<h4 style="font-size:0.82rem;color:' + sc.color + ';margin:0 0 0.5rem;">' + sc.label + '</h4>';
            dh += '<div style="font-size:0.72rem;color:#4a5568;">';
            dh += '<div style="display:flex;justify-content:space-between;margin-bottom:3px;"><span>LTV:</span><strong>' + (sc.ltv * 100) + '%</strong></div>';
            dh += '<div style="display:flex;justify-content:space-between;margin-bottom:3px;"><span>Loan:</span><strong>' + fmtM(scLoan) + '</strong></div>';
            dh += '<div style="display:flex;justify-content:space-between;margin-bottom:3px;"><span>Rate:</span><strong>' + (sc.rate * 100).toFixed(1) + '%</strong></div>';
            dh += '<div style="display:flex;justify-content:space-between;margin-bottom:3px;"><span>Annual DS:</span><strong>' + fmtM(scDS) + '</strong></div>';
            dh += '<div style="display:flex;justify-content:space-between;margin-bottom:3px;"><span>DSCR:</span><strong style="color:' + (scDSCR >= 1.25 ? '#276749' : scDSCR >= 1.0 ? '#d69e2e' : '#c53030') + ';">' + scDSCR.toFixed(2) + 'x</strong></div>';
            dh += '<div style="border-top:1px solid #e2e8f0;margin:6px 0;padding-top:6px;">';
            dh += '<div style="display:flex;justify-content:space-between;margin-bottom:3px;"><span>LP IRR:</span><strong style="color:#2b6cb0;">' + pct(scWF.lpIRR) + '</strong></div>';
            dh += '<div style="display:flex;justify-content:space-between;margin-bottom:3px;"><span>LP Multiple:</span><strong>' + scWF.lpMultiple.toFixed(2) + 'x</strong></div>';
            dh += '<div style="display:flex;justify-content:space-between;"><span>GP Promote:</span><strong style="color:#276749;">' + fmtM(Math.max(0, scWF.gpPromote)) + '</strong></div>';
            dh += '</div></div></div>';
        }
        dh += '</div>';
        dsEl.innerHTML = dh;
    }
}

function addWaterfallTier() {
    var tiers = getWaterfallTiers();
    var lastHurdle = tiers.length > 0 ? tiers[tiers.length - 1].hurdle : 10;
    tiers.push({ name: 'Custom Tier', hurdle: Math.min(lastHurdle + 5, 99), lpPct: 50, gpPct: 50 });
    investorWaterfallTiers = tiers;
    recalcInvestorModule();
}

function removeWaterfallTier(idx) {
    var tiers = getWaterfallTiers();
    if (tiers.length <= 2) return;
    tiers.splice(idx, 1);
    investorWaterfallTiers = tiers;
    recalcInvestorModule();
}

function resetWaterfallTiers() {
    investorWaterfallTiers = getDefaultWaterfallTiers();
    recalcInvestorModule();
}

function generateInvestorSummary() {
    var st = deepAnalysisState;
    if (!st) return;
    var c = st.computed, prop = st.prop;
    var fmt = function(v) { return '$' + Math.round(v).toLocaleString(); };
    var fmtM = function(v) { return v >= 1e6 ? '$' + (v / 1e6).toFixed(2) + 'M' : fmt(v); };
    var pct = function(v) { return isFinite(v) ? (v * 100).toFixed(1) + '%' : 'N/A'; };

    var cap = buildCapitalStack(c);
    var tiers = getWaterfallTiers();
    var exitYear = parseInt((document.getElementById('inv-exitYear') || {}).value) || 5;
    var years = getInvestorCashFlowData(c);
    var wf = computeWaterfall(years, cap, tiers, exitYear);
    var addr = prop ? (prop.address || prop.formattedAddress || 'Subject Property') : 'Subject Property';
    var useLabel = st.bestUse ? (st.bestUse.replace(/_/g, ' ').replace(/\b\w/g, function(l) { return l.toUpperCase(); })) : 'Development';

    var w = window.open('', '_blank');
    if (!w) { alert('Please allow popups to generate the investor summary.'); return; }

    var h = '<!DOCTYPE html><html><head><meta charset="utf-8"><title>Investment Memorandum â€” ' + addr + '</title>';
    h += '<style>';
    h += 'body { font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; max-width: 900px; margin: 0 auto; padding: 40px; color: #2d3748; line-height: 1.5; }';
    h += 'h1 { font-size: 1.6rem; color: #1a365d; border-bottom: 3px solid #2b6cb0; padding-bottom: 8px; margin-bottom: 4px; }';
    h += '.subtitle { font-size: 0.85rem; color: #718096; margin-bottom: 2rem; }';
    h += 'h2 { font-size: 1.1rem; color: #2b6cb0; margin-top: 2rem; border-bottom: 1px solid #e2e8f0; padding-bottom: 4px; }';
    h += 'table { width: 100%; border-collapse: collapse; font-size: 0.78rem; margin: 0.5rem 0 1rem; }';
    h += 'th { background: #edf2f7; padding: 6px 10px; text-align: left; font-weight: 600; }';
    h += 'td { padding: 5px 10px; border-bottom: 1px solid #e2e8f0; }';
    h += '.metric-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin: 1rem 0; }';
    h += '.metric-card { background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem; text-align: center; }';
    h += '.metric-card h4 { font-size: 0.75rem; color: #718096; margin: 0 0 0.3rem; }';
    h += '.metric-card .val { font-size: 1.4rem; font-weight: 700; }';
    h += '.metric-card .sub { font-size: 0.72rem; color: #718096; }';
    h += '.cap-bar { display: flex; height: 28px; border-radius: 6px; overflow: hidden; margin: 0.75rem 0; font-size: 0.65rem; font-weight: 600; color: #fff; }';
    h += '.disclaimer { font-size: 0.68rem; color: #a0aec0; margin-top: 2rem; border-top: 1px solid #e2e8f0; padding-top: 1rem; }';
    h += '@media print { body { padding: 20px; } .no-print { display: none; } }';
    h += '</style></head><body>';

    // Header
    h += '<h1>Investment Memorandum</h1>';
    h += '<div class="subtitle">' + addr + ' | ' + useLabel + ' | Prepared ' + new Date().toLocaleDateString() + '</div>';

    // Project Overview
    h += '<h2>Project Overview</h2>';
    h += '<table>';
    h += '<tr><td style="width:35%;font-weight:600;">Property Address</td><td>' + addr + '</td></tr>';
    h += '<tr><td style="font-weight:600;">Proposed Use</td><td>' + useLabel + '</td></tr>';
    if (c.units) h += '<tr><td style="font-weight:600;">Unit Count</td><td>' + c.units + ' units</td></tr>';
    h += '<tr><td style="font-weight:600;">Gross SF</td><td>' + c.gsf.toLocaleString() + ' SF</td></tr>';
    h += '<tr><td style="font-weight:600;">Total Development Cost</td><td>' + fmtM(c.totalDev) + '</td></tr>';
    h += '<tr><td style="font-weight:600;">Stabilized NOI</td><td>' + fmtM(c.noi) + '</td></tr>';
    h += '<tr><td style="font-weight:600;">Stabilized Value</td><td>' + fmtM(c.stabilizedValue) + '</td></tr>';
    h += '</table>';

    // Capital Stack
    h += '<h2>Capital Structure</h2>';
    var total = cap.totalDev || 1;
    h += '<div class="cap-bar">';
    if (cap.seniorLoan > 0) h += '<div style="width:' + (cap.seniorLoan / total * 100).toFixed(1) + '%;background:#e53e3e;display:flex;align-items:center;justify-content:center;">Debt ' + (cap.seniorLoan / total * 100).toFixed(0) + '%</div>';
    if (cap.mezzAmt > 0) h += '<div style="width:' + (cap.mezzAmt / total * 100).toFixed(1) + '%;background:#ed8936;display:flex;align-items:center;justify-content:center;">Mezz ' + (cap.mezzAmt / total * 100).toFixed(0) + '%</div>';
    if (cap.gpEquity > 0) h += '<div style="width:' + (cap.gpEquity / total * 100).toFixed(1) + '%;background:#38a169;display:flex;align-items:center;justify-content:center;">GP ' + (cap.gpEquity / total * 100).toFixed(0) + '%</div>';
    if (cap.lpEquity > 0) h += '<div style="width:' + (cap.lpEquity / total * 100).toFixed(1) + '%;background:#3182ce;display:flex;align-items:center;justify-content:center;">LP ' + (cap.lpEquity / total * 100).toFixed(0) + '%</div>';
    h += '</div>';
    h += '<table>';
    h += '<tr><th>Component</th><th style="text-align:right;">Amount</th><th style="text-align:right;">% of Total</th><th>Terms</th></tr>';
    h += '<tr><td>Senior Debt</td><td style="text-align:right;">' + fmtM(cap.seniorLoan) + '</td><td style="text-align:right;">' + (cap.seniorLoan / total * 100).toFixed(1) + '%</td><td>' + (cap.seniorRate * 100).toFixed(1) + '% / ' + cap.seniorAmort + '-yr amort / ' + cap.seniorIO + '-yr IO</td></tr>';
    if (cap.hasMezz && cap.mezzAmt > 0) h += '<tr><td>Mezzanine / Pref Equity</td><td style="text-align:right;">' + fmtM(cap.mezzAmt) + '</td><td style="text-align:right;">' + (cap.mezzAmt / total * 100).toFixed(1) + '%</td><td>' + (cap.mezzRate * 100).toFixed(1) + '% coupon</td></tr>';
    h += '<tr><td>GP Equity</td><td style="text-align:right;">' + fmtM(cap.gpEquity) + '</td><td style="text-align:right;">' + (cap.gpEquity / total * 100).toFixed(1) + '%</td><td>' + (cap.gpPct * 100).toFixed(0) + '% of equity</td></tr>';
    h += '<tr style="font-weight:600;"><td>LP Equity (Required)</td><td style="text-align:right;">' + fmtM(cap.lpEquity) + '</td><td style="text-align:right;">' + (cap.lpEquity / total * 100).toFixed(1) + '%</td><td>' + ((1 - cap.gpPct) * 100).toFixed(0) + '% of equity</td></tr>';
    h += '</table>';

    // Waterfall Structure
    h += '<h2>Distribution Waterfall</h2>';
    h += '<table>';
    h += '<tr><th>Tier</th><th>Description</th><th style="text-align:center;">IRR Hurdle</th><th style="text-align:center;">LP Share</th><th style="text-align:center;">GP Share</th></tr>';
    for (var i = 0; i < tiers.length; i++) {
        var t = tiers[i];
        h += '<tr><td>' + (i + 1) + '</td><td>' + t.name + '</td><td style="text-align:center;">' + (t.isROC ? '1.0x Capital' : t.hurdle + '%') + '</td><td style="text-align:center;">' + t.lpPct + '%</td><td style="text-align:center;">' + t.gpPct + '%</td></tr>';
    }
    h += '</table>';

    // Return Summary
    h += '<h2>Projected Returns (Year ' + exitYear + ' Exit)</h2>';
    h += '<div class="metric-grid">';
    h += '<div class="metric-card"><h4>LP IRR</h4><div class="val" style="color:#2b6cb0;">' + pct(wf.lpIRR) + '</div><div class="sub">' + wf.lpMultiple.toFixed(2) + 'x Multiple</div></div>';
    h += '<div class="metric-card"><h4>LP Total Distributions</h4><div class="val">' + fmtM(wf.lpTotalDist) + '</div><div class="sub">On ' + fmtM(cap.lpEquity) + ' invested</div></div>';
    h += '<div class="metric-card"><h4>Deal IRR</h4><div class="val" style="color:#553c9a;">' + pct(wf.dealIRR) + '</div><div class="sub">' + wf.dealMultiple.toFixed(2) + 'x Multiple</div></div>';
    h += '</div>';

    // Cash Flow Table
    h += '<h2>Annual Cash Flow & Distributions</h2>';
    h += '<table>';
    h += '<tr><th>Year</th><th style="text-align:right;">NOI</th><th style="text-align:right;">Debt Service</th><th style="text-align:right;">CF After DS</th><th style="text-align:right;">Exit Proceeds</th><th style="text-align:right;">LP Dist.</th><th style="text-align:right;">GP Dist.</th></tr>';
    h += '<tr style="background:#fff8f0;font-weight:600;"><td>0</td><td colspan="3" style="text-align:right;">Equity Invested</td><td style="text-align:right;">â€”</td><td style="text-align:right;">(' + fmtM(cap.lpEquity) + ')</td><td style="text-align:right;">(' + fmtM(cap.gpEquity) + ')</td></tr>';
    for (var i = 0; i < wf.years.length; i++) {
        var y = wf.years[i];
        h += '<tr' + (y.isExit ? ' style="font-weight:600;background:#f0fff4;"' : '') + '>';
        h += '<td>' + y.year + (y.isExit ? ' (Exit)' : '') + '</td>';
        h += '<td style="text-align:right;">' + fmt(y.noi) + '</td>';
        h += '<td style="text-align:right;">(' + fmt(y.debtService) + ')</td>';
        h += '<td style="text-align:right;">' + fmt(y.cfAfterDS) + '</td>';
        h += '<td style="text-align:right;">' + (y.exitProceeds > 0 ? fmtM(y.exitProceeds) : 'â€”') + '</td>';
        h += '<td style="text-align:right;">' + fmtM(y.lpDist) + '</td>';
        h += '<td style="text-align:right;">' + fmtM(y.gpDist) + '</td>';
        h += '</tr>';
    }
    h += '</table>';

    // Risk Factors
    h += '<h2>Key Risk Factors & Mitigants</h2>';
    h += '<table>';
    h += '<tr><th style="width:40%;">Risk Factor</th><th>Mitigant</th></tr>';
    h += '<tr><td>Construction cost overruns</td><td>7% hard cost contingency built into budget; GMP contract recommended</td></tr>';
    h += '<tr><td>Lease-up / absorption risk</td><td>Conservative vacancy assumptions; project located in high-demand corridor</td></tr>';
    h += '<tr><td>Interest rate risk</td><td>IO period provides cash flow cushion; rate lock at construction close</td></tr>';
    h += '<tr><td>Entitlement / approval delays</td><td>SB 79 by-right streamlining eliminates discretionary review risk</td></tr>';
    h += '<tr><td>Market cap rate expansion</td><td>Exit cap rate projected ' + ((parseFloat((document.getElementById('inv-exitCap') || {}).value) || 5)).toFixed(0) + ' bps above entry; sensitivity tested</td></tr>';
    h += '</table>';

    h += '<div class="disclaimer">This Investment Memorandum is prepared for informational purposes only and does not constitute an offer to sell or solicitation of an offer to buy any securities. Projected returns are estimates based on assumptions that may not materialize. Past performance is not indicative of future results. Investors should conduct their own due diligence.</div>';
    h += '<div class="disclaimer" style="margin-top:0.5rem;">Generated by CLS CRE HBU Land Use Analysis Tool | ' + new Date().toLocaleDateString() + '</div>';

    h += '<div class="no-print" style="text-align:center;margin-top:2rem;"><button onclick="window.print()" style="padding:10px 24px;background:#2b6cb0;color:#fff;border:none;border-radius:6px;font-size:0.85rem;cursor:pointer;">Print / Save as PDF</button></div>';

    h += '</body></html>';

    w.document.write(h);
    w.document.close();
}

</script>

</body>
</html>
