<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Highest &amp; Best Use Calculator — Los Angeles, CA</title>
    <style>
        :root {
            --primary: #1a365d;
            --primary-light: #2b6cb0;
            --accent: #e8a838;
            --accent-dark: #c77e1a;
            --bg: #f7fafc;
            --card: #ffffff;
            --text: #2d3748;
            --text-light: #718096;
            --border: #e2e8f0;
            --success: #38a169;
            --gold: #d4a020;
            --silver: #8a8a8a;
            --bronze: #b87333;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        header {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        header h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        header p {
            font-size: 1rem;
            opacity: 0.85;
        }

        .badge {
            display: inline-block;
            background: var(--accent);
            color: var(--primary);
            font-weight: 700;
            padding: 0.2rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-top: 0.5rem;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
        }

        .intro-box {
            background: var(--card);
            border-left: 4px solid var(--accent);
            padding: 1.25rem 1.5rem;
            border-radius: 0 8px 8px 0;
            margin-bottom: 2rem;
            box-shadow: 0 2px 6px rgba(0,0,0,0.06);
        }

        .intro-box h3 { color: var(--primary); margin-bottom: 0.5rem; }
        .intro-box p { font-size: 0.92rem; color: var(--text-light); }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        @media (max-width: 768px) {
            .form-grid { grid-template-columns: 1fr; }
            header h1 { font-size: 1.5rem; }
        }

        .section {
            background: var(--card);
            border-radius: 12px;
            padding: 1.75rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .section h2 {
            font-size: 1.1rem;
            color: var(--primary);
            border-bottom: 2px solid var(--border);
            padding-bottom: 0.5rem;
            margin-bottom: 1.25rem;
        }

        .field { margin-bottom: 1.1rem; }
        .field:last-child { margin-bottom: 0; }

        label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 0.3rem;
        }

        label .hint {
            font-weight: 400;
            color: var(--text-light);
            font-size: 0.78rem;
        }

        select, input[type="number"], input[type="text"] {
            width: 100%;
            padding: 0.6rem 0.75rem;
            border: 1.5px solid var(--border);
            border-radius: 8px;
            font-size: 0.92rem;
            color: var(--text);
            background: #fff;
            transition: border-color 0.2s;
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(43,108,176,0.12);
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.88rem;
        }

        .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--primary-light);
        }

        /* Address Lookup */
        .address-section {
            background: var(--card);
            border-radius: 12px;
            padding: 1.75rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            margin-bottom: 2rem;
            border: 2px solid var(--primary-light);
        }

        .address-section h2 {
            font-size: 1.1rem;
            color: var(--primary);
            border-bottom: 2px solid var(--border);
            padding-bottom: 0.5rem;
            margin-bottom: 1.25rem;
        }

        .address-row {
            display: flex;
            gap: 0.75rem;
            align-items: flex-end;
        }

        .address-row .field { flex: 1; margin-bottom: 0; }

        .btn-lookup {
            padding: 0.6rem 1.5rem;
            font-size: 0.92rem;
            font-weight: 700;
            color: white;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border: none;
            border-radius: 8px;
            cursor: pointer;
            white-space: nowrap;
            transition: transform 0.15s, box-shadow 0.15s;
            box-shadow: 0 2px 8px rgba(26,54,93,0.25);
            height: 40px;
        }

        .btn-lookup:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(26,54,93,0.35);
        }

        .btn-lookup:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .lookup-status {
            margin-top: 0.75rem;
            font-size: 0.85rem;
            min-height: 1.4em;
        }

        .lookup-status .status-item {
            display: inline-block;
            margin-right: 1rem;
            margin-bottom: 0.25rem;
        }

        .lookup-status .ok { color: var(--success); }
        .lookup-status .warn { color: var(--accent-dark); }
        .lookup-status .err { color: #e53e3e; }
        .lookup-status .loading { color: var(--primary-light); }

        .autofill-notice {
            display: none;
            background: #ebf8ff;
            border: 1px solid #bee3f8;
            border-radius: 8px;
            padding: 0.7rem 1rem;
            font-size: 0.82rem;
            color: #2b6cb0;
            margin-top: 0.75rem;
        }

        .autofill-notice.visible { display: block; }

        .field.autofilled select,
        .field.autofilled input {
            border-color: #4299e1;
            background: #ebf8ff;
        }

        .field .autofill-badge {
            display: none;
            font-size: 0.7rem;
            color: #4299e1;
            font-weight: 400;
            margin-left: 0.4rem;
        }

        .field.autofilled .autofill-badge { display: inline; }

        @media (max-width: 768px) {
            .address-row { flex-direction: column; }
            .btn-lookup { width: 100%; }
        }

        .btn-calculate {
            display: block;
            width: 100%;
            max-width: 400px;
            margin: 2rem auto;
            padding: 1rem 2rem;
            font-size: 1.15rem;
            font-weight: 700;
            color: white;
            background: linear-gradient(135deg, var(--accent-dark), var(--accent));
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
            box-shadow: 0 4px 12px rgba(232,168,56,0.35);
        }

        .btn-calculate:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(232,168,56,0.45);
        }

        .btn-calculate:active { transform: translateY(0); }

        /* Results */
        #results {
            display: none;
            margin-top: 1rem;
        }

        #results.visible { display: block; }

        .results-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .results-header h2 {
            font-size: 1.5rem;
            color: var(--primary);
        }

        .results-header p {
            color: var(--text-light);
            font-size: 0.92rem;
        }

        .result-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 900px) {
            .result-cards { grid-template-columns: 1fr; }
        }

        .result-card {
            background: var(--card);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            transition: transform 0.2s;
        }

        .result-card:hover { transform: translateY(-4px); }

        .result-card .rank-banner {
            text-align: center;
            padding: 1rem;
            color: white;
            font-size: 0.9rem;
            font-weight: 700;
        }

        .rank-1 .rank-banner { background: linear-gradient(135deg, #b8860b, #daa520); }
        .rank-2 .rank-banner { background: linear-gradient(135deg, #6a6a6a, #a0a0a0); }
        .rank-3 .rank-banner { background: linear-gradient(135deg, #8b4513, #cd853f); }

        .rank-banner .rank-num {
            display: block;
            font-size: 2rem;
            line-height: 1;
        }

        .result-card .card-body {
            padding: 1.5rem;
        }

        .result-card .use-name {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.75rem;
        }

        .score-bar-container {
            margin-bottom: 0.75rem;
        }

        .score-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .score-bar {
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }

        .score-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.8s ease-out;
        }

        .score-bar-fill.legal { background: #4299e1; }
        .score-bar-fill.physical { background: #48bb78; }
        .score-bar-fill.financial { background: #ed8936; }
        .score-bar-fill.productive { background: #9f7aea; }

        .overall-score {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .overall-score .big-score {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary);
        }

        .overall-score span {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .rationale {
            margin-top: 1rem;
            font-size: 0.85rem;
            color: var(--text-light);
            line-height: 1.5;
        }

        /* Details table */
        .details-section {
            background: var(--card);
            border-radius: 12px;
            padding: 1.75rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            margin-bottom: 2rem;
        }

        .details-section h3 {
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .details-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.88rem;
        }

        .details-table th {
            background: var(--primary);
            color: white;
            padding: 0.65rem 0.75rem;
            text-align: left;
            font-weight: 600;
        }

        .details-table th:first-child { border-radius: 8px 0 0 0; }
        .details-table th:last-child { border-radius: 0 8px 0 0; }

        .details-table td {
            padding: 0.6rem 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .details-table tr:nth-child(even) { background: #f8fafc; }
        .details-table tr.top-3 { font-weight: 600; }
        .details-table tr.top-3 td:first-child { color: var(--primary); }

        .pass { color: var(--success); font-weight: 600; }
        .fail { color: #e53e3e; font-weight: 600; }
        .partial { color: var(--accent-dark); font-weight: 600; }

        .disclaimer {
            background: #fffbeb;
            border: 1px solid #f6e05e;
            border-radius: 8px;
            padding: 1rem 1.25rem;
            font-size: 0.82rem;
            color: #744210;
            margin-top: 1rem;
        }

        footer {
            text-align: center;
            padding: 2rem;
            color: var(--text-light);
            font-size: 0.82rem;
            border-top: 1px solid var(--border);
            margin-top: 2rem;
        }

        /* Print / Export Button */
        .btn-print {
            display: none;
            width: 100%;
            max-width: 400px;
            margin: 0 auto 2rem;
            padding: 0.85rem 2rem;
            font-size: 1rem;
            font-weight: 700;
            color: white;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
            box-shadow: 0 4px 12px rgba(26,54,93,0.3);
        }

        .btn-print.visible { display: block; }

        .btn-print:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(26,54,93,0.4);
        }

        .btn-print:active { transform: translateY(0); }

        .print-date {
            display: none;
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-light);
            margin-bottom: 1rem;
        }

        /* Print Styles */
        @media print {
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; color-adjust: exact !important; }

            body { background: white; font-size: 11pt; }

            header {
                background: var(--primary) !important;
                -webkit-print-color-adjust: exact;
                padding: 1.25rem;
                box-shadow: none;
            }

            header h1 { font-size: 1.5rem; }

            .container { padding: 1rem; }

            .intro-box, .btn-calculate, .btn-print, .address-section, footer { display: none !important; }

            .form-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 1rem;
                margin-bottom: 1rem;
            }

            .section {
                box-shadow: none;
                border: 1px solid #ddd;
                padding: 1rem;
                page-break-inside: avoid;
            }

            .section h2 { font-size: 0.95rem; margin-bottom: 0.75rem; }

            .field { margin-bottom: 0.5rem; }
            label { font-size: 0.78rem; }

            select, input[type="number"], input[type="text"] {
                border: none;
                padding: 0;
                font-size: 0.82rem;
                font-weight: 600;
                color: var(--primary);
                background: transparent;
                -webkit-appearance: none;
                appearance: none;
            }

            .checkbox-item { font-size: 0.78rem; }

            #results { display: block !important; page-break-before: auto; }

            .results-header { margin-bottom: 1rem; }
            .results-header h2 { font-size: 1.2rem; }

            .result-cards {
                grid-template-columns: repeat(3, 1fr);
                gap: 0.75rem;
                margin-bottom: 1rem;
            }

            .result-card {
                box-shadow: none;
                border: 1px solid #ddd;
                page-break-inside: avoid;
            }

            .result-card:hover { transform: none; }

            .rank-banner { padding: 0.6rem; font-size: 0.8rem; }
            .rank-banner .rank-num { font-size: 1.4rem; }
            .result-card .card-body { padding: 1rem; }
            .result-card .use-name { font-size: 1rem; margin-bottom: 0.5rem; }
            .score-bar-container { margin-bottom: 0.4rem; }
            .overall-score { margin-top: 0.5rem; padding-top: 0.5rem; }
            .overall-score .big-score { font-size: 1.5rem; }
            .rationale { font-size: 0.78rem; margin-top: 0.5rem; }

            .details-section {
                box-shadow: none;
                border: 1px solid #ddd;
                padding: 1rem;
                page-break-inside: avoid;
            }

            .details-table { font-size: 0.78rem; }
            .details-table th { padding: 0.4rem 0.5rem; }
            .details-table td { padding: 0.35rem 0.5rem; }

            .disclaimer {
                font-size: 0.72rem;
                padding: 0.75rem;
                page-break-inside: avoid;
            }

            .print-date { display: block !important; }

            .legislation-section {
                page-break-inside: avoid;
                box-shadow: none;
                border: 1px solid #ddd;
                padding: 1rem;
            }
            .legislation-section .legislation-card {
                page-break-inside: avoid;
                border-left-color: #4299e1 !important;
            }
        }

        /* Legislation Section */
        .legislation-section {
            background: var(--card);
            border-radius: 12px;
            padding: 1.75rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            margin-bottom: 2rem;
        }

        .legislation-section h3 {
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .legislation-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }

        .legislation-card {
            background: #f8fafc;
            border-left: 4px solid #4299e1;
            border-radius: 0 8px 8px 0;
            padding: 1rem 1.25rem;
        }

        .legislation-card strong {
            color: var(--primary);
            font-size: 0.92rem;
            display: block;
            margin-bottom: 0.35rem;
        }

        .legislation-card p {
            color: var(--text-light);
            font-size: 0.82rem;
            margin: 0;
            line-height: 1.45;
        }

        .legislation-badge {
            display: inline-block;
            background: #ebf8ff;
            color: #2b6cb0;
            font-size: 0.7rem;
            font-weight: 600;
            padding: 0.15rem 0.5rem;
            border-radius: 12px;
            margin-right: 0.3rem;
            margin-bottom: 0.25rem;
            border: 1px solid #bee3f8;
        }

        .legislation-badges {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border);
        }

        .legislation-badges .leg-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 0.35rem;
        }

        /* Analysis Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            overflow-y: auto;
            padding: 2rem 1rem;
        }

        .modal-content {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            position: relative;
        }

        .modal-top-bar {
            position: sticky;
            top: 0;
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: rgba(255,255,255,0.95);
            border-radius: 16px 16px 0 0;
            z-index: 10;
            backdrop-filter: blur(6px);
        }

        .modal-close {
            width: 36px; height: 36px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: #f7fafc;
            font-size: 1.3rem;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            color: var(--text-light);
            transition: background 0.15s;
        }
        .modal-close:hover { background: #edf2f7; }

        .modal-print-btn {
            padding: 0.45rem 1.25rem;
            font-size: 0.85rem;
            font-weight: 700;
            color: white;
            background: var(--primary-light);
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        .modal-print-btn:hover { background: var(--primary); }

        .modal-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            padding: 1.75rem 2rem;
        }
        .modal-header h2 { font-size: 1.4rem; margin-bottom: 0.25rem; }
        .modal-header p { font-size: 0.88rem; opacity: 0.85; }

        .modal-body { padding: 2rem; }

        .analysis-section { margin-bottom: 2rem; }
        .analysis-section h3 {
            color: var(--primary);
            border-bottom: 2px solid var(--border);
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
            font-size: 1rem;
        }

        .program-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
        }
        @media (max-width: 600px) { .program-grid { grid-template-columns: repeat(2, 1fr); } }
        .program-item {
            text-align: center;
            padding: 0.85rem;
            background: #f8fafc;
            border-radius: 8px;
        }
        .program-item .program-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary);
        }
        .program-item .program-label {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-top: 0.15rem;
        }

        .rendering-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }
        @media (max-width: 700px) { .rendering-container { grid-template-columns: 1fr; } }
        .rendering-container svg {
            width: 100%;
            height: auto;
            border: 1px solid var(--border);
            border-radius: 8px;
        }

        .budget-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        .budget-table td {
            padding: 0.4rem 0.75rem;
            border-bottom: 1px solid var(--border);
        }
        .budget-table td:last-child {
            text-align: right;
            font-variant-numeric: tabular-nums;
        }
        .budget-table .section-header td {
            font-weight: 700;
            background: #f8fafc;
            color: var(--primary);
            padding-top: 0.75rem;
            border-bottom: 2px solid var(--border);
        }
        .budget-table .subtotal td {
            font-weight: 700;
            background: #f0f4f8;
        }
        .budget-table .grand-total td {
            font-weight: 700;
            background: var(--primary);
            color: white;
            font-size: 0.92rem;
            padding: 0.6rem 0.75rem;
        }

        .returns-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1.25rem;
        }
        @media (max-width: 600px) { .returns-grid { grid-template-columns: 1fr; } }
        .return-card {
            text-align: center;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 8px;
        }
        .return-card .return-value {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
        }
        .return-card .return-label {
            font-size: 0.78rem;
            color: var(--text-light);
            margin-top: 0.15rem;
        }

        .timeline-bar {
            display: flex;
            border-radius: 8px;
            overflow: hidden;
            height: 36px;
            margin-bottom: 0.5rem;
        }
        .timeline-segment {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.68rem;
            font-weight: 600;
            color: white;
            line-height: 1.2;
            text-align: center;
            padding: 0 0.25rem;
        }
        .timeline-legend {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-top: 0.35rem;
        }

        .risk-card {
            background: #fff5f5;
            border-left: 4px solid #fc8181;
            border-radius: 0 8px 8px 0;
            padding: 0.85rem 1.1rem;
            margin-bottom: 0.6rem;
        }
        .risk-card strong { color: #c53030; font-size: 0.88rem; display: block; margin-bottom: 0.2rem; }
        .risk-card p { color: var(--text-light); font-size: 0.82rem; margin: 0; line-height: 1.45; }

        .click-hint {
            font-size: 0.75rem;
            color: var(--primary-light);
            text-align: center;
            margin-top: 0.5rem;
            font-weight: 600;
        }

        /* Print: analysis modal */
        @media print {
            body.printing-analysis > *:not(#analysisModal) { display: none !important; }
            body.printing-analysis #analysisModal {
                position: static;
                padding: 0;
                background: white;
                overflow: visible;
            }
            body.printing-analysis .modal-content {
                box-shadow: none;
                border-radius: 0;
            }
            body.printing-analysis .modal-top-bar { display: none !important; }
            body.printing-analysis .modal-header {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            body.printing-analysis .analysis-section { page-break-inside: avoid; }
            body.printing-analysis .rendering-container svg { border: 1px solid #ddd; }
            body.printing-analysis .budget-table .grand-total td {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            body.printing-analysis .assumptions-panel { border-color: #ddd; background: #fafafa; }
            body.printing-analysis .assumption-input { border: none; background: transparent; padding: 0; }
            body.printing-analysis .leg-detail-overlay { display: none !important; }
        }

        /* Editable Assumptions Panel */
        .assumptions-panel {
            background: #fffdf5;
            border: 1.5px solid var(--accent);
            border-radius: 10px;
            padding: 1rem 1.25rem;
            margin-bottom: 1.5rem;
        }
        .assumptions-panel h4 {
            font-size: 0.88rem;
            color: var(--accent-dark);
            margin-bottom: 0.75rem;
            font-weight: 700;
        }
        .assumptions-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
        }
        @media (max-width: 600px) { .assumptions-grid { grid-template-columns: repeat(2, 1fr); } }
        .assumption-field {
            display: flex;
            flex-direction: column;
        }
        .assumption-field label {
            font-size: 0.72rem;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 0.2rem;
        }
        .assumption-input {
            width: 100%;
            padding: 0.45rem 0.5rem;
            border: 1.5px solid var(--border);
            border-radius: 6px;
            font-size: 0.88rem;
            font-weight: 600;
            color: var(--primary);
            background: #fffdf5;
            transition: border-color 0.2s;
        }
        .assumption-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(232,168,56,0.15);
        }

        /* Clickable Legislation Cards & Badges */
        .legislation-card.clickable {
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
        }
        .legislation-card.clickable:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .legislation-badge.clickable {
            cursor: pointer;
            transition: background 0.15s;
        }
        .legislation-badge.clickable:hover {
            background: #bee3f8;
        }

        /* Legislation Detail Popup */
        .leg-detail-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.45);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        .leg-detail-content {
            background: white;
            border-radius: 14px;
            max-width: 520px;
            width: 100%;
            box-shadow: 0 16px 48px rgba(0,0,0,0.25);
            overflow: hidden;
        }
        .leg-detail-header {
            background: linear-gradient(135deg, #2b6cb0, #4299e1);
            color: white;
            padding: 1.25rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        .leg-detail-header h3 { font-size: 1.1rem; margin: 0; }
        .leg-detail-close {
            width: 28px; height: 28px;
            border-radius: 50%;
            border: none;
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 1.1rem;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }
        .leg-detail-close:hover { background: rgba(255,255,255,0.35); }
        .leg-detail-body {
            padding: 1.5rem;
        }
        .leg-detail-body .leg-summary {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-bottom: 0.75rem;
            font-style: italic;
        }
        .leg-detail-body .leg-full {
            font-size: 0.88rem;
            color: var(--text);
            line-height: 1.65;
        }
    </style>
</head>
<body>

<header>
    <h1>Highest &amp; Best Use Calculator</h1>
    <p>Land Use Analysis for Los Angeles, CA</p>
    <span class="badge">HBU Analysis Tool</span>
</header>

<div class="container">
    <div class="intro-box">
        <h3>How It Works</h3>
        <p>Enter your parcel details below. The calculator evaluates potential land uses against the four standard HBU tests&mdash;<strong>Legally Permissible</strong>, <strong>Physically Possible</strong>, <strong>Financially Feasible</strong>, and <strong>Maximally Productive</strong>&mdash;then ranks the top 3 uses for your site.</p>
    </div>

    <div class="address-section">
        <h2>Address Lookup</h2>
        <div class="address-row">
            <div class="field">
                <label>Property Address <span class="hint">(Los Angeles, CA)</span></label>
                <input type="text" id="addressInput" placeholder="e.g. 6801 Hollywood Blvd, Los Angeles, CA 90028" onkeydown="if(event.key==='Enter'){event.preventDefault();lookupAddress();}">
            </div>
            <button type="button" class="btn-lookup" id="btnLookup" onclick="lookupAddress()">Look Up</button>
        </div>
        <div class="lookup-status" id="lookupStatus"></div>
        <div class="autofill-notice" id="autofillNotice">
            Fields highlighted in blue were auto-populated from public data. <strong>You can modify any value</strong> before running the calculation. Click a field to edit it.
        </div>
    </div>

    <form id="hbuForm" onsubmit="return false;">
        <div class="form-grid">
            <!-- LEFT COLUMN -->
            <div>
                <div class="section">
                    <h2>Parcel Information</h2>

                    <div class="field" id="field-parcelSize">
                        <label>Parcel Size (sq ft) <span class="autofill-badge">auto-filled</span></label>
                        <input type="number" id="parcelSize" value="10000" min="500" max="5000000" step="100">
                    </div>

                    <div class="field" id="field-frontage">
                        <label>Street Frontage (linear ft) <span class="autofill-badge">auto-filled</span></label>
                        <input type="number" id="frontage" value="80" min="10" max="2000" step="5">
                    </div>

                    <div class="field" id="field-zoning">
                        <label>Zoning Designation <span class="autofill-badge">auto-filled</span></label>
                        <select id="zoning">
                            <option value="R1">R1 — Single-Family Residential</option>
                            <option value="R2">R2 — Two-Family Residential</option>
                            <option value="R3">R3 — Multi-Family (Low Density)</option>
                            <option value="R4">R4 — Multi-Family (Medium Density)</option>
                            <option value="R5">R5 — Multi-Family (High Density)</option>
                            <option value="C1">C1 — Limited Commercial</option>
                            <option value="C1.5">C1.5 — Limited Commercial (Mixed)</option>
                            <option value="C2" selected>C2 — General Commercial</option>
                            <option value="C4">C4 — Commercial Zone</option>
                            <option value="C5">C5 — Commercial (Highway)</option>
                            <option value="CM">CM — Commercial Manufacturing</option>
                            <option value="M1">M1 — Limited Industrial</option>
                            <option value="M2">M2 — Light Industrial</option>
                            <option value="M3">M3 — Heavy Industrial</option>
                            <option value="PF">PF — Public Facilities</option>
                            <option value="OS">OS — Open Space</option>
                            <option value="LAX">LAX — Airport</option>
                            <option value="TOD">TOD — Transit-Oriented Development</option>
                        </select>
                    </div>

                    <div class="field" id="field-neighborhood">
                        <label>Neighborhood / Submarket <span class="autofill-badge">auto-filled</span></label>
                        <select id="neighborhood">
                            <option value="dtla">Downtown LA (DTLA)</option>
                            <option value="hollywood">Hollywood / East Hollywood</option>
                            <option value="koreatown">Koreatown</option>
                            <option value="westside" selected>Westside (West LA / Sawtelle)</option>
                            <option value="santamonica">Santa Monica Blvd Corridor</option>
                            <option value="beverly">Beverly Hills Adjacent</option>
                            <option value="midcity">Mid-City / Mid-Wilshire</option>
                            <option value="southla">South LA</option>
                            <option value="valleyeast">San Fernando Valley — East</option>
                            <option value="valleywest">San Fernando Valley — West</option>
                            <option value="silverlake">Silver Lake / Echo Park</option>
                            <option value="highland">Highland Park / Eagle Rock</option>
                            <option value="venice">Venice / Mar Vista</option>
                            <option value="culver">Culver City Adjacent</option>
                            <option value="exposition">Exposition Corridor</option>
                            <option value="southbay">South Bay (Torrance / Gardena)</option>
                            <option value="harbor">Harbor / San Pedro</option>
                            <option value="boyleheights">Boyle Heights / East LA</option>
                        </select>
                    </div>

                    <div class="field" id="field-siteCondition">
                        <label>Current Site Condition <span class="autofill-badge">auto-filled</span></label>
                        <select id="siteCondition">
                            <option value="vacant" selected>Vacant Land</option>
                            <option value="improved_under">Improved — Underutilized</option>
                            <option value="improved_functional">Improved — Functional</option>
                            <option value="demolition">Structure — Requires Demolition</option>
                            <option value="brownfield">Brownfield / Environmental Issues</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- RIGHT COLUMN -->
            <div>
                <div class="section">
                    <h2>Site Characteristics</h2>

                    <div class="field">
                        <label>Topography</label>
                        <select id="topography">
                            <option value="flat" selected>Flat / Level</option>
                            <option value="gentle">Gentle Slope (&lt;10%)</option>
                            <option value="moderate">Moderate Slope (10–25%)</option>
                            <option value="steep">Steep Slope (&gt;25%)</option>
                        </select>
                    </div>

                    <div class="field">
                        <label>Is this a corner lot?</label>
                        <select id="cornerLot">
                            <option value="yes">Yes</option>
                            <option value="no" selected>No</option>
                        </select>
                    </div>

                    <div class="field" id="field-transit">
                        <label>Proximity to Public Transit <span class="autofill-badge">auto-filled</span></label>
                        <select id="transit">
                            <option value="adjacent">Adjacent to Metro Rail Station (&lt;0.25 mi)</option>
                            <option value="near" selected>Near Transit (0.25–0.5 mi)</option>
                            <option value="moderate">Moderate (0.5–1 mi)</option>
                            <option value="far">Far (&gt;1 mi)</option>
                        </select>
                    </div>

                    <div class="field" id="field-arterial">
                        <label>Major Street / Arterial Frontage? <span class="autofill-badge">auto-filled</span></label>
                        <select id="arterial">
                            <option value="major">Yes — Major Arterial (e.g. Wilshire, Sunset)</option>
                            <option value="secondary" selected>Secondary Road</option>
                            <option value="residential">Residential / Side Street</option>
                        </select>
                    </div>

                    <div class="field">
                        <label>Site Constraints <span class="hint">(select all that apply)</span></label>
                        <div class="checkbox-group">
                            <label class="checkbox-item"><input type="checkbox" id="constFlood"> Flood Zone</label>
                            <label class="checkbox-item"><input type="checkbox" id="constHillside"> Hillside Ordinance</label>
                            <label class="checkbox-item"><input type="checkbox" id="constHistoric"> Historic Overlay</label>
                            <label class="checkbox-item"><input type="checkbox" id="constFault"> Fault Zone</label>
                            <label class="checkbox-item"><input type="checkbox" id="constCoastal"> Coastal Zone</label>
                            <label class="checkbox-item"><input type="checkbox" id="constParking"> Parking Constraints</label>
                        </div>
                    </div>

                    <div class="field">
                        <label>Utilities Available</label>
                        <select id="utilities">
                            <option value="full" selected>All Utilities Available</option>
                            <option value="partial">Partial — Needs Upgrades</option>
                            <option value="none">No Utilities — Requires Extension</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <button type="button" class="btn-calculate" onclick="calculateHBU()">Calculate Top 3 Highest &amp; Best Uses</button>
    </form>

    <button type="button" class="btn-print" id="btnPrint" onclick="exportPDF()">Print / Export to PDF</button>

    <!-- RESULTS -->
    <div id="results">
        <div class="print-date" id="printDate"></div>
        <div class="results-header">
            <h2>Top 3 Highest &amp; Best Use Results</h2>
            <p id="resultsSummary"></p>
        </div>

        <div class="result-cards" id="resultCards"></div>

        <div class="legislation-section" id="legislationSection" style="display:none;"></div>

        <div class="details-section">
            <h3>Full Scoring Breakdown — All Uses Evaluated</h3>
            <div style="overflow-x: auto;">
                <table class="details-table" id="detailsTable">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Land Use</th>
                            <th>Legal</th>
                            <th>Physical</th>
                            <th>Financial</th>
                            <th>Productive</th>
                            <th>Overall</th>
                        </tr>
                    </thead>
                    <tbody id="detailsBody"></tbody>
                </table>
            </div>
        </div>

        <div class="disclaimer">
            <strong>Disclaimer:</strong> This tool provides a preliminary, educational estimate only. Highest and Best Use analysis for real estate investment or appraisal purposes should be performed by a qualified MAI appraiser or licensed professional. Actual HBU depends on detailed market studies, entitlement feasibility, construction cost analysis, and site-specific due diligence. Zoning codes, overlay districts, and specific plan areas in Los Angeles change frequently — always verify with the LA Department of City Planning (ZIMAS).
        </div>
    </div>
</div>

<!-- Analysis Detail Modal -->
<div class="modal-overlay" id="analysisModal" style="display:none;" onclick="if(event.target===this)closeAnalysis();">
    <div class="modal-content">
        <div class="modal-top-bar">
            <button type="button" class="modal-print-btn" onclick="printAnalysis()">Print / PDF</button>
            <button type="button" class="modal-close" onclick="closeAnalysis()">&times;</button>
        </div>
        <div class="modal-header">
            <h2 id="modalTitle"></h2>
            <p id="modalSubtitle"></p>
        </div>
        <div class="modal-body" id="modalBody"></div>
    </div>
</div>

<!-- Legislation Detail Popup -->
<div class="leg-detail-overlay" id="legDetailModal" style="display:none;" onclick="if(event.target===this)closeLegislationDetail();"></div>

<footer>
    CLS CRE Brokerage &mdash; HBU Land Use Calculator &mdash; Los Angeles, CA<br>
    For educational and preliminary analysis purposes only.
</footer>

<script>
// ============================================================
//  ADDRESS LOOKUP ENGINE
// ============================================================

// Neighborhood centroids (lat, lon)
const NEIGHBORHOOD_CENTROIDS = {
    dtla:         { lat: 34.0407, lon: -118.2468 },
    hollywood:    { lat: 34.0928, lon: -118.3287 },
    koreatown:    { lat: 34.0578, lon: -118.3010 },
    westside:     { lat: 34.0367, lon: -118.4376 },
    santamonica:  { lat: 34.0906, lon: -118.3856 },
    beverly:      { lat: 34.0736, lon: -118.4004 },
    midcity:      { lat: 34.0483, lon: -118.3396 },
    southla:      { lat: 33.9425, lon: -118.2820 },
    valleyeast:   { lat: 34.2219, lon: -118.4157 },
    valleywest:   { lat: 34.1866, lon: -118.5353 },
    silverlake:   { lat: 34.0869, lon: -118.2697 },
    highland:     { lat: 34.1133, lon: -118.1902 },
    venice:       { lat: 33.9850, lon: -118.4695 },
    culver:       { lat: 34.0211, lon: -118.3965 },
    exposition:   { lat: 34.0183, lon: -118.2932 },
    southbay:     { lat: 33.8358, lon: -118.3406 },
    harbor:       { lat: 33.7361, lon: -118.2922 },
    boyleheights: { lat: 34.0345, lon: -118.2120 },
};

// Map Nominatim suburb/neighbourhood names → our dropdown IDs
const SUBURB_TO_NEIGHBORHOOD = {
    'downtown': 'dtla',
    'downtown los angeles': 'dtla',
    'little tokyo': 'dtla',
    'arts district': 'dtla',
    'chinatown': 'dtla',
    'civic center': 'dtla',
    'bunker hill': 'dtla',
    'financial district': 'dtla',
    'skid row': 'dtla',
    'hollywood': 'hollywood',
    'east hollywood': 'hollywood',
    'thai town': 'hollywood',
    'hollywood hills': 'hollywood',
    'los feliz': 'silverlake',
    'koreatown': 'koreatown',
    'pico-union': 'koreatown',
    'westlake': 'koreatown',
    'west los angeles': 'westside',
    'west la': 'westside',
    'sawtelle': 'westside',
    'westwood': 'westside',
    'brentwood': 'westside',
    'bel air': 'westside',
    'santa monica': 'santamonica',
    'west hollywood': 'santamonica',
    'weho': 'santamonica',
    'beverly hills': 'beverly',
    'beverly grove': 'beverly',
    'beverlywood': 'beverly',
    'century city': 'beverly',
    'mid-wilshire': 'midcity',
    'mid wilshire': 'midcity',
    'mid-city': 'midcity',
    'mid city': 'midcity',
    'miracle mile': 'midcity',
    'hancock park': 'midcity',
    'larchmont': 'midcity',
    'windsor square': 'midcity',
    'park la brea': 'midcity',
    'fairfax': 'midcity',
    'south los angeles': 'southla',
    'south la': 'southla',
    'watts': 'southla',
    'florence': 'southla',
    'vermont square': 'southla',
    'vermont-slauson': 'southla',
    'green meadows': 'southla',
    'north hollywood': 'valleyeast',
    'noho': 'valleyeast',
    'studio city': 'valleyeast',
    'valley village': 'valleyeast',
    'sun valley': 'valleyeast',
    'panorama city': 'valleyeast',
    'arleta': 'valleyeast',
    'pacoima': 'valleyeast',
    'sylmar': 'valleyeast',
    'sherman oaks': 'valleywest',
    'encino': 'valleywest',
    'tarzana': 'valleywest',
    'woodland hills': 'valleywest',
    'reseda': 'valleywest',
    'canoga park': 'valleywest',
    'winnetka': 'valleywest',
    'chatsworth': 'valleywest',
    'northridge': 'valleywest',
    'granada hills': 'valleywest',
    'west hills': 'valleywest',
    'silver lake': 'silverlake',
    'silverlake': 'silverlake',
    'echo park': 'silverlake',
    'elysian valley': 'silverlake',
    'atwater village': 'silverlake',
    'highland park': 'highland',
    'eagle rock': 'highland',
    'glassell park': 'highland',
    'mount washington': 'highland',
    'cypress park': 'highland',
    'el sereno': 'highland',
    'venice': 'venice',
    'mar vista': 'venice',
    'del rey': 'venice',
    'playa vista': 'venice',
    'playa del rey': 'venice',
    'marina del rey': 'venice',
    'culver city': 'culver',
    'palms': 'culver',
    'rancho park': 'culver',
    'cheviot hills': 'culver',
    'castle heights': 'culver',
    'exposition park': 'exposition',
    'university park': 'exposition',
    'leimert park': 'exposition',
    'jefferson park': 'exposition',
    'west adams': 'exposition',
    'baldwin hills': 'exposition',
    'crenshaw': 'exposition',
    'torrance': 'southbay',
    'gardena': 'southbay',
    'carson': 'southbay',
    'hawthorne': 'southbay',
    'inglewood': 'southbay',
    'lawndale': 'southbay',
    'el segundo': 'southbay',
    'manhattan beach': 'southbay',
    'hermosa beach': 'southbay',
    'redondo beach': 'southbay',
    'san pedro': 'harbor',
    'wilmington': 'harbor',
    'harbor city': 'harbor',
    'harbor gateway': 'harbor',
    'boyle heights': 'boyleheights',
    'east los angeles': 'boyleheights',
    'east la': 'boyleheights',
    'lincoln heights': 'boyleheights',
};

// LA Metro Rail stations (lat, lon)
const METRO_STATIONS = [
    { lat: 34.0561, lon: -118.2365 }, // Union Station
    { lat: 34.0488, lon: -118.2588 }, // 7th St/Metro Center
    { lat: 34.0678, lon: -118.2915 }, // Wilshire/Vermont
    { lat: 34.0624, lon: -118.3080 }, // Wilshire/Normandie
    { lat: 34.0573, lon: -118.3273 }, // Wilshire/Western
    { lat: 34.0620, lon: -118.3440 }, // Wilshire/La Brea
    { lat: 34.0622, lon: -118.3615 }, // Wilshire/Fairfax
    { lat: 34.0626, lon: -118.3766 }, // Wilshire/La Cienega
    { lat: 34.0630, lon: -118.3945 }, // Wilshire/Rodeo
    { lat: 34.0469, lon: -118.2600 }, // Pershing Square
    { lat: 34.0562, lon: -118.2500 }, // Civic Center
    { lat: 34.0620, lon: -118.2360 }, // Chinatown
    { lat: 34.0672, lon: -118.2350 }, // Lincoln/Cypress
    { lat: 34.0760, lon: -118.2260 }, // Heritage Square
    { lat: 34.0890, lon: -118.2100 }, // Southwest Museum
    { lat: 34.1014, lon: -118.3388 }, // Hollywood/Highland
    { lat: 34.1017, lon: -118.3250 }, // Hollywood/Vine
    { lat: 34.1017, lon: -118.3070 }, // Hollywood/Western
    { lat: 34.0876, lon: -118.2840 }, // Vermont/Sunset
    { lat: 34.0757, lon: -118.2915 }, // Vermont/Santa Monica
    { lat: 34.0678, lon: -118.2916 }, // Vermont/Beverly
    { lat: 34.1381, lon: -118.3623 }, // Universal City
    { lat: 34.1687, lon: -118.3765 }, // North Hollywood
    { lat: 34.1565, lon: -118.3670 }, // Valley College
    { lat: 34.1480, lon: -118.3955 }, // Woodman
    { lat: 34.1470, lon: -118.4180 }, // Van Nuys
    { lat: 34.1478, lon: -118.4400 }, // Sepulveda
    { lat: 34.0227, lon: -118.3310 }, // Expo/Crenshaw
    { lat: 34.0183, lon: -118.3088 }, // Expo/Western
    { lat: 34.0186, lon: -118.2862 }, // Expo/Vermont
    { lat: 34.0222, lon: -118.2580 }, // Expo Park/USC
    { lat: 34.0295, lon: -118.2435 }, // LATTC/Ortho Institute
    { lat: 34.0154, lon: -118.4960 }, // Downtown Santa Monica
    { lat: 34.0156, lon: -118.4694 }, // 26th St/Bergamot
    { lat: 34.0135, lon: -118.4330 }, // Expo/Bundy
    { lat: 34.0124, lon: -118.3908 }, // Expo/Sepulveda
    { lat: 34.0168, lon: -118.3685 }, // Westwood/Rancho Park
    { lat: 34.0209, lon: -118.3520 }, // Palms
    { lat: 33.9340, lon: -118.3828 }, // Aviation/LAX
    { lat: 33.9525, lon: -118.3518 }, // Hawthorne/Lennox
    { lat: 33.9268, lon: -118.2377 }, // Willowbrook/Rosa Parks
    { lat: 33.9160, lon: -118.2382 }, // Compton
    { lat: 34.0458, lon: -118.2562 }, // Grand/DTLA (Regional Connector)
    { lat: 34.0489, lon: -118.2468 }, // Historic Broadway (Regional Connector)
    { lat: 34.0562, lon: -118.2338 }, // Little Tokyo/Arts District
];

// Major LA arterials for street detection
const MAJOR_ARTERIALS = [
    'wilshire', 'sunset', 'santa monica', 'hollywood', 'venice', 'olympic',
    'pico', 'la cienega', 'figueroa', 'vermont', 'western', 'crenshaw',
    'sepulveda', 'van nuys', 'ventura', 'victory', 'sherman way', 'lincoln',
    'pacific coast', 'pch', 'florence', 'manchester', 'century', 'imperial',
    'alameda', 'broadway', 'spring', 'main st', 'san fernando', 'glendale',
    'beverly', 'la brea', 'fairfax', 'robertson', 'melrose', 'highland',
    'cahuenga', 'vine', 'western ave', 'normandie', 'hoover', 'alvarado',
    'temple', 'cesar chavez', 'first', '1st st', '3rd st', '6th st',
    'whittier', 'washington', 'jefferson', 'exposition', 'mlk',
    'martin luther king', 'slauson', 'gage', 'rosecrans', 'artesia',
    'el segundo', 'hawthorne', 'inglewood', 'prairie', 'aviation',
    'centinela', 'overland', 'motor', 'sawtelle', 'barrington',
    'balboa', 'reseda', 'tampa', 'winnetka', 'de soto', 'topanga',
    'canoga', 'fallbrook', 'laurel canyon', 'coldwater canyon',
    'lankershim', 'vineland', 'tujunga', 'foothill', 'glenoaks',
    'brand', 'colorado', 'huntington', 'atlantic', 'soto',
];

// Haversine distance in miles
function haversine(lat1, lon1, lat2, lon2) {
    const R = 3958.8; // Earth radius in miles
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat / 2) ** 2 +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon / 2) ** 2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

// Detect nearest neighborhood from coordinates + Nominatim address details
function detectNeighborhood(lat, lon, addressDetails) {
    // Try Nominatim address fields (neighbourhood is most specific, then suburb)
    if (addressDetails) {
        const fields = [
            addressDetails.neighbourhood,
            addressDetails.suburb,
            addressDetails.city_district,
            addressDetails.quarter,
        ];
        for (const field of fields) {
            if (field) {
                const key = field.toLowerCase().trim();
                if (SUBURB_TO_NEIGHBORHOOD[key]) {
                    return SUBURB_TO_NEIGHBORHOOD[key];
                }
            }
        }
    }
    // Fall back to centroid distance
    let best = 'westside';
    let bestDist = Infinity;
    for (const [key, c] of Object.entries(NEIGHBORHOOD_CENTROIDS)) {
        const d = haversine(lat, lon, c.lat, c.lon);
        if (d < bestDist) { bestDist = d; best = key; }
    }
    return best;
}

// Detect transit proximity from coordinates
function detectTransitProximity(lat, lon) {
    let minDist = Infinity;
    for (const s of METRO_STATIONS) {
        const d = haversine(lat, lon, s.lat, s.lon);
        if (d < minDist) minDist = d;
    }
    if (minDist <= 0.25) return 'adjacent';
    if (minDist <= 0.5) return 'near';
    if (minDist <= 1.0) return 'moderate';
    return 'far';
}

// Detect if address is on a major arterial
function detectArterial(addressString, addressDetails) {
    // Try Nominatim road field first (most accurate — avoids matching neighborhood names)
    if (addressDetails && addressDetails.road) {
        const road = addressDetails.road.toLowerCase();
        for (const art of MAJOR_ARTERIALS) {
            if (road.includes(art)) return 'major';
        }
        if (/\bblvd\b|\bboulevard\b|\bave\b|\bavenue\b/.test(road)) return 'secondary';
        return 'residential';
    }
    // Fall back to full address string
    const lower = addressString.toLowerCase();
    for (const art of MAJOR_ARTERIALS) {
        if (lower.includes(art)) return 'major';
    }
    if (/\bblvd\b|\bboulevard\b|\bave\b|\bavenue\b/.test(lower)) return 'secondary';
    return 'residential';
}

// Detect site condition from Nominatim result
// For HBU analysis, any existing structure implies redevelopment → demolition
function detectSiteCondition(osmClass, osmType) {
    // Named structures (buildings, amenities, commercial, etc.)
    const structureClasses = ['building', 'amenity', 'shop', 'office', 'tourism', 'leisure', 'craft', 'club', 'healthcare'];
    if (structureClasses.includes(osmClass)) return 'demolition';
    // Address resolving to a house/building → existing structure for HBU redevelopment
    if (osmClass === 'place' && ['house', 'building', 'apartments', 'residential'].includes(osmType)) return 'demolition';
    // Other place types (most LA parcels have structures)
    if (osmClass === 'place') return 'demolition';
    return 'vacant';
}

// Map ZIMAS zoning code to our dropdown values
function mapZoningCode(rawZone) {
    if (!rawZone) return null;
    // ZIMAS returns codes like "C2-1VL", "[Q]R3-1XL", "M1-1", "R1-1-HCR" etc.
    // Strip Q conditions, D limitations, and supplemental use districts
    let z = rawZone.toUpperCase().replace(/\[.*?\]/g, '').trim();
    // Extract the base zone (letters + optional digits before the dash-height suffix)
    const match = z.match(/^(R[1-5]|C[1-5]|C1\.5|CM|M[1-3]|PF|OS|LAX)/);
    if (match) return match[1];
    // TOD areas are usually identified via overlay, not base zone
    return null;
}

// === API CALLS ===

// Geocode via OpenStreetMap Nominatim (CORS-friendly)
async function geocodeAddress(address) {
    // Append Los Angeles CA if not already present to improve results
    let query = address;
    if (!/los\s*angeles/i.test(query) && !/\bLA\b/.test(query)) {
        query += ', Los Angeles, CA';
    }
    const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&addressdetails=1&limit=1&countrycodes=us`;
    const resp = await fetch(url, {
        headers: { 'Accept': 'application/json' }
    });
    if (!resp.ok) throw new Error('Geocoding service unavailable');
    const data = await resp.json();
    if (!data || data.length === 0) throw new Error('Address not found. Try including city and zip code.');
    const m = data[0];
    return {
        lat: parseFloat(m.lat),
        lon: parseFloat(m.lon),
        matched: m.display_name,
        address: m.address || {},
        osmClass: m.class || '',
        osmType: m.type || '',
    };
}

// Query ZIMAS zoning layer
async function fetchZoning(lat, lon) {
    try {
        // ZIMAS uses CA State Plane Zone 5 (feet) but we can pass WGS84 with inSR=4326
        const url = `https://zimas.lacity.org/arcgis/rest/services/zma/zoning/MapServer/1102/query?` +
            `geometry=${lon},${lat}&geometryType=esriGeometryPoint&inSR=4326` +
            `&spatialRel=esriSpatialRelIntersects&outFields=ZONE_CMPLT&returnGeometry=false&f=json`;
        const resp = await fetch(url);
        if (!resp.ok) throw new Error('ZIMAS unavailable');
        const data = await resp.json();
        if (data.features && data.features.length > 0) {
            const raw = data.features[0].attributes.ZONE_CMPLT || data.features[0].attributes.zone_cmplt;
            return { raw, mapped: mapZoningCode(raw) };
        }
        return null;
    } catch (e) {
        console.warn('ZIMAS zoning query failed (may be CORS):', e);
        return { error: 'cors' };
    }
}

// Query LA County parcel layer for lot size
async function fetchParcelInfo(lat, lon) {
    try {
        const url = `https://public.gis.lacounty.gov/public/rest/services/LACounty_Cache/LACounty_Parcel/MapServer/0/query?` +
            `geometry=${lon},${lat}&geometryType=esriGeometryPoint&inSR=4326` +
            `&spatialRel=esriSpatialRelIntersects&outFields=*&returnGeometry=true&f=json`;
        const resp = await fetch(url);
        if (!resp.ok) throw new Error('Parcel service unavailable');
        const data = await resp.json();
        if (data.features && data.features.length > 0) {
            const attrs = data.features[0].attributes;
            // Try different field names for area
            let area = attrs['Shape.STArea()'] || attrs['Shape__Area'] || attrs['ShapeSTArea'] || attrs['SHAPE.STArea()'] || null;
            // If geometry is returned, try to compute from rings
            if (!area && data.features[0].geometry && data.features[0].geometry.rings) {
                area = computePolygonArea(data.features[0].geometry.rings, data.spatialReference);
            }
            return { area, attrs };
        }
        return null;
    } catch (e) {
        console.warn('Parcel query failed (may be CORS):', e);
        return { error: 'cors' };
    }
}

// Compute polygon area from rings (in sq ft if Web Mercator, approximate otherwise)
function computePolygonArea(rings, sr) {
    // Shoelace formula — gives area in the spatial reference units
    let totalArea = 0;
    for (const ring of rings) {
        let a = 0;
        for (let i = 0; i < ring.length - 1; i++) {
            a += ring[i][0] * ring[i + 1][1] - ring[i + 1][0] * ring[i][1];
        }
        totalArea += Math.abs(a) / 2;
    }
    // If Web Mercator (meters), convert to sq ft
    if (sr && (sr.wkid === 102100 || sr.wkid === 3857)) {
        // At LA latitude (~34°), 1 Web Mercator meter ≈ 0.829 real meters
        const latRad = 34.05 * Math.PI / 180;
        const scaleFactor = Math.cos(latRad);
        const realSqMeters = totalArea * scaleFactor * scaleFactor;
        return Math.round(realSqMeters * 10.7639); // sq meters to sq ft
    }
    // If State Plane feet
    if (sr && (sr.wkid === 2229 || sr.wkid === 102645)) {
        return Math.round(totalArea);
    }
    // Fallback: assume sq ft
    return Math.round(totalArea);
}

// Estimate frontage from parcel area (rough: assume ~2:1 lot ratio)
function estimateFrontage(areaSqFt) {
    if (!areaSqFt || areaSqFt <= 0) return 80;
    // Assume lot depth ≈ 2× frontage → area = frontage × (2 × frontage) = 2f²
    const f = Math.sqrt(areaSqFt / 2);
    return Math.round(Math.max(20, Math.min(500, f)));
}

// Lookup status helpers
function setStatus(html) {
    document.getElementById('lookupStatus').innerHTML = html;
}

function addStatus(html) {
    document.getElementById('lookupStatus').innerHTML += html;
}

// Mark a field as autofilled
function markAutofill(fieldId) {
    const el = document.getElementById('field-' + fieldId);
    if (el) el.classList.add('autofilled');
}

// Clear all autofill markers
function clearAutofill() {
    document.querySelectorAll('.field.autofilled').forEach(el => el.classList.remove('autofilled'));
    document.getElementById('autofillNotice').classList.remove('visible');
}

// === MAIN LOOKUP ORCHESTRATOR ===

async function lookupAddress() {
    const address = document.getElementById('addressInput').value.trim();
    if (!address) {
        setStatus('<span class="err">Please enter an address.</span>');
        return;
    }

    const btn = document.getElementById('btnLookup');
    btn.disabled = true;
    btn.textContent = 'Looking up...';
    clearAutofill();
    setStatus('<span class="loading">Geocoding address...</span>');

    let coords;
    try {
        coords = await geocodeAddress(address);
        setStatus(`<span class="status-item ok">Matched: ${coords.matched}</span>`);
    } catch (e) {
        setStatus(`<span class="err">${e.message}</span>`);
        btn.disabled = false;
        btn.textContent = 'Look Up';
        return;
    }

    let filledCount = 0;

    // Run zoning + parcel queries in parallel
    addStatus('<br><span class="loading">Querying zoning &amp; parcel data...</span>');

    const [zoningResult, parcelResult] = await Promise.all([
        fetchZoning(coords.lat, coords.lon),
        fetchParcelInfo(coords.lat, coords.lon),
    ]);

    // Build status summary
    let statusParts = [`<span class="status-item ok">Matched: ${coords.matched}</span>`];

    // Apply zoning
    if (zoningResult && zoningResult.error === 'cors') {
        statusParts.push(`<span class="status-item warn">Zoning: ZIMAS blocked by browser — select manually</span>`);
    } else if (zoningResult && zoningResult.mapped) {
        const sel = document.getElementById('zoning');
        const opt = sel.querySelector(`option[value="${zoningResult.mapped}"]`);
        if (opt) {
            sel.value = zoningResult.mapped;
            markAutofill('zoning');
            filledCount++;
            statusParts.push(`<span class="status-item ok">Zoning: ${zoningResult.raw}</span>`);
        } else {
            statusParts.push(`<span class="status-item warn">Zoning "${zoningResult.raw}" — not in dropdown, please select manually</span>`);
        }
    } else if (zoningResult && zoningResult.raw) {
        statusParts.push(`<span class="status-item warn">Zoning "${zoningResult.raw}" — please select closest match</span>`);
    } else {
        statusParts.push(`<span class="status-item warn">Zoning: could not retrieve — please select manually</span>`);
    }

    // Apply parcel size
    if (parcelResult && parcelResult.error === 'cors') {
        statusParts.push(`<span class="status-item warn">Parcel size: County GIS blocked by browser — enter manually</span>`);
    } else if (parcelResult && parcelResult.area && parcelResult.area > 0) {
        document.getElementById('parcelSize').value = Math.round(parcelResult.area);
        markAutofill('parcelSize');
        filledCount++;
        statusParts.push(`<span class="status-item ok">Lot: ${Math.round(parcelResult.area).toLocaleString()} SF</span>`);

        // Estimate frontage
        const est = estimateFrontage(parcelResult.area);
        document.getElementById('frontage').value = est;
        markAutofill('frontage');
        filledCount++;
    } else {
        statusParts.push(`<span class="status-item warn">Parcel size: could not retrieve — enter manually</span>`);
    }

    // Detect neighborhood (using Nominatim address details when available)
    const hood = detectNeighborhood(coords.lat, coords.lon, coords.address);
    document.getElementById('neighborhood').value = hood;
    markAutofill('neighborhood');
    filledCount++;

    // Detect transit
    const transit = detectTransitProximity(coords.lat, coords.lon);
    document.getElementById('transit').value = transit;
    markAutofill('transit');
    filledCount++;

    // Detect arterial (using Nominatim road field when available)
    const arterial = detectArterial(coords.matched || address, coords.address);
    document.getElementById('arterial').value = arterial;
    markAutofill('arterial');
    filledCount++;

    // Detect site condition from Nominatim class/type
    const siteCondition = detectSiteCondition(coords.osmClass, coords.osmType);
    document.getElementById('siteCondition').value = siteCondition;
    markAutofill('siteCondition');
    filledCount++;

    // Show status
    setStatus(statusParts.join('<br>'));

    // Show autofill notice
    if (filledCount > 0) {
        document.getElementById('autofillNotice').classList.add('visible');
    }

    btn.disabled = false;
    btn.textContent = 'Look Up';
}


// ============================================================
//  LA-Specific Data & Scoring Engine
// ============================================================

const LAND_USES = [
    { id: 'sfr',            name: 'Single-Family Residential',      icon: '🏡' },
    { id: 'duplex',         name: 'Duplex / Two-Unit',              icon: '🏘️' },
    { id: 'multifamily_low', name: 'Multi-Family (Low-Rise)',       icon: '🏢' },
    { id: 'multifamily_mid', name: 'Multi-Family (Mid-Rise)',       icon: '🏙️' },
    { id: 'multifamily_high', name: 'Multi-Family (High-Rise)',     icon: '🏗️' },
    { id: 'mixeduse',       name: 'Mixed-Use (Retail + Residential)', icon: '🏬' },
    { id: 'retail',         name: 'Retail / Restaurant',            icon: '🛍️' },
    { id: 'office',         name: 'Office / Professional',          icon: '🏛️' },
    { id: 'medical',        name: 'Medical Office',                 icon: '🏥' },
    { id: 'hotel',          name: 'Hotel / Hospitality',            icon: '🏨' },
    { id: 'industrial',     name: 'Industrial / Warehouse',         icon: '🏭' },
    { id: 'selfstorage',    name: 'Self-Storage',                   icon: '📦' },
    { id: 'senior',         name: 'Senior Living / Assisted',       icon: '🧓' },
    { id: 'parking',        name: 'Parking Structure / Lot',        icon: '🅿️' },
    { id: 'creative',       name: 'Creative Office / Flex',         icon: '🎨' },
    { id: 'adu',            name: 'ADU / Small-Lot Subdivision',    icon: '🏠' },
];

// Zoning → which uses are legally permissible
// 0 = not permitted, 0.5 = conditional/CUP required, 1.0 = by-right
const ZONING_MATRIX = {
    'R1':  { sfr:1, duplex:0, multifamily_low:0, multifamily_mid:0, multifamily_high:0, mixeduse:0, retail:0, office:0, medical:0, hotel:0, industrial:0, selfstorage:0, senior:0.5, parking:0, creative:0, adu:1 },
    'R2':  { sfr:1, duplex:1, multifamily_low:0.5, multifamily_mid:0, multifamily_high:0, mixeduse:0, retail:0, office:0, medical:0, hotel:0, industrial:0, selfstorage:0, senior:0.5, parking:0, creative:0, adu:1 },
    'R3':  { sfr:1, duplex:1, multifamily_low:1, multifamily_mid:0.5, multifamily_high:0, mixeduse:0, retail:0, office:0, medical:0, hotel:0, industrial:0, selfstorage:0, senior:0.5, parking:0.5, creative:0, adu:1 },
    'R4':  { sfr:0.5, duplex:1, multifamily_low:1, multifamily_mid:1, multifamily_high:0.5, mixeduse:0, retail:0, office:0, medical:0, hotel:0, industrial:0, selfstorage:0, senior:1, parking:0.5, creative:0, adu:0.5 },
    'R5':  { sfr:0, duplex:0.5, multifamily_low:1, multifamily_mid:1, multifamily_high:1, mixeduse:0, retail:0, office:0, medical:0, hotel:0.5, industrial:0, selfstorage:0, senior:1, parking:0.5, creative:0, adu:0 },
    'C1':  { sfr:0, duplex:0, multifamily_low:0.5, multifamily_mid:0, multifamily_high:0, mixeduse:0.5, retail:1, office:1, medical:1, hotel:0, industrial:0, selfstorage:0, senior:0, parking:1, creative:0.5, adu:0 },
    'C1.5':{ sfr:0, duplex:0, multifamily_low:0.5, multifamily_mid:0.5, multifamily_high:0, mixeduse:1, retail:1, office:1, medical:1, hotel:0.5, industrial:0, selfstorage:0, senior:0.5, parking:1, creative:0.5, adu:0 },
    'C2':  { sfr:0, duplex:0, multifamily_low:1, multifamily_mid:1, multifamily_high:0.5, mixeduse:1, retail:1, office:1, medical:1, hotel:1, industrial:0, selfstorage:0.5, senior:1, parking:1, creative:1, adu:0 },
    'C4':  { sfr:0, duplex:0, multifamily_low:0.5, multifamily_mid:1, multifamily_high:0.5, mixeduse:1, retail:1, office:1, medical:1, hotel:1, industrial:0, selfstorage:0.5, senior:0.5, parking:1, creative:1, adu:0 },
    'C5':  { sfr:0, duplex:0, multifamily_low:0, multifamily_mid:0.5, multifamily_high:0, mixeduse:0.5, retail:1, office:1, medical:0.5, hotel:0.5, industrial:0, selfstorage:0.5, senior:0, parking:1, creative:0.5, adu:0 },
    'CM':  { sfr:0, duplex:0, multifamily_low:0, multifamily_mid:0, multifamily_high:0, mixeduse:0.5, retail:0.5, office:1, medical:0.5, hotel:0, industrial:0.5, selfstorage:1, senior:0, parking:1, creative:1, adu:0 },
    'M1':  { sfr:0, duplex:0, multifamily_low:0, multifamily_mid:0, multifamily_high:0, mixeduse:0, retail:0.5, office:0.5, medical:0, hotel:0, industrial:1, selfstorage:1, senior:0, parking:1, creative:1, adu:0 },
    'M2':  { sfr:0, duplex:0, multifamily_low:0, multifamily_mid:0, multifamily_high:0, mixeduse:0, retail:0, office:0, medical:0, hotel:0, industrial:1, selfstorage:1, senior:0, parking:1, creative:0.5, adu:0 },
    'M3':  { sfr:0, duplex:0, multifamily_low:0, multifamily_mid:0, multifamily_high:0, mixeduse:0, retail:0, office:0, medical:0, hotel:0, industrial:1, selfstorage:0.5, senior:0, parking:1, creative:0, adu:0 },
    'PF':  { sfr:0, duplex:0, multifamily_low:0, multifamily_mid:0, multifamily_high:0, mixeduse:0, retail:0, office:0.5, medical:0.5, hotel:0, industrial:0, selfstorage:0, senior:0.5, parking:0.5, creative:0, adu:0 },
    'OS':  { sfr:0, duplex:0, multifamily_low:0, multifamily_mid:0, multifamily_high:0, mixeduse:0, retail:0, office:0, medical:0, hotel:0, industrial:0, selfstorage:0, senior:0, parking:0, creative:0, adu:0 },
    'LAX': { sfr:0, duplex:0, multifamily_low:0, multifamily_mid:0, multifamily_high:0, mixeduse:0, retail:0.5, office:0.5, medical:0, hotel:0.5, industrial:0.5, selfstorage:0.5, senior:0, parking:1, creative:0, adu:0 },
    'TOD': { sfr:0, duplex:0.5, multifamily_low:1, multifamily_mid:1, multifamily_high:1, mixeduse:1, retail:1, office:1, medical:1, hotel:1, industrial:0, selfstorage:0, senior:1, parking:0.5, creative:1, adu:0.5 },
};

// Neighborhood market demand multipliers (1.0 = average)
const NEIGHBORHOOD_DEMAND = {
    dtla:         { sfr:0.3, duplex:0.4, multifamily_low:1.1, multifamily_mid:1.3, multifamily_high:1.4, mixeduse:1.4, retail:1.2, office:1.3, medical:0.7, hotel:1.3, industrial:0.5, selfstorage:0.7, senior:0.6, parking:1.3, creative:1.4, adu:0.3 },
    hollywood:    { sfr:0.5, duplex:0.7, multifamily_low:1.2, multifamily_mid:1.3, multifamily_high:1.1, mixeduse:1.3, retail:1.2, office:1.0, medical:0.8, hotel:1.2, industrial:0.3, selfstorage:0.7, senior:0.5, parking:1.1, creative:1.3, adu:0.6 },
    koreatown:    { sfr:0.4, duplex:0.6, multifamily_low:1.3, multifamily_mid:1.4, multifamily_high:1.2, mixeduse:1.3, retail:1.2, office:0.9, medical:1.1, hotel:1.0, industrial:0.3, selfstorage:0.8, senior:0.8, parking:1.2, creative:0.9, adu:0.5 },
    westside:     { sfr:1.0, duplex:0.9, multifamily_low:1.1, multifamily_mid:1.2, multifamily_high:0.9, mixeduse:1.2, retail:1.1, office:1.2, medical:1.3, hotel:1.0, industrial:0.2, selfstorage:0.6, senior:1.0, parking:1.0, creative:1.1, adu:0.9 },
    santamonica:  { sfr:0.8, duplex:0.8, multifamily_low:1.0, multifamily_mid:1.1, multifamily_high:0.8, mixeduse:1.2, retail:1.3, office:1.1, medical:1.0, hotel:1.1, industrial:0.2, selfstorage:0.4, senior:0.8, parking:1.0, creative:1.2, adu:0.7 },
    beverly:      { sfr:1.2, duplex:0.8, multifamily_low:1.0, multifamily_mid:1.1, multifamily_high:0.9, mixeduse:1.1, retail:1.1, office:1.3, medical:1.4, hotel:1.1, industrial:0.1, selfstorage:0.3, senior:1.0, parking:0.9, creative:0.9, adu:0.7 },
    midcity:      { sfr:0.7, duplex:0.8, multifamily_low:1.2, multifamily_mid:1.2, multifamily_high:0.8, mixeduse:1.2, retail:1.0, office:0.9, medical:1.0, hotel:0.8, industrial:0.3, selfstorage:0.8, senior:0.9, parking:0.9, creative:1.0, adu:0.8 },
    southla:      { sfr:0.9, duplex:1.0, multifamily_low:1.1, multifamily_mid:0.8, multifamily_high:0.4, mixeduse:0.8, retail:0.8, office:0.5, medical:0.7, hotel:0.4, industrial:0.9, selfstorage:1.1, senior:0.7, parking:0.6, creative:0.6, adu:1.1 },
    valleyeast:   { sfr:1.1, duplex:1.0, multifamily_low:1.0, multifamily_mid:0.8, multifamily_high:0.5, mixeduse:0.9, retail:0.9, office:0.8, medical:0.9, hotel:0.6, industrial:1.0, selfstorage:1.1, senior:0.9, parking:0.7, creative:0.7, adu:1.0 },
    valleywest:   { sfr:1.2, duplex:1.0, multifamily_low:0.9, multifamily_mid:0.8, multifamily_high:0.4, mixeduse:0.9, retail:0.9, office:0.9, medical:1.0, hotel:0.6, industrial:0.8, selfstorage:1.0, senior:1.0, parking:0.6, creative:0.7, adu:1.0 },
    silverlake:   { sfr:0.9, duplex:0.9, multifamily_low:1.2, multifamily_mid:1.0, multifamily_high:0.5, mixeduse:1.2, retail:1.1, office:0.8, medical:0.7, hotel:0.7, industrial:0.3, selfstorage:0.5, senior:0.5, parking:0.7, creative:1.3, adu:1.0 },
    highland:     { sfr:0.9, duplex:0.9, multifamily_low:1.1, multifamily_mid:0.9, multifamily_high:0.4, mixeduse:1.1, retail:1.0, office:0.7, medical:0.7, hotel:0.5, industrial:0.5, selfstorage:0.7, senior:0.5, parking:0.6, creative:1.1, adu:1.0 },
    venice:       { sfr:0.9, duplex:0.8, multifamily_low:1.0, multifamily_mid:0.9, multifamily_high:0.5, mixeduse:1.2, retail:1.2, office:1.0, medical:0.7, hotel:1.0, industrial:0.2, selfstorage:0.3, senior:0.6, parking:0.8, creative:1.3, adu:0.8 },
    culver:       { sfr:0.8, duplex:0.8, multifamily_low:1.1, multifamily_mid:1.1, multifamily_high:0.7, mixeduse:1.2, retail:1.0, office:1.2, medical:1.0, hotel:0.9, industrial:0.5, selfstorage:0.7, senior:0.8, parking:0.8, creative:1.3, adu:0.8 },
    exposition:   { sfr:0.6, duplex:0.7, multifamily_low:1.2, multifamily_mid:1.2, multifamily_high:0.9, mixeduse:1.2, retail:1.0, office:0.9, medical:0.8, hotel:0.7, industrial:0.4, selfstorage:0.8, senior:0.7, parking:0.9, creative:1.0, adu:0.8 },
    southbay:     { sfr:1.0, duplex:0.9, multifamily_low:0.9, multifamily_mid:0.7, multifamily_high:0.3, mixeduse:0.8, retail:0.9, office:0.8, medical:1.0, hotel:0.7, industrial:1.2, selfstorage:1.1, senior:0.9, parking:0.6, creative:0.6, adu:0.9 },
    harbor:       { sfr:0.7, duplex:0.7, multifamily_low:0.8, multifamily_mid:0.6, multifamily_high:0.3, mixeduse:0.7, retail:0.7, office:0.5, medical:0.6, hotel:0.6, industrial:1.3, selfstorage:1.1, senior:0.7, parking:0.7, creative:0.5, adu:0.7 },
    boyleheights: { sfr:0.9, duplex:1.0, multifamily_low:1.1, multifamily_mid:0.7, multifamily_high:0.3, mixeduse:0.9, retail:0.9, office:0.5, medical:0.6, hotel:0.3, industrial:0.8, selfstorage:0.9, senior:0.6, parking:0.5, creative:0.8, adu:1.1 },
};

// Minimum parcel sizes (sq ft) for feasibility
const MIN_PARCEL = {
    sfr: 2500, duplex: 3500, multifamily_low: 5000, multifamily_mid: 10000,
    multifamily_high: 20000, mixeduse: 5000, retail: 2000, office: 3000,
    medical: 3000, hotel: 15000, industrial: 5000, selfstorage: 8000,
    senior: 15000, parking: 3000, creative: 3000, adu: 1200
};

// Approx LA land value per SF by neighborhood (for relative comparisons)
const LAND_VALUE_PSF = {
    dtla: 280, hollywood: 210, koreatown: 190, westside: 300, santamonica: 320,
    beverly: 400, midcity: 180, southla: 80, valleyeast: 90, valleywest: 120,
    silverlake: 200, highland: 140, venice: 320, culver: 220, exposition: 150,
    southbay: 110, harbor: 70, boyleheights: 100
};

// Revenue potential per SF of building (annual, rough $/SF)
const REVENUE_PSF = {
    sfr: 28, duplex: 30, multifamily_low: 34, multifamily_mid: 38,
    multifamily_high: 42, mixeduse: 40, retail: 36, office: 38,
    medical: 45, hotel: 55, industrial: 16, selfstorage: 14,
    senior: 48, parking: 22, creative: 35, adu: 32
};

// Build cost per SF (rough LA estimates)
const BUILD_COST_PSF = {
    sfr: 280, duplex: 260, multifamily_low: 300, multifamily_mid: 380,
    multifamily_high: 500, mixeduse: 400, retail: 250, office: 350,
    medical: 420, hotel: 450, industrial: 150, selfstorage: 100,
    senior: 380, parking: 80, creative: 280, adu: 250
};

// FAR (floor area ratio) by use — typical LA densities
const FAR_TYPICAL = {
    sfr: 0.5, duplex: 0.6, multifamily_low: 1.5, multifamily_mid: 3.0,
    multifamily_high: 6.0, mixeduse: 3.0, retail: 0.5, office: 2.0,
    medical: 1.5, hotel: 4.0, industrial: 0.5, selfstorage: 2.5,
    senior: 2.5, parking: 3.0, creative: 1.5, adu: 0.5
};

// Rationale templates
const RATIONALE = {
    sfr:             'Single-family development suits the site due to residential zoning, neighborhood character, and stable demand for ownership housing.',
    duplex:          'Duplex development provides moderate density with manageable entitlement complexity, strong for owner-occupant or rental income strategies.',
    multifamily_low: 'Low-rise multifamily maximizes unit count within a manageable building type, aligning well with LA\'s housing demand and density incentives.',
    multifamily_mid: 'Mid-rise multifamily leverages the parcel size and zoning to achieve meaningful density, supported by strong rental market fundamentals.',
    multifamily_high:'High-rise multifamily captures maximum density bonus potential in a high-demand corridor, though construction costs are significantly higher.',
    mixeduse:        'Mixed-use development combines ground-floor commercial revenue with residential density above, ideal for transit-accessible commercial corridors.',
    retail:          'Retail use leverages street frontage, visibility, and pedestrian traffic in a commercial corridor with demonstrated consumer demand.',
    office:          'Office development responds to professional service demand in the submarket, with viable access and infrastructure to support employment density.',
    medical:         'Medical office benefits from proximity to health care services, strong tenant demand, and premium rents typical of medical-zoned uses.',
    hotel:           'Hotel/hospitality use leverages tourism and business travel demand, arterial visibility, and transit proximity for viable room-night revenue.',
    industrial:      'Industrial/warehouse use provides strong yield potential with lower construction costs, supported by limited industrial land supply in LA.',
    selfstorage:     'Self-storage is operationally efficient with low staffing costs, serves population density demand, and tolerates suboptimal site configurations.',
    senior:          'Senior living addresses the growing aging population with premium per-unit revenue and purpose-built care facilities.',
    parking:         'Parking structure use addresses chronic parking deficits in dense urban areas, with modest build costs and reliable demand.',
    creative:        'Creative office/flex space appeals to tech and media tenants seeking character space, commanding premium rents in emerging neighborhoods.',
    adu:             'ADU or small-lot subdivision maximizes yield on smaller parcels under CA housing legislation (SB 9, AB 68) with minimal entitlement friction.',
};


// ============================================================
//  CA HOUSING LEGISLATION
// ============================================================

const CA_HOUSING_LEGISLATION = [
    {
        id: 'sb9',
        name: 'SB 9 (HOME Act)',
        description: 'By-right duplex and lot splits on single-family parcels statewide.',
        detail: 'The California HOME Act (2021) allows property owners to split single-family lots and build duplexes by-right, bypassing traditional zoning restrictions. Applies to parcels of at least 2,400 SF in urbanized areas, not in historic districts, fire hazard zones, or conservation areas. Each resulting lot must be at least 1,200 SF. Owner-occupancy is required for 3 years on one of the units if a lot split is pursued. This effectively doubles the allowed density on R1-zoned land without requiring a zone change or CUP. Impact: Significant for small infill developers targeting R1 neighborhoods.',
        applies: (useId, inp) => inp.zoning === 'R1' && inp.parcelSize >= 2400 && ['duplex', 'adu'].includes(useId),
        densityBonus: 1.0,
        parkingReduction: 0,
        softCostReduction: 0,
        legalOverride: true,
    },
    {
        id: 'ab2011',
        name: 'AB 2011',
        description: 'By-right affordable housing on commercially zoned land.',
        detail: 'AB 2011 (2022) creates a streamlined, ministerial (by-right) approval pathway for 100% affordable housing on commercially zoned land. Projects must pay prevailing wages and meet affordability requirements — mixed-income projects require a percentage of units at below-market rents. Applies to sites zoned for office, retail, or parking that are not in industrial zones, coastal zones, or high fire areas. Overrides local zoning that would otherwise prohibit residential uses on commercial parcels. Impact: Unlocks large swaths of commercial land for affordable housing development across California.',
        applies: (useId, inp) => ['C1','C1.5','C2','C4','C5','CM'].includes(inp.zoning) && ['multifamily_low','multifamily_mid','multifamily_high','mixeduse'].includes(useId),
        densityBonus: 0.35,
        parkingReduction: 0,
        softCostReduction: 0,
        legalOverride: true,
    },
    {
        id: 'sb6',
        name: 'SB 6',
        description: 'Market-rate housing permitted on commercially zoned land.',
        detail: 'SB 6, the Middle Class Housing Act (2022), allows market-rate residential development on commercially zoned land, provided the project meets specified objective design standards and at least 20% of units are affordable. Unlike AB 2011, SB 6 allows market-rate projects but requires the local approval process. Projects must comply with local height and FAR limits. Applies to parcels zoned for office, retail, or parking uses. Impact: Enables market-rate housing on commercial corridors where residential was previously prohibited.',
        applies: (useId, inp) => ['C1','C1.5','C2','C4','C5','CM'].includes(inp.zoning) && ['multifamily_low','multifamily_mid','multifamily_high','mixeduse'].includes(useId),
        densityBonus: 0.25,
        parkingReduction: 0,
        softCostReduction: 0,
        legalOverride: false,
    },
    {
        id: 'sb423',
        name: 'SB 423 (Streamlined)',
        description: 'Streamlined ministerial approval for multifamily projects meeting affordability thresholds.',
        detail: 'SB 423 (2023) extends and strengthens SB 35\'s streamlined ministerial approval process for multifamily housing projects meeting affordability thresholds. Projects with 10%+ affordable units in jurisdictions that have not met housing production goals qualify for ministerial approval. Eliminates discretionary review, CEQA requirements, and public hearings for qualifying projects. Applies to urban infill sites in areas meeting RHNA progress standards. Impact: Dramatically reduces entitlement timelines and costs for projects meeting affordability thresholds.',
        applies: (useId, inp) => ['R2','R3','R4','R5','C1.5','C2','C4','TOD'].includes(inp.zoning) && ['multifamily_low','multifamily_mid','multifamily_high','mixeduse'].includes(useId),
        densityBonus: 0,
        parkingReduction: 0,
        softCostReduction: 0.15,
        legalOverride: false,
    },
    {
        id: 'ab2345',
        name: 'AB 2345 (Density Bonus)',
        description: 'Up to 50% density bonus and reduced parking for projects including affordable units.',
        detail: 'AB 2345 (2020) enhances California\'s Density Bonus Law, increasing the maximum density bonus from 35% to 50% for projects including affordable units. Provides up to 4 incentives or concessions such as reduced setbacks, increased height, and reduced parking. Parking minimums reduced to 0.5 spaces per unit for projects near transit. Applies to all residential and mixed-use zones with affordable set-asides meeting specified thresholds. Impact: One of the most widely used tools by LA developers to significantly increase project density and reduce parking requirements.',
        applies: (useId, inp) => ['R2','R3','R4','R5','C1','C1.5','C2','C4','TOD'].includes(inp.zoning) && ['duplex','multifamily_low','multifamily_mid','multifamily_high','mixeduse','senior'].includes(useId),
        densityBonus: 0.50,
        parkingReduction: 0.20,
        softCostReduction: 0,
        legalOverride: false,
    },
    {
        id: 'ab1763',
        name: 'AB 1763',
        description: 'Unlimited density for 100% affordable housing projects near transit.',
        detail: 'AB 1763 (2019) provides unlimited density for 100% affordable housing projects located within half a mile of a major transit stop. Eliminates maximum FAR and unit count restrictions entirely. Parking requirements are set to zero for projects within half a mile of transit. Projects must be 100% affordable with an allowance for manager units. Impact: Enables very high-density affordable development near transit without the typical density caps, making transit-adjacent sites extremely valuable for affordable housing developers.',
        applies: (useId, inp) => ['adjacent','near'].includes(inp.transit) && ['multifamily_low','multifamily_mid','multifamily_high','senior'].includes(useId),
        densityBonus: 1.0,
        parkingReduction: 0,
        softCostReduction: 0,
        legalOverride: true,
    },
    {
        id: 'toc',
        name: 'TOC (LA Local)',
        description: 'Transit Oriented Communities incentives — up to 80% density bonus and parking reductions near transit.',
        detail: 'The Transit Oriented Communities (TOC) program is an LA-specific incentive providing density bonuses of up to 80% and significant parking reductions for housing projects near transit. Projects are tiered by proximity: Tier 1 (within 750 ft of a major stop) through Tier 4 (within 2,640 ft), with each tier providing increasing incentives. Affordable units must be included at specified set-aside levels. Impact: The most impactful local density incentive in Los Angeles, enabling significantly larger buildings near Metro stations.',
        applies: (useId, inp) => ['adjacent','near'].includes(inp.transit) && ['multifamily_low','multifamily_mid','multifamily_high','mixeduse'].includes(useId),
        densityBonus: 0.80,
        parkingReduction: 0.30,
        softCostReduction: 0,
        legalOverride: false,
    },
    {
        id: 'ab2097',
        name: 'AB 2097',
        description: 'Eliminates minimum parking requirements within 1/2 mile of major transit stops.',
        detail: 'AB 2097 (2022) eliminates minimum parking requirements for any development within half a mile of a major transit stop in California. Applies to all land use types — residential, commercial, and mixed-use — not just affordable housing. Local jurisdictions cannot impose minimum parking requirements in these areas. Developers can still choose to build parking, but it is not mandated. Impact: Reduces development costs by $30,000 to $80,000 per eliminated parking space and enables more efficient site utilization near transit.',
        applies: (useId, inp) => ['adjacent','near'].includes(inp.transit),
        densityBonus: 0,
        parkingReduction: 1.0,
        softCostReduction: 0,
        legalOverride: false,
    },
    {
        id: 'adu_reform',
        name: 'ADU Reform (AB 68/SB 13/AB 881)',
        description: 'By-right ADU construction on residential lots; no parking required near transit.',
        detail: 'California\'s ADU reform package (2019-2020) established a comprehensive by-right framework for Accessory Dwelling Units on residential lots. AB 68 allows at least one ADU on any residential lot regardless of local zoning. SB 13 eliminates impact fees for ADUs under 750 SF and caps fees for larger units. AB 881 prohibits local agencies from requiring owner-occupancy or imposing minimum lot sizes. No additional parking is required near transit. Impact: Has generated tens of thousands of new housing units statewide, particularly in single-family neighborhoods.',
        applies: (useId, inp) => ['R1','R2','R3','R4','R5'].includes(inp.zoning) && useId === 'adu',
        densityBonus: 0,
        parkingReduction: 0,
        softCostReduction: 0,
        legalOverride: true,
    },
    {
        id: 'sb478',
        name: 'SB 478',
        description: 'Sets minimum 1.0 FAR for multifamily projects on parcels up to 10,000 SF.',
        detail: 'SB 478 (2021) establishes a minimum floor area ratio (FAR) of 1.0 for multifamily housing projects on parcels of 10,000 SF or less in areas zoned for at least two residential units. Prohibits local jurisdictions from imposing lot coverage limits below 60% on qualifying parcels. Prevents cities from using low FAR limits to effectively block apartment construction on small lots. Applies only to urban infill locations. Impact: Ensures meaningful development potential on small multifamily parcels that might otherwise be restricted by overly conservative FAR limits.',
        applies: (useId, inp) => inp.parcelSize <= 10000 && ['R3','R4','R5','C1.5','C2','C4','TOD'].includes(inp.zoning) && ['multifamily_low','multifamily_mid','multifamily_high'].includes(useId),
        densityBonus: 0,
        parkingReduction: 0,
        softCostReduction: 0,
        legalOverride: false,
        minFAR: 1.0,
    },
    {
        id: 'ed1',
        name: 'ED1 (LA Local)',
        description: 'Executive Directive 1 — streamlined approvals and density bonus for 100% affordable and senior housing.',
        detail: 'Executive Directive 1 (2022) is an LA mayoral order streamlining approvals for 100% affordable and senior housing projects in Los Angeles. Provides expedited processing, priority permitting, and fee waivers for qualifying projects. Includes density bonus provisions beyond state law for affordable projects. Directs all city departments to prioritize affordable housing applications and reduce bureaucratic barriers. Impact: Significantly reduces entitlement timelines for affordable housing, with some projects receiving permits in weeks rather than months.',
        applies: (useId, inp) => ['multifamily_low','multifamily_mid','multifamily_high','senior'].includes(useId),
        densityBonus: 0.35,
        parkingReduction: 0,
        softCostReduction: 0.20,
        legalOverride: false,
    },
    {
        id: 'sb684',
        name: 'SB 684',
        description: 'By-right approval for 10+ unit housing projects on commercially zoned land.',
        detail: 'SB 684 (2023) establishes a by-right (ministerial) approval pathway for housing projects of 10 or more units on commercially zoned land. Projects must meet objective design and development standards. Requires compliance with density, height, and FAR limits as defined by local jurisdictions. Overrides local discretionary review requirements and CEQA for qualifying projects on infill sites. Impact: Provides certainty and speed for developers building housing on commercial sites, reducing entitlement risk and project timelines substantially.',
        applies: (useId, inp) => ['C1','C1.5','C2','C4','C5','CM'].includes(inp.zoning) && ['multifamily_low','multifamily_mid','multifamily_high','mixeduse'].includes(useId),
        densityBonus: 0,
        parkingReduction: 0,
        softCostReduction: 0,
        legalOverride: true,
    },
];

function getApplicableLegislation(useId, inp) {
    return CA_HOUSING_LEGISLATION.filter(bill => bill.applies(useId, inp));
}

function stackLegislationEffects(legislationList) {
    let densityBonus = 0;
    let parkingReduction = 0;
    let softCostReduction = 0;
    let legalOverride = false;
    let minFAR = 0;

    for (const bill of legislationList) {
        densityBonus = Math.max(densityBonus, bill.densityBonus || 0);
        parkingReduction = Math.max(parkingReduction, bill.parkingReduction || 0);
        softCostReduction += (bill.softCostReduction || 0);
        if (bill.legalOverride) legalOverride = true;
        minFAR = Math.max(minFAR, bill.minFAR || 0);
    }

    softCostReduction = Math.min(softCostReduction, 0.50);
    return { densityBonus, parkingReduction, softCostReduction, legalOverride, minFAR };
}


// ============================================================
//  BUILDING PROGRAM & BUDGET DATA
// ============================================================

const BUILDING_PARAMS = {
    sfr:              { stories: 2,  floorH: 10, eff: 0.92, unitSF: 1800, parkRatio: 2.0,  setF: 20, setS: 5,  opex: 0.30, cap: 0.045 },
    duplex:           { stories: 2,  floorH: 10, eff: 0.90, unitSF: 1200, parkRatio: 1.5,  setF: 15, setS: 5,  opex: 0.32, cap: 0.048 },
    multifamily_low:  { stories: 4,  floorH: 10, eff: 0.82, unitSF: 850,  parkRatio: 1.25, setF: 10, setS: 5,  opex: 0.38, cap: 0.050 },
    multifamily_mid:  { stories: 7,  floorH: 10, eff: 0.80, unitSF: 800,  parkRatio: 1.0,  setF: 10, setS: 5,  opex: 0.38, cap: 0.048 },
    multifamily_high: { stories: 18, floorH: 10, eff: 0.78, unitSF: 750,  parkRatio: 1.0,  setF: 10, setS: 10, opex: 0.40, cap: 0.045 },
    mixeduse:         { stories: 6,  floorH: 12, eff: 0.80, unitSF: 850,  parkRatio: 1.0,  setF: 0,  setS: 0,  opex: 0.38, cap: 0.050 },
    retail:           { stories: 1,  floorH: 16, eff: 0.88, unitSF: null, parkRatio: 4.0,  setF: 0,  setS: 0,  opex: 0.35, cap: 0.055 },
    office:           { stories: 5,  floorH: 13, eff: 0.85, unitSF: null, parkRatio: 3.0,  setF: 5,  setS: 5,  opex: 0.40, cap: 0.055 },
    medical:          { stories: 4,  floorH: 13, eff: 0.82, unitSF: null, parkRatio: 4.0,  setF: 10, setS: 5,  opex: 0.42, cap: 0.050 },
    hotel:            { stories: 10, floorH: 11, eff: 0.75, unitSF: 400,  parkRatio: 0.5,  setF: 5,  setS: 5,  opex: 0.55, cap: 0.060 },
    industrial:       { stories: 1,  floorH: 24, eff: 0.92, unitSF: null, parkRatio: 1.0,  setF: 10, setS: 5,  opex: 0.28, cap: 0.055 },
    selfstorage:      { stories: 4,  floorH: 9,  eff: 0.88, unitSF: null, parkRatio: 0.2,  setF: 5,  setS: 5,  opex: 0.30, cap: 0.060 },
    senior:           { stories: 5,  floorH: 10, eff: 0.78, unitSF: 600,  parkRatio: 0.5,  setF: 10, setS: 5,  opex: 0.55, cap: 0.050 },
    parking:          { stories: 5,  floorH: 11, eff: 0.90, unitSF: null, parkRatio: null, setF: 0,  setS: 0,  opex: 0.25, cap: 0.065 },
    creative:         { stories: 3,  floorH: 14, eff: 0.85, unitSF: null, parkRatio: 2.5,  setF: 0,  setS: 0,  opex: 0.35, cap: 0.055 },
    adu:              { stories: 2,  floorH: 9,  eff: 0.90, unitSF: 600,  parkRatio: 0,    setF: 5,  setS: 4,  opex: 0.30, cap: 0.050 },
};

const TIMELINE_MONTHS = {
    sfr:              { entitlement: 2,  design: 2,  permits: 2, construction: 10, leaseup: 1 },
    duplex:           { entitlement: 3,  design: 2,  permits: 2, construction: 12, leaseup: 1 },
    multifamily_low:  { entitlement: 6,  design: 4,  permits: 3, construction: 18, leaseup: 6 },
    multifamily_mid:  { entitlement: 8,  design: 5,  permits: 4, construction: 24, leaseup: 8 },
    multifamily_high: { entitlement: 12, design: 8,  permits: 6, construction: 36, leaseup: 10 },
    mixeduse:         { entitlement: 8,  design: 5,  permits: 4, construction: 22, leaseup: 8 },
    retail:           { entitlement: 4,  design: 3,  permits: 2, construction: 10, leaseup: 4 },
    office:           { entitlement: 6,  design: 4,  permits: 3, construction: 18, leaseup: 8 },
    medical:          { entitlement: 6,  design: 5,  permits: 4, construction: 16, leaseup: 6 },
    hotel:            { entitlement: 10, design: 6,  permits: 5, construction: 28, leaseup: 12 },
    industrial:       { entitlement: 4,  design: 3,  permits: 2, construction: 10, leaseup: 3 },
    selfstorage:      { entitlement: 4,  design: 3,  permits: 2, construction: 12, leaseup: 12 },
    senior:           { entitlement: 8,  design: 5,  permits: 4, construction: 22, leaseup: 10 },
    parking:          { entitlement: 4,  design: 3,  permits: 2, construction: 14, leaseup: 2 },
    creative:         { entitlement: 4,  design: 3,  permits: 2, construction: 14, leaseup: 6 },
    adu:              { entitlement: 1,  design: 1,  permits: 2, construction: 8,  leaseup: 1 },
};

const USE_COLORS = {
    sfr: '#4a9e5c', duplex: '#5ba86e', multifamily_low: '#3182ce', multifamily_mid: '#2b6cb0',
    multifamily_high: '#1a4791', mixeduse: '#805ad5', retail: '#dd6b20', office: '#2c5282',
    medical: '#38a169', hotel: '#b83280', industrial: '#718096', selfstorage: '#a0aec0',
    senior: '#d69e2e', parking: '#4a5568', creative: '#ed8936', adu: '#48bb78',
};


// ============================================================
//  SCORING FUNCTIONS
// ============================================================

function getInputs() {
    return {
        parcelSize:    parseFloat(document.getElementById('parcelSize').value) || 10000,
        frontage:      parseFloat(document.getElementById('frontage').value) || 80,
        zoning:        document.getElementById('zoning').value,
        neighborhood:  document.getElementById('neighborhood').value,
        siteCondition: document.getElementById('siteCondition').value,
        topography:    document.getElementById('topography').value,
        cornerLot:     document.getElementById('cornerLot').value === 'yes',
        transit:       document.getElementById('transit').value,
        arterial:      document.getElementById('arterial').value,
        utilities:     document.getElementById('utilities').value,
        constFlood:    document.getElementById('constFlood').checked,
        constHillside: document.getElementById('constHillside').checked,
        constHistoric: document.getElementById('constHistoric').checked,
        constFault:    document.getElementById('constFault').checked,
        constCoastal:  document.getElementById('constCoastal').checked,
        constParking:  document.getElementById('constParking').checked,
    };
}

function scoreLegal(useId, inp, effects) {
    const zoneRow = ZONING_MATRIX[inp.zoning];
    if (!zoneRow) return 0;
    let base = zoneRow[useId] || 0;

    // CA Housing Legislation: by-right override
    if (effects && effects.legalOverride) {
        base = 1.0;
    }

    // Historic overlay reduces redevelopment permission
    if (inp.constHistoric && ['multifamily_high', 'hotel', 'industrial'].includes(useId)) {
        base *= 0.5;
    }
    // Coastal zone limits industrial, dense residential
    if (inp.constCoastal && ['industrial', 'multifamily_high', 'selfstorage'].includes(useId)) {
        base *= 0.4;
    }
    // Hillside ordinance restricts density
    if (inp.constHillside && ['multifamily_mid', 'multifamily_high', 'hotel', 'industrial'].includes(useId)) {
        base *= 0.3;
    }
    return Math.min(base, 1.0);
}

function scorePhysical(useId, inp) {
    let score = 1.0;

    // Parcel size check
    const minSqFt = MIN_PARCEL[useId] || 2000;
    if (inp.parcelSize < minSqFt) {
        score *= Math.max(0.1, inp.parcelSize / minSqFt);
    } else if (inp.parcelSize > minSqFt * 3) {
        score *= 1.0; // plenty of room
    }

    // Frontage adequacy
    const needsFrontage = ['retail', 'mixeduse', 'hotel', 'office', 'medical'];
    if (needsFrontage.includes(useId) && inp.frontage < 50) {
        score *= 0.6;
    }

    // Topography
    const topoPenalty = { flat: 1.0, gentle: 0.9, moderate: 0.65, steep: 0.3 };
    const baseTopo = topoPenalty[inp.topography] || 1.0;
    // Some uses are more topo-tolerant
    if (['parking', 'selfstorage'].includes(useId)) {
        score *= Math.max(baseTopo, 0.7);
    } else if (['industrial', 'multifamily_high', 'hotel'].includes(useId)) {
        score *= baseTopo * 0.9; // extra sensitive
    } else {
        score *= baseTopo;
    }

    // Utilities
    if (inp.utilities === 'partial') score *= 0.85;
    if (inp.utilities === 'none') score *= 0.5;

    // Site condition
    if (inp.siteCondition === 'demolition') score *= 0.85;
    if (inp.siteCondition === 'brownfield') score *= 0.6;

    // Flood zone
    if (inp.constFlood) score *= 0.7;

    // Fault zone — penalizes tall structures
    if (inp.constFault && ['multifamily_high', 'hotel', 'office'].includes(useId)) {
        score *= 0.7;
    }

    return Math.min(score, 1.0);
}

function scoreFinancial(useId, inp, effects) {
    // Compute effective FAR with legislation bonuses
    const baseFAR = FAR_TYPICAL[useId] || 1.0;
    let far = baseFAR;
    if (effects) {
        far = baseFAR * (1 + effects.densityBonus);
        if (effects.minFAR > 0) far = Math.max(far, effects.minFAR);
    }

    const buildableSF = inp.parcelSize * far;
    const landValuePSF = LAND_VALUE_PSF[inp.neighborhood] || 150;
    const landCost = inp.parcelSize * landValuePSF;

    // Build cost with parking reduction from legislation
    let buildCostPerSF = BUILD_COST_PSF[useId] || 300;
    if (effects && effects.parkingReduction > 0) {
        buildCostPerSF *= (1 - effects.parkingReduction * 0.18);
    }
    const buildCost = buildableSF * buildCostPerSF;

    // Total cost with soft cost reduction from legislation
    let totalCost = landCost + buildCost;
    if (effects && effects.softCostReduction > 0) {
        totalCost *= (1 - effects.softCostReduction * 0.20);
    }

    // Annual revenue
    const annualRevenue = buildableSF * (REVENUE_PSF[useId] || 30);

    // Simple yield-on-cost
    const yieldOnCost = annualRevenue / totalCost;

    // Normalize: 3% yield = 0.2, 6% = 0.5, 10%+ = 1.0
    let score;
    if (yieldOnCost >= 0.10) score = 1.0;
    else if (yieldOnCost >= 0.06) score = 0.5 + (yieldOnCost - 0.06) / 0.04 * 0.5;
    else if (yieldOnCost >= 0.03) score = 0.2 + (yieldOnCost - 0.03) / 0.03 * 0.3;
    else score = yieldOnCost / 0.03 * 0.2;

    // Neighborhood demand multiplier
    const demandRow = NEIGHBORHOOD_DEMAND[inp.neighborhood];
    const demand = demandRow ? (demandRow[useId] || 0.7) : 0.7;
    score *= demand;

    // Corner lot bonus for visibility-dependent uses
    if (inp.cornerLot && ['retail', 'mixeduse', 'hotel', 'office', 'medical'].includes(useId)) {
        score *= 1.15;
    }

    // Transit proximity bonus
    const transitBonus = { adjacent: 1.2, near: 1.1, moderate: 1.0, far: 0.85 };
    if (['multifamily_mid', 'multifamily_high', 'mixeduse', 'office', 'hotel'].includes(useId)) {
        score *= (transitBonus[inp.transit] || 1.0);
    }

    // Arterial bonus
    if (inp.arterial === 'major' && ['retail', 'mixeduse', 'hotel', 'office'].includes(useId)) {
        score *= 1.1;
    }
    if (inp.arterial === 'residential' && ['retail', 'hotel', 'industrial'].includes(useId)) {
        score *= 0.7;
    }

    // Site condition cost adjustments
    if (inp.siteCondition === 'demolition') score *= 0.9;
    if (inp.siteCondition === 'brownfield') score *= 0.7;

    // Parking constraints
    if (inp.constParking && ['retail', 'office', 'medical', 'hotel'].includes(useId)) {
        score *= 0.8;
    }

    return Math.min(score, 1.0);
}

function scoreProductive(useId, inp, effects) {
    // Compute effective FAR with legislation bonuses
    const baseFAR = FAR_TYPICAL[useId] || 1.0;
    let far = baseFAR;
    if (effects) {
        far = baseFAR * (1 + effects.densityBonus);
        if (effects.minFAR > 0) far = Math.max(far, effects.minFAR);
    }

    const buildableSF = inp.parcelSize * far;
    const revenuePSF = REVENUE_PSF[useId] || 30;
    const totalAnnualRev = buildableSF * revenuePSF;
    const landValuePSF = LAND_VALUE_PSF[inp.neighborhood] || 150;

    // Revenue-to-land-value ratio (higher = more productive per dollar of land)
    const revToLand = totalAnnualRev / (inp.parcelSize * landValuePSF);

    // Normalize
    let score;
    if (revToLand >= 0.20) score = 1.0;
    else if (revToLand >= 0.10) score = 0.5 + (revToLand - 0.10) / 0.10 * 0.5;
    else score = revToLand / 0.10 * 0.5;

    // Demand multiplier
    const demandRow = NEIGHBORHOOD_DEMAND[inp.neighborhood];
    const demand = demandRow ? (demandRow[useId] || 0.7) : 0.7;
    score *= demand;

    return Math.min(score, 1.0);
}


// ============================================================
//  MAIN CALCULATION
// ============================================================

let lastResults = null;
let lastInputs = null;

function calculateHBU() {
    const inp = getInputs();

    // Score all uses
    const results = LAND_USES.map(use => {
        const legislation = getApplicableLegislation(use.id, inp);
        const effects = stackLegislationEffects(legislation);

        const legal      = scoreLegal(use.id, inp, effects);
        const physical   = scorePhysical(use.id, inp);
        const financial  = scoreFinancial(use.id, inp, effects);
        const productive = scoreProductive(use.id, inp, effects);

        // HBU must pass ALL four tests. Weight: Legal gateway, then others.
        // If legal = 0, overall = 0
        let overall;
        if (legal === 0) {
            overall = 0;
        } else {
            overall = legal * 0.25 + physical * 0.20 + financial * 0.30 + productive * 0.25;
            // Penalize further if legal is only conditional
            if (legal <= 0.5) overall *= 0.8;
        }

        return {
            ...use,
            legal: Math.round(legal * 100),
            physical: Math.round(physical * 100),
            financial: Math.round(financial * 100),
            productive: Math.round(productive * 100),
            overall: Math.round(overall * 100),
            legislation,
        };
    });

    // Sort by overall descending
    results.sort((a, b) => b.overall - a.overall);

    // Store for modal access
    lastResults = results;
    lastInputs = inp;

    // Render
    renderResults(results, inp);
}


// ============================================================
//  RENDER
// ============================================================

function renderResults(results, inp) {
    const container = document.getElementById('results');
    container.classList.add('visible');

    // Summary
    document.getElementById('resultsSummary').textContent =
        `Analysis for a ${inp.parcelSize.toLocaleString()} SF parcel, zoned ${inp.zoning}, in ${document.getElementById('neighborhood').selectedOptions[0].text}.`;

    // Top 3 cards
    const cardsDiv = document.getElementById('resultCards');
    cardsDiv.innerHTML = '';

    const rankLabels = ['1st — Best Use', '2nd — Alternative', '3rd — Alternative'];
    const rankClasses = ['rank-1', 'rank-2', 'rank-3'];

    for (let i = 0; i < 3; i++) {
        const r = results[i];
        const legBadges = r.legislation && r.legislation.length > 0
            ? `<div class="legislation-badges">
                   <div class="leg-label">Applicable Legislation</div>
                   ${r.legislation.map(b => `<span class="legislation-badge clickable" onclick="event.stopPropagation();showLegislationDetail('${b.id}')">${b.name}</span>`).join('')}
               </div>`
            : '';

        const card = document.createElement('div');
        card.className = `result-card ${rankClasses[i]}`;
        card.style.cursor = 'pointer';
        card.onclick = ((idx) => () => openAnalysis(idx))(i);
        card.innerHTML = `
            <div class="rank-banner">
                <span class="rank-num">#${i + 1}</span>
                ${rankLabels[i]}
            </div>
            <div class="card-body">
                <div class="use-name">${r.icon} ${r.name}</div>

                <div class="score-bar-container">
                    <div class="score-label"><span>Legally Permissible</span><span>${r.legal}%</span></div>
                    <div class="score-bar"><div class="score-bar-fill legal" style="width: ${r.legal}%"></div></div>
                </div>
                <div class="score-bar-container">
                    <div class="score-label"><span>Physically Possible</span><span>${r.physical}%</span></div>
                    <div class="score-bar"><div class="score-bar-fill physical" style="width: ${r.physical}%"></div></div>
                </div>
                <div class="score-bar-container">
                    <div class="score-label"><span>Financially Feasible</span><span>${r.financial}%</span></div>
                    <div class="score-bar"><div class="score-bar-fill financial" style="width: ${r.financial}%"></div></div>
                </div>
                <div class="score-bar-container">
                    <div class="score-label"><span>Maximally Productive</span><span>${r.productive}%</span></div>
                    <div class="score-bar"><div class="score-bar-fill productive" style="width: ${r.productive}%"></div></div>
                </div>

                <div class="overall-score">
                    <div class="big-score">${r.overall}</div>
                    <span>/ 100<br>Overall Score</span>
                </div>

                <div class="rationale">${RATIONALE[r.id] || ''}</div>
                ${legBadges}
                <div class="click-hint">Click for detailed analysis</div>
            </div>
        `;
        cardsDiv.appendChild(card);
    }

    // Legislation section — collect unique bills from top 3
    const legSection = document.getElementById('legislationSection');
    const allLegislation = new Map();
    for (let i = 0; i < 3 && i < results.length; i++) {
        if (results[i].legislation) {
            for (const bill of results[i].legislation) {
                if (!allLegislation.has(bill.id)) {
                    allLegislation.set(bill.id, bill);
                }
            }
        }
    }

    if (allLegislation.size > 0) {
        legSection.style.display = 'block';
        let legHTML = '<h3>Applicable California Housing Legislation</h3>';
        legHTML += '<div class="legislation-cards">';
        for (const bill of allLegislation.values()) {
            legHTML += `<div class="legislation-card clickable" onclick="showLegislationDetail('${bill.id}')"><strong>${bill.name}</strong><p>${bill.description}</p></div>`;
        }
        legHTML += '</div>';
        legSection.innerHTML = legHTML;
    } else {
        legSection.style.display = 'none';
        legSection.innerHTML = '';
    }

    // Full table
    const tbody = document.getElementById('detailsBody');
    tbody.innerHTML = '';
    results.forEach((r, i) => {
        const tr = document.createElement('tr');
        if (i < 3) tr.className = 'top-3';

        const formatCell = (val) => {
            if (val >= 70) return `<span class="pass">${val}%</span>`;
            if (val >= 40) return `<span class="partial">${val}%</span>`;
            if (val > 0)   return `<span class="fail">${val}%</span>`;
            return `<span class="fail">N/A</span>`;
        };

        tr.innerHTML = `
            <td>${i + 1}</td>
            <td>${r.icon} ${r.name}</td>
            <td>${formatCell(r.legal)}</td>
            <td>${formatCell(r.physical)}</td>
            <td>${formatCell(r.financial)}</td>
            <td>${formatCell(r.productive)}</td>
            <td><strong>${r.overall}%</strong></td>
        `;
        tbody.appendChild(tr);
    });

    // Show print button
    document.getElementById('btnPrint').classList.add('visible');

    // Scroll to results
    container.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function exportPDF() {
    // Set the print date
    const now = new Date();
    const dateStr = now.toLocaleDateString('en-US', {
        year: 'numeric', month: 'long', day: 'numeric',
        hour: '2-digit', minute: '2-digit'
    });
    document.getElementById('printDate').textContent = `Report generated: ${dateStr}  |  CLS CRE Brokerage — HBU Analysis`;

    // Trigger browser print dialog (user can select "Save as PDF")
    window.print();
}


// ============================================================
//  DETAILED ANALYSIS MODAL
// ============================================================

function fmt(n) {
    return '$' + Math.round(n).toLocaleString();
}

function adjustColor(hex, amount) {
    let r = parseInt(hex.slice(1, 3), 16);
    let g = parseInt(hex.slice(3, 5), 16);
    let b = parseInt(hex.slice(5, 7), 16);
    r = Math.max(0, Math.min(255, r + amount));
    g = Math.max(0, Math.min(255, g + amount));
    b = Math.max(0, Math.min(255, b + amount));
    return '#' + [r, g, b].map(c => c.toString(16).padStart(2, '0')).join('');
}

function generateBudget(useId, inp, effects) {
    const params = BUILDING_PARAMS[useId];
    const baseFAR = FAR_TYPICAL[useId] || 1.0;
    let far = baseFAR;
    if (effects) {
        far = baseFAR * (1 + effects.densityBonus);
        if (effects.minFAR > 0) far = Math.max(far, effects.minFAR);
    }

    const gsf = Math.round(inp.parcelSize * far);
    const nsf = Math.round(gsf * params.eff);
    const stories = Math.max(params.stories, Math.ceil(gsf / (inp.parcelSize * 0.7)));
    const buildingHeight = stories * params.floorH;
    const buildingFootprint = Math.min(Math.round(inp.parcelSize * 0.7), Math.round(gsf / stories));
    const units = params.unitSF ? Math.max(1, Math.floor(nsf / params.unitSF)) : null;

    // Parking
    const baseParkRatio = params.parkRatio || 0;
    const parkReduction = effects ? effects.parkingReduction : 0;
    let parkingSpaces;
    if (useId === 'parking') {
        parkingSpaces = Math.round(gsf / 350); // ~350 SF per space
    } else if (units) {
        parkingSpaces = Math.max(0, Math.ceil(units * baseParkRatio * (1 - parkReduction)));
    } else {
        parkingSpaces = Math.max(0, Math.ceil(gsf / 1000 * baseParkRatio * (1 - parkReduction)));
    }

    const landValuePSF = LAND_VALUE_PSF[inp.neighborhood] || 150;
    const landCost = inp.parcelSize * landValuePSF;

    // Hard costs
    const siteWork = inp.parcelSize * 18;
    const demolition = (inp.siteCondition === 'demolition') ? inp.parcelSize * 12 : 0;
    let buildCostPSF = BUILD_COST_PSF[useId] || 300;
    if (effects && effects.parkingReduction > 0) {
        buildCostPSF *= (1 - effects.parkingReduction * 0.18);
    }
    const construction = gsf * buildCostPSF;
    const parkingCost = parkingSpaces * 45000;
    const landscaping = Math.round(construction * 0.04);
    const hardContingency = Math.round((siteWork + demolition + construction + parkingCost + landscaping) * 0.07);
    const totalHard = siteWork + demolition + construction + parkingCost + landscaping + hardContingency;

    // Soft costs
    const archEng = Math.round(totalHard * 0.10);
    const permits = Math.round(totalHard * 0.06);
    const legal = Math.round(totalHard * 0.025);
    const financing = Math.round((landCost + totalHard) * 0.05);
    const marketing = Math.round(nsf * (REVENUE_PSF[useId] || 30) * 0.025);
    const devFee = Math.round((totalHard + archEng + permits) * 0.04);
    const softCostMult = effects && effects.softCostReduction > 0 ? (1 - effects.softCostReduction * 0.20) : 1;
    const totalSoft = Math.round((archEng + permits + legal + financing + marketing + devFee) * softCostMult);

    const totalDev = landCost + totalHard + totalSoft;

    // Revenue & returns
    const grossRevenue = nsf * (REVENUE_PSF[useId] || 30);
    const opex = Math.round(grossRevenue * params.opex);
    const noi = grossRevenue - opex;
    const capRate = params.cap;
    const stabilizedValue = Math.round(noi / capRate);
    const yieldOnCost = noi / totalDev;
    const devMargin = (stabilizedValue - totalDev) / totalDev;

    return {
        gsf, nsf, stories, buildingHeight, buildingFootprint, units, parkingSpaces, far,
        landCost, siteWork, demolition, construction, buildCostPSF, parkingCost, landscaping, hardContingency, totalHard,
        archEng, permits, legal, financing, marketing, devFee, totalSoft,
        totalDev,
        grossRevenue, opex, noi, capRate, stabilizedValue, yieldOnCost, devMargin,
        params,
    };
}

// --- SVG Rendering ---

function generateSitePlanSVG(useId, inp, budget) {
    const w = 320, h = 270;
    const params = budget.params;
    const color = USE_COLORS[useId] || '#3182ce';

    const lotW = inp.frontage || Math.sqrt(inp.parcelSize * 2);
    const lotD = inp.parcelSize / lotW;
    const maxDim = Math.max(lotW, lotD);
    const scale = 170 / maxDim;
    const lw = lotW * scale, ld = lotD * scale;
    const ox = (w - lw) / 2, oy = 25;

    const sf = params.setF * scale, ss = params.setS * scale;
    const bw = Math.max(20, lw - 2 * ss);
    const bd = Math.max(20, ld - sf - ss);
    const bx = ox + ss, by = oy + ss;

    let s = `<svg viewBox="0 0 ${w} ${h}" xmlns="http://www.w3.org/2000/svg" style="background:#fafbfc;">`;
    s += `<defs><pattern id="ht" width="6" height="6" patternUnits="userSpaceOnUse"><path d="M0,6 L6,0" stroke="#ccc" stroke-width="0.5"/></pattern></defs>`;
    // Lot
    s += `<rect x="${ox}" y="${oy}" width="${lw}" height="${ld}" fill="#e8f5e9" stroke="#66bb6a" stroke-width="1.5" rx="2"/>`;
    // Setback hatching (front)
    if (sf > 2) s += `<rect x="${ox}" y="${oy + ld - sf}" width="${lw}" height="${sf}" fill="url(#ht)" opacity="0.5"/>`;
    // Building footprint
    s += `<rect x="${bx}" y="${by}" width="${bw}" height="${bd}" fill="${color}" opacity="0.75" stroke="${color}" stroke-width="1.5" rx="2"/>`;
    s += `<text x="${bx + bw/2}" y="${by + bd/2 - 5}" text-anchor="middle" font-size="10" fill="white" font-weight="600">BUILDING</text>`;
    s += `<text x="${bx + bw/2}" y="${by + bd/2 + 9}" text-anchor="middle" font-size="8" fill="rgba(255,255,255,0.85)">${budget.buildingFootprint.toLocaleString()} SF footprint</text>`;
    // Dimensions
    s += `<text x="${ox + lw/2}" y="${oy - 6}" text-anchor="middle" font-size="9" fill="#666">${Math.round(lotW)}' frontage</text>`;
    // Depth label (right side, rotated)
    s += `<text x="${ox + lw + 14}" y="${oy + ld/2}" text-anchor="middle" font-size="9" fill="#666" transform="rotate(90,${ox + lw + 14},${oy + ld/2})">${Math.round(lotD)}' depth</text>`;
    // Street
    s += `<rect x="${ox - 15}" y="${oy + ld + 8}" width="${lw + 30}" height="${22}" fill="#e2e8f0" rx="3"/>`;
    s += `<text x="${ox + lw/2}" y="${oy + ld + 23}" text-anchor="middle" font-size="9" fill="#718096" font-weight="600">STREET</text>`;
    // North arrow
    s += `<text x="${w - 22}" y="${oy + 12}" text-anchor="middle" font-size="14" fill="#999">&#8593;</text>`;
    s += `<text x="${w - 22}" y="${oy + 24}" text-anchor="middle" font-size="8" fill="#999" font-weight="600">N</text>`;
    // Title
    s += `<text x="${w/2}" y="${h - 6}" text-anchor="middle" font-size="10" fill="#999" font-weight="600">SITE PLAN</text>`;
    s += '</svg>';
    return s;
}

function generateElevationSVG(useId, inp, budget) {
    const w = 320, h = 270;
    const params = budget.params;
    const color = USE_COLORS[useId] || '#3182ce';
    const stories = budget.stories;
    const totalH = budget.buildingHeight;

    const maxSVGH = 190;
    const hScale = Math.min(maxSVGH / totalH, 3.0);
    const buildH = totalH * hScale;
    const buildW = 180;
    const ox = (w - buildW) / 2;
    const groundY = h - 45;
    const roofY = groundY - buildH;

    let s = `<svg viewBox="0 0 ${w} ${h}" xmlns="http://www.w3.org/2000/svg" style="background:#fafbfc;">`;
    // Sky
    s += `<defs><linearGradient id="sky" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#dbeafe"/><stop offset="100%" stop-color="#f0f9ff"/></linearGradient></defs>`;
    s += `<rect x="0" y="0" width="${w}" height="${groundY}" fill="url(#sky)"/>`;
    // Ground
    s += `<rect x="0" y="${groundY}" width="${w}" height="${h - groundY}" fill="#d4edda"/>`;
    s += `<line x1="0" y1="${groundY}" x2="${w}" y2="${groundY}" stroke="#888" stroke-width="1.5"/>`;
    // Building
    s += `<rect x="${ox}" y="${roofY}" width="${buildW}" height="${buildH}" fill="${color}" stroke="${adjustColor(color, -30)}" stroke-width="1.5" rx="2"/>`;
    // Floor lines
    const storyH = buildH / stories;
    for (let i = 1; i < stories; i++) {
        const y = groundY - i * storyH;
        s += `<line x1="${ox}" y1="${y}" x2="${ox + buildW}" y2="${y}" stroke="rgba(255,255,255,0.2)" stroke-width="0.5"/>`;
    }
    // Windows
    const cols = Math.min(7, Math.max(3, Math.floor(buildW / 25)));
    const winW = 12, winH = storyH * 0.45;
    const winSpacing = buildW / (cols + 1);
    for (let fl = 0; fl < stories; fl++) {
        const fy = groundY - (fl + 1) * storyH + (storyH - winH) / 2 + winH * 0.1;
        for (let c = 0; c < cols; c++) {
            const wx = ox + winSpacing * (c + 1) - winW / 2;
            s += `<rect x="${wx}" y="${fy}" width="${winW}" height="${winH}" fill="rgba(255,255,255,0.35)" rx="1"/>`;
        }
    }
    // Ground floor entrance
    if (['retail', 'mixeduse', 'hotel', 'office', 'medical', 'creative'].includes(useId)) {
        const doorW = buildW * 0.12, doorH = storyH * 0.65;
        s += `<rect x="${ox + buildW/2 - doorW/2}" y="${groundY - doorH}" width="${doorW}" height="${doorH}" fill="rgba(255,255,255,0.5)" rx="2"/>`;
    }
    // Roof line
    s += `<line x1="${ox - 4}" y1="${roofY}" x2="${ox + buildW + 4}" y2="${roofY}" stroke="${adjustColor(color, -40)}" stroke-width="2.5"/>`;
    // Height dimension
    const dx = ox + buildW + 18;
    s += `<line x1="${dx}" y1="${groundY}" x2="${dx}" y2="${roofY}" stroke="#999" stroke-width="0.75" stroke-dasharray="3,2"/>`;
    s += `<line x1="${dx - 4}" y1="${groundY}" x2="${dx + 4}" y2="${groundY}" stroke="#999" stroke-width="1"/>`;
    s += `<line x1="${dx - 4}" y1="${roofY}" x2="${dx + 4}" y2="${roofY}" stroke="#999" stroke-width="1"/>`;
    s += `<text x="${dx + 8}" y="${(groundY + roofY) / 2}" font-size="9" fill="#666" font-weight="600">${totalH} ft</text>`;
    s += `<text x="${dx + 8}" y="${(groundY + roofY) / 2 + 13}" font-size="8" fill="#999">${stories} stories</text>`;
    // Width
    s += `<text x="${ox + buildW/2}" y="${groundY + 16}" text-anchor="middle" font-size="9" fill="#666">${Math.round(inp.frontage || Math.sqrt(inp.parcelSize * 2))}' frontage</text>`;
    // Title
    s += `<text x="${w/2}" y="${h - 6}" text-anchor="middle" font-size="10" fill="#999" font-weight="600">BUILDING ELEVATION</text>`;
    s += '</svg>';
    return s;
}

function generateRisksHTML(useId, inp) {
    const risks = [];
    if (inp.constFlood) risks.push({ t: 'Flood Zone', d: 'Site is in a flood zone. Flood insurance required, ground-floor design constraints, potential FEMA elevation requirements.' });
    if (inp.constHillside) risks.push({ t: 'Hillside Ordinance', d: 'Hillside development restrictions limit grading, height, and density. Extended entitlement timeline expected.' });
    if (inp.constHistoric) risks.push({ t: 'Historic Overlay', d: 'Historic preservation review required. May limit demolition, facade changes, and building height.' });
    if (inp.constFault) risks.push({ t: 'Fault Zone', d: 'Alquist-Priolo fault zone — geotechnical study required. Structural reinforcement may increase costs 10-20%.' });
    if (inp.constCoastal) risks.push({ t: 'Coastal Zone', d: 'California Coastal Commission review required. Height, view corridor, and public access conditions likely.' });
    if (inp.siteCondition === 'brownfield') risks.push({ t: 'Environmental Contamination', d: 'Phase II ESA recommended. Remediation costs could range from $50K to $500K+ depending on contamination type.' });
    if (inp.siteCondition === 'demolition') risks.push({ t: 'Demolition Required', d: 'Existing structure requires demolition. Asbestos/lead survey required. Demo costs included in budget.' });
    if (inp.utilities === 'partial') risks.push({ t: 'Utility Upgrades Needed', d: 'Utility infrastructure requires upgrades. Coordinate with LADWP and LASAN. May add $50-200K.' });
    if (inp.utilities === 'none') risks.push({ t: 'No Utilities Available', d: 'Significant utility extension required. May add $200K-$1M+ and 6-12 months to timeline.' });
    if (inp.topography === 'steep') risks.push({ t: 'Steep Topography', d: 'Significant grading and retaining walls required. May add 15-30% to foundation costs.' });
    if (['multifamily_high', 'hotel'].includes(useId)) risks.push({ t: 'Construction Cost Escalation', d: 'High-rise construction is sensitive to material/labor cost changes. Lock in GMP contract early.' });
    if (useId === 'retail') risks.push({ t: 'Retail Market Uncertainty', d: 'Evolving retail landscape. Consider flexible ground-floor design for alternative uses.' });
    if (useId === 'office') risks.push({ t: 'Office Demand Shift', d: 'Remote work trends have shifted office demand. Consider amenity-rich design and flexible leases.' });
    risks.push({ t: 'Entitlement Risk', d: 'LA entitlement timelines are subject to CEQA review, community opposition, and council discretion. Budget for delays.' });
    risks.push({ t: 'Interest Rate Sensitivity', d: 'Construction and permanent financing costs fluctuate. Model scenarios at current rate +/- 100 bps.' });

    let html = '<div class="analysis-section"><h3>Key Risks &amp; Considerations</h3>';
    html += risks.map(r => `<div class="risk-card"><strong>${r.t}</strong><p>${r.d}</p></div>`).join('');
    html += '</div>';
    return html;
}


// ============================================================
//  EDITABLE ANALYSIS — STATE, COMPUTE, RENDER HELPERS
// ============================================================

let analysisState = {
    resultIndex: null,
    useId: null,
    inp: null,
    effects: null,
    legislation: null,
    assumptions: null,
};

function getDefaultAssumptions(useId, inp, effects) {
    const params = BUILDING_PARAMS[useId];
    const baseFAR = FAR_TYPICAL[useId] || 1.0;
    let far = baseFAR;
    if (effects) {
        far = baseFAR * (1 + effects.densityBonus);
        if (effects.minFAR > 0) far = Math.max(far, effects.minFAR);
    }

    const gsf = Math.round(inp.parcelSize * far);
    const nsf = Math.round(gsf * params.eff);
    const hasUnits = !!params.unitSF;
    const unitsOrNSF = hasUnits ? Math.max(1, Math.floor(nsf / params.unitSF)) : nsf;

    const baseParkRatio = params.parkRatio || 0;
    const parkReduction = effects ? effects.parkingReduction : 0;
    let parkingSpaces;
    if (useId === 'parking') {
        parkingSpaces = Math.round(gsf / 350);
    } else if (hasUnits) {
        parkingSpaces = Math.max(0, Math.ceil(unitsOrNSF * baseParkRatio * (1 - parkReduction)));
    } else {
        parkingSpaces = Math.max(0, Math.ceil(gsf / 1000 * baseParkRatio * (1 - parkReduction)));
    }

    let buildCostPSF = BUILD_COST_PSF[useId] || 300;
    if (effects && effects.parkingReduction > 0) {
        buildCostPSF = Math.round(buildCostPSF * (1 - effects.parkingReduction * 0.18));
    }

    return {
        far: parseFloat(far.toFixed(2)),
        unitsOrNSF,
        parkingSpaces,
        buildCostPSF: Math.round(buildCostPSF),
        landValuePSF: LAND_VALUE_PSF[inp.neighborhood] || 150,
        revenuePSF: REVENUE_PSF[useId] || 30,
        opexPct: Math.round(params.opex * 100),
        capRatePct: parseFloat((params.cap * 100).toFixed(1)),
        parkingCostPerSpace: 45000,
    };
}

function computeFromAssumptions(useId, inp, assumptions, effects) {
    const params = BUILDING_PARAMS[useId];
    const far = assumptions.far;
    const gsf = Math.round(inp.parcelSize * far);
    const nsf = Math.round(gsf * params.eff);
    const stories = Math.max(params.stories, Math.ceil(gsf / (inp.parcelSize * 0.7)));
    const buildingHeight = stories * params.floorH;
    const buildingFootprint = Math.min(Math.round(inp.parcelSize * 0.7), Math.round(gsf / stories));

    const hasUnits = !!params.unitSF;
    const units = hasUnits ? assumptions.unitsOrNSF : null;
    // For revenue: use user-edited NSF for non-unit uses, or units * unitSF for unit-based uses
    const revenueNSF = hasUnits ? assumptions.unitsOrNSF * params.unitSF : assumptions.unitsOrNSF;
    const parkingSpaces = assumptions.parkingSpaces;

    const landValuePSF = assumptions.landValuePSF;
    const landCost = inp.parcelSize * landValuePSF;

    // Hard costs
    const siteWork = inp.parcelSize * 18;
    const demolition = (inp.siteCondition === 'demolition') ? inp.parcelSize * 12 : 0;
    const buildCostPSF = assumptions.buildCostPSF;
    const construction = gsf * buildCostPSF;
    const parkingCost = parkingSpaces * assumptions.parkingCostPerSpace;
    const landscaping = Math.round(construction * 0.04);
    const hardContingency = Math.round((siteWork + demolition + construction + parkingCost + landscaping) * 0.07);
    const totalHard = siteWork + demolition + construction + parkingCost + landscaping + hardContingency;

    // Soft costs
    const archEng = Math.round(totalHard * 0.10);
    const permits = Math.round(totalHard * 0.06);
    const legal = Math.round(totalHard * 0.025);
    const financing = Math.round((landCost + totalHard) * 0.05);
    const revenuePSF = assumptions.revenuePSF;
    const marketing = Math.round(revenueNSF * revenuePSF * 0.025);
    const devFee = Math.round((totalHard + archEng + permits) * 0.04);
    const softCostMult = effects && effects.softCostReduction > 0 ? (1 - effects.softCostReduction * 0.20) : 1;
    const totalSoft = Math.round((archEng + permits + legal + financing + marketing + devFee) * softCostMult);

    const totalDev = landCost + totalHard + totalSoft;

    // Revenue & returns — use revenueNSF so user edits to units/NSF flow through
    const grossRevenue = revenueNSF * revenuePSF;
    const opexRate = assumptions.opexPct / 100;
    const opex = Math.round(grossRevenue * opexRate);
    const noi = grossRevenue - opex;
    const capRate = assumptions.capRatePct / 100;
    const stabilizedValue = capRate > 0 ? Math.round(noi / capRate) : 0;
    const yieldOnCost = totalDev > 0 ? noi / totalDev : 0;
    const devMargin = totalDev > 0 ? (stabilizedValue - totalDev) / totalDev : 0;

    return {
        gsf, nsf, revenueNSF, stories, buildingHeight, buildingFootprint, units, parkingSpaces, far,
        landCost, siteWork, demolition, construction, buildCostPSF, parkingCost, landscaping, hardContingency, totalHard,
        archEng, permits, legal, financing, marketing, devFee, totalSoft,
        totalDev,
        grossRevenue, opex, noi, capRate, stabilizedValue, yieldOnCost, devMargin,
        params, landValuePSF, revenuePSF, parkingCostPerSpace: assumptions.parkingCostPerSpace,
    };
}

function renderProgramDisplay(computed) {
    return `<div class="program-grid">
        <div class="program-item"><div class="program-value">${computed.stories}</div><div class="program-label">Stories / ${computed.buildingHeight} ft</div></div>
        <div class="program-item"><div class="program-value">${computed.gsf.toLocaleString()}</div><div class="program-label">Gross SF</div></div>
        ${computed.units
            ? `<div class="program-item"><div class="program-value">${computed.units}</div><div class="program-label">Units</div></div>`
            : `<div class="program-item"><div class="program-value">${computed.nsf.toLocaleString()}</div><div class="program-label">Net Leasable SF</div></div>`}
        <div class="program-item"><div class="program-value">${computed.parkingSpaces}</div><div class="program-label">Parking Spaces</div></div>
    </div>`;
}

function renderAssumptions(assumptions, hasUnits) {
    return `<div class="assumptions-panel">
        <h4>Key Assumptions (editable)</h4>
        <div class="assumptions-grid">
            <div class="assumption-field">
                <label>FAR</label>
                <input type="number" class="assumption-input" id="a-far" step="0.1" min="0.1" max="20" value="${assumptions.far}" oninput="recalcAnalysis()">
            </div>
            <div class="assumption-field">
                <label>${hasUnits ? 'Units' : 'Net Leasable SF'}</label>
                <input type="number" class="assumption-input" id="a-unitsOrNSF" step="1" min="1" value="${assumptions.unitsOrNSF}" oninput="recalcAnalysis()">
            </div>
            <div class="assumption-field">
                <label>Parking Spaces</label>
                <input type="number" class="assumption-input" id="a-parkingSpaces" step="1" min="0" value="${assumptions.parkingSpaces}" oninput="recalcAnalysis()">
            </div>
            <div class="assumption-field">
                <label>Build Cost $/SF</label>
                <input type="number" class="assumption-input" id="a-buildCostPSF" step="5" min="10" value="${assumptions.buildCostPSF}" oninput="recalcAnalysis()">
            </div>
            <div class="assumption-field">
                <label>Land Value $/SF</label>
                <input type="number" class="assumption-input" id="a-landValuePSF" step="5" min="1" value="${assumptions.landValuePSF}" oninput="recalcAnalysis()">
            </div>
            <div class="assumption-field">
                <label>Revenue $/SF</label>
                <input type="number" class="assumption-input" id="a-revenuePSF" step="1" min="1" value="${assumptions.revenuePSF}" oninput="recalcAnalysis()">
            </div>
            <div class="assumption-field">
                <label>OpEx %</label>
                <input type="number" class="assumption-input" id="a-opexPct" step="1" min="0" max="100" value="${assumptions.opexPct}" oninput="recalcAnalysis()">
            </div>
            <div class="assumption-field">
                <label>Cap Rate %</label>
                <input type="number" class="assumption-input" id="a-capRatePct" step="0.1" min="0.1" max="20" value="${assumptions.capRatePct}" oninput="recalcAnalysis()">
            </div>
            <div class="assumption-field">
                <label>Parking $/Space</label>
                <input type="number" class="assumption-input" id="a-parkingCostPerSpace" step="1000" min="0" value="${assumptions.parkingCostPerSpace}" oninput="recalcAnalysis()">
            </div>
        </div>
    </div>`;
}

function renderBudgetTable(computed, inp) {
    return `<table class="budget-table">
        <tr class="section-header"><td colspan="2">LAND ACQUISITION</td></tr>
        <tr><td>Land Cost (${inp.parcelSize.toLocaleString()} SF &times; $${computed.landValuePSF.toLocaleString()}/SF)</td><td>${fmt(computed.landCost)}</td></tr>

        <tr class="section-header"><td colspan="2">HARD COSTS</td></tr>
        <tr><td>Site Work &amp; Preparation ($18/SF land)</td><td>${fmt(computed.siteWork)}</td></tr>
        ${computed.demolition > 0 ? `<tr><td>Demolition ($12/SF land)</td><td>${fmt(computed.demolition)}</td></tr>` : ''}
        <tr><td>Building Construction (${computed.gsf.toLocaleString()} GSF &times; $${Math.round(computed.buildCostPSF).toLocaleString()}/SF)</td><td>${fmt(computed.construction)}</td></tr>
        <tr><td>Parking Construction (${computed.parkingSpaces} spaces &times; $${computed.parkingCostPerSpace.toLocaleString()})</td><td>${fmt(computed.parkingCost)}</td></tr>
        <tr><td>Landscaping &amp; Hardscape (4%)</td><td>${fmt(computed.landscaping)}</td></tr>
        <tr><td>Hard Cost Contingency (7%)</td><td>${fmt(computed.hardContingency)}</td></tr>
        <tr class="subtotal"><td>Subtotal Hard Costs</td><td>${fmt(computed.totalHard)}</td></tr>

        <tr class="section-header"><td colspan="2">SOFT COSTS</td></tr>
        <tr><td>Architecture &amp; Engineering (10%)</td><td>${fmt(computed.archEng)}</td></tr>
        <tr><td>Permits &amp; Impact Fees (6%)</td><td>${fmt(computed.permits)}</td></tr>
        <tr><td>Legal &amp; Accounting (2.5%)</td><td>${fmt(computed.legal)}</td></tr>
        <tr><td>Financing &amp; Interest Carry (5%)</td><td>${fmt(computed.financing)}</td></tr>
        <tr><td>Marketing &amp; Leasing</td><td>${fmt(computed.marketing)}</td></tr>
        <tr><td>Developer Fee (4%)</td><td>${fmt(computed.devFee)}</td></tr>
        <tr class="subtotal"><td>Subtotal Soft Costs</td><td>${fmt(computed.totalSoft)}</td></tr>

        <tr class="grand-total"><td>TOTAL DEVELOPMENT COST</td><td>${fmt(computed.totalDev)}</td></tr>
    </table>`;
}

function renderReturnsSection(computed) {
    return `<div class="returns-grid">
        <div class="return-card"><div class="return-value">${(computed.yieldOnCost * 100).toFixed(1)}%</div><div class="return-label">Yield on Cost</div></div>
        <div class="return-card"><div class="return-value">${(computed.capRate * 100).toFixed(1)}%</div><div class="return-label">Market Cap Rate</div></div>
        <div class="return-card"><div class="return-value">${(computed.devMargin * 100).toFixed(0)}%</div><div class="return-label">Development Margin</div></div>
    </div>
    <table class="budget-table">
        <tr><td>Annual Gross Revenue (${computed.revenueNSF.toLocaleString()} NSF &times; $${computed.revenuePSF}/SF)</td><td>${fmt(computed.grossRevenue)}</td></tr>
        <tr><td>Less: Operating Expenses (${computed.grossRevenue > 0 ? Math.round(computed.opex / computed.grossRevenue * 100) : 0}%)</td><td>(${fmt(computed.opex)})</td></tr>
        <tr class="subtotal"><td>Net Operating Income (NOI)</td><td>${fmt(computed.noi)}</td></tr>
        <tr><td>Estimated Stabilized Value (NOI &divide; ${(computed.capRate * 100).toFixed(1)}% cap)</td><td>${fmt(computed.stabilizedValue)}</td></tr>
        <tr class="subtotal"><td>Development Profit / (Loss)</td><td><strong>${fmt(computed.stabilizedValue - computed.totalDev)}</strong></td></tr>
    </table>`;
}

function renderSVGs(useId, inp, computed) {
    return `${generateSitePlanSVG(useId, inp, computed)}
        ${generateElevationSVG(useId, inp, computed)}`;
}

function recalcAnalysis() {
    const st = analysisState;
    if (!st.useId || !st.inp) return;

    const assumptions = {
        far: parseFloat(document.getElementById('a-far').value) || st.assumptions.far,
        unitsOrNSF: parseInt(document.getElementById('a-unitsOrNSF').value) || st.assumptions.unitsOrNSF,
        parkingSpaces: parseInt(document.getElementById('a-parkingSpaces').value) || 0,
        buildCostPSF: parseFloat(document.getElementById('a-buildCostPSF').value) || st.assumptions.buildCostPSF,
        landValuePSF: parseFloat(document.getElementById('a-landValuePSF').value) || st.assumptions.landValuePSF,
        revenuePSF: parseFloat(document.getElementById('a-revenuePSF').value) || st.assumptions.revenuePSF,
        opexPct: parseFloat(document.getElementById('a-opexPct').value) || 0,
        capRatePct: parseFloat(document.getElementById('a-capRatePct').value) || st.assumptions.capRatePct,
        parkingCostPerSpace: parseFloat(document.getElementById('a-parkingCostPerSpace').value) || 0,
    };

    st.assumptions = assumptions;
    const computed = computeFromAssumptions(st.useId, st.inp, assumptions, st.effects);

    const progEl = document.getElementById('sect-program');
    if (progEl) progEl.innerHTML = renderProgramDisplay(computed);

    const budgetEl = document.getElementById('sect-budget');
    if (budgetEl) budgetEl.innerHTML = renderBudgetTable(computed, st.inp);

    const returnsEl = document.getElementById('sect-returns');
    if (returnsEl) returnsEl.innerHTML = renderReturnsSection(computed);

    const svgEl = document.getElementById('sect-svg');
    if (svgEl) svgEl.innerHTML = renderSVGs(st.useId, st.inp, computed);
}


function openAnalysis(resultIndex) {
    if (!lastResults || !lastInputs) return;
    const r = lastResults[resultIndex];
    const inp = lastInputs;
    const effects = stackLegislationEffects(r.legislation || []);
    const hasUnits = !!BUILDING_PARAMS[r.id].unitSF;

    // Set up analysisState
    const assumptions = getDefaultAssumptions(r.id, inp, effects);
    analysisState = {
        resultIndex,
        useId: r.id,
        inp,
        effects,
        legislation: r.legislation || [],
        assumptions,
    };

    const computed = computeFromAssumptions(r.id, inp, assumptions, effects);
    const tl = TIMELINE_MONTHS[r.id] || { entitlement: 6, design: 4, permits: 3, construction: 18, leaseup: 6 };
    const totalMonths = tl.entitlement + tl.design + tl.permits + tl.construction + tl.leaseup;
    const neighborhoodText = document.getElementById('neighborhood').selectedOptions[0].text;

    document.getElementById('modalTitle').textContent = `${r.icon} ${r.name}`;
    document.getElementById('modalSubtitle').textContent =
        `Detailed Development Analysis  |  ${inp.parcelSize.toLocaleString()} SF  |  ${inp.zoning} Zoning  |  ${neighborhoodText}`;

    let html = '';

    // --- Building Program (re-rendered on assumption change) ---
    html += `<div class="analysis-section"><h3>Building Program</h3><div id="sect-program">${renderProgramDisplay(computed)}</div></div>`;

    // --- Key Assumptions (editable — NOT re-rendered) ---
    html += `<div class="analysis-section">${renderAssumptions(assumptions, hasUnits)}</div>`;

    // --- Conceptual Renderings (re-rendered) ---
    html += `<div class="analysis-section"><h3>Conceptual Massing Study</h3><div class="rendering-container" id="sect-svg">${renderSVGs(r.id, inp, computed)}</div></div>`;

    // --- Line Item Budget (re-rendered) ---
    html += `<div class="analysis-section"><h3>Development Pro Forma &mdash; Line Item Budget</h3><div id="sect-budget">${renderBudgetTable(computed, inp)}</div></div>`;

    // --- Revenue & Returns (re-rendered) ---
    html += `<div class="analysis-section"><h3>Revenue &amp; Return Analysis</h3><div id="sect-returns">${renderReturnsSection(computed)}</div></div>`;

    // --- Timeline (static) ---
    html += `<div class="analysis-section"><h3>Development Timeline &mdash; ${totalMonths} Months</h3>
    <div class="timeline-bar">
        <div class="timeline-segment" style="flex:${tl.entitlement};background:#805ad5;">Entitle<br>${tl.entitlement}mo</div>
        <div class="timeline-segment" style="flex:${tl.design};background:#3182ce;">Design<br>${tl.design}mo</div>
        <div class="timeline-segment" style="flex:${tl.permits};background:#38a169;">Permits<br>${tl.permits}mo</div>
        <div class="timeline-segment" style="flex:${tl.construction};background:#dd6b20;">Construction<br>${tl.construction}mo</div>
        <div class="timeline-segment" style="flex:${tl.leaseup};background:#e53e3e;">Lease-Up<br>${tl.leaseup}mo</div>
    </div>
    <div class="timeline-legend">Entitlement &rarr; Design &rarr; Permits &rarr; Construction &rarr; Lease-Up / Stabilization</div>
    </div>`;

    // --- Legislation (with clickable cards) ---
    if (r.legislation && r.legislation.length > 0) {
        html += `<div class="analysis-section"><h3>Applicable California Housing Legislation</h3>
        <div class="legislation-cards">
            ${r.legislation.map(b => `<div class="legislation-card clickable" onclick="showLegislationDetail('${b.id}')"><strong>${b.name}</strong><p>${b.description}</p></div>`).join('')}
        </div></div>`;
    }

    // --- Risks ---
    html += generateRisksHTML(r.id, inp);

    // --- Disclaimer ---
    html += `<div class="disclaimer" style="margin-top:1.5rem;">
        <strong>Disclaimer:</strong> This pro forma is a preliminary estimate for educational purposes only. Actual development costs, revenues, and timelines vary significantly based on market conditions, design specifications, entitlement outcomes, and contractor pricing. All figures should be verified through independent feasibility analysis by qualified professionals before making investment decisions.
    </div>`;

    document.getElementById('modalBody').innerHTML = html;
    document.getElementById('analysisModal').style.display = 'block';
    document.body.style.overflow = 'hidden';
    document.getElementById('analysisModal').scrollTop = 0;
}

function closeAnalysis() {
    document.getElementById('analysisModal').style.display = 'none';
    document.body.style.overflow = '';
}

function printAnalysis() {
    document.body.classList.add('printing-analysis');
    window.print();
    document.body.classList.remove('printing-analysis');
}


// ============================================================
//  LEGISLATION DETAIL POPUP
// ============================================================

function showLegislationDetail(billId) {
    const bill = CA_HOUSING_LEGISLATION.find(b => b.id === billId);
    if (!bill) return;

    const modal = document.getElementById('legDetailModal');
    modal.innerHTML = `<div class="leg-detail-content">
        <div class="leg-detail-header">
            <h3>${bill.name}</h3>
            <button type="button" class="leg-detail-close" onclick="closeLegislationDetail()">&times;</button>
        </div>
        <div class="leg-detail-body">
            <p class="leg-summary">${bill.description}</p>
            <p class="leg-full">${bill.detail || bill.description}</p>
        </div>
    </div>`;
    modal.style.display = 'flex';
}

function closeLegislationDetail() {
    document.getElementById('legDetailModal').style.display = 'none';
}


// Close modals on Escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        const legModal = document.getElementById('legDetailModal');
        if (legModal && legModal.style.display !== 'none') {
            closeLegislationDetail();
            return;
        }
        if (document.getElementById('analysisModal').style.display === 'block') {
            closeAnalysis();
        }
    }
});
</script>

</body>
</html>
